rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper: verifica autenticazione
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper: verifica che l'utente appartenga al tenant
    // Legge il documento users dell'utente corrente (ha sempre permesso di lettura)
    function belongsToTenant(tenantId) {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
    }
    
    // Helper: verifica ruolo utente
    function hasRole(role) {
      return isAuthenticated() &&
             role in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.ruoli;
    }
    
    // Helper: verifica se è Manager o Amministratore
    function isManagerOrAdmin() {
      return isAuthenticated() &&
             (hasRole('manager') || hasRole('amministratore'));
    }
    
    // Helper: verifica se è Caposquadra
    function isCaposquadra() {
      return isAuthenticated() && hasRole('caposquadra');
    }
    
    // Collection: users (globale)
    // IMPORTANTE: Permetti lettura del proprio documento per evitare dipendenza circolare
    // Permetti anche lettura di utenti dello stesso tenant (per statistiche, report, ecc.)
    match /users/{userId} {
      allow read: if isAuthenticated() && (
        request.auth.uid == userId || 
        // Permetti lettura se l'utente richiedente appartiene allo stesso tenant del documento richiesto
        // Gestisce anche il caso in cui resource.data.tenantId potrebbe essere null o non esistere
        (resource.data.keys().hasAny(['tenantId']) &&
         resource.data.tenantId != null && 
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId != null &&
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == resource.data.tenantId)
      );
      allow write: if isAuthenticated() && request.auth.uid == userId;
    }
    
    // Collection: tenants (globale)
    match /tenants/{tenantId} {
      // Lettura: autenticati del tenant O lettura pubblica (necessaria per pagina accettazione preventivo che cerca in tutti i tenant)
      allow read: if isAuthenticated() && belongsToTenant(tenantId) || true;
      allow write: if isAuthenticated() && isManagerOrAdmin() && belongsToTenant(tenantId);
    }
    
    // Collection: inviti (globale)
    match /inviti/{invitoId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && isManagerOrAdmin();
    }
    
    // Dati tenant (multi-tenant) - Regola generica per tutte le subcollection
    // NOTA: Le regole specifiche hanno priorità, questa è solo un fallback
    // DISABILITATA per evitare conflitti con onSnapshot
    // match /tenants/{tenantId}/{document=**} {
    //   allow read: if isAuthenticated() && belongsToTenant(tenantId);
    // }
    
    // Regole specifiche per collection Conto Terzi
    
    // Collection: clienti
    match /tenants/{tenantId}/clienti/{clienteId} {
      // Lettura: autenticati del tenant O lettura pubblica (necessaria per pagina accettazione preventivo)
      // NOTA: Meno sicuro, ma necessario per mostrare dati cliente nel preventivo pubblico
      allow read: if isAuthenticated() && belongsToTenant(tenantId) || true;
      allow create, update, delete: if isAuthenticated() && belongsToTenant(tenantId) && isManagerOrAdmin();
    }
    
    // Collection: tariffe
    match /tenants/{tenantId}/tariffe/{tariffaId} {
      allow read: if isAuthenticated() && belongsToTenant(tenantId);
      allow create, update, delete: if isAuthenticated() && belongsToTenant(tenantId) && isManagerOrAdmin();
    }
    
    // Collection: preventivi
    match /tenants/{tenantId}/preventivi/{preventivoId} {
      // Lettura: autenticati del tenant O lettura pubblica (necessaria per query con tokenAccettazione)
      // NOTA: Per query, dobbiamo permettere lettura pubblica, ma solo preventivi con tokenAccettazione saranno accessibili
      // La sicurezza è garantita dal fatto che il token è unico e casuale
      allow read: if isAuthenticated() && belongsToTenant(tenantId) || true;
      
      // Creazione: solo manager/admin autenticati
      allow create: if isAuthenticated() && belongsToTenant(tenantId) && isManagerOrAdmin();
      
      // Aggiornamento: manager/admin autenticati O aggiornamento pubblico solo di stato/dataAccettazione per preventivi con token
      allow update: if (isAuthenticated() && belongsToTenant(tenantId) && isManagerOrAdmin()) ||
                     (resource.data.tokenAccettazione != null && 
                      // Permetti aggiornamento solo di questi campi specifici
                      request.resource.data.diff(resource.data).affectedKeys().hasOnly(['stato', 'dataAccettazione', 'dataRifiuto']) &&
                      // Verifica che lo stato sia valido per accettazione/rifiuto
                      (request.resource.data.stato == 'accettato_email' || request.resource.data.stato == 'rifiutato'));
      
      // Eliminazione: solo manager/admin autenticati
      allow delete: if isAuthenticated() && belongsToTenant(tenantId) && isManagerOrAdmin();
    }
    
    // Collection: poderi-clienti
    match /tenants/{tenantId}/poderi-clienti/{podereId} {
      allow read: if isAuthenticated() && belongsToTenant(tenantId);
      allow create, update, delete: if isAuthenticated() && belongsToTenant(tenantId) && isManagerOrAdmin();
    }
    
    // Collection: terreni (già esistente, ma assicuriamoci che funzioni)
    match /tenants/{tenantId}/terreni/{terrenoId} {
      allow read: if isAuthenticated() && belongsToTenant(tenantId);
      allow create, update, delete: if isAuthenticated() && belongsToTenant(tenantId) && isManagerOrAdmin();
    }

    // Collection: poderi (aziendali, non clienti)
    match /tenants/{tenantId}/poderi/{podereId} {
      allow read: if isAuthenticated() && belongsToTenant(tenantId);
      allow create, update, delete: if isAuthenticated() && belongsToTenant(tenantId) && isManagerOrAdmin();
    }

    // Collection: liste (dati personalizzati, es. colture)
    match /tenants/{tenantId}/liste/{listaId} {
      allow read: if isAuthenticated() && belongsToTenant(tenantId);
      allow create, update, delete: if isAuthenticated() && belongsToTenant(tenantId) && isManagerOrAdmin();
    }

    // Collection: categorie (unificata per lavori e attrezzi)
    match /tenants/{tenantId}/categorie/{categoriaId} {
      allow read: if isAuthenticated() && belongsToTenant(tenantId);
      allow create, update, delete: if isAuthenticated() && belongsToTenant(tenantId) && isManagerOrAdmin();
    }

    // Collection: tipiLavoro (tipi di lavoro gerarchici)
    match /tenants/{tenantId}/tipiLavoro/{tipoId} {
      allow read: if isAuthenticated() && belongsToTenant(tenantId);
      allow create, update, delete: if isAuthenticated() && belongsToTenant(tenantId) && isManagerOrAdmin();
    }

    // Collection: categorieLavori (vecchia collezione, per migrazione)
    match /tenants/{tenantId}/categorieLavori/{categoriaId} {
      allow read: if isAuthenticated() && belongsToTenant(tenantId);
      allow create, update, delete: if isAuthenticated() && belongsToTenant(tenantId) && isManagerOrAdmin();
    }

    // Collection: categorieAttrezzi (vecchia collezione, per migrazione)
    match /tenants/{tenantId}/categorieAttrezzi/{categoriaId} {
      allow read: if isAuthenticated() && belongsToTenant(tenantId);
      allow create, update, delete: if isAuthenticated() && belongsToTenant(tenantId) && isManagerOrAdmin();
    }
    
    // Collection: lavori (già esistente)
    match /tenants/{tenantId}/lavori/{lavoroId} {
      allow read: if isAuthenticated() && belongsToTenant(tenantId);
      
      // Creazione ed eliminazione: solo manager/admin
      allow create, delete: if isAuthenticated() && belongsToTenant(tenantId) && isManagerOrAdmin();
      
      // Aggiornamento: manager/admin possono aggiornare tutto
      // Caposquadra può aggiornare solo campi di progresso e stato per lavori assegnati a lui
      // Operaio può segnare come completato lavori autonomi assegnati a lui
      allow update: if isAuthenticated() && belongsToTenant(tenantId) && (
        // Manager/Admin: possono aggiornare tutto
        isManagerOrAdmin() ||
        // Caposquadra: può aggiornare solo campi di progresso e stato per lavori di squadra assegnati a lui
        (isCaposquadra() && 
         // Verifica che il lavoro sia assegnato a questo caposquadra (lavoro di squadra, non autonomo)
         resource.data.caposquadraId == request.auth.uid &&
         resource.data.operaioId == null &&
         // Permetti aggiornamento solo di questi campi specifici
         request.resource.data.diff(resource.data).affectedKeys().hasOnly([
           'superficieTotaleLavorata',
           'superficieRimanente',
           'percentualeCompletamento',
           'percentualeCompletamentoTracciata',
           'giorniEffettivi',
           'statoProgresso',
           'stato',
           'completatoDa',
           'completatoIl',
           'aggiornatoIl'
         ]) &&
         // Verifica che lo stato sia valido (solo transizioni permesse)
         (request.resource.data.stato == 'in_corso' ||
          request.resource.data.stato == 'completato' ||
          request.resource.data.stato == 'completato_da_approvare' ||
          request.resource.data.stato == resource.data.stato)) ||
        // Operaio: può segnare come completato lavori autonomi assegnati a lui
        // E può aggiornare progressi quando traccia zone lavorate
        (hasRole('operaio') &&
         // Verifica che il lavoro sia autonomo assegnato a questo operaio
         resource.data.operaioId == request.auth.uid &&
         resource.data.caposquadraId == null &&
         // Permetti aggiornamento solo di questi campi specifici
         request.resource.data.diff(resource.data).affectedKeys().hasOnly([
           'stato',
           'percentualeCompletamentoTracciata',
           'superficieTotaleLavorata',
           'superficieRimanente',
           'percentualeCompletamento',
           'giorniEffettivi',
           'statoProgresso',
           'completatoDa',
           'completatoIl',
           'aggiornatoIl'
         ]) &&
         // Verifica che lo stato sia valido (solo transizioni permesse per operai)
         (request.resource.data.stato == 'completato_da_approvare' ||
          request.resource.data.stato == 'in_corso' ||
          request.resource.data.stato == resource.data.stato))
      );
    }
    
    // Collection: attivita (già esistente)
    match /tenants/{tenantId}/attivita/{attivitaId} {
      allow read: if isAuthenticated() && belongsToTenant(tenantId);
      allow create, update, delete: if isAuthenticated() && belongsToTenant(tenantId);
    }

    // Collection: squadre (Manodopera)
    match /tenants/{tenantId}/squadre/{squadraId} {
      allow read: if isAuthenticated() && belongsToTenant(tenantId);
      allow create, update, delete: if isAuthenticated() && belongsToTenant(tenantId) && isManagerOrAdmin();
    }

    // Collection: guasti (Parco Macchine)
    // NOTA: Usa controllo diretto invece di belongsToTenant per evitare problemi con onSnapshot
    match /tenants/{tenantId}/guasti/{guastoId} {
      allow read: if isAuthenticated() && 
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
      allow create, update, delete: if isAuthenticated() && 
                                       get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
    }

    // Collection: macchine (Parco Macchine)
    match /tenants/{tenantId}/macchine/{macchinaId} {
      allow read: if isAuthenticated() && belongsToTenant(tenantId);
      allow create, update, delete: if isAuthenticated() && belongsToTenant(tenantId) && isManagerOrAdmin();
    }

    // Subcollection: oreOperai (sotto lavori)
    match /tenants/{tenantId}/lavori/{lavoroId}/oreOperai/{oraId} {
      allow read: if isAuthenticated() && belongsToTenant(tenantId);
      allow create, update, delete: if isAuthenticated() && belongsToTenant(tenantId);
    }

    // Subcollection: zoneLavorate (sotto lavori)
    match /tenants/{tenantId}/lavori/{lavoroId}/zoneLavorate/{zonaId} {
      allow read: if isAuthenticated() && belongsToTenant(tenantId);
      allow create, update, delete: if isAuthenticated() && belongsToTenant(tenantId);
    }

    // Subcollection: manutenzioni (sotto macchine)
    match /tenants/{tenantId}/macchine/{macchinaId}/manutenzioni/{manutenzioneId} {
      allow read: if isAuthenticated() && belongsToTenant(tenantId);
      allow create, update, delete: if isAuthenticated() && belongsToTenant(tenantId) && isManagerOrAdmin();
    }

    // Collection: comunicazioni (comunicazioni caposquadra -> operai)
    match /tenants/{tenantId}/comunicazioni/{comunicazioneId} {
      // Lettura: operai e caposquadra del tenant possono leggere comunicazioni dove sono destinatari
      // NOTA: Il filtro per destinatari viene fatto lato client, qui permettiamo lettura a tutti gli utenti del tenant
      allow read: if isAuthenticated() && belongsToTenant(tenantId);
      
      // Creazione: solo caposquadra e manager/admin
      allow create: if isAuthenticated() && belongsToTenant(tenantId) && 
                     (hasRole('caposquadra') || isManagerOrAdmin());
      
      // Aggiornamento: caposquadra/manager/admin possono aggiornare tutto, operai solo il campo conferme
      allow update: if isAuthenticated() && belongsToTenant(tenantId) && (
        // Caposquadra/manager/admin: possono aggiornare tutto
        (hasRole('caposquadra') || isManagerOrAdmin()) ||
        // Operai: possono aggiornare solo il campo conferme (per confermare ricezione)
        (hasRole('operaio') && 
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['conferme']))
      );
      
      // Eliminazione: solo manager/admin
      allow delete: if isAuthenticated() && belongsToTenant(tenantId) && isManagerOrAdmin();
    }
  }
}

