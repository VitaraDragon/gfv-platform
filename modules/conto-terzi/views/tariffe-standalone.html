<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Tariffe - Conto Terzi - GFV Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #E3F2FD 0%, #1976D2 100%);
            color: #333;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .btn-primary:hover {
            background: rgba(255,255,255,0.3);
        }

        .modal .btn-primary {
            background: #1976D2;
            color: white;
            border: none;
        }

        .modal .btn-primary:hover {
            background: #1565C0;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }

        .content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 12px;
            font-weight: 600;
            color: #495057;
        }

        .filter-group select,
        .filter-group input {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-header h2 {
            color: #1976D2;
            font-size: 24px;
        }

        .tariffe-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .tariffe-table th,
        .tariffe-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .tariffe-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            position: sticky;
            top: 0;
        }

        .tariffe-table tr:hover {
            background: #f8f9fa;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-secondary {
            background: #e2e3e5;
            color: #383d41;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 700px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: #1976D2;
            font-size: 20px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .close-btn:hover {
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #1976D2;
        }

        .form-group small {
            display: block;
            color: #666;
            font-size: 12px;
            margin-top: 5px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        @media (max-width: 768px) {
            .tariffe-table {
                font-size: 12px;
            }

            .tariffe-table th,
            .tariffe-table td {
                padding: 8px;
            }

            .action-buttons {
                flex-direction: column;
            }

            .filters {
                flex-direction: column;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>üí∞ Gestione Tariffe</h1>
                <p style="opacity: 0.9; margin-top: 5px;">Configura tariffe per calcolo preventivi automatici</p>
            </div>
            <div class="header-actions">
                <a href="../../../core/admin/impostazioni-standalone.html" class="btn btn-primary" style="text-decoration: none; display: none; align-items: center; gap: 8px;" id="impostazioni-link">
                    <span>‚öôÔ∏è</span>
                    <span>Impostazioni</span>
                </a>
                <button class="btn btn-primary" onclick="openTariffaModal()">‚ûï Nuova Tariffa</button>
                <a href="conto-terzi-home-standalone.html" class="btn btn-secondary">‚Üê Dashboard</a>
            </div>
        </div>

        <div class="content">
            <div id="alert-container"></div>
            
            <div class="filters">
                <div class="filter-group">
                    <label>Filtra per Tipo Lavoro</label>
                    <input type="text" id="filter-tipo-lavoro" placeholder="Es: Aratura, Semina...">
                </div>
                <div class="filter-group">
                    <label>Filtra per Coltura</label>
                    <input type="text" id="filter-coltura" placeholder="Es: Grano, Mais...">
                </div>
                <div class="filter-group">
                    <label>Filtra per Tipo Campo</label>
                    <select id="filter-tipo-campo">
                        <option value="">Tutti</option>
                        <option value="pianura">Pianura</option>
                        <option value="collina">Collina</option>
                        <option value="montagna">Montagna</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Stato</label>
                    <select id="filter-attiva">
                        <option value="">Tutte</option>
                        <option value="true">Attive</option>
                        <option value="false">Disattivate</option>
                    </select>
                </div>
                <div class="filter-group" style="align-self: flex-end;">
                    <button class="btn btn-secondary" onclick="resetFilters()">Pulisci Filtri</button>
                </div>
            </div>

            <div class="section-header">
                <h2>Elenco Tariffe</h2>
                <div id="tariffe-count">0 tariffe</div>
            </div>

            <div id="tariffe-container">
                <div class="loading">Caricamento tariffe...</div>
            </div>
        </div>
    </div>

    <!-- Modal Tariffa -->
    <div id="tariffa-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Nuova Tariffa</h3>
                <button class="close-btn" onclick="closeTariffaModal()">&times;</button>
            </div>
            <form id="tariffa-form" onsubmit="handleSalvaTariffa(event)">
                <input type="hidden" id="tariffa-id">
                
                <div class="form-group">
                    <label for="lavoro-categoria-principale">Categoria Principale Lavoro *</label>
                    <select id="lavoro-categoria-principale" required>
                        <option value="">-- Seleziona categoria --</option>
                    </select>
                    <small>Seleziona la categoria funzionale principale del lavoro</small>
                </div>

                <div class="form-group" id="lavoro-sottocategoria-group" style="display: none;">
                    <label for="lavoro-sottocategoria">Sottocategoria</label>
                    <select id="lavoro-sottocategoria">
                        <option value="">-- Nessuna sottocategoria --</option>
                    </select>
                    <small>Sottocategoria specifica (opzionale, se disponibile)</small>
                </div>

                <div class="form-group">
                    <label for="tipo-lavoro">Tipo Lavoro *</label>
                    <select id="tipo-lavoro" required>
                        <option value="">-- Seleziona prima la categoria --</option>
                    </select>
                    <small style="display: block; margin-top: 5px; color: #666;">
                        <a href="#" onclick="event.preventDefault(); openTipoLavoroModal(); return false;" style="color: #1976D2; text-decoration: underline; font-size: 12px;">+ Aggiungi nuovo tipo lavoro</a>
                    </small>
                </div>

                <div class="form-group">
                    <label for="coltura-categoria">Categoria Coltura *</label>
                    <select id="coltura-categoria" required>
                        <option value="">-- Seleziona categoria --</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="coltura">Coltura</label>
                    <select id="coltura">
                        <option value="">-- Seleziona prima la categoria --</option>
                    </select>
                    <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                        <strong>üí° Lascia vuoto per applicare a tutte le colture della categoria</strong><br>
                        <a href="#" onclick="event.preventDefault(); window.location.href='../../../core/admin/impostazioni-standalone.html'; return false;" style="color: #1976D2; text-decoration: underline;">+ Aggiungi nuova coltura</a>
                    </small>
                </div>

                <div class="form-group">
                    <label for="tipo-campo">Tipo Campo</label>
                    <select id="tipo-campo">
                        <option value="">-- Seleziona per tariffa singola --</option>
                        <option value="pianura">üèûÔ∏è Pianura</option>
                        <option value="collina">‚õ∞Ô∏è Collina</option>
                        <option value="montagna">üèîÔ∏è Montagna</option>
                    </select>
                    <small>Lascia vuoto se vuoi creare tariffe per tutte le morfologie</small>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="tariffa-base">Tariffa Base (‚Ç¨/ettaro) *</label>
                        <input type="number" id="tariffa-base" required step="0.01" min="0" placeholder="0.00">
                        <small>Tariffa base per ettaro (pianura)</small>
                    </div>
                    <div class="form-group" id="coefficiente-group" style="display: none;">
                        <label for="coefficiente">Coefficiente *</label>
                        <input type="number" id="coefficiente" step="0.01" min="0.1" value="1.0" placeholder="1.0">
                        <small>Moltiplicatore per tipo campo (solo per tariffa singola)</small>
                    </div>
                </div>
                
                <div id="info-crea-multiple" style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 15px 0; display: none;">
                    <strong>‚ÑπÔ∏è Clicca "Crea per tutte le morfologie" per creare automaticamente 3 tariffe (pianura, collina, montagna) usando i coefficienti configurati nelle Impostazioni.</strong>
                </div>

                <div class="form-group">
                    <label for="attiva">Stato</label>
                    <select id="attiva">
                        <option value="true">Attiva</option>
                        <option value="false">Disattivata</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="note">Note</label>
                    <textarea id="note" placeholder="Note aggiuntive sulla tariffa..."></textarea>
                </div>

                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeTariffaModal()">Annulla</button>
                    <button type="button" id="btn-crea-multiple" class="btn btn-primary" style="background: #28a745;" onclick="handleCreaMultipleTariffe(event)">‚ú® Crea per tutte le morfologie</button>
                    <button type="submit" class="btn btn-primary">Salva Tariffa Singola</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Load Firebase config from external file -->
    <script>
        const configScript = document.createElement('script');
        configScript.src = '../../../core/config/firebase-config.js';
        configScript.onerror = function() {
            const fallbackScript = document.createElement('script');
            fallbackScript.src = 'https://raw.githubusercontent.com/VitaraDragon/gfv-platform/main/core/config/firebase-config.js';
            document.head.appendChild(fallbackScript);
        };
        document.head.appendChild(configScript);
    </script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, getDocs, doc, getDoc, addDoc, updateDoc, deleteDoc, query, where, orderBy, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Funzione per attendere il caricamento della configurazione Firebase
        function waitForConfig() {
            return new Promise((resolve, reject) => {
                if (typeof window.firebaseConfig !== 'undefined') {
                    resolve(window.firebaseConfig);
                    return;
                }
                
                let attempts = 0;
                const maxAttempts = 50;
                
                const checkInterval = setInterval(() => {
                    attempts++;
                    if (typeof window.firebaseConfig !== 'undefined') {
                        clearInterval(checkInterval);
                        resolve(window.firebaseConfig);
                    } else if (attempts >= maxAttempts) {
                        clearInterval(checkInterval);
                        reject(new Error('Firebase config not loaded after 5 seconds'));
                    }
                }, 100);
            });
        }

        const firebaseConfig = await waitForConfig();
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let currentTenantId = null;
        let tariffe = [];
        let tipiLavoro = [];
        
        // Variabili per struttura gerarchica tipi lavoro
        let categorieLavoriPrincipali = [];
        let sottocategorieLavoriMap = new Map();
        let tipiLavoroList = []; // Lista completa di tutti i tipi lavoro con struttura gerarchica

        // Verifica autenticazione
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                try {
                    const userDoc = await getDoc(doc(db, 'users', user.uid));
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        currentTenantId = userData.tenantId;
                        
                        // Imposta tenantId nel tenant-service per i servizi
                        try {
                            const { setCurrentTenantId } = await import('../../../core/services/tenant-service.js');
                            setCurrentTenantId(currentTenantId);
                        } catch (error) {
                            console.warn('Impossibile impostare tenantId nel servizio:', error);
                        }
                        
                        if (!currentTenantId) {
                            console.error('‚ö†Ô∏è TenantId non trovato nel documento utente');
                            showAlert('Errore: Tenant non configurato per questo utente', 'error');
                            return;
                        }

                        // Verifica permessi (solo Manager o Amministratore)
                        const ruoli = userData.ruoli || [];
                        const isManager = ruoli.some(r => {
                            const roleLower = r.toLowerCase();
                            return roleLower.includes('manager') || roleLower.includes('amministratore');
                        });

                        if (!isManager) {
                            showAlert('Non hai i permessi per accedere a questa pagina', 'error');
                            setTimeout(() => {
                                window.location.href = '../../../core/dashboard-standalone.html';
                            }, 2000);
                            return;
                        }
                        
                        // Mostra link impostazioni (solo Manager/Amministratore, gi√† verificato sopra)
                        const impostazioniLink = document.getElementById('impostazioni-link');
                        if (impostazioniLink) {
                            impostazioniLink.style.display = 'inline-flex';
                        }

                        // Setup filtri
                        setupFilters();
                        // Carica categorie lavori (deve essere prima di loadTipiLavoro)
                        await loadCategorieLavori();
                        // Carica tipi lavoro (senza filtro iniziale, mostra tutti)
                        await loadTipiLavoro();
                        // Setup handler per cambio categoria/sottocategoria
                        setupCategoriaLavoroHandler(); // Form principale
                        // Carica categorie e colture
                        await loadColture();
                        // Carica tariffe
                        await loadTariffe();
                    } else {
                        window.location.href = '../../../core/auth/login-standalone.html';
                    }
                } catch (error) {
                    console.error('Errore:', error);
                    showAlert('Errore caricamento dati', 'error');
                }
            } else {
                window.location.href = '../../../core/auth/login-standalone.html';
            }
        });

        // Setup filtri
        function setupFilters() {
            document.getElementById('filter-tipo-lavoro').addEventListener('input', () => filterTariffe());
            document.getElementById('filter-coltura').addEventListener('input', () => filterTariffe());
            document.getElementById('filter-tipo-campo').addEventListener('change', () => filterTariffe());
            document.getElementById('filter-attiva').addEventListener('change', () => filterTariffe());
        }

        // Reset filtri
        function resetFilters() {
            document.getElementById('filter-tipo-lavoro').value = '';
            document.getElementById('filter-coltura').value = '';
            document.getElementById('filter-tipo-campo').value = '';
            document.getElementById('filter-attiva').value = '';
            filterTariffe();
        }

        // Carica categorie lavori principali e sottocategorie
        async function loadCategorieLavori() {
            try {
                if (!currentTenantId) return;
                
                const isFileProtocol = window.location.protocol === 'file:';
                
                if (isFileProtocol) {
                    // Fallback per ambiente file://
                    const categorieRef = collection(db, `tenants/${currentTenantId}/categorie`);
                    const snapshot = await getDocs(query(categorieRef, orderBy('ordine', 'asc')));
                    categorieLavoriPrincipali = [];
                    sottocategorieLavoriMap.clear();
                    
                    snapshot.forEach(doc => {
                        const catData = { id: doc.id, ...doc.data() };
                        
                        // Escludi categorie di test (contengono "test" nel nome)
                        const nomeCategoria = (catData.nome || '').toLowerCase();
                        if (nomeCategoria.includes('test')) {
                            return; // Salta questa categoria
                        }
                        
                        if (catData.applicabileA === 'lavori' || catData.applicabileA === 'entrambi') {
                            if (!catData.parentId) {
                                categorieLavoriPrincipali.push(catData);
                            } else {
                                if (!sottocategorieLavoriMap.has(catData.parentId)) {
                                    sottocategorieLavoriMap.set(catData.parentId, []);
                                }
                                sottocategorieLavoriMap.get(catData.parentId).push(catData);
                            }
                        }
                    });
                } else {
                    // Usa servizio centralizzato
                    try {
                        const { setFirebaseInstances } = await import('../../../core/services/firebase-service.js');
                        setFirebaseInstances({ app, db, auth });
                        
                        const { setCurrentTenantId } = await import('../../../core/services/tenant-service.js');
                        if (currentTenantId) {
                            setCurrentTenantId(currentTenantId);
                        }
                        
                        const { getAllCategorie } = await import('../../../core/services/categorie-service.js');
                        const categorie = await getAllCategorie({
                            applicabileA: 'lavori',
                            orderBy: 'ordine',
                            orderDirection: 'asc'
                        });
                        
                        categorieLavoriPrincipali = [];
                        sottocategorieLavoriMap.clear();
                        
                        categorie.forEach(catData => {
                            // Escludi categorie di test (contengono "test" nel nome)
                            const nomeCategoria = (catData.nome || '').toLowerCase();
                            if (nomeCategoria.includes('test')) {
                                return; // Salta questa categoria
                            }
                            
                            if (catData.applicabileA === 'lavori' || catData.applicabileA === 'entrambi') {
                                if (!catData.parentId) {
                                    categorieLavoriPrincipali.push(catData);
                                } else {
                                    if (!sottocategorieLavoriMap.has(catData.parentId)) {
                                        sottocategorieLavoriMap.set(catData.parentId, []);
                                    }
                                    sottocategorieLavoriMap.get(catData.parentId).push(catData);
                                }
                            }
                        });
                        
                        // Ordina sottocategorie per ordine
                        sottocategorieLavoriMap.forEach((sottocat, parentId) => {
                            sottocat.sort((a, b) => (a.ordine || 0) - (b.ordine || 0));
                        });
                    } catch (error) {
                        console.error('Errore caricamento categorie lavori dal servizio:', error);
                        categorieLavoriPrincipali = [];
                    }
                }
                
                populateCategoriaLavoroDropdown();
            } catch (error) {
                console.error('Errore caricamento categorie lavori:', error);
                categorieLavoriPrincipali = [];
            }
        }
        
        // Popola dropdown categoria principale lavoro
        function populateCategoriaLavoroDropdown(prefix = '') {
            const select = document.getElementById(`${prefix}lavoro-categoria-principale`);
            if (!select) return;
            
            const currentValue = select.value;
            select.innerHTML = '<option value="">-- Seleziona categoria --</option>';
            
            categorieLavoriPrincipali.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = cat.nome || cat.codice || cat.id;
                select.appendChild(option);
            });
            
            if (currentValue) {
                select.value = currentValue;
            }
        }
        
        // Popola sottocategorie quando cambia categoria principale
        function populateSottocategorieLavoro(parentId, selectedValue = null, prefix = '') {
            const sottocategoriaSelect = document.getElementById(`${prefix}lavoro-sottocategoria`);
            const sottocategoriaGroup = document.getElementById(`${prefix}lavoro-sottocategoria-group`);
            
            if (!sottocategoriaSelect || !sottocategoriaGroup) return;
            
            sottocategoriaSelect.innerHTML = '<option value="">-- Nessuna sottocategoria --</option>';
            
            if (!parentId) {
                sottocategoriaGroup.style.display = 'none';
                return;
            }
            
            const sottocat = sottocategorieLavoriMap.get(parentId);
            if (sottocat && sottocat.length > 0) {
                sottocategoriaGroup.style.display = 'block';
                sottocat.forEach(subcat => {
                    const option = document.createElement('option');
                    option.value = subcat.id;
                    option.textContent = subcat.nome;
                    if (selectedValue === subcat.id) {
                        option.selected = true;
                    }
                    sottocategoriaSelect.appendChild(option);
                });
            } else {
                sottocategoriaGroup.style.display = 'none';
            }
        }
        
        // Carica tipi lavoro con struttura gerarchica
        async function loadTipiLavoro(categoriaId = null) {
            try {
                if (!currentTenantId) return;

                const isFileProtocol = window.location.protocol === 'file:';

                if (isFileProtocol) {
                    // Fallback per ambiente file://
                    const tipiRef = collection(db, `tenants/${currentTenantId}/tipiLavoro`);
                    const snapshot = await getDocs(query(tipiRef, orderBy('nome', 'asc')));
                    tipiLavoroList = [];
                    
                    snapshot.forEach(doc => {
                        tipiLavoroList.push({ id: doc.id, ...doc.data() });
                    });
                } else {
                    // Usa servizio centralizzato
                    try {
                        const { setFirebaseInstances } = await import('../../../core/services/firebase-service.js');
                        setFirebaseInstances({ app, db, auth });
                        
                        const { setCurrentTenantId } = await import('../../../core/services/tenant-service.js');
                        if (currentTenantId) {
                            setCurrentTenantId(currentTenantId);
                        }
                        
                        const { getAllTipiLavoro } = await import('../../../core/services/tipi-lavoro-service.js');
                        const tipiLavoro = await getAllTipiLavoro({
                            orderBy: 'nome',
                            orderDirection: 'asc'
                        });
                        
                        tipiLavoroList = tipiLavoro.map(tipo => ({
                            id: tipo.id,
                            nome: tipo.nome,
                            categoriaId: tipo.categoriaId,
                            sottocategoriaId: tipo.sottocategoriaId,
                            descrizione: tipo.descrizione,
                            predefinito: tipo.predefinito || false,
                            ...tipo
                        }));
                    } catch (error) {
                        console.error('Errore caricamento tipi lavoro dal servizio:', error);
                        tipiLavoroList = [];
                    }
                }

                // Filtra per categoria/sottocategoria se specificata
                let tipiLavoroFiltrati = tipiLavoroList;
                if (categoriaId) {
                    const categoriaTrovata = [...categorieLavoriPrincipali, ...Array.from(sottocategorieLavoriMap.values()).flat()].find(c => c.id === categoriaId);
                    
                    if (categoriaTrovata && categoriaTrovata.parentId) {
                        // √à una sottocategoria: filtra per sottocategoriaId
                        tipiLavoroFiltrati = tipiLavoroList.filter(tipo => tipo.sottocategoriaId === categoriaId);
                    } else {
                        // √à una categoria principale: include anche le sue sottocategorie
                        let allCategorieIds = [categoriaId];
                        const sottocat = sottocategorieLavoriMap.get(categoriaId);
                        if (sottocat) {
                            sottocat.forEach(subcat => allCategorieIds.push(subcat.id));
                        }
                        
                        tipiLavoroFiltrati = tipiLavoroList.filter(tipo => {
                            return tipo.categoriaId === categoriaId || 
                                   (tipo.sottocategoriaId && allCategorieIds.includes(tipo.sottocategoriaId));
                        });
                    }
                }

                // Popola dropdown con tipi filtrati
                populateTipiLavoroDropdown(tipiLavoroFiltrati);
                
                // Mantieni anche lista piatta per compatibilit√† con codice esistente
                tipiLavoro = tipiLavoroFiltrati.map(tipo => ({ nome: tipo.nome }));
            } catch (error) {
                console.error('Errore caricamento tipi lavoro:', error);
                tipiLavoroList = [];
                tipiLavoro = [];
            }
        }

        // Variabili globali per categorie e colture
        let categorieColture = [];
        let colturePerCategoria = {};

        // Carica categorie per colture usando servizi centralizzati
        async function loadCategorieColture() {
            try {
                if (!currentTenantId) {
                    console.warn('‚ö†Ô∏è currentTenantId non disponibile per caricare categorie colture');
                    return;
                }

                // Verifica se siamo in ambiente file:// (non supportato per moduli ES6)
                const isFileProtocol = window.location.protocol === 'file:';
                
                if (isFileProtocol) {
                    // Fallback: carica direttamente da Firestore
                    const categorieRef = collection(db, `tenants/${currentTenantId}/categorie`);
                    const categorieSnapshot = await getDocs(categorieRef);

                    categorieColture = [];
                    categorieSnapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.applicabileA === 'colture' || data.applicabileA === 'entrambi') {
                            categorieColture.push({ id: doc.id, ...data });
                        }
                    });
                    
                    // Ordina per ordine (client-side)
                    categorieColture.sort((a, b) => {
                        const ordineA = a.ordine || 999;
                        const ordineB = b.ordine || 999;
                        return ordineA - ordineB;
                    });
                } else {
                    // Usa servizi centralizzati
                    // Assicura che Firebase sia inizializzato nel servizio
                    const { setFirebaseInstances } = await import('../../../core/services/firebase-service.js');
                    setFirebaseInstances({ app, db, auth });
                    
                    // Assicura che il tenantId sia impostato nel servizio
                    const { setCurrentTenantId } = await import('../../../core/services/tenant-service.js');
                    if (currentTenantId) {
                        setCurrentTenantId(currentTenantId);
                    }
                    
                    // Carica categorie usando categorie-service.js
                    const { getAllCategorie } = await import('../../../core/services/categorie-service.js');
                    const categorie = await getAllCategorie({
                        applicabileA: 'colture',
                        orderBy: 'ordine',
                        orderDirection: 'asc'
                    });
                    
                    // Filtra solo categorie per colture (includi anche 'entrambi')
                    categorieColture = categorie.filter(cat => 
                        cat.applicabileA === 'colture' || cat.applicabileA === 'entrambi'
                    );
                }

                // Popola dropdown categorie
                const categoriaSelectNormal = document.getElementById('coltura-categoria');

                if (categoriaSelectNormal) {
                    const currentValue = categoriaSelectNormal.value;
                    categoriaSelectNormal.innerHTML = '<option value="">-- Seleziona categoria --</option>';
                    categorieColture.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat.id;
                        option.textContent = cat.nome;
                        categoriaSelectNormal.appendChild(option);
                    });
                    if (currentValue) {
                        categoriaSelectNormal.value = currentValue;
                    }
                }
            } catch (error) {
                console.error('Errore caricamento categorie colture:', error);
            }
        }

        // Carica colture organizzate per categoria usando servizi centralizzati
        async function loadColturePerCategoria() {
            try {
                if (!currentTenantId) {
                    console.warn('‚ö†Ô∏è currentTenantId non disponibile per caricare colture');
                    return;
                }

                // Verifica se siamo in ambiente file:// (non supportato per moduli ES6)
                const isFileProtocol = window.location.protocol === 'file:';
                
                if (isFileProtocol) {
                    // Fallback: carica direttamente da Firestore
                    const coltureRef = collection(db, `tenants/${currentTenantId}/colture`);
                    const coltureSnapshot = await getDocs(coltureRef);

                    colturePerCategoria = {};
                    const coltureArray = [];
                    coltureSnapshot.forEach(doc => {
                        const data = doc.data();
                        coltureArray.push({ id: doc.id, nome: data.nome, ...data });
                    });
                    
                    // Ordina client-side
                    coltureArray.sort((a, b) => (a.nome || '').localeCompare(b.nome || ''));
                    
                    // Organizza per categoria
                    coltureArray.forEach(coltura => {
                        const categoriaId = coltura.categoriaId || 'senza_categoria';
                        if (!colturePerCategoria[categoriaId]) {
                            colturePerCategoria[categoriaId] = [];
                        }
                        colturePerCategoria[categoriaId].push(coltura);
                    });
                    
                    // Se la collection √® vuota, prova a inizializzare le colture predefinite
                    if (coltureSnapshot.size === 0) {
                        try {
                            const { initializeColturePredefinite } = await import('../../../core/services/colture-service.js');
                            await initializeColturePredefinite();
                        } catch (initError) {
                            console.warn('‚ö†Ô∏è Impossibile inizializzare colture predefinite:', initError.message);
                        }
                    }
                } else {
                    // Usa servizi centralizzati
                    // Assicura che Firebase sia inizializzato nel servizio
                    const { setFirebaseInstances } = await import('../../../core/services/firebase-service.js');
                    setFirebaseInstances({ app, db, auth });
                    
                    // Assicura che il tenantId sia impostato nel servizio
                    const { setCurrentTenantId } = await import('../../../core/services/tenant-service.js');
                    if (currentTenantId) {
                        setCurrentTenantId(currentTenantId);
                    }
                    
                    // Assicura che le colture predefinite siano inizializzate
                    const { initializeColturePredefinite, getColturePerCategoria, getAllColture } = await import('../../../core/services/colture-service.js');
                    
                    // Verifica se ci sono poche colture e inizializza se necessario
                    const coltureEsistenti = await getAllColture();
                    if (coltureEsistenti.length < 20) {
                        await initializeColturePredefinite();
                    }
                    
                    // Usa colture-service.js per ottenere colture organizzate per categoria
                    colturePerCategoria = await getColturePerCategoria();
                    console.log('‚úÖ Colture caricate da servizio:', {
                        categorie: Object.keys(colturePerCategoria).length,
                        totaleColture: Object.values(colturePerCategoria).reduce((sum, arr) => sum + arr.length, 0),
                        struttura: Object.keys(colturePerCategoria).slice(0, 3) // Prime 3 categorie per debug
                    });
                }
            } catch (error) {
                console.error('‚ùå Errore caricamento colture:', error);
                console.error('‚ùå Dettagli errore:', {
                    code: error.code,
                    message: error.message,
                    tenantId: currentTenantId,
                    userId: currentUser?.uid
                });
                console.warn('Impossibile caricare da colture, uso ListePersonalizzate:', error.message);
                
                // Se √® un errore di permessi, potrebbe essere che la collection non esista ancora
                if (error.code === 'permission-denied' || error.message.includes('permission')) {
                    console.log('‚ö†Ô∏è Errore permessi - verifica che le regole Firestore siano pubblicate');
                    console.log('üí° Suggerimento: vai su Impostazioni per inizializzare le colture predefinite');
                }
                
                // Fallback: usa ListePersonalizzate
                try {
                    if (currentTenantId) {
                        const listeRef = doc(db, `tenants/${currentTenantId}/liste`, 'personalizzate');
                        const listeSnap = await getDoc(listeRef);
                        if (listeSnap.exists()) {
                            const data = listeSnap.data();
                            const colture = data.colture || [];
                            // Converti in formato gerarchico per retrocompatibilit√†
                            colturePerCategoria = { 'senza_categoria': colture.map(nome => ({ nome, categoriaId: null })) };
                            console.log('‚úÖ Fallback: caricate', colture.length, 'colture da ListePersonalizzate');
                        } else {
                            console.warn('‚ö†Ô∏è ListePersonalizzate non trovato, uso array vuoto');
                            colturePerCategoria = {};
                        }
                    }
                } catch (e) {
                    console.error('‚ùå Errore fallback ListePersonalizzate:', e);
                    colturePerCategoria = {};
                }
            }
        }

        // Aggiorna dropdown colture quando cambia categoria
        window.updateColtureDropdown = function(selectId) {
            const categoriaSelectId = 'coltura-categoria';
            const categoriaSelect = document.getElementById(categoriaSelectId);
            const colturaSelect = document.getElementById(selectId);

            if (!categoriaSelect || !colturaSelect) {
                console.warn('‚ö†Ô∏è Elementi non trovati:', { categoriaSelectId, selectId });
                return;
            }

            const categoriaId = categoriaSelect.value;
            const currentValue = colturaSelect.value;

            colturaSelect.innerHTML = '<option value="">-- Tutte le colture della categoria --</option>';

            if (!categoriaId) {
                return;
            }

            // Debug: verifica struttura dati
            console.log('üîç updateColtureDropdown:', {
                categoriaId,
                colturePerCategoriaKeys: Object.keys(colturePerCategoria),
                colturePerCategoriaSize: Object.keys(colturePerCategoria).length,
                hasCategoria: !!colturePerCategoria[categoriaId],
                coltureCount: colturePerCategoria[categoriaId]?.length || 0
            });

            if (colturePerCategoria[categoriaId] && colturePerCategoria[categoriaId].length > 0) {
                colturePerCategoria[categoriaId].forEach(coltura => {
                    const option = document.createElement('option');
                    option.value = coltura.nome;
                    option.textContent = coltura.nome;
                    colturaSelect.appendChild(option);
                });
                console.log('‚úÖ Popolato dropdown con', colturePerCategoria[categoriaId].length, 'colture');
            } else {
                console.warn('‚ö†Ô∏è Nessuna coltura trovata per categoria:', categoriaId);
                const option = document.createElement('option');
                option.value = '';
                option.textContent = '-- Nessuna coltura disponibile per questa categoria --';
                option.disabled = true;
                colturaSelect.appendChild(option);
            }

            // Ripristina valore selezionato se ancora valido
            if (currentValue) {
                const optionExists = Array.from(colturaSelect.options).some(opt => opt.value === currentValue);
                if (optionExists) {
                    colturaSelect.value = currentValue;
                }
            }
        }

        // Carica colture (wrapper per retrocompatibilit√†)
        async function loadColture() {
            await loadCategorieColture();
            await loadColturePerCategoria();
        }

        // Popola dropdown tipi lavoro
        function populateTipiLavoroDropdown(tipiFiltrati = null, prefix = '') {
            const select = document.getElementById(`${prefix}tipo-lavoro`);
            if (!select) return;
            
            // Mantieni valore selezionato se presente
            const currentValue = select.value;
            
            // Usa tipi filtrati se forniti, altrimenti usa tutti i tipi
            const tipiDaMostrare = tipiFiltrati || tipiLavoroList || tipiLavoro;
            
            if (tipiFiltrati && tipiFiltrati.length === 0) {
                select.innerHTML = '<option value="">-- Nessun tipo disponibile per questa categoria --</option>';
            } else if (tipiDaMostrare.length === 0) {
                select.innerHTML = '<option value="">-- Seleziona prima la categoria --</option>';
            } else {
                select.innerHTML = '<option value="">-- Seleziona tipo lavoro --</option>';
                
                tipiDaMostrare.forEach(tipo => {
                    const option = document.createElement('option');
                    const nomeTipo = tipo.nome || tipo;
                    option.value = nomeTipo;
                    option.textContent = nomeTipo;
                    select.appendChild(option);
                });
            }

            // Ripristina valore selezionato se presente e valido
            if (currentValue) {
                const optionExists = Array.from(select.options).some(opt => opt.value === currentValue);
                if (optionExists) {
                    select.value = currentValue;
                }
            }
        }
        
        // Setup handler per cambio categoria/sottocategoria lavoro
        function setupCategoriaLavoroHandler(prefix = '') {
            const categoriaPrincipaleSelect = document.getElementById(`${prefix}lavoro-categoria-principale`);
            const sottocategoriaSelect = document.getElementById(`${prefix}lavoro-sottocategoria`);
            
            if (categoriaPrincipaleSelect) {
                categoriaPrincipaleSelect.addEventListener('change', function() {
                    const categoriaPrincipaleId = this.value;
                    if (categoriaPrincipaleId) {
                        populateSottocategorieLavoro(categoriaPrincipaleId, null, prefix);
                        // Carica tipi lavoro per la categoria principale (include sottocategorie)
                        loadTipiLavoro(categoriaPrincipaleId);
                    } else {
                        const sottocategoriaGroup = document.getElementById(`${prefix}lavoro-sottocategoria-group`);
                        if (sottocategoriaGroup) sottocategoriaGroup.style.display = 'none';
                        const tipoLavoroSelect = document.getElementById(`${prefix}tipo-lavoro`);
                        if (tipoLavoroSelect) {
                            tipoLavoroSelect.innerHTML = '<option value="">-- Seleziona prima la categoria --</option>';
                            tipoLavoroSelect.value = '';
                        }
                    }
                });
            }
            
            if (sottocategoriaSelect) {
                sottocategoriaSelect.addEventListener('change', function() {
                    const sottocategoriaId = this.value;
                    const categoriaPrincipaleId = document.getElementById(`${prefix}lavoro-categoria-principale`)?.value;
                    
                    // Usa sottocategoria se selezionata, altrimenti categoria principale
                    const categoriaId = sottocategoriaId || categoriaPrincipaleId;
                    if (categoriaId) {
                        loadTipiLavoro(categoriaId);
                    }
                });
            }
        }

        // Carica tariffe
        async function loadTariffe() {
            const container = document.getElementById('tariffe-container');
            container.innerHTML = '<div class="loading">Caricamento tariffe...</div>';

            try {
                if (!currentTenantId) {
                    container.innerHTML = '<div class="empty-state">Nessun tenant trovato</div>';
                    return;
                }

                // Prova a caricare tariffe, se la collection non esiste mostra lista vuota
                try {
                    const tariffeQuery = query(
                        collection(db, 'tenants', currentTenantId, 'tariffe'),
                        orderBy('tipoLavoro')
                    );
                    const snapshot = await getDocs(tariffeQuery);
                    tariffe = [];
                    snapshot.forEach(doc => {
                        tariffe.push({ id: doc.id, ...doc.data() });
                    });
                } catch (error) {
                    // Se la collection non esiste o non ci sono permessi, lista vuota
                    if (error.code === 'permission-denied' || error.code === 'not-found') {
                        console.warn('Collection tariffe non accessibile o non esistente:', error.message);
                        tariffe = [];
                    } else {
                        throw error;
                    }
                }
                filterTariffe();
            } catch (error) {
                console.error('Errore caricamento tariffe:', error);
                showAlert('Errore caricamento tariffe: ' + error.message, 'error');
                container.innerHTML = '<div class="empty-state">Errore caricamento tariffe</div>';
            }
        }

        // Filtra tariffe
        function filterTariffe() {
            const filterTipoLavoro = document.getElementById('filter-tipo-lavoro').value.toLowerCase();
            const filterColtura = document.getElementById('filter-coltura').value.toLowerCase();
            const filterTipoCampo = document.getElementById('filter-tipo-campo').value;
            const filterAttiva = document.getElementById('filter-attiva').value;

            let filtered = tariffe.filter(tariffa => {
                // Filtro tipo lavoro
                if (filterTipoLavoro && !tariffa.tipoLavoro?.toLowerCase().includes(filterTipoLavoro)) {
                    return false;
                }

                // Filtro coltura (include anche categoria se coltura √® vuota)
                if (filterColtura) {
                    let colturaDisplay = '';
                    if (tariffa.coltura && tariffa.coltura.trim().length > 0) {
                        colturaDisplay = tariffa.coltura;
                    } else if (tariffa.categoriaColturaId) {
                        const categoria = categorieColture.find(cat => cat.id === tariffa.categoriaColturaId);
                        colturaDisplay = categoria ? categoria.nome : 'Tutte le colture';
                    } else {
                        colturaDisplay = 'Tutte le colture';
                    }
                    if (!colturaDisplay.toLowerCase().includes(filterColtura)) {
                        return false;
                    }
                }

                // Filtro tipo campo
                if (filterTipoCampo && tariffa.tipoCampo !== filterTipoCampo) {
                    return false;
                }

                // Filtro attiva
                if (filterAttiva !== '') {
                    const isAttiva = filterAttiva === 'true';
                    if (tariffa.attiva !== isAttiva) {
                        return false;
                    }
                }

                return true;
            });

            renderTariffe(filtered);
        }

        // Render tariffe
        function renderTariffe(tariffeList) {
            const container = document.getElementById('tariffe-container');
            document.getElementById('tariffe-count').textContent = `${tariffeList.length} tariffe`;

            if (tariffeList.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üí∞</div><p>Nessuna tariffa trovata</p></div>';
                return;
            }

            let html = '<table class="tariffe-table"><thead><tr>';
            html += '<th>Tipo Lavoro</th>';
            html += '<th>Coltura</th>';
            html += '<th>Tipo Campo</th>';
            html += '<th>Tariffa Base</th>';
            html += '<th>Coefficiente</th>';
            html += '<th>Tariffa Finale</th>';
            html += '<th>Stato</th>';
            html += '<th>Azioni</th>';
            html += '</tr></thead><tbody>';

            tariffeList.forEach(tariffa => {
                const tariffaFinale = (tariffa.tariffaBase || 0) * (tariffa.coefficiente || 1);
                const tipoCampoFormattato = {
                    'pianura': 'üèûÔ∏è Pianura',
                    'collina': '‚õ∞Ô∏è Collina',
                    'montagna': 'üèîÔ∏è Montagna'
                }[tariffa.tipoCampo] || tariffa.tipoCampo;
                
                // Determina display coltura: se vuota ma ha categoriaColturaId, mostra nome categoria
                let colturaDisplay = '';
                if (tariffa.coltura && tariffa.coltura.trim().length > 0) {
                    colturaDisplay = escapeHtml(tariffa.coltura);
                } else if (tariffa.categoriaColturaId) {
                    // Cerca nome categoria
                    const categoria = categorieColture.find(cat => cat.id === tariffa.categoriaColturaId);
                    colturaDisplay = categoria ? `<em style="color: #1976D2; font-weight: 500;">${escapeHtml(categoria.nome)}</em>` : '<em style="color: #666;">Tutte le colture</em>';
                } else {
                    colturaDisplay = '<em style="color: #666;">Tutte le colture</em>';
                }
                
                html += '<tr>';
                html += `<td><strong>${escapeHtml(tariffa.tipoLavoro || '')}</strong></td>`;
                html += `<td>${colturaDisplay}</td>`;
                html += `<td>${tipoCampoFormattato}</td>`;
                html += `<td>‚Ç¨ ${(tariffa.tariffaBase || 0).toFixed(2)}</td>`;
                html += `<td>${(tariffa.coefficiente || 1).toFixed(2)}x</td>`;
                html += `<td><strong>‚Ç¨ ${tariffaFinale.toFixed(2)}</strong></td>`;
                html += `<td><span class="badge ${tariffa.attiva ? 'badge-success' : 'badge-secondary'}">${tariffa.attiva ? 'Attiva' : 'Disattivata'}</span></td>`;
                html += `<td><div class="action-buttons">
                    <button class="btn btn-sm btn-primary" onclick="editTariffa('${tariffa.id}')">‚úèÔ∏è Modifica</button>
                    <button class="btn btn-sm" style="background: #17a2b8; color: white;" onclick="duplicaPerAltreMorfologie('${tariffa.id}')" title="Crea tariffe per le altre morfologie">‚ú® Duplica</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteTariffaConfirm('${tariffa.id}')">üóëÔ∏è Elimina</button>
                </div></td>`;
                html += '</tr>';
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Apri modal nuova tariffa
        window.openTariffaModal = function(tariffaId = null) {
            const modal = document.getElementById('tariffa-modal');
            const form = document.getElementById('tariffa-form');
            const title = document.getElementById('modal-title');
            
            form.reset();
            document.getElementById('tariffa-id').value = '';
            
            // Reset dropdown coltura
            const colturaSelect = document.getElementById('coltura');
            const categoriaSelect = document.getElementById('coltura-categoria');
            if (colturaSelect) {
                colturaSelect.innerHTML = '<option value="">-- Seleziona prima la categoria --</option>';
            }
            if (categoriaSelect) {
                categoriaSelect.value = '';
                // Rimuovi listener precedenti e aggiungi nuovo
                categoriaSelect.onchange = null;
                categoriaSelect.addEventListener('change', function() {
                    updateColtureDropdown('coltura');
                });
            }
            
            // Reset dropdown categoria/sottocategoria lavoro
            const lavoroCategoriaSelect = document.getElementById('lavoro-categoria-principale');
            const lavoroSottocategoriaSelect = document.getElementById('lavoro-sottocategoria');
            const lavoroSottocategoriaGroup = document.getElementById('lavoro-sottocategoria-group');
            if (lavoroCategoriaSelect) {
                lavoroCategoriaSelect.value = '';
            }
            if (lavoroSottocategoriaSelect) {
                lavoroSottocategoriaSelect.value = '';
            }
            if (lavoroSottocategoriaGroup) {
                lavoroSottocategoriaGroup.style.display = 'none';
            }
            const tipoLavoroSelect = document.getElementById('tipo-lavoro');
            if (tipoLavoroSelect) {
                tipoLavoroSelect.innerHTML = '<option value="">-- Seleziona prima la categoria --</option>';
            }
            
            if (tariffaId) {
                title.textContent = 'Modifica Tariffa';
                const tariffa = tariffe.find(t => t.id === tariffaId);
                if (tariffa) {
                    document.getElementById('tariffa-id').value = tariffa.id;
                    
                    // Precompila categoria/sottocategoria lavoro se disponibile
                    if (tariffa.tipoLavoro) {
                        // Trova il tipo lavoro nella lista per ottenere categoriaId/sottocategoriaId
                        const tipoLavoroTrovato = tipiLavoroList.find(t => t.nome === tariffa.tipoLavoro);
                        if (tipoLavoroTrovato) {
                            if (tipoLavoroTrovato.sottocategoriaId) {
                                // Ha una sottocategoria: trova la categoria principale
                                const sottocategoria = Array.from(sottocategorieLavoriMap.values()).flat().find(s => s.id === tipoLavoroTrovato.sottocategoriaId);
                                if (sottocategoria && sottocategoria.parentId) {
                                    lavoroCategoriaSelect.value = sottocategoria.parentId;
                                    populateSottocategorieLavoro(sottocategoria.parentId, tipoLavoroTrovato.sottocategoriaId);
                                    loadTipiLavoro(tipoLavoroTrovato.sottocategoriaId);
                                }
                            } else if (tipoLavoroTrovato.categoriaId) {
                                lavoroCategoriaSelect.value = tipoLavoroTrovato.categoriaId;
                                populateSottocategorieLavoro(tipoLavoroTrovato.categoriaId);
                                loadTipiLavoro(tipoLavoroTrovato.categoriaId);
                            }
                        } else {
                            // Tipo lavoro non trovato nella struttura gerarchica, carica tutti i tipi
                            loadTipiLavoro();
                        }
                    }
                    
                    // Imposta tipo lavoro dopo un breve delay per permettere il caricamento
                    setTimeout(() => {
                        if (tipoLavoroSelect) {
                            tipoLavoroSelect.value = tariffa.tipoLavoro || '';
                        }
                    }, 300);
                    // Imposta categoria e coltura
                    if (tariffa.coltura && tariffa.coltura.trim().length > 0) {
                        // Trova categoria della coltura
                        let categoriaId = null;
                        for (const [catId, colture] of Object.entries(colturePerCategoria)) {
                            const colturaTrovata = colture.find(c => c.nome === tariffa.coltura);
                            if (colturaTrovata) {
                                categoriaId = catId;
                                break;
                            }
                        }
                        if (categoriaId && categoriaId !== 'senza_categoria') {
                            document.getElementById('coltura-categoria').value = categoriaId;
                            updateColtureDropdown('coltura');
                        }
                        document.getElementById('coltura').value = tariffa.coltura || '';
                    } else {
                        // Coltura vuota = tutte le colture, imposta categoria se disponibile
                        if (tariffa.categoriaColturaId) {
                            document.getElementById('coltura-categoria').value = tariffa.categoriaColturaId;
                            updateColtureDropdown('coltura');
                        }
                        document.getElementById('coltura').value = '';
                    }
                    document.getElementById('tipo-campo').value = tariffa.tipoCampo || '';
                    document.getElementById('tariffa-base').value = tariffa.tariffaBase || '';
                    // Mostra coefficiente solo se tipo-campo √® selezionato
                    if (tariffa.tipoCampo) {
                        document.getElementById('coefficiente-group').style.display = 'block';
                        document.getElementById('coefficiente').value = tariffa.coefficiente || 1.0;
                        document.getElementById('coefficiente').required = true;
                        document.getElementById('info-crea-multiple').style.display = 'none';
                        document.getElementById('btn-crea-multiple').style.display = 'none';
                    } else {
                        document.getElementById('coefficiente-group').style.display = 'none';
                        document.getElementById('info-crea-multiple').style.display = 'block';
                        document.getElementById('btn-crea-multiple').style.display = 'inline-block';
                    }
                    document.getElementById('attiva').value = tariffa.attiva ? 'true' : 'false';
                    document.getElementById('note').value = tariffa.note || '';
                }
            } else {
                title.textContent = 'Nuova Tariffa';
                // Reset tipo-campo
                document.getElementById('tipo-campo').value = '';
                document.getElementById('coefficiente-group').style.display = 'none';
                document.getElementById('info-crea-multiple').style.display = 'block';
                // Popola dropdown tipi lavoro
                populateTipiLavoroDropdown();
            }
            
            // Listener per tipo-campo
            const tipoCampoSelect = document.getElementById('tipo-campo');
            tipoCampoSelect.onchange = function() {
                const tipoCampo = this.value;
                const coeffGroup = document.getElementById('coefficiente-group');
                const infoMultiple = document.getElementById('info-crea-multiple');
                const btnMultiple = document.getElementById('btn-crea-multiple');
                
                if (tipoCampo) {
                    // Tariffa singola: mostra coefficiente, nascondi pulsante multipla
                    coeffGroup.style.display = 'block';
                    document.getElementById('coefficiente').required = true;
                    infoMultiple.style.display = 'none';
                    btnMultiple.style.display = 'none';
                } else {
                    // Nessun tipo campo: nascondi coefficiente, mostra pulsante multipla
                    coeffGroup.style.display = 'none';
                    document.getElementById('coefficiente').required = false;
                    infoMultiple.style.display = 'block';
                    btnMultiple.style.display = 'inline-block';
                }
            };
            
            modal.classList.add('active');
        };

        // Chiudi modal
        window.closeTariffaModal = function() {
            document.getElementById('tariffa-modal').classList.remove('active');
            // Reset form
            document.getElementById('tariffa-form').reset();
            document.getElementById('coefficiente-group').style.display = 'none';
            document.getElementById('info-crea-multiple').style.display = 'none';
            document.getElementById('btn-crea-multiple').style.display = 'none';
        };


        // Duplica tariffa per altre morfologie
        window.duplicaPerAltreMorfologie = async function(tariffaId) {
            const tariffa = tariffe.find(t => t.id === tariffaId);
            if (!tariffa) {
                showAlert('Tariffa non trovata', 'error');
                return;
            }

            if (!currentTenantId && currentUser) {
                try {
                    const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                    if (userDoc.exists()) {
                        currentTenantId = userDoc.data().tenantId;
                    }
                } catch (error) {
                    console.error('Errore recupero tenant:', error);
                }
            }

            if (!currentTenantId) {
                showAlert('Errore: nessun tenant disponibile. Ricarica la pagina.', 'error');
                return;
            }

            // Determina le morfologie mancanti
            const morfologieEsistenti = tariffe
                .filter(t => t.tipoLavoro === tariffa.tipoLavoro && t.coltura === tariffa.coltura && t.id !== tariffa.id)
                .map(t => t.tipoCampo);

            const tutteMorfologie = ['pianura', 'collina', 'montagna'];
            const morfologieMancanti = tutteMorfologie.filter(m => !morfologieEsistenti.includes(m));

            if (morfologieMancanti.length === 0) {
                showAlert('‚úÖ Tutte le morfologie sono gi√† presenti per questa combinazione!', 'success');
                return;
            }

            // Carica coefficienti dalle impostazioni
            let coefficienti = {
                pianura: 1.0,
                collina: 1.2,
                montagna: 1.5
            };
            
            try {
                const coeffRef = doc(db, `tenants/${currentTenantId}/impostazioni`, 'coefficientiMorfologia');
                const coeffSnap = await getDoc(coeffRef);
                if (coeffSnap.exists()) {
                    const data = coeffSnap.data();
                    coefficienti = {
                        pianura: data.pianura || 1.0,
                        collina: data.collina || 1.2,
                        montagna: data.montagna || 1.5
                    };
                }
            } catch (error) {
                console.warn('Errore caricamento coefficienti, uso default:', error);
            }

            const coeffPianura = coefficienti.pianura;
            const coeffCollina = coefficienti.collina;
            const coeffMontagna = coefficienti.montagna;

            let colturaDisplay = '';
            if (tariffa.coltura && tariffa.coltura.trim().length > 0) {
                colturaDisplay = tariffa.coltura;
            } else if (tariffa.categoriaColturaId) {
                const categoria = categorieColture.find(cat => cat.id === tariffa.categoriaColturaId);
                colturaDisplay = categoria ? categoria.nome : 'Tutte le colture';
            } else {
                colturaDisplay = 'Tutte le colture';
            }
            if (!confirm(`Vuoi creare ${morfologieMancanti.length} tariffa/e per le morfologie mancanti?\n\nMorfologie da creare: ${morfologieMancanti.map(m => {
                const emoji = { 'pianura': 'üèûÔ∏è', 'collina': '‚õ∞Ô∏è', 'montagna': 'üèîÔ∏è' }[m];
                return `${emoji} ${m}`;
            }).join(', ')}\n\nTipo Lavoro: ${tariffa.tipoLavoro}\nColtura: ${colturaDisplay}`)) {
                return;
            }

            let createCount = 0;
            const errors = [];

            try {
                for (const morf of morfologieMancanti) {
                    try {
                        // Verifica se esiste gi√† (doppio controllo)
                        const tariffeEsistenti = await getDocs(query(
                            collection(db, 'tenants', currentTenantId, 'tariffe'),
                            where('tipoLavoro', '==', tariffa.tipoLavoro),
                            where('coltura', '==', (tariffa.coltura || '').trim() || ''),
                            where('tipoCampo', '==', morf)
                        ));

                        if (!tariffeEsistenti.empty) {
                            continue;
                        }

                        let coefficiente;
                        if (morf === 'pianura') coefficiente = coeffPianura;
                        else if (morf === 'collina') coefficiente = coeffCollina;
                        else coefficiente = coeffMontagna;

                        const tariffaData = {
                            tipoLavoro: tariffa.tipoLavoro,
                            coltura: (tariffa.coltura || '').trim() || '', // Gestisce null/undefined
                            categoriaColturaId: tariffa.categoriaColturaId || null, // Mantieni categoria se presente
                            tipoCampo: morf,
                            tariffaBase: tariffa.tariffaBase,
                            coefficiente: coefficiente,
                            attiva: tariffa.attiva,
                            note: tariffa.note || '',
                            createdAt: serverTimestamp(),
                            updatedAt: serverTimestamp()
                        };

                        await addDoc(collection(db, 'tenants', currentTenantId, 'tariffe'), tariffaData);
                        createCount++;
                    } catch (error) {
                        console.error(`Errore creazione tariffa ${morf}:`, error);
                        errors.push(`${morf}: ${error.message}`);
                    }
                }

                if (createCount > 0) {
                    showAlert(`‚úÖ Create ${createCount} tariffa/e per le morfologie mancanti!`, 'success');
                } else {
                    showAlert(`‚ö†Ô∏è Nessuna tariffa creata. ${errors.length > 0 ? 'Errori: ' + errors.join('; ') : 'Tutte le tariffe esistono gi√†.'}`, 'error');
                }

                await loadTariffe();
            } catch (error) {
                console.error('Errore duplicazione tariffe:', error);
                showAlert('Errore: ' + error.message, 'error');
            }
        };

        // Crea tariffe per tutte le morfologie
        window.handleCreaMultipleTariffe = async function(event) {
            event.preventDefault();
            
            if (!currentTenantId) {
                showAlert('Errore: nessun tenant disponibile. Verifica che il tuo account abbia un tenantId configurato.', 'error');
                return;
            }

            const tipoLavoro = document.getElementById('tipo-lavoro').value.trim();
            const colturaValue = document.getElementById('coltura').value.trim();
            const categoriaColturaId = document.getElementById('coltura-categoria').value || null;
            const tariffaBase = parseFloat(document.getElementById('tariffa-base').value);
            const attiva = document.getElementById('attiva').value === 'true';
            const note = document.getElementById('note').value.trim() || '';

            // Validazione
            if (!tipoLavoro || !tariffaBase || tariffaBase <= 0) {
                showAlert('Errore: Compila tutti i campi obbligatori con valori validi', 'error');
                return;
            }

            // Carica coefficienti dalle impostazioni
            let coefficienti = {
                pianura: 1.0,
                collina: 1.2,
                montagna: 1.5
            };
            
            try {
                const coeffRef = doc(db, `tenants/${currentTenantId}/impostazioni`, 'coefficientiMorfologia');
                const coeffSnap = await getDoc(coeffRef);
                if (coeffSnap.exists()) {
                    const data = coeffSnap.data();
                    coefficienti = {
                        pianura: data.pianura || 1.0,
                        collina: data.collina || 1.2,
                        montagna: data.montagna || 1.5
                    };
                }
            } catch (error) {
                console.warn('Errore caricamento coefficienti, uso default:', error);
            }

            const morfologie = [
                { tipo: 'pianura', coefficiente: coefficienti.pianura, emoji: 'üèûÔ∏è' },
                { tipo: 'collina', coefficiente: coefficienti.collina, emoji: '‚õ∞Ô∏è' },
                { tipo: 'montagna', coefficiente: coefficienti.montagna, emoji: 'üèîÔ∏è' }
            ];

            let createCount = 0;
            let skipCount = 0;
            const errors = [];

            try {
                // Crea le 3 tariffe
                for (const morf of morfologie) {
                    try {
                        // Verifica se esiste gi√†
                        const tariffeEsistenti = await getDocs(query(
                            collection(db, 'tenants', currentTenantId, 'tariffe'),
                            where('tipoLavoro', '==', tipoLavoro),
                            where('coltura', '==', colturaValue || ''),
                            where('tipoCampo', '==', morf.tipo)
                        ));

                        if (!tariffeEsistenti.empty) {
                            skipCount++;
                            continue;
                        }

                        const tariffaData = {
                            tipoLavoro,
                            coltura: colturaValue || '',
                            categoriaColturaId: (!colturaValue && categoriaColturaId) ? categoriaColturaId : null,
                            tipoCampo: morf.tipo,
                            tariffaBase,
                            coefficiente: morf.coefficiente,
                            attiva,
                            note,
                            createdAt: serverTimestamp(),
                            updatedAt: serverTimestamp()
                        };

                        await addDoc(collection(db, 'tenants', currentTenantId, 'tariffe'), tariffaData);
                        createCount++;
                    } catch (error) {
                        console.error(`Errore creazione tariffa ${morf.tipo}:`, error);
                        errors.push(`${morf.emoji} ${morf.tipo}: ${error.message}`);
                    }
                }

                // Mostra risultato
                if (createCount > 0) {
                    showAlert(`‚úÖ Create ${createCount} tariffa/e con successo!${skipCount > 0 ? ` (${skipCount} gi√† esistenti)` : ''}`, 'success');
                    closeTariffaModal();
                    await loadTariffe();
                } else {
                    showAlert(`‚ö†Ô∏è Nessuna tariffa creata. ${skipCount > 0 ? 'Tutte le tariffe esistono gi√†.' : ''}${errors.length > 0 ? ' Errori: ' + errors.join('; ') : ''}`, 'warning');
                }
            } catch (error) {
                console.error('Errore creazione tariffe:', error);
                showAlert('Errore: ' + error.message, 'error');
            }
        };

        // Salva tariffa
        window.handleSalvaTariffa = async function(event) {
            event.preventDefault();
            
            // Verifica e recupera tenantId se necessario
            if (!currentTenantId && currentUser) {
                try {
                    const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                    if (userDoc.exists()) {
                        currentTenantId = userDoc.data().tenantId;
                    }
                } catch (error) {
                    console.error('Errore recupero tenant:', error);
                    if (error.code === 'permission-denied') {
                        showAlert('Errore: Permessi insufficienti per leggere i dati utente. Verifica le regole di sicurezza Firestore.', 'error');
                        return;
                    }
                }
            }
            
            if (!currentTenantId) {
                showAlert('Errore: nessun tenant disponibile. Verifica che il tuo account abbia un tenantId configurato.', 'error');
                return;
            }

            const tariffaId = document.getElementById('tariffa-id').value;
            const tipoCampo = document.getElementById('tipo-campo').value;
            
            // Validazione: tipo-campo obbligatorio per tariffa singola
            if (!tipoCampo) {
                showAlert('Errore: Seleziona un tipo campo o usa "Crea per tutte le morfologie"', 'error');
                return;
            }
            
            const colturaValue = document.getElementById('coltura').value.trim();
            const categoriaColturaId = document.getElementById('coltura-categoria').value || null;
            const tariffaData = {
                tipoLavoro: document.getElementById('tipo-lavoro').value.trim(),
                coltura: colturaValue || '', // Permetti stringa vuota per "tutte le colture"
                categoriaColturaId: (!colturaValue && categoriaColturaId) ? categoriaColturaId : null, // Salva categoria solo se coltura √® vuota
                tipoCampo: tipoCampo,
                tariffaBase: parseFloat(document.getElementById('tariffa-base').value),
                coefficiente: parseFloat(document.getElementById('coefficiente').value),
                attiva: document.getElementById('attiva').value === 'true',
                note: document.getElementById('note').value.trim() || '',
                updatedAt: serverTimestamp()
            };

            try {
                if (tariffaId) {
                    await updateDoc(doc(db, 'tenants', currentTenantId, 'tariffe', tariffaId), tariffaData);
                    showAlert('Tariffa aggiornata con successo', 'success');
                } else {
                    tariffaData.createdAt = serverTimestamp();
                    await addDoc(collection(db, 'tenants', currentTenantId, 'tariffe'), tariffaData);
                    showAlert('Tariffa creata con successo', 'success');
                }
                
                window.closeTariffaModal();
                await loadTariffe();
            } catch (error) {
                console.error('Errore salvataggio tariffa:', error);
                if (error.code === 'permission-denied') {
                    showAlert('Errore: Permessi insufficienti per salvare la tariffa. Verifica che le regole Firestore permettano l\'accesso alla collection "tariffe". Vedi file firestore.rules nella root del progetto.', 'error');
                } else {
                    showAlert('Errore: ' + error.message, 'error');
                }
            }
        };

        // Elimina tariffa
        window.deleteTariffaConfirm = async function(tariffaId) {
            const tariffa = tariffe.find(t => t.id === tariffaId);
            if (!tariffa) return;

            // Verifica e recupera tenantId se necessario
            if (!currentTenantId && currentUser) {
                try {
                    const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                    if (userDoc.exists()) {
                        currentTenantId = userDoc.data().tenantId;
                    }
                } catch (error) {
                    console.error('Errore recupero tenant:', error);
                }
            }

            if (!currentTenantId) {
                showAlert('Errore: nessun tenant disponibile. Ricarica la pagina.', 'error');
                return;
            }

            let colturaDisplay = '';
            if (tariffa.coltura && tariffa.coltura.trim().length > 0) {
                colturaDisplay = tariffa.coltura;
            } else if (tariffa.categoriaColturaId) {
                const categoria = categorieColture.find(cat => cat.id === tariffa.categoriaColturaId);
                colturaDisplay = categoria ? categoria.nome : 'Tutte le colture';
            } else {
                colturaDisplay = 'Tutte le colture';
            }
            if (!confirm(`Sei sicuro di voler eliminare la tariffa "${tariffa.tipoLavoro} - ${colturaDisplay} - ${tariffa.tipoCampo}"?`)) {
                return;
            }

            try {
                await deleteDoc(doc(db, 'tenants', currentTenantId, 'tariffe', tariffaId));
                showAlert('Tariffa eliminata con successo', 'success');
                await loadTariffe();
            } catch (error) {
                console.error('Errore eliminazione tariffa:', error);
                showAlert('Errore: ' + error.message, 'error');
            }
        };

        // Alias per compatibilit√†
        window.editTariffa = function(tariffaId) {
            window.openTariffaModal(tariffaId);
        };

        // Utility functions
        function showAlert(message, type = 'info') {
            const container = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.innerHTML = '';
            container.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Funzioni per gestire creazione nuovo tipo lavoro (placeholder - da implementare se necessario)
        window.openTipoLavoroModal = function() {
            // TODO: Implementare modal creazione tipo lavoro se necessario
            // Per ora, reindirizza alle impostazioni
            if (confirm('Vuoi aggiungere un nuovo tipo lavoro? Verrai reindirizzato alle Impostazioni.')) {
                window.location.href = '../../../core/admin/impostazioni-standalone.html';
            }
        };

        // Funzione rimossa - non pi√π necessaria con modal unificato
        // Funzione rimossa - non pi√π necessaria con modal unificato
    </script>
</body>
</html>

