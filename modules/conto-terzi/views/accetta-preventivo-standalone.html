<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accetta Preventivo - GFV Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #E3F2FD 0%, #1976D2 100%);
            color: #333;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            width: 100%;
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #1976D2;
        }

        .header h1 {
            color: #1976D2;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .preventivo-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #dee2e6;
        }

        .info-row:last-child {
            border-bottom: none;
            font-size: 18px;
            font-weight: bold;
            color: #1976D2;
            margin-top: 10px;
            padding-top: 15px;
            border-top: 2px solid #1976D2;
        }

        .info-label {
            font-weight: 600;
            color: #495057;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }

        .actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìã Preventivo</h1>
            <p style="color: #666;">Visualizza e gestisci il preventivo</p>
        </div>

        <div id="alert-container"></div>

        <div id="loading" class="loading">
            Caricamento preventivo...
        </div>

        <div id="preventivo-content" style="display: none;">
            <div class="preventivo-info">
                <div class="info-row">
                    <span class="info-label">Numero Preventivo:</span>
                    <span id="numero-preventivo">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Cliente:</span>
                    <span id="cliente-nome">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Tipo Lavoro:</span>
                    <span id="tipo-lavoro">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Coltura:</span>
                    <span id="coltura">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Tipo Campo:</span>
                    <span id="tipo-campo">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Superficie:</span>
                    <span id="superficie">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Totale Imponibile:</span>
                    <span id="totale-imponibile">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">IVA (<span id="iva-percentuale">0</span>%):</span>
                    <span id="totale-iva">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Totale con IVA:</span>
                    <span id="totale-con-iva">-</span>
                </div>
            </div>

            <div id="note-section" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; display: none;">
                <strong>Note:</strong>
                <p id="note-text" style="margin-top: 10px; color: #666;"></p>
            </div>

            <div class="actions" id="actions-container">
                <!-- Azioni verranno aggiunte dinamicamente -->
            </div>
        </div>
    </div>

    <!-- Load Firebase config from external file -->
    <script>
        // Configurazione Firebase di fallback (se il file esterno non viene caricato)
        const fallbackConfig = {
            apiKey: "AIzaSyBOqH6Oax3_JRQhMaU8Fp36wxgYo3s_pw0",
            authDomain: "gfv-platform.firebaseapp.com",
            projectId: "gfv-platform",
            storageBucket: "gfv-platform.firebasestorage.app",
            messagingSenderId: "495860225347",
            appId: "1:495860225347:web:79edd2bdd78fe92f0bcbf6"
        };

        // Prova a caricare la configurazione da file esterno
        const configScript = document.createElement('script');
        configScript.src = '../../../core/config/firebase-config.js';
        configScript.onload = function() {
            // Se il file viene caricato ma non definisce window.firebaseConfig, usa il fallback
            setTimeout(() => {
                if (typeof window.firebaseConfig === 'undefined') {
                    console.warn('Firebase config file loaded but config not found, using fallback');
                    window.firebaseConfig = fallbackConfig;
                }
            }, 100);
        };
        configScript.onerror = function() {
            console.warn('Firebase config file not found, using fallback');
            // Usa configurazione di fallback
            window.firebaseConfig = fallbackConfig;
        };
        document.head.appendChild(configScript);
        
        // Timeout di sicurezza: se dopo 1 secondo non √® ancora caricato, usa fallback
        setTimeout(() => {
            if (typeof window.firebaseConfig === 'undefined') {
                console.warn('Firebase config loading timeout, using fallback');
                window.firebaseConfig = fallbackConfig;
            }
        }, 1000);
    </script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, getDocs, doc, getDoc, updateDoc, query, where, serverTimestamp, Timestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Variabili globali per le funzioni di accettazione/rifiuto
        let preventivoData = null;
        let tenantIdData = null;
        let dbInstance = null;

        // Funzione per attendere il caricamento della configurazione Firebase
        function waitForConfig() {
            return new Promise((resolve, reject) => {
                if (typeof window.firebaseConfig !== 'undefined') {
                    resolve(window.firebaseConfig);
                    return;
                }
                
                let attempts = 0;
                const maxAttempts = 50;
                
                const checkInterval = setInterval(() => {
                    attempts++;
                    if (typeof window.firebaseConfig !== 'undefined') {
                        clearInterval(checkInterval);
                        resolve(window.firebaseConfig);
                    } else if (attempts >= maxAttempts) {
                        clearInterval(checkInterval);
                        reject(new Error('Firebase config not loaded after 5 seconds'));
                    }
                }, 100);
            });
        }

        // Utility functions
        function showAlert(message, type = 'info') {
            const container = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.innerHTML = '';
            container.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        // Funzioni accetta/rifiuta (definite globalmente)
        window.accettaPreventivo = async function() {
            if (!preventivoData || !tenantIdData || !dbInstance) {
                showAlert('Errore: Dati preventivo non disponibili. Ricarica la pagina.', 'error');
                console.error('Dati mancanti:', { preventivoData, tenantIdData, dbInstance });
                return;
            }

            if (!confirm('Sei sicuro di voler accettare questo preventivo?')) {
                return;
            }

            const actionsContainer = document.getElementById('actions-container');
            const btnAccetta = actionsContainer.querySelector('.btn-success');
            if (btnAccetta) {
                btnAccetta.disabled = true;
                btnAccetta.textContent = '‚è≥ Elaborazione...';
            }

            try {
                await updateDoc(doc(dbInstance, 'tenants', tenantIdData, 'preventivi', preventivoData.id), {
                    stato: 'accettato_email',
                    dataAccettazione: serverTimestamp()
                });
                
                showAlert('Preventivo accettato con successo!', 'success');
                actionsContainer.innerHTML = '<div class="alert alert-success">‚úÖ Preventivo accettato con successo!</div>';
                
                // Aggiorna i dati locali
                preventivoData.stato = 'accettato_email';
            } catch (error) {
                console.error('Errore accettazione:', error);
                showAlert('Errore: ' + error.message, 'error');
                if (btnAccetta) {
                    btnAccetta.disabled = false;
                    btnAccetta.textContent = '‚úÖ Accetta Preventivo';
                }
            }
        };

        window.rifiutaPreventivo = async function() {
            if (!preventivoData || !tenantIdData || !dbInstance) {
                showAlert('Errore: Dati preventivo non disponibili. Ricarica la pagina.', 'error');
                console.error('Dati mancanti:', { preventivoData, tenantIdData, dbInstance });
                return;
            }

            if (!confirm('Sei sicuro di voler rifiutare questo preventivo?')) {
                return;
            }

            const actionsContainer = document.getElementById('actions-container');
            const btnRifiuta = actionsContainer.querySelector('.btn-danger');
            if (btnRifiuta) {
                btnRifiuta.disabled = true;
                btnRifiuta.textContent = '‚è≥ Elaborazione...';
            }

            try {
                await updateDoc(doc(dbInstance, 'tenants', tenantIdData, 'preventivi', preventivoData.id), {
                    stato: 'rifiutato'
                });
                
                showAlert('Preventivo rifiutato.', 'success');
                actionsContainer.innerHTML = '<div class="alert alert-error">‚ùå Preventivo rifiutato.</div>';
                
                // Aggiorna i dati locali
                preventivoData.stato = 'rifiutato';
            } catch (error) {
                console.error('Errore rifiuto:', error);
                showAlert('Errore: ' + error.message, 'error');
                if (btnRifiuta) {
                    btnRifiuta.disabled = false;
                    btnRifiuta.textContent = '‚ùå Rifiuta Preventivo';
                }
            }
        };

        // Ottieni token dalla URL
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        const action = urlParams.get('action') || (window.location.pathname.includes('accetta') ? 'accetta' : 'rifiuta');

        if (!token) {
            document.getElementById('loading').innerHTML = '<div class="alert alert-error">Token non valido. Link non valido o scaduto.</div>';
        } else {
            try {
                const firebaseConfig = await waitForConfig();
                const app = initializeApp(firebaseConfig);
                dbInstance = getFirestore(app);

                // Cerca preventivo per token
                let preventivo = null;
                let tenantId = null;

                // Cerca in tutti i tenant (non abbiamo tenantId dal token)
                const tenantsSnapshot = await getDocs(collection(dbInstance, 'tenants'));
                
                for (const tenantDoc of tenantsSnapshot.docs) {
                    const tenantIdCheck = tenantDoc.id;
                    const preventiviQuery = query(
                        collection(dbInstance, 'tenants', tenantIdCheck, 'preventivi'),
                        where('tokenAccettazione', '==', token)
                    );
                    const preventiviSnapshot = await getDocs(preventiviQuery);
                    
                    if (!preventiviSnapshot.empty) {
                        tenantId = tenantIdCheck;
                        const preventivoDoc = preventiviSnapshot.docs[0];
                        preventivo = { id: preventivoDoc.id, ...preventivoDoc.data() };
                        break;
                    }
                }

                if (!preventivo) {
                    document.getElementById('loading').innerHTML = '<div class="alert alert-error">Preventivo non trovato. Link non valido o scaduto.</div>';
                } else {
                    // Salva i dati globalmente per le funzioni
                    preventivoData = preventivo;
                    tenantIdData = tenantId;

                    // Carica dati cliente
                    const clienteDoc = await getDoc(doc(dbInstance, 'tenants', tenantId, 'clienti', preventivo.clienteId));
                    const cliente = clienteDoc.exists() ? clienteDoc.data() : null;

                    // Verifica stato
                    const dataScadenza = preventivo.dataScadenza?.toDate ? preventivo.dataScadenza.toDate() : null;
                    const isScaduto = dataScadenza && new Date() > dataScadenza;

                    // Mostra preventivo
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('preventivo-content').style.display = 'block';

                    // Popola dati
                    document.getElementById('numero-preventivo').textContent = preventivo.numero || '-';
                    document.getElementById('cliente-nome').textContent = cliente?.ragioneSociale || 'Cliente non trovato';
                    document.getElementById('tipo-lavoro').textContent = preventivo.tipoLavoro || '-';
                    document.getElementById('coltura').textContent = preventivo.coltura || '-';
                    
                    const tipoCampoFormattato = {
                        'pianura': 'üèûÔ∏è Pianura',
                        'collina': '‚õ∞Ô∏è Collina',
                        'montagna': 'üèîÔ∏è Montagna'
                    }[preventivo.tipoCampo] || preventivo.tipoCampo;
                    document.getElementById('tipo-campo').textContent = tipoCampoFormattato;
                    
                    document.getElementById('superficie').textContent = `${(preventivo.superficie || 0).toFixed(2)} ettari`;
                    document.getElementById('totale-imponibile').textContent = `‚Ç¨ ${(preventivo.totale || 0).toFixed(2)}`;
                    document.getElementById('iva-percentuale').textContent = preventivo.iva || 22;
                    document.getElementById('totale-iva').textContent = `‚Ç¨ ${((preventivo.totale || 0) * ((preventivo.iva || 22) / 100)).toFixed(2)}`;
                    document.getElementById('totale-con-iva').textContent = `‚Ç¨ ${(preventivo.totaleConIva || preventivo.totale || 0).toFixed(2)}`;

                    if (preventivo.note) {
                        document.getElementById('note-text').textContent = preventivo.note;
                        document.getElementById('note-section').style.display = 'block';
                    }

                    // Mostra azioni in base allo stato
                    const actionsContainer = document.getElementById('actions-container');
                    const stato = preventivo.stato;

                    if (isScaduto) {
                        actionsContainer.innerHTML = '<div class="alert alert-warning">‚ö†Ô∏è Questo preventivo √® scaduto e non pu√≤ pi√π essere accettato.</div>';
                    } else if (stato === 'accettato_email' || stato === 'accettato_manager') {
                        actionsContainer.innerHTML = '<div class="alert alert-success">‚úÖ Questo preventivo √® gi√† stato accettato.</div>';
                    } else if (stato === 'rifiutato') {
                        actionsContainer.innerHTML = '<div class="alert alert-error">‚ùå Questo preventivo √® stato rifiutato.</div>';
                    } else if (stato === 'pianificato') {
                        actionsContainer.innerHTML = '<div class="alert alert-success">üìã Questo preventivo √® stato pianificato e il lavoro √® stato creato.</div>';
                    } else if (stato === 'inviato' || stato === 'bozza') {
                        // Mostra pulsanti accetta/rifiuta
                        actionsContainer.innerHTML = `
                            <button class="btn btn-success" onclick="accettaPreventivo()">‚úÖ Accetta Preventivo</button>
                            <button class="btn btn-danger" onclick="rifiutaPreventivo()">‚ùå Rifiuta Preventivo</button>
                        `;
                    } else {
                        actionsContainer.innerHTML = '<div class="alert alert-warning">‚ö†Ô∏è Stato preventivo non valido per questa operazione.</div>';
                    }
                }
            } catch (error) {
                console.error('Errore caricamento preventivo:', error);
                document.getElementById('loading').innerHTML = '<div class="alert alert-error">Errore caricamento preventivo: ' + error.message + '</div>';
            }
        }
    </script>
</body>
</html>




