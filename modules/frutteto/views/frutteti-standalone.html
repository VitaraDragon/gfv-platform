<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anagrafica Frutteti - GFV Platform</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#FF6F00">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #FFE0B2 0%, #FF6F00 100%);
            color: #333;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #FF6F00 0%, #E65100 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .btn-primary:hover {
            background: rgba(255,255,255,0.3);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }

        .content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            justify-content: flex-start;
            align-items: flex-end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 12px;
            font-weight: 600;
            color: #495057;
        }

        .filter-group select,
        .filter-group input {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
            min-width: 150px;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            position: sticky;
            top: 0;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #495057;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .modal-header h2 {
            color: #FF6F00;
            font-size: 24px;
        }

        .close {
            font-size: 28px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
            border: none;
            background: none;
        }

        .close:hover {
            color: #000;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #FF6F00;
        }

        .form-group textarea {
            min-height: 60px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .error-message {
            color: #dc3545;
            font-size: 12px;
            margin-top: 5px;
        }

        .form-actions {
            margin-top: 20px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 11px;
            background: #f1f3f5;
            color: #495057;
        }

        .pill span.icon {
            font-size: 13px;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
            }
            .header-actions {
                width: 100%;
                justify-content: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>üçé Anagrafica Frutteti</h1>
                <p style="opacity: 0.9;">Gestisci i tuoi frutteti e le loro caratteristiche</p>
            </div>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="openCreateModal()">‚ûï Nuovo Frutteto</button>
                <a href="raccolta-frutta-standalone.html" class="btn btn-primary">üçé Gestisci Raccolta</a>
                <a href="frutteto-dashboard-standalone.html" class="btn btn-secondary">‚Üê Dashboard</a>
            </div>
        </div>

        <div class="content">
            <div class="filters">
                <div class="filter-group">
                    <label>Terreno</label>
                    <select id="filter-terreno" onchange="applyFilters()">
                        <option value="">Tutti i terreni</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Specie</label>
                    <select id="filter-specie" onchange="applyFilters()">
                        <option value="">Tutte le specie</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Variet√†</label>
                    <select id="filter-varieta" onchange="applyFilters()">
                        <option value="">Tutte le variet√†</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Stato</label>
                    <select id="filter-stato" onchange="applyFilters()">
                        <option value="">Tutti gli stati</option>
                        <option value="attivo">Attivo</option>
                        <option value="in_riposo">In riposo</option>
                        <option value="da_rimuovere">Da rimuovere</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>&nbsp;</label>
                    <button class="btn btn-secondary" onclick="resetFilters()">Pulisci Filtri</button>
                </div>
                <div style="display: flex; gap: 10px; align-items: flex-end; margin-left: auto;">
                    <div class="filter-group" style="margin-bottom: 0;">
                        <button id="btn-ricalcola-spese" class="btn btn-secondary" onclick="window.ricalcolaSpeseTuttiFrutteti(event)" title="Ricalcola le spese di tutti i frutteti basandosi sui lavori completati">üîÑ Ricalcola Spese</button>
                    </div>
                </div>
            </div>

            <div class="table-container">
                <div id="loading" class="loading">Caricamento frutteti...</div>
                <div id="empty-state" class="empty-state" style="display: none;">
                    <h3>Nessun frutteto trovato</h3>
                    <p>Crea il tuo primo frutteto per iniziare</p>
                </div>
                <table id="frutteti-table" style="display: none;">
                    <thead>
                        <tr>
                            <th>Specie</th>
                            <th>Variet√†</th>
                            <th>Terreno</th>
                            <th>Superficie (ha)</th>
                            <th>Annata Impianto</th>
                            <th>Produzione Anno (kg)</th>
                            <th>Resa Media (kg/ha)</th>
                            <th>Costo Totale Anno (‚Ç¨)</th>
                            <th>Stato</th>
                            <th>Dettaglio Spese</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="frutteti-table-body">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal frutteto -->
    <div id="frutteto-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="frutteto-modal-title">Nuovo Frutteto</h2>
                <button class="close" onclick="closeFruttetoModal()">&times;</button>
            </div>
            <form id="frutteto-form">
                <input type="hidden" id="frutteto-id">
                
                <div class="form-group">
                    <label for="terrenoId">Terreno *</label>
                    <select id="terrenoId" name="terrenoId" required>
                        <option value="">Seleziona terreno</option>
                    </select>
                    <div class="error-message" id="terrenoId-error"></div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="specie">Specie *</label>
                        <select id="specie" name="specie" required>
                            <option value="">Seleziona specie</option>
                        </select>
                        <div class="error-message" id="specie-error"></div>
                    </div>
                    <div class="form-group">
                        <label for="varieta">Variet√† *</label>
                        <div style="display: flex; gap: 5px;">
                            <select id="varieta" name="varieta" required style="flex: 1;">
                                <option value="">Seleziona variet√†</option>
                            </select>
                            <button type="button" class="btn-add-item" onclick="openAddVarietaModal()" title="Aggiungi nuova variet√†" style="background: #28a745; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 16px;">+</button>
                        </div>
                        <div class="error-message" id="varieta-error"></div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="annataImpianto">Annata Impianto *</label>
                        <input type="number" id="annataImpianto" name="annataImpianto" required min="1900" max="2099">
                        <div class="error-message" id="annataImpianto-error"></div>
                    </div>
                    <div class="form-group">
                        <label for="formaAllevamento">Forma Allevamento *</label>
                        <div style="display: flex; gap: 5px;">
                            <select id="formaAllevamento" name="formaAllevamento" required style="flex: 1;">
                                <option value="">Seleziona forma</option>
                            </select>
                            <button type="button" class="btn-add-item" onclick="openAddFormaAllevamentoModal()" title="Aggiungi nuova forma di allevamento" style="background: #28a745; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 16px;">+</button>
                        </div>
                        <div class="error-message" id="formaAllevamento-error"></div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="distanzaFile">Distanza File (m) *</label>
                        <input type="number" id="distanzaFile" name="distanzaFile" required min="0" step="0.1" placeholder="es. 4.0">
                        <div class="error-message" id="distanzaFile-error"></div>
                    </div>
                    <div class="form-group">
                        <label for="distanzaUnita">Distanza Piante (m) *</label>
                        <input type="number" id="distanzaUnita" name="distanzaUnita" required min="0" step="0.1" placeholder="es. 1.5">
                        <div class="error-message" id="distanzaUnita-error"></div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="densita">Densit√† Piante/ha * <span style="font-size: 12px; color: #666; font-weight: normal;">(calcolata automaticamente)</span></label>
                        <input type="number" id="densita" name="densita" required min="0" step="0.01" placeholder="Calcolata da distanza file e piante" readonly style="background: #f8f9fa; cursor: not-allowed;">
                        <div class="error-message" id="densita-error"></div>
                        <small style="color: #666; font-size: 12px;">Formula: 10.000 / (distanza file √ó distanza piante)</small>
                    </div>
                    <div class="form-group">
                        <label for="superficieEttari">Superficie (ettari) *</label>
                        <input type="number" id="superficieEttari" name="superficieEttari" required min="0" step="0.01" placeholder="es. 2.5">
                        <div class="error-message" id="superficieEttari-error"></div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="tipoImpianto">Tipo Impianto <span style="font-size: 12px; color: #666; font-weight: normal;">(precompilato automaticamente)</span></label>
                        <select id="tipoImpianto" name="tipoImpianto">
                            <option value="">Seleziona</option>
                            <option value="tradizionale">Tradizionale (&lt; 1000 piante/ha)</option>
                            <option value="intensivo">Intensivo (1000-3000 piante/ha)</option>
                            <option value="superintensivo">Superintensivo (&gt; 3000 piante/ha)</option>
                        </select>
                        <small style="color: #666; font-size: 12px;">Basato sulla densit√† calcolata. Puoi modificarlo manualmente se necessario.</small>
                    </div>
                    <div class="form-group">
                        <label for="orientamentoFilari">Orientamento Filari</label>
                        <select id="orientamentoFilari" name="orientamentoFilari">
                            <option value="">Seleziona</option>
                            <option value="N-S">Nord-Sud</option>
                            <option value="E-O">Est-Ovest</option>
                            <option value="NE-SO">Nord-Est / Sud-Ovest</option>
                            <option value="NO-SE">Nord-Ovest / Sud-Est</option>
                            <option value="N">Nord</option>
                            <option value="S">Sud</option>
                            <option value="E">Est</option>
                            <option value="O">Ovest</option>
                            <option value="NE">Nord-Est</option>
                            <option value="NO">Nord-Ovest</option>
                            <option value="SE">Sud-Est</option>
                            <option value="SO">Sud-Ovest</option>
                            <option value="variabile">Variabile</option>
                            <option value="adattato">Adattato al terreno</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="statoImpianto">Stato Impianto *</label>
                        <select id="statoImpianto" name="statoImpianto" required>
                            <option value="attivo">Attivo</option>
                            <option value="in_riposo">In riposo</option>
                            <option value="da_rimuovere">Da rimuovere</option>
                        </select>
                        <div class="error-message" id="statoImpianto-error"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="note">Note</label>
                    <textarea id="note" name="note" rows="3" placeholder="Note aggiuntive"></textarea>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" id="cancel-frutteto-btn">Annulla</button>
                    <button type="submit" class="btn btn-success">Salva</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal aggiungi variet√† personalizzata -->
    <div id="add-varieta-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Aggiungi Variet√†</h2>
                <button class="close" onclick="closeAddModal('add-varieta-modal')">&times;</button>
            </div>
            <form id="add-varieta-form" onsubmit="handleAddVarieta(event)">
                <div class="form-group">
                    <label for="new-varieta">Nome Variet√† *</label>
                    <input type="text" id="new-varieta" name="new-varieta" placeholder="Es. Golden Delicious" required>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeAddModal('add-varieta-modal')">Annulla</button>
                    <button type="submit" class="btn btn-success">Aggiungi</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal aggiungi forma di allevamento personalizzata -->
    <div id="add-forma-allevamento-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Aggiungi Nuova Forma di Allevamento</h2>
                <button class="close" onclick="closeAddModal('add-forma-allevamento-modal')">&times;</button>
            </div>
            <form id="add-forma-allevamento-form" onsubmit="addNewFormaAllevamento(event)">
                <div class="form-group">
                    <label for="new-forma-allevamento">Nome Forma di Allevamento *</label>
                    <input type="text" id="new-forma-allevamento" required placeholder="es. Parete">
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeAddModal('add-forma-allevamento-modal')">Annulla</button>
                    <button type="submit" class="btn btn-success">Aggiungi</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Dettaglio Spese -->
    <div id="dettaglio-spese-modal" class="modal">
        <div class="modal-content" style="max-width: 1200px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 id="dettaglio-spese-title">üìä Dettaglio Spese</h2>
                <button class="close" onclick="closeDettaglioSpeseModal()">&times;</button>
            </div>
            <div id="dettaglio-spese-content" style="padding: 20px;">
                <div style="margin-bottom: 20px;">
                    <label for="dettaglio-spese-anno" style="margin-right: 10px;">Anno:</label>
                    <select id="dettaglio-spese-anno" style="padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                    </select>
                    <button class="btn btn-primary" onclick="loadDettaglioSpese()" style="margin-left: 10px;">Aggiorna</button>
                </div>
                <div id="dettaglio-spese-loading" style="text-align: center; padding: 40px;">
                    <div class="loading">Caricamento dettagli...</div>
                </div>
                <div id="dettaglio-spese-body" style="display: none;">
                    <!-- Contenuto verr√† popolato dinamicamente -->
                </div>
            </div>
        </div>
    </div>

    <script>window.GFV_CONFIG_BASE = '../../../core';</script>
    <script src="../../../core/js/config-loader.js"></script>
    <script>window.GFVConfigLoader.loadConfigAndMaps().catch(function(e){ console.error('Config load error', e); });</script>
    <script type="module">
        const waitForConfig = () => window.GFVConfigLoader.waitForConfig();

        function getBasePath() {
            if (window.location.protocol === 'file:') {
                return '';
            }
            const pathname = window.location.pathname;
            const coreIndex = pathname.indexOf('/core/');
            const modulesIndex = pathname.indexOf('/modules/');
            if (coreIndex !== -1) {
                return pathname.substring(0, coreIndex);
            }
            if (modulesIndex !== -1) {
                return pathname.substring(0, modulesIndex);
            }
            return '/';
        }

        function resolvePath(relativePath) {
            if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
                return relativePath;
            }
            const basePath = getBasePath();
            if (relativePath.startsWith('/')) {
                const pathWithoutSlash = relativePath.substring(1);
                return basePath === '/' ? '/' + pathWithoutSlash : basePath + '/' + pathWithoutSlash;
            }
            const currentUrl = new URL(window.location.href);
            const docPath = currentUrl.pathname;
            const lastSlash = docPath.lastIndexOf('/');
            const docDir = lastSlash !== -1 ? docPath.substring(0, lastSlash + 1) : '/';
            const resolvedUrl = new URL(relativePath, currentUrl.origin + docDir);
            let resolvedPath = resolvedUrl.pathname;
            if (basePath && basePath !== '/' && !resolvedPath.startsWith(basePath)) {
                const pathWithoutSlash = resolvedPath.startsWith('/') ? resolvedPath.substring(1) : resolvedPath;
                const normalizedBasePath = basePath.endsWith('/') ? basePath : basePath + '/';
                return normalizedBasePath + pathWithoutSlash;
            }
            return resolvedPath;
        }

        // Import servizi modulo frutteto
        import { getAllFrutteti, createFrutteto, updateFrutteto, deleteFrutteto } from '../services/frutteti-service.js';

        // Import dinamici servizi core
        const terreniServiceModule = await import(resolvePath('../../../core/services/terreni-service.js'));
        const firebaseServiceModule = await import(resolvePath('../../../core/services/firebase-service.js'));
        const tenantServiceModule = await import(resolvePath('../../../core/services/tenant-service.js'));
        const authServiceModule = await import(resolvePath('../../../core/services/auth-service.js'));
        const coltureServiceModule = await import(resolvePath('../../../core/services/colture-service.js'));
        const categorieServiceModule = await import(resolvePath('../../../core/services/categorie-service.js'));
        const varietaFruttetoServiceModule = await import(resolvePath('../../../core/services/varieta-frutteto-service.js'));
        
        // Import configurazione forme di allevamento frutteto
        const specieFruttifereConfigModule = await import('../config/specie-fruttifere.js');
        const { FORME_ALLEVAMENTO_FRUTTETO } = specieFruttifereConfigModule;

        const { getAllTerreni } = terreniServiceModule;
        const { populateVarietaDropdown, addVarietaPersonalizzata } = varietaFruttetoServiceModule;
        const { initializeFirebase, getAuthInstance, getDb, onAuthStateChanged, getDoc, doc } = firebaseServiceModule;
        const { getCurrentTenantId, getCurrentTenant, initializeTenantService } = tenantServiceModule;
        const { initializeAuthService } = authServiceModule;
        const { getAllColture } = coltureServiceModule;
        const { getAllCategorie } = categorieServiceModule;

        let terreni = [];
        let allFrutteti = [];
        let frutteti = [];
        let currentEditingId = null;

        // Carica valori personalizzati da localStorage
        function loadCustomValues() {
            return {
                varieta: JSON.parse(localStorage.getItem('frutteto_varieta_custom') || '[]'),
                formaAllevamento: JSON.parse(localStorage.getItem('frutteto_forma_allevamento_custom') || '[]')
            };
        }

        // Salva valori personalizzati in localStorage
        function saveCustomValue(type, value) {
            const key = `frutteto_${type}_custom`;
            const current = JSON.parse(localStorage.getItem(key) || '[]');
            if (!current.includes(value)) {
                current.push(value);
                localStorage.setItem(key, JSON.stringify(current));
            }
        }

        // Popola dropdown
        function populateDropdown(selectId, predefiniti, customKey) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            const custom = loadCustomValues();
            const customValues = custom[customKey] || [];
            const allValues = [...predefiniti, ...customValues].sort();
            
            // Mantieni solo la prima opzione (placeholder)
            const firstOption = select.querySelector('option');
            select.innerHTML = '';
            if (firstOption) {
                select.appendChild(firstOption);
            }
            
            allValues.forEach(value => {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = value;
                select.appendChild(option);
            });
        }

        async function init() {
            try {
                const firebaseConfig = await waitForConfig();
                initializeFirebase(firebaseConfig);
                const auth = getAuthInstance();
                const db = getDb();

                initializeAuthService();
                initializeTenantService();

                onAuthStateChanged(auth, async (user) => {
                    if (!user) {
                        window.location.href = resolvePath('../../../core/auth/login-standalone.html');
                        return;
                    }

                    try {
                        const userDoc = await getDoc(doc(db, 'users', user.uid));
                        if (!userDoc.exists()) {
                            window.location.href = resolvePath('../../../core/auth/login-standalone.html');
                            return;
                        }

                        const tenantId = getCurrentTenantId();
                        if (tenantId) {
                            const tenant = await getCurrentTenant();
                            if (!tenant || !tenant.modules || !tenant.modules.includes('frutteto')) {
                                alert('Il modulo Frutteto non √® attivo. Attivalo dalla pagina Abbonamento.');
                                window.location.href = resolvePath('../../../core/admin/abbonamento-standalone.html');
                                return;
                            }
                        }

                        await loadTerreni();
                        await populateSpecieSelects();
                        setupEventListeners();
                        
                        // Popola dropdown forma allevamento
                        populateDropdown('formaAllevamento', FORME_ALLEVAMENTO_FRUTTETO, 'formaAllevamento');
                        
                        await loadFrutteti();
                        
                        // Ricalcolo automatico delle spese in background (non blocca l'interfaccia)
                        ricalcolaSpeseAutomatico();

                        // Gestione parametri URL: apri modal se terrenoId presente
                        const urlParams = new URLSearchParams(window.location.search);
                        const terrenoIdParam = urlParams.get('terrenoId');
                        const fruttetoIdParam = urlParams.get('fruttetoId');

                        if (fruttetoIdParam) {
                            // Apri modal modifica frutteto esistente
                            const frutteto = allFrutteti.find(f => f.id === fruttetoIdParam);
                            if (frutteto) {
                                editFrutteto(fruttetoIdParam);
                            }
                        } else if (terrenoIdParam) {
                            // Verifica se esiste gi√† un frutteto per questo terreno
                            const fruttetoEsistente = allFrutteti.find(f => f.terrenoId === terrenoIdParam);
                            if (fruttetoEsistente) {
                                // Apri modal modifica frutteto esistente
                                editFrutteto(fruttetoEsistente.id);
                            } else {
                                // Apri modal creazione nuovo frutteto con terreno pre-selezionato
                                document.getElementById('frutteto-modal').classList.add('active');
                                document.getElementById('frutteto-form').reset();
                                currentEditingId = null;
                                document.getElementById('statoImpianto').value = 'attivo';
                                
                                // Pre-seleziona terreno
                                const terrenoSelect = document.getElementById('terrenoId');
                                const terreno = terreni.find(t => t.id === terrenoIdParam);
                                
                                if (terrenoSelect) {
                                    terrenoSelect.value = terrenoIdParam;
                                    // Trigger evento change per precompilare superficie
                                    terrenoSelect.dispatchEvent(new Event('change'));
                                    
                                    // Precompila specie se il terreno ha una coltura frutteto
                                    if (terreno && terreno.coltura) {
                                        await precompilaSpecieDaTerreno(terreno.coltura);
                                        // Le variet√† vengono popolate automaticamente da precompilaSpecieDaTerreno
                                    }
                                }
                            }
                        }
                    } catch (error) {
                        console.error('[FRUTTETI] Errore in onAuthStateChanged:', error);
                        alert('Errore nel caricamento dei dati: ' + error.message);
                    }
                });
            } catch (error) {
                console.error('[FRUTTETI] Errore inizializzazione:', error);
                alert('Errore nel caricamento dei dati: ' + error.message);
            }
        }

        function getTerrenoLabel(t) {
            if (!t) return '-';
            const nome = (t.nome || '').trim();
            const podere = (t.podere || '').trim();
            if (nome && podere) return `${nome} ‚Äì ${podere}`;
            if (nome) return nome;
            if (podere) return podere;
            return 'Terreno senza nome';
        }

        async function loadTerreni() {
            try {
                terreni = await getAllTerreni();
                const terrenoSelect = document.getElementById('terrenoId');
                const filterTerrenoSelect = document.getElementById('filter-terreno');

                const optionsHtml = ['<option value="">Seleziona terreno</option>']
                    .concat(terreni.map(t => `<option value="${t.id}">${getTerrenoLabel(t)}</option>`))
                    .join('');
                terrenoSelect.innerHTML = optionsHtml;

                const filterOptionsHtml = ['<option value="">Tutti i terreni</option>']
                    .concat(terreni.map(t => `<option value="${t.id}">${getTerrenoLabel(t)}</option>`))
                    .join('');
                filterTerrenoSelect.innerHTML = filterOptionsHtml;
            } catch (error) {
                console.error('[FRUTTETI] Errore caricamento terreni:', error);
            }
        }

        // Variabile globale per memorizzare le specie frutteto caricate
        let specieFruttetoDisponibili = [];

        async function populateSpecieSelects() {
            try {
                const specieSelect = document.getElementById('specie');
                const filterSpecieSelect = document.getElementById('filter-specie');

                // Ottieni categoria 'frutteto'
                const categorie = await getAllCategorie({ 
                    applicabileA: 'colture',
                    orderBy: 'ordine'
                });
                const categoriaFrutteto = categorie.find(c => c.codice === 'frutteto');
                
                if (!categoriaFrutteto) {
                    console.warn('[FRUTTETI] Categoria frutteto non trovata');
                    return;
                }

                // Carica tutte le colture e filtra per categoria frutteto (evita indice composito categoriaId+nome)
                const tutteColture = await getAllColture({ 
                    orderBy: 'nome',
                    orderDirection: 'asc'
                });
                const coltureFrutteto = tutteColture.filter(c => c.categoriaId === categoriaFrutteto.id);

                // Estrai i nomi delle specie e salva in variabile globale
                specieFruttetoDisponibili = coltureFrutteto.map(c => c.nome).filter(Boolean).sort();

                specieSelect.innerHTML = '<option value="">Seleziona specie</option>' +
                    specieFruttetoDisponibili.map(s => `<option value="${s}">${s}</option>`).join('');

                filterSpecieSelect.innerHTML = '<option value="">Tutte le specie</option>' +
                    specieFruttetoDisponibili.map(s => `<option value="${s}">${s}</option>`).join('');
            } catch (error) {
                console.error('[FRUTTETI] Errore caricamento specie:', error);
                // Fallback: usa lista vuota
                const specieSelect = document.getElementById('specie');
                const filterSpecieSelect = document.getElementById('filter-specie');
                if (specieSelect) specieSelect.innerHTML = '<option value="">Seleziona specie</option>';
                if (filterSpecieSelect) filterSpecieSelect.innerHTML = '<option value="">Tutte le specie</option>';
            }
        }

        /**
         * Precompila la specie dal terreno se la coltura corrisponde a una specie frutteto
         * @param {string} colturaTerreno - Nome della coltura del terreno
         */
        async function precompilaSpecieDaTerreno(colturaTerreno) {
            if (!colturaTerreno) return;
            
            try {
                // Se le specie non sono ancora caricate, caricale
                if (specieFruttetoDisponibili.length === 0) {
                    await populateSpecieSelects();
                }
                
                // Verifica se la coltura del terreno corrisponde a una specie frutteto
                const specieCorrispondente = specieFruttetoDisponibili.find(s => 
                    s.toLowerCase() === colturaTerreno.toLowerCase()
                );
                
                if (specieCorrispondente) {
                    const specieSelect = document.getElementById('specie');
                    if (specieSelect) {
                        specieSelect.value = specieCorrispondente;
                        // Popola anche le variet√† per questa specie
                        await populateVarietaDropdown('varieta', specieCorrispondente);
                    }
                }
            } catch (error) {
                console.warn('[FRUTTETI] Errore precompilazione specie da terreno:', error);
            }
        }

        async function loadFrutteti() {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('frutteti-table').style.display = 'none';
                document.getElementById('empty-state').style.display = 'none';

                allFrutteti = await getAllFrutteti();
                
                // Popola filtro variet√† con tutte le variet√† disponibili
                const varietaSet = new Set(allFrutteti.map(f => f.varieta).filter(Boolean));
                const filterVarieta = document.getElementById('filter-varieta');
                if (filterVarieta) {
                    filterVarieta.innerHTML = '<option value="">Tutte le variet√†</option>';
                    varietaSet.forEach(varieta => {
                        filterVarieta.innerHTML += `<option value="${varieta}">${varieta}</option>`;
                    });
                }
                
                // Applica filtri (o mostra tutti se nessun filtro attivo)
                applyFilters();
            } catch (error) {
                console.error('[FRUTTETI] Errore caricamento frutteti:', error);
                alert('Errore nel caricamento frutteti: ' + error.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }


        window.applyFilters = function() {
            const filterTerreno = document.getElementById('filter-terreno')?.value || '';
            const filterSpecie = document.getElementById('filter-specie')?.value || '';
            const filterVarieta = document.getElementById('filter-varieta')?.value || '';
            const filterStato = document.getElementById('filter-stato')?.value || '';
            
            // Filtra frutteti
            frutteti = allFrutteti.filter(frutteto => {
                // Filtro terreno
                if (filterTerreno && frutteto.terrenoId !== filterTerreno) {
                    return false;
                }
                
                // Filtro specie
                if (filterSpecie && frutteto.specie !== filterSpecie) {
                    return false;
                }
                
                // Filtro variet√†
                if (filterVarieta && frutteto.varieta !== filterVarieta) {
                    return false;
                }
                
                // Filtro stato
                if (filterStato && frutteto.statoImpianto !== filterStato) {
                    return false;
                }
                
                return true;
            });
            
            // Renderizza frutteti filtrati
            renderFrutteti();
        };

        window.resetFilters = function() {
            document.getElementById('filter-terreno').value = '';
            document.getElementById('filter-specie').value = '';
            document.getElementById('filter-varieta').value = '';
            document.getElementById('filter-stato').value = '';
            applyFilters();
        };

        function getStatoBadgeClass(stato) {
            const classes = {
                'attivo': 'badge-success',
                'in_riposo': 'badge-warning',
                'da_rimuovere': 'badge-danger'
            };
            return classes[stato] || 'badge-secondary';
        }

        function getStatoLabel(stato) {
            const labels = {
                'attivo': 'Attivo',
                'in_riposo': 'In riposo',
                'da_rimuovere': 'Da rimuovere'
            };
            return labels[stato] || stato;
        }

        function getTerrenoNome(terrenoId) {
            const t = terreni.find(tt => tt.id === terrenoId);
            return getTerrenoLabel(t);
        }

        function renderFrutteti() {
            const tbody = document.getElementById('frutteti-table-body');
            const emptyState = document.getElementById('empty-state');
            const loadingDiv = document.getElementById('loading');
            const table = document.getElementById('frutteti-table');

            if (!frutteti || frutteti.length === 0) {
                tbody.innerHTML = '';
                if (loadingDiv) loadingDiv.style.display = 'none';
                if (table) table.style.display = 'none';
                if (emptyState) emptyState.style.display = 'block';
                return;
            }

            if (loadingDiv) loadingDiv.style.display = 'none';
            if (emptyState) emptyState.style.display = 'none';
            if (table) table.style.display = 'table';

            tbody.innerHTML = '';
            frutteti.forEach(f => {
                const resaKgHa = f.superficieEttari && f.superficieEttari > 0 && f.produzioneTotaleAnno
                    ? (f.produzioneTotaleAnno / f.superficieEttari)
                    : null;

                const row = `
                    <tr>
                        <td><strong>${f.specie || '-'}</strong></td>
                        <td><strong>${f.varieta || '-'}</strong></td>
                        <td>${getTerrenoNome(f.terrenoId)}</td>
                        <td>${f.superficieEttari ? f.superficieEttari.toFixed(2) : '-'}</td>
                        <td>${f.annataImpianto || '-'}</td>
                        <td>${f.produzioneTotaleAnno ? f.produzioneTotaleAnno.toFixed(2) : '0.00'}</td>
                        <td>${resaKgHa ? resaKgHa.toFixed(2) : '-'}</td>
                        <td>${f.costoTotaleAnno ? f.costoTotaleAnno.toFixed(2) : '0.00'}</td>
                        <td>
                            <span class="badge ${getStatoBadgeClass(f.statoImpianto)}">
                                ${getStatoLabel(f.statoImpianto)}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="showDettaglioSpese('${f.id}', '${f.specie || 'Frutteto'} - ${f.varieta || ''}')" title="Vedi dettaglio spese">
                                üìä Dettaglio
                            </button>
                        </td>
                        <td class="actions-cell">
                            <button class="btn btn-sm btn-primary" onclick="editFrutteto('${f.id}')">‚úèÔ∏è Modifica</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteFruttetoConfirm('${f.id}')">üóëÔ∏è Elimina</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function setupEventListeners() {
            // Gestione form frutteto
            document.getElementById('frutteto-form').addEventListener('submit', onFruttetoSubmit);
            
            // Chiudi modali cliccando fuori
            ['add-varieta-modal', 'add-forma-allevamento-modal'].forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.addEventListener('click', (e) => {
                        if (e.target.id === modalId || e.target.classList.contains('modal')) {
                            closeAddModal(modalId);
                        }
                    });
                }
            });
            
            // Chiudi modal cliccando fuori
            document.getElementById('frutteto-modal').addEventListener('click', (e) => {
                if (e.target.id === 'frutteto-modal') {
                    closeFruttetoModal();
                }
            });
            
            // Chiudi modali aggiungi valori cliccando fuori
            ['add-varieta-modal', 'add-forma-allevamento-modal'].forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.addEventListener('click', (e) => {
                        if (e.target.id === modalId || e.target.classList.contains('modal')) {
                            closeAddModal(modalId);
                        }
                    });
                }
            });

            // Calcolo automatico densit√† in base alle distanze
            const distanzaFileInput = document.getElementById('distanzaFile');
            const distanzaUnitaInput = document.getElementById('distanzaUnita');
            distanzaFileInput.addEventListener('input', calcolaDensita);
            distanzaUnitaInput.addEventListener('input', calcolaDensita);
            
            // Listener per tipo impianto: se modificato manualmente, non sovrascrivere pi√π
            const tipoImpiantoSelect = document.getElementById('tipoImpianto');
            if (tipoImpiantoSelect) {
                tipoImpiantoSelect.addEventListener('change', function() {
                    if (this.value) {
                        // Se l'utente seleziona manualmente, segna come non auto-filled
                        this.dataset.autoFilled = 'false';
                    }
                });
            }

            document.getElementById('terrenoId').addEventListener('change', async () => {
                const terrenoId = document.getElementById('terrenoId').value;
                const superficieInput = document.getElementById('superficieEttari');
                if (terrenoId) {
                    const terreno = terreni.find(t => t.id === terrenoId);
                    if (terreno) {
                        // Precompila superficie se disponibile
                        if (terreno.superficie && terreno.superficie > 0) {
                            superficieInput.value = parseFloat(terreno.superficie).toFixed(2);
                        }
                        // Precompila specie se la coltura del terreno corrisponde a una specie frutteto
                        if (terreno.coltura) {
                            await precompilaSpecieDaTerreno(terreno.coltura);
                        }
                    }
                } else {
                    // Se nessun terreno selezionato, svuota superficie
                    superficieInput.value = '';
                }
            });

            // Listener per cambio specie: popola dropdown variet√†
            const specieSelect = document.getElementById('specie');
            if (specieSelect) {
                specieSelect.addEventListener('change', async function() {
                    const specie = this.value;
                    console.log(`[FRUTTETI] Cambio specie selezionata: "${specie}"`);
                    if (specie) {
                        // Mostra loading nel dropdown variet√†
                        const varietaSelect = document.getElementById('varieta');
                        if (varietaSelect) {
                            varietaSelect.innerHTML = '<option value="">Caricamento variet√†...</option>';
                            varietaSelect.disabled = true;
                        }
                        
                        try {
                            await populateVarietaDropdown('varieta', specie);
                        } catch (error) {
                            console.error('[FRUTTETI] Errore popolamento variet√†:', error);
                            if (varietaSelect) {
                                varietaSelect.innerHTML = '<option value="">Errore caricamento</option>';
                            }
                        } finally {
                            if (varietaSelect) {
                                varietaSelect.disabled = false;
                            }
                        }
                    } else {
                        // Svuota dropdown variet√† se nessuna specie selezionata
                        const varietaSelect = document.getElementById('varieta');
                        if (varietaSelect) {
                            varietaSelect.innerHTML = '<option value="">Seleziona variet√†</option>';
                        }
                    }
                });
            }
        }

        // Funzioni per aprire modali
        window.openAddVarietaModal = function() {
            const specie = document.getElementById('specie').value;
            if (!specie) {
                alert('Seleziona prima una specie');
                return;
            }
            document.getElementById('add-varieta-modal').classList.add('active');
            setTimeout(() => document.getElementById('new-varieta').focus(), 100);
        };

        window.openAddFormaAllevamentoModal = function() {
            document.getElementById('add-forma-allevamento-modal').classList.add('active');
            setTimeout(() => document.getElementById('new-forma-allevamento').focus(), 100);
        };

        // Funzioni per chiudere modali
        window.closeAddModal = function(modalId) {
            document.getElementById(modalId).classList.remove('active');
            const form = document.querySelector(`#${modalId} form`);
            if (form) form.reset();
        };

        window.handleAddVarieta = async function(event) {
            event.preventDefault();
            const specie = document.getElementById('specie').value;
            const nuovaVarieta = document.getElementById('new-varieta').value.trim();
            
            if (!specie) {
                alert('Seleziona prima una specie');
                return;
            }
            
            if (!nuovaVarieta) {
                alert('Inserisci il nome della variet√†');
                return;
            }
            
            try {
                const success = await addVarietaPersonalizzata(specie, nuovaVarieta);
                if (success) {
                    // Ricarica dropdown variet√†
                    await populateVarietaDropdown('varieta', specie);
                    // Seleziona la variet√† appena aggiunta
                    document.getElementById('varieta').value = nuovaVarieta;
                    closeAddModal('add-varieta-modal');
                } else {
                    alert('Errore nell\'aggiunta della variet√†');
                }
            } catch (error) {
                console.error('[FRUTTETI] Errore aggiunta variet√†:', error);
                alert('Errore nell\'aggiunta della variet√†: ' + error.message);
            }
        };

        window.addNewFormaAllevamento = function(e) {
            e.preventDefault();
            const value = document.getElementById('new-forma-allevamento').value.trim();
            if (value) {
                saveCustomValue('formaAllevamento', value);
                populateDropdown('formaAllevamento', FORME_ALLEVAMENTO_FRUTTETO, 'formaAllevamento');
                document.getElementById('formaAllevamento').value = value;
                closeAddModal('add-forma-allevamento-modal');
            }
        };

        // Calcolo automatico densit√† piante e tipo impianto
        function calcolaDensita() {
            const distanzaFile = parseFloat(document.getElementById('distanzaFile').value);
            const distanzaPiante = parseFloat(document.getElementById('distanzaUnita').value);
            const densitaInput = document.getElementById('densita');
            const tipoImpiantoSelect = document.getElementById('tipoImpianto');
            
            if (distanzaFile > 0 && distanzaPiante > 0) {
                // Formula: 10.000 m¬≤ (1 ettaro) / (distanza file √ó distanza piante)
                const densita = 10000 / (distanzaFile * distanzaPiante);
                const densitaArrotondata = Math.round(densita * 100) / 100; // Arrotonda a 2 decimali
                densitaInput.value = densitaArrotondata;
                
                // Precompila tipo impianto in base alla densit√†
                if (tipoImpiantoSelect) {
                    // Salva il valore precedente per verificare se era stato selezionato manualmente
                    const valorePrecedente = tipoImpiantoSelect.value;
                    
                    // Determina tipo impianto in base alla densit√† (soglie per frutteto)
                    // Basate su classificazione pomacee/drupacee: tradizionale < 1000, intensivo 1000-3000, superintensivo > 3000
                    let nuovoTipoImpianto = '';
                    if (densitaArrotondata < 1000) {
                        nuovoTipoImpianto = 'tradizionale';
                    } else if (densitaArrotondata >= 1000 && densitaArrotondata <= 3000) {
                        nuovoTipoImpianto = 'intensivo';
                    } else if (densitaArrotondata > 3000) {
                        nuovoTipoImpianto = 'superintensivo';
                    }
                    
                    // Aggiorna solo se:
                    // 1. Non c'era un valore precedente (prima volta)
                    // 2. Il valore precedente era stato precompilato automaticamente (autoFilled)
                    // 3. Il nuovo valore √® diverso e coerente con la densit√†
                    if (!valorePrecedente || tipoImpiantoSelect.dataset.autoFilled === 'true') {
                        tipoImpiantoSelect.value = nuovoTipoImpianto;
                        tipoImpiantoSelect.dataset.autoFilled = 'true';
                    } else if (nuovoTipoImpianto && nuovoTipoImpianto !== valorePrecedente) {
                        // Se il valore manuale non corrisponde alla densit√†, aggiorna comunque
                        // ma segna come auto-filled per permettere override futuro
                        tipoImpiantoSelect.value = nuovoTipoImpianto;
                        tipoImpiantoSelect.dataset.autoFilled = 'true';
                    }
                }
            } else {
                densitaInput.value = '';
                // Se le distanze non sono valide, resetta tipo impianto solo se era stato precompilato automaticamente
                if (tipoImpiantoSelect && tipoImpiantoSelect.dataset.autoFilled === 'true') {
                    tipoImpiantoSelect.value = '';
                    tipoImpiantoSelect.dataset.autoFilled = 'false';
                }
            }
        }

        window.openCreateModal = function() {
            currentEditingId = null;
            document.getElementById('frutteto-modal-title').textContent = 'Nuovo Frutteto';
            document.getElementById('frutteto-form').reset();
            document.getElementById('statoImpianto').value = 'attivo';
            
            // Ripopola dropdown quando si apre il modal
            populateDropdown('formaAllevamento', FORME_ALLEVAMENTO_FRUTTETO, 'formaAllevamento');
            
            document.getElementById('frutteto-modal').classList.add('active');
            
            // Se c'√® gi√† una specie selezionata, popola le variet√†
            const specieSelect = document.getElementById('specie');
            if (specieSelect && specieSelect.value) {
                // Piccolo delay per assicurarsi che il DOM sia pronto
                setTimeout(async () => {
                    await populateVarietaDropdown('varieta', specieSelect.value);
                }, 100);
            }
        };

        window.editFrutteto = async function(fruttetoId) {
            const frutteto = allFrutteti.find(f => f.id === fruttetoId);
            if (!frutteto) return;

            currentEditingId = fruttetoId;
            document.getElementById('frutteto-modal-title').textContent = 'Modifica Frutteto';

            document.getElementById('terrenoId').value = frutteto.terrenoId || '';
            
            // Imposta specie e popola variet√†
            const specieSelect = document.getElementById('specie');
            if (specieSelect && frutteto.specie) {
                specieSelect.value = frutteto.specie;
                // Popola dropdown variet√† per questa specie
                await populateVarietaDropdown('varieta', frutteto.specie);
            }
            
            // Imposta variet√† dopo aver popolato il dropdown
            setTimeout(() => {
                document.getElementById('varieta').value = frutteto.varieta || '';
            }, 100);
            
            document.getElementById('annataImpianto').value = frutteto.annataImpianto || '';
            
            // Popola dropdown forma allevamento prima di impostare il valore
            populateDropdown('formaAllevamento', FORME_ALLEVAMENTO_FRUTTETO, 'formaAllevamento');
            setTimeout(() => {
                document.getElementById('formaAllevamento').value = frutteto.formaAllevamento || '';
            }, 50);
            
            document.getElementById('distanzaFile').value = frutteto.distanzaFile != null ? frutteto.distanzaFile : '';
            document.getElementById('distanzaUnita').value = frutteto.distanzaUnita != null ? frutteto.distanzaUnita : '';
            
            // Calcola densit√† se ci sono le distanze
            if (frutteto.distanzaFile && frutteto.distanzaUnita) {
                calcolaDensita();
            } else {
                document.getElementById('densita').value = frutteto.densita != null ? frutteto.densita : '';
            }
            
            document.getElementById('superficieEttari').value = frutteto.superficieEttari != null ? frutteto.superficieEttari : '';
            document.getElementById('tipoImpianto').value = frutteto.tipoImpianto || '';
            // Se tipoImpianto non √® stato impostato manualmente, segna come auto-filled
            if (!frutteto.tipoImpianto) {
                document.getElementById('tipoImpianto').dataset.autoFilled = 'true';
            }
            document.getElementById('orientamentoFilari').value = frutteto.orientamentoFilari || '';
            document.getElementById('statoImpianto').value = frutteto.statoImpianto || 'attivo';
            document.getElementById('note').value = frutteto.note || '';

            document.getElementById('frutteto-modal').classList.add('active');
        };

        window.closeFruttetoModal = function() {
            document.getElementById('frutteto-modal').classList.remove('active');
            currentEditingId = null;
        };

        async function onFruttetoSubmit(event) {
            event.preventDefault();

            const form = event.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            data.densita = data.densita ? parseFloat(data.densita) : null;
            data.distanzaFile = data.distanzaFile ? parseFloat(data.distanzaFile) : null;
            data.distanzaUnita = data.distanzaUnita ? parseFloat(data.distanzaUnita) : null;
            data.superficieEttari = data.superficieEttari ? parseFloat(data.superficieEttari) : null;
            data.annataImpianto = data.annataImpianto ? parseInt(data.annataImpianto, 10) : null;
            data.tipoImpianto = data.tipoImpianto || null;
            data.orientamentoFilari = data.orientamentoFilari || null;

            try {
                if (currentEditingId) {
                    await updateFrutteto(currentEditingId, data);
                    alert('Frutteto aggiornato con successo');
                } else {
                    await createFrutteto(data);
                    alert('Frutteto creato con successo');
                }
                closeFruttetoModal();
                await loadFrutteti();
            } catch (error) {
                console.error('[FRUTTETI] Errore salvataggio frutteto:', error);
                alert('Errore nel salvataggio del frutteto: ' + error.message);
                // Non chiudere il modal in caso di errore, cos√¨ l'utente pu√≤ correggere
            }
        }

        function deleteFruttetoConfirm(fruttetoId) {
            if (confirm('Sei sicuro di voler eliminare questo frutteto?')) {
                deleteFruttetoAction(fruttetoId);
            }
        }

        async function deleteFruttetoAction(fruttetoId) {
            try {
                await deleteFrutteto(fruttetoId);
                await loadFrutteti();
                alert('Frutteto eliminato con successo');
            } catch (error) {
                console.error('[FRUTTETI] Errore eliminazione frutteto:', error);
                alert('Errore nell\'eliminazione del frutteto: ' + error.message);
            }
        }

        function goToRaccolta(fruttetoId) {
            if (!fruttetoId) return;
            const basePath = getBasePath();
            // Percorso relativo da modules/frutteto/views/
            const relative = 'raccolta-frutta-standalone.html?fruttetoId=' + encodeURIComponent(fruttetoId);
            const url = resolvePath(relative);
            window.location.href = url;
        }

        // Import servizio ricalcolo spese
        let ricalcolaSpeseFruttetoAnno = null;
        let lavoriFruttetoServiceLoaded = false;
        
        // Carica servizio in modo asincrono per gestire errori
        import('../services/lavori-frutteto-service.js').then(module => {
            ricalcolaSpeseFruttetoAnno = module.ricalcolaSpeseFruttetoAnno;
            lavoriFruttetoServiceLoaded = true;
            console.log('[FRUTTETI] Servizio lavori-frutteto-service caricato correttamente');
        }).catch(error => {
            console.warn('[FRUTTETI] Servizio lavori-frutteto-service non disponibile:', error);
        });

        // Funzione per ricalcolo automatico in background (senza alert, senza bloccare UI)
        async function ricalcolaSpeseAutomatico() {
            try {
                // Verifica che il servizio sia caricato
                if (!lavoriFruttetoServiceLoaded || !ricalcolaSpeseFruttetoAnno) {
                    return;
                }

                const annoCorrente = new Date().getFullYear();
                const fruttetiList = await getAllFrutteti();
                
                if (fruttetiList.length === 0) {
                    return;
                }

                // Ricalcola in background senza bloccare l'interfaccia
                // Non mostriamo alert o messaggi per non disturbare l'utente
                let completati = 0;
                let errori = 0;

                for (const frutteto of fruttetiList) {
                    try {
                        await ricalcolaSpeseFruttetoAnno(frutteto.id, annoCorrente);
                        completati++;
                    } catch (error) {
                        console.error(`[FRUTTETI] Errore ricalcolo automatico frutteto ${frutteto.id}:`, error);
                        errori++;
                    }
                }
                
                // Ricarica la lista solo se ci sono stati aggiornamenti
                if (completati > 0) {
                    // Ricarica in modo silenzioso (senza mostrare loading)
                    await loadFrutteti();
                }
            } catch (error) {
                console.error('[FRUTTETI] Errore ricalcolo automatico spese:', error);
                // Non mostriamo alert per non disturbare l'utente
            }
        }

        // Funzione per ricalcolare le spese di tutti i frutteti (manuale, con conferma)
        window.ricalcolaSpeseTuttiFrutteti = async function(event) {
            if (!lavoriFruttetoServiceLoaded || !ricalcolaSpeseFruttetoAnno) {
                alert('Servizio ricalcolo spese non ancora disponibile. Verr√† implementato prossimamente.');
                console.warn('[FRUTTETI] Servizio non disponibile');
                return;
            }
            
            if (!confirm('Vuoi ricalcolare le spese di tutti i frutteti basandoti sui lavori completati?\n\nQuesta operazione potrebbe richiedere alcuni secondi.')) {
                return;
            }

            try {
                const annoCorrente = new Date().getFullYear();
                const fruttetiList = await getAllFrutteti();
                
                if (fruttetiList.length === 0) {
                    alert('Nessun frutteto trovato');
                    return;
                }

                // Mostra indicatore di caricamento
                const loadingMsg = `Ricalcolo in corso... (0/${fruttetiList.length})`;
                const originalBtn = event?.target || document.querySelector('button[onclick*="ricalcolaSpeseTuttiFrutteti"]');
                if (!originalBtn) {
                    console.error('[FRUTTETI] Pulsante non trovato!');
                    alert('Errore: pulsante non trovato');
                    return;
                }
                
                const originalText = originalBtn.textContent;
                originalBtn.disabled = true;
                originalBtn.textContent = loadingMsg;

                let completati = 0;
                let errori = 0;

                // Ricalcola ogni frutteto
                for (const frutteto of fruttetiList) {
                    try {
                        await ricalcolaSpeseFruttetoAnno(frutteto.id, annoCorrente);
                        completati++;
                        originalBtn.textContent = `Ricalcolo in corso... (${completati}/${fruttetiList.length})`;
                    } catch (error) {
                        console.error(`[FRUTTETI] Errore ricalcolo frutteto ${frutteto.id}:`, error);
                        errori++;
                    }
                }

                // Ripristina pulsante
                originalBtn.disabled = false;
                originalBtn.textContent = originalText;

                // Mostra risultato
                if (errori === 0) {
                    alert(`‚úÖ Ricalcolo completato con successo!\n\n${completati} frutteti aggiornati per l'anno ${annoCorrente}.`);
                } else {
                    alert(`‚ö†Ô∏è Ricalcolo completato con alcuni errori.\n\n‚úÖ ${completati} frutteti aggiornati\n‚ùå ${errori} errori`);
                }

                // Ricarica la lista per mostrare i dati aggiornati
                await loadFrutteti();
            } catch (error) {
                console.error('[FRUTTETI] Errore ricalcolo spese:', error);
                alert('Errore durante il ricalcolo: ' + error.message);
                
                // Ripristina pulsante in caso di errore
                const originalBtn = event?.target || document.querySelector('button[onclick*="ricalcolaSpeseTuttiFrutteti"]');
                if (originalBtn) {
                    originalBtn.disabled = false;
                    originalBtn.textContent = 'üîÑ Ricalcola Spese';
                }
            }
        };

        // Variabile globale per memorizzare fruttetoId corrente nel modal dettaglio
        let currentDettaglioFruttetoId = null;

        // Funzione per mostrare modal dettaglio spese
        window.showDettaglioSpese = function(fruttetoId, fruttetoNome) {
            currentDettaglioFruttetoId = fruttetoId;
            document.getElementById('dettaglio-spese-title').textContent = `üìä Dettaglio Spese - ${fruttetoNome}`;
            
            // Popola dropdown anno (ultimi 5 anni + anno corrente)
            const annoSelect = document.getElementById('dettaglio-spese-anno');
            const annoCorrente = new Date().getFullYear();
            annoSelect.innerHTML = '';
            for (let i = 0; i < 6; i++) {
                const anno = annoCorrente - i;
                const option = document.createElement('option');
                option.value = anno;
                option.textContent = anno;
                if (i === 0) option.selected = true;
                annoSelect.appendChild(option);
            }
            
            // Mostra modal e carica dettagli
            document.getElementById('dettaglio-spese-modal').classList.add('active');
            loadDettaglioSpese();
        };

        // Funzione per chiudere modal dettaglio spese
        window.closeDettaglioSpeseModal = function() {
            document.getElementById('dettaglio-spese-modal').classList.remove('active');
            currentDettaglioFruttetoId = null;
        };

        // Funzione per caricare e mostrare dettagli spese
        window.loadDettaglioSpese = async function() {
            if (!currentDettaglioFruttetoId) return;
            
            const anno = parseInt(document.getElementById('dettaglio-spese-anno').value);
            const loadingDiv = document.getElementById('dettaglio-spese-loading');
            const bodyDiv = document.getElementById('dettaglio-spese-body');
            
            loadingDiv.style.display = 'block';
            bodyDiv.style.display = 'none';
            
            try {
                // TODO: Implementare quando servizio sar√† disponibile
                // const { getDettaglioSpeseFruttetoAnno } = await import('../services/lavori-frutteto-service.js');
                // const dettaglio = await getDettaglioSpeseFruttetoAnno(currentDettaglioFruttetoId, anno);
                
                // Per ora mostra messaggio placeholder
                bodyDiv.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6c757d;">
                        <h3>Servizio in sviluppo</h3>
                        <p>Il servizio per il dettaglio spese sar√† disponibile prossimamente.</p>
                        <p style="font-size: 12px; margin-top: 20px; color: #999;">Frutteto ID: ${currentDettaglioFruttetoId}<br>Anno: ${anno}</p>
                    </div>
                `;
                
                loadingDiv.style.display = 'none';
                bodyDiv.style.display = 'block';
            } catch (error) {
                console.error('[FRUTTETI] Errore caricamento dettaglio spese:', error);
                loadingDiv.innerHTML = `<div style="color: red; padding: 20px;">Errore nel caricamento dei dettagli: ${error.message}</div>`;
            }
        };

        // Cambio anno: ricarica automaticamente i dettagli spese (senza dover cliccare "Aggiorna")
        document.getElementById('dettaglio-spese-anno').addEventListener('change', function() {
            if (currentDettaglioFruttetoId) loadDettaglioSpese();
        });

        // Avvio
        init();
    </script>
    <!-- Tony widget (assistente su tutte le pagine) -->
    <!-- Tony widget (assistente su tutte le pagine) -->
    <script>
    (function() {
      var path = (window.location.pathname || '').replace(/\\/g, '/');
      var isGH = path.indexOf('/gfv-platform/') >= 0;
      var base = isGH ? (window.location.origin + '/gfv-platform/core') : (path.indexOf('/core/admin/') >= 0 ? '../' : (path.indexOf('/modules/') >= 0 ? '../../../core/' : ''));
      var sep = (base && !base.endsWith('/')) ? '/' : '';
      var link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = (base ? base + sep : '') + 'styles/tony-widget.css';
      document.head.appendChild(link);
      var s = document.createElement('script');
      s.type = 'module';
      s.src = (base ? base + sep : '') + 'js/tony-widget-standalone.js';
      document.body.appendChild(s);
    })();
    </script>
</body>
</html>

