<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Vigneto - GFV Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #E1BEE7 0%, #6A1B9A 100%);
            color: #333;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #6A1B9A 0%, #4A148C 100%);
            color: white;
            padding: 40px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
        }

        .header h1 {
            font-size: 36px;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 18px;
            opacity: 0.9;
        }

        .filters {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }

        .filter-group select {
            padding: 8px 12px;
            border: 2px solid #E1BEE7;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            color: #333;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .filter-group select:hover {
            border-color: #6A1B9A;
        }

        .filter-group select:focus {
            outline: none;
            border-color: #6A1B9A;
        }

        .content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: linear-gradient(135deg, #F3E5F5 0%, #E1BEE7 100%);
            border: 2px solid #6A1B9A;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #6A1B9A;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
        }

        .stat-subtitle {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .action-card {
            background: white;
            border: 2px solid #6A1B9A;
            border-radius: 12px;
            padding: 25px;
            text-decoration: none;
            color: #333;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .action-card:hover {
            background: #F3E5F5;
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .action-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .action-title {
            font-size: 18px;
            font-weight: bold;
            color: #6A1B9A;
            margin-bottom: 10px;
        }

        .action-description {
            font-size: 14px;
            color: #666;
        }

        .section {
            margin-top: 40px;
        }

        .section h2 {
            color: #6A1B9A;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        thead {
            background: linear-gradient(135deg, #6A1B9A 0%, #4A148C 100%);
            color: white;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #E1BEE7;
        }

        th {
            font-weight: 600;
            font-size: 14px;
        }

        td {
            font-size: 14px;
            color: #333;
        }

        tbody tr:hover {
            background: #F3E5F5;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-link {
            background: transparent;
            color: #6A1B9A;
            text-decoration: underline;
            padding: 0;
        }

        .btn-link:hover {
            color: #4A148C;
        }

        .header-actions {
            margin-top: 20px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .badge-diario {
            display: inline-block;
            padding: 4px 10px;
            background: #F3E5F5;
            color: #6A1B9A;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .quick-actions {
                grid-template-columns: 1fr;
            }

            .filters {
                flex-direction: column;
                align-items: stretch;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üçá VIGNETO</h1>
            <p>Panoramica completa gestione vigneti</p>
            <div class="header-actions">
                <a href="../../../core/dashboard-standalone.html" class="btn btn-secondary">‚Üê Dashboard Principale</a>
            </div>
        </div>

        <div class="filters">
            <div class="filter-group">
                <label for="filtro-vigneto">Vigneto</label>
                <select id="filtro-vigneto">
                    <option value="">Tutti i vigneti</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="filtro-anno">Anno</label>
                <select id="filtro-anno">
                    <!-- Popolato dinamicamente -->
                </select>
            </div>
        </div>

        <div class="content">
            <div id="alert-container"></div>

            <h2 style="color: #6A1B9A; margin-bottom: 20px;">Panoramica</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="stat-produzione">-</div>
                    <div class="stat-label">Produzione Anno (Qli)</div>
                    <div class="stat-subtitle" id="stat-produzione-subtitle"></div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-resa">-</div>
                    <div class="stat-label">Resa Media (Qli/Ha)</div>
                    <div class="stat-subtitle" id="stat-resa-subtitle"></div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-spese-vendemmia">-</div>
                    <div class="stat-label">Spese Vendemmia (‚Ç¨)</div>
                    <div class="stat-subtitle" id="stat-spese-subtitle"></div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-spese-totali">-</div>
                    <div class="stat-label">Spese totali (‚Ç¨)</div>
                    <div class="stat-subtitle" id="stat-spese-totali-subtitle"></div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-numero-vigneti">-</div>
                    <div class="stat-label">Vigneti Totali</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-numero-vendemmie">-</div>
                    <div class="stat-label">Vendemmie Anno</div>
                </div>
                <a href="#" id="link-ultima-vendemmia" class="stat-card" style="text-decoration: none; color: inherit; cursor: pointer;" title="Clicca per vedere l'ultima vendemmia">
                    <div class="stat-value" id="stat-ultima-vendemmia" style="color: #6A1B9A;">-</div>
                    <div class="stat-label">Ultima Vendemmia</div>
                </a>
            </div>

            <h2 style="color: #6A1B9A; margin: 40px 0 20px 0;">Azioni Rapide</h2>
            <div class="quick-actions">
                <a href="vigneti-standalone.html" class="action-card">
                    <span class="action-icon">üçá</span>
                    <span class="action-title">Anagrafica Vigneti</span>
                    <span class="action-description">Gestisci anagrafica vigneti e dati tecnici</span>
                </a>
                <a href="vendemmia-standalone.html" class="action-card">
                    <span class="action-icon">üç∑</span>
                    <span class="action-title">Gestione Vendemmia</span>
                    <span class="action-description">Registra vendemmie e traccia produzione</span>
                </a>
                <a href="potatura-standalone.html" class="action-card">
                    <span class="action-icon">‚úÇÔ∏è</span>
                    <span class="action-title">Potatura</span>
                    <span class="action-description">Registra potature (invernale, verde, rinnovo, spollonatura)</span>
                </a>
                <a href="trattamenti-standalone.html" class="action-card">
                    <span class="action-icon">üß™</span>
                    <span class="action-title">Trattamenti</span>
                    <span class="action-description">Registra trattamenti fitosanitari e fertilizzanti</span>
                </a>
                <a href="vigneto-statistiche-standalone.html" class="action-card">
                    <span class="action-icon">üìä</span>
                    <span class="action-title">Statistiche e Grafici</span>
                    <span class="action-description">Visualizza statistiche dettagliate e analisi grafiche</span>
                </a>
                <a href="pianifica-impianto-standalone.html?coltura=vigneto" class="action-card">
                    <span class="action-icon">üìê</span>
                    <span class="action-title">Pianifica Nuovo Impianto</span>
                    <span class="action-description">Calcola file, ceppi, pali e materiali per nuovo impianto</span>
                </a>
                <a href="calcolo-materiali-standalone.html?coltura=vigneto" class="action-card">
                    <span class="action-icon">üî¢</span>
                    <span class="action-title">Calcolo Materiali</span>
                    <span class="action-description">Calcola materiali necessari dalle pianificazioni salvate</span>
                </a>
            </div>

            <div class="section">
                <h2>Vendemmie Recenti</h2>
                <div class="table-container">
                    <table id="table-vendemmie">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Vigneto</th>
                                <th>Quantit√† (Qli)</th>
                                <th>Resa (Qli/Ha)</th>
                                <th>Costo Totale (‚Ç¨)</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="6" class="loading">Caricamento vendemmie...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="section">
                <h2>Lavori Vigneto</h2>
                <div class="table-container">
                    <table id="table-lavori">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Vigneto</th>
                                <th>Tipo Lavoro</th>
                                <th>Stato</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="5" class="loading">Caricamento lavori...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>window.GFV_CONFIG_BASE = '../../../core';</script>
    <script src="../../../core/js/config-loader.js"></script>
    <script>window.GFVConfigLoader.loadConfigAndMaps().catch(function(e){ console.error('Config load error', e); });</script>
    <script type="module">
        const waitForConfig = () => window.GFVConfigLoader.waitForConfig();
        const firebaseConfig = await waitForConfig();
        
        const { initializeFirebase, getAuthInstance, getDb, onAuthStateChanged, getDoc, doc } = await import('../../../core/services/firebase-service.js');
        const { getCurrentTenantId, getCurrentTenant, initializeTenantService } = await import('../../../core/services/tenant-service.js');
        
        // Inizializza Firebase PRIMA di tutto
        initializeFirebase(firebaseConfig);
        const auth = getAuthInstance();
        const db = getDb();
        
        // Inizializza servizi tenant DOPO Firebase
        initializeTenantService();

        let currentUser = null;
        let currentTenantId = null;
        let currentVignetoId = null;
        let currentAnno = null;

        // Verifica autenticazione
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                try {
                    const userDoc = await getDoc(doc(db, 'users', user.uid));
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        currentTenantId = getCurrentTenantId();

                        // Verifica permessi (solo Manager o Amministratore)
                        const ruoli = userData.ruoli || [];
                        const isManager = ruoli.some(r => {
                            const roleLower = r.toLowerCase();
                            return roleLower.includes('manager') || roleLower.includes('amministratore');
                        });

                        if (!isManager) {
                            showAlert('Non hai i permessi per accedere a questa pagina', 'error');
                            setTimeout(() => {
                                window.location.href = '../../../core/dashboard-standalone.html';
                            }, 2000);
                            return;
                        }

                        // Verifica accesso modulo vigneto
                        // Attendi che il tenant service sia inizializzato (con retry)
                        let tenantId = getCurrentTenantId();
                        
                        // Se non disponibile, prova a usare tenantId dall'utente (fallback)
                        if (!tenantId && userData.tenantId) {
                            tenantId = userData.tenantId;
                        }
                        
                        // Retry per ottenere tenantId dal servizio (se non disponibile)
                        if (!tenantId) {
                            for (let i = 0; i < 10; i++) {
                                await new Promise(resolve => setTimeout(resolve, 100));
                                tenantId = getCurrentTenantId();
                                if (tenantId) break;
                            }
                        }
                        
                        currentTenantId = tenantId;
                        
                        if (tenantId) {
                            const tenant = await getCurrentTenant();
                            console.log('[VIGNETO-DASHBOARD] Tenant ID:', tenantId);
                            console.log('[VIGNETO-DASHBOARD] Tenant:', tenant);
                            console.log('[VIGNETO-DASHBOARD] Tenant modules:', tenant?.modules);
                            
                            if (!tenant) {
                                console.error('[VIGNETO-DASHBOARD] Tenant non trovato per ID:', tenantId);
                                showAlert('Errore: tenant non trovato', 'error');
                                setTimeout(() => {
                                    window.location.href = '../../../core/dashboard-standalone.html';
                                }, 2000);
                                return;
                            }
                            
                            // Verifica modulo vigneto (case-insensitive)
                            const modules = Array.isArray(tenant?.modules) ? tenant.modules : [];
                            
                            // Inizializza context Tony con i moduli attivi usando helper
                            if (window.Tony && window.Tony.initContextWithModules) {
                                window.Tony.initContextWithModules(modules);
                            } else {
                                // Fallback se helper non disponibile (retry manuale)
                                var initTonyContext = function(retries) {
                                    retries = retries || 0;
                                    if (window.Tony && typeof window.Tony.setContext === 'function') {
                                        window.Tony.setContext('dashboard', {
                                            info_azienda: { moduli_attivi: modules },
                                            moduli_attivi: modules
                                        });
                                        console.log('[Vigneto Dashboard] Context Tony inizializzato con moduli:', modules);
                                    } else if (retries < 10) {
                                        setTimeout(function() { initTonyContext(retries + 1); }, 500);
                                    }
                                };
                                initTonyContext();
                            }
                            const hasVignetoModule = modules.some(m => m && m.toLowerCase() === 'vigneto');
                            
                            if (!hasVignetoModule) {
                                console.warn('[VIGNETO-DASHBOARD] Modulo vigneto non trovato. Modules disponibili:', modules);
                                showAlert('Il modulo Vigneto non √® attivo. Attivalo dalla pagina Abbonamento.', 'error');
                                setTimeout(() => {
                                    window.location.href = '../../../core/admin/abbonamento-standalone.html';
                                }, 3000);
                                return;
                            }
                            
                            console.log('[VIGNETO-DASHBOARD] Modulo vigneto verificato con successo');
                        } else {
                            console.error('[VIGNETO-DASHBOARD] Nessun tenant ID disponibile');
                            showAlert('Nessun tenant disponibile', 'error');
                            setTimeout(() => {
                                window.location.href = '../../../core/dashboard-standalone.html';
                            }, 2000);
                            return;
                        }

                        // Inizializza filtri
                        await initFilters();
                        
                        // Carica statistiche iniziali
                        await loadStats();
                    } else {
                        window.location.href = '../../../core/auth/login-standalone.html';
                    }
                } catch (error) {
                    console.error('Errore:', error);
                    showAlert('Errore caricamento dati: ' + error.message, 'error');
                }
            } else {
                window.location.href = '../../../core/auth/login-standalone.html';
            }
        });

        // Inizializza filtri
        async function initFilters() {
            try {
                // Popola dropdown vigneti
                const { getAllVigneti } = await import('../services/vigneti-service.js');
                const vigneti = await getAllVigneti();
                
                const vignetoSelect = document.getElementById('filtro-vigneto');
                vignetoSelect.innerHTML = '<option value="">Tutti i vigneti</option>';
                
                vigneti.forEach(vigneto => {
                    const option = document.createElement('option');
                    option.value = vigneto.id;
                    option.textContent = vigneto.varieta || 'Vigneto';
                    vignetoSelect.appendChild(option);
                });

                // Popola dropdown anni (ultimi 5 anni + anno corrente)
                const annoSelect = document.getElementById('filtro-anno');
                const annoCorrente = new Date().getFullYear();
                annoSelect.innerHTML = '';
                
                for (let i = 0; i < 5; i++) {
                    const anno = annoCorrente - i;
                    const option = document.createElement('option');
                    option.value = anno;
                    option.textContent = anno;
                    if (i === 0) {
                        option.selected = true;
                        currentAnno = anno;
                    }
                    annoSelect.appendChild(option);
                }

                // Event listeners per filtri
                vignetoSelect.addEventListener('change', async (e) => {
                    currentVignetoId = e.target.value || null;
                    await loadStats();
                });

                annoSelect.addEventListener('change', async (e) => {
                    currentAnno = parseInt(e.target.value);
                    await loadStats();
                });
            } catch (error) {
                console.error('Errore inizializzazione filtri:', error);
                showAlert('Errore caricamento filtri: ' + error.message, 'error');
            }
        }

        // Carica statistiche
        async function loadStats() {
            try {
                if (!currentTenantId) {
                    resetStats();
                    return;
                }

                const { getStatisticheVigneto, getVendemmieRecenti, getLavoriVigneto } = await import('../services/vigneto-statistiche-service.js');
                
                // Carica statistiche aggregate
                const statistiche = await getStatisticheVigneto(currentVignetoId, currentAnno);
                
                // Aggiorna card statistiche
                document.getElementById('stat-produzione').textContent = statistiche.produzioneTotaleQli.toFixed(2);
                document.getElementById('stat-resa').textContent = statistiche.resaMediaQliHa.toFixed(2);
                document.getElementById('stat-spese-vendemmia').textContent = statistiche.speseVendemmiaAnno.toFixed(2);
                const costoTotale = statistiche.costoTotaleAnno ?? 0;
                document.getElementById('stat-spese-totali').textContent = costoTotale > 0 ? costoTotale.toFixed(2) : '-';
                document.getElementById('stat-numero-vigneti').textContent = statistiche.numeroVigneti;
                document.getElementById('stat-numero-vendemmie').textContent = statistiche.numeroVendemmie;
                
                // Ultima vendemmia
                if (statistiche.dataUltimaVendemmia) {
                    const dataUltima = statistiche.dataUltimaVendemmia instanceof Date 
                        ? statistiche.dataUltimaVendemmia 
                        : new Date(statistiche.dataUltimaVendemmia);
                    const dataFormattata = dataUltima.toLocaleDateString('it-IT', { 
                        day: '2-digit', 
                        month: '2-digit', 
                        year: 'numeric' 
                    });
                    document.getElementById('stat-ultima-vendemmia').textContent = dataFormattata;
                    
                    // Link alla vendemmia (se disponibile)
                    const linkUltima = document.getElementById('link-ultima-vendemmia');
                    // TODO: Aggiungere link quando avremo l'ID vendemmia
                } else {
                    document.getElementById('stat-ultima-vendemmia').textContent = 'Nessuna';
                    document.getElementById('link-ultima-vendemmia').style.pointerEvents = 'none';
                    document.getElementById('link-ultima-vendemmia').style.opacity = '0.6';
                }

                // Sottotitoli statistiche
                if (statistiche.produzionePerMese && Object.keys(statistiche.produzionePerMese).length > 0) {
                    const mesi = Object.keys(statistiche.produzionePerMese).sort();
                    const ultimoMese = mesi[mesi.length - 1];
                    const produzioneUltimoMese = statistiche.produzionePerMese[ultimoMese];
                    document.getElementById('stat-produzione-subtitle').textContent = `Ultimo mese: ${produzioneUltimoMese.toFixed(2)} Qli`;
                } else {
                    document.getElementById('stat-produzione-subtitle').textContent = '';
                }

                if (statistiche.resaPerVarieta && Object.keys(statistiche.resaPerVarieta).length > 0) {
                    const varieta = Object.keys(statistiche.resaPerVarieta);
                    if (varieta.length === 1) {
                        document.getElementById('stat-resa-subtitle').textContent = varieta[0];
                    } else {
                        document.getElementById('stat-resa-subtitle').textContent = `${varieta.length} variet√†`;
                    }
                } else {
                    document.getElementById('stat-resa-subtitle').textContent = '';
                }

                if (statistiche.spesePerMese && Object.keys(statistiche.spesePerMese).length > 0) {
                    const mesi = Object.keys(statistiche.spesePerMese).sort();
                    const ultimoMese = mesi[mesi.length - 1];
                    const speseUltimoMese = statistiche.spesePerMese[ultimoMese];
                    document.getElementById('stat-spese-subtitle').textContent = `Ultimo mese: ${speseUltimoMese.toFixed(2)} ‚Ç¨`;
                } else {
                    document.getElementById('stat-spese-subtitle').textContent = '';
                }

                // Carica vendemmie recenti
                await loadVendemmieRecenti();
                
                // Carica lavori vigneto
                await loadLavoriVigneto();
            } catch (error) {
                console.error('Errore caricamento statistiche:', error);
                showAlert('Errore caricamento statistiche: ' + error.message, 'error');
                resetStats();
            }
        }

        // Carica vendemmie recenti
        async function loadVendemmieRecenti() {
            try {
                const { getVendemmieRecenti } = await import('../services/vigneto-statistiche-service.js');
                const vendemmie = await getVendemmieRecenti(currentVignetoId, currentAnno, 10);
                
                const tbody = document.querySelector('#table-vendemmie tbody');
                tbody.innerHTML = '';
                
                if (vendemmie.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="empty-state">
                                <div class="empty-state-icon">üçá</div>
                                <div>Nessuna vendemmia trovata per i filtri selezionati</div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                vendemmie.forEach(vendemmia => {
                    const dataVendemmia = vendemmia.data instanceof Date 
                        ? vendemmia.data 
                        : (vendemmia.data?.toDate ? vendemmia.data.toDate() : new Date(vendemmia.data));
                    const dataFormattata = dataVendemmia.toLocaleDateString('it-IT', { 
                        day: '2-digit', 
                        month: '2-digit', 
                        year: 'numeric' 
                    });
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${dataFormattata}</td>
                        <td>${vendemmia.vignetoNome || vendemmia.varieta || 'Vigneto'}</td>
                        <td>${(vendemmia.quantitaQli || 0).toFixed(2)}</td>
                        <td>${(vendemmia.resaQliHa || 0).toFixed(2)}</td>
                        <td>${(vendemmia.costoTotale || 0).toFixed(2)}</td>
                        <td>
                            <a href="vendemmia-standalone.html?vignetoId=${vendemmia.vignetoId}&vendemmiaId=${vendemmia.id}" class="btn-link">Dettaglio</a>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Errore caricamento vendemmie recenti:', error);
                const tbody = document.querySelector('#table-vendemmie tbody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state">
                            <div>Errore caricamento vendemmie</div>
                        </td>
                    </tr>
                `;
            }
        }

        // Carica lavori vigneto
        async function loadLavoriVigneto() {
            try {
                const { getLavoriVigneto } = await import('../services/vigneto-statistiche-service.js');
                
                // Carica lavori completati
                const lavoriCompletati = await getLavoriVigneto(currentVignetoId, currentAnno, 'completato', 10);
                
                const tbody = document.querySelector('#table-lavori tbody');
                tbody.innerHTML = '';
                
                if (lavoriCompletati.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" class="empty-state">
                                <div class="empty-state-icon">üìã</div>
                                <div>Nessun lavoro completato trovato per i filtri selezionati</div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                lavoriCompletati.forEach(lavoro => {
                    const dataVal = lavoro.dataInizio || lavoro.data;
                    const dataInizio = dataVal instanceof Date 
                        ? dataVal 
                        : new Date(dataVal || 0);
                    const dataFormattata = !isNaN(dataInizio.getTime()) 
                        ? dataInizio.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric' })
                        : (lavoro.data || '-');
                    const statoFormattato = lavoro.stato === 'completato' ? '‚úÖ Completato' : lavoro.stato;
                    const isDiario = lavoro.source === 'diario';
                    const dettaglioCell = isDiario 
                        ? '<span class="badge-diario" title="Attivit√† registrata dal Diario">Da diario</span>' 
                        : `<a href="../../../core/admin/gestione-lavori-standalone.html?lavoroId=${lavoro.id}" class="btn-link">Dettaglio</a>`;
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${dataFormattata}</td>
                        <td>${lavoro.vignetoNome || 'Vigneto'}</td>
                        <td>${lavoro.tipoLavoro || 'N/A'}</td>
                        <td>${statoFormattato}</td>
                        <td>${dettaglioCell}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Errore caricamento lavori vigneto:', error);
                const tbody = document.querySelector('#table-lavori tbody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="empty-state">
                            <div>Errore caricamento lavori</div>
                        </td>
                    </tr>
                `;
            }
        }

        // Reset statistiche
        function resetStats() {
            document.getElementById('stat-produzione').textContent = '0';
            document.getElementById('stat-resa').textContent = '0';
            document.getElementById('stat-spese-vendemmia').textContent = '0';
            document.getElementById('stat-spese-totali').textContent = '-';
            document.getElementById('stat-numero-vigneti').textContent = '0';
            document.getElementById('stat-numero-vendemmie').textContent = '0';
            document.getElementById('stat-ultima-vendemmia').textContent = '-';
        }

        // Utility functions
        function showAlert(message, type = 'info') {
            const container = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.innerHTML = '';
            container.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }
    </script>
    <!-- Tony widget (assistente su tutte le pagine) -->
    <!-- Tony widget (assistente su tutte le pagine) -->
    <script>
    (function() {
      var path = (window.location.pathname || '').replace(/\\/g, '/');
      var isGH = path.indexOf('/gfv-platform/') >= 0;
      var base = isGH ? (window.location.origin + '/gfv-platform/core') : (path.indexOf('/core/admin/') >= 0 ? '../' : (path.indexOf('/modules/') >= 0 ? '../../../core/' : ''));
      var sep = (base && !base.endsWith('/')) ? '/' : '';
      var link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = (base ? base + sep : '') + 'styles/tony-widget.css';
      document.head.appendChild(link);
      var s = document.createElement('script');
      s.type = 'module';
      s.src = (base ? base + sep : '') + 'js/tony-widget-standalone.js';
      document.body.appendChild(s);
    })();
    </script>
</body>
</html>
