<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calcolo Materiali Impianto - GFV Platform</title>
    <link rel="manifest" href="../../../manifest.json">
    <meta name="theme-color" content="#6A1B9A">
    <!-- jsPDF per esportazione PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #E1BEE7 0%, #6A1B9A 100%);
            color: #333;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #6A1B9A 0%, #4A148C 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .btn-primary:hover {
            background: rgba(255,255,255,0.3);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .section-title {
            color: #6A1B9A;
            font-size: 20px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #E1BEE7;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        thead {
            background: linear-gradient(135deg, #6A1B9A 0%, #4A148C 100%);
            color: white;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #E1BEE7;
        }

        th {
            font-weight: 600;
            font-size: 14px;
        }

        td {
            font-size: 14px;
            color: #333;
        }

        tbody tr:hover {
            background: #F3E5F5;
        }

        tbody tr.total-row {
            background: #E1BEE7;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #666;
            font-weight: 500;
            font-size: 14px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #E1BEE7;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #6A1B9A;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-bozza {
            background: #ffc107;
            color: #333;
        }

        .badge-confermato {
            background: #28a745;
            color: white;
        }

        .badge-impiantato {
            background: #17a2b8;
            color: white;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .config-section {
            background: #F3E5F5;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .materiali-section {
            margin-top: 30px;
        }

        .materiali-category {
            margin-bottom: 30px;
        }

        .materiali-category h3 {
            color: #6A1B9A;
            font-size: 18px;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid #E1BEE7;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>üìê Calcolo Materiali Impianto</h1>
                <p>Calcola i materiali necessari per realizzare l'impianto pianificato</p>
            </div>
            <div class="header-actions">
                <a href="vigneto-dashboard-standalone.html" class="btn btn-primary">‚Üê Dashboard</a>
            </div>
        </div>

        <!-- Sezione Elenco Pianificazioni -->
        <div class="content">
            <h2 class="section-title">Pianificazioni Salvate</h2>
            <div id="alert-container"></div>
            
            <div class="table-container">
                <table id="table-pianificazioni">
                    <thead>
                        <tr>
                            <th>Terreno</th>
                            <th>Data Creazione</th>
                            <th>Stato</th>
                            <th>File</th>
                            <th>Unit√† Totali</th>
                            <th>Superficie (Ha)</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="7" class="loading">Caricamento pianificazioni...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Sezione Configurazione Calcolo -->
        <div class="content" id="config-section" style="display: none;">
            <h2 class="section-title">Configurazione Calcolo Materiali</h2>
            
            <div class="alert alert-info" id="info-pianificazione-selezionata" style="display: none;">
                <strong>Pianificazione selezionata:</strong> <span id="pianificazione-nome"></span>
            </div>

            <div class="config-section">
                <div class="form-group">
                    <label for="tipoImpianto">Tipo Impianto *</label>
                    <select id="tipoImpianto" required>
                        <option value="">Seleziona tipo impianto</option>
                        <optgroup label="Sistemi a Spalliera">
                            <option value="guyot">Guyot</option>
                            <option value="cordone_speronato">Cordone Speronato</option>
                            <option value="cordone_libero">Cordone Libero</option>
                            <option value="cordone_doppio">Cordone Doppio</option>
                            <option value="spalliera">Spalliera</option>
                            <option value="spalliera_doppia">Spalliera Doppia</option>
                            <option value="sylvoz">Sylvoz</option>
                            <option value="casarsa">Casarsa</option>
                            <option value="doppio_capovolto">Doppio Capovolto</option>
                            <option value="raggiera">Raggiera</option>
                            <option value="scott_henry">Scott Henry</option>
                        </optgroup>
                        <optgroup label="Sistemi Sopraelevati">
                            <option value="pergola">Pergola</option>
                            <option value="tendone">Tendone</option>
                            <option value="gdc">GDC (Geneva Double Curtain)</option>
                            <option value="lyre">Lyre</option>
                        </optgroup>
                        <optgroup label="Sistemi Tradizionali">
                            <option value="alberello">Alberello</option>
                            <option value="vite_maritata">Vite Maritata</option>
                        </optgroup>
                    </select>
                    <small style="color: #666; margin-top: 5px; display: block;" id="tipo-impianto-desc"></small>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="distanzaPali">Distanza tra Pali (metri) *</label>
                        <input type="number" id="distanzaPali" min="3" max="10" step="0.5" value="5.0" required>
                    </div>

                    <div class="form-group">
                        <label for="altezzaPali">Altezza Pali (metri) *</label>
                        <input type="number" id="altezzaPali" min="1.5" max="4" step="0.1" value="2.5" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="numeroFiliPortata">Numero Fili di Portata (override tipo impianto)</label>
                        <input type="number" id="numeroFiliPortata" min="0" max="6" step="1" placeholder="Auto (da tipo impianto)">
                        <small style="color: #666; margin-top: 5px; display: block;">Fili di sostegno principale. Lascia vuoto per usare il valore predefinito</small>
                    </div>

                    <div class="form-group">
                        <label for="numeroFiliVegetazione">Numero Fili di Vegetazione (override tipo impianto)</label>
                        <input type="number" id="numeroFiliVegetazione" min="0" max="6" step="1" placeholder="Auto (da tipo impianto)">
                        <small style="color: #666; margin-top: 5px; display: block;">Fili per contenimento chioma. Lascia vuoto per usare il valore predefinito</small>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="diametroFiloPortata">Diametro Fili di Portata (mm)</label>
                        <input type="number" id="diametroFiloPortata" min="3" max="6" step="0.1" placeholder="Auto (da tipo impianto)">
                        <small style="color: #666; margin-top: 5px; display: block;">Tipicamente 4-5mm. Lascia vuoto per usare il valore predefinito</small>
                    </div>

                    <div class="form-group">
                        <label for="diametroFiloVegetazione">Diametro Fili di Vegetazione (mm)</label>
                        <input type="number" id="diametroFiloVegetazione" min="1.5" max="4" step="0.1" placeholder="Auto (da tipo impianto)">
                        <small style="color: #666; margin-top: 5px; display: block;">Tipicamente 2-2.5mm. Lascia vuoto per usare il valore predefinito</small>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="usaTutori">Usa Braccetti</label>
                        <select id="usaTutori">
                            <option value="">Auto (da tipo impianto)</option>
                            <option value="true">S√¨</option>
                            <option value="false">No</option>
                        </select>
                        <small style="color: #666; margin-top: 5px; display: block;">
                            Braccetti strutturali per pali (2 per palo) - necessari per pergole, tendoni, GDC, Lyre
                        </small>
                    </div>

                    <div class="form-group">
                        <label for="usaAncore">Usa Ancore</label>
                        <select id="usaAncore">
                            <option value="">Auto (da tipo impianto)</option>
                            <option value="true">S√¨</option>
                            <option value="false">No</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="fissaggioTutori">Fissaggio Tutori al Filo Portata</label>
                        <select id="fissaggioTutori">
                            <option value="legacci">Legacci (legare tutori al filo)</option>
                            <option value="gancetti">Gancetti (fissaggio meccanico)</option>
                        </select>
                        <small style="color: #666; margin-top: 5px; display: block;">
                            Scegli come fissare i tutori al filo di portata. I legacci sono gli stessi usati per legare le piante ai fili.
                        </small>
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <button class="btn btn-success" onclick="calcolaMateriali()">üî¢ Calcola Materiali</button>
                    <button class="btn btn-secondary" onclick="resetConfigurazione()">üîÑ Reset</button>
                </div>
            </div>
        </div>

        <!-- Sezione Risultati Materiali -->
        <div class="content materiali-section" id="risultati-section" style="display: none;">
            <h2 class="section-title">Materiali Necessari</h2>
            
            <div id="materiali-container">
                <!-- Popolato dinamicamente -->
            </div>
        </div>
    </div>

    <!-- Load Firebase config from external file -->
    <script>
        const configScript = document.createElement('script');
        configScript.src = '../../../core/config/firebase-config.js';
        configScript.onerror = function() {
            const fallbackScript = document.createElement('script');
            fallbackScript.src = 'https://raw.githubusercontent.com/VitaraDragon/gfv-platform/main/core/config/firebase-config.js';
            document.head.appendChild(fallbackScript);
        };
        document.head.appendChild(configScript);
    </script>

    <script type="module">
        // Calcola base path per GitHub Pages
        function getBasePath() {
            if (window.location.protocol === 'file:') {
                return '';
            }
            const pathname = window.location.pathname;
            const coreIndex = pathname.indexOf('/core/');
            const modulesIndex = pathname.indexOf('/modules/');
            if (coreIndex !== -1) {
                return pathname.substring(0, coreIndex);
            }
            if (modulesIndex !== -1) {
                return pathname.substring(0, modulesIndex);
            }
            return '/';
        }
        
        // Funzione helper per risolvere percorsi relativi in assoluti con base path
        function resolvePath(relativePath) {
            if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
                return relativePath;
            }
            const basePath = getBasePath();
            if (relativePath.startsWith('/')) {
                const pathWithoutSlash = relativePath.substring(1);
                return basePath === '/' ? '/' + pathWithoutSlash : basePath + '/' + pathWithoutSlash;
            }
            // Per percorsi relativi, risolvi rispetto all'URL corrente
            const currentUrl = new URL(window.location.href);
            const docPath = currentUrl.pathname;
            const lastSlash = docPath.lastIndexOf('/');
            const docDir = lastSlash !== -1 ? docPath.substring(0, lastSlash + 1) : '/';
            const resolvedUrl = new URL(relativePath, currentUrl.origin + docDir);
            let resolvedPath = resolvedUrl.pathname;
            if (basePath && basePath !== '/' && !resolvedPath.startsWith(basePath)) {
                const pathWithoutSlash = resolvedPath.startsWith('/') ? resolvedPath.substring(1) : resolvedPath;
                const normalizedBasePath = basePath.endsWith('/') ? basePath : basePath + '/';
                return normalizedBasePath + pathWithoutSlash;
            }
            return resolvedPath;
        }
        
        import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getDoc, doc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAllPianificazioni, deletePianificazione, confermaPianificazione } from '../services/pianificazione-impianto-service.js';
        import { calcolaMateriali, formattaMaterialiPerTabella, TIPI_IMPIANTO } from '../services/calcolo-materiali-service.js';
        import { getChiaveTecnica, getNomeVisualizzato } from '../config/forme-allevamento.js';
        
        // Import dinamici dei servizi core con risoluzione percorsi per GitHub Pages
        const tenantServiceModule = await import(resolvePath('../../../core/services/tenant-service.js'));
        const terreniServiceModule = await import(resolvePath('../../../core/services/terreni-service.js'));
        
        const { getCurrentTenantId, getCurrentTenant } = tenantServiceModule;
        const { getAllTerreni } = terreniServiceModule;

        // Funzione per attendere il caricamento della configurazione Firebase
        function waitForConfig() {
            return new Promise((resolve, reject) => {
                if (typeof window.firebaseConfig !== 'undefined') {
                    resolve(window.firebaseConfig);
                    return;
                }
                
                let attempts = 0;
                const maxAttempts = 50;
                
                const checkInterval = setInterval(() => {
                    attempts++;
                    if (typeof window.firebaseConfig !== 'undefined') {
                        clearInterval(checkInterval);
                        resolve(window.firebaseConfig);
                    } else if (attempts >= maxAttempts) {
                        clearInterval(checkInterval);
                        reject(new Error('Firebase config not loaded after 5 seconds'));
                    }
                }, 100);
            });
        }

        let db, auth;
        let pianificazioni = [];
        let terreni = [];
        let pianificazioneSelezionata = null;
        let materialiCalcolati = null; // Memorizza i materiali calcolati per l'export PDF

        async function init() {
            try {
                // Carica configurazione Firebase
                const firebaseConfig = await waitForConfig();
                
                // Importa servizi Firebase e Tenant con risoluzione percorsi
                const { initializeFirebase, getAuthInstance, getDb } = await import(resolvePath('../../../core/services/firebase-service.js'));
                const { initializeTenantService } = await import(resolvePath('../../../core/services/tenant-service.js'));
                
                // Inizializza Firebase PRIMA di tutto
                await initializeFirebase(firebaseConfig);
                auth = getAuthInstance();
                db = getDb();
                
                // Inizializza servizi tenant DOPO Firebase
                initializeTenantService();

                onAuthStateChanged(auth, async (user) => {
                    if (!user) {
                        window.location.href = '../../../core/auth/login-standalone.html';
                        return;
                    }

                    try {
                        const userDoc = await getDoc(doc(db, 'users', user.uid));
                        if (!userDoc.exists()) {
                            window.location.href = '../../../core/auth/login-standalone.html';
                            return;
                        }

                        const userData = userDoc.data();

                        // Verifica modulo vigneto attivo
                        // Attendi che il tenant service sia inizializzato (con retry)
                        let tenantId = getCurrentTenantId();
                        
                        // Se non disponibile, prova a usare tenantId dall'utente (fallback)
                        if (!tenantId && userData.tenantId) {
                            tenantId = userData.tenantId;
                        }
                        
                        // Retry per ottenere tenantId dal servizio (se non disponibile)
                        if (!tenantId) {
                            for (let i = 0; i < 10; i++) {
                                await new Promise(resolve => setTimeout(resolve, 100));
                                tenantId = getCurrentTenantId();
                                if (tenantId) break;
                            }
                        }
                        
                        if (tenantId) {
                            const tenant = await getCurrentTenant();
                            
                            if (!tenant) {
                                showAlert('Errore: tenant non trovato', 'error');
                                setTimeout(() => {
                                    window.location.href = '../../../core/dashboard-standalone.html';
                                }, 2000);
                                return;
                            }
                            
                            // Verifica modulo vigneto (case-insensitive)
                            const modules = tenant.modules || [];
                            const hasVignetoModule = modules.some(m => m && m.toLowerCase() === 'vigneto');
                            
                            if (!hasVignetoModule) {
                                showAlert('Il modulo Vigneto non √® attivo. Attivalo dalla pagina Abbonamento.', 'error');
                                setTimeout(() => {
                                    window.location.href = '../../../core/admin/abbonamento-standalone.html';
                                }, 3000);
                                return;
                            }
                        } else {
                            showAlert('Nessun tenant disponibile', 'error');
                            setTimeout(() => {
                                window.location.href = '../../../core/dashboard-standalone.html';
                            }, 2000);
                            return;
                        }

                        // Carica dati
                        await loadTerreni();
                        await loadPianificazioni();

                        // Event listeners
                        setupEventListeners();
                    } catch (error) {
                        console.error('Errore inizializzazione:', error);
                        showAlert('Errore durante l\'inizializzazione: ' + error.message, 'error');
                    }
                });
            } catch (error) {
                console.error('Errore caricamento configurazione:', error);
                showAlert('Errore caricamento configurazione Firebase', 'error');
            }
        }

        async function loadTerreni() {
            try {
                terreni = await getAllTerreni();
            } catch (error) {
                console.error('Errore caricamento terreni:', error);
                terreni = [];
            }
        }

        async function loadPianificazioni() {
            console.log('[CALCOLO-MATERIALI] Inizio caricamento pianificazioni...');
            try {
                console.log('[CALCOLO-MATERIALI] Chiamata getAllPianificazioni con opzioni:', {
                    tipoColtura: 'vigneto',
                    orderBy: 'createdAt',
                    orderDirection: 'desc'
                });
                
                pianificazioni = await getAllPianificazioni({
                    tipoColtura: 'vigneto',
                    orderBy: 'createdAt',
                    orderDirection: 'desc'
                });
                
                console.log('[CALCOLO-MATERIALI] Pianificazioni caricate:', pianificazioni);
                console.log('[CALCOLO-MATERIALI] Numero pianificazioni:', pianificazioni.length);
                
                if (pianificazioni.length > 0) {
                    console.log('[CALCOLO-MATERIALI] Prima pianificazione esempio:', {
                        id: pianificazioni[0].id,
                        terrenoId: pianificazioni[0].terrenoId,
                        tipoColtura: pianificazioni[0].tipoColtura,
                        numeroFile: pianificazioni[0].numeroFile,
                        numeroUnitaTotale: pianificazioni[0].numeroUnitaTotale,
                        stato: pianificazioni[0].stato
                    });
                } else {
                    console.warn('[CALCOLO-MATERIALI] Nessuna pianificazione trovata con filtro tipoColtura=vigneto');
                    console.log('[CALCOLO-MATERIALI] Provo a caricare tutte le pianificazioni senza filtro...');
                    
                    // Prova senza filtro tipoColtura per vedere se ci sono pianificazioni
                    const tuttePianificazioni = await getAllPianificazioni({
                        orderBy: 'createdAt',
                        orderDirection: 'desc'
                    });
                    console.log('[CALCOLO-MATERIALI] Pianificazioni senza filtro:', tuttePianificazioni.length);
                    if (tuttePianificazioni.length > 0) {
                        console.log('[CALCOLO-MATERIALI] Esempio pianificazione senza filtro:', {
                            id: tuttePianificazioni[0].id,
                            tipoColtura: tuttePianificazioni[0].tipoColtura,
                            terrenoId: tuttePianificazioni[0].terrenoId
                        });
                    }
                }
                
                renderPianificazioni();
                console.log('[CALCOLO-MATERIALI] Render pianificazioni completato');
            } catch (error) {
                console.error('[CALCOLO-MATERIALI] Errore caricamento pianificazioni:', error);
                console.error('[CALCOLO-MATERIALI] Stack trace:', error.stack);
                showAlert('Errore caricamento pianificazioni: ' + error.message, 'error');
                pianificazioni = [];
                renderPianificazioni();
            }
        }

        function renderPianificazioni() {
            const tbody = document.querySelector('#table-pianificazioni tbody');
            
            if (!tbody) {
                console.error('Errore: tbody non trovato!');
                return;
            }
            
            if (pianificazioni.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state">
                            <div class="empty-state-icon">üìã</div>
                            <p>Nessuna pianificazione salvata</p>
                            <p style="margin-top: 10px; font-size: 12px;">
                                <a href="pianifica-impianto-standalone.html" style="color: #6A1B9A;">Crea una nuova pianificazione</a>
                            </p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = pianificazioni.map((p, index) => {
                const terreno = terreni.find(t => t.id === p.terrenoId);
                const terrenoNome = terreno ? terreno.nome : 'Terreno non trovato';
                
                const dataCreazione = p.createdAt ? (p.createdAt.toDate ? p.createdAt.toDate().toLocaleDateString('it-IT') : new Date(p.createdAt).toLocaleDateString('it-IT')) : '-';
                const statoBadge = getStatoBadge(p.stato);
                
                // Verifica se la pianificazione ha dati completi
                const hasCompleteData = p.numeroFile > 0 && p.numeroUnitaTotale > 0 && p.superficieNettaImpianto > 0;
                const warningIcon = hasCompleteData ? '' : ' ‚ö†Ô∏è';
                const buttonDisabled = hasCompleteData ? '' : ' disabled';
                const buttonTitle = hasCompleteData ? '' : ' title="Pianificazione incompleta - completa prima di calcolare"';
                
                return `
                    <tr>
                        <td>${terrenoNome}${warningIcon}</td>
                        <td>${dataCreazione}</td>
                        <td>${statoBadge}</td>
                        <td>${p.numeroFile || 0}</td>
                        <td>${(p.numeroUnitaTotale || 0).toLocaleString('it-IT')}</td>
                        <td>${(p.superficieNettaImpianto || 0).toFixed(2)}</td>
                        <td>
                            <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                <button class="btn btn-success" onclick="selezionaPianificazione('${p.id}')" 
                                        style="padding: 5px 10px; font-size: 12px;"${buttonDisabled}${buttonTitle}>
                                    ${hasCompleteData ? 'Calcola Materiali' : 'Dati Incompleti'}
                                </button>
                                <button class="btn btn-primary" onclick="modificaPianificazione('${p.id}')" 
                                        style="padding: 5px 10px; font-size: 12px;" title="Modifica pianificazione">
                                    ‚úèÔ∏è Modifica
                                </button>
                                ${p.stato === 'bozza' ? `
                                <button class="btn btn-info" onclick="confermaPianificazioneConfirm('${p.id}')" 
                                        style="padding: 5px 10px; font-size: 12px;" title="Conferma pianificazione">
                                    ‚úÖ Conferma
                                </button>
                                ` : ''}
                                <button class="btn btn-danger" onclick="eliminaPianificazioneConfirm('${p.id}')" 
                                        style="padding: 5px 10px; font-size: 12px;" title="Elimina pianificazione">
                                    üóëÔ∏è Elimina
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function getStatoBadge(stato) {
            const badges = {
                'bozza': '<span class="badge badge-bozza">üìù Bozza</span>',
                'confermato': '<span class="badge badge-confermato">‚úÖ Confermato</span>',
                'impiantato': '<span class="badge badge-impiantato">üå± Impiantato</span>'
            };
            return badges[stato] || stato;
        }

        window.selezionaPianificazione = function(pianificazioneId) {
            pianificazioneSelezionata = pianificazioni.find(p => p.id === pianificazioneId);
            if (!pianificazioneSelezionata) {
                showAlert('Pianificazione non trovata', 'error');
                return;
            }

            // Verifica se la pianificazione ha dati completi
            const hasCompleteData = pianificazioneSelezionata.numeroFile > 0 && 
                                   pianificazioneSelezionata.numeroUnitaTotale > 0 &&
                                   pianificazioneSelezionata.superficieNettaImpianto > 0;

            if (!hasCompleteData) {
                showAlert('‚ö†Ô∏è Questa pianificazione non ha dati completi (numeroFile o numeroUnitaTotale = 0). ' +
                         'Completa la pianificazione nella pagina di pianificazione impianto prima di calcolare i materiali.', 
                         'warning');
                // Mostra comunque le info ma disabilita il calcolo
                const terreno = terreni.find(t => t.id === pianificazioneSelezionata.terrenoId);
                const terrenoNome = terreno ? terreno.nome : 'Terreno non trovato';
                document.getElementById('pianificazione-nome').textContent = 
                    `${terrenoNome} - Pianificazione incompleta (bozza)`;
                document.getElementById('info-pianificazione-selezionata').style.display = 'block';
                document.getElementById('config-section').style.display = 'block';
                document.getElementById('risultati-section').style.display = 'none';
                
                // Disabilita il pulsante calcola
                const calcolaBtn = document.querySelector('#config-section button.btn-success');
                if (calcolaBtn) {
                    calcolaBtn.disabled = true;
                    calcolaBtn.title = 'Completa la pianificazione prima di calcolare i materiali';
                }
                
                // Scroll alla sezione configurazione
                document.getElementById('config-section').scrollIntoView({ behavior: 'smooth' });
                return;
            }

            // Mostra sezione configurazione
            document.getElementById('config-section').style.display = 'block';
            document.getElementById('risultati-section').style.display = 'none';

            // Mostra info pianificazione
            const terreno = terreni.find(t => t.id === pianificazioneSelezionata.terrenoId);
            const terrenoNome = terreno ? terreno.nome : 'Terreno non trovato';
            document.getElementById('pianificazione-nome').textContent = 
                `${terrenoNome} - ${pianificazioneSelezionata.numeroFile} file - ${(pianificazioneSelezionata.numeroUnitaTotale || 0).toLocaleString('it-IT')} unit√†`;
            document.getElementById('info-pianificazione-selezionata').style.display = 'block';

            // Abilita il pulsante calcola
            const calcolaBtn = document.querySelector('#config-section button.btn-success');
            if (calcolaBtn) {
                calcolaBtn.disabled = false;
                calcolaBtn.title = '';
            }
            
            // Pre-compila tipo impianto se presente nella pianificazione
            if (pianificazioneSelezionata.formaAllevamento) {
                const tipoImpiantoSelect = document.getElementById('tipoImpianto');
                if (tipoImpiantoSelect) {
                    // La pianificazione ha la chiave tecnica (es. "guyot")
                    // Il dropdown tipoImpianto usa le stesse chiavi
                    tipoImpiantoSelect.value = pianificazioneSelezionata.formaAllevamento;
                    
                    // Trigger evento change per pre-compilare i campi
                    if (tipoImpiantoSelect.value && TIPI_IMPIANTO[tipoImpiantoSelect.value]) {
                        tipoImpiantoSelect.dispatchEvent(new Event('change'));
                    }
                }
            }
            
            // Scroll alla sezione configurazione
            document.getElementById('config-section').scrollIntoView({ behavior: 'smooth' });
        };

        function setupEventListeners() {
            // Aggiorna descrizione e precompila valori quando cambia tipo impianto
            document.getElementById('tipoImpianto').addEventListener('change', function() {
                const tipo = this.value;
                const descEl = document.getElementById('tipo-impianto-desc');
                
                if (tipo && TIPI_IMPIANTO[tipo]) {
                    const config = TIPI_IMPIANTO[tipo];
                    descEl.textContent = config.descrizione;
                    
                    // Elementi del form
                    const numFiliPortataEl = document.getElementById('numeroFiliPortata');
                    const numFiliVegetazioneEl = document.getElementById('numeroFiliVegetazione');
                    const diamFiloPortataEl = document.getElementById('diametroFiloPortata');
                    const diamFiloVegetazioneEl = document.getElementById('diametroFiloVegetazione');
                    const usaTutoriEl = document.getElementById('usaTutori');
                    const usaAncoreEl = document.getElementById('usaAncore');
                    
                    // Precompila sempre i valori quando si seleziona un tipo impianto
                    // Numero Fili Portata
                    if (config.numeroFiliPortata !== undefined) {
                        numFiliPortataEl.value = config.numeroFiliPortata;
                        numFiliPortataEl.placeholder = `Default: ${config.numeroFiliPortata}`;
                    }
                    
                    // Abilita/disabilita campo numero fili portata in base al tipo impianto
                    if (config.numeroFiliPortata === 0) {
                        numFiliPortataEl.disabled = true;
                        numFiliPortataEl.placeholder = 'Non applicabile (sistema senza fili)';
                    } else {
                        numFiliPortataEl.disabled = false;
                    }
                    
                    // Numero Fili Vegetazione
                    if (config.numeroFiliVegetazione !== undefined) {
                        numFiliVegetazioneEl.value = config.numeroFiliVegetazione;
                        numFiliVegetazioneEl.placeholder = `Default: ${config.numeroFiliVegetazione}`;
                    }
                    
                    // Diametro Fili Portata
                    if (config.numeroFiliPortata > 0 && config.diametroFiloPortata) {
                        diamFiloPortataEl.value = config.diametroFiloPortata;
                        diamFiloPortataEl.placeholder = `Default: ${config.diametroFiloPortata}mm`;
                        diamFiloPortataEl.disabled = false;
                    } else {
                        diamFiloPortataEl.value = '';
                        diamFiloPortataEl.placeholder = 'Non applicabile (nessun filo portata)';
                        diamFiloPortataEl.disabled = true;
                    }
                    
                    // Diametro Fili Vegetazione
                    if (config.numeroFiliVegetazione > 0 && config.diametroFiloVegetazione) {
                        diamFiloVegetazioneEl.value = config.diametroFiloVegetazione;
                        diamFiloVegetazioneEl.placeholder = `Default: ${config.diametroFiloVegetazione}mm`;
                        diamFiloVegetazioneEl.disabled = false;
                    } else {
                        diamFiloVegetazioneEl.value = '';
                        diamFiloVegetazioneEl.placeholder = 'Non applicabile (nessun filo vegetazione)';
                        diamFiloVegetazioneEl.disabled = true;
                    }
                    
                    // Precompila Braccetti
                    if (config.necessitaTutori !== undefined) {
                        usaTutoriEl.value = config.necessitaTutori ? 'true' : 'false';
                    }
                    
                    // Precompila Ancore
                    if (config.necessitaAncore !== undefined) {
                        usaAncoreEl.value = config.necessitaAncore ? 'true' : 'false';
                    }
                } else {
                    descEl.textContent = '';
                    // Reset campi se nessun tipo selezionato
                    document.getElementById('numeroFiliPortata').value = '';
                    document.getElementById('numeroFiliVegetazione').value = '';
                    document.getElementById('diametroFiloPortata').value = '';
                    document.getElementById('diametroFiloVegetazione').value = '';
                    document.getElementById('usaTutori').value = '';
                    document.getElementById('usaAncore').value = '';
                }
            });
            
            // Abilita/disabilita campo diametro portata quando cambia numero fili portata
            document.getElementById('numeroFiliPortata').addEventListener('change', function() {
                const numFili = parseInt(this.value) || 0;
                const diamFiloPortataEl = document.getElementById('diametroFiloPortata');
                
                if (numFili > 0) {
                    diamFiloPortataEl.disabled = false;
                    if (!diamFiloPortataEl.value) {
                        // Se vuoto, ripristina placeholder
                        const tipo = document.getElementById('tipoImpianto').value;
                        if (tipo && TIPI_IMPIANTO[tipo]) {
                            diamFiloPortataEl.placeholder = `Default: ${TIPI_IMPIANTO[tipo].diametroFiloPortata}mm`;
                        } else {
                            diamFiloPortataEl.placeholder = 'Auto (da tipo impianto)';
                        }
                    }
                } else {
                    diamFiloPortataEl.disabled = true;
                    diamFiloPortataEl.value = '';
                    diamFiloPortataEl.placeholder = 'Non applicabile (nessun filo portata)';
                }
            });
            
            // Abilita/disabilita campo diametro vegetazione quando cambia numero fili vegetazione
            document.getElementById('numeroFiliVegetazione').addEventListener('change', function() {
                const numFili = parseInt(this.value) || 0;
                const diamFiloVegetazioneEl = document.getElementById('diametroFiloVegetazione');
                
                if (numFili > 0) {
                    diamFiloVegetazioneEl.disabled = false;
                    if (!diamFiloVegetazioneEl.value) {
                        // Se vuoto, ripristina placeholder
                        const tipo = document.getElementById('tipoImpianto').value;
                        if (tipo && TIPI_IMPIANTO[tipo]) {
                            diamFiloVegetazioneEl.placeholder = `Default: ${TIPI_IMPIANTO[tipo].diametroFiloVegetazione}mm`;
                        } else {
                            diamFiloVegetazioneEl.placeholder = 'Auto (da tipo impianto)';
                        }
                    }
                } else {
                    diamFiloVegetazioneEl.disabled = true;
                    diamFiloVegetazioneEl.value = '';
                    diamFiloVegetazioneEl.placeholder = 'Non applicabile (nessun filo vegetazione)';
                }
            });
        }

        window.calcolaMateriali = function() {
            if (!pianificazioneSelezionata) {
                showAlert('Seleziona una pianificazione prima di calcolare i materiali', 'warning');
                return;
            }

            // Verifica se la pianificazione ha dati completi
            const hasCompleteData = pianificazioneSelezionata.numeroFile > 0 && 
                                   pianificazioneSelezionata.numeroUnitaTotale > 0 &&
                                   pianificazioneSelezionata.superficieNettaImpianto > 0;

            if (!hasCompleteData) {
                showAlert('‚ö†Ô∏è Impossibile calcolare i materiali: questa pianificazione non ha dati completi. ' +
                         'Completa la pianificazione nella pagina di pianificazione impianto (calcola il reticolato) prima di procedere.', 
                         'error');
                return;
            }

            const tipoImpianto = document.getElementById('tipoImpianto').value;
            if (!tipoImpianto) {
                showAlert('Seleziona un tipo di impianto', 'warning');
                return;
            }

            const distanzaPali = parseFloat(document.getElementById('distanzaPali').value);
            const altezzaPali = parseFloat(document.getElementById('altezzaPali').value);
            
            // Fili di portata
            const numeroFiliPortata = document.getElementById('numeroFiliPortata').value ? 
                parseInt(document.getElementById('numeroFiliPortata').value) : null;
            const diametroFiloPortata = document.getElementById('diametroFiloPortata').value ? 
                parseFloat(document.getElementById('diametroFiloPortata').value) : null;
            
            // Fili di vegetazione
            const numeroFiliVegetazione = document.getElementById('numeroFiliVegetazione').value ? 
                parseInt(document.getElementById('numeroFiliVegetazione').value) : null;
            const diametroFiloVegetazione = document.getElementById('diametroFiloVegetazione').value ? 
                parseFloat(document.getElementById('diametroFiloVegetazione').value) : null;
            
            // Supporti
            const usaTutori = document.getElementById('usaTutori').value === '' ? null : 
                document.getElementById('usaTutori').value === 'true';
            const usaAncore = document.getElementById('usaAncore').value === '' ? null : 
                document.getElementById('usaAncore').value === 'true';
            
            // Fissaggio tutori
            const fissaggioTutori = document.getElementById('fissaggioTutori').value || 'legacci';

            const configurazione = {
                tipoImpianto,
                distanzaPali,
                altezzaPali,
                numeroFiliPortata,
                numeroFiliVegetazione,
                diametroFiloPortata,
                diametroFiloVegetazione,
                usaTutori,
                usaAncore,
                fissaggioTutori
            };

            try {
                const materiali = calcolaMateriali(pianificazioneSelezionata, configurazione);
                materialiCalcolati = materiali; // Salva per export PDF
                renderMateriali(materiali);
                
                // Mostra sezione risultati
                document.getElementById('risultati-section').style.display = 'block';
                document.getElementById('risultati-section').scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                console.error('Errore calcolo materiali:', error);
                showAlert('Errore durante il calcolo: ' + error.message, 'error');
            }
        };

        function renderMateriali(materiali) {
            const container = document.getElementById('materiali-container');
            const righe = formattaMaterialiPerTabella(materiali);
            
            // Raggruppa per categoria
            const perCategoria = {};
            righe.forEach(riga => {
                if (!perCategoria[riga.categoria]) {
                    perCategoria[riga.categoria] = [];
                }
                perCategoria[riga.categoria].push(riga);
            });

            let html = '<div class="table-container">';
            html += '<table>';
            html += '<thead><tr><th>Categoria</th><th>Materiale</th><th>Quantit√†</th><th>Unit√†</th><th>Descrizione</th></tr></thead>';
            html += '<tbody>';

            Object.keys(perCategoria).forEach(categoria => {
                perCategoria[categoria].forEach((riga, index) => {
                    const isTotal = riga.isTotal;
                    html += `
                        <tr ${isTotal ? 'class="total-row"' : ''}>
                            <td>${index === 0 ? categoria : ''}</td>
                            <td>${riga.materiale}</td>
                            <td>${riga.quantita}</td>
                            <td>${riga.unitaMisura}</td>
                            <td>${riga.descrizione}</td>
                        </tr>
                    `;
                });
            });

            html += '</tbody></table>';
            html += '</div>';

            // Aggiungi riepilogo
            html += `
                <div style="margin-top: 30px; padding: 20px; background: #F3E5F5; border-radius: 8px; position: relative;">
                    <h3 style="color: #6A1B9A; margin-bottom: 15px;">Riepilogo Pianificazione</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div>
                            <strong>Tipo Impianto:</strong><br>
                            ${materiali.riepilogo.tipoImpianto}
                        </div>
                        <div>
                            <strong>Numero File:</strong><br>
                            ${materiali.riepilogo.numeroFile}
                        </div>
                        <div>
                            <strong>Unit√† Totali:</strong><br>
                            ${materiali.riepilogo.numeroUnitaTotale.toLocaleString('it-IT')}
                        </div>
                        <div>
                            <strong>Lunghezza Filari:</strong><br>
                            ${materiali.riepilogo.lunghezzaFilariTotale.toFixed(2)} m
                        </div>
                        <div>
                            <strong>Distanza Pali:</strong><br>
                            ${materiali.riepilogo.distanzaPali} m
                        </div>
                        ${materiali.riepilogo.numeroFiliPortata > 0 ? `
                        <div>
                            <strong>Fili di Portata:</strong><br>
                            ${materiali.riepilogo.numeroFiliPortata} fili (${materiali.riepilogo.diametroFiloPortata}mm)
                        </div>
                        ` : '<div><strong>Fili di Portata:</strong><br>Nessuno (sistema senza fili)</div>'}
                        ${materiali.riepilogo.numeroFiliVegetazione > 0 ? `
                        <div>
                            <strong>Fili di Vegetazione:</strong><br>
                            ${materiali.riepilogo.numeroFiliVegetazione} fili (${materiali.riepilogo.diametroFiloVegetazione}mm)
                        </div>
                        ` : ''}
                    </div>
                    <div style="margin-top: 20px; display: flex; justify-content: flex-end;">
                        <button class="btn btn-danger" onclick="esportaPDF()" style="display: inline-flex; align-items: center; gap: 8px;">
                            üìÑ Esporta PDF
                        </button>
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        // Funzione per esportare in PDF
        window.esportaPDF = function() {
            if (typeof window.jspdf === 'undefined') {
                showAlert('Libreria PDF non caricata. Ricarica la pagina.', 'error');
                return;
            }

            if (!materialiCalcolati || !pianificazioneSelezionata) {
                showAlert('Nessun calcolo disponibile. Calcola prima i materiali.', 'error');
                return;
            }

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Configurazione
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const margin = 15;
                let yPos = margin;
                const lineHeight = 7;
                const titleSize = 16;
                const subtitleSize = 12;
                const normalSize = 10;

                // Titolo
                doc.setFontSize(titleSize);
                doc.setFont(undefined, 'bold');
                doc.text('Lista Materiali Impianto Vigneto', pageWidth / 2, yPos, { align: 'center' });
                yPos += lineHeight * 2;

                // Dati Pianificazione
                const terreno = terreni.find(t => t.id === pianificazioneSelezionata.terrenoId);
                const terrenoNome = terreno ? terreno.nome : 'Terreno sconosciuto';
                
                doc.setFontSize(subtitleSize);
                doc.setFont(undefined, 'bold');
                doc.text('Dati Pianificazione', margin, yPos);
                yPos += lineHeight;

                doc.setFontSize(normalSize);
                doc.setFont(undefined, 'normal');
                doc.text(`Terreno: ${terrenoNome}`, margin, yPos);
                yPos += lineHeight;
                doc.text(`Tipo Impianto: ${String(materialiCalcolati.riepilogo.tipoImpianto || '')}`, margin, yPos);
                yPos += lineHeight;
                doc.text(`Numero File: ${String(materialiCalcolati.riepilogo.numeroFile || 0)}`, margin, yPos);
                yPos += lineHeight;
                const unitaTotaliStr = materialiCalcolati.riepilogo.numeroUnitaTotale ? 
                    String(materialiCalcolati.riepilogo.numeroUnitaTotale.toLocaleString('it-IT')) : '0';
                doc.text(`Unit√† Totali: ${unitaTotaliStr}`, margin, yPos);
                yPos += lineHeight;
                const superficieStr = String((pianificazioneSelezionata.superficieNettaImpianto || 0).toFixed(2));
                doc.text(`Superficie Netta: ${superficieStr} Ha`, margin, yPos);
                yPos += lineHeight;
                const lunghezzaFilariStr = String(materialiCalcolati.riepilogo.lunghezzaFilariTotale.toFixed(2));
                doc.text(`Lunghezza Filari Totale: ${lunghezzaFilariStr} m`, margin, yPos);
                yPos += lineHeight;
                const distanzaPaliStr = String(materialiCalcolati.riepilogo.distanzaPali || '');
                doc.text(`Distanza Pali: ${distanzaPaliStr} m`, margin, yPos);
                yPos += lineHeight * 1.5;

                // Tabella Materiali
                const righe = formattaMaterialiPerTabella(materialiCalcolati);
                
                // Raggruppa per categoria
                const perCategoria = {};
                righe.forEach(riga => {
                    if (!perCategoria[riga.categoria]) {
                        perCategoria[riga.categoria] = [];
                    }
                    perCategoria[riga.categoria].push(riga);
                });

                // Intestazione tabella
                doc.setFontSize(subtitleSize);
                doc.setFont(undefined, 'bold');
                doc.text('Materiali Necessari', margin, yPos);
                yPos += lineHeight * 1.5;

                // Colonne tabella - ricalcolate per distribuire meglio lo spazio
                const usableWidth = pageWidth - (margin * 2);
                // Larghezze: Categoria (30mm), Materiale (45mm), Quantit√† (25mm), Unit√† (20mm), Descrizione (resto ~70mm)
                const colWidths = [30, 45, 25, 20, usableWidth - 30 - 45 - 25 - 20];
                const colPositions = [
                    margin, 
                    margin + colWidths[0], 
                    margin + colWidths[0] + colWidths[1], 
                    margin + colWidths[0] + colWidths[1] + colWidths[2],
                    margin + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3]
                ];

                // Intestazione colonne
                doc.setFontSize(9);
                doc.setFont(undefined, 'bold');
                doc.text('Categoria', colPositions[0], yPos);
                doc.text('Materiale', colPositions[1], yPos);
                doc.text('Quantit√†', colPositions[2], yPos);
                doc.text('Unit√†', colPositions[3], yPos);
                doc.text('Descrizione', colPositions[4], yPos);
                yPos += lineHeight;

                // Linea separatrice
                doc.setLineWidth(0.5);
                doc.line(margin, yPos - 2, pageWidth - margin, yPos - 2);
                yPos += lineHeight * 0.5;

                // Righe tabella
                doc.setFontSize(normalSize);
                doc.setFont(undefined, 'normal');
                
                Object.keys(perCategoria).forEach(categoria => {
                    perCategoria[categoria].forEach((riga, index) => {
                        // Controlla se serve una nuova pagina
                        if (yPos > pageHeight - margin - lineHeight * 3) {
                            doc.addPage();
                            yPos = margin;
                        }

                        const isTotal = riga.isTotal;
                        if (isTotal) {
                            doc.setFont(undefined, 'bold');
                        }

                        // Salva yPos iniziale per questa riga
                        const yPosIniziale = yPos;
                        let maxRighe = 1;
                        
                        // Categoria (solo prima riga del gruppo)
                        if (index === 0) {
                            const categoriaText = String(riga.categoria || '');
                            const catLines = doc.splitTextToSize(categoriaText, colWidths[0] - 2);
                            doc.text(catLines, colPositions[0], yPos, { maxWidth: colWidths[0] - 2 });
                            maxRighe = Math.max(maxRighe, catLines.length);
                        }
                        
                        // Materiale
                        const materialeText = String(riga.materiale || '');
                        const matLines = doc.splitTextToSize(materialeText, colWidths[1] - 2);
                        doc.text(matLines, colPositions[1], yPos, { maxWidth: colWidths[1] - 2 });
                        maxRighe = Math.max(maxRighe, matLines.length);
                        
                        // Quantit√† (converti in stringa, gestisci null/undefined)
                        let quantitaStr = '';
                        if (riga.quantita != null) {
                            if (typeof riga.quantita === 'number') {
                                quantitaStr = riga.quantita.toString();
                            } else if (typeof riga.quantita === 'string') {
                                quantitaStr = riga.quantita;
                            } else {
                                quantitaStr = String(riga.quantita);
                            }
                        }
                        const qtyLines = doc.splitTextToSize(quantitaStr, colWidths[2] - 2);
                        doc.text(qtyLines, colPositions[2], yPos, { maxWidth: colWidths[2] - 2 });
                        maxRighe = Math.max(maxRighe, qtyLines.length);
                        
                        // Unit√†
                        const unitaText = String(riga.unitaMisura || '');
                        const unitLines = doc.splitTextToSize(unitaText, colWidths[3] - 2);
                        doc.text(unitLines, colPositions[3], yPos, { maxWidth: colWidths[3] - 2 });
                        maxRighe = Math.max(maxRighe, unitLines.length);
                        
                        // Descrizione - usa splitTextToSize per wrappare il testo su pi√π righe
                        const descrizione = String(riga.descrizione || '');
                        const descLines = doc.splitTextToSize(descrizione, colWidths[4] - 2);
                        doc.text(descLines, colPositions[4], yPos, { maxWidth: colWidths[4] - 2 });
                        maxRighe = Math.max(maxRighe, descLines.length);
                        
                        // Aumenta yPos in base al numero massimo di righe
                        if (maxRighe > 1) {
                            yPos += lineHeight * (maxRighe - 1);
                        }

                        if (isTotal) {
                            doc.setFont(undefined, 'normal');
                        }

                        yPos += lineHeight;
                    });
                });

                // Riepilogo finale
                yPos += lineHeight;
                if (yPos > pageHeight - margin - lineHeight * 8) {
                    doc.addPage();
                    yPos = margin;
                }

                doc.setFontSize(subtitleSize);
                doc.setFont(undefined, 'bold');
                doc.text('Riepilogo Configurazione', margin, yPos);
                yPos += lineHeight * 1.5;

                doc.setFontSize(normalSize);
                doc.setFont(undefined, 'normal');
                const filiPortataText = materialiCalcolati.riepilogo.numeroFiliPortata > 0 ? 
                    `${String(materialiCalcolati.riepilogo.numeroFiliPortata)} fili (${String(materialiCalcolati.riepilogo.diametroFiloPortata)}mm)` : 
                    'Nessuno';
                doc.text(`Fili di Portata: ${filiPortataText}`, margin, yPos);
                yPos += lineHeight;
                
                if (materialiCalcolati.riepilogo.numeroFiliVegetazione > 0) {
                    doc.text(`Fili di Vegetazione: ${String(materialiCalcolati.riepilogo.numeroFiliVegetazione)} fili (${String(materialiCalcolati.riepilogo.diametroFiloVegetazione)}mm)`, margin, yPos);
                    yPos += lineHeight;
                }

                // Data e firma
                yPos += lineHeight;
                const dataOggi = new Date().toLocaleDateString('it-IT');
                doc.text(`Documento generato il: ${dataOggi}`, margin, yPos);
                yPos += lineHeight;
                doc.text('GFV Platform - Calcolo Materiali Impianto', pageWidth / 2, yPos, { align: 'center' });

                // Salva PDF
                const fileName = `materiali-impianto-${terrenoNome.replace(/\s+/g, '-')}-${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);
                
                showAlert('PDF esportato con successo!', 'success');
            } catch (error) {
                console.error('Errore esportazione PDF:', error);
                showAlert('Errore durante l\'esportazione PDF: ' + error.message, 'error');
            }
        };

        window.resetConfigurazione = function() {
            document.getElementById('tipoImpianto').value = '';
            document.getElementById('distanzaPali').value = '5.0';
            document.getElementById('altezzaPali').value = '2.5';
            
            // Reset campi fili
            const numFiliPortataEl = document.getElementById('numeroFiliPortata');
            const numFiliVegetazioneEl = document.getElementById('numeroFiliVegetazione');
            const diamFiloPortataEl = document.getElementById('diametroFiloPortata');
            const diamFiloVegetazioneEl = document.getElementById('diametroFiloVegetazione');
            
            numFiliPortataEl.value = '';
            numFiliVegetazioneEl.value = '';
            diamFiloPortataEl.value = '';
            diamFiloVegetazioneEl.value = '';
            
            // Abilita tutti i campi
            numFiliPortataEl.disabled = false;
            numFiliVegetazioneEl.disabled = false;
            diamFiloPortataEl.disabled = false;
            diamFiloVegetazioneEl.disabled = false;
            
            // Reset placeholder
            numFiliPortataEl.placeholder = 'Auto (da tipo impianto)';
            numFiliVegetazioneEl.placeholder = 'Auto (da tipo impianto)';
            diamFiloPortataEl.placeholder = 'Auto (da tipo impianto)';
            diamFiloVegetazioneEl.placeholder = 'Auto (da tipo impianto)';
            
            // Reset braccetti, ancore e fissaggio tutori
            document.getElementById('usaTutori').value = '';
            document.getElementById('usaAncore').value = '';
            document.getElementById('fissaggioTutori').value = 'legacci';
            
            // Reset descrizione
            document.getElementById('tipo-impianto-desc').textContent = '';
            
            // Nascondi risultati
            document.getElementById('risultati-section').style.display = 'none';
        };

        function showAlert(message, type = 'info') {
            const container = document.getElementById('alert-container');
            const alertClass = type === 'error' ? 'alert-error' : type === 'warning' ? 'alert-warning' : 'alert-info';
            container.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        // Funzione per modificare una pianificazione
        window.modificaPianificazione = function(pianificazioneId) {
            if (!pianificazioneId) {
                showAlert('ID pianificazione non valido', 'error');
                return;
            }
            
            // Reindirizza alla pagina di pianificazione con parametro URL
            window.location.href = `pianifica-impianto-standalone.html?pianificazioneId=${pianificazioneId}`;
        };

        // Funzione per confermare eliminazione pianificazione
        window.eliminaPianificazioneConfirm = function(pianificazioneId) {
            if (!pianificazioneId) {
                showAlert('ID pianificazione non valido', 'error');
                return;
            }

            const pianificazione = pianificazioni.find(p => p.id === pianificazioneId);
            if (!pianificazione) {
                showAlert('Pianificazione non trovata', 'error');
                return;
            }

            const terreno = terreni.find(t => t.id === pianificazione.terrenoId);
            const terrenoNome = terreno ? terreno.nome : 'Terreno non trovato';
            const dataCreazione = pianificazione.createdAt ? 
                (pianificazione.createdAt.toDate ? pianificazione.createdAt.toDate().toLocaleDateString('it-IT') : new Date(pianificazione.createdAt).toLocaleDateString('it-IT')) : '-';

            const messaggio = `Sei sicuro di voler eliminare questa pianificazione?\n\n` +
                            `Terreno: ${terrenoNome}\n` +
                            `Data creazione: ${dataCreazione}\n` +
                            `Stato: ${pianificazione.stato || 'bozza'}\n\n` +
                            `L'operazione non pu√≤ essere annullata.`;

            if (confirm(messaggio)) {
                eliminaPianificazioneAction(pianificazioneId);
            }
        };

        // Funzione per eseguire l'eliminazione
        async function eliminaPianificazioneAction(pianificazioneId) {
            try {
                await deletePianificazione(pianificazioneId);
                showAlert('Pianificazione eliminata con successo', 'info');
                
                // Ricarica la lista
                await loadPianificazioni();
                
                // Se la pianificazione eliminata era selezionata, nascondi sezioni
                if (pianificazioneSelezionata && pianificazioneSelezionata.id === pianificazioneId) {
                    pianificazioneSelezionata = null;
                    document.getElementById('config-section').style.display = 'none';
                    document.getElementById('risultati-section').style.display = 'none';
                }
            } catch (error) {
                console.error('Errore eliminazione pianificazione:', error);
                showAlert('Errore nell\'eliminazione: ' + error.message, 'error');
            }
        }

        // Funzione per confermare pianificazione (con dialog di conferma)
        window.confermaPianificazioneConfirm = function(pianificazioneId) {
            const pianificazione = pianificazioni.find(p => p.id === pianificazioneId);
            if (!pianificazione) {
                showAlert('Pianificazione non trovata', 'error');
                return;
            }

            const terreno = terreni.find(t => t.id === pianificazione.terrenoId);
            const terrenoNome = terreno ? terreno.nome : 'Terreno sconosciuto';
            
            const conferma = confirm(
                `Sei sicuro di voler confermare questa pianificazione?\n\n` +
                `Terreno: ${terrenoNome}\n` +
                `File: ${pianificazione.numeroFile || 0}\n` +
                `Unit√†: ${(pianificazione.numeroUnitaTotale || 0).toLocaleString('it-IT')}\n` +
                `Superficie: ${(pianificazione.superficieNettaImpianto || 0).toFixed(2)} Ha\n\n` +
                `La pianificazione passer√† da "BOZZA" a "CONFERMATO" e potr√† essere utilizzata per creare lavori di impianto.`
            );

            if (conferma) {
                confermaPianificazioneAction(pianificazioneId);
            }
        };

        // Funzione per eseguire la conferma
        async function confermaPianificazioneAction(pianificazioneId) {
            try {
                await confermaPianificazione(pianificazioneId);
                showAlert('Pianificazione confermata con successo', 'success');
                
                // Ricarica la lista
                await loadPianificazioni();
            } catch (error) {
                console.error('Errore conferma pianificazione:', error);
                showAlert('Errore nella conferma: ' + error.message, 'error');
            }
        }

        // Avvia inizializzazione
        init();
    </script>
</body>
</html>
