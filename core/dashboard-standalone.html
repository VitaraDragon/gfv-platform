<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - GFV Platform</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#2E8B57">
    <link rel="stylesheet" href="styles/dashboard.css">
    <link rel="stylesheet" href="styles/tour.css">
    <link rel="stylesheet" href="https://unpkg.com/intro.js/minified/introjs.min.css">
</head>
<body>
    <div class="dashboard-container">
        <div class="dashboard-header">
            <div>
                <h1>üåæ GFV Platform</h1>
                <div class="user-info" id="user-info">Caricamento...</div>
                <div class="user-roles" id="user-roles"></div>
            </div>
            <div class="header-actions">
                <a href="admin/impostazioni-standalone.html" class="btn btn-primary" style="text-decoration: none; display: inline-flex; align-items: center; gap: 8px;">
                    <span>‚öôÔ∏è</span>
                    <span>Impostazioni</span>
                </a>
                <a href="../documentazione-utente/index.html" target="_blank" rel="noopener" class="btn btn-primary" data-tour="guide-link" style="text-decoration: none; display: inline-flex; align-items: center; gap: 8px;">
                    <span>üìò</span>
                    <span>Guide</span>
                </a>
                <button class="btn btn-primary" id="dashboard-tour-button" type="button" style="display: inline-flex; align-items: center; gap: 8px;">
                    <span>üß≠</span>
                    <span>Tour</span>
                </button>
                <a href="admin/gestisci-utenti-standalone.html" id="invita-collaboratore-link" class="btn btn-primary" style="text-decoration: none; display: none; align-items: center; gap: 8px; font-size: 13px; padding: 8px 16px;">
                    <span>‚ûï</span>
                    <span>Invita Collaboratore</span>
                </a>
                <button class="btn btn-primary" id="switch-tenant-button" style="display: none; align-items: center; gap: 8px;">
                    <span>üè¢</span>
                    <span id="switch-tenant-text">Cambia Azienda</span>
                </button>
                <button class="logout-button" id="logout-button">Logout</button>
            </div>
        </div>

        <div id="dashboard-content" class="dashboard-content">
            <div class="loading">Caricamento dashboard...</div>
        </div>
    </div>

    <!-- Tony: widget globale (FAB + chat) ‚Äì URL assoluti su GitHub Pages per evitare problemi online -->
    <script>
    (function() {
      var path = (window.location.pathname || '').replace(/\\/g, '/');
      var isGH = path.indexOf('/gfv-platform/') >= 0;
      var base = isGH ? (window.location.origin + '/gfv-platform/core') : (path.indexOf('/core/admin/') >= 0 ? '../' : (path.indexOf('/modules/') >= 0 ? '../../../core/' : ''));
      var sep = (base && !base.endsWith('/')) ? '/' : '';
      var link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = (base ? base + sep : '') + 'styles/tony-widget.css';
      document.head.appendChild(link);
      var s = document.createElement('script');
      s.type = 'module';
      s.src = (base ? base + sep : '') + 'js/tony-widget-standalone.js';
      document.body.appendChild(s);
    })();
    </script>

    <script src="https://unpkg.com/intro.js/minified/intro.min.js" defer></script>
    <script src="js/config-loader.js"></script>
    <script src="js/dashboard-utils.js"></script>
    <script src="js/dashboard-sections.js"></script>
    
    <!-- Carica Firebase e Google Maps config in parallelo (pi√π veloce) -->
    <script>
        window.GFVConfigLoader.loadConfigAndMaps().then(() => {
            // Config pronti; lo script module proceder√† con Firebase e Maps
        }).catch(error => {
            console.error('Errore caricamento config:', error);
            document.getElementById('dashboard-content').innerHTML = `
                <div style="padding: 20px; text-align: center;">
                    <h3 style="color: #dc3545;">‚ö†Ô∏è Errore Configurazione</h3>
                    <p>File di configurazione Firebase non trovato.</p>
                    <p>Errore: ${error.message}</p>
                </div>
            `;
        });
    </script>
    
    <!-- Firebase SDK da CDN -->
    <script type="module">
        // Usa funzioni dai moduli caricati
        const { waitForConfig, loadGoogleMapsAPI } = window.GFVConfigLoader;
        const { 
            roleNames, 
            normalizeRole, 
            normalizeRoles, 
            escapeHtml, 
            hasRole, 
            hasAnyRole, 
            hasOnlyCoreModules, 
            hasManodoperaModule 
        } = window.GFVDashboardUtils;
        const {
            createCoreBaseSection,
            createAdminSection,
            createManagerSection,
            createAmministrazioneCard,
            createStatisticheCard,
            createTerreniCard,
            createDiarioAttivitaCard,
            createAbbonamentoCard,
            createAffittiScadenzaCard,
            createContoTerziCard,
            createVignetoCard,
            createFruttetoCard,
            createMagazzinoCard,
            createReportCard,
            createManagerManodoperaSection,
            createManagerLavoriSection,
            createDiarioDaLavoriSection,
            createCaposquadraSection,
            createOperaioSection
        } = window.GFVDashboardSections;
        const TOUR_STORAGE_KEY = 'gfv_dashboard_tour_v1';

        // ============================================
        // IMPORT MODULI ES6
        // ============================================
        import { renderDashboard as renderDashboardModule } from './js/dashboard-controller.js';
        import { 
            loadAmministrazioneStats as loadAmministrazioneStatsModule,
            loadAdminStats as loadAdminStatsModule,
            loadAffittiInScadenza as loadAffittiInScadenzaModule,
            loadCoreStatsForManager as loadCoreStatsForManagerModule,
            loadManagerManodoperaStats as loadManagerManodoperaStatsModule,
            loadRecentLavoriManagerManodopera as loadRecentLavoriManagerManodoperaModule,
            loadManagerLavoriStats as loadManagerLavoriStatsModule,
            loadRecentLavori as loadRecentLavoriModule,
            loadDiarioDaLavori as loadDiarioDaLavoriModule,
            loadCaposquadraStats as loadCaposquadraStatsModule,
            loadRecentLavoriCaposquadra as loadRecentLavoriCaposquadraModule,
            loadComunicazioniOperaio as loadComunicazioniOperaioModule,
            loadLavoriOggiOperaio as loadLavoriOggiOperaioModule,
            loadStatisticheOreOperaio as loadStatisticheOreOperaioModule,
            loadComunicazioneRapida as loadComunicazioneRapidaModule,
            loadComunicazioniInviateCaposquadra as loadComunicazioniInviateCaposquadraModule,
            loadDettagliTerreniPerLavori as loadDettagliTerreniPerLavoriModule,
            loadMagazzinoSottoScortaCount as loadMagazzinoSottoScortaCountModule,
            renderComunicazioneRapidaForm as renderComunicazioneRapidaFormModule,
            calcolaAlertAffitto as calcolaAlertAffittoModule,
            formattaDataScadenza as formattaDataScadenzaModule,
            formattaOre as formattaOreModule
        } from './js/dashboard-data.js';
        import { 
            createMappaAziendaleSection as createMappaAziendaleSectionModule,
            loadMappaAziendale as loadMappaAziendaleModule,
            getPolygonCenter as getPolygonCenterModule
        } from './js/dashboard-maps.js';
        import {
            setupDashboardTour as setupDashboardTourModule,
            startDashboardTour as startDashboardTourModule
        } from './js/dashboard-tour.js';
        import {
            handleLogout as handleLogoutModule,
            confermaComunicazione as confermaComunicazioneModule,
            handleRapidaLavoroChange as handleRapidaLavoroChangeModule,
            handleSendComunicazioneRapida as handleSendComunicazioneRapidaModule,
            showRapidaMessage as showRapidaMessageModule
        } from './js/dashboard-events.js';

        // Carica configurazione
        const firebaseConfig = await waitForConfig();

        // Inizializza Firebase usando il service condiviso (tutto da firebase-service = stesso SDK 11)
        const {
            initializeFirebase,
            getAuthInstance,
            getDb,
            getAppInstance,
            signOut,
            onAuthStateChanged,
            getDoc,
            doc,
            updateDoc,
            setDoc,
            serverTimestamp,
            collection,
            getDocs,
            query,
            where,
            orderBy,
            limit,
            addDoc,
            Timestamp,
            onSnapshot
        } = await import('./services/firebase-service.js');
        initializeFirebase(firebaseConfig);
        const auth = getAuthInstance();
        const db = getDb();
        console.log('[Tony] Firebase OK. Tony widget caricato da tony-widget-standalone.js.');

        // Google Maps: caricamento in background (non blocca la prima visualizzazione)
        let googleMapsReady = false;
        loadGoogleMapsAPI().then(() => {
            googleMapsReady = true;
        });

        // Conta utenti del tenant
        let tenantUserCount = 1; // Default a 1 (solo utente corrente)

        // Variabili per cleanup listener real-time
        let manutenzioniUnsubscribe = null;
        let guastiUnsubscribe = null;

        // ============================================
        // FUNZIONI SETUP REAL-TIME
        // ============================================
        
        /**
         * Setup listener real-time per manutenzioni in scadenza (per dashboard manager)
         * @param {string} tenantId - ID tenant
         */
        function setupManutenzioniRealtime(tenantId) {
            // TODO: Implementare se necessario per mostrare manutenzioni in scadenza nella dashboard
            // Per ora √® una funzione stub per evitare errori
            console.log('setupManutenzioniRealtime chiamato per tenant:', tenantId);
        }

        /**
         * Setup listener real-time per guasti segnalati (per dashboard manager)
         * @param {string} tenantId - ID tenant
         */
        function setupGuastiRealtime(tenantId) {
            try {
                if (!tenantId) return;

                // Rimuovi listener precedente
                if (guastiUnsubscribe) {
                    guastiUnsubscribe();
                    guastiUnsubscribe = null;
                }

                const guastiRef = collection(db, `tenants/${tenantId}/guasti`);
                
                // Prova prima con orderBy, se fallisce usa senza
                let guastiQuery;
                try {
                    guastiQuery = query(guastiRef, orderBy('segnalatoIl', 'desc'));
                } catch (e) {
                    // Se manca indice, usa collection senza query
                    guastiQuery = guastiRef;
                }

                guastiUnsubscribe = onSnapshot(
                    guastiQuery,
                    (snapshot) => {
                        const guastiList = [];
                        snapshot.forEach(doc => {
                            guastiList.push({ id: doc.id, ...doc.data() });
                        });

                        // Ordina se non abbiamo usato orderBy nella query
                        if (!guastiQuery.query) {
                            guastiList.sort((a, b) => {
                                const dateA = a.segnalatoIl?.toDate ? a.segnalatoIl.toDate() : new Date(a.segnalatoIl || 0);
                                const dateB = b.segnalatoIl?.toDate ? b.segnalatoIl.toDate() : new Date(b.segnalatoIl || 0);
                                return dateB - dateA;
                            });
                        }

                        // Filtra solo guasti aperti (non risolti)
                        const guastiAperti = guastiList.filter(g => g.stato !== 'risolto');
                        
                        // Aggiorna UI
                        updateGuastiSection(guastiAperti, tenantId);
                    },
                    (error) => {
                        console.error('Errore listener guasti dashboard:', error);
                        // Se fallisce con orderBy, prova senza
                        if (guastiQuery.query) {
                            const allGuastiRef = collection(db, `tenants/${tenantId}/guasti`);
                            guastiUnsubscribe = onSnapshot(
                                allGuastiRef,
                                (snapshot) => {
                                    const guastiList = [];
                                    snapshot.forEach(doc => {
                                        guastiList.push({ id: doc.id, ...doc.data() });
                                    });
                                    guastiList.sort((a, b) => {
                                        const dateA = a.segnalatoIl?.toDate ? a.segnalatoIl.toDate() : new Date(a.segnalatoIl || 0);
                                        const dateB = b.segnalatoIl?.toDate ? b.segnalatoIl.toDate() : new Date(b.segnalatoIl || 0);
                                        return dateB - dateA;
                                    });
                                    const guastiAperti = guastiList.filter(g => g.stato !== 'risolto');
                                    updateGuastiSection(guastiAperti, tenantId);
                                },
                                (error) => {
                                    console.error('Errore listener guasti dashboard (fallback):', error);
                                }
                            );
                        }
                    }
                );
            } catch (error) {
                console.error('Errore setup listener guasti dashboard:', error);
            }
        }

        /**
         * Aggiorna la sezione guasti nella dashboard
         * @param {Array} guastiAperti - Array di guasti aperti
         * @param {string} tenantId - ID tenant
         */
        function updateGuastiSection(guastiAperti, tenantId) {
            const section = document.getElementById('guasti-segnalati-section');
            const list = document.getElementById('guasti-segnalati-list');
            
            if (!section || !list) return;

            if (guastiAperti.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';
            
            let html = '';
            guastiAperti.slice(0, 5).forEach(guasto => {
                const tipoGuasto = guasto.tipoGuasto || 'macchina';
                const gravita = guasto.gravita || 'non-grave';
                const stato = guasto.stato || 'in-attesa';
                
                let titolo = '';
                let tipoIcon = 'üîß';
                
                if (tipoGuasto === 'generico') {
                    tipoIcon = 'üåç';
                    titolo = `${guasto.tipoProblema || 'Segnalazione'} - ${guasto.ubicazione || 'Ubicazione non specificata'}`;
                } else {
                    titolo = guasto.macchinaId ? 'Macchina' : 'Attrezzo';
                }

                const dataSegnalazione = guasto.segnalatoIl?.toDate 
                    ? guasto.segnalatoIl.toDate().toLocaleDateString('it-IT')
                    : new Date(guasto.segnalatoIl).toLocaleDateString('it-IT');

                const gravitaBadge = gravita === 'grave' 
                    ? '<span style="background: #dc3545; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; margin-left: 8px;">üî¥ Grave</span>'
                    : '<span style="background: #ffc107; color: #000; padding: 2px 8px; border-radius: 4px; font-size: 12px; margin-left: 8px;">üü° Non grave</span>';

                const statoBadge = stato === 'sospeso'
                    ? '<span style="background: #721c24; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; margin-left: 8px;">‚õî Sospeso</span>'
                    : '<span style="background: #856404; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; margin-left: 8px;">‚è≥ In attesa</span>';

                html += `
                    <div style="padding: 12px; margin-bottom: 10px; background: white; border-radius: 6px; border-left: 3px solid ${gravita === 'grave' ? '#dc3545' : '#ffc107'};">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                            <div style="font-weight: 600; color: #333;">
                                ${tipoIcon} ${escapeHtml(titolo)}
                            </div>
                            <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                ${gravitaBadge}
                                ${statoBadge}
                            </div>
                        </div>
                        <div style="font-size: 13px; color: #666; margin-bottom: 8px;">
                            ${escapeHtml(guasto.dettagli || 'Nessun dettaglio')}
                        </div>
                        <div style="font-size: 12px; color: #999; margin-bottom: 8px;">
                            Segnalato il: ${dataSegnalazione}
                        </div>
                        <div style="margin-top: 8px;">
                            <a href="admin/gestione-guasti-standalone.html" 
                               style="display: inline-block; padding: 6px 12px; background: #2E8B57; color: white; text-decoration: none; border-radius: 4px; font-size: 13px;">
                                üîß Gestisci Guasto
                            </a>
                        </div>
                    </div>
                `;
            });

            if (guastiAperti.length > 5) {
                html += `
                    <div style="text-align: center; margin-top: 10px; padding: 10px;">
                        <a href="admin/gestione-guasti-standalone.html" 
                           style="color: #2E8B57; text-decoration: none; font-weight: 600;">
                            Vedi tutti i ${guastiAperti.length} guasti ‚Üí
                        </a>
                    </div>
                `;
            }

            list.innerHTML = html;
        }

        // ============================================
        // PREPARA DIPENDENZE E CALLBACKS PER MODULI
        // ============================================
        const dependencies = {
            db,
            auth,
            getDoc,
            doc,
            collection,
            getDocs,
            query,
            where,
            orderBy,
            limit,
            addDoc,
            updateDoc,
            setDoc,
            serverTimestamp,
            Timestamp,
            onSnapshot,
            escapeHtml,
            loadGoogleMapsAPI,
            setupManutenzioniRealtime,
            setupGuastiRealtime
        };

        // Wrapper per createMappaAziendaleSection che usa il modulo
        const createMappaAziendaleSectionWrapper = (userData, hasManodopera) => {
            return createMappaAziendaleSectionModule(userData, hasManodopera, (userData, hasManodopera) => {
                loadMappaAziendaleModule(userData, hasManodopera, dependencies);
            });
        };

        const callbacks = {
            // Create functions (da window.GFVDashboardSections)
            createCoreBaseSection,
            createAdminSection,
            createManagerSection,
            createAmministrazioneCard,
            createStatisticheCard,
            createTerreniCard,
            createDiarioAttivitaCard,
            createAbbonamentoCard,
            createAffittiScadenzaCard,
            createContoTerziCard,
            createVignetoCard,
            createFruttetoCard,
            createMagazzinoCard,
            createReportCard,
            createManagerManodoperaSection,
            createDiarioDaLavoriSection,
            createCaposquadraSection,
            createOperaioSection,
            createMappaAziendaleSection: createMappaAziendaleSectionWrapper,
            // Load functions (da moduli ES6)
            loadAffittiInScadenza: loadAffittiInScadenzaModule,
            loadCoreStatsForManager: loadCoreStatsForManagerModule,
            loadManagerManodoperaStats: loadManagerManodoperaStatsModule,
            loadRecentLavoriManagerManodopera: loadRecentLavoriManagerManodoperaModule,
            loadDiarioDaLavori: loadDiarioDaLavoriModule,
            loadCaposquadraStats: loadCaposquadraStatsModule,
            loadRecentLavoriCaposquadra: loadRecentLavoriCaposquadraModule,
            loadComunicazioneRapida: loadComunicazioneRapidaModule,
            loadComunicazioniInviateCaposquadra: loadComunicazioniInviateCaposquadraModule,
            loadComunicazioniOperaio: loadComunicazioniOperaioModule,
            loadLavoriOggiOperaio: loadLavoriOggiOperaioModule,
            loadStatisticheOreOperaio: loadStatisticheOreOperaioModule,
            loadMappaAziendale: loadMappaAziendaleModule,
            loadMagazzinoSottoScortaCount: loadMagazzinoSottoScortaCountModule,
            // Utility functions
            hasRole,
            hasOnlyCoreModules,
            hasManodoperaModule,
            setupDashboardTour: setupDashboardTourModule
        };

        // ============================================
        // ESPORTAZIONI GLOBALI PER COMPATIBILIT√Ä
        // ============================================
        // Funzioni esposte globalmente per attributi HTML onclick/onchange
        
        // Wrapper per confermaComunicazione (usa modulo)
        window.confermaComunicazione = async function(comunicazioneId) {
            await confermaComunicazioneModule(comunicazioneId, auth, db, () => {
                // Callback per ricaricare comunicazioni
                const user = auth.currentUser;
                if (user) {
                    getDoc(doc(db, 'users', user.uid)).then(userDoc => {
                        if (userDoc.exists()) {
                            const userData = userDoc.data();
                            loadComunicazioniOperaioModule(userData, dependencies);
                        }
                    });
                }
            });
        };
        
        // Wrapper per handleRapidaLavoroChange (usa modulo)
        window.handleRapidaLavoroChange = function() {
            // lavoriAttiviCaposquadra √® una variabile globale definita in dashboard-data.js
            const user = auth.currentUser;
            if (user) {
                getDoc(doc(db, 'users', user.uid)).then(userDoc => {
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        if (userData.tenantId) {
                            // Nota: lavoriAttiviCaposquadra deve essere accessibile globalmente
                            // o passato come parametro. Per ora usiamo una variabile globale.
                            if (typeof window.lavoriAttiviCaposquadra !== 'undefined') {
                                handleRapidaLavoroChangeModule(window.lavoriAttiviCaposquadra, db, userData.tenantId);
                            }
                        }
                    }
                });
            }
        };
        
        // Wrapper per handleSendComunicazioneRapida (usa modulo)
        window.handleSendComunicazioneRapida = async function(e) {
            if (e && e.preventDefault) {
                e.preventDefault(); // Previeni submit di default
            }
            
            try {
                const user = auth.currentUser;
                if (!user) {
                    showRapidaMessageModule('Errore: utente non autenticato', 'error');
                    return;
                }
                
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                if (!userDoc.exists()) {
                    showRapidaMessageModule('Errore: dati utente non trovati', 'error');
                    return;
                }
                
                const userData = userDoc.data();
                if (!userData.tenantId) {
                    showRapidaMessageModule('Errore: tenant non trovato', 'error');
                    return;
                }
                
                if (typeof window.lavoriAttiviCaposquadra === 'undefined' || !window.lavoriAttiviCaposquadra || window.lavoriAttiviCaposquadra.length === 0) {
                    showRapidaMessageModule('Errore: nessun lavoro attivo disponibile', 'error');
                    return;
                }
                
                await handleSendComunicazioneRapidaModule(
                    e, 
                    auth, 
                    db, 
                    window.lavoriAttiviCaposquadra, 
                    showRapidaMessageModule
                );
            } catch (error) {
                console.error('Errore wrapper handleSendComunicazioneRapida:', error);
                showRapidaMessageModule('Errore durante l\'invio: ' + (error.message || 'Errore sconosciuto'), 'error');
            }
        };
        
        // Wrapper per renderComunicazioneRapidaForm (usa modulo)
        window.renderComunicazioneRapidaForm = function() {
            renderComunicazioneRapidaFormModule();
        };
        
        // segnaLavoroCompletato √® gi√† definita come funzione globale nel file (riga ~4485)
        // Non serve esportarla dal modulo

        // Carica contesto vigneto per Tony (produzione per anno) se modulo attivo
        async function loadTonyVignetoContext(availableModules) {
            if (!availableModules || !availableModules.includes('vigneto') || !window.Tony || !window.Tony.isReady()) return;
            try {
                const { getStatisticheVigneto } = await import('../modules/vigneto/services/vigneto-statistiche-service.js');
                const annoCorrente = new Date().getFullYear();
                const anni = [annoCorrente, annoCorrente - 1, annoCorrente - 2];
                const produzionePerAnno = {};
                let numeroVigneti = 0;
                for (const anno of anni) {
                    const stats = await getStatisticheVigneto(null, anno);
                    produzionePerAnno[anno] = {
                        produzioneTotaleQli: stats.produzioneTotaleQli ?? 0,
                        numeroVendemmie: stats.numeroVendemmie ?? 0,
                        resaMediaQliHa: stats.resaMediaQliHa
                    };
                    if (anno === annoCorrente && stats.numeroVigneti != null) numeroVigneti = stats.numeroVigneti;
                }
                const riepilogo = anni.map(a => {
                    const q = produzionePerAnno[a].produzioneTotaleQli;
                    return `Nel ${a}: ${q} qli di uva` + (produzionePerAnno[a].numeroVendemmie ? ` (${produzionePerAnno[a].numeroVendemmie} vendemmie)` : '');
                }).join('. ');
                window.Tony.setContext('vigneto', {
                    produzione_per_anno: produzionePerAnno,
                    numero_vigneti: numeroVigneti,
                    riepilogo_produzione: riepilogo
                });
            } catch (e) {
                console.warn('[Tony] Caricamento contesto vigneto non disponibile:', e);
            }
        }

        // Renderizza dashboard in base ai ruoli e moduli (usa modulo)
        async function renderDashboard(userData, availableModules = []) {
            await renderDashboardModule(userData, availableModules, callbacks, dependencies);
        }
        
        // Funzione renderDashboard originale rimossa - ora usa il modulo dashboard-controller.js
        
        // Le funzioni create* sono state estratte nel modulo dashboard-sections.js
        // Le funzioni load* sono state estratte nei moduli dashboard-data.js e dashboard-maps.js
        // Le funzioni tour sono state estratte nel modulo dashboard-tour.js
        // Tutte le funzioni duplicate sono state rimosse
        // Le funzioni load*, setupDashboardTour, startDashboardTour, buildDashboardTourSteps, 
        // createMappaAziendaleSection, loadMappaAziendale e tutte le altre sono state estratte nei moduli
        
        // Tutte le funzioni duplicate (loadAmministrazioneStats, loadAdminStats, setupDashboardTour, 
        // startDashboardTour, buildDashboardTourSteps, createMappaAziendaleSection, loadMappaAziendale,
        // e tutte le altre funzioni load*) sono state rimosse - ora sono nei moduli
        
        // Tutte le funzioni duplicate sono state rimosse - ora sono nei moduli
        
        // Mostra messaggio nel form rapido (funzione locale, non esportata)
        function showRapidaMessage(message, type) {
            const messageDiv = document.getElementById('rapida-message');
            if (!messageDiv) return;
            
            const color = type === 'success' ? '#28a745' : '#dc3545';
            const bgColor = type === 'success' ? '#d4edda' : '#f8d7da';
            
            messageDiv.innerHTML = `
                <div style="padding: 12px; background: ${bgColor}; color: ${color}; border-radius: 6px; font-size: 14px;">
                    ${message}
                </div>
            `;
            
            if (type === 'success') {
                setTimeout(() => {
                    messageDiv.innerHTML = '';
                }, 3000);
            }
        }

        // Verifica autenticazione e carica dashboard
        // Traccia l'utente previsto per questa scheda (per gestire cambio sessione)
        let expectedUserId = sessionStorage.getItem('gfv_expected_user_id');
        
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                // Non autenticato, redirect a login
                sessionStorage.removeItem('gfv_expected_user_id');
                window.location.href = './auth/login-standalone.html';
                return;
            }
            
            // Se questa scheda aveva un utente previsto e ora √® cambiato, gestisci il cambio
            if (expectedUserId && expectedUserId !== user.uid) {
                // L'utente √® cambiato (probabilmente un'altra scheda ha fatto login)
                // Se questa scheda non √® appena stata usata per registrazione, fai logout
                const justRegistered = sessionStorage.getItem('gfv_user_just_registered');
                if (!justRegistered) {
                    const { signOut } = await import('./services/firebase-service.js');
                    await signOut(auth);
                    sessionStorage.removeItem('gfv_expected_user_id');
                    window.location.href = './auth/login-standalone.html';
                    return;
                } else {
                    // Questa scheda √® appena stata usata per registrazione, aggiorna l'utente previsto
                    expectedUserId = user.uid;
                    sessionStorage.setItem('gfv_expected_user_id', user.uid);
                    sessionStorage.removeItem('gfv_user_just_registered');
                }
            } else if (!expectedUserId) {
                // Prima volta che carichiamo questa scheda, salva l'utente previsto
                expectedUserId = user.uid;
                sessionStorage.setItem('gfv_expected_user_id', user.uid);
            }

            // Carica dati utente
            // Verifica se l'utente si √® appena registrato
            const justRegistered = sessionStorage.getItem('gfv_user_just_registered') === 'true';
            const expectedTenantId = sessionStorage.getItem('gfv_expected_tenant_id');
            if (justRegistered) {
                await new Promise(resolve => setTimeout(resolve, 2000));
            }
            
            try {
                const userDocRef = doc(db, 'users', user.uid);
                const userDoc = await getDoc(userDocRef);

                if (!userDoc.exists()) {
                    // Il documento utente non esiste, verifica prima se esiste gi√† un documento con la stessa email
                    console.warn('‚ö†Ô∏è Documento utente non trovato per UID, verifico se esiste gi√† un documento con la stessa email...');
                    try {
                        // PRIMA VERIFICA: Cerca se esiste gi√† un documento con la stessa email (per evitare duplicati)
                        const existingUsersQuery = query(
                            collection(db, 'users'),
                            where('email', '==', user.email)
                        );
                        const existingUsersSnapshot = await getDocs(existingUsersQuery);
                        
                        if (!existingUsersSnapshot.empty) {
                            // Trovato un documento esistente con la stessa email ma UID diverso
                            // Questo √® un documento orfano o duplicato - aggiornalo con il nuovo UID
                            const existingDoc = existingUsersSnapshot.docs[0];
                            const existingData = existingDoc.data();
                            console.warn('‚ö†Ô∏è Trovato documento esistente con stessa email ma UID diverso:', existingDoc.id);
                            console.warn('‚ö†Ô∏è Aggiorno il documento esistente con il nuovo UID:', user.uid);
                            
                            // Aggiorna il documento esistente con il nuovo UID
                            await setDoc(userDocRef, {
                                ...existingData,
                                id: user.uid,
                                email: user.email,
                                ultimoAccesso: serverTimestamp(),
                                isOnline: true,
                                lastSeen: serverTimestamp()
                            });
                            
                            // Elimina il vecchio documento orfano
                            await deleteDoc(doc(db, 'users', existingDoc.id));
                            
                            // Ricarica il documento appena creato per continuare con il flusso normale
                            const updatedUserDoc = await getDoc(userDocRef);
                            if (!updatedUserDoc.exists()) {
                                throw new Error('Errore: documento non creato correttamente dopo merge');
                            }
                        } else {
                            // Nessun documento esistente con questa email, procedi con la creazione normale
                            // IMPORTANTE: Se l'utente non viene dalla registrazione, NON creare documento vuoto
                            // L'utente deve completare la registrazione prima
                            const justRegistered = sessionStorage.getItem('gfv_user_just_registered') === 'true';
                            
                            if (!justRegistered) {
                                console.warn('‚ö†Ô∏è ATTENZIONE: Utente autenticato ma documento non trovato e non viene dalla registrazione!');
                                console.warn('‚ö†Ô∏è Questo potrebbe indicare un problema. Redirect alla registrazione...');
                                await auth.signOut();
                                alert('Errore: documento utente non trovato. Completa la registrazione.');
                                window.location.href = '../auth/registrazione-standalone.html';
                                return;
                            }
                            
                            // Attendi un breve momento per evitare race condition con registrazione appena completata
                            await new Promise(resolve => setTimeout(resolve, 2000));
                            
                            // Ricarica il documento utente (dovrebbe essere stato creato dalla registrazione)
                            const retryUserDoc = await getDoc(userDocRef);
                            if (!retryUserDoc.exists()) {
                                console.error('‚ùå Errore: documento utente ancora non trovato dopo attesa');
                                await auth.signOut();
                                alert('Errore: documento utente non trovato. Riprova la registrazione.');
                                window.location.href = '../auth/registrazione-standalone.html';
                                return;
                            }
                            
                            // Se il documento esiste ora, continua con il flusso normale
                            const userData = retryUserDoc.data();
                            
                            // Ottieni tenant corrente e ruoli filtrati per questo tenant
                            const { getCurrentTenantId, getUserRolesForTenant } = await import('./services/tenant-service.js');
                            const currentTenantId = getCurrentTenantId() || userData.tenantId; // Fallback per retrocompatibilit√†
                            
                            // Ottieni ruoli per il tenant corrente (non tutti i ruoli)
                            let rolesForCurrentTenant = [];
                            if (currentTenantId) {
                                rolesForCurrentTenant = await getUserRolesForTenant(currentTenantId, user.uid);
                            }
                            
                            // Se non ci sono ruoli per il tenant corrente, usa ruoli deprecati come fallback
                            if (rolesForCurrentTenant.length === 0) {
                                rolesForCurrentTenant = userData.ruoli || [];
                            }
                            
                            const normalizedRoles = normalizeRoles(rolesForCurrentTenant);
                            
                            const userDataNormalized = {
                                ...userData,
                                ruoli: normalizedRoles,
                                tenantId: currentTenantId // Usa tenant corrente invece di deprecato
                            };
                            
                            // Carica moduli disponibili dal tenant CORRENTE (non deprecato)
                            let availableModules = [];
                            if (currentTenantId) {
                                try {
                                    const tenantDoc = await getDoc(doc(db, 'tenants', currentTenantId));
                                    if (tenantDoc.exists()) {
                                        const tenantData = tenantDoc.data();
                                        availableModules = tenantData.modules || [];
                                    }
                                } catch (e) {
                                    console.warn('Errore caricamento moduli tenant:', e);
                                }
                            }
                            
                            // Renderizza dashboard
                            await renderDashboard(userDataNormalized, availableModules);
                            // Nutre Tony con contesto dashboard (tenant corrente)
                            if (window.Tony && Tony.isReady()) {
                                Tony.setContext('dashboard', {
                                    info_azienda: { moduli_attivi: availableModules },
                                    utente_corrente: { nome: `${userDataNormalized.nome || ''} ${userDataNormalized.cognome || ''}`.trim() || (user && user.email) || '', ruoli: userDataNormalized.ruoli || [] },
                                    moduli_attivi: availableModules
                                });
                                loadTonyVignetoContext(availableModules);
                            }
                            return; // Esci qui per non eseguire il codice sotto
                        }
                    } catch (error) {
                        console.error('‚ùå Errore creazione documento utente:', error);
                        // Continua con il flusso di errore
                    }
                } else {
                    // Se arriviamo qui, significa che il documento esiste
                    const userData = userDoc.data();
                    
                    // Ottieni tenant corrente e ruoli filtrati per questo tenant
                    const { getCurrentTenantId, getUserRolesForTenant } = await import('./services/tenant-service.js');
                    const currentTenantId = getCurrentTenantId() || userData.tenantId; // Fallback per retrocompatibilit√†
                    
                    // Ottieni ruoli per il tenant corrente (non tutti i ruoli)
                    let rolesForCurrentTenant = [];
                    if (currentTenantId) {
                        rolesForCurrentTenant = await getUserRolesForTenant(currentTenantId, user.uid);
                    }
                    
                    // Se non ci sono ruoli per il tenant corrente, usa ruoli deprecati come fallback
                    if (rolesForCurrentTenant.length === 0) {
                        rolesForCurrentTenant = userData.ruoli || [];
                    }
                    
                    const normalizedRoles = normalizeRoles(rolesForCurrentTenant);
                    
                    const userDataNormalized = {
                        ...userData,
                        ruoli: normalizedRoles,
                        tenantId: currentTenantId // Usa tenant corrente invece di deprecato
                    };
                    
                    // Aggiorna info utente nell'header
                    document.getElementById('user-info').textContent = 
                        `${userData.nome || ''} ${userData.cognome || ''}`.trim() || user.email;
                    
                    const rolesHTML = normalizedRoles.map(role => 
                        `<span class="role-badge">${roleNames[role] || role}</span>`
                    ).join(' ');
                    document.getElementById('user-roles').innerHTML = rolesHTML || '<span class="role-badge">Nessun ruolo</span>';
                    
                    // Aggiorna ultimo accesso
                    try {
                        await updateDoc(userDocRef, {
                            ultimoAccesso: serverTimestamp(),
                            isOnline: true,
                            lastSeen: serverTimestamp()
                        });
                    } catch (error) {
                        console.warn('Errore aggiornamento ultimo accesso:', error);
                    }
                    
                    // Aggiorna stato online ogni 30 secondi
                    if (window.gfvOnlineInterval) {
                        clearInterval(window.gfvOnlineInterval);
                    }
                    window.gfvOnlineInterval = setInterval(async () => {
                        try {
                            const currentUser = auth.currentUser;
                            if (currentUser) {
                                await updateDoc(doc(db, 'users', currentUser.uid), {
                                    lastSeen: serverTimestamp()
                                });
                            }
                        } catch (error) {
                            console.warn('Errore aggiornamento stato online:', error);
                        }
                    }, 30000);
                    
                    // Carica moduli disponibili dal tenant CORRENTE (non deprecato)
                    let availableModules = [];
                    if (currentTenantId) {
                        try {
                            const tenantDoc = await getDoc(doc(db, 'tenants', currentTenantId));
                            if (tenantDoc.exists()) {
                                const tenantData = tenantDoc.data();
                                availableModules = tenantData.modules || [];
                            }
                        } catch (error) {
                            console.warn('Errore caricamento moduli tenant:', error);
                        }
                    }
                    
                    // La visibilit√† del link "Invita Collaboratore" viene gestita in renderDashboard
                    // in base a se Manodopera √® attivo o no
                    
                    // Gestione switch tenant (multi-tenant)
                    await setupTenantSwitch(user.uid, userDataNormalized);
                    
                    // Renderizza dashboard con moduli
                    await renderDashboard(userDataNormalized, availableModules);
                    // Nutre Tony con contesto dashboard (tenant corrente)
                    if (window.Tony && Tony.isReady()) {
                        Tony.setContext('dashboard', {
                            info_azienda: { moduli_attivi: availableModules },
                            utente_corrente: { nome: `${userDataNormalized.nome || ''} ${userDataNormalized.cognome || ''}`.trim() || (user && user.email) || '', ruoli: userDataNormalized.ruoli || [] },
                            moduli_attivi: availableModules
                        });
                        loadTonyVignetoContext(availableModules);
                    }
                }
            } catch (error) {
                console.error('Errore caricamento dati utente:', error);
                document.getElementById('user-info').textContent = 
                    `Utente: ${user.email}`;
                document.getElementById('user-roles').innerHTML = 
                    '<span class="role-badge">Errore caricamento</span>';
                
                // Renderizza dashboard vuota
                renderDashboard({ ruoli: [] }, []);
            }
        });

        /**
         * Setup switch tenant button (mostra solo se utente ha pi√π tenant)
         */
        async function setupTenantSwitch(userId, userData) {
            try {
                const { getUserTenants } = await import('./services/tenant-service.js');
                const { getCurrentTenantId } = await import('./services/tenant-service.js');
                const tenants = await getUserTenants(userId);
                
                const switchButton = document.getElementById('switch-tenant-button');
                const switchText = document.getElementById('switch-tenant-text');
                
                // Mostra pulsante solo se pi√π di un tenant
                if (tenants.length > 1) {
                    switchButton.style.display = 'inline-flex';
                    
                    // Mostra nome tenant corrente
                    const currentTenantId = getCurrentTenantId();
                    const currentTenant = tenants.find(t => t.tenantId === currentTenantId);
                    if (currentTenant) {
                        // Usa nome tenant se disponibile, altrimenti ID formattato
                        const tenantName = currentTenant.nome || currentTenantId.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                        switchText.textContent = tenantName;
                    }
                    
                    // Event listener per switch tenant
                    switchButton.addEventListener('click', async () => {
                        try {
                            const { showTenantSelector, handleTenantSelection } = await import('./services/tenant-selection-service.js');
                            
                            const selectedTenantId = await showTenantSelector(tenants, async (tenantId) => {
                                try {
                                    await handleTenantSelection(tenantId);
                                    // Ricarica la pagina per aggiornare tutti i dati
                                    window.location.reload();
                                } catch (error) {
                                    console.error('Errore switch tenant:', error);
                                    alert('Errore durante il cambio azienda. Riprova.');
                                }
                            });
                        } catch (error) {
                            console.error('Errore apertura selettore tenant:', error);
                            alert('Errore durante l\'apertura del selettore aziende. Riprova.');
                        }
                    });
                } else {
                    switchButton.style.display = 'none';
                }
            } catch (error) {
                console.warn('Errore setup switch tenant:', error);
                // Nascondi pulsante in caso di errore
                const switchButton = document.getElementById('switch-tenant-button');
                if (switchButton) {
                    switchButton.style.display = 'none';
                }
            }
        }

        // Pulizia listener quando si chiude la pagina
        window.addEventListener('beforeunload', () => {
            if (manutenzioniUnsubscribe) {
                manutenzioniUnsubscribe();
                manutenzioniUnsubscribe = null;
            }
            if (guastiUnsubscribe) {
                guastiUnsubscribe();
                guastiUnsubscribe = null;
            }
        });

        // Logout
        document.getElementById('logout-button').addEventListener('click', async () => {
            try {
                // Ferma l'aggiornamento dello stato online
                if (window.gfvOnlineInterval) {
                    clearInterval(window.gfvOnlineInterval);
                }
                
                // Pulizia listener manutenzioni e guasti
                if (manutenzioniUnsubscribe) {
                    manutenzioniUnsubscribe();
                    manutenzioniUnsubscribe = null;
                }
                if (guastiUnsubscribe) {
                    guastiUnsubscribe();
                    guastiUnsubscribe = null;
                }
                
                // Imposta offline prima del logout
                const user = auth.currentUser;
                if (user) {
                    try {
                        const userDocRef = doc(db, 'users', user.uid);
                        await updateDoc(userDocRef, {
                            isOnline: false
                        });
                    } catch (error) {
                        console.warn('Errore aggiornamento stato offline:', error);
                    }
                }
                
                // Rimuovi anche il flag di sessione
                sessionStorage.removeItem('gfv_expected_user_id');
                sessionStorage.removeItem('gfv_user_just_registered');
                await signOut(auth);
                window.location.href = './auth/login-standalone.html';
            } catch (error) {
                console.error('Errore logout:', error);
                alert('Errore durante il logout');
            }
        });

    </script>
    
    <!-- Service Worker Registration for PWA -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // Usa percorso relativo per compatibilit√† con localhost e GitHub Pages
                const swPath = window.location.pathname.includes('/gfv-platform/') 
                    ? '/gfv-platform/service-worker.js' 
                    : '../service-worker.js';
                navigator.serviceWorker.register(swPath)
                    .catch((error) => {
                        console.error('Registrazione Service Worker fallita:', error);
                    });
            });
        }
    </script>
</body>
</html>
