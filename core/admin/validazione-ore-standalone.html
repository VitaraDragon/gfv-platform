<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Validazione Ore - GFV Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #2E8B57 0%, #228B22 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .btn-primary:hover {
            background: rgba(255,255,255,0.3);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }

        .content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-header h2 {
            color: #2E8B57;
            font-size: 24px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 32px;
            color: #2E8B57;
            margin-bottom: 5px;
        }

        .stat-card p {
            color: #666;
            font-size: 14px;
        }

        .ore-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .ore-table th,
        .ore-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .ore-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        .ore-table tr:hover {
            background: #f8f9fa;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: #2E8B57;
            font-size: 20px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .close-btn:hover {
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
        }

        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            min-height: 100px;
            resize: vertical;
        }

        .form-group textarea:focus {
            outline: none;
            border-color: #2E8B57;
        }

        .ora-details {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .ora-details p {
            margin-bottom: 8px;
        }

        .ora-details strong {
            color: #2E8B57;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-da_validare {
            background: #fff3cd;
            color: #856404;
        }

        .ora-checkbox {
            cursor: pointer;
            width: 18px;
            height: 18px;
        }

        #select-all-checkbox {
            cursor: pointer;
            width: 18px;
            height: 18px;
        }

        #valida-selezionate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        @media (max-width: 768px) {
            .ore-table {
                font-size: 12px;
            }

            .ore-table th,
            .ore-table td {
                padding: 8px;
            }

            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>✅ Validazione Ore</h1>
                <p style="opacity: 0.9; margin-top: 5px;">Valida o rifiuta le ore segnate dagli operai</p>
            </div>
            <div class="header-actions">
                <a href="../dashboard-standalone.html" class="btn btn-secondary">← Dashboard</a>
            </div>
        </div>

        <div class="content">
            <div id="alert-container"></div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="stat-da-validare">0</h3>
                    <p>Ore da validare</p>
                </div>
                <div class="stat-card">
                    <h3 id="stat-validate">0</h3>
                    <p>Ore validate</p>
                </div>
                <div class="stat-card">
                    <h3 id="stat-rifiutate">0</h3>
                    <p>Ore rifiutate</p>
                </div>
            </div>

            <div class="section-header">
                <h2>Ore da Validare</h2>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <button id="valida-selezionate-btn" class="btn btn-success" onclick="validaSelezionate()" style="display: none;">
                        ✅ Valida Selezionate (<span id="count-selezionate">0</span>)
                    </button>
                </div>
            </div>

            <div id="ore-container">
                <div class="loading">Caricamento ore...</div>
            </div>
        </div>
    </div>

    <!-- Modal Rifiuta Ora -->
    <div id="rifiuta-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Rifiuta Ora</h3>
                <button class="close-btn" onclick="closeRifiutaModal()">&times;</button>
            </div>
            <form id="rifiuta-form" onsubmit="handleRifiutaOra(event)">
                <input type="hidden" id="rifiuta-lavoro-id">
                <input type="hidden" id="rifiuta-ora-id">
                
                <div class="ora-details" id="rifiuta-ora-details"></div>
                
                <div class="form-group">
                    <label for="rifiuta-motivo">Motivo Rifiuto *</label>
                    <textarea id="rifiuta-motivo" required placeholder="Spiega il motivo del rifiuto..."></textarea>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-danger" style="flex: 1;">Rifiuta Ora</button>
                    <button type="button" class="btn btn-secondary" onclick="closeRifiutaModal()">Annulla</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Load Firebase config -->
    <script>
        const configScript = document.createElement('script');
        configScript.src = '../config/firebase-config.js';
        configScript.onerror = function() {
            const fallbackScript = document.createElement('script');
            fallbackScript.src = 'https://raw.githubusercontent.com/VitaraDragon/gfv-platform/main/core/config/firebase-config.js';
            document.head.appendChild(fallbackScript);
        };
        document.head.appendChild(configScript);
    </script>
    
    <!-- Firebase SDK -->
    <script type="module">
        // Funzione per attendere il caricamento della configurazione Firebase
        function waitForConfig() {
            return new Promise((resolve, reject) => {
                if (typeof window.firebaseConfig !== 'undefined') {
                    resolve(window.firebaseConfig);
                    return;
                }
                
                let attempts = 0;
                const maxAttempts = 50;
                
                const checkInterval = setInterval(() => {
                    attempts++;
                    if (typeof window.firebaseConfig !== 'undefined') {
                        clearInterval(checkInterval);
                        resolve(window.firebaseConfig);
                    } else if (attempts >= maxAttempts) {
                        clearInterval(checkInterval);
                        reject(new Error('Firebase config not loaded after 5 seconds'));
                    }
                }, 100);
            });
        }

        const firebaseConfig = await waitForConfig();

        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, getDocs, doc, getDoc, query, where, orderBy, onSnapshot, updateDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUserData = null;
        let currentTenantId = null;
        let oreDaValidare = [];
        let operaiMap = new Map();

        // Verifica autenticazione e permessi
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = '../auth/login-standalone.html';
                return;
            }

            try {
                // Carica dati utente
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                if (userDoc.exists()) {
                    currentUserData = userDoc.data();
                    currentTenantId = currentUserData.tenantId;

                    // Verifica permessi (caposquadra O manager/amministratore)
                    const isCaposquadra = currentUserData.ruoli && currentUserData.ruoli.includes('caposquadra');
                    const isManager = currentUserData.ruoli && (currentUserData.ruoli.includes('manager') || currentUserData.ruoli.includes('amministratore'));
                    
                    if (!isCaposquadra && !isManager) {
                        showAlert('Non hai i permessi per accedere a questa pagina', 'error');
                        setTimeout(() => {
                            window.location.href = '../dashboard-standalone.html';
                        }, 2000);
                        return;
                    }

                    // Verifica se modulo Manodopera è attivo
                    let hasManodoperaModule = false;
                    if (currentTenantId) {
                        try {
                            const tenantDoc = await getDoc(doc(db, 'tenants', currentTenantId));
                            if (tenantDoc.exists()) {
                                const tenantData = tenantDoc.data();
                                hasManodoperaModule = tenantData.modules && tenantData.modules.includes('manodopera');
                            }
                        } catch (error) {
                            console.warn('Errore verifica modulo Manodopera:', error);
                        }
                    }

                    if (!hasManodoperaModule) {
                        showAlert('Questa pagina è disponibile solo con il modulo Manodopera attivo.', 'error');
                        setTimeout(() => {
                            window.location.href = '../dashboard-standalone.html';
                        }, 3000);
                        return;
                    }

                    // Carica dati iniziali
                    await loadOperai();
                    await loadOreDaValidare();
                    
                    // Setup listener in tempo reale
                    setupRealtimeListener();
                } else {
                    window.location.href = '../auth/login-standalone.html';
                }
            } catch (error) {
                console.error('Errore:', error);
                showAlert('Errore caricamento dati', 'error');
            }
        });

        // Carica operai per riferimento
        async function loadOperai() {
            try {
                const usersRef = collection(db, 'users');
                const q = query(
                    usersRef,
                    where('tenantId', '==', currentTenantId),
                    where('ruoli', 'array-contains', 'operaio')
                );
                const snapshot = await getDocs(q);
                
                snapshot.forEach(doc => {
                    operaiMap.set(doc.id, { id: doc.id, ...doc.data() });
                });
            } catch (error) {
                console.error('Errore caricamento operai:', error);
            }
        }

        // Carica ore da validare
        async function loadOreDaValidare() {
            const container = document.getElementById('ore-container');
            container.innerHTML = '<div class="loading">Caricamento ore...</div>';

            try {
                const isCaposquadra = currentUserData.ruoli && currentUserData.ruoli.includes('caposquadra');
                const isManager = currentUserData.ruoli && (currentUserData.ruoli.includes('manager') || currentUserData.ruoli.includes('amministratore'));
                const userId = currentUserData.id || currentUserData.uid;
                
                // Carica tutti i lavori (filtriamo in memoria)
                const lavoriRef = collection(db, 'tenants', currentTenantId, 'lavori');
                const lavoriSnapshot = await getDocs(lavoriRef);
                
                oreDaValidare = [];
                
                // Per ogni lavoro, verifica se l'utente può validare le ore
                for (const lavoroDoc of lavoriSnapshot.docs) {
                    const lavoroId = lavoroDoc.id;
                    const lavoroData = lavoroDoc.data();
                    
                    let canValidate = false;
                    
                    if (isCaposquadra) {
                        // CAPOSQUADRA: può validare solo lavori di squadra assegnati a lui
                        if (lavoroData.caposquadraId === userId && !lavoroData.operaioId) {
                            canValidate = true;
                        }
                    } else if (isManager) {
                        // MANAGER: può validare lavori autonomi (operaioId presente, caposquadraId null)
                        if (lavoroData.operaioId && !lavoroData.caposquadraId) {
                            canValidate = true;
                        }
                    }
                    
                    if (!canValidate) {
                        continue; // Salta questo lavoro
                    }
                    
                    // Carica ore da validare per questo lavoro
                    const oreRef = collection(db, 'tenants', currentTenantId, 'lavori', lavoroId, 'oreOperai');
                    const oreQuery = query(oreRef, where('stato', '==', 'da_validare'));
                    const oreSnapshot = await getDocs(oreQuery);
                    
                    oreSnapshot.forEach(oraDoc => {
                        const data = oraDoc.data();
                        // Converti Timestamp in Date
                        if (data.data && data.data.toDate) {
                            data.data = data.data.toDate();
                        }
                        if (data.creatoIl && data.creatoIl.toDate) {
                            data.creatoIl = data.creatoIl.toDate();
                        }
                        oreDaValidare.push({
                            id: oraDoc.id,
                            lavoroId: lavoroId,
                            lavoroNome: lavoroData.nome || 'N/A',
                            tipoLavoro: lavoroData.operaioId ? 'autonomo' : 'squadra', // Flag per distinguere
                            ...data
                        });
                    });
                }
                
                // Ordina per data creazione (più vecchie prima)
                oreDaValidare.sort((a, b) => {
                    const dateA = a.creatoIl instanceof Date ? a.creatoIl : new Date(a.creatoIl);
                    const dateB = b.creatoIl instanceof Date ? b.creatoIl : new Date(b.creatoIl);
                    return dateA - dateB;
                });

                updateStats();
                renderOre();
                // Reset checkbox seleziona tutto e nascondi pulsante
                const selectAllCheckbox = document.getElementById('select-all-checkbox');
                if (selectAllCheckbox) {
                    selectAllCheckbox.checked = false;
                }
                updateValidaSelezionateBtn();
            } catch (error) {
                console.error('Errore caricamento ore:', error);
                container.innerHTML = '<div class="empty-state">Errore caricamento ore</div>';
                showAlert('Errore caricamento ore', 'error');
            }
        }

        // Setup listener in tempo reale
        function setupRealtimeListener() {
            // Ascolta cambiamenti in tutti i lavori (filtriamo in loadOreDaValidare)
            const lavoriRef = collection(db, 'tenants', currentTenantId, 'lavori');
            
            onSnapshot(lavoriRef, async (lavoriSnapshot) => {
                // Ricarica ore quando cambiano i lavori
                await loadOreDaValidare();
            });
        }

        // Aggiorna statistiche
        async function updateStats() {
            // Conta ore da validare
            document.getElementById('stat-da-validare').textContent = oreDaValidare.length;
            
            // Conta ore validate e rifiutate
            let validateCount = 0;
            let rifiutateCount = 0;
            
            const isCaposquadra = currentUserData.ruoli && currentUserData.ruoli.includes('caposquadra');
            const isManager = currentUserData.ruoli && (currentUserData.ruoli.includes('manager') || currentUserData.ruoli.includes('amministratore'));
            const userId = currentUserData.id || currentUserData.uid;
            
            // Carica tutti i lavori (filtriamo in memoria)
            const lavoriRef = collection(db, 'tenants', currentTenantId, 'lavori');
            const lavoriSnapshot = await getDocs(lavoriRef);
            
            for (const lavoroDoc of lavoriSnapshot.docs) {
                const lavoroData = lavoroDoc.data();
                let canValidate = false;
                
                if (isCaposquadra) {
                    // CAPOSQUADRA: solo lavori di squadra assegnati a lui
                    if (lavoroData.caposquadraId === userId && !lavoroData.operaioId) {
                        canValidate = true;
                    }
                } else if (isManager) {
                    // MANAGER: solo lavori autonomi
                    if (lavoroData.operaioId && !lavoroData.caposquadraId) {
                        canValidate = true;
                    }
                }
                
                if (!canValidate) continue;
                
                const lavoroId = lavoroDoc.id;
                const oreRef = collection(db, 'tenants', currentTenantId, 'lavori', lavoroId, 'oreOperai');
                const oreSnapshot = await getDocs(oreRef);
                
                oreSnapshot.forEach(oraDoc => {
                    const stato = oraDoc.data().stato;
                    if (stato === 'validate') {
                        validateCount++;
                    } else if (stato === 'rifiutate') {
                        rifiutateCount++;
                    }
                });
            }
            
            document.getElementById('stat-validate').textContent = validateCount;
            document.getElementById('stat-rifiutate').textContent = rifiutateCount;
        }

        // Renderizza lista ore
        function renderOre() {
            const container = document.getElementById('ore-container');

            if (oreDaValidare.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">✅</div>
                        <p>Nessuna ora da validare</p>
                        <p style="font-size: 14px; margin-top: 10px;">Tutte le ore sono state validate o rifiutate</p>
                    </div>
                `;
                return;
            }

            let html = `
                <table class="ore-table">
                    <thead>
                        <tr>
                            <th style="width: 50px;">
                                <input type="checkbox" id="select-all-checkbox" onchange="toggleSelectAll(this.checked)">
                            </th>
                            <th>Data</th>
                            <th>Operaio</th>
                            <th>Lavoro</th>
                            <th>Orario</th>
                            <th>Ore Nette</th>
                            <th>Note</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            oreDaValidare.forEach(ora => {
                const data = ora.data instanceof Date 
                    ? ora.data.toLocaleDateString('it-IT')
                    : new Date(ora.data).toLocaleDateString('it-IT');
                
                const operaio = operaiMap.get(ora.operaioId);
                const operaioNome = operaio 
                    ? `${operaio.nome || ''} ${operaio.cognome || ''}`.trim() || operaio.email || 'N/A'
                    : 'N/A';
                
                const oreFormattate = formattaOre(ora.oreNette || 0);

                html += `
                    <tr>
                        <td>
                            <input type="checkbox" class="ora-checkbox" data-lavoro-id="${ora.lavoroId}" data-ora-id="${ora.id}" onchange="updateValidaSelezionateBtn()">
                        </td>
                        <td>${data}</td>
                        <td>${escapeHtml(operaioNome)}</td>
                        <td>${escapeHtml(ora.lavoroNome)}</td>
                        <td>${ora.orarioInizio || ''} - ${ora.orarioFine || ''}</td>
                        <td><strong>${oreFormattate}</strong></td>
                        <td>${escapeHtml(ora.note || '-')}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-success btn-sm" onclick="validaOra('${ora.lavoroId}', '${ora.id}')">✅ Valida</button>
                                <button class="btn btn-danger btn-sm" onclick="openRifiutaModal('${ora.lavoroId}', '${ora.id}')">❌ Rifiuta</button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            container.innerHTML = html;
        }

        // Formatta ore
        function formattaOre(oreDecimali) {
            if (!oreDecimali || oreDecimali <= 0) {
                return '0h';
            }
            
            const ore = Math.floor(oreDecimali);
            const minuti = Math.round((oreDecimali - ore) * 60);
            
            if (minuti === 0) {
                return `${ore}h`;
            }
            
            return `${ore}h ${minuti}min`;
        }

        // Aggiorna ore macchina/attrezzo quando viene validata un'ora
        async function aggiornaOreMacchina(oraData) {
            if (!oraData.macchinaId && !oraData.attrezzoId) return; // Nessuna macchina/attrezzo
            
            const oreMacchina = oraData.oreMacchina || oraData.oreNette || 0;
            if (oreMacchina <= 0) return; // Nessuna ora da aggiungere
            
            try {
                // Verifica se modulo Parco Macchine è attivo
                const tenantDoc = await getDoc(doc(db, 'tenants', currentTenantId));
                if (!tenantDoc.exists()) return;
                
                const tenantData = tenantDoc.data();
                const hasParcoMacchineModule = tenantData.modules && tenantData.modules.includes('parcoMacchine');
                if (!hasParcoMacchineModule) return;
                
                // Aggiorna macchina (trattore) se presente
                if (oraData.macchinaId) {
                    const macchinaDoc = await getDoc(doc(db, 'tenants', currentTenantId, 'macchine', oraData.macchinaId));
                    if (macchinaDoc.exists()) {
                        const macchinaData = macchinaDoc.data();
                        const oreAttuali = (macchinaData.oreAttuali || macchinaData.oreIniziali || 0) + oreMacchina;
                        
                        await updateDoc(macchinaDoc.ref, {
                            oreAttuali: oreAttuali
                        });
                        
                        // Verifica se supera oreProssimaManutenzione
                        if (macchinaData.oreProssimaManutenzione && oreAttuali >= macchinaData.oreProssimaManutenzione) {
                            const oreOltre = oreAttuali - macchinaData.oreProssimaManutenzione;
                            console.warn(`⚠️ ATTENZIONE: Macchina "${macchinaData.nome}" ha superato di ${oreOltre.toFixed(1)} ore la manutenzione programmata!`);
                            // Mostra alert visibile all'utente
                            setTimeout(() => {
                                showAlert(`⚠️ ATTENZIONE: La macchina "${macchinaData.nome}" ha superato le ore di manutenzione programmata! Controlla in Gestione Macchine.`, 'error');
                            }, 500);
                        } else if (macchinaData.oreProssimaManutenzione) {
                            const oreRimanenti = macchinaData.oreProssimaManutenzione - oreAttuali;
                            if (oreRimanenti <= 50 && oreRimanenti > 0) {
                                console.info(`ℹ️ INFO: Macchina "${macchinaData.nome}" si avvicina alla manutenzione (${oreRimanenti.toFixed(1)} ore rimanenti)`);
                            }
                        }
                    }
                }
                
                // Aggiorna attrezzo se presente
                if (oraData.attrezzoId) {
                    const attrezzoDoc = await getDoc(doc(db, 'tenants', currentTenantId, 'macchine', oraData.attrezzoId));
                    if (attrezzoDoc.exists()) {
                        const attrezzoData = attrezzoDoc.data();
                        const oreAttuali = (attrezzoData.oreAttuali || attrezzoData.oreIniziali || 0) + oreMacchina;
                        
                        await updateDoc(attrezzoDoc.ref, {
                            oreAttuali: oreAttuali
                        });
                        
                        // Verifica se supera oreProssimaManutenzione
                        if (attrezzoData.oreProssimaManutenzione && oreAttuali >= attrezzoData.oreProssimaManutenzione) {
                            const oreOltre = oreAttuali - attrezzoData.oreProssimaManutenzione;
                            console.warn(`⚠️ ATTENZIONE: Attrezzo "${attrezzoData.nome}" ha superato di ${oreOltre.toFixed(1)} ore la manutenzione programmata!`);
                            // Mostra alert visibile all'utente
                            setTimeout(() => {
                                showAlert(`⚠️ ATTENZIONE: L'attrezzo "${attrezzoData.nome}" ha superato le ore di manutenzione programmata! Controlla in Gestione Macchine.`, 'error');
                            }, 500);
                        } else if (attrezzoData.oreProssimaManutenzione) {
                            const oreRimanenti = attrezzoData.oreProssimaManutenzione - oreAttuali;
                            if (oreRimanenti <= 50 && oreRimanenti > 0) {
                                console.info(`ℹ️ INFO: Attrezzo "${attrezzoData.nome}" si avvicina alla manutenzione (${oreRimanenti.toFixed(1)} ore rimanenti)`);
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Errore aggiornamento ore macchina:', error);
                // Non bloccare la validazione se c'è un errore nell'aggiornamento ore
            }
        }

        // Valida ora
        window.validaOra = async function(lavoroId, oraId) {
            if (!confirm('Sei sicuro di voler validare questa ora?')) {
                return;
            }
            
            try {
                // Verifica che il lavoro esista
                const lavoroDoc = await getDoc(doc(db, 'tenants', currentTenantId, 'lavori', lavoroId));
                if (!lavoroDoc.exists()) {
                    throw new Error('Lavoro non trovato');
                }
                
                const lavoroData = lavoroDoc.data();
                const isCaposquadra = currentUserData.ruoli && currentUserData.ruoli.includes('caposquadra');
                const isManager = currentUserData.ruoli && (currentUserData.ruoli.includes('manager') || currentUserData.ruoli.includes('amministratore'));
                const userId = currentUserData.id || currentUserData.uid;
                
                // Verifica permessi in base al tipo di lavoro
                if (lavoroData.operaioId && !lavoroData.caposquadraId) {
                    // Lavoro autonomo: solo Manager può validare
                    if (!isManager) {
                        throw new Error('Solo Manager può validare ore di lavori autonomi');
                    }
                } else if (lavoroData.caposquadraId && !lavoroData.operaioId) {
                    // Lavoro di squadra: solo caposquadra assegnato può validare
                    if (!isCaposquadra || lavoroData.caposquadraId !== userId) {
                        throw new Error('Non sei il caposquadra assegnato a questo lavoro');
                    }
                } else {
                    throw new Error('Lavoro non valido (deve essere assegnato a caposquadra o operaio)');
                }
                
                // Verifica che l'ora esista e sia in stato "da_validare"
                const oraDoc = await getDoc(doc(db, 'tenants', currentTenantId, 'lavori', lavoroId, 'oreOperai', oraId));
                if (!oraDoc.exists()) {
                    throw new Error('Ora non trovata');
                }
                
                const oraData = oraDoc.data();
                if (oraData.stato !== 'da_validare') {
                    throw new Error('Questa ora è già stata validata o rifiutata');
                }
                
                // Aggiorna stato
                await updateDoc(oraDoc.ref, {
                    stato: 'validate',
                    validatoDa: currentUserData.id,
                    validatoIl: serverTimestamp(),
                    rifiutatoDa: null,
                    motivoRifiuto: null
                });
                
                // Aggiorna ore macchina/attrezzo automaticamente
                await aggiornaOreMacchina(oraData);
                
                showAlert('Ora validata con successo!', 'success');
                await loadOreDaValidare();
            } catch (error) {
                console.error('Errore validazione ora:', error);
                showAlert(`Errore: ${error.message}`, 'error');
            }
        };

        // Apri modal rifiuta
        window.openRifiutaModal = function(lavoroId, oraId) {
            const ora = oreDaValidare.find(o => o.id === oraId && o.lavoroId === lavoroId);
            if (!ora) {
                showAlert('Ora non trovata', 'error');
                return;
            }
            
            const operaio = operaiMap.get(ora.operaioId);
            const operaioNome = operaio 
                ? `${operaio.nome || ''} ${operaio.cognome || ''}`.trim() || operaio.email || 'N/A'
                : 'N/A';
            
            const data = ora.data instanceof Date 
                ? ora.data.toLocaleDateString('it-IT')
                : new Date(ora.data).toLocaleDateString('it-IT');
            
            const oreFormattate = formattaOre(ora.oreNette || 0);
            
            document.getElementById('rifiuta-lavoro-id').value = lavoroId;
            document.getElementById('rifiuta-ora-id').value = oraId;
            document.getElementById('rifiuta-motivo').value = '';
            
            document.getElementById('rifiuta-ora-details').innerHTML = `
                <p><strong>Operaio:</strong> ${escapeHtml(operaioNome)}</p>
                <p><strong>Lavoro:</strong> ${escapeHtml(ora.lavoroNome)}</p>
                <p><strong>Data:</strong> ${data}</p>
                <p><strong>Orario:</strong> ${ora.orarioInizio || ''} - ${ora.orarioFine || ''}</p>
                <p><strong>Ore Nette:</strong> ${oreFormattate}</p>
                ${ora.note ? `<p><strong>Note:</strong> ${escapeHtml(ora.note)}</p>` : ''}
            `;
            
            document.getElementById('rifiuta-modal').classList.add('active');
        };

        // Chiudi modal rifiuta
        window.closeRifiutaModal = function() {
            document.getElementById('rifiuta-modal').classList.remove('active');
        };

        // Gestisci rifiuto ora
        window.handleRifiutaOra = async function(event) {
            event.preventDefault();
            
            const lavoroId = document.getElementById('rifiuta-lavoro-id').value;
            const oraId = document.getElementById('rifiuta-ora-id').value;
            const motivo = document.getElementById('rifiuta-motivo').value.trim();
            
            if (!motivo) {
                showAlert('Inserisci il motivo del rifiuto', 'error');
                return;
            }
            
            try {
                // Verifica che il lavoro esista e sia assegnato al caposquadra
                const lavoroDoc = await getDoc(doc(db, 'tenants', currentTenantId, 'lavori', lavoroId));
                if (!lavoroDoc.exists()) {
                    throw new Error('Lavoro non trovato');
                }
                
                const lavoroData = lavoroDoc.data();
                const isCaposquadra = currentUserData.ruoli && currentUserData.ruoli.includes('caposquadra');
                const isManager = currentUserData.ruoli && (currentUserData.ruoli.includes('manager') || currentUserData.ruoli.includes('amministratore'));
                const userId = currentUserData.id || currentUserData.uid;
                
                // Verifica permessi in base al tipo di lavoro
                if (lavoroData.operaioId && !lavoroData.caposquadraId) {
                    // Lavoro autonomo: solo Manager può rifiutare
                    if (!isManager) {
                        throw new Error('Solo Manager può rifiutare ore di lavori autonomi');
                    }
                } else if (lavoroData.caposquadraId && !lavoroData.operaioId) {
                    // Lavoro di squadra: solo caposquadra assegnato può rifiutare
                    if (!isCaposquadra || lavoroData.caposquadraId !== userId) {
                        throw new Error('Non sei il caposquadra assegnato a questo lavoro');
                    }
                } else {
                    throw new Error('Lavoro non valido (deve essere assegnato a caposquadra o operaio)');
                }
                
                // Verifica che l'ora esista e sia in stato "da_validare"
                const oraDoc = await getDoc(doc(db, 'tenants', currentTenantId, 'lavori', lavoroId, 'oreOperai', oraId));
                if (!oraDoc.exists()) {
                    throw new Error('Ora non trovata');
                }
                
                const oraData = oraDoc.data();
                if (oraData.stato !== 'da_validare') {
                    throw new Error('Questa ora è già stata validata o rifiutata');
                }
                
                // Aggiorna stato
                await updateDoc(oraDoc.ref, {
                    stato: 'rifiutate',
                    rifiutatoDa: currentUserData.id,
                    motivoRifiuto: motivo,
                    validatoDa: null,
                    validatoIl: null
                });
                
                showAlert('Ora rifiutata con successo', 'success');
                closeRifiutaModal();
                await loadOreDaValidare();
            } catch (error) {
                console.error('Errore rifiuto ora:', error);
                showAlert(`Errore: ${error.message}`, 'error');
            }
        };

        // Mostra alert
        function showAlert(message, type = 'info') {
            const container = document.getElementById('alert-container');
            const alertClass = type === 'success' ? 'alert-success' : 'alert-error';
            const alert = document.createElement('div');
            alert.className = `alert ${alertClass}`;
            alert.textContent = message;
            container.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Toggle seleziona tutto
        window.toggleSelectAll = function(checked) {
            const checkboxes = document.querySelectorAll('.ora-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = checked;
            });
            updateValidaSelezionateBtn();
        };

        // Aggiorna pulsante valida selezionate
        window.updateValidaSelezionateBtn = function() {
            const checkboxes = document.querySelectorAll('.ora-checkbox:checked');
            const count = checkboxes.length;
            const btn = document.getElementById('valida-selezionate-btn');
            const countSpan = document.getElementById('count-selezionate');
            
            if (count > 0) {
                btn.style.display = 'inline-block';
                countSpan.textContent = count;
            } else {
                btn.style.display = 'none';
            }
            
            // Aggiorna anche checkbox "seleziona tutto"
            const selectAllCheckbox = document.getElementById('select-all-checkbox');
            const totalCheckboxes = document.querySelectorAll('.ora-checkbox').length;
            if (totalCheckboxes > 0) {
                selectAllCheckbox.checked = count === totalCheckboxes;
            }
        };

        // Valida tutte le ore selezionate
        window.validaSelezionate = async function() {
            const checkboxes = document.querySelectorAll('.ora-checkbox:checked');
            const selectedOre = Array.from(checkboxes).map(cb => ({
                lavoroId: cb.dataset.lavoroId,
                oraId: cb.dataset.oraId
            }));
            
            if (selectedOre.length === 0) {
                showAlert('Seleziona almeno un\'ora da validare', 'error');
                return;
            }
            
            const confirmMessage = `Sei sicuro di voler validare ${selectedOre.length} ${selectedOre.length === 1 ? 'ora' : 'ore'}?`;
            if (!confirm(confirmMessage)) {
                return;
            }
            
            const btn = document.getElementById('valida-selezionate-btn');
            btn.disabled = true;
            btn.textContent = `⏳ Validazione in corso...`;
            
            let successCount = 0;
            let errorCount = 0;
            const errors = [];
            
            try {
                // Valida tutte le ore in parallelo
                const promises = selectedOre.map(async ({ lavoroId, oraId }) => {
                    try {
                        // Verifica che il lavoro esista e sia assegnato al caposquadra
                        const lavoroDoc = await getDoc(doc(db, 'tenants', currentTenantId, 'lavori', lavoroId));
                        if (!lavoroDoc.exists()) {
                            throw new Error('Lavoro non trovato');
                        }
                        
                        const lavoroData = lavoroDoc.data();
                        const isCaposquadra = currentUserData.ruoli && currentUserData.ruoli.includes('caposquadra');
                        const isManager = currentUserData.ruoli && (currentUserData.ruoli.includes('manager') || currentUserData.ruoli.includes('amministratore'));
                        const userId = currentUserData.id || currentUserData.uid;
                        
                        // Verifica permessi in base al tipo di lavoro
                        if (lavoroData.operaioId && !lavoroData.caposquadraId) {
                            // Lavoro autonomo: solo Manager può validare
                            if (!isManager) {
                                throw new Error('Solo Manager può validare ore di lavori autonomi');
                            }
                        } else if (lavoroData.caposquadraId && !lavoroData.operaioId) {
                            // Lavoro di squadra: solo caposquadra assegnato può validare
                            if (!isCaposquadra || lavoroData.caposquadraId !== userId) {
                                throw new Error('Non sei il caposquadra assegnato a questo lavoro');
                            }
                        } else {
                            throw new Error('Lavoro non valido (deve essere assegnato a caposquadra o operaio)');
                        }
                        
                        // Verifica che l'ora esista e sia in stato "da_validare"
                        const oraDoc = await getDoc(doc(db, 'tenants', currentTenantId, 'lavori', lavoroId, 'oreOperai', oraId));
                        if (!oraDoc.exists()) {
                            throw new Error('Ora non trovata');
                        }
                        
                        const oraData = oraDoc.data();
                        if (oraData.stato !== 'da_validare') {
                            throw new Error('Questa ora è già stata validata o rifiutata');
                        }
                        
                        // Aggiorna stato
                        await updateDoc(oraDoc.ref, {
                            stato: 'validate',
                            validatoDa: currentUserData.id,
                            validatoIl: serverTimestamp(),
                            rifiutatoDa: null,
                            motivoRifiuto: null
                        });
                        
                        // Aggiorna ore macchina/attrezzo automaticamente
                        await aggiornaOreMacchina(oraData);
                        
                        successCount++;
                        return { success: true };
                    } catch (error) {
                        errorCount++;
                        errors.push(`Ora ${oraId}: ${error.message}`);
                        return { success: false, error: error.message };
                    }
                });
                
                await Promise.all(promises);
                
                // Mostra risultato
                if (successCount > 0) {
                    showAlert(`✅ ${successCount} ${successCount === 1 ? 'ora validata' : 'ore validate'} con successo!`, 'success');
                }
                
                if (errorCount > 0) {
                    console.error('Errori durante la validazione:', errors);
                    showAlert(`⚠️ ${errorCount} ${errorCount === 1 ? 'ora non validata' : 'ore non validate'}. Controlla la console per i dettagli.`, 'error');
                }
                
                // Ricarica lista ore
                await loadOreDaValidare();
                
            } catch (error) {
                console.error('Errore validazione multipla:', error);
                showAlert(`Errore durante la validazione: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = `✅ Valida Selezionate (<span id="count-selezionate">0</span>)`;
            }
        };
    </script>
</body>
</html>

