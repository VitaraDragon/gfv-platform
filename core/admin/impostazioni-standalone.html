<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Impostazioni - GFV Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #2E8B57 0%, #228B22 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 28px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            display: inline-block;
        }

        .btn-secondary {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.3);
        }

        .content {
            display: grid;
            gap: 20px;
        }

        .card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .card h2 {
            color: #2E8B57;
            margin-bottom: 20px;
            font-size: 20px;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #2E8B57;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .btn-primary {
            background: #2E8B57;
            color: white;
            padding: 12px 24px;
        }

        .btn-primary:hover {
            background: #228B22;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .info-text {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }

        .list-container {
            display: grid;
            gap: 10px;
        }

        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }

        .list-item-name {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-custom {
            background: #ffc107;
            color: #212529;
        }

        .badge-predefinito {
            background: #28a745;
            color: white;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            margin: auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 15px;
        }

        .modal-header h3 {
            color: #2E8B57;
            margin: 0;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-modal:hover {
            color: #333;
        }

        #podere-map-container {
            position: relative;
        }

        .map-marker-info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: white;
            padding: 8px 12px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            font-size: 12px;
            z-index: 1000;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>‚öôÔ∏è Impostazioni</h1>
                <p style="opacity: 0.9; margin-top: 5px;">Configura azienda e account</p>
            </div>
            <a href="../dashboard-standalone.html" class="btn btn-secondary">‚Üê Dashboard</a>
        </div>

        <div class="content">
            <div id="alert-container"></div>

            <!-- Impostazioni Azienda (solo Manager/Amministratore) -->
            <div class="card" id="azienda-section" style="display: none;">
                <h2>Informazioni Azienda</h2>
                <form id="azienda-form" onsubmit="handleSaveAzienda(event)">
                    <div class="form-group">
                        <label for="azienda-nome">Nome Azienda *</label>
                        <input type="text" id="azienda-nome" required placeholder="Es: Vigneto Rossi">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="azienda-piva">Partita IVA</label>
                            <input type="text" id="azienda-piva" placeholder="IT12345678901">
                        </div>
                        <div class="form-group">
                            <label for="azienda-cf">Codice Fiscale</label>
                            <input type="text" id="azienda-cf" placeholder="RSSMRA80A01H501U">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="azienda-indirizzo">Indirizzo</label>
                        <input type="text" id="azienda-indirizzo" placeholder="Via Roma 123">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="azienda-citta">Citt√†</label>
                            <input type="text" id="azienda-citta" placeholder="Milano">
                        </div>
                        <div class="form-group">
                            <label for="azienda-cap">CAP</label>
                            <input type="text" id="azienda-cap" placeholder="20100">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="azienda-provincia">Provincia</label>
                        <input type="text" id="azienda-provincia" placeholder="MI">
                    </div>

                    <div class="form-group">
                        <label for="azienda-telefono">Telefono</label>
                        <input type="tel" id="azienda-telefono" placeholder="+39 02 1234567">
                    </div>

                    <div class="form-group">
                        <label for="azienda-email">Email Aziendale</label>
                        <input type="email" id="azienda-email" placeholder="info@azienda.it">
                    </div>

                    <div class="form-group">
                        <label for="azienda-note">Note</label>
                        <textarea id="azienda-note" placeholder="Note aggiuntive sull'azienda"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="azienda-logo">Logo Aziendale</label>
                        <div style="display: flex; gap: 15px; align-items: flex-start; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 200px;">
                                <input type="file" id="azienda-logo" accept="image/*" onchange="handleLogoUpload(event)" style="margin-bottom: 10px;">
                                <small style="display: block; color: #666; margin-top: 5px;">
                                    Formati supportati: PNG, JPG, SVG (max 2MB). Il logo verr√† usato nei preventivi inviati ai clienti.
                                </small>
                            </div>
                            <div id="logo-preview-container" style="min-width: 150px;">
                                <div id="logo-preview" style="display: none; margin-top: 10px;">
                                    <img id="logo-preview-img" src="" alt="Logo preview" style="max-width: 150px; max-height: 80px; border: 1px solid #ddd; border-radius: 4px; padding: 5px; background: white;">
                                    <button type="button" onclick="rimuoviLogo()" style="display: block; margin-top: 5px; padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">Rimuovi Logo</button>
                                </div>
                                <div id="logo-current" style="display: none; margin-top: 10px;">
                                    <p style="font-size: 12px; color: #666; margin-bottom: 5px;">Logo attuale:</p>
                                    <img id="logo-current-img" src="" alt="Logo attuale" style="max-width: 150px; max-height: 80px; border: 1px solid #ddd; border-radius: 4px; padding: 5px; background: white;">
                                </div>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary">Salva Impostazioni Azienda</button>
                </form>
            </div>

            <!-- Comunicazioni Squadra (solo Caposquadra) -->
            <div class="card" id="comunicazioni-section" style="display: none;">
                <h2>üì¢ Comunicazioni Squadra</h2>
                <p class="info-text" style="margin-bottom: 20px;">Invia comunicazioni di ritrovo alla tua squadra. Gli operai riceveranno la notifica nella loro dashboard.</p>
                
                <form id="comunicazione-form" onsubmit="handleSendComunicazione(event)">
                    <div class="form-group">
                        <label for="comunicazione-lavoro">Seleziona Lavoro (opzionale)</label>
                        <select id="comunicazione-lavoro" onchange="handleLavoroChange()">
                            <option value="">-- Seleziona lavoro per pre-compilare --</option>
                        </select>
                        <div class="info-text" style="margin-top: 5px;">Seleziona un lavoro per pre-compilare automaticamente podere e terreno</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="comunicazione-podere">Podere *</label>
                        <select id="comunicazione-podere" required>
                            <option value="">-- Seleziona podere --</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="comunicazione-terreno">Campo/Terreno *</label>
                        <select id="comunicazione-terreno" required>
                            <option value="">-- Seleziona terreno --</option>
                        </select>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="comunicazione-data">Data Ritrovo *</label>
                            <input type="date" id="comunicazione-data" required>
                        </div>
                        <div class="form-group">
                            <label for="comunicazione-orario">Orario Ritrovo *</label>
                            <input type="time" id="comunicazione-orario" required value="07:00">
                            <div class="info-text">Orario di default: 7:00</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="comunicazione-note">Note Aggiuntive</label>
                        <textarea id="comunicazione-note" placeholder="Eventuali note o istruzioni particolari per la squadra..." rows="3"></textarea>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">üì§ Invia alla Squadra</button>
                </form>
                
                <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e9ecef;">
                    <h3 style="color: #2E8B57; font-size: 18px; margin-bottom: 15px;">Comunicazioni Inviate</h3>
                    <div id="comunicazioni-list" class="list-container">
                        <!-- Lista verr√† popolata dinamicamente -->
                    </div>
                </div>
            </div>

            <!-- Impostazioni Account (tutti i ruoli) -->
            <div class="card" id="account-section">
                <h2>Impostazioni Account Personale</h2>
                <form id="account-form" onsubmit="handleSaveAccount(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="account-nome">Nome *</label>
                            <input type="text" id="account-nome" required>
                        </div>
                        <div class="form-group">
                            <label for="account-cognome">Cognome *</label>
                            <input type="text" id="account-cognome" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="account-email">Email</label>
                        <input type="email" id="account-email" readonly>
                        <div class="info-text">L'email non pu√≤ essere modificata</div>
                    </div>

                    <div class="form-group">
                        <label for="account-telefono">Telefono</label>
                        <input type="tel" id="account-telefono" placeholder="+39 333 1234567">
                    </div>

                    <button type="submit" class="btn btn-primary">Salva Impostazioni Account</button>
                </form>
            </div>

            <!-- Cambio Password (tutti i ruoli) -->
            <div class="card" id="password-section">
                <h2>Cambio Password</h2>
                <form id="password-form" onsubmit="handleChangePassword(event)">
                    <div class="form-group">
                        <label for="password-current">Password Attuale *</label>
                        <input type="password" id="password-current" required>
                    </div>

                    <div class="form-group">
                        <label for="password-new">Nuova Password *</label>
                        <input type="password" id="password-new" required minlength="6">
                        <div class="info-text">Minimo 6 caratteri</div>
                    </div>

                    <div class="form-group">
                        <label for="password-confirm">Conferma Nuova Password *</label>
                        <input type="password" id="password-confirm" required minlength="6">
                    </div>

                    <button type="submit" class="btn btn-primary">Cambia Password</button>
                </form>
            </div>

            <!-- Gestione Poderi (solo Manager/Amministratore) -->
            <div class="card" id="poderi-section" style="display: none;">
                <h2>üè° Gestione Poderi</h2>
                <p class="info-text" style="margin-bottom: 20px;">Gestisci i poderi dell'azienda. I poderi possono essere assegnati ai terreni e utilizzati per filtri e report.</p>
                
                <div class="form-group" style="margin-bottom: 20px;">
                    <button type="button" class="btn btn-primary" onclick="openPodereModal()">‚ûï Aggiungi Podere</button>
                </div>

                <div id="poderi-list" class="list-container">
                    <!-- Lista verr√† popolata dinamicamente -->
                </div>
            </div>

            <!-- Liste Personalizzate (solo Manager/Amministratore) -->
            <div class="card" id="liste-section" style="display: none;">
                <h2>üìã Liste Personalizzate</h2>
                <p class="info-text" style="margin-bottom: 20px;">Gestisci tipi lavoro e colture personalizzate. Gli elementi predefiniti non possono essere eliminati.</p>
                
                <!-- Tipi Lavoro -->
                <div style="margin-bottom: 40px;">
                    <h3 style="color: #2E8B57; font-size: 18px; margin-bottom: 15px; border-bottom: 1px solid #e9ecef; padding-bottom: 8px;">Tipi Lavoro</h3>
                    
                    <div class="form-group" style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <input type="text" id="new-tipo-lavoro" placeholder="Aggiungi nuovo tipo lavoro..." style="flex: 1;">
                        <button type="button" class="btn btn-primary" onclick="addTipoLavoro()">‚ûï Aggiungi</button>
                    </div>

                    <div id="tipi-lavoro-list" class="list-container">
                        <!-- Lista verr√† popolata dinamicamente -->
                    </div>
                </div>

                <!-- Colture -->
                <div>
                    <h3 style="color: #2E8B57; font-size: 18px; margin-bottom: 15px; border-bottom: 1px solid #e9ecef; padding-bottom: 8px;">Colture</h3>
                    
                    <div class="form-group" style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <input type="text" id="new-coltura" placeholder="Aggiungi nuova coltura..." style="flex: 1;">
                        <button type="button" class="btn btn-primary" onclick="addColtura()">‚ûï Aggiungi</button>
                    </div>

                    <div id="colture-list" class="list-container">
                        <!-- Lista verr√† popolata dinamicamente -->
                    </div>
                </div>
            </div>

            <!-- Tariffe Operai (solo Manager/Amministratore) -->
            <div class="card" id="tariffe-section" style="display: none;">
                <h2>üí∞ Tariffe Operai</h2>
                <p class="info-text" style="margin-bottom: 20px;">Configura le tariffe orarie di default per ogni tipo operaio. Queste tariffe verranno utilizzate per il calcolo compensi. Puoi anche impostare tariffe personalizzate per singoli operai nella pagina Gestione Operai.</p>
                
                <div id="tariffe-list" class="list-container">
                    <!-- Lista verr√† popolata dinamicamente -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Podere -->
    <div id="podere-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="podere-modal-title">Aggiungi Podere</h3>
                <button class="close-modal" onclick="closePodereModal()">&times;</button>
            </div>
            <form id="podere-form" onsubmit="handleSavePodere(event)">
                <div class="form-group">
                    <label for="podere-nome">Nome Podere *</label>
                    <input type="text" id="podere-nome" required placeholder="Es. Podere San Giovanni">
                </div>
                <div class="form-group">
                    <label for="podere-indirizzo">Indirizzo</label>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <input type="text" id="podere-indirizzo" placeholder="Via Roma 123, Citt√†" style="flex: 1;">
                        <button type="button" class="btn btn-primary" onclick="searchPodereAddress()" style="white-space: nowrap;">üîç Cerca</button>
                    </div>
                    <div id="podere-map-container" style="height: 300px; width: 100%; border: 1px solid #ced4da; border-radius: 6px; margin-top: 10px; display: none; position: relative;">
                        <div id="podere-map" style="height: 100%; width: 100%;"></div>
                        <div id="podere-map-actions" style="position: absolute; top: 10px; right: 10px; display: none;">
                            <button type="button" class="btn btn-primary" onclick="openDirections()" style="font-size: 12px; padding: 6px 12px; white-space: nowrap;">üó∫Ô∏è Indicazioni</button>
                        </div>
                    </div>
                    <small style="display: block; margin-top: 5px;">Cerca l'indirizzo per posizionare il marker sulla mappa. Puoi anche cliccare sulla mappa per posizionare il marker manualmente.</small>
                </div>
                <div class="form-group">
                    <label for="podere-note">Note</label>
                    <textarea id="podere-note" placeholder="Note aggiuntive sul podere..."></textarea>
                </div>
                <div class="form-group" style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Salva</button>
                    <button type="button" class="btn btn-secondary" onclick="closePodereModal()">Annulla</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Load Firebase config from external file -->
    <!-- Fallback: usa raw GitHub se il file locale non √® disponibile (per GitHub Pages) -->
    <script>
        const configScript = document.createElement('script');
        configScript.src = '../config/firebase-config.js';
        configScript.onerror = function() {
            const fallbackScript = document.createElement('script');
            fallbackScript.src = 'https://raw.githubusercontent.com/VitaraDragon/gfv-platform/main/core/config/firebase-config.js';
            document.head.appendChild(fallbackScript);
        };
        document.head.appendChild(configScript);
    </script>
    
    <!-- Load Google Maps config -->
    <script>
        const mapsConfigScript = document.createElement('script');
        mapsConfigScript.src = '../config/google-maps-config.js';
        mapsConfigScript.onerror = function() {
            const fallbackScript = document.createElement('script');
            fallbackScript.src = 'https://raw.githubusercontent.com/VitaraDragon/gfv-platform/main/core/config/google-maps-config.js';
            document.head.appendChild(fallbackScript);
        };
        document.head.appendChild(mapsConfigScript);
    </script>
    
    <!-- Firebase SDK -->
    <script type="module">
        // Funzione per attendere il caricamento della configurazione Firebase
        function waitForConfig() {
            return new Promise((resolve, reject) => {
                if (typeof window.firebaseConfig !== 'undefined') {
                    resolve(window.firebaseConfig);
                    return;
                }
                
                let attempts = 0;
                const maxAttempts = 50;
                
                const checkInterval = setInterval(() => {
                    attempts++;
                    if (typeof window.firebaseConfig !== 'undefined') {
                        clearInterval(checkInterval);
                        resolve(window.firebaseConfig);
                    } else if (attempts >= maxAttempts) {
                        clearInterval(checkInterval);
                        reject(new Error('Firebase config not loaded after 5 seconds'));
                    }
                }, 100);
            });
        }

        const firebaseConfig = await waitForConfig();
        
        // Attendi Google Maps config e carica API
        function waitForMapsConfig() {
            return new Promise((resolve, reject) => {
                if (typeof window.GOOGLE_MAPS_API_KEY !== 'undefined') {
                    resolve(window.GOOGLE_MAPS_API_KEY);
                    return;
                }
                
                let attempts = 0;
                const maxAttempts = 50;
                
                const checkInterval = setInterval(() => {
                    attempts++;
                    if (typeof window.GOOGLE_MAPS_API_KEY !== 'undefined') {
                        clearInterval(checkInterval);
                        resolve(window.GOOGLE_MAPS_API_KEY);
                    } else if (attempts >= maxAttempts) {
                        clearInterval(checkInterval);
                        resolve(null); // Non fallire, solo non caricare Maps
                    }
                }, 100);
            });
        }
        
        // Carica Google Maps API se disponibile
        try {
            GOOGLE_MAPS_API_KEY = await waitForMapsConfig();
            
            if (GOOGLE_MAPS_API_KEY && GOOGLE_MAPS_API_KEY !== 'YOUR_GOOGLE_MAPS_API_KEY_HERE') {
                const script = document.createElement('script');
                script.async = true;
                script.defer = true;
                script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&libraries=geometry&loading=async&callback=initGoogleMapsPodere`;
                document.head.appendChild(script);
                
                window.initGoogleMapsPodere = function() {
                    console.log('‚úÖ Google Maps initialized for poderi');
                    window.googleMapsReadyPodere = true;
                };
            } else {
                console.warn('Google Maps API key non disponibile');
                window.googleMapsReadyPodere = false;
            }
        } catch (e) {
            console.warn('Google Maps config non disponibile:', e);
            window.googleMapsReadyPodere = false;
        }

        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, updatePassword, reauthenticateWithCredential, EmailAuthProvider } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, getDoc, updateDoc, setDoc, serverTimestamp, query, collection, where, getDocs, addDoc, deleteDoc, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        let currentUserData = null;
        let currentTenantId = null;
        let currentPodereId = null;
        let poderiList = [];
        let podereMap = null;
        let podereMarker = null;
        let logoFileToUpload = null;
        
        // Liste predefinite
        const TIPI_LAVORO_PREDEFINITI = [
            'Potatura', 'Raccolta', 'Trattamento', 'Semina', 'Aratura',
            'Irrigazione', 'Concimazione', 'Diserbo', 'Raccolta frutta', 'Raccolta verdura'
        ];
        const COLTURE_PREDEFINITE = [
            'Vite', 'Frutteto', 'Seminativo', 'Orto', 'Prato', 'Olivo', 'Agrumeto', 'Bosco'
        ];

        // Carica dati utente
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = '../auth/login-standalone.html';
                return;
            }

            try {
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                if (userDoc.exists()) {
                    currentUserData = userDoc.data();
                    
                    // Pre-compila form account
                    document.getElementById('account-nome').value = currentUserData.nome || '';
                    document.getElementById('account-cognome').value = currentUserData.cognome || '';
                    document.getElementById('account-email').value = currentUserData.email || user.email;
                    document.getElementById('account-telefono').value = currentUserData.telefono || '';

                    // Salva tenant ID
                    currentTenantId = currentUserData.tenantId;
                    
                    // Controlla ruoli e mostra/nascondi sezioni
                    const ruoli = currentUserData.ruoli || [];
                    const isManager = ruoli.includes('manager') || ruoli.includes('amministratore');
                    const isCaposquadra = ruoli.includes('caposquadra');
                    
                    // Mostra/nascondi sezioni in base al ruolo
                    if (isManager) {
                        // Manager/Amministratore: mostra tutto
                        document.getElementById('azienda-section').style.display = 'block';
                        document.getElementById('poderi-section').style.display = 'block';
                        document.getElementById('liste-section').style.display = 'block';
                        document.getElementById('tariffe-section').style.display = 'block';
                        
                        // Carica dati azienda
                        if (currentTenantId) {
                            const tenantDoc = await getDoc(doc(db, 'tenants', currentTenantId));
                            if (tenantDoc.exists()) {
                                const tenantData = tenantDoc.data();
                                document.getElementById('azienda-nome').value = tenantData.nome || '';
                                document.getElementById('azienda-piva').value = tenantData.piva || '';
                                document.getElementById('azienda-cf').value = tenantData.cf || '';
                                document.getElementById('azienda-indirizzo').value = tenantData.indirizzo || '';
                                document.getElementById('azienda-citta').value = tenantData.citta || '';
                                document.getElementById('azienda-cap').value = tenantData.cap || '';
                                document.getElementById('azienda-provincia').value = tenantData.provincia || '';
                                document.getElementById('azienda-telefono').value = tenantData.telefono || '';
                                document.getElementById('azienda-email').value = tenantData.email || '';
                                document.getElementById('azienda-note').value = tenantData.note || '';
                                
                                // Carica logo esistente se presente
                                if (tenantData.logoUrl) {
                                    document.getElementById('logo-current-img').src = tenantData.logoUrl;
                                    document.getElementById('logo-current').style.display = 'block';
                                }
                            }
                            
                            // Carica liste personalizzate, poderi e tariffe
                            await loadListe();
                            await loadPoderi();
                            await loadTariffe();
                        }
                    } else {
                        // Nascondi sezioni azienda per non-manager
                        document.getElementById('azienda-section').style.display = 'none';
                        document.getElementById('poderi-section').style.display = 'none';
                        document.getElementById('liste-section').style.display = 'none';
                        document.getElementById('tariffe-section').style.display = 'none';
                    }
                    
                    if (isCaposquadra) {
                        // Caposquadra: mostra sezione comunicazioni
                        document.getElementById('comunicazioni-section').style.display = 'block';
                        
                        // Carica poderi, terreni e lavori per dropdown comunicazioni
                        if (currentTenantId) {
                            await loadPoderiForComunicazioni();
                            await loadTerreniForComunicazioni();
                            await loadLavoriAttiviForComunicazioni();
                            await loadComunicazioniInviate();
                            
                            // Pre-compila con il primo lavoro attivo se disponibile
                            await precompilaDaPrimoLavoro();
                        }
                    } else {
                        document.getElementById('comunicazioni-section').style.display = 'none';
                    }
                    
                    // Account e Password sempre visibili per tutti
                    document.getElementById('account-section').style.display = 'block';
                    document.getElementById('password-section').style.display = 'block';
                }
            } catch (error) {
                console.error('Errore caricamento dati:', error);
                showAlert('Errore caricamento dati', 'error');
            }
        });

        // Gestisce upload logo
        window.handleLogoUpload = async function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Verifica se l'app √® aperta con file:// (problema CORS)
            if (window.location.protocol === 'file:') {
                showAlert('‚ö†Ô∏è L\'app √® aperta con file://. Per caricare il logo, apri l\'app da un server HTTP (es. GitHub Pages o server locale).', 'error');
                event.target.value = '';
                return;
            }
            
            // Validazione file
            const maxSize = 2 * 1024 * 1024; // 2MB
            if (file.size > maxSize) {
                showAlert('Il file √® troppo grande. Dimensione massima: 2MB', 'error');
                event.target.value = '';
                return;
            }
            
            const validTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/svg+xml'];
            if (!validTypes.includes(file.type)) {
                showAlert('Formato file non supportato. Usa PNG, JPG o SVG', 'error');
                event.target.value = '';
                return;
            }
            
            // Mostra preview
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('logo-preview-img').src = e.target.result;
                document.getElementById('logo-preview').style.display = 'block';
                document.getElementById('logo-current').style.display = 'none';
            };
            reader.readAsDataURL(file);
            
            // Salva file per upload successivo
            logoFileToUpload = file;
        };
        
        // Rimuove logo
        window.rimuoviLogo = async function() {
            if (!currentTenantId) return;
            
            try {
                // Verifica autenticazione
                const user = auth.currentUser;
                if (!user) {
                    showAlert('Utente non autenticato. Effettua il login.', 'error');
                    return;
                }
                
                const tenantRef = doc(db, 'tenants', currentTenantId);
                const tenantSnap = await getDoc(tenantRef);
                
                if (tenantSnap.exists()) {
                    const tenantData = tenantSnap.data();
                    
                    // Elimina logo da Storage se presente
                    if (tenantData.logoUrl) {
                        try {
                            // Estrai percorso dal URL completo
                            const urlParts = tenantData.logoUrl.split('/o/');
                            if (urlParts.length > 1) {
                                const pathPart = urlParts[1].split('?')[0];
                                const decodedPath = decodeURIComponent(pathPart);
                                const logoRef = ref(storage, decodedPath);
                                await deleteObject(logoRef);
                                console.log('üóëÔ∏è Logo eliminato da Storage');
                            }
                        } catch (storageError) {
                            console.warn('‚ö†Ô∏è Errore eliminazione logo da Storage (non critico):', storageError);
                            // Continua comunque
                        }
                    }
                    
                    // Rimuovi URL logo dal tenant
                    await updateDoc(tenantRef, {
                        logoUrl: null,
                        aggiornatoIl: serverTimestamp()
                    });
                    
                    // Aggiorna UI
                    document.getElementById('logo-preview').style.display = 'none';
                    document.getElementById('logo-current').style.display = 'none';
                    document.getElementById('azienda-logo').value = '';
                    logoFileToUpload = null;
                    
                    showAlert('Logo rimosso con successo', 'success');
                }
            } catch (error) {
                console.error('Errore rimozione logo:', error);
                showAlert('Errore durante la rimozione del logo: ' + error.message, 'error');
            }
        };

        // Salva impostazioni azienda
        async function handleSaveAzienda(e) {
            e.preventDefault();
            
            if (!currentUserData || !currentUserData.tenantId) {
                showAlert('Tenant non trovato', 'error');
                return;
            }

            try {
                const tenantRef = doc(db, 'tenants', currentUserData.tenantId);
                const tenantSnap = await getDoc(tenantRef);
                
                let logoUrl = null;
                
                // Upload logo se presente
                if (logoFileToUpload) {
                    try {
                        // Verifica autenticazione
                        const user = auth.currentUser;
                        if (!user) {
                            throw new Error('Utente non autenticato. Effettua il login.');
                        }
                        
                        // Normalizza tenantId per percorso Storage (rimuovi spazi e caratteri speciali)
                        const normalizedTenantId = currentUserData.tenantId
                            .replace(/[^a-zA-Z0-9_-]/g, '_')
                            .replace(/_+/g, '_')
                            .replace(/^_|_$/g, '');
                        
                        // Estrai estensione file
                        const fileExtension = logoFileToUpload.name.split('.').pop().toLowerCase();
                        const logoFileName = `tenants/${normalizedTenantId}/logo_${Date.now()}.${fileExtension}`;
                        
                        console.log('üì§ Upload logo:', {
                            tenantId: currentUserData.tenantId,
                            normalizedTenantId: normalizedTenantId,
                            fileName: logoFileName,
                            fileSize: logoFileToUpload.size,
                            fileType: logoFileToUpload.type
                        });
                        
                        const logoStorageRef = ref(storage, logoFileName);
                        
                        // Elimina logo vecchio se presente
                        if (tenantSnap.exists()) {
                            const oldTenantData = tenantSnap.data();
                            if (oldTenantData.logoUrl) {
                                try {
                                    // Estrai percorso dal URL completo
                                    const urlParts = oldTenantData.logoUrl.split('/o/');
                                    if (urlParts.length > 1) {
                                        const pathPart = urlParts[1].split('?')[0];
                                        const decodedPath = decodeURIComponent(pathPart);
                                        const oldLogoRef = ref(storage, decodedPath);
                                        await deleteObject(oldLogoRef);
                                        console.log('üóëÔ∏è Logo vecchio eliminato');
                                    }
                                } catch (deleteError) {
                                    console.warn('‚ö†Ô∏è Errore eliminazione logo vecchio (non critico):', deleteError);
                                    // Continua comunque
                                }
                            }
                        }
                        
                        // Upload nuovo logo con metadata
                        const metadata = {
                            contentType: logoFileToUpload.type,
                            customMetadata: {
                                uploadedBy: user.uid,
                                tenantId: normalizedTenantId,
                                uploadedAt: new Date().toISOString()
                            }
                        };
                        
                        await uploadBytes(logoStorageRef, logoFileToUpload, metadata);
                        logoUrl = await getDownloadURL(logoStorageRef);
                        
                        console.log('‚úÖ Logo caricato con successo:', logoUrl);
                    } catch (uploadError) {
                        console.error('‚ùå Errore upload logo:', uploadError);
                        
                        let errorMessage = 'Errore durante il caricamento del logo';
                        const errorCode = uploadError.code || '';
                        const errorMsg = uploadError.message || '';
                        
                        if (window.location.protocol === 'file:') {
                            errorMessage = '‚ö†Ô∏è ERRORE CORS: L\'app √® aperta con file://. Per caricare il logo:\n\n' +
                                         '1. Apri l\'app da GitHub Pages: https://vitaradragon.github.io/gfv-platform/\n' +
                                         '2. Oppure usa un server locale (es. Live Server in VS Code)\n\n' +
                                         'Firebase Storage richiede un\'origine HTTP valida.';
                        } else if (errorMsg.includes('CORS') || errorMsg.includes('origin') || errorMsg.includes('preflight')) {
                            errorMessage = '‚ö†Ô∏è ERRORE CORS: Configurazione CORS mancante sul bucket Storage.\n\n' +
                                         'SOLUZIONE:\n' +
                                         '1. Vai su Firebase Console ‚Üí Storage ‚Üí Settings\n' +
                                         '2. Copia il nome del bucket (es: gfv-platform.firebasestorage.app)\n' +
                                         '3. Segui le istruzioni in CONFIGURA_CORS_STORAGE.md\n' +
                                         '4. Oppure usa: gsutil cors set cors.json gs://[BUCKET_NAME]\n\n' +
                                         'Vedi il file CONFIGURA_CORS_STORAGE.md per istruzioni dettagliate.';
                        } else if (errorCode.includes('unauthorized') || errorMsg.includes('permission') || errorCode === 'storage/unauthorized') {
                            errorMessage = '‚ùå Errore permessi Storage. Verifica:\n\n' +
                                         '1. Le regole Storage sono deployate: firebase deploy --only storage\n' +
                                         '2. Sei autenticato correttamente\n' +
                                         '3. Il tuo tenantId √® corretto';
                        } else if (errorCode.includes('network') || errorCode === 'storage/network-request-failed' || errorMsg.includes('network')) {
                            errorMessage = 'üåê Errore di rete. Verifica:\n\n' +
                                         '1. La connessione internet\n' +
                                         '2. Che Firebase Storage sia abilitato nel progetto Firebase Console';
                        } else if (errorCode === 'storage/bucket-not-found' || errorMsg.includes('bucket')) {
                            errorMessage = '‚ùå Bucket Storage non trovato. Verifica:\n\n' +
                                         '1. Storage √® abilitato in Firebase Console ‚Üí Storage\n' +
                                         '2. Il nome bucket in firebase-config.js √® corretto';
                        } else {
                            errorMessage = `Errore: ${errorMsg || errorCode || 'Errore sconosciuto durante l\'upload'}\n\n` +
                                         `Codice: ${errorCode || 'N/A'}\n` +
                                         `Messaggio: ${errorMsg || 'N/A'}`;
                        }
                        
                        showAlert(errorMessage, 'error');
                        return;
                    }
                } else if (tenantSnap.exists()) {
                    // Mantieni logo esistente se non c'√® nuovo upload
                    const existingData = tenantSnap.data();
                    logoUrl = existingData.logoUrl || null;
                }
                
                const tenantData = {
                    nome: document.getElementById('azienda-nome').value,
                    piva: document.getElementById('azienda-piva').value,
                    cf: document.getElementById('azienda-cf').value,
                    indirizzo: document.getElementById('azienda-indirizzo').value,
                    citta: document.getElementById('azienda-citta').value,
                    cap: document.getElementById('azienda-cap').value,
                    provincia: document.getElementById('azienda-provincia').value,
                    telefono: document.getElementById('azienda-telefono').value,
                    email: document.getElementById('azienda-email').value,
                    note: document.getElementById('azienda-note').value,
                    aggiornatoIl: serverTimestamp()
                };
                
                // Aggiungi logoUrl se presente
                if (logoUrl !== null) {
                    tenantData.logoUrl = logoUrl;
                }

                // Se il documento esiste, aggiorna; altrimenti crea
                if (tenantSnap.exists()) {
                    await updateDoc(tenantRef, tenantData);
                } else {
                    // Crea nuovo documento tenant
                    tenantData.creatoIl = serverTimestamp();
                    await setDoc(tenantRef, tenantData);
                }
                
                // Aggiorna preview logo
                if (logoUrl) {
                    document.getElementById('logo-current-img').src = logoUrl;
                    document.getElementById('logo-current').style.display = 'block';
                    document.getElementById('logo-preview').style.display = 'none';
                }
                
                // Reset upload
                logoFileToUpload = null;
                document.getElementById('azienda-logo').value = '';
                
                showAlert('Impostazioni azienda salvate con successo', 'success');
            } catch (error) {
                console.error('Errore salvataggio azienda:', error);
                showAlert('Errore durante il salvataggio: ' + error.message, 'error');
            }
        }

        // Salva impostazioni account
        async function handleSaveAccount(e) {
            e.preventDefault();
            
            const user = auth.currentUser;
            if (!user) return;

            try {
                const accountData = {
                    nome: document.getElementById('account-nome').value,
                    cognome: document.getElementById('account-cognome').value,
                    telefono: document.getElementById('account-telefono').value
                };

                await updateDoc(doc(db, 'users', user.uid), accountData);
                showAlert('Impostazioni account salvate con successo', 'success');
            } catch (error) {
                console.error('Errore salvataggio account:', error);
                showAlert('Errore durante il salvataggio: ' + error.message, 'error');
            }
        }

        // Cambia password
        async function handleChangePassword(e) {
            e.preventDefault();
            
            const user = auth.currentUser;
            if (!user) return;

            const currentPassword = document.getElementById('password-current').value;
            const newPassword = document.getElementById('password-new').value;
            const confirmPassword = document.getElementById('password-confirm').value;

            if (newPassword !== confirmPassword) {
                showAlert('Le password non corrispondono', 'error');
                return;
            }

            if (newPassword.length < 6) {
                showAlert('La password deve essere almeno 6 caratteri', 'error');
                return;
            }

            try {
                // Ri-autentica utente
                const credential = EmailAuthProvider.credential(user.email, currentPassword);
                await reauthenticateWithCredential(user, credential);

                // Aggiorna password
                await updatePassword(user, newPassword);
                
                showAlert('Password cambiata con successo', 'success');
                document.getElementById('password-form').reset();
            } catch (error) {
                console.error('Errore cambio password:', error);
                let errorMsg = 'Errore durante il cambio password';
                if (error.code === 'auth/wrong-password') {
                    errorMsg = 'Password attuale errata';
                } else if (error.code === 'auth/weak-password') {
                    errorMsg = 'La nuova password √® troppo debole';
                }
                showAlert(errorMsg, 'error');
            }
        }

        // Utility: mostra alert
        function showAlert(message, type = 'success') {
            const container = document.getElementById('alert-container');
            const alertClass = type === 'success' ? 'alert-success' : 'alert-info';
            container.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
            
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        // ========== Liste Personalizzate ==========
        
        // Carica liste personalizzate
        async function loadListe() {
            if (!currentTenantId) return;
            
            try {
                const listeRef = doc(db, `tenants/${currentTenantId}/liste`, 'personalizzate');
                const listeSnap = await getDoc(listeRef);
                
                let tipiLavoro = [...TIPI_LAVORO_PREDEFINITI];
                let colture = [...COLTURE_PREDEFINITE];
                
                if (listeSnap.exists()) {
                    const data = listeSnap.data();
                    tipiLavoro = data.tipiLavoro || tipiLavoro;
                    colture = data.colture || colture;
                }
                
                renderTipiLavoro(tipiLavoro);
                renderColture(colture);
            } catch (error) {
                console.error('Errore caricamento liste:', error);
                showAlert('Errore caricamento liste personalizzate', 'error');
            }
        }
        
        // Render tipi lavoro
        function renderTipiLavoro(tipiLavoro) {
            const container = document.getElementById('tipi-lavoro-list');
            container.innerHTML = tipiLavoro.map(tipo => {
                const isPredefinito = TIPI_LAVORO_PREDEFINITI.some(p => p.toLowerCase() === tipo.toLowerCase());
                return `
                    <div class="list-item">
                        <div class="list-item-name">
                            <span>${escapeHtml(tipo)}</span>
                            <span class="badge ${isPredefinito ? 'badge-predefinito' : 'badge-custom'}">
                                ${isPredefinito ? 'Predefinito' : 'Custom'}
                            </span>
                        </div>
                        ${!isPredefinito ? `
                            <button class="btn btn-danger btn-small" onclick="removeTipoLavoro('${escapeHtml(tipo)}')" title="Elimina">
                                üóëÔ∏è Elimina
                            </button>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }
        
        // Render colture
        function renderColture(colture) {
            const container = document.getElementById('colture-list');
            container.innerHTML = colture.map(coltura => {
                const isPredefinita = COLTURE_PREDEFINITE.some(p => p.toLowerCase() === coltura.toLowerCase());
                return `
                    <div class="list-item">
                        <div class="list-item-name">
                            <span>${escapeHtml(coltura)}</span>
                            <span class="badge ${isPredefinita ? 'badge-predefinito' : 'badge-custom'}">
                                ${isPredefinita ? 'Predefinito' : 'Custom'}
                            </span>
                        </div>
                        ${!isPredefinita ? `
                            <button class="btn btn-danger btn-small" onclick="removeColtura('${escapeHtml(coltura)}')" title="Elimina">
                                üóëÔ∏è Elimina
                            </button>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }
        
        // Aggiungi tipo lavoro
        async function addTipoLavoro() {
            const input = document.getElementById('new-tipo-lavoro');
            const nome = input.value.trim();
            
            if (!nome) {
                showAlert('Inserisci un nome per il tipo lavoro', 'error');
                return;
            }
            
            if (!currentTenantId) {
                showAlert('Tenant ID non disponibile', 'error');
                return;
            }
            
            try {
                // Carica liste esistenti
                const listeRef = doc(db, `tenants/${currentTenantId}/liste`, 'personalizzate');
                const listeSnap = await getDoc(listeRef);
                
                let tipiLavoro = [...TIPI_LAVORO_PREDEFINITI];
                if (listeSnap.exists()) {
                    const data = listeSnap.data();
                    tipiLavoro = data.tipiLavoro || tipiLavoro;
                }
                
                // Verifica duplicati (case-insensitive)
                if (tipiLavoro.some(t => t.toLowerCase() === nome.toLowerCase())) {
                    showAlert('Questo tipo lavoro √® gi√† presente', 'error');
                    return;
                }
                
                // Aggiungi nuovo tipo lavoro
                tipiLavoro.push(nome);
                
                // Ordina: prima predefiniti, poi custom
                tipiLavoro.sort((a, b) => {
                    const aIsPredefinito = TIPI_LAVORO_PREDEFINITI.some(p => p.toLowerCase() === a.toLowerCase());
                    const bIsPredefinito = TIPI_LAVORO_PREDEFINITI.some(p => p.toLowerCase() === b.toLowerCase());
                    if (aIsPredefinito && !bIsPredefinito) return -1;
                    if (!aIsPredefinito && bIsPredefinito) return 1;
                    return a.localeCompare(b);
                });
                
                // Salva
                const listeData = {
                    tipiLavoro: tipiLavoro,
                    colture: listeSnap.exists() ? (listeSnap.data().colture || COLTURE_PREDEFINITE) : COLTURE_PREDEFINITE,
                    updatedAt: serverTimestamp()
                };
                
                if (!listeSnap.exists()) {
                    listeData.createdAt = serverTimestamp();
                }
                
                await setDoc(listeRef, listeData);
                
                input.value = '';
                showAlert('Tipo lavoro aggiunto con successo', 'success');
                await loadListe();
            } catch (error) {
                console.error('Errore aggiunta tipo lavoro:', error);
                showAlert('Errore durante l\'aggiunta: ' + error.message, 'error');
            }
        }
        
        // Rimuovi tipo lavoro
        async function removeTipoLavoro(tipoLavoro) {
            if (!currentTenantId) {
                showAlert('Tenant ID non disponibile', 'error');
                return;
            }
            
            // Verifica se √® predefinito
            if (TIPI_LAVORO_PREDEFINITI.some(p => p.toLowerCase() === tipoLavoro.toLowerCase())) {
                showAlert('Non √® possibile eliminare un tipo lavoro predefinito', 'error');
                return;
            }
            
            // Verifica se usato in attivit√†
            try {
                const attivitaCollection = collection(db, `tenants/${currentTenantId}/attivita`);
                const q = query(attivitaCollection, where('tipoLavoro', '==', tipoLavoro));
                const querySnapshot = await getDocs(q);
                const numAttivita = querySnapshot.size;
                
                if (numAttivita > 0) {
                    if (!confirm(`Questo tipo lavoro √® usato in ${numAttivita} attivit√†. Eliminare comunque?`)) {
                        return;
                    }
                }
            } catch (e) {
                console.warn('Errore verifica attivit√†:', e);
            }
            
            try {
                const listeRef = doc(db, `tenants/${currentTenantId}/liste`, 'personalizzate');
                const listeSnap = await getDoc(listeRef);
                
                if (!listeSnap.exists()) {
                    showAlert('Liste non trovate', 'error');
                    return;
                }
                
                const data = listeSnap.data();
                const tipiLavoro = (data.tipiLavoro || []).filter(t => t !== tipoLavoro);
                
                await updateDoc(listeRef, {
                    tipiLavoro: tipiLavoro,
                    updatedAt: serverTimestamp()
                });
                
                showAlert('Tipo lavoro eliminato con successo', 'success');
                await loadListe();
            } catch (error) {
                console.error('Errore rimozione tipo lavoro:', error);
                showAlert('Errore durante l\'eliminazione: ' + error.message, 'error');
            }
        }
        
        // Aggiungi coltura
        async function addColtura() {
            const input = document.getElementById('new-coltura');
            const nome = input.value.trim();
            
            if (!nome) {
                showAlert('Inserisci un nome per la coltura', 'error');
                return;
            }
            
            if (!currentTenantId) {
                showAlert('Tenant ID non disponibile', 'error');
                return;
            }
            
            try {
                // Carica liste esistenti
                const listeRef = doc(db, `tenants/${currentTenantId}/liste`, 'personalizzate');
                const listeSnap = await getDoc(listeRef);
                
                let colture = [...COLTURE_PREDEFINITE];
                if (listeSnap.exists()) {
                    const data = listeSnap.data();
                    colture = data.colture || colture;
                }
                
                // Verifica duplicati (case-insensitive)
                if (colture.some(c => c.toLowerCase() === nome.toLowerCase())) {
                    showAlert('Questa coltura √® gi√† presente', 'error');
                    return;
                }
                
                // Aggiungi nuova coltura
                colture.push(nome);
                
                // Ordina: prima predefinite, poi custom
                colture.sort((a, b) => {
                    const aIsPredefinita = COLTURE_PREDEFINITE.some(p => p.toLowerCase() === a.toLowerCase());
                    const bIsPredefinita = COLTURE_PREDEFINITE.some(p => p.toLowerCase() === b.toLowerCase());
                    if (aIsPredefinita && !bIsPredefinita) return -1;
                    if (!aIsPredefinita && bIsPredefinita) return 1;
                    return a.localeCompare(b);
                });
                
                // Salva
                const listeData = {
                    tipiLavoro: listeSnap.exists() ? (listeSnap.data().tipiLavoro || TIPI_LAVORO_PREDEFINITI) : TIPI_LAVORO_PREDEFINITI,
                    colture: colture,
                    updatedAt: serverTimestamp()
                };
                
                if (!listeSnap.exists()) {
                    listeData.createdAt = serverTimestamp();
                }
                
                await setDoc(listeRef, listeData);
                
                input.value = '';
                showAlert('Coltura aggiunta con successo', 'success');
                await loadListe();
            } catch (error) {
                console.error('Errore aggiunta coltura:', error);
                showAlert('Errore durante l\'aggiunta: ' + error.message, 'error');
            }
        }
        
        // Rimuovi coltura
        async function removeColtura(coltura) {
            if (!currentTenantId) {
                showAlert('Tenant ID non disponibile', 'error');
                return;
            }
            
            // Verifica se √® predefinita
            if (COLTURE_PREDEFINITE.some(p => p.toLowerCase() === coltura.toLowerCase())) {
                showAlert('Non √® possibile eliminare una coltura predefinita', 'error');
                return;
            }
            
            // Verifica se usata in attivit√†
            try {
                const attivitaCollection = collection(db, `tenants/${currentTenantId}/attivita`);
                const q = query(attivitaCollection, where('coltura', '==', coltura));
                const querySnapshot = await getDocs(q);
                const numAttivita = querySnapshot.size;
                
                if (numAttivita > 0) {
                    if (!confirm(`Questa coltura √® usata in ${numAttivita} attivit√†. Eliminare comunque?`)) {
                        return;
                    }
                }
            } catch (e) {
                console.warn('Errore verifica attivit√†:', e);
            }
            
            try {
                const listeRef = doc(db, `tenants/${currentTenantId}/liste`, 'personalizzate');
                const listeSnap = await getDoc(listeRef);
                
                if (!listeSnap.exists()) {
                    showAlert('Liste non trovate', 'error');
                    return;
                }
                
                const data = listeSnap.data();
                const colture = (data.colture || []).filter(c => c !== coltura);
                
                await updateDoc(listeRef, {
                    colture: colture,
                    updatedAt: serverTimestamp()
                });
                
                showAlert('Coltura eliminata con successo', 'success');
                await loadListe();
            } catch (error) {
                console.error('Errore rimozione coltura:', error);
                showAlert('Errore durante l\'eliminazione: ' + error.message, 'error');
            }
        }
        
        // Escape HTML
        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return String(text).replace(/[&<>"']/g, m => map[m]);
        }
        
        // ========== Gestione Tariffe Operai ==========
        
        const TIPI_OPERAI = [
            { value: 'semplice', label: 'Operaio Semplice' },
            { value: 'specializzato', label: 'Operaio Specializzato' },
            { value: 'trattorista', label: 'Trattorista' },
            { value: 'meccanico', label: 'Meccanico' },
            { value: 'elettricista', label: 'Elettricista' },
            { value: 'altro', label: 'Altro' }
        ];
        
        // Tariffe default (se non configurate)
        const TARIFFE_DEFAULT = {
            semplice: 10.0,
            specializzato: 12.0,
            trattorista: 15.0,
            meccanico: 14.0,
            elettricista: 14.0,
            altro: 10.0
        };
        
        // Carica tariffe
        async function loadTariffe() {
            if (!currentTenantId) return;
            
            try {
                const tariffeRef = doc(db, `tenants/${currentTenantId}/tariffe`, 'operai');
                const tariffeSnap = await getDoc(tariffeRef);
                
                let tariffe = { ...TARIFFE_DEFAULT };
                if (tariffeSnap.exists()) {
                    const data = tariffeSnap.data();
                    // Unisci con default per assicurarsi che tutti i tipi siano presenti
                    tariffe = { ...TARIFFE_DEFAULT, ...data };
                }
                
                renderTariffe(tariffe);
            } catch (error) {
                console.error('Errore caricamento tariffe:', error);
                showAlert('Errore caricamento tariffe', 'error');
            }
        }
        
        // Render tariffe
        function renderTariffe(tariffe) {
            const container = document.getElementById('tariffe-list');
            
            container.innerHTML = TIPI_OPERAI.map(tipo => {
                const tariffa = tariffe[tipo.value] || TARIFFE_DEFAULT[tipo.value] || 0;
                const escapedLabel = escapeHtml(tipo.label);
                
                return `
                    <div class="list-item" style="align-items: center;">
                        <div class="list-item-name" style="flex: 1;">
                            <div style="font-weight: 600; color: #2E8B57;">${escapedLabel}</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 15px; flex: 1;">
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <input 
                                    type="number" 
                                    step="0.01" 
                                    min="0" 
                                    id="tariffa-${tipo.value}" 
                                    value="${tariffa.toFixed(2)}" 
                                    style="width: 100px; padding: 8px; border: 1px solid #ced4da; border-radius: 6px;"
                                    onchange="saveTariffa('${tipo.value}')"
                                >
                                <span style="color: #666;">‚Ç¨/ora</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Salva tariffa
        async function saveTariffa(tipoOperaio) {
            if (!currentTenantId) {
                showAlert('Tenant ID non disponibile', 'error');
                return;
            }
            
            const input = document.getElementById(`tariffa-${tipoOperaio}`);
            const valore = parseFloat(input.value);
            
            if (isNaN(valore) || valore < 0) {
                showAlert('Inserisci un valore valido (>= 0)', 'error');
                // Ripristina valore precedente
                await loadTariffe();
                return;
            }
            
            try {
                const tariffeRef = doc(db, `tenants/${currentTenantId}/tariffe`, 'operai');
                const tariffeSnap = await getDoc(tariffeRef);
                
                let tariffe = { ...TARIFFE_DEFAULT };
                if (tariffeSnap.exists()) {
                    tariffe = { ...TARIFFE_DEFAULT, ...tariffeSnap.data() };
                }
                
                tariffe[tipoOperaio] = valore;
                tariffe.updatedAt = serverTimestamp();
                
                if (!tariffeSnap.exists()) {
                    tariffe.createdAt = serverTimestamp();
                }
                
                await setDoc(tariffeRef, tariffe);
                showAlert('Tariffa salvata con successo', 'success');
            } catch (error) {
                console.error('Errore salvataggio tariffa:', error);
                showAlert('Errore durante il salvataggio: ' + error.message, 'error');
                // Ripristina valore precedente
                await loadTariffe();
            }
        }
        
        // ========== Gestione Poderi ==========
        
        // Carica poderi
        async function loadPoderi() {
            if (!currentTenantId) return;
            
            try {
                const poderiCollection = collection(db, `tenants/${currentTenantId}/poderi`);
                const q = query(poderiCollection, orderBy('nome', 'asc'));
                const querySnapshot = await getDocs(q);
                
                poderiList = [];
                querySnapshot.forEach((docSnap) => {
                    poderiList.push({
                        id: docSnap.id,
                        ...docSnap.data()
                    });
                });
                
                renderPoderi();
            } catch (error) {
                console.error('Errore caricamento poderi:', error);
                showAlert('Errore caricamento poderi', 'error');
            }
        }
        
        // Render poderi
        function renderPoderi() {
            const container = document.getElementById('poderi-list');
            
            if (poderiList.length === 0) {
                container.innerHTML = '<p class="info-text">Nessun podere aggiunto. Clicca su "Aggiungi Podere" per iniziare.</p>';
                return;
            }
            
            container.innerHTML = poderiList.map(podere => {
                const escapedNome = escapeHtml(podere.nome || 'Senza nome');
                const escapedIndirizzo = escapeHtml(podere.indirizzo || '');
                const escapedNote = escapeHtml(podere.note || '');
                
                return `
                    <div class="list-item">
                        <div class="list-item-name" style="flex-direction: column; align-items: flex-start; gap: 5px;">
                            <div style="font-weight: 600; color: #2E8B57;">${escapedNome}</div>
                            ${escapedIndirizzo ? `<div style="font-size: 12px; color: #666;">üìç ${escapedIndirizzo}</div>` : ''}
                            ${escapedNote ? `<div style="font-size: 12px; color: #999;">${escapedNote}</div>` : ''}
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-info btn-small" onclick="editPodere('${podere.id}')" title="Modifica">‚úèÔ∏è Modifica</button>
                            <button class="btn btn-danger btn-small" onclick="confirmDeletePodere('${podere.id}')" title="Elimina">üóëÔ∏è Elimina</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Apri modal podere
        function openPodereModal(podereId = null) {
            currentPodereId = podereId;
            const modal = document.getElementById('podere-modal');
            const form = document.getElementById('podere-form');
            const title = document.getElementById('podere-modal-title');
            
            if (podereId) {
                title.textContent = 'Modifica Podere';
                const podere = poderiList.find(p => p.id === podereId);
                if (podere) {
                    document.getElementById('podere-nome').value = podere.nome || '';
                    document.getElementById('podere-indirizzo').value = podere.indirizzo || '';
                    document.getElementById('podere-note').value = podere.note || '';
                    
                    // Inizializza mappa se ci sono coordinate o indirizzo
                    if (window.googleMapsReadyPodere) {
                        setTimeout(() => {
                            if (podere.coordinate) {
                                // Se ci sono coordinate salvate, usa quelle
                                initPodereMap(podere.coordinate);
                            } else if (podere.indirizzo) {
                                // Se c'√® indirizzo ma non coordinate, inizializza mappa e cerca indirizzo
                                initPodereMap();
                                setTimeout(() => {
                                    searchPodereAddress(true);
                                }, 500);
                            } else {
                                // Nessuna coordinata n√© indirizzo, inizializza mappa vuota
                                initPodereMap();
                            }
                        }, 300);
                    }
                }
            } else {
                title.textContent = 'Aggiungi Podere';
                form.reset();
                // Mostra sempre la mappa quando si apre il modal
                setTimeout(() => {
                    initPodereMap();
                }, 300);
            }
            
            modal.classList.add('active');
        }
        
        // Chiudi modal podere
        function closePodereModal() {
            const modal = document.getElementById('podere-modal');
            modal.classList.remove('active');
            document.getElementById('podere-form').reset();
            currentPodereId = null;
            
            // Pulisci mappa
            if (podereMarker) {
                podereMarker.setMap(null);
                podereMarker = null;
            }
            if (podereMap) {
                podereMap = null;
            }
            document.getElementById('podere-map-container').style.display = 'none';
            const mapActions = document.getElementById('podere-map-actions');
            if (mapActions) {
                mapActions.style.display = 'none';
            }
        }
        
        // Inizializza mappa podere
        function initPodereMap(center = null) {
            const mapContainer = document.getElementById('podere-map-container');
            const mapDiv = document.getElementById('podere-map');
            
            if (!mapDiv) return;
            
            // Mostra sempre il container della mappa
            mapContainer.style.display = 'block';
            
            // Se Google Maps non √® ancora caricato, mostra messaggio e riprova dopo
            if (!window.google || !window.google.maps || !window.googleMapsReadyPodere) {
                mapDiv.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666; font-size: 14px;">Caricamento mappa...</div>';
                
                // Riprova dopo un po'
                setTimeout(() => {
                    if (window.google && window.google.maps && window.googleMapsReadyPodere) {
                        initPodereMap(center);
                    } else {
                        mapDiv.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #999; font-size: 14px; flex-direction: column; gap: 10px;"><div>‚ö†Ô∏è Google Maps non disponibile</div><div style="font-size: 12px;">La mappa verr√† caricata quando disponibile</div></div>';
                    }
                }, 1000);
                return;
            }
            
            // Se la mappa √® gi√† inizializzata, aggiorna solo il centro
            if (podereMap) {
                if (center) {
                    podereMap.setCenter(center);
                    podereMap.setZoom(17);
                    if (!podereMarker) {
                        setPodereMarker(center);
                    }
                }
                return;
            }
            
            try {
                const defaultCenter = center || { lat: 44.4949, lng: 11.3426 }; // Bologna area
                
                podereMap = new google.maps.Map(mapDiv, {
                    zoom: center ? 17 : 10,
                    center: defaultCenter,
                    mapTypeId: google.maps.MapTypeId.SATELLITE
                });
                
                // Aggiungi controlli per cambiare tipo mappa
                podereMap.setOptions({
                    mapTypeControl: true,
                    mapTypeControlOptions: {
                        style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR,
                        position: google.maps.ControlPosition.TOP_RIGHT,
                        mapTypeIds: [
                            google.maps.MapTypeId.SATELLITE,
                            google.maps.MapTypeId.HYBRID,
                            google.maps.MapTypeId.ROADMAP
                        ]
                    }
                });
                
                // Click sulla mappa per posizionare marker
                podereMap.addListener('click', function(event) {
                    setPodereMarker(event.latLng);
                });
                
                // Se c'√® un centro, posiziona marker
                if (center) {
                    setPodereMarker(center);
                }
            } catch (error) {
                console.error('Errore inizializzazione mappa podere:', error);
                mapDiv.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #dc3545; font-size: 14px;">Errore caricamento mappa</div>';
            }
        }
        
        // Posiziona marker sulla mappa
        function setPodereMarker(position) {
            if (!podereMap || !window.google || !window.google.maps) return;
            
            // Rimuovi marker esistente
            if (podereMarker) {
                podereMarker.setMap(null);
            }
            
            // Crea nuovo marker
            podereMarker = new google.maps.Marker({
                map: podereMap,
                position: position,
                draggable: true,
                title: 'Posizione podere'
            });
            
            // Centra mappa sul marker
            podereMap.setCenter(position);
            podereMap.setZoom(17);
            
            // Mostra pulsante indicazioni
            const mapActions = document.getElementById('podere-map-actions');
            if (mapActions) {
                mapActions.style.display = 'block';
            }
            
            // Listener per drag marker
            podereMarker.addListener('dragend', function(event) {
                // Aggiorna indirizzo quando si sposta il marker
                reverseGeocodePodere(event.latLng);
            });
        }
        
        // Apri indicazioni stradali
        function openDirections() {
            if (!podereMarker) {
                showAlert('Posiziona prima un marker sulla mappa', 'error');
                return;
            }
            
            const position = podereMarker.getPosition();
            const lat = position.lat();
            const lng = position.lng();
            
            // Apri Google Maps con indicazioni verso questa posizione
            const url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
            window.open(url, '_blank');
        }
        
        // Cerca indirizzo podere
        async function searchPodereAddress(useExistingValue = false) {
            if (!window.google || !window.google.maps || !window.googleMapsReadyPodere) {
                showAlert('Mappa non ancora caricata. Attendi qualche secondo.', 'error');
                return;
            }
            
            const indirizzoInput = document.getElementById('podere-indirizzo');
            const address = useExistingValue ? indirizzoInput.value.trim() : indirizzoInput.value.trim();
            
            if (!address) {
                showAlert('Inserisci un indirizzo da cercare', 'error');
                return;
            }
            
            // Inizializza mappa se non gi√† fatto
            if (!podereMap) {
                initPodereMap();
            }
            
            const geocoder = new google.maps.Geocoder();
            
            geocoder.geocode({ address: address }, function(results, status) {
                if (status === 'OK' && results[0]) {
                    const location = results[0].geometry.location;
                    setPodereMarker(location);
                    
                    // Aggiorna indirizzo con quello completo trovato
                    indirizzoInput.value = results[0].formatted_address;
                    
                    showAlert('Indirizzo trovato! Marker posizionato sulla mappa.', 'success');
                } else {
                    showAlert('Indirizzo non trovato. Verifica di aver inserito un indirizzo valido.', 'error');
                }
            });
        }
        
        // Reverse geocoding (da coordinate a indirizzo)
        function reverseGeocodePodere(latLng) {
            if (!window.google || !window.google.maps) return;
            
            const geocoder = new google.maps.Geocoder();
            geocoder.geocode({ location: latLng }, function(results, status) {
                if (status === 'OK' && results[0]) {
                    const indirizzoInput = document.getElementById('podere-indirizzo');
                    indirizzoInput.value = results[0].formatted_address;
                }
            });
        }
        
        // Salva podere
        async function handleSavePodere(e) {
            e.preventDefault();
            
            if (!currentTenantId) {
                showAlert('Tenant ID non disponibile', 'error');
                return;
            }
            
            const nome = document.getElementById('podere-nome').value.trim();
            if (!nome) {
                showAlert('Il nome podere √® obbligatorio', 'error');
                return;
            }
            
            const indirizzo = document.getElementById('podere-indirizzo').value.trim() || null;
            const note = document.getElementById('podere-note').value.trim() || null;
            
            // Ottieni coordinate dal marker se presente
            let coordinate = null;
            if (podereMarker) {
                const position = podereMarker.getPosition();
                coordinate = {
                    lat: position.lat(),
                    lng: position.lng()
                };
            }
            
            try {
                const poderiCollection = collection(db, `tenants/${currentTenantId}/poderi`);
                const podereData = {
                    nome,
                    indirizzo,
                    note,
                    coordinate: coordinate,
                    aggiornatoIl: serverTimestamp()
                };
                
                if (currentPodereId) {
                    // Modifica
                    const podereRef = doc(poderiCollection, currentPodereId);
                    await updateDoc(podereRef, podereData);
                    showAlert('Podere modificato con successo', 'success');
                } else {
                    // Crea
                    podereData.creatoIl = serverTimestamp();
                    await addDoc(poderiCollection, podereData);
                    showAlert('Podere aggiunto con successo', 'success');
                }
                
                closePodereModal();
                await loadPoderi();
            } catch (error) {
                console.error('Errore salvataggio podere:', error);
                showAlert('Errore durante il salvataggio: ' + error.message, 'error');
            }
        }
        
        // Modifica podere
        function editPodere(podereId) {
            openPodereModal(podereId);
        }
        
        // Conferma eliminazione podere
        async function confirmDeletePodere(podereId) {
            const podere = poderiList.find(p => p.id === podereId);
            if (!podere) return;
            
            // Verifica se il podere √® usato in terreni
            try {
                const terreniCollection = collection(db, `tenants/${currentTenantId}/terreni`);
                const q = query(terreniCollection, where('podere', '==', podere.nome));
                const querySnapshot = await getDocs(q);
                const numTerreni = querySnapshot.size;
                
                if (numTerreni > 0) {
                    if (!confirm(`Questo podere √® assegnato a ${numTerreni} terreno/i. Eliminare comunque?\n\nNota: I terreni perderanno l'assegnazione al podere.`)) {
                        return;
                    }
                }
            } catch (e) {
                console.warn('Errore verifica terreni:', e);
            }
            
            if (!confirm(`Sei sicuro di voler eliminare il podere "${podere.nome}"?`)) {
                return;
            }
            
            try {
                const podereRef = doc(db, `tenants/${currentTenantId}/poderi`, podereId);
                await deleteDoc(podereRef);
                showAlert('Podere eliminato con successo', 'success');
                await loadPoderi();
            } catch (error) {
                console.error('Errore eliminazione podere:', error);
                showAlert('Errore durante l\'eliminazione: ' + error.message, 'error');
            }
        }
        
        // Esponi funzioni globalmente
        window.handleSaveAzienda = handleSaveAzienda;
        window.handleSaveAccount = handleSaveAccount;
        window.handleChangePassword = handleChangePassword;
        window.addTipoLavoro = addTipoLavoro;
        window.removeTipoLavoro = removeTipoLavoro;
        window.addColtura = addColtura;
        window.removeColtura = removeColtura;
        window.openPodereModal = openPodereModal;
        window.closePodereModal = closePodereModal;
        window.handleSavePodere = handleSavePodere;
        window.editPodere = editPodere;
        window.confirmDeletePodere = confirmDeletePodere;
        window.searchPodereAddress = searchPodereAddress;
        window.openDirections = openDirections;
        
        // ========== Gestione Comunicazioni Squadra (Caposquadra) ==========
        
        let terreniList = [];
        let lavoriAttiviList = [];
        
        // Carica poderi per dropdown comunicazioni
        async function loadPoderiForComunicazioni() {
            if (!currentTenantId) return;
            
            try {
                const poderiCollection = collection(db, `tenants/${currentTenantId}/poderi`);
                const q = query(poderiCollection, orderBy('nome', 'asc'));
                const querySnapshot = await getDocs(q);
                
                const podereSelect = document.getElementById('comunicazione-podere');
                podereSelect.innerHTML = '<option value="">-- Seleziona podere --</option>';
                
                querySnapshot.forEach((docSnap) => {
                    const podere = docSnap.data();
                    const option = document.createElement('option');
                    option.value = podere.nome;
                    option.textContent = podere.nome;
                    option.dataset.podereId = docSnap.id;
                    option.dataset.coordinate = podere.coordinate ? JSON.stringify(podere.coordinate) : '';
                    podereSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Errore caricamento poderi per comunicazioni:', error);
            }
        }
        
        // Carica terreni per dropdown comunicazioni
        async function loadTerreniForComunicazioni() {
            if (!currentTenantId) return;
            
            try {
                const terreniCollection = collection(db, `tenants/${currentTenantId}/terreni`);
                const q = query(terreniCollection, orderBy('nome', 'asc'));
                const querySnapshot = await getDocs(q);
                
                terreniList = [];
                const terrenoSelect = document.getElementById('comunicazione-terreno');
                terrenoSelect.innerHTML = '<option value="">-- Seleziona terreno --</option>';
                
                querySnapshot.forEach((docSnap) => {
                    const terreno = docSnap.data();
                    terreniList.push({
                        id: docSnap.id,
                        ...terreno
                    });
                    
                    const option = document.createElement('option');
                    option.value = terreno.nome || '';
                    option.textContent = terreno.nome || 'Senza nome';
                    option.dataset.terrenoId = docSnap.id;
                    option.dataset.podere = terreno.podere || '';
                    terrenoSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Errore caricamento terreni per comunicazioni:', error);
            }
        }
        
        // Carica lavori attivi del caposquadra
        async function loadLavoriAttiviForComunicazioni() {
            if (!currentTenantId || !currentUserData) return;
            
            try {
                const lavoriCollection = collection(db, `tenants/${currentTenantId}/lavori`);
                const caposquadraId = currentUserData.id || auth.currentUser.uid;
                const q = query(
                    lavoriCollection,
                    where('caposquadraId', '==', caposquadraId)
                );
                const querySnapshot = await getDocs(q);
                
                lavoriAttiviList = [];
                const lavoroSelect = document.getElementById('comunicazione-lavoro');
                lavoroSelect.innerHTML = '<option value="">-- Seleziona lavoro per pre-compilare --</option>';
                
                querySnapshot.forEach((docSnap) => {
                    const lavoro = docSnap.data();
                    const stato = lavoro.stato || 'assegnato';
                    
                    // Solo lavori attivi (non completati e non annullati)
                    if (stato !== 'completato' && stato !== 'annullato' && stato !== 'completato_da_approvare') {
                        lavoriAttiviList.push({
                            id: docSnap.id,
                            ...lavoro
                        });
                        
                        const option = document.createElement('option');
                        option.value = docSnap.id;
                        option.textContent = lavoro.nome || 'Lavoro senza nome';
                        option.dataset.terrenoId = lavoro.terrenoId || '';
                        lavoroSelect.appendChild(option);
                    }
                });
            } catch (error) {
                console.error('Errore caricamento lavori per comunicazioni:', error);
            }
        }
        
        // Gestisce cambio selezione lavoro
        async function handleLavoroChange() {
            const lavoroSelect = document.getElementById('comunicazione-lavoro');
            const lavoroId = lavoroSelect.value;
            
            if (!lavoroId) return;
            
            const lavoro = lavoriAttiviList.find(l => l.id === lavoroId);
            if (!lavoro || !lavoro.terrenoId) return;
            
            try {
                // Carica terreno per ottenere podere
                const terrenoRef = doc(db, `tenants/${currentTenantId}/terreni`, lavoro.terrenoId);
                const terrenoDoc = await getDoc(terrenoRef);
                
                if (terrenoDoc.exists()) {
                    const terreno = terrenoDoc.data();
                    const podereNome = terreno.podere || '';
                    const terrenoNome = terreno.nome || '';
                    
                    // Pre-compila podere
                    const podereSelect = document.getElementById('comunicazione-podere');
                    if (podereNome) {
                        // Cerca l'opzione corrispondente
                        for (let i = 0; i < podereSelect.options.length; i++) {
                            if (podereSelect.options[i].value === podereNome) {
                                podereSelect.value = podereNome;
                                break;
                            }
                        }
                    }
                    
                    // Pre-compila terreno
                    const terrenoSelect = document.getElementById('comunicazione-terreno');
                    if (terrenoNome) {
                        terrenoSelect.value = terrenoNome;
                    }
                }
            } catch (error) {
                console.error('Errore caricamento terreno:', error);
            }
        }
        
        // Pre-compila form con il primo lavoro attivo
        async function precompilaDaPrimoLavoro() {
            if (lavoriAttiviList.length === 0) return;
            
            // Seleziona automaticamente il primo lavoro
            const lavoroSelect = document.getElementById('comunicazione-lavoro');
            if (lavoroSelect.options.length > 1) {
                lavoroSelect.value = lavoriAttiviList[0].id;
                await handleLavoroChange();
            }
        }
        
        window.handleLavoroChange = handleLavoroChange;
        
        // Ottieni squadra del caposquadra
        async function getSquadraCaposquadra() {
            if (!currentTenantId || !currentUserData) {
                console.warn('getSquadraCaposquadra: tenantId o userData mancanti');
                return [];
            }
            
            try {
                const caposquadraId = currentUserData.id || auth.currentUser.uid;
                console.log('Cercando squadra per caposquadraId:', caposquadraId);
                
                const squadreCollection = collection(db, `tenants/${currentTenantId}/squadre`);
                const q = query(squadreCollection, where('caposquadraId', '==', caposquadraId));
                const querySnapshot = await getDocs(q);
                
                console.log('Query squadre risultato:', querySnapshot.size, 'squadre trovate');
                
                if (querySnapshot.empty) {
                    console.warn('Nessuna squadra trovata per caposquadraId:', caposquadraId);
                    return [];
                }
                
                // Prendi la prima squadra trovata
                const squadraDoc = querySnapshot.docs[0];
                const squadraData = squadraDoc.data();
                
                console.log('Dati squadra trovata:', {
                    id: squadraDoc.id,
                    nome: squadraData.nome,
                    caposquadraId: squadraData.caposquadraId,
                    operai: squadraData.operai,
                    operaiCount: squadraData.operai?.length || 0
                });
                
                // Il campo corretto √® "operai", non "membri"
                return squadraData.operai || [];
            } catch (error) {
                console.error('Errore recupero squadra:', error);
                return [];
            }
        }
        
        // Invia comunicazione alla squadra
        async function handleSendComunicazione(e) {
            e.preventDefault();
            
            if (!currentUserData || !currentTenantId) {
                showAlert('Errore: dati utente non disponibili', 'error');
                return;
            }
            
            const podereSelect = document.getElementById('comunicazione-podere');
            const terrenoSelect = document.getElementById('comunicazione-terreno');
            const dataInput = document.getElementById('comunicazione-data');
            const orarioInput = document.getElementById('comunicazione-orario');
            const noteInput = document.getElementById('comunicazione-note');
            
            const podere = podereSelect.value.trim();
            const terreno = terrenoSelect.value.trim();
            const data = dataInput.value;
            const orario = orarioInput.value;
            const note = noteInput.value.trim();
            
            if (!podere || !terreno || !data || !orario) {
                showAlert('Compila tutti i campi obbligatori', 'error');
                return;
            }
            
            // Ottieni coordinate podere
            const podereOption = podereSelect.options[podereSelect.selectedIndex];
            const coordinatePodere = podereOption.dataset.coordinate ? JSON.parse(podereOption.dataset.coordinate) : null;
            
            try {
                // Ottieni membri squadra
                const membriSquadra = await getSquadraCaposquadra();
                
                if (membriSquadra.length === 0) {
                    showAlert('Nessun membro nella tua squadra', 'error');
                    return;
                }
                
                // Crea comunicazione
                const comunicazioneData = {
                    caposquadraId: currentUserData.id || auth.currentUser.uid,
                    caposquadraNome: `${currentUserData.nome || ''} ${currentUserData.cognome || ''}`.trim(),
                    podere: podere,
                    terreno: terreno,
                    data: new Date(data + 'T' + orario),
                    orario: orario,
                    note: note || null,
                    coordinatePodere: coordinatePodere,
                    destinatari: membriSquadra,
                    conferme: [],
                    stato: 'attiva',
                    createdAt: serverTimestamp()
                };
                
                const comunicazioniCollection = collection(db, `tenants/${currentTenantId}/comunicazioni`);
                await addDoc(comunicazioniCollection, comunicazioneData);
                
                showAlert('Comunicazione inviata alla squadra con successo!', 'success');
                
                // Reset form
                document.getElementById('comunicazione-form').reset();
                document.getElementById('comunicazione-orario').value = '07:00';
                
                // Ricarica lista comunicazioni
                await loadComunicazioniInviate();
            } catch (error) {
                console.error('Errore invio comunicazione:', error);
                showAlert('Errore durante l\'invio: ' + error.message, 'error');
            }
        }
        
        // Carica comunicazioni inviate
        async function loadComunicazioniInviate() {
            if (!currentTenantId || !currentUserData) return;
            
            try {
                const comunicazioniCollection = collection(db, `tenants/${currentTenantId}/comunicazioni`);
                // Usa solo where senza orderBy per evitare bisogno di indice composito
                // Ordineremo in memoria
                const q = query(
                    comunicazioniCollection,
                    where('caposquadraId', '==', currentUserData.id || auth.currentUser.uid)
                );
                const querySnapshot = await getDocs(q);
                
                // Converti in array e ordina per createdAt in memoria
                const comunicazioniArray = [];
                querySnapshot.forEach((docSnap) => {
                    const comm = docSnap.data();
                    comunicazioniArray.push({
                        id: docSnap.id,
                        ...comm,
                        createdAtValue: comm.createdAt?.toDate ? comm.createdAt.toDate() : new Date(comm.createdAt || 0)
                    });
                });
                
                // Ordina per data creazione (pi√π recenti prima)
                comunicazioniArray.sort((a, b) => {
                    const dateA = a.createdAtValue || new Date(0);
                    const dateB = b.createdAtValue || new Date(0);
                    return dateB - dateA; // Ordine decrescente
                });
                
                const container = document.getElementById('comunicazioni-list');
                
                if (comunicazioniArray.length === 0) {
                    container.innerHTML = '<p class="info-text">Nessuna comunicazione inviata.</p>';
                    return;
                }
                
                container.innerHTML = comunicazioniArray.map(comm => {
                    const dataCom = comm.data?.toDate ? comm.data.toDate() : new Date(comm.data);
                    const dataFormatted = dataCom.toLocaleDateString('it-IT', { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    });
                    const oraFormatted = comm.orario || '07:00';
                    
                    const numDestinatari = comm.destinatari?.length || 0;
                    const numConferme = comm.conferme?.length || 0;
                    const percentualeConferme = numDestinatari > 0 ? Math.round((numConferme / numDestinatari) * 100) : 0;
                    
                    const statoBadge = comm.stato === 'attiva' ? 
                        '<span style="background: #28a745; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px;">Attiva</span>' :
                        '<span style="background: #6c757d; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px;">Completata</span>';
                    
                    return `
                        <div class="list-item" style="margin-bottom: 15px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                <div>
                                    <div style="font-weight: 600; color: #2E8B57; margin-bottom: 5px;">${escapeHtml(comm.podere)} - ${escapeHtml(comm.terreno)}</div>
                                    <div style="font-size: 14px; color: #666;">üìÖ ${dataFormatted} alle ${oraFormatted}</div>
                                    ${comm.note ? `<div style="font-size: 13px; color: #999; margin-top: 5px;">${escapeHtml(comm.note)}</div>` : ''}
                                </div>
                                ${statoBadge}
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px; padding-top: 10px; border-top: 1px solid #e9ecef;">
                                <div style="font-size: 12px; color: #666;">
                                    Conferme: ${numConferme}/${numDestinatari} (${percentualeConferme}%)
                                </div>
                                ${comm.coordinatePodere ? `<a href="https://www.google.com/maps/dir/?api=1&destination=${comm.coordinatePodere.lat},${comm.coordinatePodere.lng}" target="_blank" style="color: #2E8B57; text-decoration: none; font-size: 14px;">üìç Indicazioni</a>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Errore caricamento comunicazioni:', error);
                const container = document.getElementById('comunicazioni-list');
                container.innerHTML = '<p class="info-text">Errore caricamento comunicazioni.</p>';
            }
        }
        
        // Imposta data di default a domani
        function setDefaultDate() {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const dateString = tomorrow.toISOString().split('T')[0];
            const dataInput = document.getElementById('comunicazione-data');
            if (dataInput) {
                dataInput.value = dateString;
                dataInput.min = dateString; // Non permettere date passate
            }
        }
        
        // Chiama setDefaultDate quando la pagina √® caricata
        if (document.getElementById('comunicazione-data')) {
            setDefaultDate();
        }
        
        window.handleSendComunicazione = handleSendComunicazione;
    </script>
</body>
</html>

