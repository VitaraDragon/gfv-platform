<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Segnalazione Guasti - GFV Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .btn-primary:hover {
            background: rgba(255,255,255,0.3);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
            border-bottom: 2px solid #2E8B57;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-group small {
            display: block;
            margin-top: 5px;
            color: #666;
            font-size: 12px;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .radio-option input[type="radio"] {
            width: auto;
        }

        .guasti-list {
            margin-top: 20px;
        }

        .guasto-item {
            background: #f8f9fa;
            border-left: 4px solid #dc3545;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
        }

        .guasto-item.risolto {
            border-left-color: #28a745;
            background: #d4edda;
        }

        .guasto-item.in-attesa {
            border-left-color: #ffc107;
            background: #fff3cd;
        }

        .guasto-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .guasto-title {
            font-weight: 600;
            font-size: 16px;
        }

        .guasto-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-grave {
            background: #dc3545;
            color: white;
        }

        .badge-non-grave {
            background: #ffc107;
            color: #856404;
        }

        .badge-risolto {
            background: #28a745;
            color: white;
        }

        .badge-in-attesa {
            background: #6c757d;
            color: white;
        }

        .guasto-details {
            margin-top: 10px;
            color: #666;
            font-size: 14px;
        }

        .guasto-details div {
            margin-bottom: 5px;
        }

        .guasto-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert.show {
            display: block;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            overflow: auto;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            font-size: 20px;
            color: #333;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .close-modal:hover {
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>🔧 Segnalazione Guasti</h1>
                <p>Segnala guasti alle macchine e gestisci le risoluzioni</p>
            </div>
            <div class="header-actions">
                <a href="../dashboard-standalone.html" class="btn btn-primary">← Dashboard</a>
            </div>
        </div>

        <div id="alert-container"></div>

        <!-- Sezione Segnala Nuovo Guasto -->
        <div class="content">
            <h2 class="section-title">Segnala Nuovo Guasto / Segnalazione</h2>
            <form id="segnala-guasto-form">
                <div class="form-group">
                    <label>Tipo di segnalazione *</label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="tipo-macchina" name="tipoGuasto" value="macchina" required checked>
                            <label for="tipo-macchina">🔧 Guasto Macchina/Attrezzo</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="tipo-generico" name="tipoGuasto" value="generico" required>
                            <label for="tipo-generico">🌍 Segnalazione Generica</label>
                        </div>
                    </div>
                    <small>Scegli se segnalare un guasto a macchina/attrezzo o una segnalazione generica (frane, voragini, problemi infrastrutturali, ecc.)</small>
                </div>

                <!-- Sezione Guasto Macchina -->
                <div id="sezione-macchina">
                    <div class="form-group">
                        <label for="guasto-macchina">Trattore (Macchina) *</label>
                        <select id="guasto-macchina" required>
                            <option value="">-- Seleziona trattore --</option>
                        </select>
                        <small>Seleziona il trattore con il guasto (pre-selezionato se assegnato al lavoro)</small>
                    </div>

                    <div class="form-group">
                        <label for="guasto-attrezzo">Attrezzo (Opzionale)</label>
                        <select id="guasto-attrezzo">
                            <option value="">-- Nessun attrezzo --</option>
                        </select>
                        <small>Seleziona l'attrezzo con il guasto (pre-selezionato se assegnato al lavoro)</small>
                    </div>

                    <div class="form-group">
                        <label for="guasto-componente">Componente con guasto *</label>
                        <select id="guasto-componente" required>
                            <option value="">-- Seleziona componente --</option>
                            <option value="trattore">Trattore</option>
                            <option value="attrezzo">Attrezzo</option>
                            <option value="entrambi">Entrambi</option>
                        </select>
                        <small>Specifica quale componente ha il guasto</small>
                    </div>
                </div>

                <!-- Sezione Segnalazione Generica -->
                <div id="sezione-generico" style="display: none;">
                    <div class="form-group">
                        <label for="guasto-ubicazione">Ubicazione *</label>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <input type="text" id="guasto-ubicazione" placeholder="Es: Podere Nord, filare 12" required style="flex: 1;">
                            <button type="button" id="btn-apri-maps" class="btn btn-secondary" style="padding: 10px 15px; min-width: auto;" title="Apri in Google Maps">
                                🗺️
                            </button>
                        </div>
                        <small>Indica dove si trova il problema (terreno, podere, filare, ecc.). Clicca l'icona per aprire Google Maps.</small>
                    </div>

                    <div class="form-group">
                        <label>📍 Localizza il problema sulla mappa</label>
                        <div style="background: #e3f2fd; padding: 10px; border-radius: 6px; margin-bottom: 10px; border-left: 4px solid #2196F3;">
                            <strong style="color: #1976D2;">💡 Come usare:</strong>
                            <div style="margin-top: 5px; font-size: 13px; color: #1565C0;">
                                1. Clicca sulla mappa nel punto esatto dove si trova il problema<br>
                                2. Apparirà un marker rosso 🎯 che puoi trascinare per precisione<br>
                                3. I confini del terreno sono mostrati in rosso
                            </div>
                        </div>
                        <div id="map-container" style="width: 100%; height: 400px; border: 2px solid #2196F3; border-radius: 8px; margin-top: 10px; position: relative; background: #f5f5f5; cursor: crosshair;">
                            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #666; text-align: center; z-index: 1;">
                                <div style="margin-bottom: 10px;">🗺️</div>
                                <div>Caricamento mappa...</div>
                            </div>
                        </div>
                        <small id="map-status" style="display: block; margin-top: 8px; color: #666;">
                            <span id="marker-status">Clicca sulla mappa per posizionare il marker</span>
                        </small>
                    </div>

                    <div class="form-group">
                        <label for="guasto-tipo-problema">Tipo di problema *</label>
                        <select id="guasto-tipo-problema" required>
                            <option value="">-- Seleziona tipo --</option>
                            <option value="Frana">Frana</option>
                            <option value="Voragine">Voragine</option>
                            <option value="Danno infrastruttura">Danno infrastruttura</option>
                            <option value="Problema filare">Problema filare</option>
                            <option value="Danno recinzione">Danno recinzione</option>
                            <option value="Problema irrigazione">Problema irrigazione</option>
                            <option value="Altro">Altro</option>
                        </select>
                        <small>Seleziona il tipo di problema riscontrato</small>
                    </div>
                </div>

                <div class="form-group">
                    <label>Gravità del guasto *</label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="gravita-non-grave" name="gravita" value="non-grave" required>
                            <label for="gravita-non-grave">Non grave - Posso finire il lavoro</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="gravita-grave" name="gravita" value="grave" required>
                            <label for="gravita-grave">Grave - Sospendere subito</label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="guasto-dettagli">Dettagli del guasto / segnalazione *</label>
                    <textarea id="guasto-dettagli" required placeholder="Descrivi il problema riscontrato..."></textarea>
                    <small>Fornisci tutti i dettagli utili per la risoluzione</small>
                </div>

                <div class="form-group">
                    <label for="guasto-lavoro">Lavoro corrente (opzionale)</label>
                    <select id="guasto-lavoro">
                        <option value="">-- Nessun lavoro associato --</option>
                    </select>
                    <small>Se stai lavorando su un lavoro specifico, selezionalo</small>
                </div>

                <button type="submit" class="btn btn-danger">🚨 Segnala</button>
            </form>
        </div>

        <!-- Sezione Guasti Attivi -->
        <div class="content">
            <h2 class="section-title">I Miei Guasti Segnalati</h2>
            <div id="guasti-list" class="guasti-list">
                <div class="empty-state">
                    <div class="empty-state-icon">⏳</div>
                    <p>Caricamento guasti...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Risolvi Guasto -->
    <div id="risolvi-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Risolvi Guasto</h3>
                <button class="close-modal" onclick="closeRisolviModal()">&times;</button>
            </div>
            <form id="risolvi-guasto-form">
                <input type="hidden" id="risolvi-guasto-id">
                
                <div class="form-group">
                    <label for="risolvi-note">Note di risoluzione *</label>
                    <textarea id="risolvi-note" required placeholder="Descrivi come hai risolto il problema..."></textarea>
                    <small>Es: "Sostituito filtro olio", "Riparato tubo idraulico"</small>
                </div>

                <div class="form-group">
                    <label for="risolvi-costo">Costo riparazione (€) - Opzionale</label>
                    <input type="number" id="risolvi-costo" step="0.01" min="0" placeholder="0.00">
                    <small>Inserisci il costo se hai acquistato pezzi di ricambio</small>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-success">✅ Conferma Risoluzione</button>
                    <button type="button" class="btn btn-secondary" onclick="closeRisolviModal()">Annulla</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Load Google Maps config -->
    <script>
        const mapsConfigScript = document.createElement('script');
        mapsConfigScript.src = '../config/google-maps-config.js';
        mapsConfigScript.onerror = function() {
            const fallbackScript = document.createElement('script');
            fallbackScript.src = 'https://raw.githubusercontent.com/VitaraDragon/gfv-platform/main/core/config/google-maps-config.js';
            document.head.appendChild(fallbackScript);
        };
        document.head.appendChild(mapsConfigScript);
    </script>

    <script type="module">
        // Import Firebase modules (devono essere al top-level)
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, getDocs, doc, getDoc, addDoc, updateDoc, query, where, orderBy, serverTimestamp, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Carica Firebase config
        let firebaseConfig = {};
        try {
            const configScript = document.createElement('script');
            configScript.src = '../config/firebase-config.js';
            configScript.onload = () => {
                if (window.firebaseConfig) {
                    firebaseConfig = window.firebaseConfig;
                    initApp();
                }
            };
            configScript.onerror = () => {
                const fallbackScript = document.createElement('script');
                fallbackScript.src = 'https://raw.githubusercontent.com/VitaraDragon/gfv-platform/main/core/config/firebase-config.js';
                document.head.appendChild(fallbackScript);
            };
            document.head.appendChild(configScript);
        } catch (e) {
            console.error('Errore caricamento config:', e);
        }

        async function initApp() {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);

            let currentUser = null;
            let currentTenantId = null;
            let macchineList = [];
            let lavoriList = [];
            let terreniMap = new Map(); // Mappa terreni per lookup rapido
            let guastiUnsubscribe = null;
            
            // Variabili mappa
            let problemaMap = null;
            let problemaMarker = null;
            let terrenoPolygon = null;
            let coordinateProblema = null; // {lat, lng}

            // Verifica autenticazione
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUser = user;
                    const userDoc = await getDoc(doc(db, 'users', user.uid));
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        currentTenantId = userData.tenantId;
                        
                        // Imposta tenantId nel tenant-service per i servizi
                        try {
                            const { setCurrentTenantId } = await import('../services/tenant-service.js');
                            setCurrentTenantId(currentTenantId);
                        } catch (error) {
                            console.warn('Impossibile impostare tenantId nel servizio:', error);
                        }
                        
                        // Assicura che Firebase sia inizializzato nei servizi
                        try {
                            const { setFirebaseInstances } = await import('../services/firebase-service.js');
                            setFirebaseInstances({ app, db, auth });
                        } catch (error) {
                            console.warn('Impossibile impostare Firebase instances nel servizio:', error);
                        }
                        
                        // Verifica ruolo operaio
                        const ruoli = userData.ruoli || [];
                        if (!ruoli.includes('operaio')) {
                            showAlert('Questa pagina è disponibile solo per operai.', 'error');
                            setTimeout(() => {
                                window.location.href = '../dashboard-standalone.html';
                            }, 3000);
                            return;
                        }

                        // Verifica modulo Parco Macchine
                        if (currentTenantId) {
                            try {
                                const tenantDoc = await getDoc(doc(db, 'tenants', currentTenantId));
                                if (tenantDoc.exists()) {
                                    const tenantData = tenantDoc.data();
                                    const hasParcoMacchine = tenantData.modules && tenantData.modules.includes('parcoMacchine');
                                    if (!hasParcoMacchine) {
                                        showAlert('Questa pagina è disponibile solo con il modulo Parco Macchine attivo.', 'error');
                                        setTimeout(() => {
                                            window.location.href = '../dashboard-standalone.html';
                                        }, 3000);
                                        return;
                                    }
                                }
                            } catch (error) {
                                console.warn('Errore verifica modulo:', error);
                            }
                        }

                        // Carica prima le macchine, poi i terreni, poi i lavori (per assicurarsi che i dropdown siano popolati)
                        await loadMacchine();
                        await loadTerreni(); // Carica terreni prima dei lavori
                        // Piccolo delay per assicurarsi che i dropdown siano completamente popolati
                        await new Promise(resolve => setTimeout(resolve, 100));
                        await loadLavori();
                        setupTipoGuastoToggle();
                        setupLavoroChangeHandler();
                        setupMapsButton();
                        await setupGuastiRealtime();
                    }
                } else {
                    window.location.href = '../auth/login-standalone.html';
                }
            });

            // Carica macchine
            async function loadMacchine() {
                try {
                    if (!currentTenantId) return;

                    const isFileProtocol = window.location.protocol === 'file:';
                    const macchinaSelect = document.getElementById('guasto-macchina');
                    const attrezzoSelect = document.getElementById('guasto-attrezzo');
                    
                    if (!macchinaSelect || !attrezzoSelect) return;
                    
                    macchinaSelect.innerHTML = '<option value="">-- Seleziona trattore --</option>';
                    attrezzoSelect.innerHTML = '<option value="">-- Nessun attrezzo --</option>';

                    if (isFileProtocol) {
                        // Fallback per ambiente file://
                        const macchineRef = collection(db, `tenants/${currentTenantId}/macchine`);
                        const snapshot = await getDocs(macchineRef);
                        
                        macchineList = [];
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            if (data.stato !== 'dismesso') {
                                macchineList.push({ id: doc.id, ...data });
                                const tipoMacchina = data.tipoMacchina || data.tipo || '';
                                
                                if (tipoMacchina === 'trattore') {
                                    const option = document.createElement('option');
                                    option.value = doc.id;
                                    option.textContent = `🚜 ${data.nome || 'Trattore senza nome'}`;
                                    macchinaSelect.appendChild(option);
                                } else if (tipoMacchina === 'attrezzo') {
                                    const option = document.createElement('option');
                                    option.value = doc.id;
                                    option.textContent = `⚙️ ${data.nome || 'Attrezzo senza nome'}`;
                                    attrezzoSelect.appendChild(option);
                                }
                            }
                        });
                    } else {
                        // Usa servizio centralizzato
                        try {
                            // Assicura che Firebase sia inizializzato nei servizi
                            const { setFirebaseInstances } = await import('../services/firebase-service.js');
                            setFirebaseInstances({ app, db, auth });
                            
                            // Assicura che il tenantId sia impostato nel servizio
                            const { setCurrentTenantId } = await import('../services/tenant-service.js');
                            if (currentTenantId) {
                                setCurrentTenantId(currentTenantId);
                            }
                            
                            // Usa servizio centralizzato
                            const { getAllMacchine } = await import('../../../modules/parco-macchine/services/macchine-service.js');
                            let macchine = await getAllMacchine({
                                // Non usiamo soloAttive per evitare problemi con indice Firestore
                                // Filtriamo lato client invece
                                orderBy: 'nome',
                                orderDirection: 'asc'
                            });
                            
                            // Filtra lato client: solo macchine non dismesse
                            macchine = macchine.filter(m => m.stato !== 'dismesso');
                            
                            // Converti in formato compatibile con codice esistente
                            macchineList = macchine.map(m => ({
                                id: m.id,
                                nome: m.nome,
                                tipoMacchina: m.tipoMacchina || m.tipo,
                                tipo: m.tipo || m.tipoMacchina, // Retrocompatibilità
                                stato: m.stato,
                                cavalli: m.cavalli,
                                cavalliMinimiRichiesti: m.cavalliMinimiRichiesti,
                                categoriaFunzione: m.categoriaFunzione,
                                ...(m.toFirestore ? m.toFirestore() : m)
                            }));
                            
                            // Popola dropdown
                            macchineList.forEach(macchina => {
                                const tipoMacchina = macchina.tipoMacchina || macchina.tipo || '';
                                
                                if (tipoMacchina === 'trattore') {
                                    const option = document.createElement('option');
                                    option.value = macchina.id;
                                    option.textContent = `🚜 ${macchina.nome || 'Trattore senza nome'}`;
                                    macchinaSelect.appendChild(option);
                                } else if (tipoMacchina === 'attrezzo') {
                                    const option = document.createElement('option');
                                    option.value = macchina.id;
                                    option.textContent = `⚙️ ${macchina.nome || 'Attrezzo senza nome'}`;
                                    attrezzoSelect.appendChild(option);
                                }
                            });
                        } catch (error) {
                            console.error('Errore caricamento macchine dal servizio:', error);
                            // Fallback: carica direttamente da Firestore
                            const macchineRef = collection(db, `tenants/${currentTenantId}/macchine`);
                            const snapshot = await getDocs(macchineRef);
                            macchineList = [];
                            snapshot.forEach(doc => {
                                const data = doc.data();
                                if (data.stato !== 'dismesso') {
                                    macchineList.push({ id: doc.id, ...data });
                                    const tipoMacchina = data.tipoMacchina || data.tipo || '';
                                    
                                    if (tipoMacchina === 'trattore') {
                                        const option = document.createElement('option');
                                        option.value = doc.id;
                                        option.textContent = `🚜 ${data.nome || 'Trattore senza nome'}`;
                                        macchinaSelect.appendChild(option);
                                    } else if (tipoMacchina === 'attrezzo') {
                                        const option = document.createElement('option');
                                        option.value = doc.id;
                                        option.textContent = `⚙️ ${data.nome || 'Attrezzo senza nome'}`;
                                        attrezzoSelect.appendChild(option);
                                    }
                                }
                            });
                        }
                    }
                } catch (error) {
                    console.error('Errore caricamento macchine:', error);
                    showAlert('Errore caricamento macchine', 'error');
                }
            }

            // Carica terreni per lookup rapido
            async function loadTerreni() {
                try {
                    if (!currentTenantId) return;

                    const terreniRef = collection(db, `tenants/${currentTenantId}/terreni`);
                    const snapshot = await getDocs(terreniRef);
                    
                    terreniMap.clear();
                    snapshot.forEach(doc => {
                        terreniMap.set(doc.id, { id: doc.id, ...doc.data() });
                    });
                } catch (error) {
                    console.error('Errore caricamento terreni:', error);
                }
            }

            // Carica lavori attivi dell'operaio e pre-seleziona macchina/attrezzo
            async function loadLavori() {
                try {
                    if (!currentTenantId || !currentUser) return;

                    const lavoriRef = collection(db, `tenants/${currentTenantId}/lavori`);
                    const snapshot = await getDocs(lavoriRef);
                    
                    lavoriList = [];
                    const lavoroSelect = document.getElementById('guasto-lavoro');
                    if (!lavoroSelect) return;
                    
                    lavoroSelect.innerHTML = '<option value="">-- Nessun lavoro associato --</option>';

                    let lavoroAttivoPiuRecente = null;
                    let dataLavoroPiuRecente = null;

                    // Carica anche i dati dell'utente per verificare se è caposquadra
                    let userDoc = null;
                    try {
                        userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                    } catch (e) {
                        console.warn('Errore caricamento dati utente:', e);
                    }
                    const userData = userDoc?.exists() ? userDoc.data() : null;
                    const isCaposquadra = userData?.ruolo === 'caposquadra' || (userData?.ruoli && userData.ruoli.includes('caposquadra'));

                    // Trova il caposquadra dell'operaio (se è operaio)
                    let caposquadraId = null;
                    if (!isCaposquadra) {
                        try {
                            const squadreRef = collection(db, `tenants/${currentTenantId}/squadre`);
                            const squadreSnapshot = await getDocs(squadreRef);
                            
                            squadreSnapshot.forEach(doc => {
                                const squadra = doc.data();
                                if (squadra.operai && squadra.operai.includes(currentUser.uid)) {
                                    caposquadraId = squadra.caposquadraId;
                                }
                            });
                        } catch (e) {
                            console.warn('Errore caricamento squadre:', e);
                        }
                    }

                    snapshot.forEach(doc => {
                        const lavoro = doc.data();
                        const stato = lavoro.stato || 'assegnato';
                        
                        // Considera attivi tutti i lavori che non sono completati/annullati
                        const isLavoroAttivo = stato !== 'completato' && stato !== 'annullato' && stato !== 'completato_da_approvare';
                        
                        // Cerca lavori assegnati direttamente all'operaio
                        const isAssegnatoDirettamente = lavoro.operaioId === currentUser.uid && !lavoro.caposquadraId;
                        
                        // Cerca lavori assegnati tramite caposquadra (se l'operaio fa parte di una squadra)
                        const isAssegnatoTramiteCaposquadra = caposquadraId && lavoro.caposquadraId === caposquadraId && !lavoro.operaioId;
                        
                        // Se è caposquadra, mostra anche i lavori assegnati direttamente a lui
                        const isLavoroCaposquadra = isCaposquadra && lavoro.caposquadraId === currentUser.uid && !lavoro.operaioId;
                        
                        if (isLavoroAttivo && (isAssegnatoDirettamente || isAssegnatoTramiteCaposquadra || isLavoroCaposquadra)) {
                            const lavoroData = { id: doc.id, ...lavoro };
                            lavoriList.push(lavoroData);
                            
                            const option = document.createElement('option');
                            option.value = doc.id;
                            let tipoAssegnazione = '';
                            if (isAssegnatoDirettamente) {
                                tipoAssegnazione = ' (Autonomo)';
                            } else if (isAssegnatoTramiteCaposquadra || isLavoroCaposquadra) {
                                tipoAssegnazione = ' (Squadra)';
                            }
                            option.textContent = (lavoro.nome || `Lavoro ${doc.id}`) + tipoAssegnazione;
                            lavoroSelect.appendChild(option);

                            // Trova il lavoro più recente (per pre-selezione)
                            // Usa createdAt se disponibile, altrimenti updatedAt, altrimenti dataInizio
                            let dataLavoro = new Date(0);
                            if (lavoro.createdAt) {
                                dataLavoro = lavoro.createdAt.toDate ? lavoro.createdAt.toDate() : new Date(lavoro.createdAt);
                            } else if (lavoro.updatedAt) {
                                dataLavoro = lavoro.updatedAt.toDate ? lavoro.updatedAt.toDate() : new Date(lavoro.updatedAt);
                            } else if (lavoro.dataInizio) {
                                dataLavoro = lavoro.dataInizio.toDate ? lavoro.dataInizio.toDate() : new Date(lavoro.dataInizio);
                            }
                            
                            if (!dataLavoroPiuRecente || dataLavoro > dataLavoroPiuRecente) {
                                dataLavoroPiuRecente = dataLavoro;
                                lavoroAttivoPiuRecente = lavoroData;
                            }
                        }
                    });

                    // Pre-seleziona macchina e attrezzo dal lavoro più recente
                    if (lavoroAttivoPiuRecente) {

                        // Pre-seleziona il lavoro nel dropdown
                        lavoroSelect.value = lavoroAttivoPiuRecente.id;
                        
                        // Pre-seleziona trattore se presente
                        if (lavoroAttivoPiuRecente.macchinaId) {
                            const macchinaSelect = document.getElementById('guasto-macchina');
                            if (macchinaSelect) {
                                // Verifica che l'opzione esista nel dropdown
                                const optionExists = Array.from(macchinaSelect.options).some(
                                    opt => opt.value === lavoroAttivoPiuRecente.macchinaId
                                );
                                if (optionExists) {
                                    macchinaSelect.value = lavoroAttivoPiuRecente.macchinaId;

                                } else {
                                    console.warn('Trattore non trovato nel dropdown:', lavoroAttivoPiuRecente.macchinaId);
                                }
                            }
                        }
                        
                        // Pre-seleziona attrezzo se presente
                        if (lavoroAttivoPiuRecente.attrezzoId) {
                            const attrezzoSelect = document.getElementById('guasto-attrezzo');
                            if (attrezzoSelect) {
                                // Verifica che l'opzione esista nel dropdown
                                const optionExists = Array.from(attrezzoSelect.options).some(
                                    opt => opt.value === lavoroAttivoPiuRecente.attrezzoId
                                );
                                if (optionExists) {
                                    attrezzoSelect.value = lavoroAttivoPiuRecente.attrezzoId;

                                } else {
                                    console.warn('Attrezzo non trovato nel dropdown:', lavoroAttivoPiuRecente.attrezzoId);
                                }
                            }
                        }
                        
                        // Pre-seleziona componente in base a trattore/attrezzo
                        updateComponenteDropdown();
                        
                        // Pre-compila ubicazione se c'è un terreno associato al lavoro
                        if (lavoroAttivoPiuRecente.terrenoId) {
                            const terreno = terreniMap.get(lavoroAttivoPiuRecente.terrenoId);
                            if (terreno) {
                                const ubicazioneInput = document.getElementById('guasto-ubicazione');
                                if (ubicazioneInput) {
                                    // Formatta: "Podere - Nome Terreno" o solo "Nome Terreno" se non c'è podere
                                    let ubicazione = '';
                                    if (terreno.podere && terreno.podere.trim()) {
                                        ubicazione = `${terreno.podere.trim()} - ${terreno.nome || 'Terreno senza nome'}`;
                                    } else {
                                        ubicazione = terreno.nome || 'Terreno senza nome';
                                    }
                                    ubicazioneInput.value = ubicazione;
                                }
                            }
                        }
                    } else {

                    }
                } catch (error) {
                    console.error('Errore caricamento lavori:', error);
                }
            }

            // Aggiorna dropdown componente in base a trattore/attrezzo selezionati
            function updateComponenteDropdown() {
                const macchinaSelect = document.getElementById('guasto-macchina');
                const attrezzoSelect = document.getElementById('guasto-attrezzo');
                const componenteSelect = document.getElementById('guasto-componente');
                
                if (!macchinaSelect || !attrezzoSelect || !componenteSelect) return;
                
                const macchinaId = macchinaSelect.value;
                const attrezzoId = attrezzoSelect.value;
                
                // Se c'è solo trattore, pre-seleziona "trattore"
                if (macchinaId && !attrezzoId) {
                    componenteSelect.value = 'trattore';
                }
                // Se c'è solo attrezzo, pre-seleziona "attrezzo"
                else if (!macchinaId && attrezzoId) {
                    componenteSelect.value = 'attrezzo';
                }
                // Se ci sono entrambi, pre-seleziona "entrambi" (ma l'utente può cambiare)
                else if (macchinaId && attrezzoId) {
                    if (!componenteSelect.value) {
                        componenteSelect.value = 'entrambi';
                    }
                }
                // Se non c'è né trattore né attrezzo, resetta
                else {
                    componenteSelect.value = '';
                }
            }

            // Gestione toggle tipo guasto (macchina/generico)
            function setupTipoGuastoToggle() {
                const tipoMacchina = document.getElementById('tipo-macchina');
                const tipoGenerico = document.getElementById('tipo-generico');
                const sezioneMacchina = document.getElementById('sezione-macchina');
                const sezioneGenerico = document.getElementById('sezione-generico');
                
                if (!tipoMacchina || !tipoGenerico || !sezioneMacchina || !sezioneGenerico) return;

                function updateFormVisibility() {
                    const isMacchina = tipoMacchina.checked;
                    const isGenerico = tipoGenerico.checked;

                    if (isMacchina) {
                        sezioneMacchina.style.display = 'block';
                        sezioneGenerico.style.display = 'none';
                        // Rendi obbligatori i campi macchina
                        document.getElementById('guasto-macchina').required = true;
                        document.getElementById('guasto-componente').required = true;
                        document.getElementById('guasto-ubicazione').required = false;
                        document.getElementById('guasto-tipo-problema').required = false;
                    } else if (isGenerico) {
                        sezioneMacchina.style.display = 'none';
                        sezioneGenerico.style.display = 'block';
                        // Rendi obbligatori i campi generico
                        document.getElementById('guasto-macchina').required = false;
                        document.getElementById('guasto-componente').required = false;
                        document.getElementById('guasto-ubicazione').required = true;
                        document.getElementById('guasto-tipo-problema').required = true;
                        
                        // Pre-compila ubicazione se c'è un lavoro selezionato
                        const lavoroSelect = document.getElementById('guasto-lavoro');
                        const ubicazioneInput = document.getElementById('guasto-ubicazione');
                        if (lavoroSelect && ubicazioneInput && lavoroSelect.value && !ubicazioneInput.value) {
                            const lavoro = lavoriList.find(l => l.id === lavoroSelect.value);
                            if (lavoro && lavoro.terrenoId) {
                                const terreno = terreniMap.get(lavoro.terrenoId);
                                if (terreno) {
                                    // Formatta: "Podere - Nome Terreno" o solo "Nome Terreno" se non c'è podere
                                    let ubicazione = '';
                                    if (terreno.podere && terreno.podere.trim()) {
                                        ubicazione = `${terreno.podere.trim()} - ${terreno.nome || 'Terreno senza nome'}`;
                                    } else {
                                        ubicazione = terreno.nome || 'Terreno senza nome';
                                    }
                                    ubicazioneInput.value = ubicazione;
                                }
                            }
                        }
                        
                        // Inizializza mappa quando si passa a generico
                        // Piccolo delay per assicurarsi che il container sia visibile
                        setTimeout(() => {
                            initProblemaMap();
                        }, 100);
                    }
                }

                tipoMacchina.addEventListener('change', updateFormVisibility);
                tipoGenerico.addEventListener('change', updateFormVisibility);
                
                // Inizializza
                updateFormVisibility();
            }

            // Aggiorna ubicazione quando cambia il lavoro selezionato (solo se tipo generico)
            function setupLavoroChangeHandler() {
                const lavoroSelect = document.getElementById('guasto-lavoro');
                if (!lavoroSelect) return;

                lavoroSelect.addEventListener('change', () => {
                    const tipoGuasto = document.querySelector('input[name="tipoGuasto"]:checked')?.value;
                    const ubicazioneInput = document.getElementById('guasto-ubicazione');
                    
                    // Aggiorna ubicazione solo se tipo generico e c'è un lavoro selezionato
                    if (tipoGuasto === 'generico' && ubicazioneInput && lavoroSelect.value) {
                        const lavoro = lavoriList.find(l => l.id === lavoroSelect.value);
                        if (lavoro && lavoro.terrenoId) {
                            const terreno = terreniMap.get(lavoro.terrenoId);
                            if (terreno) {
                                // Formatta: "Podere - Nome Terreno" o solo "Nome Terreno" se non c'è podere
                                let ubicazione = '';
                                if (terreno.podere && terreno.podere.trim()) {
                                    ubicazione = `${terreno.podere.trim()} - ${terreno.nome || 'Terreno senza nome'}`;
                                } else {
                                    ubicazione = terreno.nome || 'Terreno senza nome';
                                }
                                ubicazioneInput.value = ubicazione;
                            }
                        }
                        
                        // Reinizializza mappa quando cambia il lavoro (se tipo generico)
                        // Reset marker
                        coordinateProblema = null;
                        if (problemaMarker) {
                            problemaMarker.setMap(null);
                            problemaMarker = null;
                        }
                        if (terrenoPolygon) {
                            terrenoPolygon.setMap(null);
                            terrenoPolygon = null;
                        }
                        // Reinizializza mappa
                        setTimeout(() => {
                            initProblemaMap();
                        }, 100);
                    }
                });
            }

            // Inizializza mappa per localizzazione problema
            async function initProblemaMap() {
                const mapContainer = document.getElementById('map-container');
                if (!mapContainer) return;

                // Attendi che la config sia caricata
                let attempts = 0;
                while (typeof window.GOOGLE_MAPS_API_KEY === 'undefined' && attempts < 50) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }

                const apiKey = window.GOOGLE_MAPS_API_KEY;
                if (!apiKey || apiKey === 'YOUR_GOOGLE_MAPS_API_KEY_HERE') {
                    mapContainer.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #d32f2f;">Google Maps API key non configurata</div>';
                    return;
                }

                // Carica Google Maps API se non già caricata
                if (typeof google === 'undefined' || !google.maps) {
                    mapContainer.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666;">Caricamento Google Maps...</div>';
                    
                    return new Promise((resolve) => {
                        // Verifica se lo script è già stato aggiunto
                        if (document.querySelector('script[src*="maps.googleapis.com"]')) {
                            // Aspetta che Google Maps sia completamente caricato
                            const checkInterval = setInterval(() => {
                                if (typeof google !== 'undefined' && google.maps && google.maps.Map && google.maps.MapTypeId && google.maps.Marker && google.maps.Polygon) {
                                    clearInterval(checkInterval);
                                    // Piccolo delay per assicurarsi che tutto sia pronto
                                    setTimeout(() => {
                                        initProblemaMapImplementation();
                                        resolve();
                                    }, 200);
                                }
                            }, 100);
                            setTimeout(() => {
                                clearInterval(checkInterval);
                                if (typeof google === 'undefined' || !google.maps || !google.maps.Map) {
                                    mapContainer.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #d32f2f;">Timeout caricamento Google Maps</div>';
                                } else {
                                    // Prova comunque se è parzialmente caricato
                                    setTimeout(() => {
                                        initProblemaMapImplementation();
                                    }, 200);
                                }
                                resolve();
                            }, 10000);
                            return;
                        }

                        // Crea callback globale per inizializzazione
                        window.initProblemaMapCallback = function() {
                            // Piccolo delay per assicurarsi che tutto sia pronto
                            setTimeout(() => {
                                if (typeof google !== 'undefined' && google.maps && google.maps.Map && google.maps.MapTypeId) {
                                    initProblemaMapImplementation();
                                    resolve();
                                } else {
                                    mapContainer.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #d32f2f;">Errore inizializzazione Google Maps</div>';
                                    resolve();
                                }
                            }, 200);
                        };

                        const script = document.createElement('script');
                        script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=geometry&callback=initProblemaMapCallback`;
                        script.async = true;
                        script.defer = true;
                        
                        script.onerror = () => {
                            mapContainer.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #d32f2f;">Errore caricamento Google Maps</div>';
                            resolve();
                        };
                        
                        script.onerror = () => {
                            mapContainer.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #d32f2f;">Errore caricamento Google Maps</div>';
                            resolve();
                        };
                        
                        document.head.appendChild(script);
                    });
                } else {
                    // Verifica che sia completamente inizializzato
                    if (google.maps && google.maps.Map && google.maps.MapTypeId) {
                        initProblemaMapImplementation();
                    } else {
                        // Aspetta che sia pronto
                        const checkInterval = setInterval(() => {
                            if (typeof google !== 'undefined' && google.maps && google.maps.Map && google.maps.MapTypeId) {
                                clearInterval(checkInterval);
                                initProblemaMapImplementation();
                            }
                        }, 50);
                        setTimeout(() => {
                            clearInterval(checkInterval);
                        }, 5000);
                    }
                }
            }

            // Implementazione effettiva della mappa
            function initProblemaMapImplementation() {
                const mapContainer = document.getElementById('map-container');
                if (!mapContainer) return;

                // Verifica che Google Maps sia completamente caricato
                if (typeof google === 'undefined' || !google.maps || !google.maps.Map || !google.maps.MapTypeId) {
                    mapContainer.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #d32f2f;">Google Maps non disponibile. Attendi qualche secondo e riprova.</div>';
                    return;
                }

                // Pulisci contenitore
                mapContainer.innerHTML = '';

                const lavoroSelect = document.getElementById('guasto-lavoro');
                let center = { lat: 44.4949, lng: 11.3426 }; // Default: Bologna
                let zoom = 15;
                let terreno = null;

                // Cerca terreno dal lavoro selezionato
                if (lavoroSelect && lavoroSelect.value) {
                    const lavoro = lavoriList.find(l => l.id === lavoroSelect.value);
                    if (lavoro && lavoro.terrenoId) {
                        terreno = terreniMap.get(lavoro.terrenoId);
                        if (terreno) {
                            // Usa coordinate terreno se disponibili
                            if (terreno.coordinate) {
                                const coord = terreno.coordinate;
                                if (coord.lat !== undefined && coord.lng !== undefined) {
                                    center = { lat: coord.lat, lng: coord.lng };
                                } else if (coord._lat !== undefined && coord._long !== undefined) {
                                    center = { lat: coord._lat, lng: coord._long };
                                }
                            }
                        }
                    }
                }

                // Verifica che Google Maps sia completamente inizializzato
                if (!google.maps.Map || !google.maps.MapTypeId || !google.maps.Marker || !google.maps.Polygon) {
                    mapContainer.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #d32f2f;">Google Maps non completamente caricato. Attendi qualche secondo.</div>';
                    return;
                }

                // Inizializza mappa
                problemaMap = new google.maps.Map(mapContainer, {
                    zoom: zoom,
                    center: center,
                    mapTypeId: google.maps.MapTypeId.SATELLITE,
                    disableDefaultUI: false,
                    clickableIcons: false // Disabilita click su POI (punti di interesse)
                });

                // Imposta cursore crosshair sulla mappa
                if (mapContainer) {
                    mapContainer.style.cursor = 'crosshair';
                }

                // Listener click sulla mappa per posizionare marker (PRIMA del poligono)
                console.log('🔧 Registrazione listener click sulla mappa...');
                problemaMap.addListener('click', (event) => {
                    console.log('🗺️ Click sulla mappa ricevuto!', event.latLng);
                    const lat = event.latLng.lat();
                    const lng = event.latLng.lng();
                    coordinateProblema = { lat, lng };

                    // Rimuovi marker precedente se esiste
                    if (problemaMarker) {
                        problemaMarker.setMap(null);
                        problemaMarker = null;
                    }

                    // Crea nuovo marker
                    try {
                        problemaMarker = new google.maps.Marker({
                            position: { lat, lng },
                            map: problemaMap,
                            draggable: true,
                            title: 'Posizione del problema - Trascina per spostare',
                            animation: google.maps.Animation.DROP,
                            icon: {
                                url: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png',
                                scaledSize: new google.maps.Size(40, 40)
                            },
                            zIndex: 1000 // Sopra il poligono
                        });
                        console.log('✅ Marker creato con successo!');
                    } catch (error) {
                        console.error('❌ Errore creazione marker:', error);
                        showAlert('Errore posizionamento marker: ' + error.message, 'error');
                        return;
                    }

                    // Aggiorna status
                    const markerStatus = document.getElementById('marker-status');
                    if (markerStatus) {
                        markerStatus.innerHTML = `✅ Marker posizionato! Coordinate: ${lat.toFixed(6)}, ${lng.toFixed(6)} - <strong>Trascina il marker per precisione</strong>`;
                        markerStatus.style.color = '#28a745';
                    }

                    // Listener per drag marker
                    problemaMarker.addListener('dragstart', () => {
                        const markerStatus = document.getElementById('marker-status');
                        if (markerStatus) {
                            markerStatus.innerHTML = '🔄 Trascinando marker...';
                            markerStatus.style.color = '#ffc107';
                        }
                    });

                    problemaMarker.addListener('dragend', (event) => {
                        coordinateProblema = {
                            lat: event.latLng.lat(),
                            lng: event.latLng.lng()
                        };
                        const markerStatus = document.getElementById('marker-status');
                        if (markerStatus) {
                            markerStatus.innerHTML = `✅ Marker aggiornato! Coordinate: ${coordinateProblema.lat.toFixed(6)}, ${coordinateProblema.lng.toFixed(6)}`;
                            markerStatus.style.color = '#28a745';
                        }
                    });

                    // Info window sul marker
                    const infoWindow = new google.maps.InfoWindow({
                        content: `
                            <div style="padding: 5px;">
                                <strong>📍 Posizione problema</strong><br>
                                Lat: ${lat.toFixed(6)}<br>
                                Lng: ${lng.toFixed(6)}<br>
                                <small>Trascina per spostare</small>
                            </div>
                        `
                    });

                    problemaMarker.addListener('click', () => {
                        infoWindow.open(problemaMap, problemaMarker);
                    });
                });

                // Assicura che il cursore sia sempre crosshair sulla mappa
                // Usa getDiv() per ottenere il div della mappa
                const mapDiv = problemaMap.getDiv();
                if (mapDiv) {
                    mapDiv.style.cursor = 'crosshair';
                    
                    // Listener per mantenere crosshair anche quando si passa sopra controlli
                    mapDiv.addEventListener('mouseenter', () => {
                        mapDiv.style.cursor = 'crosshair';
                    });
                }

                // Disegna confini terreno se disponibili (DOPO il listener click)
                if (terreno && terreno.polygonCoords && terreno.polygonCoords.length > 0) {
                    const terrenoCoords = terreno.polygonCoords.map(c => {
                        if (typeof c === 'object' && c !== null) {
                            return new google.maps.LatLng(
                                c.lat !== undefined ? c.lat : (Array.isArray(c) ? c[0] : center.lat),
                                c.lng !== undefined ? c.lng : (Array.isArray(c) ? c[1] : center.lng)
                            );
                        } else if (Array.isArray(c)) {
                            return new google.maps.LatLng(c[0] || center.lat, c[1] || center.lng);
                        }
                        return new google.maps.LatLng(center.lat, center.lng);
                    });

                    terrenoPolygon = new google.maps.Polygon({
                        paths: terrenoCoords,
                        strokeColor: '#FF0000',
                        strokeOpacity: 0.8,
                        strokeWeight: 3,
                        fillColor: '#FF0000',
                        fillOpacity: 0.1,
                        map: problemaMap,
                        clickable: false, // ⭐ IMPORTANTE: non intercettare i click
                        zIndex: 1 // Sotto il marker
                    });

                    // Adatta zoom ai confini del terreno
                    const bounds = new google.maps.LatLngBounds();
                    terrenoCoords.forEach(coord => bounds.extend(coord));
                    problemaMap.fitBounds(bounds);
                    console.log('✅ Poligono terreno disegnato (clickable: false)');
                }

                console.log('✅ Mappa inizializzata, listener click attivo. Clicca sulla mappa per posizionare il marker!');
            }

            // Setup pulsante Google Maps
            function setupMapsButton() {
                const btnMaps = document.getElementById('btn-apri-maps');
                if (!btnMaps) return;

                btnMaps.addEventListener('click', () => {
                    const ubicazioneInput = document.getElementById('guasto-ubicazione');
                    const lavoroSelect = document.getElementById('guasto-lavoro');
                    
                    if (!ubicazioneInput) return;

                    let mapsUrl = '';
                    let hasCoordinates = false;

                    // Priorità 1: Coordinate del marker se posizionato
                    if (coordinateProblema) {
                        mapsUrl = `https://www.google.com/maps?q=${coordinateProblema.lat},${coordinateProblema.lng}`;
                        hasCoordinates = true;
                    }
                    // Priorità 2: Coordinate del terreno se c'è un lavoro selezionato
                    else if (lavoroSelect && lavoroSelect.value) {
                        const lavoro = lavoriList.find(l => l.id === lavoroSelect.value);
                        if (lavoro && lavoro.terrenoId) {
                            const terreno = terreniMap.get(lavoro.terrenoId);
                            if (terreno && terreno.coordinate) {
                                const coord = terreno.coordinate;
                                let lat, lng;
                                
                                if (typeof coord === 'object') {
                                    if (coord.lat !== undefined && coord.lng !== undefined) {
                                        lat = coord.lat;
                                        lng = coord.lng;
                                    } else if (coord.latitude !== undefined && coord.longitude !== undefined) {
                                        lat = coord.latitude;
                                        lng = coord.longitude;
                                    } else if (coord._lat !== undefined && coord._long !== undefined) {
                                        lat = coord._lat;
                                        lng = coord._long;
                                    }
                                }
                                
                                if (lat !== undefined && lng !== undefined) {
                                    mapsUrl = `https://www.google.com/maps?q=${lat},${lng}`;
                                    hasCoordinates = true;
                                }
                            }
                        }
                    }

                    // Fallback: ricerca per testo
                    if (!hasCoordinates) {
                        const ubicazione = ubicazioneInput.value.trim();
                        if (ubicazione) {
                            mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(ubicazione)}`;
                        } else {
                            showAlert('Inserisci prima un\'ubicazione', 'error');
                            return;
                        }
                    }

                    if (mapsUrl) {
                        window.open(mapsUrl, '_blank');
                    }
                });
            }

            // Setup listener real-time per guasti
            function setupGuastiRealtime() {
                try {
                    if (!currentTenantId || !currentUser) return;

                    // Rimuovi listener precedente
                    if (guastiUnsubscribe) {
                        guastiUnsubscribe();
                        guastiUnsubscribe = null;
                    }

                    const guastiRef = collection(db, `tenants/${currentTenantId}/guasti`);
                    
                    // Usa direttamente la collection senza query filtrata per evitare errori indice
                    // Filtriamo e ordiniamo in memoria
                    guastiUnsubscribe = onSnapshot(
                        guastiRef,
                        (snapshot) => {
                            // Filtra per operaio corrente e ordina per data segnalazione
                            const filtered = snapshot.docs
                                .filter(doc => {
                                    const data = doc.data();
                                    return data.segnalatoDa === currentUser.uid;
                                })
                                .sort((a, b) => {
                                    const dateA = a.data().segnalatoIl?.toDate 
                                        ? a.data().segnalatoIl.toDate() 
                                        : new Date(a.data().segnalatoIl || 0);
                                    const dateB = b.data().segnalatoIl?.toDate 
                                        ? b.data().segnalatoIl.toDate() 
                                        : new Date(b.data().segnalatoIl || 0);
                                    return dateB - dateA; // Più recente prima
                                });
                            
                            renderGuasti({ docs: filtered });
                        },
                        (error) => {
                            // Solo logga se non è un errore di indice
                            if (!error.message || !error.message.includes('index')) {
                                console.error('Errore listener guasti:', error);
                            }
                        }
                    );
                } catch (error) {
                    console.error('Errore setup listener guasti:', error);
                }
            }

            // Render guasti
            function renderGuasti(snapshot) {
                const container = document.getElementById('guasti-list');
                
                if (snapshot.docs.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">✅</div>
                            <p>Nessun guasto segnalato</p>
                        </div>
                    `;
                    return;
                }

                let html = '';
                snapshot.docs.forEach(doc => {
                    const guasto = { id: doc.id, ...doc.data() };
                    const tipoGuasto = guasto.tipoGuasto || 'macchina'; // Default per retrocompatibilità
                    
                    let titolo = '';
                    let tipoIcon = '❓';
                    let tipoBadge = '';
                    
                    if (tipoGuasto === 'generico') {
                        // Segnalazione generica
                        tipoIcon = '🌍';
                        tipoBadge = '<span class="guasto-badge" style="background: #17a2b8; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">🌍 Generico</span>';
                        titolo = `${guasto.tipoProblema || 'Segnalazione'} - ${guasto.ubicazione || 'Ubicazione non specificata'}`;
                    } else {
                        // Guasto macchina (logica esistente)
                        tipoBadge = '<span class="guasto-badge" style="background: #6c757d; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">🔧 Macchina</span>';
                        const componenteGuasto = guasto.componenteGuasto || 'trattore'; // Default per retrocompatibilità
                        let macchinaNome = '';
                        
                        if (componenteGuasto === 'trattore' && guasto.macchinaId) {
                            const macchina = macchineList.find(m => m.id === guasto.macchinaId);
                            if (macchina) {
                                macchinaNome = `🚜 ${macchina.nome}`;
                                tipoIcon = '🚜';
                            }
                        } else if (componenteGuasto === 'attrezzo' && guasto.attrezzoId) {
                            const attrezzo = macchineList.find(m => m.id === guasto.attrezzoId);
                            if (attrezzo) {
                                macchinaNome = `⚙️ ${attrezzo.nome}`;
                                tipoIcon = '⚙️';
                            }
                        } else if (componenteGuasto === 'entrambi') {
                            // Mostra entrambi
                            if (guasto.macchinaId) {
                                const macchina = macchineList.find(m => m.id === guasto.macchinaId);
                                if (macchina) {
                                    macchinaNome = `🚜 ${macchina.nome}`;
                                }
                            }
                            if (guasto.attrezzoId) {
                                const attrezzo = macchineList.find(m => m.id === guasto.attrezzoId);
                                if (attrezzo) {
                                    if (macchinaNome) {
                                        macchinaNome += ` + ⚙️ ${attrezzo.nome}`;
                                    } else {
                                        macchinaNome = `⚙️ ${attrezzo.nome}`;
                                    }
                                }
                            }
                            tipoIcon = '🚜⚙️';
                        } else {
                            // Fallback per dati legacy senza componenteGuasto
                            if (guasto.macchinaId) {
                                const macchina = macchineList.find(m => m.id === guasto.macchinaId);
                                if (macchina) {
                                    macchinaNome = `🚜 ${macchina.nome}`;
                                    tipoIcon = '🚜';
                                }
                            }
                            if (guasto.attrezzoId) {
                                const attrezzo = macchineList.find(m => m.id === guasto.attrezzoId);
                                if (attrezzo) {
                                    if (macchinaNome) {
                                        macchinaNome += ` + ⚙️ ${attrezzo.nome}`;
                                    } else {
                                        macchinaNome = `⚙️ ${attrezzo.nome}`;
                                        tipoIcon = '⚙️';
                                    }
                                }
                            }
                        }
                        
                        if (!macchinaNome) {
                            macchinaNome = 'Macchina non trovata';
                        }
                        titolo = macchinaNome;
                    }

                    const stato = guasto.stato || 'in-attesa';
                    const gravitaBadge = guasto.gravita === 'grave' 
                        ? '<span class="guasto-badge badge-grave">🔴 Grave</span>'
                        : '<span class="guasto-badge badge-non-grave">🟡 Non grave</span>';

                    const statoBadge = stato === 'risolto'
                        ? '<span class="guasto-badge badge-risolto">✅ Risolto</span>'
                        : '<span class="guasto-badge badge-in-attesa">⏳ In attesa</span>';

                    const dataSegnalazione = guasto.segnalatoIl?.toDate 
                        ? guasto.segnalatoIl.toDate().toLocaleString('it-IT')
                        : new Date(guasto.segnalatoIl).toLocaleString('it-IT');

                    html += `
                        <div class="guasto-item ${stato === 'risolto' ? 'risolto' : stato === 'approvato-continuazione' ? 'in-attesa' : ''}">
                            <div class="guasto-header">
                                <div class="guasto-title">${tipoIcon} ${titolo}</div>
                                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                    ${tipoBadge}
                                    ${gravitaBadge}
                                    ${statoBadge}
                                </div>
                            </div>
                            <div class="guasto-details">
                                ${tipoGuasto === 'generico' ? `
                                    <div><strong>Ubicazione:</strong> ${guasto.ubicazione || '-'}</div>
                                    <div><strong>Tipo problema:</strong> ${guasto.tipoProblema || '-'}</div>
                                ` : ''}
                                <div><strong>Dettagli:</strong> ${guasto.dettagli || '-'}</div>
                                <div><strong>Segnalato il:</strong> ${dataSegnalazione}</div>
                                ${guasto.stato === 'risolto' ? `
                                    <div><strong>Risolto il:</strong> ${guasto.risoltoIl?.toDate ? guasto.risoltoIl.toDate().toLocaleString('it-IT') : '-'}</div>
                                    <div><strong>Note risoluzione:</strong> ${guasto.noteRisoluzione || '-'}</div>
                                    ${guasto.costoRiparazione ? `<div><strong>Costo riparazione:</strong> €${guasto.costoRiparazione.toFixed(2)}</div>` : ''}
                                ` : ''}
                                ${guasto.stato === 'approvato-continuazione' ? `
                                    <div style="color: #856404; font-weight: 600; margin-top: 10px;">
                                        ✅ Continuazione approvata - Puoi continuare a lavorare
                                    </div>
                                ` : ''}
                                ${guasto.stato === 'sospeso' ? `
                                    <div style="color: #dc3545; font-weight: 600; margin-top: 10px;">
                                        ⛔ Lavoro sospeso dal Manager
                                    </div>
                                ` : ''}
                            </div>
                            ${stato !== 'risolto' ? `
                                <div class="guasto-actions">
                                    <button class="btn btn-success" onclick="openRisolviModal('${guasto.id}')">
                                        ✅ Risolvi ${tipoGuasto === 'generico' ? 'Segnalazione' : 'Guasto'}
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });

                container.innerHTML = html;
            }

            // Gestione form segnala guasto
            document.getElementById('segnala-guasto-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const tipoGuasto = document.querySelector('input[name="tipoGuasto"]:checked')?.value;
                const macchinaId = document.getElementById('guasto-macchina').value;
                const attrezzoId = document.getElementById('guasto-attrezzo').value || null;
                const componenteGuasto = document.getElementById('guasto-componente').value;
                const gravita = document.querySelector('input[name="gravita"]:checked')?.value;
                const dettagli = document.getElementById('guasto-dettagli').value.trim();
                const lavoroId = document.getElementById('guasto-lavoro').value || null;
                const ubicazione = document.getElementById('guasto-ubicazione')?.value.trim() || null;
                const tipoProblema = document.getElementById('guasto-tipo-problema')?.value || null;

                // Validazione base
                if (!tipoGuasto || !gravita || !dettagli) {
                    showAlert('Compila tutti i campi obbligatori', 'error');
                    return;
                }

                // Validazione guasto macchina
                if (tipoGuasto === 'macchina') {
                    if (!componenteGuasto) {
                        showAlert('Seleziona il componente con il guasto', 'error');
                        return;
                    }
                    // Validazione componente vs selezione macchina/attrezzo
                    if (componenteGuasto === 'trattore' && !macchinaId) {
                        showAlert('Devi selezionare un trattore se il guasto è del trattore', 'error');
                        return;
                    }
                    if (componenteGuasto === 'attrezzo' && !attrezzoId) {
                        showAlert('Devi selezionare un attrezzo se il guasto è dell\'attrezzo', 'error');
                        return;
                    }
                    if (componenteGuasto === 'entrambi' && (!macchinaId || !attrezzoId)) {
                        showAlert('Devi selezionare sia trattore che attrezzo se il guasto è di entrambi', 'error');
                        return;
                    }
                }

                // Validazione segnalazione generica
                if (tipoGuasto === 'generico') {
                    if (!ubicazione) {
                        showAlert('Inserisci l\'ubicazione del problema', 'error');
                        return;
                    }
                    if (!tipoProblema) {
                        showAlert('Seleziona il tipo di problema', 'error');
                        return;
                    }
                }

                try {
                    const guastoData = {
                        tipoGuasto, // 'macchina' | 'generico'
                        gravita,
                        dettagli,
                        lavoroId,
                        segnalatoDa: currentUser.uid,
                        segnalatoIl: serverTimestamp(),
                        stato: 'in-attesa',
                        risolto: false
                    };

                    // Aggiungi campi specifici in base al tipo
                    if (tipoGuasto === 'macchina') {
                        guastoData.macchinaId = macchinaId || null;
                        guastoData.attrezzoId = attrezzoId;
                        guastoData.componenteGuasto = componenteGuasto;
                    } else if (tipoGuasto === 'generico') {
                        guastoData.macchinaId = null;
                        guastoData.attrezzoId = null;
                        guastoData.componenteGuasto = null;
                        guastoData.ubicazione = ubicazione;
                        guastoData.tipoProblema = tipoProblema;
                        // Aggiungi coordinate problema se marker posizionato
                        if (coordinateProblema) {
                            guastoData.coordinateProblema = coordinateProblema;
                        }
                    }

                    await addDoc(collection(db, `tenants/${currentTenantId}/guasti`), guastoData);

                    // Aggiorna stato macchine SOLO se è un guasto macchina
                    if (tipoGuasto === 'macchina') {
                        // Aggiorna stato trattore solo se il guasto è del trattore o di entrambi
                        if (macchinaId && (componenteGuasto === 'trattore' || componenteGuasto === 'entrambi')) {
                            const macchinaRef = doc(db, `tenants/${currentTenantId}/macchine`, macchinaId);
                            const macchinaDoc = await getDoc(macchinaRef);
                            if (macchinaDoc.exists()) {
                                let nuovoStato = 'guasto';
                                if (gravita === 'non-grave') {
                                    nuovoStato = 'guasto-lavoro-in-corso';
                                }
                                await updateDoc(macchinaRef, {
                                    stato: nuovoStato
                                });
                            }
                        }

                        // Aggiorna stato attrezzo solo se il guasto è dell'attrezzo o di entrambi
                        if (attrezzoId && (componenteGuasto === 'attrezzo' || componenteGuasto === 'entrambi')) {
                            const attrezzoRef = doc(db, `tenants/${currentTenantId}/macchine`, attrezzoId);
                            const attrezzoDoc = await getDoc(attrezzoRef);
                            if (attrezzoDoc.exists()) {
                                let nuovoStato = 'guasto';
                                if (gravita === 'non-grave') {
                                    nuovoStato = 'guasto-lavoro-in-corso';
                                }
                                await updateDoc(attrezzoRef, {
                                    stato: nuovoStato
                                });
                            }
                        }
                    }

                    // Se guasto grave e c'è un lavoro associato, sospendi lavoro
                    if (gravita === 'grave' && lavoroId) {
                        const lavoroRef = doc(db, `tenants/${currentTenantId}/lavori`, lavoroId);
                        const motivoSospensione = tipoGuasto === 'macchina' 
                            ? 'Guasto macchina grave' 
                            : 'Segnalazione grave';
                        await updateDoc(lavoroRef, {
                            stato: 'sospeso',
                            motivoSospensione
                        });
                    }

                    showAlert('Segnalazione inviata con successo!', 'success');
                    document.getElementById('segnala-guasto-form').reset();
                    // Reset tipo a macchina
                    document.getElementById('tipo-macchina').checked = true;
                    // Reset mappa
                    coordinateProblema = null;
                    if (problemaMarker) {
                        problemaMarker.setMap(null);
                        problemaMarker = null;
                    }
                    if (terrenoPolygon) {
                        terrenoPolygon.setMap(null);
                        terrenoPolygon = null;
                    }
                    if (problemaMap) {
                        problemaMap = null;
                    }
                    setupTipoGuastoToggle();
                } catch (error) {
                    console.error('Errore segnalazione guasto:', error);
                    showAlert('Errore segnalazione: ' + error.message, 'error');
                }
            });

            // Funzioni globali per modal
            window.openRisolviModal = function(guastoId) {
                document.getElementById('risolvi-guasto-id').value = guastoId;
                document.getElementById('risolvi-modal').classList.add('show');
            };

            window.closeRisolviModal = function() {
                document.getElementById('risolvi-modal').classList.remove('show');
                document.getElementById('risolvi-guasto-form').reset();
            };

            // Gestione form risolvi guasto
            document.getElementById('risolvi-guasto-form').addEventListener('submit', async (e) => {
                e.preventDefault();

                const guastoId = document.getElementById('risolvi-guasto-id').value;
                const noteRisoluzione = document.getElementById('risolvi-note').value.trim();
                const costoRiparazione = parseFloat(document.getElementById('risolvi-costo').value) || null;

                if (!noteRisoluzione) {
                    showAlert('Inserisci le note di risoluzione', 'error');
                    return;
                }

                try {
                    const guastoRef = doc(db, `tenants/${currentTenantId}/guasti`, guastoId);
                    const guastoDoc = await getDoc(guastoRef);
                    
                    if (!guastoDoc.exists()) {
                        throw new Error('Guasto non trovato');
                    }

                    const guastoData = guastoDoc.data();
                    const tipoGuasto = guastoData.tipoGuasto || 'macchina'; // Default per retrocompatibilità
                    const updateData = {
                        stato: 'risolto',
                        risolto: true,
                        risoltoDa: currentUser.uid,
                        risoltoIl: serverTimestamp(),
                        noteRisoluzione
                    };

                    if (costoRiparazione !== null) {
                        updateData.costoRiparazione = costoRiparazione;
                    }

                    await updateDoc(guastoRef, updateData);

                    // Ripristina stato macchine SOLO se è un guasto macchina
                    if (tipoGuasto === 'macchina') {
                        const componenteGuasto = guastoData.componenteGuasto || 'trattore'; // Default per retrocompatibilità

                        // Ripristina stato trattore solo se il guasto era del trattore o di entrambi
                        if (guastoData.macchinaId && (componenteGuasto === 'trattore' || componenteGuasto === 'entrambi')) {
                            const macchinaRef = doc(db, `tenants/${currentTenantId}/macchine`, guastoData.macchinaId);
                            const macchinaDoc = await getDoc(macchinaRef);
                            if (macchinaDoc.exists()) {
                                const macchinaData = macchinaDoc.data();
                                // Ripristina stato precedente o disponibile
                                let nuovoStato = 'disponibile';
                                if (macchinaData.stato === 'guasto-lavoro-in-corso') {
                                    // Se era in uso prima del guasto, ripristina in uso
                                    nuovoStato = 'in-uso';
                                }

                                await updateDoc(macchinaRef, {
                                    stato: nuovoStato
                                });
                            }
                        }

                        // Ripristina stato attrezzo solo se il guasto era dell'attrezzo o di entrambi
                        if (guastoData.attrezzoId && (componenteGuasto === 'attrezzo' || componenteGuasto === 'entrambi')) {
                            const attrezzoRef = doc(db, `tenants/${currentTenantId}/macchine`, guastoData.attrezzoId);
                            const attrezzoDoc = await getDoc(attrezzoRef);
                            if (attrezzoDoc.exists()) {
                                const attrezzoData = attrezzoDoc.data();
                                // Ripristina stato precedente o disponibile
                                let nuovoStato = 'disponibile';
                                if (attrezzoData.stato === 'guasto-lavoro-in-corso') {
                                    // Se era in uso prima del guasto, ripristina in uso
                                    nuovoStato = 'in-uso';
                                }

                                await updateDoc(attrezzoRef, {
                                    stato: nuovoStato
                                });
                            }
                        }
                    }

                    // Se c'era un lavoro sospeso, riattivalo (il manager dovrà confermare)
                    if (guastoData.lavoroId) {
                        const lavoroRef = doc(db, `tenants/${currentTenantId}/lavori`, guastoData.lavoroId);
                        const lavoroDoc = await getDoc(lavoroRef);
                        if (lavoroDoc.exists()) {
                            const lavoroData = lavoroDoc.data();
                            const motivoSospensione = tipoGuasto === 'macchina' 
                                ? 'Guasto macchina grave' 
                                : 'Segnalazione grave';
                            if (lavoroData.stato === 'sospeso' && lavoroData.motivoSospensione === motivoSospensione) {
                                // Non riattiviamo automaticamente, il manager deve decidere
                                await updateDoc(lavoroRef, {
                                    motivoSospensione: `${tipoGuasto === 'macchina' ? 'Guasto' : 'Segnalazione'} risolto - In attesa riattivazione Manager`
                                });
                            }
                        }
                    }

                    const messaggio = tipoGuasto === 'macchina' 
                        ? 'Guasto risolto con successo! La macchina è ora disponibile.' 
                        : 'Segnalazione risolta con successo!';
                    showAlert(messaggio, 'success');
                    closeRisolviModal();
                } catch (error) {
                    console.error('Errore risoluzione guasto:', error);
                    showAlert('Errore risoluzione guasto: ' + error.message, 'error');
                }
            });

            // Chiudi modal cliccando fuori
            document.getElementById('risolvi-modal').addEventListener('click', (e) => {
                if (e.target.id === 'risolvi-modal') {
                    closeRisolviModal();
                }
            });

            // Funzione showAlert
            function showAlert(message, type) {
                const container = document.getElementById('alert-container');
                const alert = document.createElement('div');
                alert.className = `alert alert-${type} show`;
                alert.textContent = message;
                container.innerHTML = '';
                container.appendChild(alert);
                
                setTimeout(() => {
                    alert.classList.remove('show');
                    setTimeout(() => container.removeChild(alert), 300);
                }, 5000);
            }
        }
    </script>
</body>
</html>

