<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Statistiche Manodopera - GFV Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #2E8B57 0%, #228B22 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-secondary {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.3);
        }

        .content {
            display: grid;
            gap: 20px;
        }

        .stats-section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stats-section h2 {
            color: #2E8B57;
            font-size: 20px;
            margin-bottom: 25px;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 25px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #2E8B57;
        }

        .stat-value {
            font-size: 36px;
            font-weight: bold;
            color: #2E8B57;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>📊 Statistiche Manodopera</h1>
                <p style="opacity: 0.9; margin-top: 5px;">Visualizza statistiche e analisi dettagliate</p>
            </div>
            <a href="../dashboard-standalone.html" class="btn btn-secondary">← Dashboard</a>
        </div>

        <div class="content">
            <!-- Statistiche Lavori -->
            <div class="stats-section">
                <h2>📋 Statistiche Lavori</h2>
                <div class="stats-grid">
                    <div class="stat-card" style="background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white;">
                        <div class="stat-value" id="stat-lavori-totali" style="color: white;">-</div>
                        <div class="stat-label" style="color: rgba(255,255,255,0.9);">Lavori Totali</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white;">
                        <div class="stat-value" id="stat-lavori-attivi" style="color: white;">-</div>
                        <div class="stat-label" style="color: rgba(255,255,255,0.9);">Lavori Attivi</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%); color: white;">
                        <div class="stat-value" id="stat-lavori-completati" style="color: white;">-</div>
                        <div class="stat-label" style="color: rgba(255,255,255,0.9);">Lavori Completati</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%); color: white;">
                        <div class="stat-value" id="stat-lavori-pianificati" style="color: white;">-</div>
                        <div class="stat-label" style="color: rgba(255,255,255,0.9);">Lavori Pianificati</div>
                    </div>
                </div>
            </div>

            <!-- Statistiche Ore -->
            <div class="stats-section">
                <h2>⏱️ Statistiche Ore</h2>
                <div class="stats-grid">
                    <div class="stat-card" style="background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%); color: white;">
                        <div class="stat-value" id="stat-ore-validate-mese" style="color: white;">-</div>
                        <div class="stat-label" style="color: rgba(255,255,255,0.9);">Ore Validate (Mese)</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%); color: white;">
                        <div class="stat-value" id="stat-ore-validate-totale" style="color: white;">-</div>
                        <div class="stat-label" style="color: rgba(255,255,255,0.9);">Ore Validate (Totale)</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white;">
                        <div class="stat-value" id="stat-ore-da-validare" style="color: white;">-</div>
                        <div class="stat-label" style="color: rgba(255,255,255,0.9);">Ore da Validare</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%); color: white;">
                        <div class="stat-value" id="stat-media-ore-giorno" style="color: white;">-</div>
                        <div class="stat-label" style="color: rgba(255,255,255,0.9);">Media Ore/Giorno</div>
                    </div>
                </div>
            </div>

            <!-- Statistiche Squadre -->
            <div class="stats-section">
                <h2>👥 Statistiche Squadre</h2>
                <div class="stats-grid">
                    <div class="stat-card" style="background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white;">
                        <div class="stat-value" id="stat-squadre-totali" style="color: white;">-</div>
                        <div class="stat-label" style="color: rgba(255,255,255,0.9);">Squadre Totali</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%); color: white;">
                        <div class="stat-value" id="stat-squadre-attive" style="color: white;">-</div>
                        <div class="stat-label" style="color: rgba(255,255,255,0.9);">Squadre Attive</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white;">
                        <div class="stat-value" id="stat-operai-totali" style="color: white;">-</div>
                        <div class="stat-label" style="color: rgba(255,255,255,0.9);">Operai Totali</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%); color: white;">
                        <div class="stat-value" id="stat-operai-online" style="color: white;">-</div>
                        <div class="stat-label" style="color: rgba(255,255,255,0.9);">Operai Online</div>
                    </div>
                </div>
            </div>

            <!-- Statistiche Superficie -->
            <div class="stats-section">
                <h2>🗺️ Statistiche Superficie</h2>
                <div class="stats-grid">
                    <div class="stat-card" style="background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%); color: white;">
                        <div class="stat-value" id="stat-superficie-lavorata" style="color: white;">-</div>
                        <div class="stat-label" style="color: rgba(255,255,255,0.9);">Superficie Lavorata (ha)</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white;">
                        <div class="stat-value" id="stat-superficie-totale" style="color: white;">-</div>
                        <div class="stat-label" style="color: rgba(255,255,255,0.9);">Superficie Totale Terreni (ha)</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%); color: white;">
                        <div class="stat-value" id="stat-percentuale-lavorata" style="color: white;">-</div>
                        <div class="stat-label" style="color: rgba(255,255,255,0.9);">% Superficie Lavorata</div>
                    </div>
                </div>
            </div>

            <!-- Report Ore Operai -->
            <div class="stats-section">
                <h2>⏱️ Report Ore Operai</h2>
                
                <!-- Filtri periodo -->
                <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057;">Periodo:</label>
                            <select id="filter-periodo-ore" style="width: 100%; padding: 8px 12px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;">
                                <option value="mese">Questo Mese</option>
                                <option value="settimana">Questa Settimana</option>
                                <option value="oggi">Oggi</option>
                                <option value="custom">Personalizzato</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057;">Tipo Operaio:</label>
                            <select id="filter-tipo-operaio-ore" style="width: 100%; padding: 8px 12px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;">
                                <option value="tutti">Tutti</option>
                                <option value="Caposquadra">Caposquadra</option>
                                <option value="semplice">Operaio Semplice</option>
                                <option value="specializzato">Operaio Specializzato</option>
                                <option value="trattorista">Trattorista</option>
                                <option value="meccanico">Meccanico</option>
                                <option value="elettricista">Elettricista</option>
                                <option value="altro">Altro</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057;">Operaio:</label>
                            <select id="filter-operaio-ore" style="width: 100%; padding: 8px 12px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;">
                                <option value="tutti">Tutti gli operai</option>
                            </select>
                        </div>
                    </div>
                    <div id="date-range-group" style="display: none; margin-bottom: 15px;">
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057;">Da:</label>
                                <input type="date" id="date-from-ore" style="padding: 8px 12px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057;">A:</label>
                                <input type="date" id="date-to-ore" style="padding: 8px 12px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;">
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="loadReportOreOperai()" class="btn btn-primary" style="background: #2E8B57; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;" title="Aggiorna immediatamente il report">Aggiorna</button>
                        <button onclick="resetFiltriOre()" class="btn btn-secondary" style="background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">Pulisci Filtri</button>
                    </div>
                    <div style="margin-top: 10px; font-size: 12px; color: #666; font-style: italic;">
                        💡 I filtri si aggiornano automaticamente quando cambi i valori
                    </div>
                </div>

                <!-- Statistiche aggregate -->
                <div class="stats-grid" style="margin-bottom: 25px;">
                    <div class="stat-card" style="background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white;">
                        <div class="stat-value" id="stat-ore-totali-operai" style="color: white;">-</div>
                        <div class="stat-label" style="color: rgba(255,255,255,0.9);">Ore Totali</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%); color: white;">
                        <div class="stat-value" id="stat-media-ore-giorno" style="color: white;">-</div>
                        <div class="stat-label" style="color: rgba(255,255,255,0.9);">Media Ore/Giorno</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #17a2b8 0%, #117a8b 100%); color: white;">
                        <div class="stat-value" id="stat-giorni-lavorati" style="color: white;">-</div>
                        <div class="stat-label" style="color: rgba(255,255,255,0.9);">Giorni Lavorati</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%); color: white;">
                        <div class="stat-value" id="stat-operai-attivi" style="color: white;">-</div>
                        <div class="stat-label" style="color: rgba(255,255,255,0.9);">Operai Attivi</div>
                    </div>
                </div>

                <!-- Statistiche per tipo operaio -->
                <div style="margin-bottom: 25px;">
                    <h3 style="color: #495057; font-size: 16px; margin-bottom: 15px;">Ore per Tipo Operaio</h3>
                    <div id="ore-per-tipo-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div class="loading">Caricamento...</div>
                    </div>
                </div>

                <!-- Tabella report operai -->
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                        <thead>
                            <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Operaio</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Tipo Operaio</th>
                                <th style="padding: 12px; text-align: right; font-weight: 600; color: #495057;">Ore Totali</th>
                                <th style="padding: 12px; text-align: right; font-weight: 600; color: #495057;">Ore Validate</th>
                                <th style="padding: 12px; text-align: right; font-weight: 600; color: #495057;">Da Validare</th>
                                <th style="padding: 12px; text-align: right; font-weight: 600; color: #495057;">Giorni</th>
                                <th style="padding: 12px; text-align: right; font-weight: 600; color: #495057;">Media/Giorno</th>
                            </tr>
                        </thead>
                        <tbody id="report-ore-operai-body">
                            <tr>
                                <td colspan="7" style="padding: 40px; text-align: center; color: #999;">
                                    <div class="loading">Caricamento report...</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Statistiche Terreni -->
            <div class="stats-section">
                <h2>🌾 Statistiche Terreni</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="stat-terreni-totali-manodopera">-</div>
                        <div class="stat-label">Terreni Totali</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%); color: white;">
                        <div class="stat-value" id="stat-terreni-proprieta-manodopera" style="color: white;">-</div>
                        <div class="stat-label" style="color: rgba(255,255,255,0.9);">Di Proprietà</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #17a2b8 0%, #117a8b 100%); color: white;">
                        <div class="stat-value" id="stat-terreni-affitto-manodopera" style="color: white;">-</div>
                        <div class="stat-label" style="color: rgba(255,255,255,0.9);">In Affitto</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-superficie-totale-manodopera">-</div>
                        <div class="stat-label">Superficie Totale (ha)</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%); color: white;">
                        <div class="stat-value" id="stat-superficie-proprieta-manodopera" style="color: white;">-</div>
                        <div class="stat-label" style="color: rgba(255,255,255,0.9);">Superficie Proprietà (ha)</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #17a2b8 0%, #117a8b 100%); color: white;">
                        <div class="stat-value" id="stat-superficie-affitto-manodopera" style="color: white;">-</div>
                        <div class="stat-label" style="color: rgba(255,255,255,0.9);">Superficie Affitto (ha)</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white;">
                        <div class="stat-value" id="stat-canone-mensile-manodopera" style="color: white;">-</div>
                        <div class="stat-label" style="color: rgba(255,255,255,0.9);">Canone Mensile Totale</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white;">
                        <div class="stat-value" id="stat-canone-annuo-manodopera" style="color: white;">-</div>
                        <div class="stat-label" style="color: rgba(255,255,255,0.9);">Canone Annuo Totale</div>
                    </div>
                </div>
                
                <!-- Affitti in Scadenza -->
                <div style="margin-top: 30px;">
                    <h3 style="color: #2E8B57; margin-bottom: 15px; font-size: 18px;">📅 Affitti in Scadenza</h3>
                    <div id="affitti-scadenza-lista-manodopera" style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                        <div style="text-align: center; color: #666;">Caricamento...</div>
                    </div>
                </div>
            </div>

            <!-- Link a Compensi Operai -->
            <div class="stats-section">
                <h2>💰 Compensi Operai</h2>
                <div style="padding: 30px; text-align: center; background: #f8f9fa; border-radius: 8px;">
                    <p style="margin-bottom: 20px; color: #666; font-size: 16px;">
                        Calcola e gestisci i compensi per gli operai basati sulle ore validate e le tariffe configurate.
                    </p>
                    <a href="compensi-operai-standalone.html" class="btn btn-primary" style="background: #2E8B57; color: white; padding: 12px 24px; font-size: 16px; text-decoration: none; display: inline-block;">
                        📊 Vai a Compensi Operai
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Load Firebase config from external file -->
    <script>
        const configScript = document.createElement('script');
        configScript.src = '../config/firebase-config.js';
        configScript.onerror = function() {
            const fallbackScript = document.createElement('script');
            fallbackScript.src = 'https://raw.githubusercontent.com/VitaraDragon/gfv-platform/main/core/config/firebase-config.js';
            document.head.appendChild(fallbackScript);
        };
        document.head.appendChild(configScript);
    </script>
    
    <!-- Firebase SDK -->
    <script type="module">
        // Funzione per attendere il caricamento della configurazione Firebase
        function waitForConfig() {
            return new Promise((resolve, reject) => {
                if (typeof window.firebaseConfig !== 'undefined') {
                    resolve(window.firebaseConfig);
                    return;
                }
                
                let attempts = 0;
                const maxAttempts = 50;
                
                const checkInterval = setInterval(() => {
                    attempts++;
                    if (typeof window.firebaseConfig !== 'undefined') {
                        clearInterval(checkInterval);
                        resolve(window.firebaseConfig);
                    } else if (attempts >= maxAttempts) {
                        clearInterval(checkInterval);
                        reject(new Error('Firebase config not loaded after 5 seconds'));
                    }
                }, 100);
            });
        }

        const firebaseConfig = await waitForConfig();

        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, getDoc, doc, collection, getDocs, query, where, Timestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Inizializza Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Variabili globali per funzioni
        window.currentAuth = auth;
        window.currentDb = db;

        // Verifica autenticazione e carica statistiche
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = '../auth/login-standalone.html';
                return;
            }

            try {
                // Carica dati utente
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                if (!userDoc.exists()) {
                    console.error('Documento utente non trovato');
                    return;
                }

                const userData = userDoc.data();
                const tenantId = userData.tenantId;
                if (!tenantId) {
                    console.error('Tenant ID non trovato');
                    return;
                }

                // Verifica permessi (solo Manager o Amministratore)
                const ruoli = userData.ruoli || [];
                const isManager = ruoli.some(r => {
                    const roleLower = r.toLowerCase();
                    return roleLower.includes('manager') || roleLower.includes('amministratore');
                });
                if (!isManager) {
                    alert('Non hai i permessi per accedere a questa pagina');
                    window.location.href = '../dashboard-standalone.html';
                    return;
                }

                // Carica tutte le statistiche
                await loadAllStats(tenantId);

            } catch (error) {
                console.error('Errore caricamento dati:', error);
            }
        });

        // Carica tutte le statistiche
        async function loadAllStats(tenantId) {
            try {
                // 1. Statistiche Lavori
                await loadLavoriStats(tenantId);
                
                // 2. Statistiche Ore
                await loadOreStats(tenantId);
                
                // 3. Statistiche Squadre
                await loadSquadreStats(tenantId);
                
                // 4. Statistiche Superficie
                await loadSuperficieStats(tenantId);
                
                // 5. Statistiche Terreni
                await loadStatisticheTerreni(tenantId);
                
                // 6. Report Ore Operai
                setupReportOreOperai();
                await loadReportOreOperai(tenantId);

            } catch (error) {
                console.error('Errore caricamento statistiche:', error);
            }
        }
        
        // Variabile per debounce
        let debounceTimerOre = null;
        
        // Setup filtri report ore operai
        async function setupReportOreOperai() {
            const periodoSelect = document.getElementById('filter-periodo-ore');
            const dateRangeGroup = document.getElementById('date-range-group');
            const tipoOperaioSelect = document.getElementById('filter-tipo-operaio-ore');
            const operaioSelect = document.getElementById('filter-operaio-ore');
            const dateFrom = document.getElementById('date-from-ore');
            const dateTo = document.getElementById('date-to-ore');
            
            // Funzione per aggiornamento automatico con debounce
            const triggerAutoUpdate = () => {
                // Cancella timer precedente se esiste
                if (debounceTimerOre) {
                    clearTimeout(debounceTimerOre);
                }
                
                // Imposta nuovo timer (700ms di attesa)
                debounceTimerOre = setTimeout(() => {
                    loadReportOreOperai();
                }, 700);
            };
            
            // Setup cambio periodo
            periodoSelect.addEventListener('change', () => {
                if (periodoSelect.value === 'custom') {
                    dateRangeGroup.style.display = 'block';
                } else {
                    dateRangeGroup.style.display = 'none';
                    // Aggiorna automaticamente se non è custom
                    triggerAutoUpdate();
                }
            });
            
            // Setup cambio tipo operaio (aggiornamento automatico)
            tipoOperaioSelect.addEventListener('change', triggerAutoUpdate);
            
            // Setup cambio operaio (aggiornamento automatico)
            operaioSelect.addEventListener('change', triggerAutoUpdate);
            
            // Setup cambio date personalizzate (aggiornamento automatico)
            dateFrom.addEventListener('change', () => {
                if (dateFrom.value && dateTo.value) {
                    triggerAutoUpdate();
                }
            });
            
            dateTo.addEventListener('change', () => {
                if (dateFrom.value && dateTo.value) {
                    triggerAutoUpdate();
                }
            });
            
            // Carica lista operai per dropdown
            try {
                const user = window.currentAuth.currentUser;
                if (!user) return;
                
                const userDoc = await getDoc(doc(window.currentDb, 'users', user.uid));
                if (!userDoc.exists()) return;
                
                const tenantId = userDoc.data().tenantId;
                if (!tenantId) return;
                
                // Carica tutti gli utenti del tenant
                const usersQuery = query(
                    collection(window.currentDb, 'users'),
                    where('tenantId', '==', tenantId)
                );
                const usersSnapshot = await getDocs(usersQuery);
                
                // Log TUTTI gli utenti del tenant per trovare Pier Best

                usersSnapshot.forEach(doc => {
                    const userData = doc.data();
                    const nomeCompleto = `${userData.nome || ''} ${userData.cognome || ''}`.trim();
                    const ruoli = userData.ruoli || [];

                });
                
                const operai = [];
                usersSnapshot.forEach(doc => {
                    const userData = doc.data();
                    const ruoli = userData.ruoli || [];
                    
                    // Filtra operai e caposquadra (entrambi possono avere ore registrate)
                    const isOperaio = ruoli.some(r => r.toLowerCase().includes('operaio'));
                    const isCaposquadra = ruoli.some(r => r.toLowerCase() === 'caposquadra');
                    
                    if (isOperaio || isCaposquadra) {
                        const nomeCompleto = `${userData.nome || ''} ${userData.cognome || ''}`.trim();
                        if (nomeCompleto) {
                            operai.push({
                                id: doc.id,
                                nomeCompleto: nomeCompleto,
                                tipoOperaio: userData.tipoOperaio || '',
                                ruoli: ruoli
                            });
                        }
                    }
                });
                
                // Log dettagliato operai trovati

                operai.forEach(op => {

                });
                
                // Ordina per nome
                operai.sort((a, b) => a.nomeCompleto.localeCompare(b.nomeCompleto));
                
                // Log dettagliato per debug

                operai.forEach(op => {

                });
                
                // Popola dropdown
                operai.forEach(operaio => {
                    const option = document.createElement('option');
                    option.value = operaio.id;
                    option.textContent = operaio.nomeCompleto;
                    operaioSelect.appendChild(option);
                });
                
            } catch (error) {
                console.error('Errore caricamento lista operai:', error);
            }
        }
        
        // Reset filtri ore
        function resetFiltriOre() {
            // Cancella timer debounce se esiste
            if (debounceTimerOre) {
                clearTimeout(debounceTimerOre);
                debounceTimerOre = null;
            }
            
            document.getElementById('filter-periodo-ore').value = 'mese';
            document.getElementById('filter-tipo-operaio-ore').value = 'tutti';
            document.getElementById('filter-operaio-ore').value = 'tutti';
            document.getElementById('date-range-group').style.display = 'none';
            document.getElementById('date-from-ore').value = '';
            document.getElementById('date-to-ore').value = '';
            
            // Aggiorna immediatamente dopo reset
            loadReportOreOperai();
        }
        
        // Funzione helper per determinare il tipo operaio da visualizzare
        // Combina ruolo (caposquadra) e tipoOperaio (trattorista, semplice, ecc.)
        function getTipoOperaioDisplay(operaio) {
            const tipoOperaioNames = {
                'semplice': 'Operaio Semplice',
                'specializzato': 'Operaio Specializzato',
                'trattorista': 'Trattorista',
                'meccanico': 'Meccanico',
                'elettricista': 'Elettricista',
                'altro': 'Altro'
            };
            
            const ruoli = operaio.ruoli || [];
            const tipoOperaio = operaio.tipoOperaio || '';
            const isCaposquadra = ruoli.some(r => r.toLowerCase() === 'caposquadra');
            
            // Se è caposquadra
            if (isCaposquadra) {
                // Se ha anche un tipoOperaio, mostra entrambi
                if (tipoOperaio && tipoOperaioNames[tipoOperaio]) {
                    return `Caposquadra - ${tipoOperaioNames[tipoOperaio]}`;
                } else if (tipoOperaio) {
                    return `Caposquadra - ${tipoOperaio}`;
                } else {
                    // Solo caposquadra, senza tipoOperaio
                    return 'Caposquadra';
                }
            }
            
            // Se non è caposquadra, usa solo tipoOperaio
            if (tipoOperaio && tipoOperaioNames[tipoOperaio]) {
                return tipoOperaioNames[tipoOperaio];
            } else if (tipoOperaio) {
                return tipoOperaio;
            }
            
            return '-';
        }
        
        // Carica report ore operai
        async function loadReportOreOperai(tenantId) {
            if (!tenantId) {
                const user = window.currentAuth.currentUser;
                if (!user) return;
                const userDoc = await getDoc(doc(window.currentDb, 'users', user.uid));
                if (!userDoc.exists()) return;
                tenantId = userDoc.data().tenantId;
                if (!tenantId) return;
            }
            
            try {
                // Calcola date periodo
                const periodo = document.getElementById('filter-periodo-ore').value;
                let dataInizio, dataFine;
                const oggi = new Date();
                oggi.setHours(0, 0, 0, 0);
                
                if (periodo === 'oggi') {
                    dataInizio = new Date(oggi);
                    dataFine = new Date(oggi);
                    dataFine.setHours(23, 59, 59, 999);
                } else if (periodo === 'settimana') {
                    const giornoSettimana = oggi.getDay();
                    const diff = oggi.getDate() - giornoSettimana + (giornoSettimana === 0 ? -6 : 1); // Lunedì
                    dataInizio = new Date(oggi.setDate(diff));
                    dataInizio.setHours(0, 0, 0, 0);
                    dataFine = new Date(dataInizio);
                    dataFine.setDate(dataFine.getDate() + 6);
                    dataFine.setHours(23, 59, 59, 999);
                } else if (periodo === 'mese') {
                    dataInizio = new Date(oggi.getFullYear(), oggi.getMonth(), 1);
                    dataFine = new Date(oggi.getFullYear(), oggi.getMonth() + 1, 0);
                    dataFine.setHours(23, 59, 59, 999);
                } else if (periodo === 'custom') {
                    const dateFrom = document.getElementById('date-from-ore').value;
                    const dateTo = document.getElementById('date-to-ore').value;
                    if (!dateFrom || !dateTo) {
                        alert('Seleziona entrambe le date per il periodo personalizzato');
                        return;
                    }
                    dataInizio = new Date(dateFrom);
                    dataInizio.setHours(0, 0, 0, 0);
                    dataFine = new Date(dateTo);
                    dataFine.setHours(23, 59, 59, 999);
                } else {
                    // Default: questo mese
                    dataInizio = new Date(oggi.getFullYear(), oggi.getMonth(), 1);
                    dataFine = new Date(oggi.getFullYear(), oggi.getMonth() + 1, 0);
                    dataFine.setHours(23, 59, 59, 999);
                }
                
                // Carica tutti i lavori
                const lavoriCollection = collection(window.currentDb, `tenants/${tenantId}/lavori`);
                const lavoriSnapshot = await getDocs(lavoriCollection);
                
                // Mappa per aggregare ore per operaio
                const orePerOperaio = {};
                const giorniLavoratiSet = new Set();
                let oreTotali = 0;
                let oreValidateTotali = 0;
                let oreDaValidareTotali = 0;
                
                // Per ogni lavoro, carica le ore
                for (const lavoroDoc of lavoriSnapshot.docs) {
                    const lavoroId = lavoroDoc.id;
                    const oreRef = collection(window.currentDb, `tenants/${tenantId}/lavori/${lavoroId}/oreOperai`);
                    const oreSnapshot = await getDocs(oreRef);
                    
                    oreSnapshot.forEach(oraDoc => {
                        const ora = oraDoc.data();
                        const dataOra = ora.data?.toDate ? ora.data.toDate() : new Date(ora.data);
                        
                        // Filtra per periodo
                        if (dataOra < dataInizio || dataOra > dataFine) {
                            return;
                        }
                        
                        const operaioId = ora.operaioId;
                        if (!operaioId) return;
                        
                        const oreNette = ora.oreNette || 0;
                        const stato = ora.stato || 'da_validare';
                        
                        // Inizializza operaio se non esiste
                        if (!orePerOperaio[operaioId]) {
                            orePerOperaio[operaioId] = {
                                operaioId: operaioId,
                                nome: '',
                                cognome: '',
                                tipoOperaio: '',
                                ruoli: [],
                                oreTotali: 0,
                                oreValidate: 0,
                                oreDaValidare: 0,
                                giorniLavorati: new Set()
                            };
                        }
                        
                        // Aggrega ore
                        orePerOperaio[operaioId].oreTotali += oreNette;
                        oreTotali += oreNette;
                        
                        if (stato === 'validate') {
                            orePerOperaio[operaioId].oreValidate += oreNette;
                            oreValidateTotali += oreNette;
                        } else if (stato === 'da_validare') {
                            orePerOperaio[operaioId].oreDaValidare += oreNette;
                            oreDaValidareTotali += oreNette;
                        }
                        
                        // Aggiungi giorno lavorato
                        const giornoKey = dataOra.toISOString().split('T')[0];
                        orePerOperaio[operaioId].giorniLavorati.add(giornoKey);
                        giorniLavoratiSet.add(giornoKey);
                    });
                }
                
                // Carica dati operai
                const currentUser = window.currentAuth.currentUser;

// Carica prima il tenantId dell'utente corrente per verificare
                if (currentUser) {
                    try {
                        const currentUserDoc = await getDoc(doc(window.currentDb, 'users', currentUser.uid));
                        if (currentUserDoc.exists()) {
                            const currentUserData = currentUserDoc.data();

                        }
                    } catch (err) {
                        console.error('🔍 [REPORT ORE] Errore lettura current user:', err);
                    }
                }
                
                for (const operaioId of Object.keys(orePerOperaio)) {
                    try {

                        const operaioDoc = await getDoc(doc(window.currentDb, 'users', operaioId));
                        if (operaioDoc.exists()) {
                            const operaioData = operaioDoc.data();

orePerOperaio[operaioId].nome = operaioData.nome || '';
                            orePerOperaio[operaioId].cognome = operaioData.cognome || '';
                            orePerOperaio[operaioId].tipoOperaio = operaioData.tipoOperaio || '';
                            orePerOperaio[operaioId].ruoli = operaioData.ruoli || [];
                        } else {
                            console.warn(`⚠️ [REPORT ORE] Operaio ${operaioId} non trovato`);
                            // Usa dati di fallback se il documento non esiste
                            orePerOperaio[operaioId].nome = 'N/A';
                            orePerOperaio[operaioId].cognome = '';
                            orePerOperaio[operaioId].tipoOperaio = '';
                            orePerOperaio[operaioId].ruoli = [];
                        }
                    } catch (error) {
                        console.error(`❌ [REPORT ORE] Errore caricamento operaio ${operaioId}:`);
                        console.error(`❌ [REPORT ORE] Error code: ${error.code}`);
                        console.error(`❌ [REPORT ORE] Error message: ${error.message}`);
                        console.error(`❌ [REPORT ORE] Error stack:`, error.stack);
                        
                        // Verifica se il documento esiste ma non possiamo leggerlo
                        if (error.code === 'permission-denied') {
                            console.warn(`⚠️ [REPORT ORE] Permesso negato per operaio ${operaioId}. Possibili cause:`);
                            console.warn(`⚠️ [REPORT ORE] - Il documento potrebbe non avere tenantId impostato`);
                            console.warn(`⚠️ [REPORT ORE] - Il tenantId potrebbe essere diverso da "${tenantId}"`);
                            console.warn(`⚠️ [REPORT ORE] - Il documento potrebbe non esistere`);
                            
                            // Usa dati di fallback
                            orePerOperaio[operaioId].nome = 'N/A';
                            orePerOperaio[operaioId].cognome = '';
                            orePerOperaio[operaioId].tipoOperaio = '';
                            orePerOperaio[operaioId].ruoli = [];
                        }
                    }
                }

                // Converti giorni lavorati da Set a numero
                Object.keys(orePerOperaio).forEach(operaioId => {
                    orePerOperaio[operaioId].giorniLavorati = orePerOperaio[operaioId].giorniLavorati.size;
                });
                
                // Applica filtri
                const filtroTipoOperaio = document.getElementById('filter-tipo-operaio-ore').value;
                const filtroOperaio = document.getElementById('filter-operaio-ore').value;
                
                let orePerOperaioFiltrate = { ...orePerOperaio };
                
                // Filtro per tipo operaio (usa la funzione helper per confrontare il display)
                if (filtroTipoOperaio !== 'tutti') {
                    Object.keys(orePerOperaioFiltrate).forEach(operaioId => {
                        const tipoDisplay = getTipoOperaioDisplay(orePerOperaioFiltrate[operaioId]);
                        const operaio = orePerOperaioFiltrate[operaioId];
                        const ruoli = operaio.ruoli || [];
                        const isCaposquadra = ruoli.some(r => r.toLowerCase() === 'caposquadra');
                        
                        // Se il filtro è "Caposquadra", mostra solo i caposquadra
                        if (filtroTipoOperaio === 'Caposquadra') {
                            if (!isCaposquadra) {
                                delete orePerOperaioFiltrate[operaioId];
                            }
                        } else {
                            // Per gli altri filtri, confronta con tipoOperaio (non con il display)
                            if (operaio.tipoOperaio !== filtroTipoOperaio) {
                                delete orePerOperaioFiltrate[operaioId];
                            }
                        }
                    });
                }
                
                // Filtro per singolo operaio
                if (filtroOperaio !== 'tutti') {
                    Object.keys(orePerOperaioFiltrate).forEach(operaioId => {
                        if (operaioId !== filtroOperaio) {
                            delete orePerOperaioFiltrate[operaioId];
                        }
                    });
                }
                
                // Ricalcola statistiche aggregate solo per operai filtrati
                let oreTotaliFiltrate = 0;
                let oreValidateTotaliFiltrate = 0;
                let oreDaValidareTotaliFiltrate = 0;
                let giorniLavoratiFiltrati = 0;
                
                Object.values(orePerOperaioFiltrate).forEach(operaio => {
                    oreTotaliFiltrate += operaio.oreTotali;
                    oreValidateTotaliFiltrate += operaio.oreValidate;
                    oreDaValidareTotaliFiltrate += operaio.oreDaValidare;
                    giorniLavoratiFiltrati = Math.max(giorniLavoratiFiltrati, operaio.giorniLavorati);
                });
                
                // Calcola statistiche aggregate (usando dati filtrati)
                const giorniLavorati = giorniLavoratiFiltrati || giorniLavoratiSet.size;
                const mediaOreGiorno = giorniLavorati > 0 ? oreTotaliFiltrate / giorniLavorati : 0;
                const operaiAttivi = Object.keys(orePerOperaioFiltrate).length;
                
                // Aggiorna statistiche aggregate
                const formatOre = (ore) => {
                    const oreInt = Math.floor(ore);
                    const minuti = Math.round((ore - oreInt) * 60);
                    return minuti === 0 ? `${oreInt}h` : `${oreInt}h ${minuti}min`;
                };
                
                document.getElementById('stat-ore-totali-operai').textContent = formatOre(oreTotaliFiltrate);
                document.getElementById('stat-media-ore-giorno').textContent = formatOre(mediaOreGiorno);
                document.getElementById('stat-giorni-lavorati').textContent = giorniLavorati;
                document.getElementById('stat-operai-attivi').textContent = operaiAttivi;
                
                // Statistiche per tipo operaio (solo per operai filtrati)
                // Usa la funzione helper per ottenere il tipo display corretto
                const orePerTipo = {};
                Object.values(orePerOperaioFiltrate).forEach(operaio => {
                    const tipoDisplay = getTipoOperaioDisplay(operaio);
                    if (!orePerTipo[tipoDisplay]) {
                        orePerTipo[tipoDisplay] = 0;
                    }
                    orePerTipo[tipoDisplay] += operaio.oreTotali;
                });
                
                let orePerTipoHTML = '';
                if (Object.keys(orePerTipo).length === 0) {
                    orePerTipoHTML = '<div style="padding: 20px; text-align: center; color: #999;">Nessun dato disponibile</div>';
                } else {
                    Object.keys(orePerTipo).sort((a, b) => orePerTipo[b] - orePerTipo[a]).forEach(tipo => {
                        orePerTipoHTML += `
                            <div class="stat-card" style="text-align: center;">
                                <div class="stat-value" style="font-size: 24px;">${formatOre(orePerTipo[tipo])}</div>
                                <div class="stat-label">${tipo}</div>
                            </div>
                        `;
                    });
                }
                document.getElementById('ore-per-tipo-container').innerHTML = orePerTipoHTML;
                
                // Renderizza tabella (con dati filtrati)
                renderReportOreOperai(orePerOperaioFiltrate);
                
            } catch (error) {
                console.error('Errore caricamento report ore operai:', error);
                document.getElementById('report-ore-operai-body').innerHTML = `
                    <tr>
                        <td colspan="7" style="padding: 40px; text-align: center; color: #dc3545;">
                            Errore caricamento report
                        </td>
                    </tr>
                `;
            }
        }
        
        // Renderizza tabella report ore operai
        function renderReportOreOperai(orePerOperaio) {
            const tbody = document.getElementById('report-ore-operai-body');
            
            if (Object.keys(orePerOperaio).length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="padding: 40px; text-align: center; color: #999;">
                            Nessun dato disponibile per il periodo selezionato
                        </td>
                    </tr>
                `;
                return;
            }
            
            const formatOre = (ore) => {
                const oreInt = Math.floor(ore);
                const minuti = Math.round((ore - oreInt) * 60);
                return minuti === 0 ? `${oreInt}h` : `${oreInt}h ${minuti}min`;
            };
            
            // Ordina per ore totali (decrescente)
            const operaiArray = Object.values(orePerOperaio).sort((a, b) => b.oreTotali - a.oreTotali);
            
            let html = '';
            operaiArray.forEach(operaio => {
                const nomeCompleto = `${operaio.nome || ''} ${operaio.cognome || ''}`.trim() || 'N/A';
                const tipoOperaioDisplay = getTipoOperaioDisplay(operaio);
                const mediaGiorno = operaio.giorniLavorati > 0 ? operaio.oreTotali / operaio.giorniLavorati : 0;
                
                html += `
                    <tr style="border-bottom: 1px solid #e9ecef;">
                        <td style="padding: 12px;">${nomeCompleto}</td>
                        <td style="padding: 12px;">${tipoOperaioDisplay}</td>
                        <td style="padding: 12px; text-align: right; font-weight: 600;">${formatOre(operaio.oreTotali)}</td>
                        <td style="padding: 12px; text-align: right; color: #28a745;">${formatOre(operaio.oreValidate)}</td>
                        <td style="padding: 12px; text-align: right; color: #ffc107;">${formatOre(operaio.oreDaValidare)}</td>
                        <td style="padding: 12px; text-align: right;">${operaio.giorniLavorati}</td>
                        <td style="padding: 12px; text-align: right;">${formatOre(mediaGiorno)}</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
        
        // Export funzioni globali
        window.loadReportOreOperai = () => {
            const user = window.currentAuth.currentUser;
            if (!user) return;
            getDoc(doc(window.currentDb, 'users', user.uid)).then(userDoc => {
                if (userDoc.exists()) {
                    const tenantId = userDoc.data().tenantId;
                    if (tenantId) {
                        loadReportOreOperai(tenantId);
                    }
                }
            });
        };
        
        window.resetFiltriOre = resetFiltriOre;

        // Carica statistiche lavori
        async function loadLavoriStats(tenantId) {
            try {
                const lavoriCollection = collection(db, `tenants/${tenantId}/lavori`);
                const lavoriSnapshot = await getDocs(lavoriCollection);
                
                let totali = 0;
                let attivi = 0;
                let completati = 0;
                let pianificati = 0;
                
                lavoriSnapshot.forEach(doc => {
                    totali++;
                    const lavoro = doc.data();
                    const stato = lavoro.stato || 'pianificato';
                    
                    if (stato === 'attivo') attivi++;
                    else if (stato === 'completato') completati++;
                    else if (stato === 'pianificato') pianificati++;
                });
                
                document.getElementById('stat-lavori-totali').textContent = totali;
                document.getElementById('stat-lavori-attivi').textContent = attivi;
                document.getElementById('stat-lavori-completati').textContent = completati;
                document.getElementById('stat-lavori-pianificati').textContent = pianificati;
            } catch (error) {
                console.error('Errore caricamento statistiche lavori:', error);
            }
        }

        // Carica statistiche ore
        async function loadOreStats(tenantId) {
            try {
                const lavoriCollection = collection(db, `tenants/${tenantId}/lavori`);
                const lavoriSnapshot = await getDocs(lavoriCollection);
                
                const oggi = new Date();
                const primoGiornoMese = new Date(oggi.getFullYear(), oggi.getMonth(), 1);
                
                let oreValidateMese = 0;
                let oreValidateTotale = 0;
                let oreDaValidare = 0;
                let giorniConOre = new Set();
                
                for (const lavoroDoc of lavoriSnapshot.docs) {
                    try {
                        const oreRef = collection(db, `tenants/${tenantId}/lavori/${lavoroDoc.id}/oreOperai`);
                        const oreSnapshot = await getDocs(oreRef);
                        
                        oreSnapshot.forEach(oraDoc => {
                            const ora = oraDoc.data();
                            const oreNette = ora.oreNette || 0;
                            
                            if (ora.stato === 'validate') {
                                oreValidateTotale += oreNette;
                                
                                if (ora.data) {
                                    try {
                                        const dataOra = ora.data.toDate ? ora.data.toDate() : new Date(ora.data);
                                        if (dataOra >= primoGiornoMese) {
                                            oreValidateMese += oreNette;
                                            giorniConOre.add(dataOra.toISOString().split('T')[0]);
                                        }
                                    } catch (e) {
                                        // Ignora errori di conversione data
                                    }
                                }
                            } else if (ora.stato === 'da_validare') {
                                oreDaValidare += oreNette;
                            }
                        });
                    } catch (error) {
                        // Se la sub-collection non esiste, continua
                    }
                }
                
                // Formatta ore
                const formatOre = (ore) => {
                    const oreInt = Math.floor(ore);
                    const minuti = Math.round((ore - oreInt) * 60);
                    return minuti === 0 ? `${oreInt}h` : `${oreInt}h ${minuti}min`;
                };
                
                document.getElementById('stat-ore-validate-mese').textContent = formatOre(oreValidateMese);
                document.getElementById('stat-ore-validate-totale').textContent = formatOre(oreValidateTotale);
                document.getElementById('stat-ore-da-validare').textContent = formatOre(oreDaValidare);
                
                // Media ore/giorno (solo giorni con ore nel mese corrente)
                const giorniConOreCount = giorniConOre.size;
                const mediaOreGiorno = giorniConOreCount > 0 ? oreValidateMese / giorniConOreCount : 0;
                document.getElementById('stat-media-ore-giorno').textContent = formatOre(mediaOreGiorno);
            } catch (error) {
                console.error('Errore caricamento statistiche ore:', error);
            }
        }

        // Carica statistiche squadre
        async function loadSquadreStats(tenantId) {
            try {
                const squadreCollection = collection(db, `tenants/${tenantId}/squadre`);
                const squadreSnapshot = await getDocs(squadreCollection);
                
                let squadreTotali = 0;
                let squadreAttive = 0;
                const operaiSet = new Set();
                
                squadreSnapshot.forEach(doc => {
                    squadreTotali++;
                    const squadra = doc.data();
                    if (squadra.operai && squadra.operai.length > 0) {
                        squadreAttive++;
                        squadra.operai.forEach(operaioId => operaiSet.add(operaioId));
                    }
                });
                
                // Conta operai online
                let operaiOnline = 0;
                for (const operaioId of operaiSet) {
                    try {
                        const operaioDoc = await getDoc(doc(db, 'users', operaioId));
                        if (operaioDoc.exists()) {
                            const operaioData = operaioDoc.data();
                            if (operaioData.isOnline) {
                                operaiOnline++;
                            }
                        }
                    } catch (e) {
                        // Ignora errori
                    }
                }
                
                document.getElementById('stat-squadre-totali').textContent = squadreTotali;
                document.getElementById('stat-squadre-attive').textContent = squadreAttive;
                document.getElementById('stat-operai-totali').textContent = operaiSet.size;
                document.getElementById('stat-operai-online').textContent = operaiOnline;
            } catch (error) {
                console.error('Errore caricamento statistiche squadre:', error);
            }
        }

        // Carica statistiche superficie
        async function loadSuperficieStats(tenantId) {
            try {
                // Carica terreni
                const terreniCollection = collection(db, `tenants/${tenantId}/terreni`);
                const terreniSnapshot = await getDocs(terreniCollection);
                
                let superficieTotale = 0;
                terreniSnapshot.forEach(doc => {
                    const terreno = doc.data();
                    superficieTotale += terreno.superficie || 0;
                });
                
                // Carica lavori per superficie lavorata
                const lavoriCollection = collection(db, `tenants/${tenantId}/lavori`);
                const lavoriSnapshot = await getDocs(lavoriCollection);
                
                let superficieLavorata = 0;
                lavoriSnapshot.forEach(doc => {
                    const lavoro = doc.data();
                    // Usa superficieTotaleLavorata che viene aggiornato quando si tracciano zone lavorate
                    if (lavoro.superficieTotaleLavorata) {
                        superficieLavorata += lavoro.superficieTotaleLavorata;
                    }
                });
                
                const percentualeLavorata = superficieTotale > 0 
                    ? ((superficieLavorata / superficieTotale) * 100).toFixed(1)
                    : 0;
                
                document.getElementById('stat-superficie-lavorata').textContent = superficieLavorata.toFixed(2);
                document.getElementById('stat-superficie-totale').textContent = superficieTotale.toFixed(2);
                document.getElementById('stat-percentuale-lavorata').textContent = `${percentualeLavorata}%`;
            } catch (error) {
                console.error('Errore caricamento statistiche superficie:', error);
            }
        }

        // Calcola alert scadenza affitto
        function calcolaAlertAffitto(dataScadenza) {
            if (!dataScadenza) {
                return { colore: null, testo: '', giorni: null };
            }

            const oggi = new Date();
            oggi.setHours(0, 0, 0, 0);
            
            const scadenza = dataScadenza.toDate ? dataScadenza.toDate() : new Date(dataScadenza);
            scadenza.setHours(0, 0, 0, 0);

            const giorniRimanenti = Math.ceil((scadenza - oggi) / (1000 * 60 * 60 * 24));
            const mesiRimanenti = giorniRimanenti / 30;

            if (giorniRimanenti < 0) {
                return { colore: 'grey', testo: 'Scaduto', giorni: giorniRimanenti, mesi: null };
            } else if (giorniRimanenti <= 30) {
                return { colore: 'red', testo: `${giorniRimanenti} giorni`, giorni: giorniRimanenti, mesi: mesiRimanenti };
            } else if (giorniRimanenti <= 180) {
                const mesi = Math.floor(mesiRimanenti);
                return { colore: 'yellow', testo: `~${mesi} mesi`, giorni: giorniRimanenti, mesi: mesiRimanenti };
            } else {
                const mesi = Math.floor(mesiRimanenti);
                return { colore: 'green', testo: `~${mesi} mesi`, giorni: giorniRimanenti, mesi: mesiRimanenti };
            }
        }

        // Formatta data scadenza
        function formattaDataScadenza(data) {
            if (!data) return '';
            const d = data.toDate ? data.toDate() : new Date(data);
            return d.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        // Escape HTML
        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return String(text).replace(/[&<>"']/g, m => map[m]);
        }

        // Carica statistiche terreni
        async function loadStatisticheTerreni(tenantId) {
            try {
                // Carica terreni
                const terreniCollection = collection(db, `tenants/${tenantId}/terreni`);
                const terreniSnapshot = await getDocs(terreniCollection);
                
                // Calcola statistiche
                let totaleTerreni = 0;
                let terreniProprieta = 0;
                let terreniAffitto = 0;
                let superficieTotale = 0;
                let superficieProprieta = 0;
                let superficieAffitto = 0;
                let canoneMensileTotale = 0;
                
                terreniSnapshot.forEach(doc => {
                    totaleTerreni++;
                    const terreno = doc.data();
                    const superficie = terreno.superficie || 0;
                    superficieTotale += superficie;
                    
                    // Applica default 'proprieta' per retrocompatibilità (terreni esistenti senza tipoPossesso)
                    const tipoPossesso = terreno.tipoPossesso || 'proprieta';
                    
                    if (tipoPossesso === 'proprieta') {
                        terreniProprieta++;
                        superficieProprieta += superficie;
                    } else if (tipoPossesso === 'affitto') {
                        terreniAffitto++;
                        superficieAffitto += superficie;
                        if (terreno.canoneAffitto) {
                            canoneMensileTotale += terreno.canoneAffitto;
                        }
                    }
                });
                
                const canoneAnnuoTotale = canoneMensileTotale * 12;
                
                // Aggiorna metriche
                document.getElementById('stat-terreni-totali-manodopera').textContent = totaleTerreni;
                document.getElementById('stat-terreni-proprieta-manodopera').textContent = terreniProprieta;
                document.getElementById('stat-terreni-affitto-manodopera').textContent = terreniAffitto;
                document.getElementById('stat-superficie-totale-manodopera').textContent = superficieTotale.toFixed(2);
                document.getElementById('stat-superficie-proprieta-manodopera').textContent = superficieProprieta.toFixed(2);
                document.getElementById('stat-superficie-affitto-manodopera').textContent = superficieAffitto.toFixed(2);
                document.getElementById('stat-canone-mensile-manodopera').textContent = canoneMensileTotale > 0 ? `€${canoneMensileTotale.toFixed(2)}` : '-';
                document.getElementById('stat-canone-annuo-manodopera').textContent = canoneAnnuoTotale > 0 ? `€${canoneAnnuoTotale.toFixed(2)}` : '-';
                
                // Carica affitti in scadenza
                const affitti = [];
                terreniSnapshot.forEach(doc => {
                    const terreno = doc.data();
                    // Applica default 'proprieta' per retrocompatibilità
                    const tipoPossesso = terreno.tipoPossesso || 'proprieta';
                    if (tipoPossesso === 'affitto' && terreno.dataScadenzaAffitto) {
                        const alert = calcolaAlertAffitto(terreno.dataScadenzaAffitto);
                        affitti.push({
                            id: doc.id,
                            nome: terreno.nome || 'Senza nome',
                            dataScadenza: terreno.dataScadenzaAffitto,
                            alert: alert,
                            canone: terreno.canoneAffitto || null
                        });
                    }
                });
                
                // Ordina per urgenza
                affitti.sort((a, b) => {
                    const order = { 'red': 0, 'yellow': 1, 'green': 2, 'grey': 3 };
                    const orderA = order[a.alert.colore] !== undefined ? order[a.alert.colore] : 999;
                    const orderB = order[b.alert.colore] !== undefined ? order[b.alert.colore] : 999;
                    if (orderA !== orderB) return orderA - orderB;
                    return (a.alert.giorni || 999) - (b.alert.giorni || 999);
                });
                
                const listaEl = document.getElementById('affitti-scadenza-lista-manodopera');
                if (affitti.length === 0) {
                    listaEl.innerHTML = '<div style="text-align: center; color: #666;">Nessun terreno in affitto registrato</div>';
                } else {
                    let html = '';
                    affitti.forEach(affitto => {
                        const dataFormattata = formattaDataScadenza(affitto.dataScadenza);
                        const pallinoEmoji = affitto.alert.colore === 'red' ? '🔴' : affitto.alert.colore === 'yellow' ? '🟡' : affitto.alert.colore === 'green' ? '🟢' : '⚫';
                        const coloreBordo = affitto.alert.colore === 'red' ? '#dc3545' : affitto.alert.colore === 'yellow' ? '#ffc107' : affitto.alert.colore === 'green' ? '#28a745' : '#6c757d';
                        const coloreSfondo = affitto.alert.colore === 'red' ? '#f8d7da' : affitto.alert.colore === 'yellow' ? '#fff3cd' : affitto.alert.colore === 'green' ? '#d4edda' : '#e9ecef';
                        
                        html += `
                            <div style="padding: 12px; margin-bottom: 10px; background: ${coloreSfondo}; border-left: 3px solid ${coloreBordo}; border-radius: 4px;">
                                <div style="font-weight: 600; color: #333; margin-bottom: 6px; display: flex; align-items: center; gap: 8px;">
                                    <span>${pallinoEmoji}</span>
                                    <span>${escapeHtml(affitto.nome)}</span>
                                </div>
                                <div style="font-size: 13px; color: #666; margin-bottom: 4px;">
                                    <strong>Scade:</strong> ${dataFormattata} (${affitto.alert.testo})
                                </div>
                                ${affitto.canone ? `
                                    <div style="font-size: 12px; color: #666;">
                                        <strong>Canone:</strong> €${affitto.canone.toFixed(2)}/mese
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    });
                    listaEl.innerHTML = html;
                }
            } catch (error) {
                console.error('Errore caricamento statistiche terreni:', error);
            }
        }
    </script>
</body>
</html>

