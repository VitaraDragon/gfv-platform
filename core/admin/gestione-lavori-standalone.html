<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Lavori - GFV Platform</title>
    <link rel="stylesheet" href="https://unpkg.com/intro.js/minified/introjs.min.css">
    <link rel="stylesheet" href="../styles/tour.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #2E8B57 0%, #228B22 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        /* Stili Conto Terzi - applicati immediatamente se rilevati */
        body.conto-terzi-mode .header {
            background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%) !important;
        }
        
        body.conto-terzi-mode .modal .btn-primary {
            background: #1976D2 !important;
        }
        
        body.conto-terzi-mode .stat-card:not(.secondary):not(.warning):not(.danger):not(.stat-card-ritardo):not(.stat-card-tempo):not(.stat-card-anticipo) {
            background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%) !important;
        }
        
        /* Stili specifici per card statistiche progresso */
        .stat-card-ritardo {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%) !important;
            color: white !important;
        }
        
        .stat-card-tempo {
            background: linear-gradient(135deg, #28a745 0%, #218838 100%) !important;
            color: white !important;
        }
        
        .stat-card-anticipo {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%) !important;
            color: white !important;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .btn-primary:hover {
            background: rgba(255,255,255,0.3);
        }

        .modal .btn-primary {
            background: #2E8B57;
            color: white;
            border: none;
        }

        .modal .btn-primary:hover {
            background: #228B22;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }

        .content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .section-header h2 {
            color: #2E8B57;
            font-size: 24px;
        }

        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 12px;
            color: #666;
            font-weight: 500;
        }

        .filter-group select,
        .filter-group input {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
            min-width: 150px;
        }

        .lavori-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .lavori-table th,
        .lavori-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .lavori-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        .lavori-table tr:hover {
            background: #f8f9fa;
        }

        .lavoro-conto-terzi {
            background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%) !important;
            border-left: 4px solid #1976D2;
        }

        .lavoro-conto-terzi:hover {
            background: linear-gradient(135deg, #BBDEFB 0%, #90CAF9 100%) !important;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
        }

        .badge-assegnato {
            background: #e3f2fd;
            color: #1976d2;
        }

        .badge-in_corso {
            background: #fff3e0;
            color: #f57c00;
        }

        .badge-completato {
            background: #e8f5e9;
            color: #388e3c;
        }

        .badge-annullato {
            background: #ffebee;
            color: #d32f2f;
        }

        .badge-completato_da_approvare {
            background: #fff3cd;
            color: #856404;
        }

        .badge-progresso-in_ritardo {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-progresso-in_tempo {
            background: #d4edda;
            color: #155724;
        }

        .badge-progresso-in_anticipo {
            background: #d1ecf1;
            color: #0c5460;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 700px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: #2E8B57;
            font-size: 20px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .close-btn:hover {
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #2E8B57;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #2E8B57 0%, #228B22 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stat-card.secondary {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        }

        .stat-card.warning {
            background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
        }

        .stat-card.danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .progress-cell {
            min-width: 150px;
        }

        .progress-bar-inline {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 5px;
        }

        .progress-fill-inline {
            height: 100%;
            background: linear-gradient(90deg, #2E8B57 0%, #228B22 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 10px;
            font-weight: 500;
        }

        .progress-text {
            font-size: 12px;
            color: #666;
        }

        .modal-large {
            max-width: 1200px;
        }

        .modal-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }

        .modal-tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 14px;
            color: #666;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
        }

        .modal-tab.active {
            color: #2E8B57;
            border-bottom-color: #2E8B57;
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .map-container {
            width: 100%;
            height: 400px;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .ore-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .ore-stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #2E8B57;
        }

        .ore-stat-value {
            font-size: 24px;
            font-weight: 600;
            color: #2E8B57;
        }

        .ore-stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .zone-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .zone-item {
            padding: 10px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .zone-item:last-child {
            border-bottom: none;
        }

        .zone-info {
            flex: 1;
        }

        .zone-date {
            font-weight: 500;
            color: #333;
        }

        .zone-surface {
            font-size: 12px;
            color: #666;
        }

        @media (max-width: 768px) {
            .lavori-table {
                font-size: 12px;
            }

            .lavori-table th,
            .lavori-table td {
                padding: 8px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
    <script>
        // Rileva immediatamente modalit√† Conto Terzi per evitare flash verde
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const statoFromUrl = urlParams.get('stato');
            const contoTerziFromUrl = urlParams.get('contoTerzi');
            
            // Se c'√® il parametro contoTerzi=true o stato=da_pianificare, applica subito gli stili
            // Nota: hasContoTerziModule non √® ancora disponibile qui, quindi controlliamo solo i parametri URL
            if (contoTerziFromUrl === 'true' || statoFromUrl === 'da_pianificare') {
                // Aggiungi classe al body immediatamente
                document.addEventListener('DOMContentLoaded', function() {
                    document.body.classList.add('conto-terzi-mode');
                    
                    // Aggiorna link dashboard immediatamente
                    const dashboardLink = document.getElementById('dashboard-link');
                    if (dashboardLink) {
                        dashboardLink.href = '../../modules/conto-terzi/views/conto-terzi-home-standalone.html';
                    }
                    
                    // Aggiorna titolo header
                    const headerTitle = document.querySelector('.header h1');
                    if (headerTitle && headerTitle.textContent.includes('Gestione Lavori')) {
                        headerTitle.textContent = 'üìã Lavori da Pianificare - Conto Terzi';
                    }
                });
                
                // Applica anche prima che DOM sia caricato usando inline style
                const style = document.createElement('style');
                style.textContent = `
                    .header { background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%) !important; }
                `;
                document.head.appendChild(style);
            }
        })();
    </script>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>üìã Gestione Lavori</h1>
                <p style="opacity: 0.9; margin-top: 5px;">Pianifica e assegna lavori alle squadre</p>
            </div>
            <div class="header-actions">
                <a href="impostazioni-standalone.html" class="btn btn-primary" style="text-decoration: none; display: none; align-items: center; gap: 8px;" id="impostazioni-link">
                    <span>‚öôÔ∏è</span>
                    <span>Impostazioni</span>
                </a>
                <button class="btn btn-primary" id="lavori-tour-button" type="button">üß≠ Tour</button>
                <button class="btn btn-primary" id="crea-lavoro-button" onclick="openCreaModal()">‚ûï Crea Nuovo Lavoro</button>
                <a href="../dashboard-standalone.html" id="dashboard-link" class="btn btn-secondary">‚Üê Dashboard</a>
            </div>
        </div>

        <div class="content">
            <div id="alert-container"></div>
            
            <!-- Card Statistiche -->
            <div class="stats-grid" id="stats-container" data-tour-section="lavori-stats">
                <div class="stat-card">
                    <div class="stat-value" id="stat-totale-lavori">0</div>
                    <div class="stat-label">Lavori Totali</div>
                </div>
                <div class="stat-card secondary">
                    <div class="stat-value" id="stat-lavori-corso">0</div>
                    <div class="stat-label">In Corso</div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-value" id="stat-ore-validate">0h</div>
                    <div class="stat-label">Ore Validate</div>
                </div>
                <div class="stat-card danger">
                    <div class="stat-value" id="stat-superficie-lavorata">0 ha</div>
                    <div class="stat-label">Superficie Lavorata</div>
                </div>
                <div class="stat-card stat-card-ritardo">
                    <div class="stat-value" id="stat-lavori-ritardo">0</div>
                    <div class="stat-label">üî¥ In Ritardo</div>
                </div>
                <div class="stat-card stat-card-tempo">
                    <div class="stat-value" id="stat-lavori-tempo">0</div>
                    <div class="stat-label">üü¢ In Tempo</div>
                </div>
                <div class="stat-card stat-card-anticipo">
                    <div class="stat-value" id="stat-lavori-anticipo">0</div>
                    <div class="stat-label">üöÄ In Anticipo</div>
                </div>
            </div>
            
            <div class="section-header">
                <h2>Lavori</h2>
                <div id="lavori-count">0 lavori</div>
            </div>

            <div class="filters" data-tour-section="lavori-filters">
                <div class="filter-group">
                    <label for="filter-stato">Filtra per Stato</label>
                    <select id="filter-stato" onchange="applyFilters()">
                        <option value="">Tutti gli stati</option>
                        <option value="da_pianificare">üìù Da Pianificare</option>
                        <option value="assegnato">Assegnato</option>
                        <option value="in_corso">In corso</option>
                        <option value="completato_da_approvare">In attesa approvazione</option>
                        <option value="completato">Completato</option>
                        <option value="annullato">Annullato</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filter-progresso">Filtra per Stato Progresso</label>
                    <select id="filter-progresso" onchange="applyFilters()">
                        <option value="">Tutti</option>
                        <option value="in_ritardo">üî¥ In ritardo</option>
                        <option value="in_tempo">üü¢ In tempo</option>
                        <option value="in_anticipo">üöÄ In anticipo</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filter-caposquadra">Filtra per Caposquadra</label>
                    <select id="filter-caposquadra" onchange="applyFilters()">
                        <option value="">Tutti i caposquadra</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filter-terreno">Filtra per Terreno</label>
                    <select id="filter-terreno" onchange="applyFilters()">
                        <option value="">Tutti i terreni</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filter-tipo">Filtra per Tipo</label>
                    <select id="filter-tipo" onchange="applyFilters()">
                        <option value="">Tutti i lavori</option>
                        <option value="interno">üè† Lavori Interni</option>
                        <option value="conto_terzi">üíº Conto Terzi</option>
                    </select>
                </div>
                <div class="filter-group" style="align-self: flex-end;">
                    <button class="btn btn-secondary btn-sm" onclick="clearFilters()">Pulisci Filtri</button>
                </div>
            </div>

            <div id="lavori-container" data-tour-section="lavori-list">
                <div class="loading">Caricamento lavori...</div>
            </div>
        </div>
    </div>

    <!-- Modal Dettaglio Lavoro -->
    <div id="dettaglio-modal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3 id="dettaglio-title">Dettaglio Lavoro</h3>
                <button class="close-btn" onclick="closeDettaglioModal()">&times;</button>
            </div>
            
            <div class="modal-tabs">
                <button class="modal-tab active" onclick="switchTab('overview')">üìä Panoramica</button>
                <button class="modal-tab" onclick="switchTab('map')">üó∫Ô∏è Mappa</button>
                <button class="modal-tab" onclick="switchTab('ore')">‚è∞ Ore</button>
            </div>
            
            <!-- Tab Panoramica -->
            <div id="tab-overview" class="tab-content active">
                <div id="dettaglio-overview-content">
                    <div class="loading">Caricamento dettagli...</div>
                </div>
            </div>
            
            <!-- Tab Mappa -->
            <div id="tab-map" class="tab-content">
                <div id="dettaglio-map-content">
                    <div style="margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <h4 style="margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
                            <span>üóìÔ∏è Filtro per Giorno</span>
                        </h4>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                            <label for="filtro-data-zone" style="display: none;">Filtro per Giorno</label>
                            <select id="filtro-data-zone" aria-label="Filtro per Giorno" style="flex: 1; min-width: 200px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                                <option value="tutte">üìÖ Tutte le date</option>
                            </select>
                            <button id="btn-mostra-tutte-zone" class="btn btn-secondary btn-sm" onclick="mostraTutteLeZone()" style="white-space: nowrap;">
                                üëÅÔ∏è Mostra Tutte
                            </button>
                        </div>
                        <div id="info-zone-filtrate" style="margin-top: 10px; font-size: 12px; color: #666;"></div>
                    </div>
                    <div class="map-container" id="dettaglio-map"></div>
                    <div id="zone-list-container">
                        <h4 style="margin-bottom: 10px;">Zone Lavorate</h4>
                        <div class="zone-list" id="zone-list"></div>
                    </div>
                </div>
            </div>
            
            <!-- Tab Ore -->
            <div id="tab-ore" class="tab-content">
                <div id="dettaglio-ore-content">
                    <div class="loading">Caricamento statistiche ore...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Crea/Modifica Lavoro -->
    <div id="lavoro-modal" class="modal">
        <div class="modal-content" data-tour-section="lavoro-form">
            <div class="modal-header">
                <h3 id="modal-title">Crea Nuovo Lavoro</h3>
                <button class="close-btn" onclick="closeLavoroModal()">&times;</button>
            </div>
            <form id="lavoro-form" onsubmit="handleSalvaLavoro(event)">
                <input type="hidden" id="lavoro-id">
                
                <div class="form-group">
                    <label for="lavoro-nome">Nome Lavoro *</label>
                    <input type="text" id="lavoro-nome" required minlength="3" maxlength="100" 
                           placeholder="Es: Potatura Campo Nord, Vendemmia Vigneto Sud">
                </div>

                <div class="form-group">
                    <label for="lavoro-categoria-principale">Categoria Principale Lavoro *</label>
                    <div style="display: flex; gap: 5px;">
                        <select id="lavoro-categoria-principale" required style="flex: 1;">
                            <option value="">-- Seleziona categoria principale --</option>
                        </select>
                        <button type="button" class="btn btn-info btn-sm" onclick="openCategoriaLavoroModal()" style="white-space: nowrap;">‚ûï Nuova</button>
                    </div>
                    <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                        Seleziona la categoria funzionale principale del lavoro
                    </small>
                </div>

                <div class="form-group" id="lavoro-sottocategoria-group" style="display: none;">
                    <label for="lavoro-sottocategoria">Sottocategoria</label>
                    <select id="lavoro-sottocategoria" style="flex: 1;">
                        <option value="">-- Nessuna sottocategoria --</option>
                    </select>
                    <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                        Sottocategoria specifica (opzionale, se disponibile)
                    </small>
                </div>

                <div class="form-group" id="tipo-lavoro-group" style="display: none;">
                    <label for="lavoro-tipo-lavoro">Tipo Lavoro Specifico *</label>
                    <div style="display: flex; gap: 5px;">
                        <select id="lavoro-tipo-lavoro" required style="flex: 1;">
                            <option value="">-- Seleziona tipo lavoro --</option>
                        </select>
                        <button type="button" class="btn btn-info btn-sm" onclick="openTipoLavoroModal()" style="white-space: nowrap;">‚ûï Nuovo</button>
                    </div>
                    <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                        Seleziona il tipo specifico di lavoro nella categoria selezionata
                    </small>
                </div>

                <div class="form-group">
                    <label for="lavoro-terreno">Terreno *</label>
                    <select id="lavoro-terreno" required>
                        <option value="">Seleziona terreno...</option>
                    </select>
                </div>

                <!-- Dropdown Pianificazione Impianto (solo per tipi Impianto) -->
                <div class="form-group" id="pianificazione-impianto-group" style="display: none;">
                    <label for="lavoro-pianificazione-impianto">Pianificazione Impianto</label>
                    <select id="lavoro-pianificazione-impianto">
                        <option value="">-- Seleziona pianificazione (opzionale) --</option>
                    </select>
                    <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                        Seleziona una pianificazione confermata per pre-compilare i dati del vigneto/frutteto/oliveto
                    </small>
                </div>

                <!-- Form Vigneto (solo per Impianto Nuovo Vigneto con pianificazione selezionata) -->
                <div class="form-group" id="vigneto-form-group" style="display: none;">
                    <div style="background: #f0f8ff; padding: 15px; border-radius: 8px; border: 1px solid #b0d4f1; margin-top: 10px;">
                        <h4 style="margin: 0 0 15px 0; color: #2E8B57; font-size: 16px;">üå± Dati Vigneto (pre-compilati dalla pianificazione)</h4>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="vigneto-varieta">Variet√† Uva *</label>
                                <div style="display: flex; gap: 5px;">
                                    <select id="vigneto-varieta" required style="flex: 1;">
                                        <option value="">Seleziona variet√†</option>
                                    </select>
                                    <button type="button" class="btn btn-info btn-sm" onclick="openAddVarietaModal()" style="white-space: nowrap;">‚ûï</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="vigneto-annata-impianto">Anno Impianto *</label>
                                <input type="number" id="vigneto-annata-impianto" required min="1900" max="2100" value="">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="vigneto-portainnesto">Portainnesto</label>
                                <div style="display: flex; gap: 5px;">
                                    <select id="vigneto-portainnesto" style="flex: 1;">
                                        <option value="">Seleziona portainnesto (opzionale)</option>
                                    </select>
                                    <button type="button" class="btn btn-info btn-sm" onclick="openAddPortainnestoModal()" style="white-space: nowrap;">‚ûï</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="vigneto-forma-allevamento">Forma Allevamento *</label>
                                <div style="display: flex; gap: 5px;">
                                    <select id="vigneto-forma-allevamento" required style="flex: 1;">
                                        <option value="">Seleziona forma</option>
                                    </select>
                                    <button type="button" class="btn btn-info btn-sm" onclick="openAddFormaAllevamentoModal()" style="white-space: nowrap;">‚ûï</button>
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="vigneto-distanza-file">Distanza File (m) *</label>
                                <input type="number" id="vigneto-distanza-file" required step="0.1" min="0" readonly style="background: #e9ecef;">
                            </div>
                            <div class="form-group">
                                <label for="vigneto-distanza-unita">Distanza Unit√† (m) *</label>
                                <input type="number" id="vigneto-distanza-unita" required step="0.1" min="0" readonly style="background: #e9ecef;">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="vigneto-superficie-ettari">Superficie (Ha) *</label>
                                <input type="number" id="vigneto-superficie-ettari" required step="0.01" min="0" readonly style="background: #e9ecef;">
                            </div>
                            <div class="form-group">
                                <label for="vigneto-densita">Densit√† (ceppi/ha) *</label>
                                <input type="number" id="vigneto-densita" required step="0.01" min="0" readonly style="background: #e9ecef;">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="vigneto-tipo-palo">Tipo Palo *</label>
                                <div style="display: flex; gap: 5px;">
                                    <select id="vigneto-tipo-palo" required style="flex: 1;">
                                        <option value="">Seleziona tipo palo</option>
                                    </select>
                                    <button type="button" class="btn btn-info btn-sm" onclick="openAddTipoPaloModal()" style="white-space: nowrap;">‚ûï</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="vigneto-destinazione-uva">Destinazione Uva *</label>
                                <select id="vigneto-destinazione-uva" required>
                                    <option value="">Seleziona destinazione</option>
                                    <option value="vino">Vino</option>
                                    <option value="vendita_uva">Vendita Uva</option>
                                    <option value="misto">Misto</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="vigneto-note">Note Vigneto</label>
                            <textarea id="vigneto-note" rows="2" placeholder="Note opzionali sul vigneto..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- Form Frutteto (solo per Impianto Nuovo Frutteto con pianificazione selezionata) -->
                <div class="form-group" id="frutteto-form-group" style="display: none;">
                    <div style="background: #fff3e0; padding: 15px; border-radius: 8px; border: 1px solid #ffcc80; margin-top: 10px;">
                        <h4 style="margin: 0 0 15px 0; color: #E65100; font-size: 16px;">üçé Dati Frutteto (pre-compilati dalla pianificazione)</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="frutteto-specie">Specie *</label>
                                <div style="display: flex; gap: 5px;">
                                    <select id="frutteto-specie" required style="flex: 1;">
                                        <option value="">Seleziona specie</option>
                                    </select>
                                    <button type="button" class="btn btn-info btn-sm" onclick="openAddFruttetoSpecieModal()" style="white-space: nowrap;">‚ûï</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="frutteto-varieta">Variet√† *</label>
                                <div style="display: flex; gap: 5px;">
                                    <select id="frutteto-varieta" required style="flex: 1;">
                                        <option value="">Seleziona variet√†</option>
                                    </select>
                                    <button type="button" class="btn btn-info btn-sm" onclick="openAddFruttetoVarietaModal()" style="white-space: nowrap;">‚ûï</button>
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="frutteto-annata-impianto">Anno Impianto *</label>
                                <input type="number" id="frutteto-annata-impianto" required min="1900" max="2100" value="">
                            </div>
                            <div class="form-group">
                                <label for="frutteto-forma-allevamento">Forma Allevamento *</label>
                                <div style="display: flex; gap: 5px;">
                                    <select id="frutteto-forma-allevamento" required style="flex: 1;">
                                        <option value="">Seleziona forma</option>
                                    </select>
                                    <button type="button" class="btn btn-info btn-sm" onclick="openAddFruttetoFormaAllevamentoModal()" style="white-space: nowrap;">‚ûï</button>
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="frutteto-distanza-file">Distanza File (m) *</label>
                                <input type="number" id="frutteto-distanza-file" required step="0.1" min="0" readonly style="background: #e9ecef;">
                            </div>
                            <div class="form-group">
                                <label for="frutteto-distanza-unita">Distanza Unit√† (m) *</label>
                                <input type="number" id="frutteto-distanza-unita" required step="0.1" min="0" readonly style="background: #e9ecef;">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="frutteto-superficie-ettari">Superficie (Ha) *</label>
                                <input type="number" id="frutteto-superficie-ettari" required step="0.01" min="0" readonly style="background: #e9ecef;">
                            </div>
                            <div class="form-group">
                                <label for="frutteto-densita">Densit√† (piante/ha) *</label>
                                <input type="number" id="frutteto-densita" required step="0.01" min="0" readonly style="background: #e9ecef;">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="frutteto-note">Note Frutteto</label>
                            <textarea id="frutteto-note" rows="2" placeholder="Note opzionali sul frutteto..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Tipo Assegnazione *</label>
                    <div style="display: flex; gap: 20px; margin-top: 8px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="radio" name="tipo-assegnazione" value="squadra" checked id="tipo-squadra">
                            <span>Lavoro di Squadra</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="radio" name="tipo-assegnazione" value="autonomo" id="tipo-autonomo">
                            <span>Lavoro Autonomo</span>
                        </label>
                    </div>
                    <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                        <strong>Squadra:</strong> Assegna a un caposquadra che gestisce una squadra<br>
                        <strong>Autonomo:</strong> Assegna direttamente a un operaio (es. trattorista)
                    </small>
                </div>

                <div class="form-group" id="caposquadra-group">
                    <label for="lavoro-caposquadra" id="label-caposquadra">Caposquadra *</label>
                    <select id="lavoro-caposquadra">
                        <option value="">Seleziona caposquadra...</option>
                    </select>
                    <small id="squadra-info" style="color: #666; font-size: 12px; margin-top: 5px; display: block;"></small>
                </div>

                <div class="form-group" id="operaio-group" style="display: none;">
                    <label for="lavoro-operaio" id="label-operaio">Operaio Responsabile *</label>
                    <select id="lavoro-operaio">
                        <option value="">Seleziona operaio...</option>
                    </select>
                    <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                        <strong>Operaio responsabile del lavoro:</strong> L'operaio che gestisce e coordina il lavoro. 
                        Pu√≤ essere diverso da chi guida la macchina.
                    </small>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="lavoro-data-inizio">Data Inizio *</label>
                        <input type="date" id="lavoro-data-inizio" required>
                    </div>

                    <div class="form-group">
                        <label for="lavoro-durata">Durata Prevista (giorni) *</label>
                        <input type="number" id="lavoro-durata" required min="1" max="365" 
                               placeholder="Es: 3">
                    </div>
                </div>

                <div class="form-group">
                    <label for="lavoro-stato">Stato</label>
                    <select id="lavoro-stato">
                        <option value="da_pianificare">üìù Da Pianificare</option>
                        <option value="assegnato">Assegnato</option>
                        <option value="in_corso">In corso</option>
                        <option value="completato">Completato</option>
                        <option value="annullato">Annullato</option>
                    </select>
                </div>

                <!-- Sezione Macchine (solo se modulo Parco Macchine attivo) -->
                <div id="macchine-section" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 2px solid #e0e0e0;">
                    <h4 style="margin-bottom: 15px; color: #333;">üöú Macchine (Opzionale)</h4>
                    
                    <div class="form-group">
                        <label for="lavoro-trattore">Trattore</label>
                        <select id="lavoro-trattore">
                            <option value="">-- Nessun trattore --</option>
                        </select>
                        <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                            Seleziona un trattore per questo lavoro (opzionale)
                        </small>
                    </div>

                    <div class="form-group" id="attrezzo-group" style="display: none;">
                        <label for="lavoro-attrezzo">Attrezzo</label>
                        <select id="lavoro-attrezzo">
                            <option value="">-- Nessun attrezzo --</option>
                        </select>
                        <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                            Seleziona un attrezzo compatibile con il trattore selezionato
                        </small>
                    </div>

                    <div class="form-group" id="operatore-macchina-group" style="display: none;">
                        <label for="lavoro-operatore-macchina">Operatore Macchina</label>
                        <select id="lavoro-operatore-macchina">
                            <option value="">-- Nessun operatore --</option>
                        </select>
                        <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                            <strong>Chi guida/utilizza la macchina:</strong> L'operaio specifico che guider√† il trattore/utilizzer√† l'attrezzo. 
                            Se non specificato, verr√† usato l'operaio responsabile del lavoro. 
                            <span style="color: #28a745; font-weight: bold;">üí° Tip: Se √® la stessa persona, lascia il campo vuoto.</span>
                        </small>
                    </div>
                </div>

                <div class="form-group">
                    <label for="lavoro-note">Note</label>
                    <textarea id="lavoro-note" placeholder="Note aggiuntive sul lavoro (opzionale)"></textarea>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Salva</button>
                    <button type="button" class="btn btn-secondary" onclick="closeLavoroModal()">Annulla</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Categoria Lavoro -->
    <div id="categoria-lavoro-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Nuova Categoria Lavoro</h3>
                <button class="close-btn" onclick="closeCategoriaLavoroModal()">&times;</button>
            </div>
            <form id="categoria-lavoro-form" onsubmit="handleSalvaCategoriaLavoro(event)">
                <div class="form-group">
                    <label for="categoria-lavoro-nome">Nome Categoria *</label>
                    <input type="text" id="categoria-lavoro-nome" required placeholder="es. Lavorazione del Terreno">
                    <small>Nome descrittivo della categoria</small>
                </div>

                <div class="form-group">
                    <label for="categoria-lavoro-descrizione">Descrizione</label>
                    <textarea id="categoria-lavoro-descrizione" placeholder="Descrizione opzionale della categoria..."></textarea>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">Salva</button>
                    <button type="button" class="btn btn-secondary" onclick="closeCategoriaLavoroModal()">Annulla</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Tipo Lavoro -->
    <div id="tipo-lavoro-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Nuovo Tipo Lavoro</h3>
                <button class="close-btn" onclick="closeTipoLavoroModal()">&times;</button>
            </div>
            <form id="tipo-lavoro-form" onsubmit="handleSalvaTipoLavoro(event)">
                <div class="form-group">
                    <label for="tipo-lavoro-nome">Nome Tipo Lavoro *</label>
                    <input type="text" id="tipo-lavoro-nome" required placeholder="es. Aratura">
                    <small>Nome specifico del tipo di lavoro</small>
                </div>

                <div class="form-group">
                    <label for="tipo-lavoro-categoria">Categoria *</label>
                    <select id="tipo-lavoro-categoria" required>
                        <option value="">-- Seleziona categoria --</option>
                    </select>
                    <small>La categoria selezionata nel form sar√† pre-compilata</small>
                </div>

                <div class="form-group">
                    <label for="tipo-lavoro-descrizione">Descrizione</label>
                    <textarea id="tipo-lavoro-descrizione" placeholder="Descrizione opzionale del tipo lavoro..."></textarea>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">Salva</button>
                    <button type="button" class="btn btn-secondary" onclick="closeTipoLavoroModal()">Annulla</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modali per aggiungere variet√†, portainnesto, forma allevamento, tipo palo (per form vigneto) -->
    <div id="add-varieta-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Aggiungi Nuova Variet√†</h2>
                <button class="close-btn" onclick="closeAddModal('add-varieta-modal')">&times;</button>
            </div>
            <form onsubmit="addNewVarieta(event)">
                <div class="form-group">
                    <label for="new-varieta">Nome Variet√† *</label>
                    <input type="text" id="new-varieta" required placeholder="es. Sangiovese">
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeAddModal('add-varieta-modal')">Annulla</button>
                    <button type="submit" class="btn btn-success">Aggiungi</button>
                </div>
            </form>
        </div>
    </div>

    <div id="add-portainnesto-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Aggiungi Nuovo Portainnesto</h2>
                <button class="close-btn" onclick="closeAddModal('add-portainnesto-modal')">&times;</button>
            </div>
            <form onsubmit="addNewPortainnesto(event)">
                <div class="form-group">
                    <label for="new-portainnesto">Nome Portainnesto *</label>
                    <input type="text" id="new-portainnesto" required placeholder="es. 1103P">
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeAddModal('add-portainnesto-modal')">Annulla</button>
                    <button type="submit" class="btn btn-success">Aggiungi</button>
                </div>
            </form>
        </div>
    </div>

    <div id="add-forma-allevamento-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Aggiungi Nuova Forma di Allevamento</h2>
                <button class="close-btn" onclick="closeAddModal('add-forma-allevamento-modal')">&times;</button>
            </div>
            <form onsubmit="addNewFormaAllevamento(event)">
                <div class="form-group">
                    <label for="new-forma-allevamento">Nome Forma di Allevamento *</label>
                    <input type="text" id="new-forma-allevamento" required placeholder="es. Guyot">
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeAddModal('add-forma-allevamento-modal')">Annulla</button>
                    <button type="submit" class="btn btn-success">Aggiungi</button>
                </div>
            </form>
        </div>
    </div>

    <div id="add-tipo-palo-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Aggiungi Nuovo Tipo Palo</h2>
                <button class="close-btn" onclick="closeAddModal('add-tipo-palo-modal')">&times;</button>
            </div>
            <form onsubmit="addNewTipoPalo(event)">
                <div class="form-group">
                    <label for="new-tipo-palo">Nome Tipo Palo *</label>
                    <input type="text" id="new-tipo-palo" required placeholder="es. Cemento">
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeAddModal('add-tipo-palo-modal')">Annulla</button>
                    <button type="submit" class="btn btn-success">Aggiungi</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modali per form frutteto (specie, variet√†, forma allevamento) -->
    <div id="add-frutteto-specie-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Aggiungi Nuova Specie</h2>
                <button class="close-btn" onclick="closeAddModal('add-frutteto-specie-modal')">&times;</button>
            </div>
            <form onsubmit="addNewFruttetoSpecie(event)">
                <div class="form-group">
                    <label for="new-frutteto-specie">Nome Specie *</label>
                    <input type="text" id="new-frutteto-specie" required placeholder="es. Melo">
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeAddModal('add-frutteto-specie-modal')">Annulla</button>
                    <button type="submit" class="btn btn-success">Aggiungi</button>
                </div>
            </form>
        </div>
    </div>
    <div id="add-frutteto-varieta-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Aggiungi Nuova Variet√†</h2>
                <button class="close-btn" onclick="closeAddModal('add-frutteto-varieta-modal')">&times;</button>
            </div>
            <form onsubmit="addNewFruttetoVarieta(event)">
                <div class="form-group">
                    <label for="new-frutteto-varieta">Nome Variet√† *</label>
                    <input type="text" id="new-frutteto-varieta" required placeholder="es. Gala">
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeAddModal('add-frutteto-varieta-modal')">Annulla</button>
                    <button type="submit" class="btn btn-success">Aggiungi</button>
                </div>
            </form>
        </div>
    </div>
    <div id="add-frutteto-forma-allevamento-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Aggiungi Nuova Forma di Allevamento</h2>
                <button class="close-btn" onclick="closeAddModal('add-frutteto-forma-allevamento-modal')">&times;</button>
            </div>
            <form onsubmit="addNewFruttetoFormaAllevamento(event)">
                <div class="form-group">
                    <label for="new-frutteto-forma-allevamento">Nome Forma *</label>
                    <input type="text" id="new-frutteto-forma-allevamento" required placeholder="es. Fusetto">
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeAddModal('add-frutteto-forma-allevamento-modal')">Annulla</button>
                    <button type="submit" class="btn btn-success">Aggiungi</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Load Firebase config from external file -->
    <script>
        const configScript = document.createElement('script');
        configScript.src = '../config/firebase-config.js';
        configScript.onerror = function() {
            const fallbackScript = document.createElement('script');
            fallbackScript.src = 'https://raw.githubusercontent.com/VitaraDragon/gfv-platform/main/core/config/firebase-config.js';
            document.head.appendChild(fallbackScript);
        };
        document.head.appendChild(configScript);
    </script>
    
    <!-- Load Google Maps config -->
    <script>
        const mapsConfigScript = document.createElement('script');
        mapsConfigScript.src = '../config/google-maps-config.js';
        mapsConfigScript.onerror = function() {
            const fallbackScript = document.createElement('script');
            fallbackScript.src = 'https://raw.githubusercontent.com/VitaraDragon/gfv-platform/main/core/config/google-maps-config.js';
            document.head.appendChild(fallbackScript);
        };
        document.head.appendChild(mapsConfigScript);
    </script>
    
    <!-- Google Maps API -->
    <script>
        // Carica Google Maps API dopo che la config √® pronta
        function loadGoogleMapsAPI() {
            const apiKey = window.GOOGLE_MAPS_API_KEY || 'AIzaSyDno2cpcMHfs_FqhD4-hi_esj6pBixyJBk';
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=geometry&callback=initGoogleMaps`;
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);
        }
        
        window.initGoogleMaps = function() {
        };
        
        // Prova a caricare dopo un breve delay per assicurarsi che la config sia caricata
        setTimeout(loadGoogleMapsAPI, 500);
    </script>
    
    <script src="https://unpkg.com/intro.js/minified/intro.min.js"></script>
    <!-- Firebase SDK -->
    <script type="module">
        // ============================================
        // IMPORT MODULI (prima di tutto)
        // ============================================
        import { 
            waitForConfig as waitForConfigModule,
            setupManodoperaVisibility as setupManodoperaVisibilityModule,
            loadTerreni as loadTerreniModule,
            loadCaposquadra as loadCaposquadraModule,
            loadOperai as loadOperaiModule,
            loadSquadre as loadSquadreModule,
            loadLavori as loadLavoriModule,
            loadCategorieLavori as loadCategorieLavoriModule,
            loadProgressiLavoro as loadProgressiLavoroModule,
            loadTrattori as loadTrattoriModule,
            loadAttrezzi as loadAttrezziModule,
            loadCategorieAttrezzi as loadCategorieAttrezziModule,
            initializeCategorieLavori as initializeCategorieLavoriModule,
            initializeTipiLavoroPredefiniti as initializeTipiLavoroPredefinitiModule,
            loadTipiLavoro as loadTipiLavoroModule,
            populateTerrenoFilter as populateTerrenoFilterModule,
            populateCaposquadraFilter as populateCaposquadraFilterModule,
            populateTerrenoDropdown as populateTerrenoDropdownModule,
            populateCaposquadraDropdown as populateCaposquadraDropdownModule,
            populateOperaiDropdown as populateOperaiDropdownModule,
            populateTrattoriDropdown as populateTrattoriDropdownModule,
            populateCategoriaLavoroDropdown as populateCategoriaLavoroDropdownModule,
            populateSottocategorieLavoro as populateSottocategorieLavoroModule,
            populateTipoLavoroDropdown as populateTipoLavoroDropdownModule,
            loadStatistics as loadStatisticsModule,
            getNomeCategoria as getNomeCategoriaModule,
            updateMacchinaStato as updateMacchinaStatoModule,
            correggiMacchineLavoriCompletati as correggiMacchineLavoriCompletatiModule,
            renderLavori as renderLavoriModule,
            populateAttrezziDropdown as populateAttrezziDropdownModule,
            populateOperatoreMacchinaDropdown as populateOperatoreMacchinaDropdownModule,
            loadDettaglioOverview as loadDettaglioOverviewModule,
            loadDettaglioOre as loadDettaglioOreModule
        } from './js/gestione-lavori-controller.js';

        import {
            showAlert as showAlertUtil,
            escapeHtml as escapeHtmlUtil,
            getStatoFormattato as getStatoFormattatoUtil,
            getStatoProgressoFormattato as getStatoProgressoFormattatoUtil,
            calcolaStatoProgresso as calcolaStatoProgressoUtil,
            applyContoTerziStyles as applyContoTerziStylesUtil,
            updateDashboardLink as updateDashboardLinkUtil
        } from './js/gestione-lavori-utils.js';

        import {
            loadDettaglioMap as loadDettaglioMapModule,
            filtraZonePerData as filtraZonePerDataModule,
            mostraZoneSullaMappa as mostraZoneSullaMappaModule,
            aggiornaListaZone as aggiornaListaZoneModule,
            aggiornaInfoZone as aggiornaInfoZoneModule,
            mostraTutteLeZone as mostraTutteLeZoneModule
        } from './js/gestione-lavori-maps.js';

        import {
            setupTipoAssegnazioneHandlers as setupTipoAssegnazioneHandlersModule,
            setupCategoriaLavoroHandler as setupCategoriaLavoroHandlerModule,
            setupMacchineHandlers as setupMacchineHandlersModule,
            applyFilters as applyFiltersModule,
            clearFilters as clearFiltersModule,
            openCreaModal as openCreaModalModule,
            closeLavoroModal as closeLavoroModalModule,
            openModificaModal as openModificaModalModule,
            openEliminaModal as openEliminaModalModule,
            approvaLavoro as approvaLavoroModule,
            rifiutaLavoro as rifiutaLavoroModule,
            openDettaglioModal as openDettaglioModalModule,
            closeDettaglioModal as closeDettaglioModalModule,
            switchTab as switchTabModule,
            handleSalvaLavoro as handleSalvaLavoroModule,
            generaVoceDiarioContoTerzi as generaVoceDiarioContoTerziModule,
            openCategoriaLavoroModal as openCategoriaLavoroModalModule,
            closeCategoriaLavoroModal as closeCategoriaLavoroModalModule,
            handleSalvaCategoriaLavoro as handleSalvaCategoriaLavoroModule,
            openTipoLavoroModal as openTipoLavoroModalModule,
            closeTipoLavoroModal as closeTipoLavoroModalModule,
            handleSalvaTipoLavoro as handleSalvaTipoLavoroModule
        } from './js/gestione-lavori-events.js';

        import {
            setupLavoriTourButton as setupLavoriTourButtonModule,
            maybeAutoStartLavoriTour as maybeAutoStartLavoriTourModule,
            startLavoriTour as startLavoriTourModule,
            buildLavoriTourSteps as buildLavoriTourStepsModule
        } from './js/gestione-lavori-tour.js';

        // Import per modulo Vigneto (pianificazioni e forme allevamento)
        let getAllPianificazioniModule = null;
        let getFormeAllevamentoListModule = null;
        let getNomeVisualizzatoModule = null;
        let createVignetoModule = null;
        
        // Carica moduli vigneto solo se il modulo √® attivo
        async function loadVignetoModules() {
            try {
                const { getCurrentTenant } = await import('../services/tenant-service.js');
                const tenant = await getCurrentTenant();
                if (tenant && tenant.modules && tenant.modules.includes('vigneto')) {
                    const pianificazioneModule = await import('../../modules/vigneto/services/pianificazione-impianto-service.js');
                    const formeAllevamentoModule = await import('../../modules/vigneto/config/forme-allevamento.js');
                    const vignetiModule = await import('../../modules/vigneto/services/vigneti-service.js');
                    
                    getAllPianificazioniModule = pianificazioneModule.getAllPianificazioni;
                    getFormeAllevamentoListModule = formeAllevamentoModule.getFormeAllevamentoList;
                    getNomeVisualizzatoModule = formeAllevamentoModule.getNomeVisualizzato;
                    createVignetoModule = vignetiModule.createVigneto;
                }
            } catch (error) {
                console.warn('Modulo Vigneto non disponibile:', error);
            }
        }

        // Attendi che le configurazioni siano caricate
        await waitForConfigModule();

        const firebaseConfig = window.firebaseConfig;

        import { initializeFirebase, getAppInstance, getAuthInstance, getDb } from '../services/firebase-service.js';
        import { collection, getDocs, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, query, where, orderBy, serverTimestamp, Timestamp } from '../services/firebase-service.js';
        import { onAuthStateChanged } from '../services/firebase-service.js';

        // Verifica che Google Maps API sia caricata
        if (typeof window.GOOGLE_MAPS_API_KEY === 'undefined') {
            console.warn('Google Maps API Key non trovata. La visualizzazione mappa potrebbe non funzionare.');
        }

        initializeFirebase(firebaseConfig);
        const app = getAppInstance();
        const auth = getAuthInstance();
        const db = getDb();

        // ============================================
        // STATE OBJECT
        // ============================================
        const lavoriState = {
            // Dati
            currentLavoroId: null,
            currentTenantId: null,
            terreniList: [],
            caposquadraList: [],
            operaiList: [],
            squadreList: [],
            lavoriList: [],
            filteredLavoriList: [],
            trattoriList: [],
            attrezziList: [],
            categorieAttrezziList: [],
            categorieLavoriPrincipali: [],
            sottocategorieLavoriMap: new Map(),
            tipiLavoroList: [],
            
            // Google Maps (dettaglio)
            dettaglioMap: null,
            dettaglioMapMarkers: [],
            dettaglioMapPolygons: [],
            allZoneLavorate: [],
            zonePerData: {},
            dateDisponibili: [],
            
            // Moduli
            hasParcoMacchineModule: false,
            hasManodoperaModule: false,
            hasContoTerziModule: false,
            
            // Tour
            lavoriTourAutoRequested: false,
            lavoriTourOpenedModal: false,
            
            // Firebase (riferimenti)
            db,
            auth,
            app
        };

        // ============================================
        // VARIABILI GLOBALI (per compatibilit√†)
        // ============================================
        let currentUserData = null;
        let currentTenantId = null;
        let currentLavoroId = null;
        let terreniList = [];
        let caposquadraList = [];
        let operaiList = [];
        let squadreList = [];
        let lavoriList = [];
        let filteredLavoriList = [];
        
        // Esponi lavoriState globalmente per accesso da funzioni helper
        window.lavoriState = lavoriState;
        let dettaglioMap = null;
        let dettaglioMapMarkers = [];
        let dettaglioMapPolygons = [];
        let trattoriList = [];
        let attrezziList = [];
        let categorieAttrezziList = [];
        let hasParcoMacchineModule = false;
        let hasManodoperaModule = false;
        let hasContoTerziModule = false;
        let categorieLavoriPrincipali = [];
        let sottocategorieLavoriMap = new Map();
        let tipiLavoroList = [];
        const LAVORI_TOUR_STORAGE_KEY = 'gfv_lavori_tour_v1';
        let lavoriTourAutoRequested = false;
        let lavoriTourOpenedModal = false;
        let allZoneLavorate = [];
        let zonePerData = {};
        let dateDisponibili = [];

        // ============================================
        // FUNZIONE UPDATE STATE
        // ============================================
        function updateState(updates) {
            Object.assign(lavoriState, updates);
            // Sincronizza con variabili globali per compatibilit√†
            currentLavoroId = lavoriState.currentLavoroId;
            currentTenantId = currentTenantId || lavoriState.currentTenantId;
            terreniList = lavoriState.terreniList;
            caposquadraList = lavoriState.caposquadraList;
            operaiList = lavoriState.operaiList;
            squadreList = lavoriState.squadreList;
            lavoriList = lavoriState.lavoriList;
            filteredLavoriList = lavoriState.filteredLavoriList;
            trattoriList = lavoriState.trattoriList;
            attrezziList = lavoriState.attrezziList;
            categorieAttrezziList = lavoriState.categorieAttrezziList;
            categorieLavoriPrincipali = lavoriState.categorieLavoriPrincipali;
            sottocategorieLavoriMap = lavoriState.sottocategorieLavoriMap;
            tipiLavoroList = lavoriState.tipiLavoroList;
            dettaglioMap = lavoriState.dettaglioMap;
            dettaglioMapMarkers = lavoriState.dettaglioMapMarkers;
            dettaglioMapPolygons = lavoriState.dettaglioMapPolygons;
            allZoneLavorate = lavoriState.allZoneLavorate;
            zonePerData = lavoriState.zonePerData;
            dateDisponibili = lavoriState.dateDisponibili;
            hasParcoMacchineModule = lavoriState.hasParcoMacchineModule;
            hasManodoperaModule = lavoriState.hasManodoperaModule;
            hasContoTerziModule = lavoriState.hasContoTerziModule;
            lavoriTourAutoRequested = lavoriState.lavoriTourAutoRequested;
            lavoriTourOpenedModal = lavoriState.lavoriTourOpenedModal;
        }

        // ============================================
        // WRAPPER FUNCTIONS
        // ============================================

        // Wrapper per populateTerrenoFilter
        function populateTerrenoFilterWrapper() {
            populateTerrenoFilterModule(lavoriState.terreniList);
        }

        // Wrapper per populateCaposquadraFilter
        function populateCaposquadraFilterWrapper() {
            populateCaposquadraFilterModule(lavoriState.caposquadraList);
        }

        // Wrapper per populateTerrenoDropdown
        function populateTerrenoDropdownWrapper(selectedId = null) {
            populateTerrenoDropdownModule(lavoriState.terreniList, selectedId);
        }

        // Wrapper per populateCaposquadraDropdown
        function populateCaposquadraDropdownWrapper(selectedId = null) {
            populateCaposquadraDropdownModule(lavoriState.caposquadraList, lavoriState.squadreList, selectedId);
        }

        // Wrapper per populateOperaiDropdown
        function populateOperaiDropdownWrapper(selectedId = null) {
            populateOperaiDropdownModule(lavoriState.operaiList, selectedId);
        }

        // Wrapper per populateTrattoriDropdown
        function populateTrattoriDropdownWrapper(trattoriListParam = null) {
            // Usa parametro se passato, altrimenti usa lavoriState.trattoriList
            const trattoriDaUsare = trattoriListParam || lavoriState.trattoriList;
            populateTrattoriDropdownModule(trattoriDaUsare);
        }

        // Wrapper per populateCategoriaLavoroDropdown
        function populateCategoriaLavoroDropdownWrapper(selectedValue = null) {
            populateCategoriaLavoroDropdownModule(lavoriState.categorieLavoriPrincipali, selectedValue);
        }

        // Wrapper per populateSottocategorieLavoro
        function populateSottocategorieLavoroWrapper(parentId, selectedValue = null) {
            populateSottocategorieLavoroModule(parentId, lavoriState.sottocategorieLavoriMap, selectedValue);
        }

        // Wrapper per populateTipoLavoroDropdown
        function populateTipoLavoroDropdownWrapper(categoriaId = null, selectedValue = null, tipiFiltratiPassati = null) {
            populateTipoLavoroDropdownModule(
                categoriaId,
                selectedValue,
                tipiFiltratiPassati,
                lavoriState.tipiLavoroList,
                lavoriState.categorieLavoriPrincipali,
                lavoriState.sottocategorieLavoriMap
            );
        }

        // Wrapper per loadTerreni
        async function loadTerreniWrapper() {
            // Rileva se siamo in modalit√† conto terzi
            const urlParams = new URLSearchParams(window.location.search);
            const contoTerziFromUrl = urlParams.get('contoTerzi');
            const statoFromUrl = urlParams.get('stato');
            const isContoTerziMode = contoTerziFromUrl === 'true' || 
                                    (statoFromUrl === 'da_pianificare' && lavoriState.hasContoTerziModule);
            
            await loadTerreniModule(
                currentTenantId || lavoriState.currentTenantId,
                db,
                app,
                auth,
                lavoriState.terreniList,
                populateTerrenoFilterWrapper,
                populateTerrenoDropdownWrapper,
                isContoTerziMode
            );
            updateState({ terreniList: lavoriState.terreniList });
        }

        // Wrapper per loadCaposquadra
        async function loadCaposquadraWrapper() {
            await loadCaposquadraModule(
                currentTenantId || lavoriState.currentTenantId,
                db,
                lavoriState.caposquadraList,
                populateCaposquadraFilterWrapper,
                populateCaposquadraDropdownWrapper
            );
            updateState({ caposquadraList: lavoriState.caposquadraList });
        }

        // Wrapper per loadOperai
        async function loadOperaiWrapper() {
            await loadOperaiModule(
                currentTenantId || lavoriState.currentTenantId,
                db,
                lavoriState.operaiList,
                populateOperaiDropdownWrapper
            );
            updateState({ operaiList: lavoriState.operaiList });
        }

        // Wrapper per loadSquadre
        async function loadSquadreWrapper() {
            await loadSquadreModule(
                currentTenantId || lavoriState.currentTenantId,
                db,
                lavoriState.squadreList
            );
            updateState({ squadreList: lavoriState.squadreList });
        }

        // Wrapper per loadCategorieLavori
        async function loadCategorieLavoriWrapper() {
            await loadCategorieLavoriModule(
                currentTenantId || lavoriState.currentTenantId,
                db,
                lavoriState.categorieLavoriPrincipali,
                lavoriState.sottocategorieLavoriMap,
                populateCategoriaLavoroDropdownWrapper
            );
            updateState({
                categorieLavoriPrincipali: lavoriState.categorieLavoriPrincipali,
                sottocategorieLavoriMap: lavoriState.sottocategorieLavoriMap
            });
        }

        // Wrapper per loadTipiLavoro
        async function loadTipiLavoroWrapper(categoriaId = null) {
            await loadTipiLavoroModule(
                categoriaId,
                currentTenantId || lavoriState.currentTenantId,
                db,
                app,
                auth,
                lavoriState.tipiLavoroList,
                lavoriState.categorieLavoriPrincipali,
                lavoriState.sottocategorieLavoriMap,
                populateTipoLavoroDropdownWrapper
            );
            updateState({ tipiLavoroList: lavoriState.tipiLavoroList });
        }

        // Wrapper per loadTrattori
        async function loadTrattoriWrapper() {
            try {
                await loadTrattoriModule(
                    currentTenantId || lavoriState.currentTenantId,
                    db,
                    app,
                    auth,
                    lavoriState.trattoriList,
                    populateTrattoriDropdownWrapper
                );
                updateState({ trattoriList: lavoriState.trattoriList });
            } catch (error) {
                console.error('[loadTrattoriWrapper] Errore:', error);
                throw error;
            }
        }

        // Wrapper per loadAttrezzi
        async function loadAttrezziWrapper() {
            const tenantId = currentTenantId || lavoriState.currentTenantId;
            await loadAttrezziModule(
                tenantId,
                db,
                app,
                auth,
                lavoriState.attrezziList
            );
            updateState({ attrezziList: lavoriState.attrezziList });
        }

        // Wrapper per loadCategorieAttrezzi
        async function loadCategorieAttrezziWrapper() {
            await loadCategorieAttrezziModule(
                currentTenantId || lavoriState.currentTenantId,
                db,
                lavoriState.categorieAttrezziList
            );
            updateState({ categorieAttrezziList: lavoriState.categorieAttrezziList });
        }

        // Wrapper per loadStatistics
        async function loadStatisticsWrapper() {
            await loadStatisticsModule(
                currentTenantId || lavoriState.currentTenantId,
                db,
                lavoriState.lavoriList
            );
        }

        // Wrapper per getNomeCategoria
        function getNomeCategoriaWrapper(categoriaId) {
            return getNomeCategoriaModule(
                categoriaId,
                lavoriState.categorieAttrezziList,
                lavoriState.categorieLavoriPrincipali,
                lavoriState.sottocategorieLavoriMap
            );
        }

        // Wrapper per updateMacchinaStato
        async function updateMacchinaStatoWrapper(macchinaId, nuovoStato) {
            await updateMacchinaStatoModule(
                macchinaId,
                nuovoStato,
                currentTenantId || lavoriState.currentTenantId,
                db
            );
        }

        // Wrapper per correggiMacchineLavoriCompletati
        async function correggiMacchineLavoriCompletatiWrapper() {
            await correggiMacchineLavoriCompletatiModule(
                currentTenantId || lavoriState.currentTenantId,
                db,
                lavoriState.lavoriList,
                updateMacchinaStatoWrapper
            );
        }

        // Wrapper per loadLavori
        async function loadLavoriWrapper() {
            await loadLavoriModule(
                currentTenantId || lavoriState.currentTenantId,
                db,
                lavoriState.lavoriList,
                lavoriState.hasParcoMacchineModule,
                correggiMacchineLavoriCompletatiWrapper,
                applyFiltersWrapper,
                showAlertUtil
            );
            updateState({ lavoriList: lavoriState.lavoriList });
            // Carica statistiche dopo aver caricato i lavori
            await loadStatisticsWrapper();
        }

        // Wrapper per setupTipoAssegnazioneHandlers
        function setupTipoAssegnazioneHandlersWrapper() {
            setupTipoAssegnazioneHandlersModule(lavoriState.hasManodoperaModule);
        }

        // Wrapper per setupCategoriaLavoroHandler
        function setupCategoriaLavoroHandlerWrapper() {
            setupCategoriaLavoroHandlerModule(
                populateSottocategorieLavoroWrapper,
                loadTipiLavoroWrapper
            );
        }

        // Setup handler per tipo lavoro Impianto
        function setupTipoLavoroImpiantoHandler() {
            const tipoLavoroSelect = document.getElementById('lavoro-tipo-lavoro');
            const pianificazioneGroup = document.getElementById('pianificazione-impianto-group');
            const vignetoFormGroup = document.getElementById('vigneto-form-group');
            
            if (!tipoLavoroSelect) return;
            
            tipoLavoroSelect.addEventListener('change', async function() {
                const tipoLavoroNome = this.value;
                const isImpianto = tipoLavoroNome && (
                    tipoLavoroNome.includes('Impianto Nuovo Vigneto') ||
                    tipoLavoroNome.includes('Impianto Nuovo Frutteto') ||
                    tipoLavoroNome.includes('Impianto Nuovo Oliveto')
                );
                
                if (isImpianto && getAllPianificazioniModule) {
                    // Mostra dropdown pianificazioni
                    if (pianificazioneGroup) pianificazioneGroup.style.display = 'block';
                    
                    // Carica pianificazioni confermate
                    try {
                        const pianificazioni = await getAllPianificazioniModule();
                        const pianificazioniConfermate = pianificazioni.filter(p => 
                            p.stato === 'confermato' && 
                            ((tipoLavoroNome.includes('Vigneto') && p.tipoColtura === 'vigneto') ||
                             (tipoLavoroNome.includes('Frutteto') && p.tipoColtura === 'frutteto') ||
                             (tipoLavoroNome.includes('Oliveto') && p.tipoColtura === 'oliveto'))
                        );
                        
                        const select = document.getElementById('lavoro-pianificazione-impianto');
                        if (select) {
                            select.innerHTML = '<option value="">-- Seleziona pianificazione (opzionale) --</option>';
                            pianificazioniConfermate.forEach(p => {
                                const terreno = lavoriState.terreniList.find(t => t.id === p.terrenoId);
                                const terrenoNome = terreno ? terreno.nome : 'Terreno sconosciuto';
                                const option = document.createElement('option');
                                option.value = p.id;
                                option.textContent = `${terrenoNome} - ${p.numeroFile || 0} file - ${(p.numeroUnitaTotale || 0).toLocaleString('it-IT')} unit√†`;
                                option.dataset.pianificazione = JSON.stringify(p);
                                select.appendChild(option);
                            });
                        }
                    } catch (error) {
                        console.error('Errore caricamento pianificazioni:', error);
                        if (pianificazioneGroup) pianificazioneGroup.style.display = 'none';
                    }
                } else {
                    // Nascondi dropdown e form vigneto/frutteto
                    if (pianificazioneGroup) pianificazioneGroup.style.display = 'none';
                    if (vignetoFormGroup) vignetoFormGroup.style.display = 'none';
                    const fruttetoFormGroup = document.getElementById('frutteto-form-group');
                    if (fruttetoFormGroup) fruttetoFormGroup.style.display = 'none';
                    setVignetoFormRequired(false);
                    setFruttetoFormRequired(false);
                }
            });
            
            // Handler per cambio pianificazione
            const pianificazioneSelect = document.getElementById('lavoro-pianificazione-impianto');
            const fruttetoFormGroup = document.getElementById('frutteto-form-group');
            if (pianificazioneSelect) {
                pianificazioneSelect.addEventListener('change', function() {
                    const pianificazioneId = this.value;
                    if (pianificazioneId && this.selectedOptions[0] && this.selectedOptions[0].dataset.pianificazione) {
                        const pianificazione = JSON.parse(this.selectedOptions[0].dataset.pianificazione);
                        precompilaFormImpiantoDaPianificazione(pianificazione);
                    } else {
                        if (vignetoFormGroup) vignetoFormGroup.style.display = 'none';
                        if (fruttetoFormGroup) fruttetoFormGroup.style.display = 'none';
                        setVignetoFormRequired(false);
                        setFruttetoFormRequired(false);
                    }
                });
            }
        }

        // Liste predefinite per form vigneto (stesse dell'anagrafica vigneti)
        const VARIETA_PREDEFINITE = [
            // Variet√† italiane rosse
            'Sangiovese', 'Nebbiolo', 'Barbera', 'Montepulciano', 'Primitivo', 'Nero d\'Avola',
            'Aglianico', 'Corvina', 'Negroamaro', 'Dolcetto', 'Cannonau', 'Ciliegiolo',
            'Lagrein', 'Teroldego', 'Refosco', 'Raboso', 'Schiava', 'Marzemino',
            // Variet√† italiane bianche
            'Trebbiano', 'Pinot Grigio', 'Chardonnay', 'Sauvignon Blanc', 'Vermentino',
            'Fiano', 'Grechetto', 'Garganega', 'Cortese', 'Verdicchio', 'Pecorino',
            'Falanghina', 'Glera', 'Moscato', 'Malvasia', 'Gew√ºrztraminer', 'Riesling',
            // Variet√† internazionali
            'Cabernet Sauvignon', 'Merlot', 'Syrah', 'Pinot Noir', 'Cabernet Franc',
            'Grenache', 'Tempranillo', 'Zinfandel', 'Malbec', 'Carm√©n√®re', 'Viognier',
            'S√©millon', 'Chenin Blanc', 'Albari√±o', 'Pinot Bianco', 'M√ºller-Thurgau'
        ];

        const PORTAINNESTO_PREDEFINITI = [
            '1103P', 'SO4', '140Ru', '110R', 'Kober 5BB', '420A', '41B', '3309C',
            '101-14', '161-49', 'Riparia Gloire', 'MGT 101-14', 'MGT 161-49',
            'MGT 3309C', 'MGT 420A', 'MGT 5BB', 'MGT 1103P', 'MGT 110R',
            'Selvatico', 'Franco di piede', 'Rupestris du Lot', 'Berlandieri x Riparia'
        ];

        const TIPI_PALO_PREDEFINITI = [
            'Cemento', 'Cemento armato', 'Ferro', 'Acciaio', 'Acciaio zincato',
            'Ferro zincato a caldo', 'Ferro zincato a freddo',
            'Legno', 'Legno trattato', 'Plastica', 'Fibra di vetro', 'PVC',
            'Bamb√π', 'Alluminio', 'Misto cemento-ferro'
        ];

        // Carica valori personalizzati da localStorage
        function loadCustomValues() {
            return {
                varieta: JSON.parse(localStorage.getItem('vigneto_varieta_custom') || '[]'),
                portainnesto: JSON.parse(localStorage.getItem('vigneto_portainnesto_custom') || '[]'),
                formaAllevamento: JSON.parse(localStorage.getItem('vigneto_forma_allevamento_custom') || '[]'),
                tipoPalo: JSON.parse(localStorage.getItem('vigneto_tipo_palo_custom') || '[]')
            };
        }

        // Salva valori personalizzati in localStorage
        function saveCustomValue(type, value) {
            const key = `vigneto_${type}_custom`;
            const current = JSON.parse(localStorage.getItem(key) || '[]');
            if (!current.includes(value)) {
                current.push(value);
                localStorage.setItem(key, JSON.stringify(current));
            }
        }

        // Popola dropdown form vigneto (con supporto localStorage come anagrafica)
        function popolaDropdownVigneto(selectId, listaPredefinita, customKey) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            const custom = loadCustomValues();
            const customValues = custom[customKey] || [];
            const allValues = [...listaPredefinita, ...customValues].sort();
            
            // Mantieni solo la prima opzione (placeholder)
            const firstOption = select.querySelector('option');
            select.innerHTML = '';
            if (firstOption) {
                select.appendChild(firstOption);
            }
            
            // Aggiungi tutti i valori (predefiniti + custom)
            allValues.forEach(valore => {
                const option = document.createElement('option');
                option.value = valore;
                option.textContent = valore;
                select.appendChild(option);
            });
        }

        // Gestisce l'attributo required per i campi del form vigneto.
        // Obiettivo: evitare che campi required dentro un blocco nascosto (#vigneto-form-group)
        // blocchino il submit quando il lavoro NON √® un impianto vigneto.
        function setVignetoFormRequired(isRequired) {
            const fieldIds = [
                'vigneto-varieta',
                'vigneto-annata-impianto',
                'vigneto-forma-allevamento',
                'vigneto-distanza-file',
                'vigneto-distanza-unita',
                'vigneto-superficie-ettari',
                'vigneto-densita',
                'vigneto-tipo-palo',
                'vigneto-destinazione-uva'
            ];

            fieldIds.forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                if (isRequired) {
                    el.setAttribute('required', '');
                } else {
                    el.removeAttribute('required');
                }
            });
        }

        // Gestisce required per i campi del form frutteto (come per vigneto)
        function setFruttetoFormRequired(isRequired) {
            const fieldIds = [
                'frutteto-specie',
                'frutteto-varieta',
                'frutteto-annata-impianto',
                'frutteto-forma-allevamento',
                'frutteto-distanza-file',
                'frutteto-distanza-unita',
                'frutteto-superficie-ettari',
                'frutteto-densita'
            ];
            fieldIds.forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                if (isRequired) el.setAttribute('required', '');
                else el.removeAttribute('required');
            });
        }

        // Mostra e pre-compila il form corretto (vigneto o frutteto) in base a pianificazione.tipoColtura
        async function precompilaFormImpiantoDaPianificazione(pianificazione) {
            if (!pianificazione) return;
            const vignetoFormGroup = document.getElementById('vigneto-form-group');
            const fruttetoFormGroup = document.getElementById('frutteto-form-group');
            if (vignetoFormGroup) vignetoFormGroup.style.display = 'none';
            if (fruttetoFormGroup) fruttetoFormGroup.style.display = 'none';
            setVignetoFormRequired(false);
            setFruttetoFormRequired(false);
            if (pianificazione.tipoColtura === 'vigneto') {
                await precompilaFormVignetoDaPianificazione(pianificazione);
            } else if (pianificazione.tipoColtura === 'frutteto') {
                await precompilaFormFruttetoDaPianificazione(pianificazione);
            }
        }

        // Pre-compila form vigneto da pianificazione (solo vigneto)
        async function precompilaFormVignetoDaPianificazione(pianificazione) {
            if (!pianificazione || pianificazione.tipoColtura !== 'vigneto') return;
            
            const vignetoFormGroup = document.getElementById('vigneto-form-group');
            if (!vignetoFormGroup) return;
            
            vignetoFormGroup.style.display = 'block';
            setVignetoFormRequired(true);
            
            // Popola dropdown con liste predefinite (con supporto localStorage)
            popolaDropdownVigneto('vigneto-varieta', VARIETA_PREDEFINITE, 'varieta');
            popolaDropdownVigneto('vigneto-portainnesto', PORTAINNESTO_PREDEFINITI, 'portainnesto');
            popolaDropdownVigneto('vigneto-tipo-palo', TIPI_PALO_PREDEFINITI, 'tipoPalo');
            
            // Pre-compila forma allevamento
            if (getFormeAllevamentoListModule && getNomeVisualizzatoModule) {
                const formaAllevamentoEl = document.getElementById('vigneto-forma-allevamento');
                if (formaAllevamentoEl) {
                    const formeList = getFormeAllevamentoListModule();
                    formaAllevamentoEl.innerHTML = '<option value="">Seleziona forma</option>';
                    formeList.forEach(nome => {
                        const option = document.createElement('option');
                        option.value = nome;
                        option.textContent = nome;
                        formaAllevamentoEl.appendChild(option);
                    });
                    
                    // Seleziona forma dalla pianificazione
                    if (pianificazione.formaAllevamento) {
                        const nomeVisualizzato = getNomeVisualizzatoModule(pianificazione.formaAllevamento);
                        if (nomeVisualizzato) {
                            formaAllevamentoEl.value = nomeVisualizzato;
                        }
                    }
                }
            }
            
            // Pre-compila campi dalla pianificazione (readonly)
            const distanzaFileEl = document.getElementById('vigneto-distanza-file');
            const distanzaUnitaEl = document.getElementById('vigneto-distanza-unita');
            const superficieEl = document.getElementById('vigneto-superficie-ettari');
            const densitaEl = document.getElementById('vigneto-densita');
            
            if (distanzaFileEl && pianificazione.distanzaFile) {
                distanzaFileEl.value = pianificazione.distanzaFile;
            }
            if (distanzaUnitaEl && pianificazione.distanzaUnita) {
                distanzaUnitaEl.value = pianificazione.distanzaUnita;
            }
            // Formattazione superficie: 2 decimali
            if (superficieEl && pianificazione.superficieNettaImpianto) {
                superficieEl.value = parseFloat(pianificazione.superficieNettaImpianto).toFixed(2);
            }
            // Formattazione densit√†: numero intero
            if (densitaEl && pianificazione.densitaEffettiva) {
                densitaEl.value = Math.round(pianificazione.densitaEffettiva);
            }
            
            // Pre-compila anno impianto con anno corrente
            const annataEl = document.getElementById('vigneto-annata-impianto');
            if (annataEl && !annataEl.value) {
                annataEl.value = new Date().getFullYear();
            }
            
            // Pre-compila terreno (gi√† selezionato nel form lavoro)
            const terrenoSelect = document.getElementById('lavoro-terreno');
            if (terrenoSelect && pianificazione.terrenoId) {
                terrenoSelect.value = pianificazione.terrenoId;
            }
        }

        // Pre-compila form frutteto da pianificazione (solo frutteto)
        async function precompilaFormFruttetoDaPianificazione(pianificazione) {
            if (!pianificazione || pianificazione.tipoColtura !== 'frutteto') return;
            const fruttetoFormGroup = document.getElementById('frutteto-form-group');
            if (!fruttetoFormGroup) return;
            fruttetoFormGroup.style.display = 'block';
            setFruttetoFormRequired(true);
            try {
                const { SPECIE_FRUTTIFERE, FORME_ALLEVAMENTO_FRUTTETO, VARIETA_PER_SPECIE } = await import('../../modules/frutteto/config/specie-fruttifere.js');
                const customSpecie = JSON.parse(localStorage.getItem('frutteto_specie_custom') || '[]');
                const customVarieta = JSON.parse(localStorage.getItem('frutteto_varieta_custom') || '[]');
                const customForma = JSON.parse(localStorage.getItem('frutteto_forma_allevamento_custom') || '[]');
                const specieSelect = document.getElementById('frutteto-specie');
                const varietaSelect = document.getElementById('frutteto-varieta');
                const formaSelect = document.getElementById('frutteto-forma-allevamento');
                if (specieSelect) {
                    specieSelect.innerHTML = '<option value="">Seleziona specie</option>';
                    [...SPECIE_FRUTTIFERE, ...customSpecie].forEach(s => {
                        const opt = document.createElement('option');
                        opt.value = s;
                        opt.textContent = s;
                        specieSelect.appendChild(opt);
                    });
                }
                if (formaSelect) {
                    formaSelect.innerHTML = '<option value="">Seleziona forma</option>';
                    [...FORME_ALLEVAMENTO_FRUTTETO, ...customForma].sort().forEach(f => {
                        const opt = document.createElement('option');
                        opt.value = f;
                        opt.textContent = f;
                        formaSelect.appendChild(opt);
                    });
                    if (pianificazione.formaAllevamento) formaSelect.value = pianificazione.formaAllevamento;
                }
                function popolaVarieta(specie) {
                    if (!varietaSelect) return;
                    const varietaList = (specie && VARIETA_PER_SPECIE[specie]) ? VARIETA_PER_SPECIE[specie] : [];
                    varietaSelect.innerHTML = '<option value="">Seleziona variet√†</option>';
                    [...varietaList, ...customVarieta].forEach(v => {
                        const opt = document.createElement('option');
                        opt.value = v;
                        opt.textContent = v;
                        varietaSelect.appendChild(opt);
                    });
                }
                if (!specieSelect.dataset.varietaListener) {
                    specieSelect.dataset.varietaListener = '1';
                    specieSelect.addEventListener('change', function() { popolaVarieta(this.value); });
                }
                popolaVarieta(specieSelect.value);
                const distanzaFileEl = document.getElementById('frutteto-distanza-file');
                const distanzaUnitaEl = document.getElementById('frutteto-distanza-unita');
                const superficieEl = document.getElementById('frutteto-superficie-ettari');
                const densitaEl = document.getElementById('frutteto-densita');
                if (distanzaFileEl && pianificazione.distanzaFile) distanzaFileEl.value = pianificazione.distanzaFile;
                if (distanzaUnitaEl && pianificazione.distanzaUnita) distanzaUnitaEl.value = pianificazione.distanzaUnita;
                if (superficieEl && pianificazione.superficieNettaImpianto) superficieEl.value = parseFloat(pianificazione.superficieNettaImpianto).toFixed(2);
                if (densitaEl && pianificazione.densitaEffettiva) densitaEl.value = Math.round(pianificazione.densitaEffettiva);
                const annataEl = document.getElementById('frutteto-annata-impianto');
                if (annataEl && !annataEl.value) annataEl.value = new Date().getFullYear();
                const terrenoSelect = document.getElementById('lavoro-terreno');
                if (terrenoSelect && pianificazione.terrenoId) terrenoSelect.value = pianificazione.terrenoId;
            } catch (err) {
                console.error('Errore precompilazione form frutteto:', err);
            }
        }

        // Funzioni per gestire modali aggiunta valori personalizzati
        window.openAddVarietaModal = function() {
            document.getElementById('add-varieta-modal').classList.add('active');
            setTimeout(() => document.getElementById('new-varieta').focus(), 100);
        };

        window.openAddPortainnestoModal = function() {
            document.getElementById('add-portainnesto-modal').classList.add('active');
            setTimeout(() => document.getElementById('new-portainnesto').focus(), 100);
        };

        window.openAddFormaAllevamentoModal = function() {
            document.getElementById('add-forma-allevamento-modal').classList.add('active');
            setTimeout(() => document.getElementById('new-forma-allevamento').focus(), 100);
        };

        window.openAddTipoPaloModal = function() {
            document.getElementById('add-tipo-palo-modal').classList.add('active');
            setTimeout(() => document.getElementById('new-tipo-palo').focus(), 100);
        };

        window.closeAddModal = function(modalId) {
            document.getElementById(modalId).classList.remove('active');
        };

        window.addNewVarieta = function(e) {
            e.preventDefault();
            const value = document.getElementById('new-varieta').value.trim();
            if (value) {
                saveCustomValue('varieta', value);
                popolaDropdownVigneto('vigneto-varieta', VARIETA_PREDEFINITE, 'varieta');
                const select = document.getElementById('vigneto-varieta');
                if (select) {
                    select.value = value;
                }
                document.getElementById('new-varieta').value = '';
                closeAddModal('add-varieta-modal');
            }
        };

        window.addNewPortainnesto = function(e) {
            e.preventDefault();
            const value = document.getElementById('new-portainnesto').value.trim();
            if (value) {
                saveCustomValue('portainnesto', value);
                popolaDropdownVigneto('vigneto-portainnesto', PORTAINNESTO_PREDEFINITI, 'portainnesto');
                const select = document.getElementById('vigneto-portainnesto');
                if (select) {
                    select.value = value;
                }
                document.getElementById('new-portainnesto').value = '';
                closeAddModal('add-portainnesto-modal');
            }
        };

        window.addNewFormaAllevamento = function(e) {
            e.preventDefault();
            const value = document.getElementById('new-forma-allevamento').value.trim();
            if (value) {
                const select = document.getElementById('vigneto-forma-allevamento');
                if (select) {
                    const option = document.createElement('option');
                    option.value = value;
                    option.textContent = value;
                    select.appendChild(option);
                    select.value = value;
                }
                closeAddModal('add-forma-allevamento-modal');
            }
        };

        window.addNewTipoPalo = function(e) {
            e.preventDefault();
            const value = document.getElementById('new-tipo-palo').value.trim();
            if (value) {
                saveCustomValue('tipoPalo', value);
                popolaDropdownVigneto('vigneto-tipo-palo', TIPI_PALO_PREDEFINITI, 'tipoPalo');
                const select = document.getElementById('vigneto-tipo-palo');
                if (select) {
                    select.value = value;
                }
                document.getElementById('new-tipo-palo').value = '';
                closeAddModal('add-tipo-palo-modal');
            }
        };

        window.openAddFruttetoSpecieModal = function() {
            document.getElementById('add-frutteto-specie-modal').classList.add('active');
            setTimeout(() => document.getElementById('new-frutteto-specie').focus(), 100);
        };
        window.openAddFruttetoVarietaModal = function() {
            document.getElementById('add-frutteto-varieta-modal').classList.add('active');
            setTimeout(() => document.getElementById('new-frutteto-varieta').focus(), 100);
        };
        window.openAddFruttetoFormaAllevamentoModal = function() {
            document.getElementById('add-frutteto-forma-allevamento-modal').classList.add('active');
            setTimeout(() => document.getElementById('new-frutteto-forma-allevamento').focus(), 100);
        };
        function saveFruttetoCustom(key, value) {
            const k = 'frutteto_' + key + '_custom';
            const arr = JSON.parse(localStorage.getItem(k) || '[]');
            if (!arr.includes(value)) { arr.push(value); localStorage.setItem(k, JSON.stringify(arr)); }
        }
        window.addNewFruttetoSpecie = function(e) {
            e.preventDefault();
            const v = document.getElementById('new-frutteto-specie').value.trim();
            if (v) { saveFruttetoCustom('specie', v); const sel = document.getElementById('frutteto-specie'); if (sel) { const o = document.createElement('option'); o.value = v; o.textContent = v; sel.appendChild(o); sel.value = v; } document.getElementById('new-frutteto-specie').value = ''; closeAddModal('add-frutteto-specie-modal'); }
        };
        window.addNewFruttetoVarieta = function(e) {
            e.preventDefault();
            const v = document.getElementById('new-frutteto-varieta').value.trim();
            if (v) { saveFruttetoCustom('varieta', v); const sel = document.getElementById('frutteto-varieta'); if (sel) { const o = document.createElement('option'); o.value = v; o.textContent = v; sel.appendChild(o); sel.value = v; } document.getElementById('new-frutteto-varieta').value = ''; closeAddModal('add-frutteto-varieta-modal'); }
        };
        window.addNewFruttetoFormaAllevamento = function(e) {
            e.preventDefault();
            const v = document.getElementById('new-frutteto-forma-allevamento').value.trim();
            if (v) { saveFruttetoCustom('forma_allevamento', v); const sel = document.getElementById('frutteto-forma-allevamento'); if (sel) { const o = document.createElement('option'); o.value = v; o.textContent = v; sel.appendChild(o); sel.value = v; } document.getElementById('new-frutteto-forma-allevamento').value = ''; closeAddModal('add-frutteto-forma-allevamento-modal'); }
        };

        // Wrapper per setupMacchineHandlers
        function setupMacchineHandlersWrapper(populateAttrezziDropdownCallback, populateOperatoreMacchinaDropdownCallback) {
            setupMacchineHandlersModule(
                populateAttrezziDropdownCallback || populateAttrezziDropdownWrapper,
                populateOperatoreMacchinaDropdownCallback || populateOperatoreMacchinaDropdownWrapper
            );
        }

        // Wrapper per populateAttrezziDropdown
        function populateAttrezziDropdownWrapper(trattoreId) {
            populateAttrezziDropdownModule(
                trattoreId,
                lavoriState.trattoriList,
                lavoriState.attrezziList,
                (categoriaId) => getNomeCategoriaModule(
                    categoriaId,
                    lavoriState.categorieAttrezziList,
                    lavoriState.categorieLavoriPrincipali,
                    lavoriState.sottocategorieLavoriMap
                )
            );
        }

        // Wrapper per populateOperatoreMacchinaDropdown
        function populateOperatoreMacchinaDropdownWrapper() {
            populateOperatoreMacchinaDropdownModule(lavoriState.operaiList);
        }

        // Wrapper per renderLavori
        async function renderLavoriWrapper() {
            await renderLavoriModule(
                lavoriState.filteredLavoriList,
                lavoriState.terreniList,
                lavoriState.caposquadraList,
                lavoriState.squadreList,
                lavoriState.trattoriList,
                lavoriState.attrezziList,
                lavoriState.hasManodoperaModule,
                lavoriState.hasParcoMacchineModule,
                async (lavoroId) => {
                    return await loadProgressiLavoroModule(lavoroId, currentTenantId || lavoriState.currentTenantId, db);
                },
                escapeHtmlUtil,
                getStatoFormattatoUtil,
                getStatoProgressoFormattatoUtil,
                maybeAutoStartLavoriTourWrapper,
                lavoriState.operaiList,
                currentTenantId || lavoriState.currentTenantId,
                db
            );
        }

        // Wrapper per openCreaModal
        async function openCreaModalWrapper() {
            // Rileva se siamo in modalit√† conto terzi
            const urlParams = new URLSearchParams(window.location.search);
            const contoTerziFromUrl = urlParams.get('contoTerzi');
            const statoFromUrl = urlParams.get('stato');
            const isContoTerziMode = contoTerziFromUrl === 'true' || 
                                    (statoFromUrl === 'da_pianificare' && lavoriState.hasContoTerziModule);
            
            // Ricarica le liste necessarie prima di aprire il modal
            // per assicurarsi che siano aggiornate
            // IMPORTANTE: Ricarica i terreni per assicurarsi che siano corretti per la modalit√† corrente
            await loadTerreniWrapper();
            
            if (lavoriState.hasManodoperaModule) {
                await Promise.all([
                    loadCaposquadraWrapper(),
                    loadOperaiWrapper(),
                    loadSquadreWrapper()
                ]);
            }
            
            if (lavoriState.hasParcoMacchineModule) {
                await Promise.all([
                    loadTrattoriWrapper(),
                    loadAttrezziWrapper()
                ]);
            }
            
            await openCreaModalModule(
                lavoriState,
                updateState,
                lavoriState.hasManodoperaModule,
                lavoriState.hasParcoMacchineModule,
                loadCategorieLavoriWrapper,
                loadTipiLavoroWrapper,
                populateTerrenoDropdownWrapper,
                populateCategoriaLavoroDropdownWrapper,
                populateCaposquadraDropdownWrapper,
                populateOperaiDropdownWrapper,
                populateTrattoriDropdownWrapper,
                setupTipoAssegnazioneHandlersWrapper,
                populateAttrezziDropdownWrapper,
                populateOperatoreMacchinaDropdownWrapper,
                setupMacchineHandlersWrapper
            );
        }

        // Wrapper per openModificaModal
        async function openModificaModalWrapper(lavoroId) {
            // Trova il lavoro per determinare se √® conto terzi
            const lavoro = lavoriState.lavoriList.find(l => l.id === lavoroId);
            const isLavoroContoTerzi = lavoro && lavoro.clienteId != null && lavoro.clienteId !== '';
            
            // Rileva se siamo in modalit√† conto terzi (da URL o dal lavoro stesso)
            const urlParams = new URLSearchParams(window.location.search);
            const contoTerziFromUrl = urlParams.get('contoTerzi');
            const statoFromUrl = urlParams.get('stato');
            const isContoTerziMode = contoTerziFromUrl === 'true' || 
                                    (statoFromUrl === 'da_pianificare' && lavoriState.hasContoTerziModule) ||
                                    isLavoroContoTerzi;
            
            // IMPORTANTE: Ricarica i terreni per assicurarsi che siano corretti per la modalit√† corrente
            // Se il lavoro √® conto terzi, dobbiamo caricare terreni clienti
            if (isLavoroContoTerzi || isContoTerziMode) {
                await loadTerreniWrapper();
            }
            
            // Ricarica le liste necessarie prima di aprire il modal
            // per assicurarsi che siano aggiornate
            if (lavoriState.hasManodoperaModule) {
                await Promise.all([
                    loadCaposquadraWrapper(),
                    loadOperaiWrapper(),
                    loadSquadreWrapper()
                ]);
            }
            
            if (lavoriState.hasParcoMacchineModule) {
                await Promise.all([
                    loadTrattoriWrapper(),
                    loadAttrezziWrapper()
                ]);
            }
            
            await openModificaModalModule(
                lavoroId,
                lavoriState,
                updateState,
                lavoriState.lavoriList,
                lavoriState.tipiLavoroList,
                lavoriState.hasManodoperaModule,
                lavoriState.hasParcoMacchineModule,
                populateTerrenoDropdownWrapper,
                populateCategoriaLavoroDropdownWrapper,
                populateTipoLavoroDropdownWrapper,
                populateCaposquadraDropdownWrapper,
                populateOperaiDropdownWrapper,
                populateTrattoriDropdownWrapper,
                populateAttrezziDropdownWrapper,
                populateOperatoreMacchinaDropdownWrapper,
                loadTipiLavoroWrapper,
                setupTipoAssegnazioneHandlersWrapper,
                setupMacchineHandlersWrapper
            );
        }

        // Wrapper per closeLavoroModal
        function closeLavoroModalWrapper() {
            closeLavoroModalModule(lavoriState, updateState);
        }

        // Wrapper per openDettaglioModal
        async function openDettaglioModalWrapper(lavoroId) {
            await openDettaglioModalModule(
                lavoroId,
                lavoriState,
                updateState,
                lavoriState.lavoriList,
                loadDettaglioOverviewWrapper,
                switchTabWrapper
            );
        }

        // Wrapper per closeDettaglioModal
        function closeDettaglioModalWrapper() {
            closeDettaglioModalModule(lavoriState, updateState);
        }

        // Wrapper per switchTab
        async function switchTabWrapper(tabName) {
            await switchTabModule(
                tabName,
                lavoriState,
                loadDettaglioOverviewWrapper,
                loadDettaglioMapWrapper,
                loadDettaglioOreWrapper
            );
        }

        // Wrapper per approvaLavoro
        async function approvaLavoroWrapper(lavoroId) {
            await approvaLavoroModule(
                lavoroId,
                lavoriState.lavoriList,
                currentTenantId || lavoriState.currentTenantId,
                db,
                currentUserData,
                lavoriState.hasParcoMacchineModule,
                lavoriState.hasContoTerziModule,
                updateMacchinaStatoWrapper,
                loadTrattoriWrapper,
                loadAttrezziWrapper,
                loadLavoriWrapper,
                generaVoceDiarioContoTerziWrapper
            );
        }

        // Wrapper per rifiutaLavoro
        async function rifiutaLavoroWrapper(lavoroId) {
            await rifiutaLavoroModule(
                lavoroId,
                lavoriState.lavoriList,
                currentTenantId || lavoriState.currentTenantId,
                db,
                currentUserData,
                loadLavoriWrapper
            );
        }

        // Wrapper per openEliminaModal
        async function openEliminaModalWrapper(lavoroId) {
            await openEliminaModalModule(
                lavoroId,
                lavoriState.lavoriList,
                currentTenantId || lavoriState.currentTenantId,
                db,
                lavoriState.hasParcoMacchineModule,
                updateMacchinaStatoWrapper,
                loadTrattoriWrapper,
                loadAttrezziWrapper,
                loadLavoriWrapper
            );
        }

        // Wrapper per loadDettaglioOverview
        async function loadDettaglioOverviewWrapper(lavoroId) {
            await loadDettaglioOverviewModule(
                lavoroId,
                lavoriState.lavoriList,
                lavoriState.terreniList,
                lavoriState.caposquadraList,
                currentTenantId || lavoriState.currentTenantId,
                db,
                async (lavoroId, currentTenantId, db) => {
                    return await loadProgressiLavoroModule(lavoroId, currentTenantId, db);
                },
                escapeHtmlUtil,
                getStatoFormattatoUtil
            );
        }

        // Wrapper per loadDettaglioOre
        async function loadDettaglioOreWrapper(lavoroId) {
            await loadDettaglioOreModule(
                lavoroId,
                lavoriState.lavoriList,
                currentTenantId || lavoriState.currentTenantId,
                db,
                escapeHtmlUtil
            );
        }

        // Wrapper per generaVoceDiarioContoTerzi
        async function generaVoceDiarioContoTerziWrapper(lavoroId, lavoroData, orariOpzionali = null) {
            await generaVoceDiarioContoTerziModule(
                lavoroId,
                lavoroData,
                orariOpzionali,
                lavoriState.hasContoTerziModule,
                currentTenantId || lavoriState.currentTenantId,
                db,
                currentUserData
            );
        }

        // Wrapper per handleSalvaLavoro
        window.handleSalvaLavoro = async function(event) {
            await handleSalvaLavoroModule(
                event,
                lavoriState,
                updateState,
                currentTenantId || lavoriState.currentTenantId,
                db,
                currentUserData,
                closeLavoroModalWrapper,
                loadLavoriWrapper,
                loadStatisticsWrapper,
                loadTrattoriWrapper,
                loadAttrezziWrapper,
                updateMacchinaStatoWrapper,
                generaVoceDiarioContoTerziWrapper
            );
        };

        // Wrapper per openCategoriaLavoroModal
        window.openCategoriaLavoroModal = function() {
            openCategoriaLavoroModalModule();
        };

        // Wrapper per closeCategoriaLavoroModal
        window.closeCategoriaLavoroModal = function() {
            closeCategoriaLavoroModalModule();
        };

        // Wrapper per handleSalvaCategoriaLavoro
        window.handleSalvaCategoriaLavoro = async function(event) {
            await handleSalvaCategoriaLavoroModule(
                event,
                currentTenantId || lavoriState.currentTenantId,
                db,
                currentUserData,
                loadCategorieLavoriWrapper
            );
        };

        // Wrapper per openTipoLavoroModal
        window.openTipoLavoroModal = function() {
            openTipoLavoroModalModule(
                lavoriState.categorieLavoriPrincipali,
                lavoriState.sottocategorieLavoriMap
            );
        };

        // Wrapper per closeTipoLavoroModal
        window.closeTipoLavoroModal = function() {
            closeTipoLavoroModalModule();
        };

        // Wrapper per handleSalvaTipoLavoro
        window.handleSalvaTipoLavoro = async function(event) {
            await handleSalvaTipoLavoroModule(
                event,
                currentTenantId || lavoriState.currentTenantId,
                db,
                currentUserData,
                lavoriState.categorieLavoriPrincipali,
                lavoriState.sottocategorieLavoriMap,
                loadTipiLavoroWrapper
            );
        };

        // Wrapper per setupLavoriTourButton
        function setupLavoriTourButtonWrapper() {
            setupLavoriTourButtonModule((triggeredManually) => {
                startLavoriTourWrapper(triggeredManually);
            });
        }

        // Wrapper per maybeAutoStartLavoriTour
        function maybeAutoStartLavoriTourWrapper() {
            maybeAutoStartLavoriTourModule(
                lavoriState,
                updateState,
                (triggeredManually) => startLavoriTourWrapper(triggeredManually)
            );
        }

        // Wrapper per startLavoriTour
        function startLavoriTourWrapper(triggeredManually) {
            startLavoriTourModule(
                triggeredManually,
                lavoriState,
                updateState,
                openCreaModalWrapper,
                closeLavoroModalWrapper,
                lavoriState.hasParcoMacchineModule
            );
        }

        // Wrapper per loadDettaglioMap
        async function loadDettaglioMapWrapper(lavoroId) {
            await loadDettaglioMapModule(
                lavoroId,
                lavoriState,
                updateState,
                lavoriState.lavoriList,
                lavoriState.terreniList,
                currentTenantId || lavoriState.currentTenantId,
                db
            );
        }

        // Wrapper per filtraZonePerData (per window.mostraTutteLeZone)
        function filtraZonePerDataWrapper(dataSelezionata) {
            filtraZonePerDataModule(dataSelezionata, lavoriState, updateState);
        }

        // Wrapper per applyFilters
        function applyFiltersWrapper() {
            applyFiltersModule(
                lavoriState.lavoriList,
                lavoriState.filteredLavoriList,
                lavoriState.hasManodoperaModule,
                renderLavoriWrapper // Usa wrapper invece di funzione inline
            );
            updateState({ filteredLavoriList: lavoriState.filteredLavoriList });
        }

        // Wrapper per clearFilters
        function clearFiltersWrapper() {
            clearFiltersModule(
                lavoriState.lavoriList,
                lavoriState.filteredLavoriList,
                lavoriState.hasManodoperaModule,
                applyFiltersWrapper
            );
            updateState({ filteredLavoriList: lavoriState.filteredLavoriList });
        }

        // ============================================
        // ESPOSIZIONE FUNZIONI SU WINDOW (per attributi HTML)
        // ============================================
        window.applyFilters = applyFiltersWrapper;
        window.clearFilters = clearFiltersWrapper;
        window.showAlert = showAlertUtil;
        window.escapeHtml = escapeHtmlUtil;
        window.getStatoFormattato = getStatoFormattatoUtil;
        window.getStatoProgressoFormattato = getStatoProgressoFormattatoUtil;
        window.openCreaModal = openCreaModalWrapper;
        window.openModificaModal = openModificaModalWrapper;
        window.closeLavoroModal = closeLavoroModalWrapper;
        window.openDettaglioModal = openDettaglioModalWrapper;
        window.closeDettaglioModal = closeDettaglioModalWrapper;
        window.switchTab = switchTabWrapper;
        window.approvaLavoro = approvaLavoroWrapper;
        window.rifiutaLavoro = rifiutaLavoroWrapper;
        window.openEliminaModal = openEliminaModalWrapper;
        // Nota: editLavoro e deleteLavoro sono alias di openModificaModal e openEliminaModal
        window.editLavoro = openModificaModalWrapper;
        window.deleteLavoro = openEliminaModalWrapper;

        // Setup tour button all'inizio
        setupLavoriTourButtonWrapper();

        // Verifica autenticazione e permessi
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = '../auth/login-standalone.html';
                return;
            }

            try {
                // Carica dati utente
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                if (userDoc.exists()) {
                    currentUserData = userDoc.data();
                    currentTenantId = currentUserData.tenantId;
                    
                    // Aggiorna state con currentTenantId
                    updateState({ currentTenantId: currentTenantId });
                    
                    // Imposta tenantId nel tenant-service per i servizi
                    try {
                        const { setCurrentTenantId } = await import('../services/tenant-service.js');
                        setCurrentTenantId(currentTenantId);
                    } catch (error) {
                        console.warn('Impossibile impostare tenantId nel servizio:', error);
                    }
                    
                    // Assicura che Firebase sia inizializzato nei servizi
                    try {
                        const { setFirebaseInstances } = await import('../services/firebase-service.js');
                        setFirebaseInstances({ app, db, auth });
                    } catch (error) {
                        console.warn('Impossibile impostare Firebase instances nel servizio:', error);
                    }

                    // Verifica permessi (solo manager e amministratore)
                    if (!currentUserData.ruoli || 
                        (!currentUserData.ruoli.includes('manager') && 
                         !currentUserData.ruoli.includes('amministratore'))) {
                        showAlert('Non hai i permessi per accedere a questa pagina', 'error');
                        setTimeout(() => {
                            window.location.href = '../dashboard-standalone.html';
                        }, 2000);
                        return;
                    }
                    
                    // Mostra link impostazioni (solo Manager/Amministratore, gi√† verificato sopra)
                    const impostazioniLink = document.getElementById('impostazioni-link');
                    if (impostazioniLink) {
                        impostazioniLink.style.display = 'inline-flex';
                    }

                    // Verifica moduli attivi
                    hasManodoperaModule = false;
                    hasContoTerziModule = false;
                    if (currentTenantId) {
                        try {
                            const tenantDoc = await getDoc(doc(db, 'tenants', currentTenantId));
                            if (tenantDoc.exists()) {
                                const tenantData = tenantDoc.data();
                                const modules = Array.isArray(tenantData?.modules) ? tenantData.modules : [];
                                hasManodoperaModule = modules.includes('manodopera');
                                hasParcoMacchineModule = modules.includes('parcoMacchine');
                                hasContoTerziModule = modules.includes('contoTerzi');
                                
                                // Inizializza context Tony con i moduli attivi usando helper
                                if (window.Tony && window.Tony.initContextWithModules) {
                                    window.Tony.initContextWithModules(modules);
                                } else {
                                    // Fallback se helper non disponibile (retry manuale)
                                    var initTonyContext = function(retries) {
                                        retries = retries || 0;
                                        if (window.Tony && typeof window.Tony.setContext === 'function') {
                                            window.Tony.setContext('dashboard', {
                                                info_azienda: { moduli_attivi: modules },
                                                moduli_attivi: modules
                                            });
                                            console.log('[Gestione Lavori] Context Tony inizializzato con moduli:', modules);
                                        } else if (retries < 10) {
                                            setTimeout(function() {
                                                initTonyContext(retries + 1);
                                            }, 500);
                                        }
                                    };
                                    initTonyContext();
                                }
                            }
                        } catch (error) {
                            console.warn('Errore verifica moduli:', error);
                        }
                    }
                    
                    // AGGIORNA LO STATE CON I MODULI!
                    updateState({
                        hasManodoperaModule,
                        hasParcoMacchineModule,
                        hasContoTerziModule
                    });
                    
                    // Mostra/nascondi sezione macchine se modulo Parco Macchine attivo
                    const macchineSection = document.getElementById('macchine-section');
                    if (macchineSection) {
                        macchineSection.style.display = hasParcoMacchineModule ? 'block' : 'none';
                    }

                    // Nascondi/mostra funzionalit√† Manodopera in base al modulo attivo
                    setupManodoperaVisibilityModule(hasManodoperaModule);

                    // Migra prima categorie esistenti (se presenti)
                    await migraCategorieLavoriEsistenti();
                    
                    // Inizializza categorie e tipi lavoro predefiniti se necessario
                    await initializeCategorieLavoriModule(currentTenantId, db);
                    await initializeTipiLavoroPredefinitiModule(currentTenantId, db, app, auth);
                    
                    // Migra dati esistenti dalla lista piatta alla struttura gerarchica
                    await migraDatiEsistenti();
                    
                    // Leggi parametro URL per filtro stato (es: ?stato=da_pianificare)
                    const urlParams = new URLSearchParams(window.location.search);
                    const statoFromUrl = urlParams.get('stato');
                    const contoTerziFromUrl = urlParams.get('contoTerzi');
                    
                    // Rileva se siamo in modalit√† conto terzi
                    const isContoTerziMode = contoTerziFromUrl === 'true' || 
                                            (statoFromUrl === 'da_pianificare' && hasContoTerziModule);
                    
                    if (isContoTerziMode) {
                        // La classe √® gi√† stata aggiunta nello script nell'head, ma verifichiamo
                        document.body.classList.add('conto-terzi-mode');
                        applyContoTerziStylesUtil();
                        updateDashboardLinkUtil();
                    }
                    
                    if (statoFromUrl && hasManodoperaModule) {
                        const filterStatoEl = document.getElementById('filter-stato');
                        if (filterStatoEl) {
                            filterStatoEl.value = statoFromUrl;
                        } else {
                            console.warn('‚ö†Ô∏è Elemento filter-stato non trovato');
                        }
                    }
                    
                    // Se c'√® il parametro lavoroId nell'URL, apri automaticamente il modal dettaglio
                    const lavoroIdFromUrl = urlParams.get('lavoroId');
                    if (lavoroIdFromUrl) {
                        // Attendi che i lavori siano caricati
                        await loadLavoriWrapper();
                        // Apri modal dettaglio
                        setTimeout(async () => {
                            await openDettaglioModalWrapper(lavoroIdFromUrl);
                        }, 500);
                    }
                    
                    // Se stato=da_pianificare e modulo conto terzi attivo, imposta filtro anche senza Manodopera
                    if (statoFromUrl === 'da_pianificare' && hasContoTerziModule && !hasManodoperaModule) {
                        const filterStatoEl = document.getElementById('filter-stato');
                        if (filterStatoEl) {
                            filterStatoEl.value = statoFromUrl;
                        }
                    }
                    
                    // Carica dati iniziali - PRIMA i dati di riferimento (terreni, categorie, ecc.)
                    // poi i lavori che dipendono da questi dati
                    await Promise.all([
                        loadTerreniWrapper(),
                        loadCategorieLavoriWrapper(),
                        loadTipiLavoroWrapper() // Carica tutti i tipi (senza filtro categoria)
                    ]);
                    
                    // Carica dati Manodopera solo se modulo attivo
                    if (hasManodoperaModule) {
                        await Promise.all([
                            loadCaposquadraWrapper(),
                            loadOperaiWrapper(),
                            loadSquadreWrapper()
                        ]);
                    }
                    
                    // Carica macchine solo se modulo Parco Macchine attivo
                    if (hasParcoMacchineModule) {
                        await Promise.all([
                            loadTrattoriWrapper(),
                            loadAttrezziWrapper(),
                            loadCategorieAttrezziWrapper()
                        ]);
                    }
                    
                    // DOPO aver caricato tutti i dati di riferimento, carica i lavori
                    await loadLavoriWrapper();
                    
                    // Applica filtro stato se presente nell'URL (loadLavori chiama gi√† applyFilters, ma lo richiamiamo per sicurezza)
                    if (statoFromUrl) {
                        applyFiltersWrapper();
                    }
                    
                    // Inizializza handler tipo assegnazione solo se Manodopera attivo
                    if (hasManodoperaModule) {
                        setupTipoAssegnazioneHandlersWrapper();
                    }
                    
                    // Inizializza handler categoria lavoro
                    setupCategoriaLavoroHandlerWrapper();
                    
                    // Carica moduli vigneto se disponibili
                    await loadVignetoModules();
                    
                    // Setup handler per tipo lavoro Impianto
                    setupTipoLavoroImpiantoHandler();

                    // All'avvio, i campi dei form vigneto/frutteto non devono bloccare il submit
                    // quando i blocco sono nascosti. Diventano required solo quando mostriamo il form corrispondente.
                    setVignetoFormRequired(false);
                    setFruttetoFormRequired(false);
                    
                    // Inizializza handler macchine se modulo attivo
                    // NOTA: setupMacchineHandlers √® gestito dagli event handlers nei moduli
                    // Ma aggiungiamo anche un listener per quando il modal diventa attivo,
                    // per gestire casi in cui il modal viene aperto in modo diverso
                    if (lavoriState.hasParcoMacchineModule) {
                        const lavoroModal = document.getElementById('lavoro-modal');
                        if (lavoroModal) {
                            // Usa MutationObserver per rilevare quando il modal diventa attivo
                            let lastActiveState = false;
                            const observer = new MutationObserver((mutations) => {
                                mutations.forEach((mutation) => {
                                    if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                                        const isActive = lavoroModal.classList.contains('active');
                                        // Chiama setupMacchineHandlers e setupTipoAssegnazioneHandlers solo quando il modal diventa attivo (transizione da false a true)
                                        if (isActive && !lastActiveState) {
                                            // Usa setTimeout per assicurarsi che il DOM sia completamente pronto
                                            setTimeout(() => {
                                                // Configura handler tipo assegnazione (solo se Manodopera attivo)
                                                if (lavoriState.hasManodoperaModule) {
                                                    setupTipoAssegnazioneHandlersWrapper();
                                                }
                                                
                                                // Configura handler macchine (solo se Parco Macchine attivo)
                                                const trattoreSelect = document.getElementById('lavoro-trattore');
                                                if (trattoreSelect) {
                                                    setupMacchineHandlersWrapper(
                                                        populateAttrezziDropdownWrapper,
                                                        populateOperatoreMacchinaDropdownWrapper
                                                    );
                                                }
                                            }, 100);
                                        }
                                        lastActiveState = isActive;
                                    }
                                });
                            });
                            observer.observe(lavoroModal, {
                                attributes: true,
                                attributeFilter: ['class']
                            });
                        }
                    }
                    
                    // Carica statistiche
                    await loadStatisticsWrapper();
                } else {
                    window.location.href = '../auth/login-standalone.html';
                }
            } catch (error) {
                console.error('Errore:', error);
                showAlert('Errore caricamento dati', 'error');
            }
        });

        // Funzione loadSquadre √® stata estratta nel modulo gestione-lavori-controller.js
        // Usa il wrapper: loadSquadreWrapper

        // Funzione loadAttrezzi √® stata estratta nel modulo gestione-lavori-controller.js
        // Usa il wrapper: loadAttrezziWrapper

        // Funzione loadCategorieAttrezzi √® stata estratta nel modulo gestione-lavori-controller.js
        // Usa il wrapper: loadCategorieAttrezziWrapper

        // Funzione populateTrattoriDropdown √® stata estratta nel modulo gestione-lavori-controller.js
        // Usa il wrapper: populateTrattoriDropdownWrapper

        // Funzioni populateAttrezziDropdown, getNomeCategoria e populateOperatoreMacchinaDropdown
        // sono state estratte nel modulo gestione-lavori-controller.js
        // Usa i wrapper: populateAttrezziDropdownWrapper, getNomeCategoriaWrapper, populateOperatoreMacchinaDropdownWrapper

        // Funzione setupMacchineHandlers √® stata estratta nel modulo gestione-lavori-events.js
        // Usa il wrapper: setupMacchineHandlersWrapper

        // Funzione updateMacchinaStato √® stata estratta nel modulo gestione-lavori-controller.js
        // Usa il wrapper: updateMacchinaStatoWrapper

        // Nota: Le categorie predefinite sono ora gestite dal servizio categorie-service.js
        // che contiene la lista completa e aggiornata con tutte le categorie e sottocategorie
        // Nota: I tipi lavoro predefiniti sono ora gestiti dal servizio tipi-lavoro-service.js

        // Funzione initializeCategorieLavori √® stata estratta nel modulo gestione-lavori-controller.js
        // Usa il wrapper: initializeCategorieLavoriModule (chiamata diretta)

        // Funzione initializeTipiLavoroPredefiniti √® stata estratta nel modulo gestione-lavori-controller.js
        // Usa il wrapper: initializeTipiLavoroPredefinitiModule (chiamata diretta)

        // Funzione loadCategorieLavori √® stata estratta nel modulo gestione-lavori-controller.js
        // Usa il wrapper: loadCategorieLavoriWrapper

        // Funzione populateSottocategorieLavoro √® stata estratta nel modulo gestione-lavori-controller.js
        // Usa il wrapper: populateSottocategorieLavoroWrapper

        // Funzione loadTipiLavoro √® stata estratta nel modulo gestione-lavori-controller.js
        // Usa il wrapper: loadTipiLavoroWrapper

        // Funzione populateCategoriaLavoroDropdown √® stata estratta nel modulo gestione-lavori-controller.js
        // Usa il wrapper: populateCategoriaLavoroDropdownWrapper

        // Funzione populateTipoLavoroDropdown √® stata estratta nel modulo gestione-lavori-controller.js
        // Usa il wrapper: populateTipoLavoroDropdownWrapper

        // Migra categorie lavori esistenti alla collezione unificata
        async function migraCategorieLavoriEsistenti() {
            try {
                if (!currentTenantId) return;
                
                // Verifica se esistono categorie nella vecchia collezione
                const vecchiaCollezioneRef = collection(db, `tenants/${currentTenantId}/categorieLavori`);
                const vecchiaSnapshot = await getDocs(vecchiaCollezioneRef);
                
                if (vecchiaSnapshot.empty) {
                    return; // Niente da migrare
                }
                
                // Verifica se la nuova collezione esiste gi√†
                const nuovaCollezioneRef = collection(db, `tenants/${currentTenantId}/categorie`);
                const nuovaSnapshot = await getDocs(nuovaCollezioneRef);
                
                // Controlla se ci sono gi√† categorie applicabili a lavori
                let haCategorieLavori = false;
                nuovaSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.applicabileA === 'lavori' || data.applicabileA === 'entrambi') {
                        haCategorieLavori = true;
                    }
                });
                
                if (haCategorieLavori) {
                    // Gi√† migrato o inizializzato
                    return;
                }

// Migra ogni categoria
                for (const docSnap of vecchiaSnapshot.docs) {
                    const vecchiaData = docSnap.data();
                    
                    const nuovaCategoriaData = {
                        nome: vecchiaData.nome,
                        codice: vecchiaData.codice || vecchiaData.nome.toLowerCase().replace(/[^a-z0-9]+/g, '_'),
                        descrizione: vecchiaData.descrizione || null,
                        parentId: null, // Tutte le vecchie categorie sono principali
                        applicabileA: 'lavori', // Le vecchie categorie erano solo per lavori
                        predefinita: vecchiaData.predefinita || false,
                        ordine: null,
                        creatoDa: vecchiaData.creatoDa || 'system',
                        createdAt: vecchiaData.createdAt || serverTimestamp(),
                        updatedAt: serverTimestamp()
                    };
                    
                    await addDoc(nuovaCollezioneRef, nuovaCategoriaData);
                }
                
            } catch (error) {
                console.error('Errore migrazione categorie lavori:', error);
                // Non bloccare il caricamento se la migrazione fallisce
            }
        }

        // Migra dati esistenti dalla lista piatta alla struttura gerarchica
        async function migraDatiEsistenti() {
            try {
                if (!currentTenantId) return;
                
                // Migra prima le categorie lavori esistenti
                await migraCategorieLavoriEsistenti();
                
                // Verifica se ci sono tipi lavoro nella lista piatta
                const listeRef = doc(db, `tenants/${currentTenantId}/liste`, 'personalizzate');
                const listeSnap = await getDoc(listeRef);
                
                if (!listeSnap.exists()) {
                    return; // Nessuna lista personalizzata, niente da migrare
                }
                
                const data = listeSnap.data();
                const tipiLavoroPiatti = data.tipiLavoro;
                
                if (!tipiLavoroPiatti || !Array.isArray(tipiLavoroPiatti) || tipiLavoroPiatti.length === 0) {
                    return; // Nessun tipo lavoro nella lista piatta
                }
                
                // Verifica se ci sono gi√† tipi lavoro nella struttura gerarchica
                const tipiRef = collection(db, `tenants/${currentTenantId}/tipiLavoro`);
                const tipiSnapshot = await getDocs(tipiRef);
                
                if (!tipiSnapshot.empty) {
                    // Gi√† migrato, niente da fare
                    return;
                }
                
                // Carica categorie per mappatura (da collezione unificata)
                const categorieRef = collection(db, `tenants/${currentTenantId}/categorie`);
                const categorieSnapshot = await getDocs(categorieRef);
                const categorieMap = new Map(); // codice -> id
                
                categorieSnapshot.forEach(doc => {
                    const catData = doc.data();
                    if (catData.codice) {
                        categorieMap.set(catData.codice, doc.id);
                    }
                });
                
                // Mappatura tipi predefiniti alle categorie
                const mappaturaPredefiniti = {
                    'Potatura': 'potatura',
                    'Raccolta': 'raccolta',
                    'Raccolta frutta': 'raccolta',
                    'Raccolta verdura': 'raccolta',
                    'Trattamento': 'trattamenti',
                    'Semina': 'semina_piantagione',
                    'Aratura': 'lavorazione_terreno',
                    'Irrigazione': 'trattamenti',
                    'Concimazione': 'trattamenti',
                    'Diserbo': 'gestione_verde'
                };
                
                const nomiEsistenti = new Set();
                tipiSnapshot.forEach(doc => {
                    const tipoData = doc.data();
                    if (tipoData.nome) {
                        nomiEsistenti.add(tipoData.nome.toLowerCase());
                    }
                });
                
                let tipiCreati = 0;
                
                // Migra ogni tipo dalla lista piatta
                for (const nomeTipo of tipiLavoroPiatti) {
                    // Salta se gi√† esiste
                    if (nomiEsistenti.has(nomeTipo.toLowerCase())) {
                        continue;
                    }
                    
                    // Determina categoria (usa mappatura o categoria "Altro")
                    const codiceCategoria = mappaturaPredefiniti[nomeTipo] || 'altro';
                    const categoriaId = categorieMap.get(codiceCategoria);
                    
                    if (!categoriaId) {
                        console.warn(`Categoria ${codiceCategoria} non trovata per tipo ${nomeTipo}`);
                        continue;
                    }
                    
                    // Crea tipo lavoro
                    const tipoLavoroData = {
                        nome: nomeTipo,
                        categoriaId: categoriaId,
                        descrizione: 'Migrato da lista piatta',
                        predefinito: false,
                        creatoDa: currentUserData.id,
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp()
                    };
                    
                    await addDoc(tipiRef, tipoLavoroData);
                    nomiEsistenti.add(nomeTipo.toLowerCase());
                    tipiCreati++;
                }
                
                if (tipiCreati > 0) {
                }
            } catch (error) {
                console.error('Errore migrazione dati esistenti:', error);
                // Non bloccare il caricamento della pagina se la migrazione fallisce
            }
        }

        // Funzione setupCategoriaLavoroHandler √® stata estratta nel modulo gestione-lavori-events.js
        // Usa il wrapper: setupCategoriaLavoroHandlerWrapper

        // Funzione correggiMacchineLavoriCompletati √® stata estratta nel modulo gestione-lavori-controller.js
        // Usa il wrapper: correggiMacchineLavoriCompletatiWrapper

        // Funzioni populateTerrenoFilter, populateCaposquadraFilter, populateTerrenoDropdown, populateCaposquadraDropdown, populateOperaiDropdown
        // sono state estratte nel modulo gestione-lavori-controller.js
        // Usa i wrapper: populateTerrenoFilterWrapper, populateCaposquadraFilterWrapper, populateTerrenoDropdownWrapper, populateCaposquadraDropdownWrapper, populateOperaiDropdownWrapper

        // Funzione setupTipoAssegnazioneHandlers √® stata estratta nel modulo gestione-lavori-events.js
        // Usa il wrapper: setupTipoAssegnazioneHandlersWrapper

        // Le funzioni applyFilters e clearFilters sono ora nei wrapper sopra
        // e esposte su window per gli attributi HTML

        // Funzione renderLavori √® stata estratta nel modulo gestione-lavori-controller.js
        // Usa il wrapper: renderLavoriWrapper

        // getStatoFormattato() rimosso - usa getStatoFormattatoUtil dal modulo utils (esposto su window.getStatoFormattato)

        // getStatoProgressoFormattato() rimossa - usa getStatoProgressoFormattatoUtil dal modulo utils (esposto su window.getStatoProgressoFormattato)

        // Apri modal crea lavoro (RIMOSSA - usa openCreaModalWrapper)

        // Apri modal modifica lavoro (RIMOSSA - usa openModificaModalWrapper)
        // Chiudi modal (RIMOSSA - usa closeLavoroModalWrapper)

        // Gestisci salvataggio lavoro (RIMOSSA - usa handleSalvaLavoro wrapper sopra)

        // Apri modal elimina lavoro (RIMOSSA - usa openEliminaModalWrapper)

        // Genera voce diario conto terzi (RIMOSSA - usa generaVoceDiarioContoTerziWrapper sopra)

        // showAlert() rimossa - usa showAlertUtil dal modulo utils (esposto su window.showAlert)

        // Approva lavoro completato dal caposquadra (RIMOSSA - usa approvaLavoroWrapper)
        // Rifiuta lavoro completato dal caposquadra (RIMOSSA - usa rifiutaLavoroWrapper)
        
        // escapeHtml() rimossa - usa escapeHtmlUtil dal modulo utils (esposto su window.escapeHtml)

        // loadStatistics() rimossa - usa loadStatisticsModule dal modulo controller (esposto su loadStatisticsWrapper)

        // Funzione loadProgressiLavoro √® stata estratta nel modulo gestione-lavori-controller.js
        // Usa il wrapper: loadProgressiLavoroModule (chiamata diretta)

        // Apri modal dettaglio lavoro (RIMOSSA - usa openDettaglioModalWrapper)
        // Chiudi modal dettaglio (RIMOSSA - usa closeDettaglioModalWrapper)
        // Cambia tab nel modal (RIMOSSA - usa switchTabWrapper)

        // Funzione loadDettaglioOverview √® stata estratta nel modulo gestione-lavori-controller.js
        // Usa il wrapper: loadDettaglioOverviewWrapper

        // Variabili globali allZoneLavorate, zonePerData, dateDisponibili sono gi√† dichiarate sopra

        // Colori diversi per ogni giorno (palette colori distinte)
        const coloriGiorni = [
            { stroke: '#00FF00', fill: '#00FF00' }, // Verde (giorno 1)
            { stroke: '#0080FF', fill: '#0080FF' }, // Blu (giorno 2)
            { stroke: '#FF8000', fill: '#FF8000' }, // Arancione (giorno 3)
            { stroke: '#FF00FF', fill: '#FF00FF' }, // Magenta (giorno 4)
            { stroke: '#00FFFF', fill: '#00FFFF' }, // Cyan (giorno 5)
            { stroke: '#FFFF00', fill: '#FFFF00' }, // Giallo (giorno 6)
            { stroke: '#FF0080', fill: '#FF0080' }, // Rosa (giorno 7)
            { stroke: '#80FF00', fill: '#80FF00' }, // Verde chiaro (giorno 8)
            { stroke: '#8000FF', fill: '#8000FF' }, // Viola (giorno 9)
            { stroke: '#FF8080', fill: '#FF8080' }  // Salmone (giorno 10)
        ];

        // Funzione loadDettaglioMap √® stata estratta nel modulo gestione-lavori-maps.js
        // Usa il wrapper: loadDettaglioMapWrapper

        // Le seguenti funzioni sono state estratte nel modulo gestione-lavori-maps.js:
        // - filtraZonePerData ‚Üí filtraZonePerDataWrapper
        // - mostraZoneSullaMappa ‚Üí mostraZoneSullaMappaModule (chiamata interna)
        // - aggiornaListaZone ‚Üí aggiornaListaZoneModule (chiamata interna)
        // - aggiornaInfoZone ‚Üí aggiornaInfoZoneModule (chiamata interna)
        // - mostraTutteLeZone ‚Üí mostraTutteLeZoneWrapper

        // Tutte le funzioni seguenti sono state estratte nel modulo gestione-lavori-maps.js
        // e sono state rimosse da qui per evitare duplicazioni
        // Funzioni rimosse: loadDettaglioMap, filtraZonePerData, mostraZoneSullaMappa, aggiornaListaZone, aggiornaInfoZone, mostraTutteLeZone
        // Usa i wrapper: loadDettaglioMapWrapper, filtraZonePerDataWrapper, mostraTutteLeZoneWrapper

        // Funzione loadDettaglioOre √® stata estratta nel modulo gestione-lavori-controller.js
        // Usa il wrapper: loadDettaglioOreWrapper

        // Funzioni per gestire modali categoria e tipo lavoro (RIMOSSE - usa wrapper sopra)
        // Funzioni tour sono state estratte nel modulo gestione-lavori-tour.js
        // Usa i wrapper: setupLavoriTourButtonWrapper, maybeAutoStartLavoriTourWrapper, startLavoriTourWrapper
        
        
        // Funzioni applyContoTerziStyles e updateDashboardLink sono state estratte nel modulo gestione-lavori-utils.js
        // Usa i wrapper: applyContoTerziStylesUtil, updateDashboardLinkUtil
    </script>
    <!-- Tony widget (assistente su tutte le pagine) -->
    <script>
    (function() {
      var path = (window.location.pathname || '').replace(/\\/g, '/');
      var isGH = path.indexOf('/gfv-platform/') >= 0;
      var base = isGH ? (window.location.origin + '/gfv-platform/core') : (path.indexOf('/core/admin/') >= 0 ? '../' : (path.indexOf('/modules/') >= 0 ? '../../../core/' : ''));
      var sep = (base && !base.endsWith('/')) ? '/' : '';
      var link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = (base ? base + sep : '') + 'styles/tony-widget.css';
      document.head.appendChild(link);
      var s = document.createElement('script');
      s.type = 'module';
      s.src = (base ? base + sep : '') + 'js/tony-widget-standalone.js';
      document.body.appendChild(s);
    })();
    </script>
</body>
</html>

