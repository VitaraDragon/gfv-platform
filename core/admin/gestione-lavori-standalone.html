<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Lavori - GFV Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #2E8B57 0%, #228B22 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .btn-primary:hover {
            background: rgba(255,255,255,0.3);
        }

        .modal .btn-primary {
            background: #2E8B57;
            color: white;
            border: none;
        }

        .modal .btn-primary:hover {
            background: #228B22;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }

        .content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .section-header h2 {
            color: #2E8B57;
            font-size: 24px;
        }

        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 12px;
            color: #666;
            font-weight: 500;
        }

        .filter-group select,
        .filter-group input {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
            min-width: 150px;
        }

        .lavori-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .lavori-table th,
        .lavori-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .lavori-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        .lavori-table tr:hover {
            background: #f8f9fa;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
        }

        .badge-assegnato {
            background: #e3f2fd;
            color: #1976d2;
        }

        .badge-in_corso {
            background: #fff3e0;
            color: #f57c00;
        }

        .badge-completato {
            background: #e8f5e9;
            color: #388e3c;
        }

        .badge-annullato {
            background: #ffebee;
            color: #d32f2f;
        }

        .badge-completato_da_approvare {
            background: #fff3cd;
            color: #856404;
        }

        .badge-progresso-in_ritardo {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-progresso-in_tempo {
            background: #d4edda;
            color: #155724;
        }

        .badge-progresso-in_anticipo {
            background: #d1ecf1;
            color: #0c5460;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 700px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: #2E8B57;
            font-size: 20px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .close-btn:hover {
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #2E8B57;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #2E8B57 0%, #228B22 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stat-card.secondary {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        }

        .stat-card.warning {
            background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
        }

        .stat-card.danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .progress-cell {
            min-width: 150px;
        }

        .progress-bar-inline {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 5px;
        }

        .progress-fill-inline {
            height: 100%;
            background: linear-gradient(90deg, #2E8B57 0%, #228B22 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 10px;
            font-weight: 500;
        }

        .progress-text {
            font-size: 12px;
            color: #666;
        }

        .modal-large {
            max-width: 1200px;
        }

        .modal-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }

        .modal-tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 14px;
            color: #666;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
        }

        .modal-tab.active {
            color: #2E8B57;
            border-bottom-color: #2E8B57;
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .map-container {
            width: 100%;
            height: 400px;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .ore-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .ore-stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #2E8B57;
        }

        .ore-stat-value {
            font-size: 24px;
            font-weight: 600;
            color: #2E8B57;
        }

        .ore-stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .zone-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .zone-item {
            padding: 10px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .zone-item:last-child {
            border-bottom: none;
        }

        .zone-info {
            flex: 1;
        }

        .zone-date {
            font-weight: 500;
            color: #333;
        }

        .zone-surface {
            font-size: 12px;
            color: #666;
        }

        @media (max-width: 768px) {
            .lavori-table {
                font-size: 12px;
            }

            .lavori-table th,
            .lavori-table td {
                padding: 8px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>üìã Gestione Lavori</h1>
                <p style="opacity: 0.9; margin-top: 5px;">Pianifica e assegna lavori alle squadre</p>
            </div>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="openCreaModal()">‚ûï Crea Nuovo Lavoro</button>
                <a href="../dashboard-standalone.html" class="btn btn-secondary">‚Üê Dashboard</a>
            </div>
        </div>

        <div class="content">
            <div id="alert-container"></div>
            
            <!-- Card Statistiche -->
            <div class="stats-grid" id="stats-container">
                <div class="stat-card">
                    <div class="stat-value" id="stat-totale-lavori">0</div>
                    <div class="stat-label">Lavori Totali</div>
                </div>
                <div class="stat-card secondary">
                    <div class="stat-value" id="stat-lavori-corso">0</div>
                    <div class="stat-label">In Corso</div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-value" id="stat-ore-validate">0h</div>
                    <div class="stat-label">Ore Validate</div>
                </div>
                <div class="stat-card danger">
                    <div class="stat-value" id="stat-superficie-lavorata">0 ha</div>
                    <div class="stat-label">Superficie Lavorata</div>
                </div>
                <div class="stat-card" style="background: #f8d7da; color: #721c24;">
                    <div class="stat-value" id="stat-lavori-ritardo">0</div>
                    <div class="stat-label">üî¥ In Ritardo</div>
                </div>
                <div class="stat-card" style="background: #d4edda; color: #155724;">
                    <div class="stat-value" id="stat-lavori-tempo">0</div>
                    <div class="stat-label">üü¢ In Tempo</div>
                </div>
                <div class="stat-card" style="background: #d1ecf1; color: #0c5460;">
                    <div class="stat-value" id="stat-lavori-anticipo">0</div>
                    <div class="stat-label">üöÄ In Anticipo</div>
                </div>
            </div>
            
            <div class="section-header">
                <h2>Lavori</h2>
                <div id="lavori-count">0 lavori</div>
            </div>

            <div class="filters">
                <div class="filter-group">
                    <label>Filtra per Stato</label>
                    <select id="filter-stato" onchange="applyFilters()">
                        <option value="">Tutti gli stati</option>
                        <option value="assegnato">Assegnato</option>
                        <option value="in_corso">In corso</option>
                        <option value="completato_da_approvare">In attesa approvazione</option>
                        <option value="completato">Completato</option>
                        <option value="annullato">Annullato</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Filtra per Stato Progresso</label>
                    <select id="filter-progresso" onchange="applyFilters()">
                        <option value="">Tutti</option>
                        <option value="in_ritardo">üî¥ In ritardo</option>
                        <option value="in_tempo">üü¢ In tempo</option>
                        <option value="in_anticipo">üöÄ In anticipo</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Filtra per Caposquadra</label>
                    <select id="filter-caposquadra" onchange="applyFilters()">
                        <option value="">Tutti i caposquadra</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Filtra per Terreno</label>
                    <select id="filter-terreno" onchange="applyFilters()">
                        <option value="">Tutti i terreni</option>
                    </select>
                </div>
                <div class="filter-group" style="align-self: flex-end;">
                    <button class="btn btn-secondary btn-sm" onclick="clearFilters()">Pulisci Filtri</button>
                </div>
            </div>

            <div id="lavori-container">
                <div class="loading">Caricamento lavori...</div>
            </div>
        </div>
    </div>

    <!-- Modal Dettaglio Lavoro -->
    <div id="dettaglio-modal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3 id="dettaglio-title">Dettaglio Lavoro</h3>
                <button class="close-btn" onclick="closeDettaglioModal()">&times;</button>
            </div>
            
            <div class="modal-tabs">
                <button class="modal-tab active" onclick="switchTab('overview')">üìä Panoramica</button>
                <button class="modal-tab" onclick="switchTab('map')">üó∫Ô∏è Mappa</button>
                <button class="modal-tab" onclick="switchTab('ore')">‚è∞ Ore</button>
            </div>
            
            <!-- Tab Panoramica -->
            <div id="tab-overview" class="tab-content active">
                <div id="dettaglio-overview-content">
                    <div class="loading">Caricamento dettagli...</div>
                </div>
            </div>
            
            <!-- Tab Mappa -->
            <div id="tab-map" class="tab-content">
                <div id="dettaglio-map-content">
                    <div class="map-container" id="dettaglio-map"></div>
                    <div id="zone-list-container">
                        <h4 style="margin-bottom: 10px;">Zone Lavorate</h4>
                        <div class="zone-list" id="zone-list"></div>
                    </div>
                </div>
            </div>
            
            <!-- Tab Ore -->
            <div id="tab-ore" class="tab-content">
                <div id="dettaglio-ore-content">
                    <div class="loading">Caricamento statistiche ore...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Crea/Modifica Lavoro -->
    <div id="lavoro-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Crea Nuovo Lavoro</h3>
                <button class="close-btn" onclick="closeLavoroModal()">&times;</button>
            </div>
            <form id="lavoro-form" onsubmit="handleSalvaLavoro(event)">
                <input type="hidden" id="lavoro-id">
                
                <div class="form-group">
                    <label for="lavoro-nome">Nome Lavoro *</label>
                    <input type="text" id="lavoro-nome" required minlength="3" maxlength="100" 
                           placeholder="Es: Potatura Campo Nord, Vendemmia Vigneto Sud">
                </div>

                <div class="form-group">
                    <label for="lavoro-categoria-principale">Categoria Principale Lavoro *</label>
                    <div style="display: flex; gap: 5px;">
                        <select id="lavoro-categoria-principale" required style="flex: 1;">
                            <option value="">-- Seleziona categoria principale --</option>
                        </select>
                        <button type="button" class="btn btn-info btn-sm" onclick="openCategoriaLavoroModal()" style="white-space: nowrap;">‚ûï Nuova</button>
                    </div>
                    <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                        Seleziona la categoria funzionale principale del lavoro
                    </small>
                </div>

                <div class="form-group" id="lavoro-sottocategoria-group" style="display: none;">
                    <label for="lavoro-sottocategoria">Sottocategoria</label>
                    <select id="lavoro-sottocategoria" style="flex: 1;">
                        <option value="">-- Nessuna sottocategoria --</option>
                    </select>
                    <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                        Sottocategoria specifica (opzionale, se disponibile)
                    </small>
                </div>

                <div class="form-group" id="tipo-lavoro-group" style="display: none;">
                    <label for="lavoro-tipo-lavoro">Tipo Lavoro Specifico *</label>
                    <div style="display: flex; gap: 5px;">
                        <select id="lavoro-tipo-lavoro" required style="flex: 1;">
                            <option value="">-- Seleziona tipo lavoro --</option>
                        </select>
                        <button type="button" class="btn btn-info btn-sm" onclick="openTipoLavoroModal()" style="white-space: nowrap;">‚ûï Nuovo</button>
                    </div>
                    <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                        Seleziona il tipo specifico di lavoro nella categoria selezionata
                    </small>
                </div>

                <div class="form-group">
                    <label for="lavoro-terreno">Terreno *</label>
                    <select id="lavoro-terreno" required>
                        <option value="">Seleziona terreno...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Tipo Assegnazione *</label>
                    <div style="display: flex; gap: 20px; margin-top: 8px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="radio" name="tipo-assegnazione" value="squadra" checked id="tipo-squadra">
                            <span>Lavoro di Squadra</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="radio" name="tipo-assegnazione" value="autonomo" id="tipo-autonomo">
                            <span>Lavoro Autonomo</span>
                        </label>
                    </div>
                    <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                        <strong>Squadra:</strong> Assegna a un caposquadra che gestisce una squadra<br>
                        <strong>Autonomo:</strong> Assegna direttamente a un operaio (es. trattorista)
                    </small>
                </div>

                <div class="form-group" id="caposquadra-group">
                    <label for="lavoro-caposquadra">Caposquadra *</label>
                    <select id="lavoro-caposquadra">
                        <option value="">Seleziona caposquadra...</option>
                    </select>
                    <small id="squadra-info" style="color: #666; font-size: 12px; margin-top: 5px; display: block;"></small>
                </div>

                <div class="form-group" id="operaio-group" style="display: none;">
                    <label for="lavoro-operaio">Operaio Responsabile *</label>
                    <select id="lavoro-operaio">
                        <option value="">Seleziona operaio...</option>
                    </select>
                    <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                        <strong>Operaio responsabile del lavoro:</strong> L'operaio che gestisce e coordina il lavoro. 
                        Pu√≤ essere diverso da chi guida la macchina.
                    </small>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="lavoro-data-inizio">Data Inizio *</label>
                        <input type="date" id="lavoro-data-inizio" required>
                    </div>

                    <div class="form-group">
                        <label for="lavoro-durata">Durata Prevista (giorni) *</label>
                        <input type="number" id="lavoro-durata" required min="1" max="365" 
                               placeholder="Es: 3">
                    </div>
                </div>

                <div class="form-group">
                    <label for="lavoro-stato">Stato</label>
                    <select id="lavoro-stato">
                        <option value="assegnato">Assegnato</option>
                        <option value="in_corso">In corso</option>
                        <option value="completato">Completato</option>
                        <option value="annullato">Annullato</option>
                    </select>
                </div>

                <!-- Sezione Macchine (solo se modulo Parco Macchine attivo) -->
                <div id="macchine-section" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 2px solid #e0e0e0;">
                    <h4 style="margin-bottom: 15px; color: #333;">üöú Macchine (Opzionale)</h4>
                    
                    <div class="form-group">
                        <label for="lavoro-trattore">Trattore</label>
                        <select id="lavoro-trattore">
                            <option value="">-- Nessun trattore --</option>
                        </select>
                        <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                            Seleziona un trattore per questo lavoro (opzionale)
                        </small>
                    </div>

                    <div class="form-group" id="attrezzo-group" style="display: none;">
                        <label for="lavoro-attrezzo">Attrezzo</label>
                        <select id="lavoro-attrezzo">
                            <option value="">-- Nessun attrezzo --</option>
                        </select>
                        <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                            Seleziona un attrezzo compatibile con il trattore selezionato
                        </small>
                    </div>

                    <div class="form-group" id="operatore-macchina-group" style="display: none;">
                        <label for="lavoro-operatore-macchina">Operatore Macchina</label>
                        <select id="lavoro-operatore-macchina">
                            <option value="">-- Nessun operatore --</option>
                        </select>
                        <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                            <strong>Chi guida/utilizza la macchina:</strong> L'operaio specifico che guider√† il trattore/utilizzer√† l'attrezzo. 
                            Se non specificato, verr√† usato l'operaio responsabile del lavoro. 
                            <span style="color: #28a745; font-weight: bold;">üí° Tip: Se √® la stessa persona, lascia il campo vuoto.</span>
                        </small>
                    </div>
                </div>

                <div class="form-group">
                    <label for="lavoro-note">Note</label>
                    <textarea id="lavoro-note" placeholder="Note aggiuntive sul lavoro (opzionale)"></textarea>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Salva</button>
                    <button type="button" class="btn btn-secondary" onclick="closeLavoroModal()">Annulla</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Categoria Lavoro -->
    <div id="categoria-lavoro-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Nuova Categoria Lavoro</h3>
                <button class="close-btn" onclick="closeCategoriaLavoroModal()">&times;</button>
            </div>
            <form id="categoria-lavoro-form" onsubmit="handleSalvaCategoriaLavoro(event)">
                <div class="form-group">
                    <label for="categoria-lavoro-nome">Nome Categoria *</label>
                    <input type="text" id="categoria-lavoro-nome" required placeholder="es. Lavorazione del Terreno">
                    <small>Nome descrittivo della categoria</small>
                </div>

                <div class="form-group">
                    <label for="categoria-lavoro-descrizione">Descrizione</label>
                    <textarea id="categoria-lavoro-descrizione" placeholder="Descrizione opzionale della categoria..."></textarea>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">Salva</button>
                    <button type="button" class="btn btn-secondary" onclick="closeCategoriaLavoroModal()">Annulla</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Tipo Lavoro -->
    <div id="tipo-lavoro-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Nuovo Tipo Lavoro</h3>
                <button class="close-btn" onclick="closeTipoLavoroModal()">&times;</button>
            </div>
            <form id="tipo-lavoro-form" onsubmit="handleSalvaTipoLavoro(event)">
                <div class="form-group">
                    <label for="tipo-lavoro-nome">Nome Tipo Lavoro *</label>
                    <input type="text" id="tipo-lavoro-nome" required placeholder="es. Aratura">
                    <small>Nome specifico del tipo di lavoro</small>
                </div>

                <div class="form-group">
                    <label for="tipo-lavoro-categoria">Categoria *</label>
                    <select id="tipo-lavoro-categoria" required>
                        <option value="">-- Seleziona categoria --</option>
                    </select>
                    <small>La categoria selezionata nel form sar√† pre-compilata</small>
                </div>

                <div class="form-group">
                    <label for="tipo-lavoro-descrizione">Descrizione</label>
                    <textarea id="tipo-lavoro-descrizione" placeholder="Descrizione opzionale del tipo lavoro..."></textarea>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">Salva</button>
                    <button type="button" class="btn btn-secondary" onclick="closeTipoLavoroModal()">Annulla</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Load Firebase config from external file -->
    <script>
        const configScript = document.createElement('script');
        configScript.src = '../config/firebase-config.js';
        configScript.onerror = function() {
            const fallbackScript = document.createElement('script');
            fallbackScript.src = 'https://raw.githubusercontent.com/VitaraDragon/gfv-platform/main/core/config/firebase-config.js';
            document.head.appendChild(fallbackScript);
        };
        document.head.appendChild(configScript);
    </script>
    
    <!-- Load Google Maps config -->
    <script>
        const mapsConfigScript = document.createElement('script');
        mapsConfigScript.src = '../config/google-maps-config.js';
        mapsConfigScript.onerror = function() {
            const fallbackScript = document.createElement('script');
            fallbackScript.src = 'https://raw.githubusercontent.com/VitaraDragon/gfv-platform/main/core/config/google-maps-config.js';
            document.head.appendChild(fallbackScript);
        };
        document.head.appendChild(mapsConfigScript);
    </script>
    
    <!-- Google Maps API -->
    <script>
        // Carica Google Maps API dopo che la config √® pronta
        function loadGoogleMapsAPI() {
            const apiKey = window.GOOGLE_MAPS_API_KEY || 'AIzaSyDno2cpcMHfs_FqhD4-hi_esj6pBixyJBk';
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=geometry&callback=initGoogleMaps`;
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);
        }
        
        window.initGoogleMaps = function() {
            console.log('Google Maps API caricata');
        };
        
        // Prova a caricare dopo un breve delay per assicurarsi che la config sia caricata
        setTimeout(loadGoogleMapsAPI, 500);
    </script>
    
    <!-- Firebase SDK -->
    <script type="module">
        // Funzione per attendere il caricamento della configurazione Firebase
        function waitForConfig() {
            return new Promise((resolve, reject) => {
                if (typeof window.firebaseConfig !== 'undefined') {
                    resolve(window.firebaseConfig);
                    return;
                }
                
                let attempts = 0;
                const maxAttempts = 50;
                
                const checkInterval = setInterval(() => {
                    attempts++;
                    if (typeof window.firebaseConfig !== 'undefined') {
                        clearInterval(checkInterval);
                        resolve(window.firebaseConfig);
                    } else if (attempts >= maxAttempts) {
                        clearInterval(checkInterval);
                        reject(new Error('Firebase config not loaded after 5 seconds'));
                    }
                }, 100);
            });
        }

        const firebaseConfig = await waitForConfig();

        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, getDocs, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, query, where, orderBy, serverTimestamp, Timestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // Verifica che Google Maps API sia caricata
        if (typeof window.GOOGLE_MAPS_API_KEY === 'undefined') {
            console.warn('Google Maps API Key non trovata. La visualizzazione mappa potrebbe non funzionare.');
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUserData = null;
        let currentTenantId = null;
        let currentLavoroId = null;
        let terreniList = [];
        let caposquadraList = [];
        let operaiList = [];
        let squadreList = [];
        let lavoriList = [];
        let filteredLavoriList = [];
        let dettaglioMap = null;
        let dettaglioMapMarkers = [];
        let dettaglioMapPolygons = [];
        let trattoriList = [];
        let attrezziList = [];
        let categorieAttrezziList = [];
        let hasParcoMacchineModule = false;
        let categorieLavoriPrincipali = [];
        let sottocategorieLavoriMap = new Map(); // parentId -> Array<sottocategorie>
        let tipiLavoroList = [];

        // Verifica autenticazione e permessi
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = '../auth/login-standalone.html';
                return;
            }

            try {
                // Carica dati utente
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                if (userDoc.exists()) {
                    currentUserData = userDoc.data();
                    currentTenantId = currentUserData.tenantId;

                    // Verifica permessi (solo manager e amministratore)
                    if (!currentUserData.ruoli || 
                        (!currentUserData.ruoli.includes('manager') && 
                         !currentUserData.ruoli.includes('amministratore'))) {
                        showAlert('Non hai i permessi per accedere a questa pagina', 'error');
                        setTimeout(() => {
                            window.location.href = '../dashboard-standalone.html';
                        }, 2000);
                        return;
                    }

                    // Verifica se modulo Manodopera √® attivo
                    let hasManodoperaModule = false;
                    if (currentTenantId) {
                        try {
                            const tenantDoc = await getDoc(doc(db, 'tenants', currentTenantId));
                            if (tenantDoc.exists()) {
                                const tenantData = tenantDoc.data();
                                hasManodoperaModule = tenantData.modules && tenantData.modules.includes('manodopera');
                                hasParcoMacchineModule = tenantData.modules && tenantData.modules.includes('parcoMacchine');
                            }
                        } catch (error) {
                            console.warn('Errore verifica moduli:', error);
                        }
                    }
                    
                    // Mostra/nascondi sezione macchine se modulo Parco Macchine attivo
                    const macchineSection = document.getElementById('macchine-section');
                    if (macchineSection) {
                        macchineSection.style.display = hasParcoMacchineModule ? 'block' : 'none';
                    }

                    // Se modulo Manodopera non √® attivo, mostra avviso e redirect
                    if (!hasManodoperaModule) {
                        showAlert('Questa pagina √® disponibile solo con il modulo Manodopera attivo. Attiva il modulo dall\'abbonamento.', 'error');
                        setTimeout(() => {
                            window.location.href = '../dashboard-standalone.html';
                        }, 3000);
                        return;
                    }

                    // Migra prima categorie esistenti (se presenti)
                    await migraCategorieLavoriEsistenti();
                    
                    // Inizializza categorie e tipi lavoro predefiniti se necessario
                    await initializeCategorieLavori();
                    await initializeTipiLavoroPredefiniti();
                    
                    // Migra dati esistenti dalla lista piatta alla struttura gerarchica
                    await migraDatiEsistenti();
                    
                    // Carica dati iniziali
                    const loadPromises = [
                        loadTerreni(),
                        loadCaposquadra(),
                        loadOperai(),
                        loadSquadre(),
                        loadCategorieLavori(),
                        loadTipiLavoro(), // Carica tutti i tipi (senza filtro categoria)
                        loadLavori()
                    ];
                    
                    // Carica macchine solo se modulo Parco Macchine attivo
                    if (hasParcoMacchineModule) {
                        loadPromises.push(loadTrattori(), loadAttrezzi(), loadCategorieAttrezzi());
                    }
                    
                    await Promise.all(loadPromises);
                    
                    // Inizializza handler tipo assegnazione
                    setupTipoAssegnazioneHandlers();
                    
                    // Inizializza handler categoria lavoro
                    setupCategoriaLavoroHandler();
                    
                    // Inizializza handler macchine se modulo attivo
                    if (hasParcoMacchineModule) {
                        setupMacchineHandlers();
                    }
                    
                    // Carica statistiche
                    await loadStatistics();
                } else {
                    window.location.href = '../auth/login-standalone.html';
                }
            } catch (error) {
                console.error('Errore:', error);
                showAlert('Errore caricamento dati', 'error');
            }
        });

        // Carica lista terreni
        async function loadTerreni() {
            try {
                const terreniRef = collection(db, 'tenants', currentTenantId, 'terreni');
                const q = query(terreniRef, orderBy('nome', 'asc'));
                const snapshot = await getDocs(q);
                
                terreniList = [];
                snapshot.forEach(doc => {
                    terreniList.push({ id: doc.id, ...doc.data() });
                });

                // Popola dropdown filtri
                populateTerrenoFilter();
                populateTerrenoDropdown();
            } catch (error) {
                console.error('Errore caricamento terreni:', error);
                terreniList = [];
            }
        }

        // Carica lista caposquadra disponibili
        async function loadCaposquadra() {
            try {
                const usersRef = collection(db, 'users');
                const q = query(
                    usersRef,
                    where('tenantId', '==', currentTenantId),
                    where('ruoli', 'array-contains', 'caposquadra'),
                    where('stato', '==', 'attivo')
                );
                const snapshot = await getDocs(q);
                
                caposquadraList = [];
                snapshot.forEach(doc => {
                    caposquadraList.push({ id: doc.id, ...doc.data() });
                });

                // Popola dropdown filtri
                populateCaposquadraFilter();
                populateCaposquadraDropdown();
            } catch (error) {
                console.error('Errore caricamento caposquadra:', error);
                caposquadraList = [];
            }
        }

        // Carica lista operai disponibili
        async function loadOperai() {
            try {
                const usersRef = collection(db, 'users');
                const q = query(
                    usersRef,
                    where('tenantId', '==', currentTenantId),
                    where('ruoli', 'array-contains', 'operaio'),
                    where('stato', '==', 'attivo')
                );
                const snapshot = await getDocs(q);
                
                operaiList = [];
                snapshot.forEach(doc => {
                    operaiList.push({ id: doc.id, ...doc.data() });
                });

                // Popola dropdown operai nel form
                populateOperaiDropdown();
            } catch (error) {
                console.error('Errore caricamento operai:', error);
                operaiList = [];
            }
        }

        // Carica lista squadre
        async function loadSquadre() {
            try {
                const squadreRef = collection(db, 'tenants', currentTenantId, 'squadre');
                const q = query(squadreRef, orderBy('nome', 'asc'));
                const snapshot = await getDocs(q);
                
                squadreList = [];
                snapshot.forEach(doc => {
                    squadreList.push({ id: doc.id, ...doc.data() });
                });
            } catch (error) {
                console.error('Errore caricamento squadre:', error);
                squadreList = [];
            }
        }

        // Carica trattori disponibili
        async function loadTrattori() {
            try {
                const macchineRef = collection(db, 'tenants', currentTenantId, 'macchine');
                // Carica tutti i documenti senza filtri/ordinamenti per evitare indici composti
                const snapshot = await getDocs(macchineRef);
                
                trattoriList = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const tipoMacchina = data.tipoMacchina || data.tipo;
                    // Filtra in memoria: solo trattori non dismessi
                    if (tipoMacchina === 'trattore' && data.stato !== 'dismesso') {
                        trattoriList.push({ 
                            id: doc.id, 
                            ...data,
                            tipoMacchina: tipoMacchina
                        });
                    }
                });
                
                // Ordina in memoria per nome
                trattoriList.sort((a, b) => {
                    const nomeA = (a.nome || '').toLowerCase();
                    const nomeB = (b.nome || '').toLowerCase();
                    return nomeA.localeCompare(nomeB);
                });
                
                populateTrattoriDropdown();
            } catch (error) {
                console.error('Errore caricamento trattori:', error);
                trattoriList = [];
            }
        }

        // Carica attrezzi disponibili
        async function loadAttrezzi() {
            try {
                const macchineRef = collection(db, 'tenants', currentTenantId, 'macchine');
                // Carica tutti i documenti senza filtri/ordinamenti per evitare indici composti
                const snapshot = await getDocs(macchineRef);
                
                attrezziList = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const tipoMacchina = data.tipoMacchina || data.tipo;
                    // Filtra in memoria: solo attrezzi non dismessi
                    if (tipoMacchina === 'attrezzo' && data.stato !== 'dismesso') {
                        attrezziList.push({ 
                            id: doc.id, 
                            ...data,
                            tipoMacchina: tipoMacchina
                        });
                    }
                });
                
                // Ordina in memoria per nome
                attrezziList.sort((a, b) => {
                    const nomeA = (a.nome || '').toLowerCase();
                    const nomeB = (b.nome || '').toLowerCase();
                    return nomeA.localeCompare(nomeB);
                });
            } catch (error) {
                console.error('Errore caricamento attrezzi:', error);
                attrezziList = [];
            }
        }

        // Carica categorie attrezzi (da collezione unificata)
        async function loadCategorieAttrezzi() {
            try {
                const categorieRef = collection(db, `tenants/${currentTenantId}/categorie`);
                const q = query(categorieRef, orderBy('ordine', 'asc'));
                const snapshot = await getDocs(q);
                
                categorieAttrezziList = [];
                snapshot.forEach(doc => {
                    const catData = { id: doc.id, ...doc.data() };
                    // Filtra solo categorie applicabili ad attrezzi
                    if (catData.applicabileA === 'attrezzi' || catData.applicabileA === 'entrambi') {
                        categorieAttrezziList.push(catData);
                    }
                });
            } catch (error) {
                console.error('Errore caricamento categorie attrezzi:', error);
                categorieAttrezziList = [];
            }
        }

        // Popola dropdown trattori
        function populateTrattoriDropdown() {
            const select = document.getElementById('lavoro-trattore');
            if (!select) {
                console.warn('Dropdown lavoro-trattore non trovato');
                return;
            }
            
            select.innerHTML = '<option value="">-- Nessun trattore --</option>';
            
            if (!trattoriList || trattoriList.length === 0) {
                console.warn('Nessun trattore disponibile nella lista. Verifica che le macchine siano state caricate correttamente.');
                return;
            }
            
            trattoriList.forEach(trattore => {
                const option = document.createElement('option');
                option.value = trattore.id;
                const nome = trattore.nome || 'Trattore senza nome';
                const cavalli = trattore.cavalli ? ` (${trattore.cavalli} CV)` : '';
                const stato = trattore.stato === 'disponibile' ? '‚úÖ' : trattore.stato === 'in_uso' ? 'üîÑ' : '‚ö†Ô∏è';
                option.textContent = `${stato} ${nome}${cavalli}`;
                option.disabled = trattore.stato === 'in_uso' || trattore.stato === 'in_manutenzione' || trattore.stato === 'guasto';
                select.appendChild(option);
            });
        }

        // Popola dropdown attrezzi compatibili con trattore selezionato
        function populateAttrezziDropdown(trattoreId) {
            const select = document.getElementById('lavoro-attrezzo');
            const attrezzoGroup = document.getElementById('attrezzo-group');
            
            if (!select || !attrezzoGroup) return;
            
            select.innerHTML = '<option value="">-- Nessun attrezzo --</option>';
            
            if (!trattoreId) {
                attrezzoGroup.style.display = 'none';
                return;
            }
            
            const trattore = trattoriList.find(t => t.id === trattoreId);
            if (!trattore || !trattore.cavalli) {
                attrezzoGroup.style.display = 'none';
                return;
            }
            
            attrezzoGroup.style.display = 'block';
            
            // Filtra attrezzi compatibili
            const attrezziCompatibili = attrezziList.filter(attrezzo => {
                if (!attrezzo.cavalliMinimiRichiesti) return false;
                return trattore.cavalli >= attrezzo.cavalliMinimiRichiesti;
            });
            
            if (attrezziCompatibili.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = '-- Nessun attrezzo compatibile --';
                option.disabled = true;
                select.appendChild(option);
                return;
            }
            
            attrezziCompatibili.forEach(attrezzo => {
                const option = document.createElement('option');
                option.value = attrezzo.id;
                const nome = attrezzo.nome || 'Attrezzo senza nome';
                const categoriaNome = getNomeCategoria(attrezzo.categoriaFunzione);
                const cvMin = attrezzo.cavalliMinimiRichiesti ? ` (min ${attrezzo.cavalliMinimiRichiesti} CV)` : '';
                const stato = attrezzo.stato === 'disponibile' ? '‚úÖ' : attrezzo.stato === 'in_uso' ? 'üîÑ' : '‚ö†Ô∏è';
                option.textContent = `${stato} ${nome} - ${categoriaNome}${cvMin}`;
                option.disabled = attrezzo.stato === 'in_uso' || attrezzo.stato === 'in_manutenzione' || attrezzo.stato === 'guasto';
                select.appendChild(option);
            });
        }

        // Helper per ottenere nome categoria (cerca in tutte le categorie)
        function getNomeCategoria(categoriaId) {
            if (!categoriaId) return 'Senza categoria';
            
            // Cerca in categorie attrezzi
            const categoriaAttrezzo = categorieAttrezziList.find(c => c.id === categoriaId);
            if (categoriaAttrezzo) {
                // Se √® una sottocategoria, mostra anche il parent
                if (categoriaAttrezzo.parentId) {
                    const parent = categorieAttrezziList.find(c => c.id === categoriaAttrezzo.parentId);
                    return parent ? `${parent.nome} - ${categoriaAttrezzo.nome}` : categoriaAttrezzo.nome;
                }
                return categoriaAttrezzo.nome;
            }
            
            // Cerca in categorie lavori
            const categoriaLavoro = categorieLavoriPrincipali.find(c => c.id === categoriaId);
            if (categoriaLavoro) return categoriaLavoro.nome;
            
            // Cerca in sottocategorie lavori
            for (const [parentId, sottocat] of sottocategorieLavoriMap.entries()) {
                const sottocategoria = sottocat.find(c => c.id === categoriaId);
                if (sottocategoria) {
                    const parent = categorieLavoriPrincipali.find(c => c.id === parentId);
                    return parent ? `${parent.nome} - ${sottocategoria.nome}` : sottocategoria.nome;
                }
            }
            
            return 'Sconosciuta';
        }

        // Popola dropdown operatore macchina
        function populateOperatoreMacchinaDropdown() {
            const select = document.getElementById('lavoro-operatore-macchina');
            const operatoreGroup = document.getElementById('operatore-macchina-group');
            
            if (!select || !operatoreGroup) return;
            
            // Mostra solo se trattore o attrezzo selezionato
            const trattoreId = document.getElementById('lavoro-trattore')?.value;
            const attrezzoId = document.getElementById('lavoro-attrezzo')?.value;
            
            if (!trattoreId && !attrezzoId) {
                operatoreGroup.style.display = 'none';
                select.innerHTML = '<option value="">-- Nessun operatore --</option>';
                // Rimuovi suggerimento se presente
                const suggerimento = operatoreGroup.querySelector('.suggerimento-operatore');
                if (suggerimento) suggerimento.remove();
                return;
            }
            
            operatoreGroup.style.display = 'block';
            
            // Ottieni operaio responsabile del lavoro (se presente)
            const tipoAssegnazione = document.querySelector('input[name="tipo-assegnazione"]:checked')?.value;
            const operaioResponsabileId = tipoAssegnazione === 'autonomo' 
                ? document.getElementById('lavoro-operaio')?.value 
                : null;
            
            select.innerHTML = '<option value="">-- Usa operaio responsabile --</option>';
            
            // Mostra tutti gli operai attivi, evidenziando quello responsabile
            operaiList.forEach(operaio => {
                const option = document.createElement('option');
                option.value = operaio.id;
                const nomeCompleto = `${operaio.nome || ''} ${operaio.cognome || ''}`.trim() || operaio.email || 'Operaio senza nome';
                
                if (operaio.id === operaioResponsabileId) {
                    option.textContent = `${nomeCompleto} (responsabile lavoro)`;
                    option.style.fontWeight = 'bold';
                } else {
                    option.textContent = nomeCompleto;
                }
                
                select.appendChild(option);
            });
            
            // Rimuovi suggerimento precedente se presente
            const suggerimentoPrecedente = operatoreGroup.querySelector('.suggerimento-operatore');
            if (suggerimentoPrecedente) {
                suggerimentoPrecedente.remove();
            }
            
            // Se c'√® un operaio responsabile, mostra suggerimento
            if (operaioResponsabileId) {
                const operaioResponsabile = operaiList.find(o => o.id === operaioResponsabileId);
                if (operaioResponsabile) {
                    const nomeOp = `${operaioResponsabile.nome || ''} ${operaioResponsabile.cognome || ''}`.trim() || operaioResponsabile.email;
                    const suggerimentoDiv = document.createElement('div');
                    suggerimentoDiv.className = 'suggerimento-operatore';
                    suggerimentoDiv.style.cssText = 'margin-top: 5px; padding: 8px; background: #e7f3ff; border-left: 3px solid #2196F3; border-radius: 4px; font-size: 12px; color: #1976D2;';
                    suggerimentoDiv.innerHTML = `üí° <strong>Suggerimento:</strong> L'operaio responsabile "<strong>${nomeOp}</strong>" sar√† usato come operatore macchina se non ne selezioni uno specifico.`;
                    operatoreGroup.appendChild(suggerimentoDiv);
                }
            }
        }

        // Setup handler per macchine
        function setupMacchineHandlers() {
            const trattoreSelect = document.getElementById('lavoro-trattore');
            const attrezzoSelect = document.getElementById('lavoro-attrezzo');
            const operaioSelect = document.getElementById('lavoro-operaio');
            const tipoAssegnazioneRadios = document.querySelectorAll('input[name="tipo-assegnazione"]');
            
            if (trattoreSelect) {
                trattoreSelect.addEventListener('change', function() {
                    populateAttrezziDropdown(this.value);
                    populateOperatoreMacchinaDropdown();
                });
            }
            
            if (attrezzoSelect) {
                attrezzoSelect.addEventListener('change', function() {
                    populateOperatoreMacchinaDropdown();
                });
            }
            
            // Aggiorna operatore macchina quando cambia l'operaio responsabile
            if (operaioSelect) {
                operaioSelect.addEventListener('change', function() {
                    populateOperatoreMacchinaDropdown();
                });
            }
            
            // Aggiorna operatore macchina quando cambia tipo assegnazione
            tipoAssegnazioneRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    // Aspetta che setupTipoAssegnazioneHandlers aggiorni i dropdown
                    setTimeout(() => {
                        populateOperatoreMacchinaDropdown();
                    }, 100);
                });
            });
        }

        // Aggiorna stato macchina
        async function updateMacchinaStato(macchinaId, nuovoStato) {
            try {
                if (!macchinaId) {
                    console.warn('‚ö†Ô∏è updateMacchinaStato chiamata senza macchinaId');
                    return;
                }
                
                console.log(`üîÑ Aggiornamento stato macchina ${macchinaId} da "${nuovoStato}" a "${nuovoStato}"`);
                
                const macchinaRef = doc(db, 'tenants', currentTenantId, 'macchine', macchinaId);
                
                // Verifica stato attuale prima di aggiornare
                const macchinaDoc = await getDoc(macchinaRef);
                if (macchinaDoc.exists()) {
                    const statoAttuale = macchinaDoc.data().stato;
                    console.log(`  üìä Stato attuale: ${statoAttuale}, nuovo stato: ${nuovoStato}`);
                } else {
                    console.warn(`  ‚ö†Ô∏è Macchina ${macchinaId} non trovata nel database`);
                    return;
                }
                
                await updateDoc(macchinaRef, {
                    stato: nuovoStato,
                    updatedAt: serverTimestamp()
                });
                
                console.log(`  ‚úÖ Stato macchina ${macchinaId} aggiornato con successo a "${nuovoStato}"`);
            } catch (error) {
                console.error(`‚ùå Errore aggiornamento stato macchina ${macchinaId}:`, error);
                // Non bloccare il salvataggio del lavoro se c'√® un errore con la macchina
            }
        }

        // Categorie predefinite
        const CATEGORIE_LAVORI_PREDEFINITE = [
            {
                nome: 'Lavorazione del Terreno',
                codice: 'lavorazione_terreno',
                descrizione: 'Aratura, erpicatura, fresatura, vangatura, ecc.',
                predefinita: true
            },
            {
                nome: 'Trattamenti',
                codice: 'trattamenti',
                descrizione: 'Fitofarmaci, concimazione, irrigazione, ecc.',
                predefinita: true
            },
            {
                nome: 'Potatura',
                codice: 'potatura',
                descrizione: 'Potatura manuale, potatura meccanica, cimatura, ecc.',
                predefinita: true
            },
            {
                nome: 'Raccolta',
                codice: 'raccolta',
                descrizione: 'Raccolta frutta, raccolta verdura, vendemmia, ecc.',
                predefinita: true
            },
            {
                nome: 'Gestione del Verde',
                codice: 'gestione_verde',
                descrizione: 'Falciatura, diserbo, taglio erba, ecc.',
                predefinita: true
            },
            {
                nome: 'Semina e Piantagione',
                codice: 'semina_piantagione',
                descrizione: 'Semina, trapianto, piantagione, ecc.',
                predefinita: true
            },
            {
                nome: 'Manutenzione',
                codice: 'manutenzione',
                descrizione: 'Riparazioni, manutenzione impianti, ecc.',
                applicabileA: 'lavori',
                predefinita: true,
                ordine: 9
            },
            {
                nome: 'Altro',
                codice: 'altro',
                descrizione: 'Altri tipi di lavoro non categorizzabili',
                predefinita: true
            }
        ];

        // Tipi lavoro predefiniti per categoria
        const TIPI_LAVORO_PREDEFINITI = {
            'lavorazione_terreno': [
                { nome: 'Aratura', descrizione: 'Lavorazione profonda del terreno' },
                { nome: 'Erpicatura', descrizione: 'Lavorazione superficiale del terreno' },
                { nome: 'Fresatura', descrizione: 'Frantumazione e rimescolamento del terreno' },
                { nome: 'Vangatura', descrizione: 'Lavorazione manuale o meccanica del terreno' }
            ],
            'trattamenti': [
                { nome: 'Trattamento Fitofarmaci', descrizione: 'Trattamento con prodotti fitosanitari' },
                { nome: 'Concimazione', descrizione: 'Distribuzione di concimi' },
                { nome: 'Irrigazione', descrizione: 'Somministrazione di acqua alle colture' }
            ],
            'potatura': [
                { nome: 'Potatura Manuale', descrizione: 'Potatura eseguita manualmente' },
                { nome: 'Potatura Meccanica', descrizione: 'Potatura eseguita con macchine' },
                { nome: 'Cimatura', descrizione: 'Taglio delle cime delle piante' }
            ],
            'raccolta': [
                { nome: 'Raccolta Frutta', descrizione: 'Raccolta di frutti' },
                { nome: 'Raccolta Verdura', descrizione: 'Raccolta di verdure' },
                { nome: 'Vendemmia', descrizione: 'Raccolta dell\'uva' }
            ],
            'gestione_verde': [
                { nome: 'Falciatura', descrizione: 'Taglio dell\'erba' },
                { nome: 'Diserbo', descrizione: 'Eliminazione delle erbe infestanti' },
                { nome: 'Taglio Erba', descrizione: 'Taglio dell\'erba con macchine' }
            ],
            'semina_piantagione': [
                { nome: 'Semina', descrizione: 'Semina di semi' },
                { nome: 'Trapianto', descrizione: 'Trapianto di piantine' },
                { nome: 'Piantagione', descrizione: 'Piantagione di piante' }
            ],
            'manutenzione': [
                { nome: 'Riparazioni', descrizione: 'Riparazioni di attrezzature o impianti' },
                { nome: 'Manutenzione Impianti', descrizione: 'Manutenzione di impianti irrigui o altri' }
            ],
            'altro': [
                { nome: 'Altro', descrizione: 'Altri tipi di lavoro' }
            ]
        };

        // Inizializza categorie lavori predefinite (usa collezione unificata)
        async function initializeCategorieLavori() {
            try {
                if (!currentTenantId) return;
                
                const categorieRef = collection(db, `tenants/${currentTenantId}/categorie`);
                const snapshot = await getDocs(categorieRef);
                const codiciEsistenti = new Set();
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.codice) {
                        codiciEsistenti.add(data.codice);
                    }
                });
                
                // Crea categorie predefinite mancanti nella collezione unificata
                for (const categoriaPredefinita of CATEGORIE_LAVORI_PREDEFINITE) {
                    if (!codiciEsistenti.has(categoriaPredefinita.codice)) {
                        const categoriaData = {
                            ...categoriaPredefinita,
                            parentId: null, // Tutte le categorie predefinite sono principali
                            applicabileA: categoriaPredefinita.applicabileA || 'lavori', // Di default per lavori
                            ordine: categoriaPredefinita.ordine || null,
                            creatoDa: 'system',
                            createdAt: serverTimestamp(),
                            updatedAt: serverTimestamp()
                        };
                        await addDoc(categorieRef, categoriaData);
                        codiciEsistenti.add(categoriaPredefinita.codice);
                    }
                }
            } catch (error) {
                console.error('Errore inizializzazione categorie lavori:', error);
            }
        }

        // Inizializza tipi lavoro predefiniti (usa collezione unificata)
        async function initializeTipiLavoroPredefiniti() {
            try {
                if (!currentTenantId) return;
                
                // Carica categorie dalla collezione unificata per ottenere ID
                const categorieRef = collection(db, `tenants/${currentTenantId}/categorie`);
                const categorieSnapshot = await getDocs(categorieRef);
                const categorieMap = new Map(); // codice -> id
                
                categorieSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.codice) {
                        categorieMap.set(data.codice, doc.id);
                    }
                });
                
                // Carica tipi esistenti
                const tipiRef = collection(db, `tenants/${currentTenantId}/tipiLavoro`);
                const tipiSnapshot = await getDocs(tipiRef);
                const nomiEsistenti = new Set();
                
                tipiSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.nome) {
                        nomiEsistenti.add(data.nome.toLowerCase());
                    }
                });
                
                // Crea tipi predefiniti mancanti
                for (const [codiceCategoria, tipi] of Object.entries(TIPI_LAVORO_PREDEFINITI)) {
                    // Cerca categoria principale o sottocategoria
                    let categoriaId = categorieMap.get(codiceCategoria);
                    
                    // Se non trovata come principale, cerca sottocategorie
                    if (!categoriaId) {
                        // Cerca in tutte le categorie per trovare sottocategorie
                        categorieSnapshot.forEach(doc => {
                            const data = doc.data();
                            if (data.codice === codiceCategoria) {
                                categoriaId = doc.id;
                            }
                        });
                    }
                    
                    if (!categoriaId) {
                        console.warn(`Categoria ${codiceCategoria} non trovata per tipi predefiniti`);
                        continue;
                    }
                    
                    for (const tipoData of tipi) {
                        if (!nomiEsistenti.has(tipoData.nome.toLowerCase())) {
                            const tipoLavoroData = {
                                ...tipoData,
                                categoriaId: categoriaId,
                                predefinito: true,
                                creatoDa: 'system',
                                createdAt: serverTimestamp(),
                                updatedAt: serverTimestamp()
                            };
                            await addDoc(tipiRef, tipoLavoroData);
                            nomiEsistenti.add(tipoData.nome.toLowerCase());
                        }
                    }
                }
            } catch (error) {
                console.error('Errore inizializzazione tipi lavoro predefiniti:', error);
            }
        }

        // Carica categorie lavori principali e sottocategorie (da collezione unificata)
        async function loadCategorieLavori() {
            try {
                if (!currentTenantId) return;
                
                const categorieRef = collection(db, `tenants/${currentTenantId}/categorie`);
                
                // Carica tutte le categorie
                const snapshot = await getDocs(query(categorieRef, orderBy('ordine', 'asc')));
                categorieLavoriPrincipali = [];
                sottocategorieLavoriMap.clear();
                
                snapshot.forEach(doc => {
                    const catData = { id: doc.id, ...doc.data() };
                    
                    // Filtra solo categorie applicabili a lavori
                    if (catData.applicabileA === 'lavori' || catData.applicabileA === 'entrambi') {
                        if (!catData.parentId) {
                            // Categoria principale
                            categorieLavoriPrincipali.push(catData);
                        } else {
                            // Sottocategoria
                            if (!sottocategorieLavoriMap.has(catData.parentId)) {
                                sottocategorieLavoriMap.set(catData.parentId, []);
                            }
                            sottocategorieLavoriMap.get(catData.parentId).push(catData);
                        }
                    }
                });
                
                // Ordina sottocategorie per ordine
                sottocategorieLavoriMap.forEach((sottocat, parentId) => {
                    sottocat.sort((a, b) => (a.ordine || 0) - (b.ordine || 0));
                });
                
                populateCategoriaLavoroDropdown();
            } catch (error) {
                console.error('Errore caricamento categorie lavori:', error);
                categorieLavoriPrincipali = [];
            }
        }
        
        // Popola sottocategorie quando cambia categoria principale
        function populateSottocategorieLavoro(parentId, selectedValue = null) {
            const sottocategoriaSelect = document.getElementById('lavoro-sottocategoria');
            const sottocategoriaGroup = document.getElementById('lavoro-sottocategoria-group');
            
            if (!sottocategoriaSelect || !sottocategoriaGroup) return;
            
            sottocategoriaSelect.innerHTML = '<option value="">-- Nessuna sottocategoria --</option>';
            
            if (!parentId) {
                sottocategoriaGroup.style.display = 'none';
                return;
            }
            
            const sottocat = sottocategorieLavoriMap.get(parentId);
            if (sottocat && sottocat.length > 0) {
                sottocategoriaGroup.style.display = 'block';
                sottocat.forEach(subcat => {
                    const option = document.createElement('option');
                    option.value = subcat.id;
                    option.textContent = subcat.nome;
                    if (selectedValue === subcat.id) {
                        option.selected = true;
                    }
                    sottocategoriaSelect.appendChild(option);
                });
            } else {
                sottocategoriaGroup.style.display = 'none';
            }
        }

        // Carica tipi lavoro (filtrati per categoria se specificata)
        async function loadTipiLavoro(categoriaId = null) {
            try {
                if (!currentTenantId) return;
                
                const tipiRef = collection(db, `tenants/${currentTenantId}/tipiLavoro`);
                let q = query(tipiRef, orderBy('nome', 'asc'));
                
                // Carica sempre tutti i tipi lavoro (per avere la lista completa)
                const snapshot = await getDocs(query(tipiRef, orderBy('nome', 'asc')));
                tipiLavoroList = [];
                
                snapshot.forEach(doc => {
                    tipiLavoroList.push({ id: doc.id, ...doc.data() });
                });
                
                // Se √® specificata una categoria, filtra per quella categoria o le sue sottocategorie
                if (categoriaId) {
                    // Verifica se categoriaId √® una sottocategoria o categoria principale
                    let allCategorieIds = [categoriaId];
                    
                    // Verifica se √® una sottocategoria (ha parentId)
                    const categoriaTrovata = [...categorieLavoriPrincipali, ...Array.from(sottocategorieLavoriMap.values()).flat()].find(c => c.id === categoriaId);
                    
                    if (categoriaTrovata && !categoriaTrovata.parentId) {
                        // √à una categoria principale, aggiungi le sue sottocategorie
                        const sottocat = sottocategorieLavoriMap.get(categoriaId);
                        if (sottocat) {
                            sottocat.forEach(subcat => allCategorieIds.push(subcat.id));
                        }
                    }
                    
                    // Filtra i tipi per le categorie rilevanti
                    tipiLavoroList = tipiLavoroList.filter(tipo => allCategorieIds.includes(tipo.categoriaId));
                }
                
                populateTipoLavoroDropdown(categoriaId);
            } catch (error) {
                console.error('Errore caricamento tipi lavoro:', error);
                tipiLavoroList = [];
            }
        }

        // Popola dropdown categoria principale lavoro
        function populateCategoriaLavoroDropdown(selectedValue = null) {
            const select = document.getElementById('lavoro-categoria-principale');
            if (!select) return;
            
            select.innerHTML = '<option value="">-- Seleziona categoria principale --</option>';
            
            categorieLavoriPrincipali.forEach(categoria => {
                const option = document.createElement('option');
                option.value = categoria.id;
                option.textContent = categoria.nome;
                if (selectedValue === categoria.id) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }

        // Popola dropdown tipo lavoro nel form (filtrato per categoria)
        function populateTipoLavoroDropdown(categoriaId = null, selectedValue = null) {
            const select = document.getElementById('lavoro-tipo-lavoro');
            const tipoLavoroGroup = document.getElementById('tipo-lavoro-group');
            
            if (!select || !tipoLavoroGroup) return;
            
            select.innerHTML = '<option value="">-- Seleziona tipo lavoro --</option>';
            
            if (!categoriaId) {
                tipoLavoroGroup.style.display = 'none';
                return;
            }
            
            tipoLavoroGroup.style.display = 'block';
            
            // Filtra tipi lavoro per categoria (include anche sottocategorie se categoriaId √® principale)
            let tipiFiltrati = tipiLavoroList.filter(tipo => tipo.categoriaId === categoriaId);
            
            // Se non ci sono tipi per questa categoria specifica, verifica se √® una categoria principale
            // e cerca anche nelle sue sottocategorie
            if (tipiFiltrati.length === 0) {
                const sottocat = sottocategorieLavoriMap.get(categoriaId);
                if (sottocat && sottocat.length > 0) {
                    // Cerca tipi lavoro associati alle sottocategorie
                    const sottocatIds = sottocat.map(sc => sc.id);
                    tipiFiltrati = tipiLavoroList.filter(tipo => sottocatIds.includes(tipo.categoriaId));
                }
            }
            
            if (tipiFiltrati.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = '-- Nessun tipo disponibile --';
                option.disabled = true;
                select.appendChild(option);
                return;
            }
            
            tipiFiltrati.forEach(tipo => {
                const option = document.createElement('option');
                option.value = tipo.nome; // Usa nome per retrocompatibilit√† con lavori esistenti
                option.textContent = tipo.nome;
                if (selectedValue === tipo.nome) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }

        // Migra categorie lavori esistenti alla collezione unificata
        async function migraCategorieLavoriEsistenti() {
            try {
                if (!currentTenantId) return;
                
                // Verifica se esistono categorie nella vecchia collezione
                const vecchiaCollezioneRef = collection(db, `tenants/${currentTenantId}/categorieLavori`);
                const vecchiaSnapshot = await getDocs(vecchiaCollezioneRef);
                
                if (vecchiaSnapshot.empty) {
                    return; // Niente da migrare
                }
                
                // Verifica se la nuova collezione esiste gi√†
                const nuovaCollezioneRef = collection(db, `tenants/${currentTenantId}/categorie`);
                const nuovaSnapshot = await getDocs(nuovaCollezioneRef);
                
                // Controlla se ci sono gi√† categorie applicabili a lavori
                let haCategorieLavori = false;
                nuovaSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.applicabileA === 'lavori' || data.applicabileA === 'entrambi') {
                        haCategorieLavori = true;
                    }
                });
                
                if (haCategorieLavori) {
                    // Gi√† migrato o inizializzato
                    return;
                }
                
                console.log(`Migrazione di ${vecchiaSnapshot.size} categorie lavori...`);
                
                // Migra ogni categoria
                for (const docSnap of vecchiaSnapshot.docs) {
                    const vecchiaData = docSnap.data();
                    
                    const nuovaCategoriaData = {
                        nome: vecchiaData.nome,
                        codice: vecchiaData.codice || vecchiaData.nome.toLowerCase().replace(/[^a-z0-9]+/g, '_'),
                        descrizione: vecchiaData.descrizione || null,
                        parentId: null, // Tutte le vecchie categorie sono principali
                        applicabileA: 'lavori', // Le vecchie categorie erano solo per lavori
                        predefinita: vecchiaData.predefinita || false,
                        ordine: null,
                        creatoDa: vecchiaData.creatoDa || 'system',
                        createdAt: vecchiaData.createdAt || serverTimestamp(),
                        updatedAt: serverTimestamp()
                    };
                    
                    await addDoc(nuovaCollezioneRef, nuovaCategoriaData);
                }
                
                console.log('Migrazione categorie lavori completata');
            } catch (error) {
                console.error('Errore migrazione categorie lavori:', error);
                // Non bloccare il caricamento se la migrazione fallisce
            }
        }

        // Migra dati esistenti dalla lista piatta alla struttura gerarchica
        async function migraDatiEsistenti() {
            try {
                if (!currentTenantId) return;
                
                // Migra prima le categorie lavori esistenti
                await migraCategorieLavoriEsistenti();
                
                // Verifica se ci sono tipi lavoro nella lista piatta
                const listeRef = doc(db, `tenants/${currentTenantId}/liste`, 'personalizzate');
                const listeSnap = await getDoc(listeRef);
                
                if (!listeSnap.exists()) {
                    return; // Nessuna lista personalizzata, niente da migrare
                }
                
                const data = listeSnap.data();
                const tipiLavoroPiatti = data.tipiLavoro;
                
                if (!tipiLavoroPiatti || !Array.isArray(tipiLavoroPiatti) || tipiLavoroPiatti.length === 0) {
                    return; // Nessun tipo lavoro nella lista piatta
                }
                
                // Verifica se ci sono gi√† tipi lavoro nella struttura gerarchica
                const tipiRef = collection(db, `tenants/${currentTenantId}/tipiLavoro`);
                const tipiSnapshot = await getDocs(tipiRef);
                
                if (!tipiSnapshot.empty) {
                    // Gi√† migrato, niente da fare
                    return;
                }
                
                // Carica categorie per mappatura (da collezione unificata)
                const categorieRef = collection(db, `tenants/${currentTenantId}/categorie`);
                const categorieSnapshot = await getDocs(categorieRef);
                const categorieMap = new Map(); // codice -> id
                
                categorieSnapshot.forEach(doc => {
                    const catData = doc.data();
                    if (catData.codice) {
                        categorieMap.set(catData.codice, doc.id);
                    }
                });
                
                // Mappatura tipi predefiniti alle categorie
                const mappaturaPredefiniti = {
                    'Potatura': 'potatura',
                    'Raccolta': 'raccolta',
                    'Raccolta frutta': 'raccolta',
                    'Raccolta verdura': 'raccolta',
                    'Trattamento': 'trattamenti',
                    'Semina': 'semina_piantagione',
                    'Aratura': 'lavorazione_terreno',
                    'Irrigazione': 'trattamenti',
                    'Concimazione': 'trattamenti',
                    'Diserbo': 'gestione_verde'
                };
                
                const nomiEsistenti = new Set();
                tipiSnapshot.forEach(doc => {
                    const tipoData = doc.data();
                    if (tipoData.nome) {
                        nomiEsistenti.add(tipoData.nome.toLowerCase());
                    }
                });
                
                let tipiCreati = 0;
                
                // Migra ogni tipo dalla lista piatta
                for (const nomeTipo of tipiLavoroPiatti) {
                    // Salta se gi√† esiste
                    if (nomiEsistenti.has(nomeTipo.toLowerCase())) {
                        continue;
                    }
                    
                    // Determina categoria (usa mappatura o categoria "Altro")
                    const codiceCategoria = mappaturaPredefiniti[nomeTipo] || 'altro';
                    const categoriaId = categorieMap.get(codiceCategoria);
                    
                    if (!categoriaId) {
                        console.warn(`Categoria ${codiceCategoria} non trovata per tipo ${nomeTipo}`);
                        continue;
                    }
                    
                    // Crea tipo lavoro
                    const tipoLavoroData = {
                        nome: nomeTipo,
                        categoriaId: categoriaId,
                        descrizione: 'Migrato da lista piatta',
                        predefinito: false,
                        creatoDa: currentUserData.id,
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp()
                    };
                    
                    await addDoc(tipiRef, tipoLavoroData);
                    nomiEsistenti.add(nomeTipo.toLowerCase());
                    tipiCreati++;
                }
                
                if (tipiCreati > 0) {
                    console.log(`Migrazione completata: ${tipiCreati} tipi lavoro migrati`);
                }
            } catch (error) {
                console.error('Errore migrazione dati esistenti:', error);
                // Non bloccare il caricamento della pagina se la migrazione fallisce
            }
        }

        // Setup handler per cambio categoria lavoro
        function setupCategoriaLavoroHandler() {
            const categoriaPrincipaleSelect = document.getElementById('lavoro-categoria-principale');
            const sottocategoriaSelect = document.getElementById('lavoro-sottocategoria');
            
            if (categoriaPrincipaleSelect) {
                categoriaPrincipaleSelect.addEventListener('change', function() {
                    const categoriaPrincipaleId = this.value;
                    if (categoriaPrincipaleId) {
                        populateSottocategorieLavoro(categoriaPrincipaleId);
                        // Carica tipi lavoro per la categoria principale (include sottocategorie)
                        loadTipiLavoro(categoriaPrincipaleId);
                    } else {
                        document.getElementById('lavoro-sottocategoria-group').style.display = 'none';
                        document.getElementById('tipo-lavoro-group').style.display = 'none';
                        document.getElementById('lavoro-tipo-lavoro').value = '';
                    }
                });
            }
            
            if (sottocategoriaSelect) {
                sottocategoriaSelect.addEventListener('change', function() {
                    const sottocategoriaId = this.value;
                    const categoriaPrincipaleId = document.getElementById('lavoro-categoria-principale').value;
                    
                    // Usa sottocategoria se selezionata, altrimenti categoria principale
                    const categoriaId = sottocategoriaId || categoriaPrincipaleId;
                    if (categoriaId) {
                        loadTipiLavoro(categoriaId);
                    }
                });
            }
        }

        // Carica lista lavori
        async function loadLavori() {
            const container = document.getElementById('lavori-container');
            container.innerHTML = '<div class="loading">Caricamento lavori...</div>';

            try {
                const lavoriRef = collection(db, 'tenants', currentTenantId, 'lavori');
                const q = query(lavoriRef, orderBy('dataInizio', 'desc'));
                const snapshot = await getDocs(q);
                
                lavoriList = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    lavoriList.push({ 
                        id: doc.id, 
                        ...data,
                        dataInizio: data.dataInizio?.toDate ? data.dataInizio.toDate() : (data.dataInizio ? new Date(data.dataInizio) : null)
                    });
                });

                // Corregge macchine ancora in uso per lavori completati
                console.log('üîç Verifica modulo Parco Macchine:', hasParcoMacchineModule);
                if (hasParcoMacchineModule) {
                    await correggiMacchineLavoriCompletati();
                } else {
                    console.log('‚ö†Ô∏è Modulo Parco Macchine non attivo, skip correzione macchine');
                }

                applyFilters();
            } catch (error) {
                console.error('Errore caricamento lavori:', error);
                container.innerHTML = '<div class="empty-state">Errore caricamento lavori</div>';
                showAlert('Errore caricamento lavori', 'error');
            }
        }

        // Corregge macchine ancora in uso per lavori completati
        // IMPORTANTE: Libera solo se la macchina NON √® assegnata ad altri lavori attivi
        async function correggiMacchineLavoriCompletati() {
            try {
                console.log('üîß Inizio correzione macchine per lavori completati...');
                console.log('üìä Totale lavori caricati:', lavoriList.length);
                
                // Log di tutti gli stati dei lavori
                const statiLavori = {};
                lavoriList.forEach(l => {
                    const stato = l.stato || 'senza_stato';
                    statiLavori[stato] = (statiLavori[stato] || 0) + 1;
                });
                console.log('üìà Distribuzione stati lavori:', statiLavori);
                
                const lavoriCompletati = lavoriList.filter(l => 
                    (l.stato === 'completato' || l.stato === 'completato_da_approvare') && 
                    (l.macchinaId || l.attrezzoId)
                );

                console.log('‚úÖ Lavori completati trovati:', lavoriCompletati.length);
                
                if (lavoriCompletati.length === 0) {
                    console.log('‚ÑπÔ∏è Nessun lavoro completato con macchine associate');
                    return;
                }

                // Trova lavori attivi (non completati/annullati)
                const lavoriAttivi = lavoriList.filter(l => 
                    l.stato !== 'completato' && 
                    l.stato !== 'completato_da_approvare' && 
                    l.stato !== 'annullato' &&
                    (l.macchinaId || l.attrezzoId)
                );
                console.log('üîÑ Lavori attivi con macchine:', lavoriAttivi.length);

                // Crea mappa delle macchine/attrezzi in uso per lavori attivi
                const macchineInUsoAttive = new Set();
                const attrezziInUsoAttivi = new Set();
                lavoriAttivi.forEach(l => {
                    if (l.macchinaId) macchineInUsoAttive.add(l.macchinaId);
                    if (l.attrezzoId) attrezziInUsoAttivi.add(l.attrezzoId);
                });
                console.log('üìã Macchine in uso per lavori attivi:', Array.from(macchineInUsoAttive));
                console.log('üìã Attrezzi in uso per lavori attivi:', Array.from(attrezziInUsoAttivi));

                let macchineCorrette = 0;
                for (const lavoro of lavoriCompletati) {
                    console.log(`üîç Analizzando lavoro "${lavoro.nome}" (ID: ${lavoro.id})`);
                    
                    if (lavoro.macchinaId) {
                        console.log(`  üöú Verifica trattore ID: ${lavoro.macchinaId}`);
                        
                        // Verifica se la macchina √® ancora in uso per altri lavori attivi
                        if (macchineInUsoAttive.has(lavoro.macchinaId)) {
                            console.log(`  ‚ö†Ô∏è Trattore ancora in uso per altri lavori attivi, NON libero`);
                            continue;
                        }
                        
                        try {
                            const macchinaDoc = await getDoc(doc(db, 'tenants', currentTenantId, 'macchine', lavoro.macchinaId));
                            if (macchinaDoc.exists()) {
                                const macchinaData = macchinaDoc.data();
                                console.log(`  üìä Stato attuale trattore: ${macchinaData.stato}`);
                                if (macchinaData.stato === 'in_uso') {
                                    console.log(`  ‚úÖ Libero trattore "${macchinaData.nome || lavoro.macchinaId}"`);
                                    await updateMacchinaStato(lavoro.macchinaId, 'disponibile');
                                    macchineCorrette++;
                                    console.log(`  ‚úÖ Trattore liberato con successo`);
                                } else {
                                    console.log(`  ‚ÑπÔ∏è Trattore gi√† in stato: ${macchinaData.stato}`);
                                }
                            } else {
                                console.log(`  ‚ö†Ô∏è Trattore non trovato nel database`);
                            }
                        } catch (error) {
                            console.error(`  ‚ùå Errore verifica trattore:`, error);
                        }
                    }
                    
                    if (lavoro.attrezzoId) {
                        console.log(`  ‚öôÔ∏è Verifica attrezzo ID: ${lavoro.attrezzoId}`);
                        
                        // Verifica se l'attrezzo √® ancora in uso per altri lavori attivi
                        if (attrezziInUsoAttivi.has(lavoro.attrezzoId)) {
                            console.log(`  ‚ö†Ô∏è Attrezzo ancora in uso per altri lavori attivi, NON libero`);
                            continue;
                        }
                        
                        try {
                            const attrezzoDoc = await getDoc(doc(db, 'tenants', currentTenantId, 'macchine', lavoro.attrezzoId));
                            if (attrezzoDoc.exists()) {
                                const attrezzoData = attrezzoDoc.data();
                                console.log(`  üìä Stato attuale attrezzo: ${attrezzoData.stato}`);
                                if (attrezzoData.stato === 'in_uso') {
                                    console.log(`  ‚úÖ Libero attrezzo "${attrezzoData.nome || lavoro.attrezzoId}"`);
                                    await updateMacchinaStato(lavoro.attrezzoId, 'disponibile');
                                    macchineCorrette++;
                                    console.log(`  ‚úÖ Attrezzo liberato con successo`);
                                } else {
                                    console.log(`  ‚ÑπÔ∏è Attrezzo gi√† in stato: ${attrezzoData.stato}`);
                                }
                            } else {
                                console.log(`  ‚ö†Ô∏è Attrezzo non trovato nel database`);
                            }
                        } catch (error) {
                            console.error(`  ‚ùå Errore verifica attrezzo:`, error);
                        }
                    }
                }

                console.log(`üìä Riepilogo: ${macchineCorrette} macchine corrette su ${lavoriCompletati.length} lavori completati`);
                
                if (macchineCorrette > 0) {
                    console.log(`‚úÖ Corrette ${macchineCorrette} macchine per lavori completati`);
                    // Ricarica trattori e attrezzi per aggiornare dropdown
                    await loadTrattori();
                    await loadAttrezzi();
                } else {
                    console.log('‚ÑπÔ∏è Nessuna macchina da correggere (tutte gi√† disponibili o ancora in uso per altri lavori)');
                }
            } catch (error) {
                console.error('‚ùå Errore correzione macchine lavori completati:', error);
                console.error('Stack trace:', error.stack);
                // Non blocchiamo il caricamento se c'√® un errore
            }
        }

        // Popola dropdown filtri terreni
        function populateTerrenoFilter() {
            const select = document.getElementById('filter-terreno');
            select.innerHTML = '<option value="">Tutti i terreni</option>';
            terreniList.forEach(terreno => {
                const option = document.createElement('option');
                option.value = terreno.id;
                option.textContent = terreno.nome || 'N/A';
                select.appendChild(option);
            });
        }

        // Popola dropdown filtri caposquadra
        function populateCaposquadraFilter() {
            const select = document.getElementById('filter-caposquadra');
            select.innerHTML = '<option value="">Tutti i caposquadra</option>';
            caposquadraList.forEach(capo => {
                const option = document.createElement('option');
                option.value = capo.id;
                const nomeCompleto = `${capo.nome || ''} ${capo.cognome || ''}`.trim() || capo.email || 'N/A';
                option.textContent = nomeCompleto;
                select.appendChild(option);
            });
        }

        // Popola dropdown terreni nel form
        function populateTerrenoDropdown(selectedId = null) {
            const select = document.getElementById('lavoro-terreno');
            select.innerHTML = '<option value="">Seleziona terreno...</option>';
            
            if (terreniList.length === 0) {
                select.innerHTML = '<option value="">Nessun terreno disponibile</option>';
                select.disabled = true;
                return;
            }
            
            select.disabled = false;
            terreniList.forEach(terreno => {
                const option = document.createElement('option');
                option.value = terreno.id;
                option.textContent = `${terreno.nome || 'N/A'}${terreno.superficie ? ` (${terreno.superficie} ha)` : ''}`;
                if (selectedId === terreno.id) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }

        // Popola dropdown caposquadra nel form
        function populateCaposquadraDropdown(selectedId = null) {
            const select = document.getElementById('lavoro-caposquadra');
            if (!select) return;
            
            const squadraInfo = document.getElementById('squadra-info');
            select.innerHTML = '<option value="">Seleziona caposquadra...</option>';
            
            if (caposquadraList.length === 0) {
                select.innerHTML = '<option value="">Nessun caposquadra disponibile</option>';
                select.disabled = true;
                if (squadraInfo) {
                    squadraInfo.textContent = 'Crea prima una squadra con un caposquadra.';
                }
                return;
            }
            
            select.disabled = false;
            if (squadraInfo) {
                squadraInfo.textContent = '';
            }
            
            // Listener per mostrare info squadra quando si seleziona caposquadra
            select.onchange = function() {
                if (this.value && squadraInfo) {
                    const squadra = squadreList.find(s => s.caposquadraId === this.value);
                    if (squadra) {
                        const operaiCount = squadra.operai ? squadra.operai.length : 0;
                        squadraInfo.textContent = `Squadra: ${squadra.nome} (${operaiCount} operai)`;
                        squadraInfo.style.color = '#2E8B57';
                    } else {
                        squadraInfo.textContent = '‚ö†Ô∏è Nessuna squadra assegnata a questo caposquadra';
                        squadraInfo.style.color = '#856404';
                    }
                } else if (squadraInfo) {
                    squadraInfo.textContent = '';
                }
            };
            
            caposquadraList.forEach(capo => {
                const nomeCompleto = `${capo.nome || ''} ${capo.cognome || ''}`.trim() || capo.email || 'N/A';
                const option = document.createElement('option');
                option.value = capo.id;
                option.textContent = nomeCompleto;
                if (selectedId === capo.id) {
                    option.selected = true;
                    select.onchange(); // Trigger per mostrare info squadra
                }
                select.appendChild(option);
            });
        }

        // Popola dropdown operai nel form
        function populateOperaiDropdown(selectedId = null) {
            const select = document.getElementById('lavoro-operaio');
            if (!select) return;
            
            select.innerHTML = '<option value="">Seleziona operaio...</option>';
            
            if (operaiList.length === 0) {
                select.innerHTML = '<option value="">Nessun operaio disponibile</option>';
                select.disabled = true;
                return;
            }
            
            select.disabled = false;
            
            // Ordina operai per nome
            const operaiOrdinati = [...operaiList].sort((a, b) => {
                const nomeA = `${a.nome || ''} ${a.cognome || ''}`.trim() || a.email || '';
                const nomeB = `${b.nome || ''} ${b.cognome || ''}`.trim() || b.email || '';
                return nomeA.localeCompare(nomeB);
            });
            
            operaiOrdinati.forEach(operaio => {
                const nomeCompleto = `${operaio.nome || ''} ${operaio.cognome || ''}`.trim() || operaio.email || 'N/A';
                const tipoOperaio = operaio.tipoOperaio ? ` (${operaio.tipoOperaio})` : '';
                const option = document.createElement('option');
                option.value = operaio.id;
                option.textContent = `${nomeCompleto}${tipoOperaio}`;
                if (selectedId === operaio.id) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }

        // Gestisce cambio tipo assegnazione (radio button)
        function setupTipoAssegnazioneHandlers() {
            const tipoSquadra = document.getElementById('tipo-squadra');
            const tipoAutonomo = document.getElementById('tipo-autonomo');
            const caposquadraGroup = document.getElementById('caposquadra-group');
            const operaioGroup = document.getElementById('operaio-group');
            const caposquadraSelect = document.getElementById('lavoro-caposquadra');
            const operaioSelect = document.getElementById('lavoro-operaio');

            if (!tipoSquadra || !tipoAutonomo || !caposquadraGroup || !operaioGroup) return;

            function updateVisibility() {
                if (tipoSquadra.checked) {
                    caposquadraGroup.style.display = 'block';
                    operaioGroup.style.display = 'none';
                    if (caposquadraSelect) {
                        caposquadraSelect.required = true;
                    }
                    if (operaioSelect) {
                        operaioSelect.required = false;
                        operaioSelect.value = '';
                    }
                } else if (tipoAutonomo.checked) {
                    caposquadraGroup.style.display = 'none';
                    operaioGroup.style.display = 'block';
                    if (caposquadraSelect) {
                        caposquadraSelect.required = false;
                        caposquadraSelect.value = '';
                    }
                    if (operaioSelect) {
                        operaioSelect.required = true;
                    }
                }
            }

            tipoSquadra.addEventListener('change', updateVisibility);
            tipoAutonomo.addEventListener('change', updateVisibility);
            
            // Inizializza visibilit√†
            updateVisibility();
        }

        // Applica filtri
        window.applyFilters = function() {
            const statoFilter = document.getElementById('filter-stato').value;
            const caposquadraFilter = document.getElementById('filter-caposquadra').value;
            const terrenoFilter = document.getElementById('filter-terreno').value;

            filteredLavoriList = lavoriList.filter(lavoro => {
                if (statoFilter && lavoro.stato !== statoFilter) return false;
                if (caposquadraFilter && lavoro.caposquadraId !== caposquadraFilter) return false;
                if (terrenoFilter && lavoro.terrenoId !== terrenoFilter) return false;
                return true;
            });

            // Il filtro stato progresso viene applicato in renderLavori dopo il calcolo
            renderLavori();
        };

        // Pulisci filtri
        window.clearFilters = function() {
            document.getElementById('filter-stato').value = '';
            document.getElementById('filter-progresso').value = '';
            document.getElementById('filter-caposquadra').value = '';
            document.getElementById('filter-terreno').value = '';
            applyFilters();
        };

        // Renderizza lista lavori
        async function renderLavori() {
            const container = document.getElementById('lavori-container');
            const countEl = document.getElementById('lavori-count');

            if (filteredLavoriList.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <p>Nessun lavoro trovato</p>
                        <p style="font-size: 14px; margin-top: 10px;">Clicca su "Crea Nuovo Lavoro" per iniziare</p>
                    </div>
                `;
                countEl.textContent = '0 lavori';
                return;
            }

            // Carica dati terreno e caposquadra per ogni lavoro
            const lavoriConDettagli = await Promise.all(
                filteredLavoriList.map(async (lavoro) => {
                    const terreno = terreniList.find(t => t.id === lavoro.terrenoId);
                    const caposquadra = caposquadraList.find(c => c.id === lavoro.caposquadraId);
                    const squadra = squadreList.find(s => s.caposquadraId === lavoro.caposquadraId);
                    
                    return { 
                        ...lavoro, 
                        terreno, 
                        caposquadra,
                        squadra
                    };
                })
            );

            // Carica progressi per ogni lavoro
            const lavoriConProgressi = await Promise.all(
                lavoriConDettagli.map(async (lavoro) => {
                    const progressi = await loadProgressiLavoro(lavoro.id);
                    const lavoroConProgressi = { ...lavoro, ...progressi };
                    
                    // Calcola stato progresso se non presente o se necessario ricalcolarlo
                    if (lavoroConProgressi.dataInizio && lavoroConProgressi.durataPrevista) {
                        const dataInizio = lavoroConProgressi.dataInizio instanceof Date 
                            ? lavoroConProgressi.dataInizio 
                            : (lavoroConProgressi.dataInizio?.toDate ? lavoroConProgressi.dataInizio.toDate() : new Date(lavoroConProgressi.dataInizio));
                        const oggi = new Date();
                        oggi.setHours(0, 0, 0, 0);
                        dataInizio.setHours(0, 0, 0, 0);
                        
                        const giorniEffettivi = Math.max(0, Math.floor((oggi - dataInizio) / (1000 * 60 * 60 * 24)) + 1);
                        const giorniRimanenti = Math.max(0, lavoroConProgressi.durataPrevista - giorniEffettivi);
                        
                        // Calcola stato progresso se non presente
                        if (!lavoroConProgressi.statoProgresso && giorniEffettivi > 0) {
                            const superficieTotale = lavoroConProgressi.terreno?.superficie || 0;
                            // Usa superficieTotaleLavorata dal documento lavoro o superficieLavorata calcolata da loadProgressiLavoro
                            const superficieLavorata = lavoroConProgressi.superficieTotaleLavorata || lavoroConProgressi.superficieLavorata || 0;
                            const percentualeCompletamento = superficieTotale > 0 ? (superficieLavorata / superficieTotale * 100) : 0;
                            const percentualeTempo = (giorniEffettivi / lavoroConProgressi.durataPrevista) * 100;
                            const tolleranza = 10; // Tolleranza del 10%
                            
                            if (percentualeCompletamento > percentualeTempo + tolleranza) {
                                lavoroConProgressi.statoProgresso = 'in_anticipo';
                            } else if (percentualeCompletamento < percentualeTempo - tolleranza) {
                                lavoroConProgressi.statoProgresso = 'in_ritardo';
                            } else {
                                lavoroConProgressi.statoProgresso = 'in_tempo';
                            }
                        }
                        
                        lavoroConProgressi.giorniEffettivi = giorniEffettivi;
                        lavoroConProgressi.giorniRimanenti = giorniRimanenti;
                    }
                    
                    return lavoroConProgressi;
                })
            );

            // Applica filtro stato progresso se presente (dopo il calcolo)
            const progressoFilter = document.getElementById('filter-progresso')?.value || '';
            let lavoriFiltratiPerProgresso = lavoriConProgressi;
            if (progressoFilter) {
                lavoriFiltratiPerProgresso = lavoriConProgressi.filter(l => l.statoProgresso === progressoFilter);
            }
            
            // Separa lavori in attesa di approvazione dagli altri
            const lavoriInAttesa = lavoriFiltratiPerProgresso.filter(l => l.stato === 'completato_da_approvare');
            const altriLavori = lavoriFiltratiPerProgresso.filter(l => l.stato !== 'completato_da_approvare');

            let html = '';

            // Sezione lavori in attesa di approvazione
            if (lavoriInAttesa.length > 0) {
                html += `
                    <div style="background: #fff3cd; padding: 20px; border-radius: 12px; margin-bottom: 30px; border-left: 5px solid #ffc107;">
                        <h2 style="color: #856404; margin-bottom: 15px; font-size: 20px;">
                            ‚è≥ Lavori in attesa di approvazione (${lavoriInAttesa.length})
                        </h2>
                        <table class="lavori-table">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Terreno</th>
                                    <th>Caposquadra</th>
                                    <th>Progressi Tracciati</th>
                                    <th>Azioni</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                lavoriInAttesa.forEach(lavoro => {
                    const terrenoNome = lavoro.terreno ? lavoro.terreno.nome || 'N/A' : 'N/A';
                    const caposquadraNome = lavoro.caposquadra 
                        ? `${lavoro.caposquadra.nome || ''} ${lavoro.caposquadra.cognome || ''}`.trim() || 'N/A'
                        : 'N/A';
                    
                    const superficieTotale = lavoro.terreno?.superficie || 0;
                    // Usa superficieTotaleLavorata dal documento lavoro
                    const superficieLavorata = lavoro.superficieTotaleLavorata || 0;
                    const percentualeTracciata = lavoro.percentualeCompletamentoTracciata || 
                        (superficieTotale > 0 ? Math.round((superficieLavorata / superficieTotale) * 100) : 0);
                    
                    html += `
                        <tr style="background: #fffbf0;">
                            <td><strong>${escapeHtml(lavoro.nome || 'N/A')}</strong></td>
                            <td>${escapeHtml(terrenoNome)}</td>
                            <td>${escapeHtml(caposquadraNome)}</td>
                            <td>
                                <div class="progress-bar-inline">
                                    <div class="progress-fill-inline" style="width: ${Math.min(percentualeTracciata, 100)}%; background: #ffc107;">
                                        ${percentualeTracciata}%
                                    </div>
                                </div>
                                <div class="progress-text">Superficie tracciata: ${percentualeTracciata}%</div>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-primary btn-sm" onclick="approvaLavoro('${lavoro.id}')">
                                        ‚úÖ Approva
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="rifiutaLavoro('${lavoro.id}')">
                                        ‚ùå Rifiuta
                                    </button>
                                    <button class="btn btn-info btn-sm" onclick="openDettaglioModal('${lavoro.id}')">
                                        üëÅÔ∏è Dettagli
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });

                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            }

            // Tabella lavori normali
            html += `
                <table class="lavori-table">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Terreno</th>
                            <th>Caposquadra</th>
                            <th>Data Inizio</th>
                            <th>Durata</th>
                            <th>Progressi</th>
                            <th>Stato Progresso</th>
                            <th>Stato</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            altriLavori.forEach(lavoro => {
                const terrenoNome = lavoro.terreno ? lavoro.terreno.nome || 'N/A' : 'N/A';
                const caposquadraNome = lavoro.caposquadra 
                    ? `${lavoro.caposquadra.nome || ''} ${lavoro.caposquadra.cognome || ''}`.trim() || 'N/A'
                    : 'N/A';
                const dataInizioFormatted = lavoro.dataInizio 
                    ? new Date(lavoro.dataInizio).toLocaleDateString('it-IT')
                    : 'N/A';
                const durata = lavoro.durataPrevista ? `${lavoro.durataPrevista} giorni` : 'N/A';
                const statoBadge = `<span class="badge badge-${lavoro.stato || 'assegnato'}">${getStatoFormattato(lavoro.stato)}</span>`;
                
                // Calcola progressi
                const superficieTotale = lavoro.terreno?.superficie || 0;
                // Usa superficieTotaleLavorata dal documento lavoro
                const superficieLavorata = lavoro.superficieTotaleLavorata || 0;
                const percentuale = superficieTotale > 0 ? Math.round((superficieLavorata / superficieTotale) * 100) : 0;
                const progressBar = superficieTotale > 0 ? `
                    <div class="progress-bar-inline">
                        <div class="progress-fill-inline" style="width: ${Math.min(percentuale, 100)}%">${percentuale}%</div>
                    </div>
                    <div class="progress-text">${superficieLavorata.toFixed(2)} / ${superficieTotale.toFixed(2)} ha</div>
                ` : '<div class="progress-text" style="color: #999;">Nessun progresso</div>';

                // Badge stato progresso
                let statoProgressoBadge = '';
                if (lavoro.statoProgresso && lavoro.durataPrevista && lavoro.dataInizio) {
                    statoProgressoBadge = `
                        <span class="badge badge-progresso-${lavoro.statoProgresso}" style="display: inline-block; margin-bottom: 5px;">
                            ${getStatoProgressoFormattato(lavoro.statoProgresso)}
                        </span>
                        <div style="font-size: 11px; color: #666; margin-top: 3px;">
                            ${lavoro.giorniEffettivi || 0}/${lavoro.durataPrevista} giorni
                            ${lavoro.giorniRimanenti !== null && lavoro.giorniRimanenti >= 0 ? `(${lavoro.giorniRimanenti} rim.)` : ''}
                        </div>
                    `;
                } else {
                    statoProgressoBadge = '<span style="color: #999; font-size: 12px;">N/A</span>';
                }

                // Info macchine (solo se modulo Parco Macchine attivo)
                let macchineInfo = '';
                if (hasParcoMacchineModule && (lavoro.macchinaId || lavoro.attrezzoId)) {
                    const macchineParts = [];
                    if (lavoro.macchinaId) {
                        const trattore = trattoriList.find(t => t.id === lavoro.macchinaId);
                        if (trattore) {
                            macchineParts.push(`üöú ${trattore.nome || 'Trattore'}`);
                        }
                    }
                    if (lavoro.attrezzoId) {
                        const attrezzo = attrezziList.find(a => a.id === lavoro.attrezzoId);
                        if (attrezzo) {
                            macchineParts.push(`‚öôÔ∏è ${attrezzo.nome || 'Attrezzo'}`);
                        }
                    }
                    if (macchineParts.length > 0) {
                        macchineInfo = `<div style="font-size: 11px; color: #666; margin-top: 3px;">${macchineParts.join(' + ')}</div>`;
                    }
                }

                html += `
                    <tr>
                        <td><strong>${escapeHtml(lavoro.nome || 'N/A')}</strong>${macchineInfo}</td>
                        <td>${escapeHtml(terrenoNome)}</td>
                        <td>${escapeHtml(caposquadraNome)}</td>
                        <td>${dataInizioFormatted}</td>
                        <td>${durata}</td>
                        <td class="progress-cell">${progressBar}</td>
                        <td style="min-width: 120px;">${statoProgressoBadge}</td>
                        <td>${statoBadge}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-info btn-sm" onclick="openDettaglioModal('${lavoro.id}')">üëÅÔ∏è Dettagli</button>
                                <button class="btn btn-info btn-sm" onclick="openModificaModal('${lavoro.id}')">‚úèÔ∏è Modifica</button>
                                <button class="btn btn-danger btn-sm" onclick="openEliminaModal('${lavoro.id}')">üóëÔ∏è Elimina</button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            container.innerHTML = html;
            countEl.textContent = `${filteredLavoriList.length} lavoro${filteredLavoriList.length !== 1 ? 'i' : ''}`;
        }

        // Ottieni stato formattato
        function getStatoFormattato(stato) {
            const stati = {
                'assegnato': 'üìã Assegnato',
                'in_corso': 'üîÑ In corso',
                'completato': '‚úÖ Completato',
                'completato_da_approvare': '‚è≥ In attesa approvazione',
                'annullato': '‚ùå Annullato'
            };
            return stati[stato] || stato;
        }

        // Ottieni stato progresso formattato
        function getStatoProgressoFormattato(statoProgresso) {
            const stati = {
                'in_ritardo': 'üî¥ In ritardo',
                'in_tempo': 'üü¢ In tempo',
                'in_anticipo': 'üöÄ In anticipo'
            };
            return stati[statoProgresso] || statoProgresso || '';
        }

        // Apri modal crea lavoro
        window.openCreaModal = function() {
            currentLavoroId = null;
            document.getElementById('modal-title').textContent = 'Crea Nuovo Lavoro';
            document.getElementById('lavoro-form').reset();
            document.getElementById('lavoro-id').value = '';
            document.getElementById('lavoro-stato').value = 'assegnato';
            
            // Imposta tipo assegnazione default a "squadra"
            document.getElementById('tipo-squadra').checked = true;
            document.getElementById('tipo-autonomo').checked = false;
            
            // Imposta data minima a oggi
            const today = new Date().toISOString().split('T')[0];
            // Permetti date passate (il manager pu√≤ assegnare lavori anche per giorni precedenti)
            // document.getElementById('lavoro-data-inizio').setAttribute('min', today);
            
            populateTerrenoDropdown();
            populateCaposquadraDropdown();
            populateOperaiDropdown();
            populateCategoriaLavoroDropdown();
            document.getElementById('lavoro-sottocategoria-group').style.display = 'none';
            document.getElementById('tipo-lavoro-group').style.display = 'none';
            document.getElementById('lavoro-tipo-lavoro').value = '';
            
            // Reset e popola campi macchine se modulo Parco Macchine attivo
            if (hasParcoMacchineModule) {
                populateTrattoriDropdown(); // Popola dropdown trattori
                document.getElementById('lavoro-trattore').value = '';
                document.getElementById('lavoro-attrezzo').value = '';
                document.getElementById('lavoro-operatore-macchina').value = '';
                document.getElementById('attrezzo-group').style.display = 'none';
                document.getElementById('operatore-macchina-group').style.display = 'none';
            }
            
            // Aggiorna visibilit√† dropdown
            setupTipoAssegnazioneHandlers();
            
            document.getElementById('lavoro-modal').classList.add('active');
        };

        // Apri modal modifica lavoro
        window.openModificaModal = async function(lavoroId) {
            currentLavoroId = lavoroId;
            const lavoro = lavoriList.find(l => l.id === lavoroId);
            
            if (!lavoro) {
                showAlert('Lavoro non trovato', 'error');
                return;
            }

            document.getElementById('modal-title').textContent = 'Modifica Lavoro';
            document.getElementById('lavoro-id').value = lavoroId;
            document.getElementById('lavoro-nome').value = lavoro.nome || '';
            document.getElementById('lavoro-note').value = lavoro.note || '';
            document.getElementById('lavoro-stato').value = lavoro.stato || 'assegnato';
            document.getElementById('lavoro-durata').value = lavoro.durataPrevista || '';
            
            // Formatta data per input date
            if (lavoro.dataInizio) {
                const dataInizio = lavoro.dataInizio instanceof Date 
                    ? lavoro.dataInizio 
                    : new Date(lavoro.dataInizio);
                document.getElementById('lavoro-data-inizio').value = dataInizio.toISOString().split('T')[0];
            }
            
            // Determina tipo assegnazione in base ai dati del lavoro
            if (lavoro.operaioId && !lavoro.caposquadraId) {
                // Lavoro autonomo
                document.getElementById('tipo-autonomo').checked = true;
                document.getElementById('tipo-squadra').checked = false;
            } else {
                // Lavoro di squadra (default o se caposquadraId presente)
                document.getElementById('tipo-squadra').checked = true;
                document.getElementById('tipo-autonomo').checked = false;
            }
            
            populateTerrenoDropdown(lavoro.terrenoId);
            populateCaposquadraDropdown(lavoro.caposquadraId || null);
            populateOperaiDropdown(lavoro.operaioId || null);
            
            // Popola categoria e tipo lavoro (se struttura gerarchica disponibile)
            if (lavoro.tipoLavoro) {
                // Cerca il tipo lavoro per nome per ottenere categoriaId
                const tipoLavoroObj = tipiLavoroList.find(t => t.nome === lavoro.tipoLavoro);
                if (tipoLavoroObj && tipoLavoroObj.categoriaId) {
                    populateCategoriaLavoroDropdown(tipoLavoroObj.categoriaId);
                    // Carica tipi lavoro per quella categoria e poi seleziona
                    loadTipiLavoro(tipoLavoroObj.categoriaId).then(() => {
                        populateTipoLavoroDropdown(tipoLavoroObj.categoriaId, lavoro.tipoLavoro);
                    });
                } else {
                    // Fallback: usa lista piatta se tipo non trovato nella struttura gerarchica
                    populateCategoriaLavoroDropdown();
                    populateTipoLavoroDropdown(null, lavoro.tipoLavoro);
                }
            } else {
                populateCategoriaLavoroDropdown();
                populateTipoLavoroDropdown();
            }
            
            // Popola campi macchine se modulo Parco Macchine attivo
            if (hasParcoMacchineModule) {
                populateTrattoriDropdown(); // Popola dropdown trattori
                const macchinaId = lavoro.macchinaId || null;
                const attrezzoId = lavoro.attrezzoId || null;
                const operatoreMacchinaId = lavoro.operatoreMacchinaId || null;
                
                if (macchinaId) {
                    document.getElementById('lavoro-trattore').value = macchinaId;
                    populateAttrezziDropdown(macchinaId);
                }
                
                if (attrezzoId) {
                    document.getElementById('lavoro-attrezzo').value = attrezzoId;
                }
                
                if (operatoreMacchinaId) {
                    document.getElementById('lavoro-operatore-macchina').value = operatoreMacchinaId;
                }
                
                populateOperatoreMacchinaDropdown();
            }
            
            // Aggiorna visibilit√† dropdown
            setupTipoAssegnazioneHandlers();
            
            document.getElementById('lavoro-modal').classList.add('active');
        };

        // Chiudi modal
        window.closeLavoroModal = function() {
            document.getElementById('lavoro-modal').classList.remove('active');
            currentLavoroId = null;
        };

        // Gestisci salvataggio lavoro
        window.handleSalvaLavoro = async function(event) {
            event.preventDefault();
            
            const nome = document.getElementById('lavoro-nome').value.trim();
            const terrenoId = document.getElementById('lavoro-terreno').value;
            const categoriaPrincipaleId = document.getElementById('lavoro-categoria-principale').value;
            const sottocategoriaId = document.getElementById('lavoro-sottocategoria').value;
            const tipoLavoro = document.getElementById('lavoro-tipo-lavoro').value.trim();
            const dataInizio = document.getElementById('lavoro-data-inizio').value;
            
            // Usa sottocategoria se selezionata, altrimenti categoria principale
            const categoriaLavoroId = sottocategoriaId || categoriaPrincipaleId;
            const durataPrevista = parseInt(document.getElementById('lavoro-durata').value);
            const stato = document.getElementById('lavoro-stato').value;
            const note = document.getElementById('lavoro-note').value.trim();
            
            // Determina tipo assegnazione
            const tipoAssegnazione = document.querySelector('input[name="tipo-assegnazione"]:checked')?.value;
            const caposquadraId = document.getElementById('lavoro-caposquadra').value;
            const operaioId = document.getElementById('lavoro-operaio').value;
            
            if (!nome || nome.length < 3) {
                showAlert('Il nome lavoro deve essere di almeno 3 caratteri', 'error');
                return;
            }
            
            if (!categoriaPrincipaleId) {
                showAlert('Seleziona una categoria principale lavoro', 'error');
                return;
            }
            
            if (!tipoLavoro) {
                showAlert('Seleziona un tipo lavoro specifico', 'error');
                return;
            }
            
            if (!terrenoId) {
                showAlert('Seleziona un terreno', 'error');
                return;
            }
            
            // Validazione assegnazione
            if (tipoAssegnazione === 'squadra') {
                if (!caposquadraId) {
                    showAlert('Seleziona un caposquadra per lavori di squadra', 'error');
                    return;
                }
            } else if (tipoAssegnazione === 'autonomo') {
                if (!operaioId) {
                    showAlert('Seleziona un operaio per lavori autonomi', 'error');
                    return;
                }
            } else {
                showAlert('Seleziona un tipo di assegnazione', 'error');
                return;
            }
            
            if (!dataInizio) {
                showAlert('Seleziona una data di inizio', 'error');
                return;
            }
            
            if (!durataPrevista || durataPrevista < 1) {
                showAlert('La durata deve essere di almeno 1 giorno', 'error');
                return;
            }
            
            try {
                const lavoroData = {
                    nome,
                    terrenoId,
                    tipoLavoro,
                    dataInizio: Timestamp.fromDate(new Date(dataInizio)),
                    durataPrevista,
                    stato,
                    note: note || '',
                    aggiornatoIl: serverTimestamp()
                };
                
                // Assegnazione flessibile: O caposquadra O operaio (non entrambi)
                if (tipoAssegnazione === 'squadra') {
                    lavoroData.caposquadraId = caposquadraId;
                    lavoroData.operaioId = null;
                } else {
                    lavoroData.operaioId = operaioId;
                    lavoroData.caposquadraId = null;
                }
                
                // Campi macchine (solo se modulo Parco Macchine attivo)
                if (hasParcoMacchineModule) {
                    const macchinaId = document.getElementById('lavoro-trattore')?.value || null;
                    const attrezzoId = document.getElementById('lavoro-attrezzo')?.value || null;
                    let operatoreMacchinaId = document.getElementById('lavoro-operatore-macchina')?.value || null;
                    
                    // Se operatore macchina non specificato ma c'√® un operaio responsabile, usa quello
                    if (!operatoreMacchinaId && tipoAssegnazione === 'autonomo' && operaioId) {
                        operatoreMacchinaId = operaioId;
                    }
                    
                    lavoroData.macchinaId = macchinaId || null;
                    lavoroData.attrezzoId = attrezzoId || null;
                    lavoroData.operatoreMacchinaId = operatoreMacchinaId || null;
                    
                    // Gestisci stato macchine (aggiorna solo se macchina assegnata/rimossa)
                    if (currentLavoroId) {
                        // Modifica: verifica se macchina √® cambiata
                        const lavoroEsistente = lavoriList.find(l => l.id === currentLavoroId);
                        if (lavoroEsistente) {
                            // Libera macchina vecchia se cambiata
                            if (lavoroEsistente.macchinaId && lavoroEsistente.macchinaId !== macchinaId) {
                                await updateMacchinaStato(lavoroEsistente.macchinaId, 'disponibile');
                            }
                            if (lavoroEsistente.attrezzoId && lavoroEsistente.attrezzoId !== attrezzoId) {
                                await updateMacchinaStato(lavoroEsistente.attrezzoId, 'disponibile');
                            }
                        }
                    }
                    
                    // Imposta macchine come in_uso se assegnate e lavoro non completato/annullato
                    const statiCompletati = ['completato', 'completato_da_approvare', 'annullato'];
                    const lavoroNonCompletato = !statiCompletati.includes(stato);
                    
                    console.log(`üìä Gestione macchine - Stato lavoro: ${stato}, Non completato: ${lavoroNonCompletato}`);
                    console.log(`üìä Macchine assegnate - Trattore: ${macchinaId}, Attrezzo: ${attrezzoId}`);
                    
                    if (macchinaId && lavoroNonCompletato) {
                        console.log(`üîß Imposto trattore ${macchinaId} come in_uso per lavoro ${currentLavoroId || 'nuovo'}`);
                        await updateMacchinaStato(macchinaId, 'in_uso');
                    } else if (macchinaId && !lavoroNonCompletato) {
                        console.log(`‚è≠Ô∏è Trattore ${macchinaId} NON impostato come in_uso perch√© lavoro √® ${stato}`);
                    }
                    
                    if (attrezzoId && lavoroNonCompletato) {
                        console.log(`üîß Imposto attrezzo ${attrezzoId} come in_uso per lavoro ${currentLavoroId || 'nuovo'}`);
                        await updateMacchinaStato(attrezzoId, 'in_uso');
                    } else if (attrezzoId && !lavoroNonCompletato) {
                        console.log(`‚è≠Ô∏è Attrezzo ${attrezzoId} NON impostato come in_uso perch√© lavoro √® ${stato}`);
                    }
                    
                    // Libera macchine se lavoro completato/annullato
                    if (statiCompletati.includes(stato)) {
                        if (macchinaId) {
                            console.log(`üîß Libero trattore ${macchinaId} per lavoro ${stato}`);
                            await updateMacchinaStato(macchinaId, 'disponibile');
                        }
                        if (attrezzoId) {
                            console.log(`üîß Libero attrezzo ${attrezzoId} per lavoro ${stato}`);
                            await updateMacchinaStato(attrezzoId, 'disponibile');
                        }
                    }
                }
                
                if (currentLavoroId) {
                    // Modifica lavoro esistente
                    lavoroData.aggiornatoIl = serverTimestamp();
                    
                    await updateDoc(doc(db, 'tenants', currentTenantId, 'lavori', currentLavoroId), lavoroData);
                    showAlert('Lavoro modificato con successo!', 'success');
                } else {
                    // Crea nuovo lavoro
                    lavoroData.creatoDa = currentUserData.id;
                    lavoroData.creatoIl = serverTimestamp();
                    
                    await addDoc(collection(db, 'tenants', currentTenantId, 'lavori'), lavoroData);
                    showAlert('Lavoro creato con successo!', 'success');
                }
                
                closeLavoroModal();
                
                // Ricarica macchine se modulo Parco Macchine attivo (per aggiornare stati)
                if (hasParcoMacchineModule) {
                    await loadTrattori();
                    await loadAttrezzi();
                }
                
                await loadLavori();
                await loadStatistics();
            } catch (error) {
                console.error('Errore salvataggio lavoro:', error);
                showAlert(`Errore: ${error.message}`, 'error');
            }
        };

        // Apri modal elimina lavoro
        window.openEliminaModal = async function(lavoroId) {
            const lavoro = lavoriList.find(l => l.id === lavoroId);
            
            if (!lavoro) {
                showAlert('Lavoro non trovato', 'error');
                return;
            }
            
            // Verifica se ci sono zone lavorate o ore (quando avremo i moduli)
            // Per ora, chiediamo solo conferma
            
            if (confirm(`Sei sicuro di voler eliminare il lavoro "${lavoro.nome}"?\n\nQuesta azione non pu√≤ essere annullata.`)) {
                try {
                    // Libera macchine se assegnate (solo se modulo Parco Macchine attivo)
                    if (hasParcoMacchineModule) {
                        if (lavoro.macchinaId) {
                            await updateMacchinaStato(lavoro.macchinaId, 'disponibile');
                        }
                        if (lavoro.attrezzoId) {
                            await updateMacchinaStato(lavoro.attrezzoId, 'disponibile');
                        }
                    }
                    
                    await deleteDoc(doc(db, 'tenants', currentTenantId, 'lavori', lavoroId));
                    showAlert('Lavoro eliminato con successo!', 'success');
                    
                    // Ricarica macchine per aggiornare stati
                    if (hasParcoMacchineModule) {
                        await loadTrattori();
                        await loadAttrezzi();
                    }
                    
                    await loadLavori();
                } catch (error) {
                    console.error('Errore eliminazione lavoro:', error);
                    showAlert(`Errore: ${error.message}`, 'error');
                }
            }
        };

        // Mostra alert
        function showAlert(message, type = 'info') {
            const container = document.getElementById('alert-container');
            const alertClass = `alert-${type}`;
            const alert = document.createElement('div');
            alert.className = `alert ${alertClass}`;
            alert.textContent = message;
            container.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        // Approva lavoro completato dal caposquadra
        window.approvaLavoro = async function(lavoroId) {
            const lavoro = lavoriList.find(l => l.id === lavoroId);
            if (!lavoro) {
                showAlert('Lavoro non trovato', 'error');
                return;
            }
            
            const conferma = confirm(
                `Sei sicuro di voler approvare questo lavoro?\n\n` +
                `Lavoro: ${lavoro.nome}\n` +
                `Il lavoro sar√† marcato come completato al 100%.`
            );
            
            if (!conferma) return;
            
            try {
                const lavoroRef = doc(db, 'tenants', currentTenantId, 'lavori', lavoroId);
                const terrenoDoc = await getDoc(doc(db, 'tenants', currentTenantId, 'terreni', lavoro.terrenoId));
                const terreno = terrenoDoc.exists() ? terrenoDoc.data() : null;
                const superficieTotale = terreno?.superficie || 0;
                
                // Aggiorna stato a "completato" e forza percentuale a 100%
                await updateDoc(lavoroRef, {
                    stato: 'completato',
                    superficieTotaleLavorata: superficieTotale, // Forza a superficie totale
                    superficieRimanente: 0,
                    percentualeCompletamento: 100,
                    approvatoDa: currentUserData.id,
                    approvatoIl: serverTimestamp(),
                    aggiornatoIl: serverTimestamp()
                });
                
                // Libera macchine se modulo Parco Macchine attivo
                if (hasParcoMacchineModule) {
                    if (lavoro.macchinaId) {
                        await updateMacchinaStato(lavoro.macchinaId, 'disponibile');
                    }
                    if (lavoro.attrezzoId) {
                        await updateMacchinaStato(lavoro.attrezzoId, 'disponibile');
                    }
                    
                    // Ricarica trattori e attrezzi per aggiornare dropdown
                    await loadTrattori();
                    await loadAttrezzi();
                }
                
                showAlert('Lavoro approvato con successo!', 'success');
                await loadLavori(); // Ricarica lavori
            } catch (error) {
                console.error('Errore approvazione lavoro:', error);
                showAlert(`Errore: ${error.message}`, 'error');
            }
        };
        
        // Rifiuta lavoro completato dal caposquadra
        window.rifiutaLavoro = async function(lavoroId) {
            const lavoro = lavoriList.find(l => l.id === lavoroId);
            if (!lavoro) {
                showAlert('Lavoro non trovato', 'error');
                return;
            }
            
            const motivo = prompt(
                `Inserisci il motivo del rifiuto (opzionale):\n\n` +
                `Lavoro: ${lavoro.nome}`
            );
            
            if (motivo === null) return; // Utente ha annullato
            
            try {
                const lavoroRef = doc(db, 'tenants', currentTenantId, 'lavori', lavoroId);
                
                // Riporta stato a "in_corso" per permettere al caposquadra di continuare
                await updateDoc(lavoroRef, {
                    stato: 'in_corso',
                    rifiutatoDa: currentUserData.id,
                    rifiutatoIl: serverTimestamp(),
                    motivoRifiuto: motivo || '',
                    aggiornatoIl: serverTimestamp()
                });
                
                showAlert('Lavoro rifiutato. Il caposquadra pu√≤ continuare a tracciare zone.', 'success');
                await loadLavori(); // Ricarica lavori
            } catch (error) {
                console.error('Errore rifiuto lavoro:', error);
                showAlert(`Errore: ${error.message}`, 'error');
            }
        };
        
        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Carica statistiche generali
        async function loadStatistics() {
            try {
                let totaleLavori = lavoriList.length;
                let lavoriInCorso = lavoriList.filter(l => l.stato === 'in_corso').length;
                let totaleOreValidate = 0;
                let totaleSuperficieLavorata = 0;
                let lavoriInRitardo = 0;
                let lavoriInTempo = 0;
                let lavoriInAnticipo = 0;

                // Carica ore validate e calcola stato progresso per tutti i lavori
                for (const lavoro of lavoriList) {
                    const oreRef = collection(db, 'tenants', currentTenantId, 'lavori', lavoro.id, 'oreOperai');
                    const oreSnapshot = await getDocs(oreRef);
                    
                    oreSnapshot.forEach(oraDoc => {
                        const oraData = oraDoc.data();
                        if (oraData.stato === 'validate') {
                            totaleOreValidate += oraData.oreNette || 0;
                        }
                    });

                    // Carica superficie lavorata
                    const zoneRef = collection(db, 'tenants', currentTenantId, 'lavori', lavoro.id, 'zoneLavorate');
                    const zoneSnapshot = await getDocs(zoneRef);
                    
                    let superficieLavorataLavoro = 0;
                    zoneSnapshot.forEach(zonaDoc => {
                        const zonaData = zonaDoc.data();
                        superficieLavorataLavoro += zonaData.superficieHa || 0;
                    });
                    totaleSuperficieLavorata += superficieLavorataLavoro;

                    // Calcola stato progresso se il lavoro ha durata prevista e data inizio
                    if (lavoro.dataInizio && lavoro.durataPrevista && lavoro.stato !== 'completato' && lavoro.stato !== 'annullato') {
                        const dataInizio = lavoro.dataInizio instanceof Date 
                            ? lavoro.dataInizio 
                            : (lavoro.dataInizio?.toDate ? lavoro.dataInizio.toDate() : new Date(lavoro.dataInizio));
                        const oggi = new Date();
                        oggi.setHours(0, 0, 0, 0);
                        dataInizio.setHours(0, 0, 0, 0);
                        
                        const giorniEffettivi = Math.max(0, Math.floor((oggi - dataInizio) / (1000 * 60 * 60 * 24)) + 1);
                        
                        if (giorniEffettivi > 0) {
                            // Carica terreno per ottenere superficie totale
                            const terrenoDoc = await getDoc(doc(db, 'tenants', currentTenantId, 'terreni', lavoro.terrenoId));
                            const terreno = terrenoDoc.exists() ? terrenoDoc.data() : null;
                            const superficieTotale = terreno?.superficie || 0;
                            
                            const percentualeCompletamento = superficieTotale > 0 ? (superficieLavorataLavoro / superficieTotale * 100) : 0;
                            const percentualeTempo = (giorniEffettivi / lavoro.durataPrevista) * 100;
                            const tolleranza = 10; // Tolleranza del 10%
                            
                            if (percentualeCompletamento > percentualeTempo + tolleranza) {
                                lavoriInAnticipo++;
                            } else if (percentualeCompletamento < percentualeTempo - tolleranza) {
                                lavoriInRitardo++;
                            } else {
                                lavoriInTempo++;
                            }
                        }
                    }
                }

                // Aggiorna UI
                document.getElementById('stat-totale-lavori').textContent = totaleLavori;
                document.getElementById('stat-lavori-corso').textContent = lavoriInCorso;
                
                // Formatta ore
                const oreFormatted = totaleOreValidate >= 1 
                    ? `${Math.round(totaleOreValidate)}h`
                    : `${Math.round(totaleOreValidate * 60)}min`;
                document.getElementById('stat-ore-validate').textContent = oreFormatted;
                
                document.getElementById('stat-superficie-lavorata').textContent = `${totaleSuperficieLavorata.toFixed(2)} ha`;
                
                // Aggiorna statistiche stato progresso
                document.getElementById('stat-lavori-ritardo').textContent = lavoriInRitardo;
                document.getElementById('stat-lavori-tempo').textContent = lavoriInTempo;
                document.getElementById('stat-lavori-anticipo').textContent = lavoriInAnticipo;
            } catch (error) {
                console.error('Errore caricamento statistiche:', error);
            }
        }

        // Carica progressi per un singolo lavoro
        async function loadProgressiLavoro(lavoroId) {
            try {
                // Prima prova a usare il campo del documento lavoro (pi√π veloce)
                const lavoroDoc = await getDoc(doc(db, 'tenants', currentTenantId, 'lavori', lavoroId));
                if (lavoroDoc.exists()) {
                    const lavoroData = lavoroDoc.data();
                    if (lavoroData.superficieTotaleLavorata) {
                        return { superficieLavorata: lavoroData.superficieTotaleLavorata };
                    }
                }
                
                // Fallback: calcola dalle zone lavorate (pi√π accurato ma pi√π lento)
                const zoneRef = collection(db, 'tenants', currentTenantId, 'lavori', lavoroId, 'zoneLavorate');
                const zoneSnapshot = await getDocs(zoneRef);
                
                let superficieLavorata = 0;
                zoneSnapshot.forEach(zonaDoc => {
                    const zonaData = zonaDoc.data();
                    superficieLavorata += zonaData.superficieHa || 0;
                });

                return { superficieLavorata };
            } catch (error) {
                console.error('Errore caricamento progressi:', error);
                return { superficieLavorata: 0 };
            }
        }

        // Apri modal dettaglio lavoro
        window.openDettaglioModal = async function(lavoroId) {
            currentLavoroId = lavoroId;
            const lavoro = lavoriList.find(l => l.id === lavoroId);
            
            if (!lavoro) {
                showAlert('Lavoro non trovato', 'error');
                return;
            }

            document.getElementById('dettaglio-title').textContent = `Dettaglio: ${lavoro.nome}`;
            document.getElementById('dettaglio-modal').classList.add('active');
            
            // Reset tabs
            switchTab('overview');
            
            // Carica contenuto iniziale
            await loadDettaglioOverview(lavoroId);
        };

        // Chiudi modal dettaglio
        window.closeDettaglioModal = function() {
            document.getElementById('dettaglio-modal').classList.remove('active');
            currentLavoroId = null;
            
            // Pulisci mappa
            if (dettaglioMap) {
                dettaglioMapMarkers.forEach(m => m.setMap(null));
                dettaglioMapPolygons.forEach(p => p.setMap(null));
                dettaglioMapMarkers = [];
                dettaglioMapPolygons = [];
            }
        };

        // Cambia tab nel modal
        window.switchTab = async function(tabName) {
            // Aggiorna tab attivi
            document.querySelectorAll('.modal-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            // Carica contenuto del tab se necessario
            if (tabName === 'map' && currentLavoroId) {
                await loadDettaglioMap(currentLavoroId);
            } else if (tabName === 'ore' && currentLavoroId) {
                await loadDettaglioOre(currentLavoroId);
            }
        };

        // Carica contenuto tab Panoramica
        async function loadDettaglioOverview(lavoroId) {
            const container = document.getElementById('dettaglio-overview-content');
            container.innerHTML = '<div class="loading">Caricamento dettagli...</div>';

            try {
                const lavoro = lavoriList.find(l => l.id === lavoroId);
                if (!lavoro) {
                    container.innerHTML = '<div class="empty-state">Lavoro non trovato</div>';
                    return;
                }

                const terreno = terreniList.find(t => t.id === lavoro.terrenoId);
                const caposquadra = caposquadraList.find(c => c.id === lavoro.caposquadraId);
                const progressi = await loadProgressiLavoro(lavoroId);
                
                // Carica ore validate
                const oreRef = collection(db, 'tenants', currentTenantId, 'lavori', lavoroId, 'oreOperai');
                const oreSnapshot = await getDocs(oreRef);
                let totaleOreValidate = 0;
                let totaleOreDaValidare = 0;
                oreSnapshot.forEach(oraDoc => {
                    const oraData = oraDoc.data();
                    if (oraData.stato === 'validate') {
                        totaleOreValidate += oraData.oreNette || 0;
                    } else if (oraData.stato === 'da_validare') {
                        totaleOreDaValidare += oraData.oreNette || 0;
                    }
                });

                const superficieTotale = terreno?.superficie || 0;
                const superficieLavorata = progressi.superficieLavorata || 0;
                const percentuale = superficieTotale > 0 ? Math.round((superficieLavorata / superficieTotale) * 100) : 0;

                container.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
                        <div class="ore-stat-card">
                            <div class="ore-stat-value">${superficieLavorata.toFixed(2)} / ${superficieTotale.toFixed(2)} ha</div>
                            <div class="ore-stat-label">Superficie Lavorata</div>
                        </div>
                        <div class="ore-stat-card">
                            <div class="ore-stat-value">${percentuale}%</div>
                            <div class="ore-stat-label">Percentuale Completamento</div>
                        </div>
                        <div class="ore-stat-card">
                            <div class="ore-stat-value">${Math.round(totaleOreValidate)}h</div>
                            <div class="ore-stat-label">Ore Validate</div>
                        </div>
                        <div class="ore-stat-card">
                            <div class="ore-stat-value">${Math.round(totaleOreDaValidare)}h</div>
                            <div class="ore-stat-label">Ore da Validare</div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h4 style="margin-bottom: 10px;">Progressi</h4>
                        <div class="progress-bar-inline" style="height: 30px;">
                            <div class="progress-fill-inline" style="width: ${Math.min(percentuale, 100)}%; height: 30px; font-size: 14px;">${percentuale}%</div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div>
                            <strong>Terreno:</strong> ${terreno ? terreno.nome : 'N/A'}
                        </div>
                        <div>
                            <strong>Caposquadra:</strong> ${caposquadra ? `${caposquadra.nome || ''} ${caposquadra.cognome || ''}`.trim() : 'N/A'}
                        </div>
                        <div>
                            <strong>Data Inizio:</strong> ${lavoro.dataInizio ? new Date(lavoro.dataInizio).toLocaleDateString('it-IT') : 'N/A'}
                        </div>
                        <div>
                            <strong>Durata Prevista:</strong> ${lavoro.durataPrevista || 0} giorni
                        </div>
                        <div>
                            <strong>Stato:</strong> <span class="badge badge-${lavoro.stato || 'assegnato'}">${getStatoFormattato(lavoro.stato)}</span>
                        </div>
                    </div>
                    
                    ${lavoro.note ? `<div style="margin-top: 20px;"><strong>Note:</strong><br>${escapeHtml(lavoro.note)}</div>` : ''}
                `;
            } catch (error) {
                console.error('Errore caricamento dettaglio:', error);
                container.innerHTML = '<div class="empty-state">Errore caricamento dettagli</div>';
            }
        }

        // Carica contenuto tab Mappa
        async function loadDettaglioMap(lavoroId) {
            const container = document.getElementById('dettaglio-map-content');
            const mapContainer = document.getElementById('dettaglio-map');
            const zoneListContainer = document.getElementById('zone-list');
            
            try {
                const lavoro = lavoriList.find(l => l.id === lavoroId);
                if (!lavoro) {
                    container.innerHTML = '<div class="empty-state">Lavoro non trovato</div>';
                    return;
                }

                const terreno = terreniList.find(t => t.id === lavoro.terrenoId);
                if (!terreno || !terreno.polygonCoords || terreno.polygonCoords.length === 0) {
                    mapContainer.innerHTML = '<div class="empty-state">Terreno senza confini mappa</div>';
                    zoneListContainer.innerHTML = '<div class="empty-state">Nessuna zona lavorata</div>';
                    return;
                }

                // Inizializza mappa (sempre re-inizializza per ogni lavoro)
                const center = terreno.coordinate || { lat: 45.0, lng: 9.0 };
                if (typeof google !== 'undefined' && google.maps) {
                    dettaglioMap = new google.maps.Map(mapContainer, {
                        zoom: 15,
                        center: center,
                        mapTypeId: 'satellite'
                    });
                } else {
                    mapContainer.innerHTML = '<div class="empty-state">Google Maps non disponibile. Attendi il caricamento...</div>';
                    setTimeout(() => loadDettaglioMap(lavoroId), 1000);
                    return;
                }

                // Pulisci markers e poligoni precedenti
                dettaglioMapMarkers.forEach(m => m.setMap(null));
                dettaglioMapPolygons.forEach(p => p.setMap(null));
                dettaglioMapMarkers = [];
                dettaglioMapPolygons = [];

                // Disegna confini terreno
                const terrenoCoords = terreno.polygonCoords.map(c => {
                    if (typeof c === 'object' && c !== null) {
                        return {
                            lat: c.lat !== undefined ? c.lat : (Array.isArray(c) ? c[0] : 45.0),
                            lng: c.lng !== undefined ? c.lng : (Array.isArray(c) ? c[1] : 9.0)
                        };
                    } else if (Array.isArray(c)) {
                        return { lat: c[0] || 45.0, lng: c[1] || 9.0 };
                    }
                    return { lat: 45.0, lng: 9.0 };
                });
                
                const terrenoPolygon = new google.maps.Polygon({
                    paths: terrenoCoords,
                    strokeColor: '#FF0000',
                    strokeOpacity: 0.8,
                    strokeWeight: 3,
                    fillColor: '#FF0000',
                    fillOpacity: 0.1
                });
                terrenoPolygon.setMap(dettaglioMap);
                dettaglioMapPolygons.push(terrenoPolygon);

                // Aggiusta zoom per includere tutto il terreno
                const bounds = new google.maps.LatLngBounds();
                terrenoCoords.forEach(coord => bounds.extend(coord));
                dettaglioMap.fitBounds(bounds);

                // Carica zone lavorate
                const zoneRef = collection(db, 'tenants', currentTenantId, 'lavori', lavoroId, 'zoneLavorate');
                const zoneSnapshot = await getDocs(zoneRef);
                
                let zoneList = [];
                zoneSnapshot.forEach(zonaDoc => {
                    const zonaData = zonaDoc.data();
                    zoneList.push({ id: zonaDoc.id, ...zonaData });
                    
                    // Disegna zona lavorata sulla mappa
                    if (zonaData.coordinate && zonaData.coordinate.length > 0) {
                        const zonaCoords = zonaData.coordinate.map(c => ({
                            lat: c.lat,
                            lng: c.lng
                        }));
                        
                        const zonaPolygon = new google.maps.Polygon({
                            paths: zonaCoords,
                            strokeColor: '#00FF00',
                            strokeOpacity: 0.8,
                            strokeWeight: 2,
                            fillColor: '#00FF00',
                            fillOpacity: 0.3
                        });
                        zonaPolygon.setMap(dettaglioMap);
                        dettaglioMapPolygons.push(zonaPolygon);
                    }
                });

                // Ordina zone per data (pi√π recenti prima)
                zoneList.sort((a, b) => {
                    const dateA = a.data?.toDate ? a.data.toDate() : new Date(a.data);
                    const dateB = b.data?.toDate ? b.data.toDate() : new Date(b.data);
                    return dateB - dateA;
                });

                // Renderizza lista zone
                if (zoneList.length === 0) {
                    zoneListContainer.innerHTML = '<div class="empty-state">Nessuna zona lavorata tracciata</div>';
                } else {
                    zoneListContainer.innerHTML = zoneList.map(zona => {
                        const dataFormatted = zona.data?.toDate 
                            ? zona.data.toDate().toLocaleDateString('it-IT')
                            : new Date(zona.data).toLocaleDateString('it-IT');
                        return `
                            <div class="zone-item">
                                <div class="zone-info">
                                    <div class="zone-date">${dataFormatted}</div>
                                    <div class="zone-surface">${(zona.superficieHa || 0).toFixed(2)} ha</div>
                                </div>
                                <div>${zona.tipo === 'poligono' ? 'üî∑ Poligono' : 'üìè Segmento'}</div>
                            </div>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('Errore caricamento mappa:', error);
                mapContainer.innerHTML = '<div class="empty-state">Errore caricamento mappa</div>';
            }
        }

        // Carica contenuto tab Ore
        async function loadDettaglioOre(lavoroId) {
            const container = document.getElementById('dettaglio-ore-content');
            container.innerHTML = '<div class="loading">Caricamento statistiche ore...</div>';

            try {
                const lavoro = lavoriList.find(l => l.id === lavoroId);
                if (!lavoro) {
                    container.innerHTML = '<div class="empty-state">Lavoro non trovato</div>';
                    return;
                }

                // Carica ore
                const oreRef = collection(db, 'tenants', currentTenantId, 'lavori', lavoroId, 'oreOperai');
                const oreSnapshot = await getDocs(oreRef);
                
                let oreList = [];
                let totaleValidate = 0;
                let totaleDaValidare = 0;
                let totaleRifiutate = 0;
                let orePerOperaio = {};

                oreSnapshot.forEach(oraDoc => {
                    const oraData = oraDoc.data();
                    oreList.push({ id: oraDoc.id, ...oraData });
                    
                    const oreNette = oraData.oreNette || 0;
                    const operaioId = oraData.operaioId;
                    
                    if (oraData.stato === 'validate') {
                        totaleValidate += oreNette;
                    } else if (oraData.stato === 'da_validare') {
                        totaleDaValidare += oreNette;
                    } else if (oraData.stato === 'rifiutate') {
                        totaleRifiutate += oreNette;
                    }
                    
                    if (!orePerOperaio[operaioId]) {
                        orePerOperaio[operaioId] = { validate: 0, daValidare: 0, rifiutate: 0 };
                    }
                    
                    if (oraData.stato === 'validate') {
                        orePerOperaio[operaioId].validate += oreNette;
                    } else if (oraData.stato === 'da_validare') {
                        orePerOperaio[operaioId].daValidare += oreNette;
                    } else if (oraData.stato === 'rifiutate') {
                        orePerOperaio[operaioId].rifiutate += oreNette;
                    }
                });

                // Carica nomi operai
                const operaiMap = {};
                for (const operaioId of Object.keys(orePerOperaio)) {
                    try {
                        const operaioDoc = await getDoc(doc(db, 'users', operaioId));
                        if (operaioDoc.exists()) {
                            const operaioData = operaioDoc.data();
                            operaiMap[operaioId] = `${operaioData.nome || ''} ${operaioData.cognome || ''}`.trim() || operaioData.email || 'N/A';
                        }
                    } catch (error) {
                        console.error('Errore caricamento operaio:', error);
                        operaiMap[operaioId] = 'N/A';
                    }
                }

                container.innerHTML = `
                    <div class="ore-stats-grid">
                        <div class="ore-stat-card">
                            <div class="ore-stat-value">${Math.round(totaleValidate)}h</div>
                            <div class="ore-stat-label">Ore Validate</div>
                        </div>
                        <div class="ore-stat-card">
                            <div class="ore-stat-value">${Math.round(totaleDaValidare)}h</div>
                            <div class="ore-stat-label">Ore da Validare</div>
                        </div>
                        <div class="ore-stat-card">
                            <div class="ore-stat-value">${Math.round(totaleRifiutate)}h</div>
                            <div class="ore-stat-label">Ore Rifiutate</div>
                        </div>
                    </div>
                    
                    <h4 style="margin-bottom: 15px;">Ore per Operaio</h4>
                    <div style="display: grid; gap: 10px;">
                        ${Object.keys(orePerOperaio).map(operaioId => {
                            const ore = orePerOperaio[operaioId];
                            const nomeOperaio = operaiMap[operaioId] || 'N/A';
                            return `
                                <div style="padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                    <strong>${escapeHtml(nomeOperaio)}</strong>
                                    <div style="margin-top: 10px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                                        <div><span style="color: #2E8B57;">‚úÖ ${Math.round(ore.validate)}h</span> validate</div>
                                        <div><span style="color: #ffc107;">‚è≥ ${Math.round(ore.daValidare)}h</span> da validare</div>
                                        <div><span style="color: #dc3545;">‚ùå ${Math.round(ore.rifiutate)}h</span> rifiutate</div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            } catch (error) {
                console.error('Errore caricamento statistiche ore:', error);
                container.innerHTML = '<div class="empty-state">Errore caricamento statistiche ore</div>';
            }
        }

        // Funzioni per gestire modali categoria e tipo lavoro
        let openCategoriaLavoroModal, closeCategoriaLavoroModal, handleSalvaCategoriaLavoro;
        let openTipoLavoroModal, closeTipoLavoroModal, handleSalvaTipoLavoro;

        openCategoriaLavoroModal = function() {
            document.getElementById('categoria-lavoro-form').reset();
            document.getElementById('categoria-lavoro-modal').classList.add('active');
        }

        closeCategoriaLavoroModal = function() {
            document.getElementById('categoria-lavoro-modal').classList.remove('active');
            document.getElementById('categoria-lavoro-form').reset();
        }

        handleSalvaCategoriaLavoro = async function(e) {
            e.preventDefault();

            const nome = document.getElementById('categoria-lavoro-nome').value.trim();
            const descrizione = document.getElementById('categoria-lavoro-descrizione').value.trim() || null;

            if (!nome || nome.length < 3) {
                showAlert('Il nome categoria deve essere di almeno 3 caratteri', 'error');
                return;
            }

            try {
                // Genera codice dal nome
                const codice = nome
                    .toLowerCase()
                    .normalize('NFD')
                    .replace(/[\u0300-\u036f]/g, '')
                    .replace(/[^a-z0-9]+/g, '_')
                    .replace(/^_+|_+$/g, '');
                
                // Verifica che il codice non esista gi√†
                const categorieRef = collection(db, `tenants/${currentTenantId}/categorie`);
                const snapshot = await getDocs(query(categorieRef, where('codice', '==', codice)));
                
                if (!snapshot.empty) {
                    showAlert('Una categoria con questo nome esiste gi√†', 'error');
                    return;
                }
                
                const categoriaData = {
                    nome,
                    codice,
                    descrizione,
                    parentId: null, // Categoria principale
                    applicabileA: 'lavori', // Di default per lavori
                    predefinita: false,
                    ordine: null,
                    creatoDa: currentUserData.id,
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                };
                
                const categoriaDoc = await addDoc(categorieRef, categoriaData);
                
                showAlert('Categoria creata con successo', 'success');
                closeCategoriaLavoroModal();
                
                await loadCategorieLavori();
                
                // Seleziona la nuova categoria nel form lavoro
                const categoriaSelect = document.getElementById('lavoro-categoria-principale');
                if (categoriaSelect) {
                    categoriaSelect.value = categoriaDoc.id;
                    categoriaSelect.dispatchEvent(new Event('change'));
                }
            } catch (error) {
                console.error('Errore salvataggio categoria:', error);
                showAlert('Errore salvataggio categoria: ' + error.message, 'error');
            }
        }

        openTipoLavoroModal = function() {
            const categoriaPrincipaleId = document.getElementById('lavoro-categoria-principale').value;
            const sottocategoriaId = document.getElementById('lavoro-sottocategoria').value;
            
            if (!categoriaPrincipaleId) {
                showAlert('Seleziona prima una categoria principale lavoro', 'error');
                return;
            }

            // Usa sottocategoria se selezionata, altrimenti categoria principale
            const categoriaId = sottocategoriaId || categoriaPrincipaleId;

            document.getElementById('tipo-lavoro-form').reset();
            document.getElementById('tipo-lavoro-categoria').value = categoriaId;
            
            // Popola dropdown categoria nel modal (include principali e sottocategorie)
            const categoriaSelectModal = document.getElementById('tipo-lavoro-categoria');
            categoriaSelectModal.innerHTML = '<option value="">-- Seleziona categoria --</option>';
            
            // Aggiungi categorie principali
            categorieLavoriPrincipali.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = cat.nome;
                if (cat.id === categoriaId) {
                    option.selected = true;
                }
                categoriaSelectModal.appendChild(option);
                
                // Aggiungi sottocategorie
                const sottocat = sottocategorieLavoriMap.get(cat.id);
                if (sottocat) {
                    sottocat.forEach(subcat => {
                        const subOption = document.createElement('option');
                        subOption.value = subcat.id;
                        subOption.textContent = `  ‚îî ${subcat.nome}`;
                        if (subcat.id === categoriaId) {
                            subOption.selected = true;
                        }
                        categoriaSelectModal.appendChild(subOption);
                    });
                }
            });
            
            document.getElementById('tipo-lavoro-modal').classList.add('active');
        }

        closeTipoLavoroModal = function() {
            document.getElementById('tipo-lavoro-modal').classList.remove('active');
            document.getElementById('tipo-lavoro-form').reset();
        }

        handleSalvaTipoLavoro = async function(e) {
            e.preventDefault();

            const nome = document.getElementById('tipo-lavoro-nome').value.trim();
            const categoriaId = document.getElementById('tipo-lavoro-categoria').value;
            const descrizione = document.getElementById('tipo-lavoro-descrizione').value.trim() || null;

            if (!nome || nome.length < 2) {
                showAlert('Il nome tipo lavoro deve essere di almeno 2 caratteri', 'error');
                return;
            }

            if (!categoriaId) {
                showAlert('Seleziona una categoria', 'error');
                return;
            }

            try {
                // Verifica che la categoria esista (nella collezione unificata)
                const categoriaDoc = await getDoc(doc(db, `tenants/${currentTenantId}/categorie`, categoriaId));
                if (!categoriaDoc.exists()) {
                    showAlert('Categoria lavoro non trovata', 'error');
                    return;
                }
                
                // Verifica che non esista gi√† un tipo con lo stesso nome nella stessa categoria
                const tipiRef = collection(db, `tenants/${currentTenantId}/tipiLavoro`);
                const tipiSnapshot = await getDocs(query(tipiRef, where('categoriaId', '==', categoriaId)));
                
                const tipoEsistente = tipiSnapshot.docs.find(doc => {
                    const data = doc.data();
                    return data.nome && data.nome.toLowerCase() === nome.toLowerCase();
                });
                
                if (tipoEsistente) {
                    showAlert(`Un tipo lavoro con nome "${nome}" esiste gi√† in questa categoria`, 'error');
                    return;
                }
                
                const tipoLavoroData = {
                    nome,
                    categoriaId,
                    descrizione,
                    predefinito: false,
                    creatoDa: currentUserData.id,
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                };
                
                const tipoDoc = await addDoc(tipiRef, tipoLavoroData);
                
                showAlert('Tipo lavoro creato con successo', 'success');
                closeTipoLavoroModal();
                
                // Ricarica tipi lavoro per la categoria selezionata
                await loadTipiLavoro(categoriaId);
                
                // Seleziona il nuovo tipo nel form lavoro
                const tipoSelect = document.getElementById('lavoro-tipo-lavoro');
                if (tipoSelect) {
                    tipoSelect.value = nome;
                }
            } catch (error) {
                console.error('Errore salvataggio tipo lavoro:', error);
                showAlert('Errore salvataggio tipo lavoro: ' + error.message, 'error');
            }
        }

        // Export funzioni globali
        window.openCategoriaLavoroModal = openCategoriaLavoroModal;
        window.closeCategoriaLavoroModal = closeCategoriaLavoroModal;
        window.handleSalvaCategoriaLavoro = handleSalvaCategoriaLavoro;
        window.openTipoLavoroModal = openTipoLavoroModal;
        window.closeTipoLavoroModal = closeTipoLavoroModal;
        window.handleSalvaTipoLavoro = handleSalvaTipoLavoro;
    </script>
</body>
</html>

