<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Squadre - GFV Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #2E8B57 0%, #228B22 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .btn-primary:hover {
            background: rgba(255,255,255,0.3);
        }

        .modal .btn-primary {
            background: #2E8B57;
            color: white;
            border: none;
        }

        .modal .btn-primary:hover {
            background: #228B22;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }

        .content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-header h2 {
            color: #2E8B57;
            font-size: 24px;
        }

        .squadre-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .squadre-table th,
        .squadre-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .squadre-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        .squadre-table tr:hover {
            background: #f8f9fa;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: #2E8B57;
            font-size: 20px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .close-btn:hover {
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #2E8B57;
        }

        .checkbox-group {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ced4da;
            border-radius: 6px;
            padding: 10px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            border-radius: 4px;
        }

        .checkbox-item:hover {
            background: #f8f9fa;
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
            cursor: pointer;
        }

        .checkbox-item label {
            margin: 0;
            cursor: pointer;
            font-weight: normal;
            flex: 1;
        }

        .checkbox-item .user-info {
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        .checkbox-item .user-name {
            font-weight: 500;
        }

        .checkbox-item .user-email {
            font-size: 12px;
            color: #666;
        }

        .checkbox-item .user-cellulare {
            font-size: 11px;
            color: #999;
        }

        .warning-badge {
            display: inline-block;
            padding: 4px 8px;
            background: #fff3cd;
            color: #856404;
            border-radius: 4px;
            font-size: 11px;
            margin-left: 8px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        @media (max-width: 768px) {
            .squadre-table {
                font-size: 12px;
            }

            .squadre-table th,
            .squadre-table td {
                padding: 8px;
            }

            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>üë∑ Gestione Squadre</h1>
                <p style="opacity: 0.9; margin-top: 5px;">Crea e gestisci squadre di lavoro</p>
            </div>
            <div class="header-actions">
                <button class="btn btn-primary" id="btn-crea-squadra" onclick="openCreaModal()">‚ûï Crea Nuova Squadra</button>
                <a href="../dashboard-standalone.html" class="btn btn-secondary">‚Üê Dashboard</a>
            </div>
        </div>

        <div class="content">
            <div id="alert-container"></div>
            
            <div class="section-header">
                <h2>Squadre</h2>
                <div id="squadre-count">0 squadre</div>
            </div>

            <div id="squadre-container">
                <div class="loading">Caricamento squadre...</div>
            </div>
        </div>
    </div>

    <!-- Modal Crea/Modifica Squadra -->
    <div id="squadra-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Crea Nuova Squadra</h3>
                <button class="close-btn" onclick="closeSquadraModal()">&times;</button>
            </div>
            <form id="squadra-form" onsubmit="handleSalvaSquadra(event)">
                <input type="hidden" id="squadra-id">
                
                <div class="form-group">
                    <label for="squadra-nome">Nome Squadra *</label>
                    <input type="text" id="squadra-nome" required minlength="3" maxlength="50" 
                           placeholder="Es: Squadra Nord, Squadra Sud">
                </div>

                <div class="form-group">
                    <label for="squadra-caposquadra">Caposquadra *</label>
                    <select id="squadra-caposquadra" required>
                        <option value="">Seleziona caposquadra...</option>
                    </select>
                    <div id="caposquadra-warning" style="display: none; margin-top: 5px;"></div>
                </div>

                <div class="form-group">
                    <label>Operai <span style="color: #666; font-weight: normal;">(opzionale)</span></label>
                    <div id="operai-checkbox-group" class="checkbox-group">
                        <div class="loading">Caricamento operai...</div>
                    </div>
                    <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                        Seleziona gli operai da aggiungere alla squadra. Puoi aggiungerli anche successivamente modificando la squadra.
                    </small>
                </div>

                <div class="form-group">
                    <label for="squadra-note">Note</label>
                    <textarea id="squadra-note" placeholder="Note aggiuntive sulla squadra (opzionale)"></textarea>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Salva</button>
                    <button type="button" class="btn btn-secondary" onclick="closeSquadraModal()">Annulla</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Load Firebase config from external file -->
    <script>
        const configScript = document.createElement('script');
        configScript.src = '../config/firebase-config.js';
        configScript.onerror = function() {
            const fallbackScript = document.createElement('script');
            fallbackScript.src = 'https://raw.githubusercontent.com/VitaraDragon/gfv-platform/main/core/config/firebase-config.js';
            document.head.appendChild(fallbackScript);
        };
        document.head.appendChild(configScript);
    </script>
    
    <!-- Firebase SDK -->
    <script type="module">
        // Funzione per attendere il caricamento della configurazione Firebase
        function waitForConfig() {
            return new Promise((resolve, reject) => {
                if (typeof window.firebaseConfig !== 'undefined') {
                    resolve(window.firebaseConfig);
                    return;
                }
                
                let attempts = 0;
                const maxAttempts = 50;
                
                const checkInterval = setInterval(() => {
                    attempts++;
                    if (typeof window.firebaseConfig !== 'undefined') {
                        clearInterval(checkInterval);
                        resolve(window.firebaseConfig);
                    } else if (attempts >= maxAttempts) {
                        clearInterval(checkInterval);
                        reject(new Error('Firebase config not loaded after 5 seconds'));
                    }
                }, 100);
            });
        }

        const firebaseConfig = await waitForConfig();

        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, getDocs, doc, getDoc, setDoc, updateDoc, deleteDoc, query, where, orderBy, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUserData = null;
        let currentTenantId = null;
        let currentSquadraId = null;
        let caposquadraList = [];
        let operaiList = [];
        let squadreList = [];
        let isReadOnly = false; // Flag per modalit√† solo lettura (caposquadra)

        // Verifica autenticazione e permessi
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = '../auth/login-standalone.html';
                return;
            }

            try {
                // Carica dati utente
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                if (userDoc.exists()) {
                    currentUserData = userDoc.data();
                    currentTenantId = currentUserData.tenantId;

                    // Verifica permessi (manager, amministratore o caposquadra)
                    const isManager = currentUserData.ruoli && currentUserData.ruoli.includes('manager');
                    const isAmministratore = currentUserData.ruoli && currentUserData.ruoli.includes('amministratore');
                    const isCaposquadra = currentUserData.ruoli && currentUserData.ruoli.includes('caposquadra');
                    
                    if (!currentUserData.ruoli || (!isManager && !isAmministratore && !isCaposquadra)) {
                        showAlert('Non hai i permessi per accedere a questa pagina', 'error');
                        setTimeout(() => {
                            window.location.href = '../dashboard-standalone.html';
                        }, 2000);
                        return;
                    }
                    
                    // Se √® caposquadra, pu√≤ solo visualizzare la sua squadra (non pu√≤ creare/modificare)
                    isReadOnly = isCaposquadra && !isManager && !isAmministratore;

                    // Verifica se modulo Manodopera √® attivo
                    let hasManodoperaModule = false;
                    if (currentTenantId) {
                        try {
                            const tenantDoc = await getDoc(doc(db, 'tenants', currentTenantId));
                            if (tenantDoc.exists()) {
                                const tenantData = tenantDoc.data();
                                hasManodoperaModule = tenantData.modules && tenantData.modules.includes('manodopera');
                            }
                        } catch (error) {
                            console.warn('Errore verifica modulo Manodopera:', error);
                        }
                    }

                    // Se modulo Manodopera non √® attivo, mostra avviso e redirect
                    if (!hasManodoperaModule) {
                        showAlert('Questa pagina √® disponibile solo con il modulo Manodopera attivo. Attiva il modulo dall\'abbonamento.', 'error');
                        setTimeout(() => {
                            window.location.href = '../dashboard-standalone.html';
                        }, 3000);
                        return;
                    }

                    // Nascondi pulsante crea se √® caposquadra (solo lettura)
                    const btnCrea = document.getElementById('btn-crea-squadra');
                    if (btnCrea) {
                        btnCrea.style.display = isReadOnly ? 'none' : 'inline-block';
                    }
                    
                    // Modifica titolo se √® caposquadra
                    const headerTitle = document.querySelector('.header h1');
                    if (headerTitle && isReadOnly) {
                        headerTitle.textContent = 'üë• La Mia Squadra';
                    }
                    
                    // Carica dati iniziali
                    await Promise.all([
                        loadSquadre(),
                        loadCaposquadra(),
                        loadOperai()
                    ]);
                } else {
                    window.location.href = '../auth/login-standalone.html';
                }
            } catch (error) {
                console.error('Errore:', error);
                showAlert('Errore caricamento dati', 'error');
            }
        });

        // Carica lista squadre
        async function loadSquadre() {
            const container = document.getElementById('squadre-container');
            container.innerHTML = '<div class="loading">Caricamento squadre...</div>';

            try {
                const squadreRef = collection(db, 'tenants', currentTenantId, 'squadre');
                let q;
                
                // Se √® caposquadra in modalit√† read-only, filtra solo la sua squadra
                if (isReadOnly && currentUserData) {
                    const caposquadraId = currentUserData.id || currentUserData.uid;
                    // Non usare orderBy con where su campi diversi (richiede indice composito)
                    // Ordineremo in memoria dopo
                    q = query(squadreRef, where('caposquadraId', '==', caposquadraId));
                } else {
                    q = query(squadreRef, orderBy('nome', 'asc'));
                }
                
                const snapshot = await getDocs(q);
                
                squadreList = [];
                snapshot.forEach(doc => {
                    squadreList.push({ id: doc.id, ...doc.data() });
                });
                
                // Se √® caposquadra, ordina in memoria per nome
                if (isReadOnly) {
                    squadreList.sort((a, b) => {
                        const nomeA = (a.nome || '').toLowerCase();
                        const nomeB = (b.nome || '').toLowerCase();
                        return nomeA.localeCompare(nomeB);
                    });
                }

                renderSquadre();
            } catch (error) {
                console.error('Errore caricamento squadre:', error);
                container.innerHTML = '<div class="empty-state">Errore caricamento squadre</div>';
                showAlert('Errore caricamento squadre', 'error');
            }
        }

        // Renderizza lista squadre
        async function renderSquadre() {
            const container = document.getElementById('squadre-container');
            const countEl = document.getElementById('squadre-count');

            if (squadreList.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üë∑</div>
                        <p>Nessuna squadra creata</p>
                        <p style="font-size: 14px; margin-top: 10px;">Clicca su "Crea Nuova Squadra" per iniziare</p>
                    </div>
                `;
                countEl.textContent = '0 squadre';
                return;
            }

            // Carica dati caposquadra e operai per ogni squadra
            const squadreConDettagli = await Promise.all(
                squadreList.map(async (squadra) => {
                    const caposquadra = await getCaposquadraInfo(squadra.caposquadraId);
                    const operai = await Promise.all(
                        (squadra.operai || []).map(id => getOperaioInfo(id))
                    );
                    return { ...squadra, caposquadra, operai };
                })
            );

            // Se √® caposquadra (solo lettura), mostra vista dettagliata con contatti
            if (isReadOnly) {
                // Vista dettagliata per caposquadra: mostra lista operai con contatti
                let html = '<div style="margin-top: 20px;">';
                
                // Trova la squadra del caposquadra corrente
                const miaSquadra = squadreConDettagli.find(s => 
                    s.caposquadra && s.caposquadra.id === currentUserData.id
                );
                
                if (!miaSquadra || !miaSquadra.operai || miaSquadra.operai.length === 0) {
                    html += `
                        <div class="empty-state">
                            <div class="empty-state-icon">üë∑</div>
                            <p>Nessuna squadra assegnata</p>
                            <p style="font-size: 14px; margin-top: 10px;">Contatta il manager per essere assegnato a una squadra</p>
                        </div>
                    `;
                } else {
                    html += `
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <h3 style="color: #2E8B57; margin-bottom: 10px;">${escapeHtml(miaSquadra.nome || 'Squadra')}</h3>
                            ${miaSquadra.note ? `<p style="color: #666; margin-bottom: 15px;">${escapeHtml(miaSquadra.note)}</p>` : ''}
                        </div>
                        <h3 style="color: #2E8B57; margin-bottom: 15px;">Membri della Squadra (${miaSquadra.operai.length})</h3>
                        <table class="squadre-table">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Email</th>
                                    <th>Cellulare</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    miaSquadra.operai.forEach(operaio => {
                        const nomeCompleto = `${operaio.nome || ''} ${operaio.cognome || ''}`.trim() || operaio.email || 'N/A';
                        const cellulare = operaio.cellulare || 'Non disponibile';
                        const email = operaio.email || 'N/A';
                        
                        html += `
                            <tr>
                                <td><strong>${escapeHtml(nomeCompleto)}</strong></td>
                                <td>
                                    ${email !== 'N/A' ? `<a href="mailto:${escapeHtml(email)}" style="color: #2E8B57; text-decoration: none;">${escapeHtml(email)}</a>` : 'N/A'}
                                </td>
                                <td>
                                    ${cellulare !== 'Non disponibile' ? `
                                        <a href="tel:${cellulare.replace(/[\s\-]/g, '')}" style="color: #2E8B57; text-decoration: none; font-weight: 500;">
                                            üì± ${escapeHtml(cellulare)}
                                        </a>
                                    ` : '<span style="color: #999;">Non disponibile</span>'}
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += `
                            </tbody>
                        </table>
                    `;
                }
                
                html += '</div>';
                container.innerHTML = html;
                countEl.textContent = miaSquadra ? '1 squadra' : '0 squadre';
                return;
            }
            
            // Vista normale per Manager: tabella con tutte le squadre
            let html = `
                <table class="squadre-table">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Caposquadra</th>
                            <th>Operai</th>
                            <th>Note</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            squadreConDettagli.forEach(squadra => {
                const caposquadraNome = squadra.caposquadra 
                    ? `${squadra.caposquadra.nome || ''} ${squadra.caposquadra.cognome || ''}`.trim() || 'N/A'
                    : 'N/A';
                const operaiCount = squadra.operai ? squadra.operai.length : 0;
                const operaiNomi = squadra.operai && squadra.operai.length > 0
                    ? squadra.operai.map(op => `${op.nome || ''} ${op.cognome || ''}`.trim() || 'N/A').join(', ')
                    : 'Nessun operaio';
                const operaiLabel = operaiCount === 1 ? 'operaio' : 'operai';

                html += `
                    <tr>
                        <td><strong>${escapeHtml(squadra.nome || 'N/A')}</strong></td>
                        <td>${escapeHtml(caposquadraNome)}</td>
                        <td>
                            <strong>${operaiCount}</strong> ${operaiLabel}
                            ${operaiCount > 0 ? `<br><small style="color: #666;">${escapeHtml(operaiNomi)}</small>` : ''}
                        </td>
                        <td>${escapeHtml(squadra.note || '-')}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-info btn-sm" onclick="openModificaModal('${squadra.id}')">‚úèÔ∏è Modifica</button>
                                <button class="btn btn-danger btn-sm" onclick="openEliminaModal('${squadra.id}')">üóëÔ∏è Elimina</button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            container.innerHTML = html;
            countEl.textContent = `${squadreList.length} squadra${squadreList.length !== 1 ? 'e' : ''}`;
        }

        // Carica lista caposquadra disponibili
        async function loadCaposquadra() {
            try {
                const usersRef = collection(db, 'users');
                const q = query(
                    usersRef,
                    where('tenantId', '==', currentTenantId),
                    where('ruoli', 'array-contains', 'caposquadra'),
                    where('stato', '==', 'attivo')
                );
                const snapshot = await getDocs(q);
                
                caposquadraList = [];
                snapshot.forEach(doc => {
                    caposquadraList.push({ id: doc.id, ...doc.data() });
                });
            } catch (error) {
                console.error('Errore caricamento caposquadra:', error);
                caposquadraList = [];
            }
        }

        // Carica lista operai disponibili
        async function loadOperai() {
            try {
                const usersRef = collection(db, 'users');
                const q = query(
                    usersRef,
                    where('tenantId', '==', currentTenantId),
                    where('ruoli', 'array-contains', 'operaio'),
                    where('stato', '==', 'attivo')
                );
                const snapshot = await getDocs(q);
                
                operaiList = [];
                snapshot.forEach(doc => {
                    operaiList.push({ id: doc.id, ...doc.data() });
                });
            } catch (error) {
                console.error('Errore caricamento operai:', error);
                operaiList = [];
            }
        }

        // Ottieni info caposquadra
        async function getCaposquadraInfo(caposquadraId) {
            if (!caposquadraId) return null;
            try {
                const userDoc = await getDoc(doc(db, 'users', caposquadraId));
                if (userDoc.exists()) {
                    return { id: userDoc.id, ...userDoc.data() };
                }
            } catch (error) {
                console.error('Errore recupero caposquadra:', error);
            }
            return null;
        }

        // Ottieni info operaio
        async function getOperaioInfo(operaioId) {
            if (!operaioId) return null;
            try {
                const userDoc = await getDoc(doc(db, 'users', operaioId));
                if (userDoc.exists()) {
                    return { id: userDoc.id, ...userDoc.data() };
                }
            } catch (error) {
                console.error('Errore recupero operaio:', error);
            }
            return null;
        }

        // Apri modal crea squadra
        window.openCreaModal = function() {
            currentSquadraId = null;
            document.getElementById('modal-title').textContent = 'Crea Nuova Squadra';
            document.getElementById('squadra-form').reset();
            document.getElementById('squadra-id').value = '';
            document.getElementById('caposquadra-warning').style.display = 'none';
            
            // Popola dropdown caposquadra
            populateCaposquadraDropdown();
            
            // Popola checkbox operai
            populateOperaiCheckboxes();
            
            document.getElementById('squadra-modal').classList.add('active');
        };

        // Apri modal modifica squadra
        window.openModificaModal = async function(squadraId) {
            currentSquadraId = squadraId;
            const squadra = squadreList.find(s => s.id === squadraId);
            
            if (!squadra) {
                showAlert('Squadra non trovata', 'error');
                return;
            }

            document.getElementById('modal-title').textContent = 'Modifica Squadra';
            document.getElementById('squadra-id').value = squadraId;
            document.getElementById('squadra-nome').value = squadra.nome || '';
            document.getElementById('squadra-note').value = squadra.note || '';
            
            // Popola dropdown caposquadra
            populateCaposquadraDropdown(squadra.caposquadraId);
            
            // Verifica se caposquadra √® gi√† in altra squadra
            checkCaposquadraInAltraSquadra(squadra.caposquadraId, squadraId);
            
            // Popola checkbox operai
            populateOperaiCheckboxes(squadra.operai || []);
            
            document.getElementById('squadra-modal').classList.add('active');
        };

        // Popola dropdown caposquadra
        function populateCaposquadraDropdown(selectedId = null) {
            const select = document.getElementById('squadra-caposquadra');
            select.innerHTML = '<option value="">Seleziona caposquadra...</option>';
            
            if (caposquadraList.length === 0) {
                select.innerHTML = '<option value="">Nessun caposquadra disponibile</option>';
                select.disabled = true;
                
                // Mostra messaggio informativo
                const warningDiv = document.getElementById('caposquadra-warning');
                warningDiv.innerHTML = `
                    <div class="alert alert-warning" style="margin-top: 10px; padding: 12px;">
                        <strong>‚ö†Ô∏è Nessun caposquadra disponibile</strong><br>
                        <small>Per creare una squadra, devi prima assegnare il ruolo "caposquadra" agli utenti.<br>
                        <a href="gestisci-utenti-standalone.html" style="color: #856404; text-decoration: underline;">Vai a Gestisci Utenti ‚Üí</a></small>
                    </div>
                `;
                warningDiv.style.display = 'block';
                return;
            }
            
            select.disabled = false;
            document.getElementById('caposquadra-warning').innerHTML = '';
            document.getElementById('caposquadra-warning').style.display = 'none';
            
            caposquadraList.forEach(capo => {
                const nomeCompleto = `${capo.nome || ''} ${capo.cognome || ''}`.trim() || capo.email || 'N/A';
                const option = document.createElement('option');
                option.value = capo.id;
                option.textContent = `${nomeCompleto} (${capo.email || ''})`;
                if (selectedId === capo.id) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
            
            // Listener per verificare se caposquadra √® gi√† in altra squadra
            select.addEventListener('change', function() {
                if (this.value) {
                    checkCaposquadraInAltraSquadra(this.value, currentSquadraId);
                } else {
                    document.getElementById('caposquadra-warning').innerHTML = '';
                    document.getElementById('caposquadra-warning').style.display = 'none';
                }
            });
        }

        // Verifica se caposquadra √® gi√† in altra squadra
        function checkCaposquadraInAltraSquadra(caposquadraId, currentSquadraId) {
            const warningDiv = document.getElementById('caposquadra-warning');
            const squadraEsistente = squadreList.find(s => 
                s.caposquadraId === caposquadraId && s.id !== currentSquadraId
            );
            
            if (squadraEsistente) {
                warningDiv.innerHTML = '<span class="warning-badge">‚ö†Ô∏è Questo caposquadra √® gi√† assegnato a un\'altra squadra</span>';
                warningDiv.style.display = 'block';
            } else {
                warningDiv.innerHTML = '';
                warningDiv.style.display = 'none';
            }
        }

        // Verifica in quali squadre √® presente un operaio
        function getSquadreConOperaio(operaioId, excludeSquadraId = null) {
            return squadreList.filter(squadra => {
                if (excludeSquadraId && squadra.id === excludeSquadraId) return false;
                return squadra.operai && squadra.operai.includes(operaioId);
            });
        }

        // Popola checkbox operai
        function populateOperaiCheckboxes(selectedIds = []) {
            const container = document.getElementById('operai-checkbox-group');
            
            if (operaiList.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info" style="padding: 15px; margin: 0;">
                        <strong>‚ÑπÔ∏è Nessun operaio disponibile</strong><br>
                        <small style="display: block; margin-top: 8px;">
                            Per aggiungere operai alla squadra, devi prima assegnare il ruolo "operaio" agli utenti.<br>
                            <a href="gestisci-utenti-standalone.html" style="color: #0c5460; text-decoration: underline; font-weight: 500;">Vai a Gestisci Utenti per assegnare ruoli ‚Üí</a>
                        </small>
                        <small style="display: block; margin-top: 8px; color: #666;">
                            <em>Nota: Puoi creare la squadra anche senza operai e aggiungerli successivamente.</em>
                        </small>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            operaiList.forEach(operaio => {
                const nomeCompleto = `${operaio.nome || ''} ${operaio.cognome || ''}`.trim() || operaio.email || 'N/A';
                const isSelected = selectedIds.includes(operaio.id);
                
                // Verifica se operaio √® gi√† in altre squadre
                const altreSquadre = getSquadreConOperaio(operaio.id, currentSquadraId);
                const inAltreSquadre = altreSquadre.length > 0;
                const nomiSquadre = altreSquadre.map(s => s.nome).join(', ');
                
                const checkboxItem = document.createElement('div');
                checkboxItem.className = 'checkbox-item';
                checkboxItem.style.position = 'relative';
                
                checkboxItem.innerHTML = `
                    <input type="checkbox" id="operaio-${operaio.id}" value="${operaio.id}" ${isSelected ? 'checked' : ''}>
                    <label for="operaio-${operaio.id}">
                        <div class="user-info">
                            <div class="user-name">${escapeHtml(nomeCompleto)}</div>
                            <div class="user-email">${escapeHtml(operaio.email || '')}</div>
                            ${operaio.cellulare ? `<div class="user-cellulare">üì± ${escapeHtml(operaio.cellulare)}</div>` : ''}
                        </div>
                    </label>
                    ${inAltreSquadre ? `
                        <div class="operaio-warning" id="warning-operaio-${operaio.id}" style="margin-top: 5px; padding: 8px; background: #fff3cd; border-left: 3px solid #ffc107; border-radius: 4px; font-size: 12px; color: #856404;">
                            <strong>‚ÑπÔ∏è Informazione:</strong> Questo operaio √® gi√† presente nella squadra: <strong>${escapeHtml(nomiSquadre)}</strong><br>
                            <small style="color: #666;">√à normale se le squadre lavorano in periodi diversi (es. Vendemmia e Potatura).</small>
                        </div>
                    ` : ''}
                `;
                
                container.appendChild(checkboxItem);
                
                // Aggiungi listener per mostrare/nascondere avviso quando cambia selezione
                const checkbox = checkboxItem.querySelector(`#operaio-${operaio.id}`);
                if (checkbox && inAltreSquadre) {
                    checkbox.addEventListener('change', function() {
                        const warningDiv = checkboxItem.querySelector(`#warning-operaio-${operaio.id}`);
                        if (warningDiv) {
                            if (this.checked) {
                                warningDiv.style.display = 'block';
                            } else {
                                // Nascondi solo se non √® selezionato E non √® gi√† in altre squadre
                                // (in realt√† lo lasciamo sempre visibile se √® in altre squadre)
                            }
                        }
                    });
                }
            });
        }

        // Chiudi modal
        window.closeSquadraModal = function() {
            document.getElementById('squadra-modal').classList.remove('active');
            currentSquadraId = null;
        };

        // Gestisci salvataggio squadra
        window.handleSalvaSquadra = async function(event) {
            event.preventDefault();
            
            const nome = document.getElementById('squadra-nome').value.trim();
            const caposquadraId = document.getElementById('squadra-caposquadra').value;
            const note = document.getElementById('squadra-note').value.trim();
            
            // Raccogli operai selezionati
            const operaiSelezionati = [];
            document.querySelectorAll('#operai-checkbox-group input[type="checkbox"]:checked').forEach(checkbox => {
                operaiSelezionati.push(checkbox.value);
            });
            
            if (!nome || nome.length < 3) {
                showAlert('Il nome squadra deve essere di almeno 3 caratteri', 'error');
                return;
            }
            
            if (!caposquadraId) {
                showAlert('Seleziona un caposquadra. Se non ci sono caposquadra disponibili, vai su "Gestisci Utenti" per assegnare il ruolo.', 'error');
                return;
            }
            
            // Avviso se non ci sono operai selezionati (ma non blocchiamo)
            if (operaiSelezionati.length === 0) {
                if (!confirm('Nessun operaio selezionato. Vuoi creare la squadra senza operai? Potrai aggiungerli successivamente modificando la squadra.')) {
                    return;
                }
            }
            
            try {
                const squadraData = {
                    nome,
                    caposquadraId,
                    operai: operaiSelezionati,
                    note: note || '',
                    creatoDa: currentUserData.id,
                    creatoIl: serverTimestamp(),
                    aggiornatoIl: serverTimestamp()
                };
                
                if (currentSquadraId) {
                    // Modifica squadra esistente
                    delete squadraData.creatoDa;
                    delete squadraData.creatoIl;
                    squadraData.aggiornatoIl = serverTimestamp();
                    
                    await updateDoc(doc(db, 'tenants', currentTenantId, 'squadre', currentSquadraId), squadraData);
                    showAlert('Squadra modificata con successo!', 'success');
                } else {
                    // Crea nuova squadra
                    await setDoc(doc(collection(db, 'tenants', currentTenantId, 'squadre')), squadraData);
                    showAlert('Squadra creata con successo!', 'success');
                }
                
                closeSquadraModal();
                await loadSquadre();
            } catch (error) {
                console.error('Errore salvataggio squadra:', error);
                showAlert(`Errore: ${error.message}`, 'error');
            }
        };

        // Apri modal elimina squadra
        window.openEliminaModal = async function(squadraId) {
            const squadra = squadreList.find(s => s.id === squadraId);
            
            if (!squadra) {
                showAlert('Squadra non trovata', 'error');
                return;
            }
            
            // Verifica se ci sono lavori attivi (quando avremo il modulo lavori)
            // Per ora, chiediamo solo conferma
            
            if (confirm(`Sei sicuro di voler eliminare la squadra "${squadra.nome}"?\n\nQuesta azione non pu√≤ essere annullata.`)) {
                try {
                    await deleteDoc(doc(db, 'tenants', currentTenantId, 'squadre', squadraId));
                    showAlert('Squadra eliminata con successo!', 'success');
                    await loadSquadre();
                } catch (error) {
                    console.error('Errore eliminazione squadra:', error);
                    showAlert(`Errore: ${error.message}`, 'error');
                }
            }
        };

        // Mostra alert
        function showAlert(message, type = 'info') {
            const container = document.getElementById('alert-container');
            const alertClass = `alert-${type}`;
            const alert = document.createElement('div');
            alert.className = `alert ${alertClass}`;
            alert.textContent = message;
            container.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>

