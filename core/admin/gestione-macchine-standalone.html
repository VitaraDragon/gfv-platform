<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Macchine - GFV Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #2E8B57 0%, #228B22 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .btn-primary:hover {
            background: rgba(255,255,255,0.3);
        }

        .modal .btn-primary {
            background: #2E8B57;
            color: white;
            border: none;
        }

        .modal .btn-primary:hover {
            background: #228B22;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }

        .content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 12px;
            font-weight: 600;
            color: #495057;
        }

        .filter-group select,
        .filter-group input {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-header h2 {
            color: #2E8B57;
            font-size: 24px;
        }

        .macchine-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .macchine-table th,
        .macchine-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .macchine-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            position: sticky;
            top: 0;
        }

        .macchine-table tr:hover {
            background: #f8f9fa;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .badge-secondary {
            background: #e2e3e5;
            color: #383d41;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 700px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: #2E8B57;
            font-size: 20px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .close-btn:hover {
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #2E8B57;
        }

        .form-group small {
            display: block;
            color: #666;
            font-size: 12px;
            margin-top: 5px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        @media (max-width: 768px) {
            .macchine-table {
                font-size: 12px;
            }

            .macchine-table th,
            .macchine-table td {
                padding: 8px;
            }

            .action-buttons {
                flex-direction: column;
            }

            .filters {
                flex-direction: column;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>üöú Gestione Macchine</h1>
                <p style="opacity: 0.9; margin-top: 5px;">Gestisci il parco macchine aziendale</p>
            </div>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="openMacchinaModal()">‚ûï Nuova Macchina</button>
                <a href="../dashboard-standalone.html" class="btn btn-secondary">‚Üê Dashboard</a>
            </div>
        </div>

        <div class="content">
            <div id="alert-container"></div>
            
            <div class="filters">
                <div class="filter-group">
                    <label>Filtra per Stato</label>
                    <select id="filter-stato">
                        <option value="tutti">Tutti</option>
                        <option value="disponibile">Disponibile</option>
                        <option value="in_uso">In uso</option>
                        <option value="in_manutenzione">In manutenzione</option>
                        <option value="guasto">Guasto</option>
                        <option value="dismesso">Dismesso</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Filtra per Tipo</label>
                    <select id="filter-tipo">
                        <option value="tutti">Tutti</option>
                        <option value="trattore">üöú Trattori</option>
                        <option value="attrezzo">‚öôÔ∏è Attrezzi</option>
                    </select>
                </div>
                <div class="filter-group" id="filter-categoria-group" style="display: none;">
                    <label>Filtra per Categoria</label>
                    <select id="filter-categoria">
                        <option value="tutte">Tutte le categorie</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Mostra solo Attive</label>
                    <select id="filter-attive">
                        <option value="false">Tutte</option>
                        <option value="true">Solo Attive</option>
                    </select>
                </div>
                <div class="filter-group" style="align-self: flex-end;">
                    <button class="btn btn-secondary" onclick="resetFilters()">Pulisci Filtri</button>
                </div>
            </div>

            <div class="section-header">
                <h2>Elenco Macchine</h2>
                <div id="macchine-count">0 macchine</div>
            </div>

            <div id="macchine-container">
                <div class="loading">Caricamento macchine...</div>
            </div>
        </div>
    </div>

    <!-- Modal Macchina -->
    <div id="macchina-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Nuova Macchina</h3>
                <button class="close-btn" onclick="closeMacchinaModal()">&times;</button>
            </div>
            <form id="macchina-form" onsubmit="handleSalvaMacchina(event)">
                <input type="hidden" id="macchina-id">
                
                <div class="form-group">
                    <label>Tipo Macchina *</label>
                    <div style="display: flex; gap: 20px; margin-top: 10px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="radio" name="tipo-macchina" value="trattore" id="tipo-trattore" required>
                            <span style="font-size: 24px;">üöú</span>
                            <span>Trattore</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="radio" name="tipo-macchina" value="attrezzo" id="tipo-attrezzo" required>
                            <span style="font-size: 24px;">‚öôÔ∏è</span>
                            <span>Attrezzo</span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="macchina-nome">Nome Macchina *</label>
                    <input type="text" id="macchina-nome" required placeholder="es. Trattore John Deere 6120">
                    <small>Nome identificativo della macchina</small>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="macchina-stato">Stato *</label>
                        <select id="macchina-stato" required>
                            <option value="disponibile">‚úÖ Disponibile</option>
                            <option value="in_uso">üîÑ In uso</option>
                            <option value="in_manutenzione">üîß In manutenzione</option>
                            <option value="guasto">‚ùå Guasto</option>
                            <option value="dismesso">üóëÔ∏è Dismesso</option>
                        </select>
                    </div>

                    <!-- Campo Cavalli (solo per Trattore) -->
                    <div class="form-group" id="campo-cavalli-group">
                        <label for="macchina-cavalli">Potenza (CV) *</label>
                        <input type="number" id="macchina-cavalli" step="0.1" min="1" max="1000" placeholder="es. 100">
                        <small>Potenza del trattore in cavalli</small>
                    </div>

                    <!-- Campo Categoria (solo per Attrezzo) -->
                    <div class="form-group" id="campo-categoria-group" style="display: none;">
                        <label for="macchina-categoria-principale">Categoria Principale *</label>
                        <div style="display: flex; gap: 5px;">
                            <select id="macchina-categoria-principale" style="flex: 1;">
                                <option value="">-- Seleziona categoria principale --</option>
                            </select>
                            <button type="button" class="btn btn-info btn-sm" onclick="openCategoriaModal()" style="white-space: nowrap;">‚ûï Nuova</button>
                        </div>
                        <small>Categoria funzionale principale dell'attrezzo</small>
                    </div>

                    <div class="form-group" id="campo-sottocategoria-group" style="display: none;">
                        <label for="macchina-sottocategoria">Sottocategoria</label>
                        <select id="macchina-sottocategoria">
                            <option value="">-- Nessuna sottocategoria --</option>
                        </select>
                        <small>Sottocategoria specifica (opzionale, se disponibile)</small>
                    </div>
                </div>

                <!-- Campo Cavalli Minimi (solo per Attrezzo) -->
                <div class="form-group" id="campo-cavalli-minimi-group" style="display: none;">
                    <label for="macchina-cavalli-minimi">Cavalli Minimi Richiesti (CV) *</label>
                    <input type="number" id="macchina-cavalli-minimi" step="0.1" min="1" max="1000" placeholder="es. 100">
                    <small>Potenza minima del trattore necessaria per utilizzare questo attrezzo</small>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="macchina-marca">Marca</label>
                        <input type="text" id="macchina-marca" placeholder="es. John Deere">
                    </div>

                    <div class="form-group">
                        <label for="macchina-modello">Modello</label>
                        <input type="text" id="macchina-modello" placeholder="es. 6120">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="macchina-targa">Targa/Numero Identificativo</label>
                        <input type="text" id="macchina-targa" placeholder="es. AB123CD">
                    </div>

                    <div class="form-group">
                        <label for="macchina-numero-telaio">Numero Telaio</label>
                        <input type="text" id="macchina-numero-telaio" placeholder="es. JD123456789">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="macchina-data-acquisto">Data Acquisto</label>
                        <input type="date" id="macchina-data-acquisto">
                    </div>

                    <div class="form-group">
                        <label for="macchina-ore-iniziali">Ore Iniziali</label>
                        <input type="number" id="macchina-ore-iniziali" step="0.1" min="0" value="0">
                        <small>Ore al momento dell'inserimento</small>
                    </div>
                </div>

                <div class="form-group">
                    <label for="macchina-ore-attuali">Ore Attuali</label>
                    <input type="number" id="macchina-ore-attuali" step="0.1" min="0">
                    <small>Ore attuali (se non specificate, usa ore iniziali)</small>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="macchina-prossima-manutenzione">Prossima Manutenzione (Data)</label>
                        <input type="date" id="macchina-prossima-manutenzione">
                    </div>

                    <div class="form-group">
                        <label for="macchina-ore-prossima-manutenzione">Prossima Manutenzione (Ore)</label>
                        <input type="number" id="macchina-ore-prossima-manutenzione" step="0.1" min="0" placeholder="es. 1000">
                        <small>Ore alla prossima manutenzione</small>
                    </div>
                </div>

                <div class="form-group">
                    <label for="macchina-note">Note</label>
                    <textarea id="macchina-note" placeholder="Note aggiuntive sulla macchina..."></textarea>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">Salva</button>
                    <button type="button" class="btn btn-secondary" onclick="closeMacchinaModal()">Annulla</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Categoria Attrezzo -->
    <div id="categoria-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Nuova Categoria Attrezzo</h3>
                <button class="close-btn" onclick="closeCategoriaModal()">&times;</button>
            </div>
            <form id="categoria-form" onsubmit="handleSalvaCategoria(event)">
                <div class="form-group">
                    <label for="categoria-nome">Nome Categoria *</label>
                    <input type="text" id="categoria-nome" required placeholder="es. Lavorazione del Terreno">
                    <small>Nome descrittivo della categoria</small>
                </div>

                <div class="form-group">
                    <label for="categoria-descrizione">Descrizione</label>
                    <textarea id="categoria-descrizione" placeholder="Descrizione opzionale della categoria..."></textarea>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">Salva</button>
                    <button type="button" class="btn btn-secondary" onclick="closeCategoriaModal()">Annulla</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Load Firebase config -->
    <script>
        const configScript = document.createElement('script');
        configScript.src = '../config/firebase-config.js';
        configScript.onerror = function() {
            const fallbackScript = document.createElement('script');
            fallbackScript.src = 'https://raw.githubusercontent.com/VitaraDragon/gfv-platform/main/core/config/firebase-config.js';
            document.head.appendChild(fallbackScript);
        };
        document.head.appendChild(configScript);
    </script>
    
    <!-- Funzioni stub per evitare errori prima del caricamento del modulo -->
    <script>
        window.openMacchinaModal = function(macchinaId) {
            console.log('Funzione non ancora caricata, attendere...');
        };
        window.closeMacchinaModal = function() {
            console.log('Funzione non ancora caricata, attendere...');
        };
        window.handleSalvaMacchina = function(e) {
            e.preventDefault();
            console.log('Funzione non ancora caricata, attendere...');
        };
        window.deleteMacchina = function(macchinaId) {
            console.log('Funzione non ancora caricata, attendere...');
        };
        window.resetFilters = function() {
            console.log('Funzione non ancora caricata, attendere...');
        };
        window.openCategoriaModal = function() {
            console.log('Funzione non ancora caricata, attendere...');
        };
        window.closeCategoriaModal = function() {
            console.log('Funzione non ancora caricata, attendere...');
        };
        window.handleSalvaCategoria = function(e) {
            e.preventDefault();
            console.log('Funzione non ancora caricata, attendere...');
        };
    </script>
    
    <!-- Firebase SDK -->
    <script type="module">
        function waitForConfig() {
            return new Promise((resolve, reject) => {
                if (typeof window.firebaseConfig !== 'undefined') {
                    resolve(window.firebaseConfig);
                    return;
                }
                
                let attempts = 0;
                const maxAttempts = 50;
                
                const checkInterval = setInterval(() => {
                    attempts++;
                    if (typeof window.firebaseConfig !== 'undefined') {
                        clearInterval(checkInterval);
                        resolve(window.firebaseConfig);
                    } else if (attempts >= maxAttempts) {
                        clearInterval(checkInterval);
                        reject(new Error('Firebase config not loaded after 5 seconds'));
                    }
                }, 100);
            });
        }

        const firebaseConfig = await waitForConfig();

        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, getDoc, doc, collection, getDocs, query, where, setDoc, addDoc, updateDoc, deleteDoc, Timestamp, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let currentTenantId = null;
        let macchine = [];
        let categorie = [];
        let categoriePrincipali = [];
        let sottocategorieMap = new Map(); // parentId -> Array<sottocategorie>

        // Dichiarazioni funzioni (da definire dopo)
        let openMacchinaModal, closeMacchinaModal, handleSalvaMacchina, deleteMacchina, resetFilters;
        let openCategoriaModal, closeCategoriaModal, handleSalvaCategoria;

        // Verifica autenticazione
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                try {
                    const userDoc = await getDoc(doc(db, 'users', user.uid));
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        currentTenantId = userData.tenantId;

                        // Verifica permessi (solo Manager o Amministratore)
                        const ruoli = userData.ruoli || [];
                        const isManager = ruoli.some(r => {
                            const roleLower = r.toLowerCase();
                            return roleLower.includes('manager') || roleLower.includes('amministratore');
                        });

                        if (!isManager) {
                            showAlert('Non hai i permessi per accedere a questa pagina', 'error');
                            setTimeout(() => {
                                window.location.href = '../dashboard-standalone.html';
                            }, 2000);
                            return;
                        }

                        // Verifica modulo Parco Macchine
                        if (currentTenantId) {
                            try {
                                const tenantDoc = await getDoc(doc(db, 'tenants', currentTenantId));
                                if (tenantDoc.exists()) {
                                    const tenantData = tenantDoc.data();
                                    const hasParcoMacchine = tenantData.modules && tenantData.modules.includes('parcoMacchine');
                                    if (!hasParcoMacchine) {
                                        showAlert('Questa pagina √® disponibile solo con il modulo Parco Macchine attivo.', 'error');
                                        setTimeout(() => {
                                            window.location.href = '../dashboard-standalone.html';
                                        }, 3000);
                                        return;
                                    }
                                }
                            } catch (error) {
                                console.warn('Errore verifica modulo:', error);
                            }
                        }

                        // Inizializza categorie predefinite se necessario
                        await initializeCategorie();
                        // Carica categorie
                        await loadCategorie();
                        // Setup filtri
                        setupFilters();
                        // Setup form dinamico
                        setupFormDinamico();
                        // Carica macchine
                        await loadMacchine();
                    } else {
                        window.location.href = '../auth/login-standalone.html';
                    }
                } catch (error) {
                    console.error('Errore:', error);
                    showAlert('Errore caricamento dati', 'error');
                }
            } else {
                window.location.href = '../auth/login-standalone.html';
            }
        });

        // Migra dati esistenti da categorieAttrezzi alla collezione unificata
        async function migraCategorieAttrezziEsistenti() {
            try {
                if (!currentTenantId) return;
                
                // Verifica se esistono categorie nella vecchia collezione
                const vecchiaCollezioneRef = collection(db, `tenants/${currentTenantId}/categorieAttrezzi`);
                const vecchiaSnapshot = await getDocs(vecchiaCollezioneRef);
                
                if (vecchiaSnapshot.empty) {
                    return; // Niente da migrare
                }
                
                // Verifica se la nuova collezione esiste gi√†
                const nuovaCollezioneRef = collection(db, `tenants/${currentTenantId}/categorie`);
                const nuovaSnapshot = await getDocs(nuovaCollezioneRef);
                
                if (!nuovaSnapshot.empty) {
                    // Gi√† migrato o inizializzato
                    return;
                }
                
                console.log(`Migrazione di ${vecchiaSnapshot.size} categorie attrezzi...`);
                
                // Migra ogni categoria
                for (const docSnap of vecchiaSnapshot.docs) {
                    const vecchiaData = docSnap.data();
                    
                    const nuovaCategoriaData = {
                        nome: vecchiaData.nome,
                        codice: vecchiaData.codice || vecchiaData.nome.toLowerCase().replace(/[^a-z0-9]+/g, '_'),
                        descrizione: vecchiaData.descrizione || null,
                        parentId: null, // Tutte le vecchie categorie sono principali
                        applicabileA: 'attrezzi', // Le vecchie categorie erano solo per attrezzi
                        predefinita: vecchiaData.predefinita || false,
                        ordine: null,
                        creatoDa: vecchiaData.creatoDa || 'system',
                        createdAt: vecchiaData.createdAt || serverTimestamp(),
                        updatedAt: serverTimestamp()
                    };
                    
                    await addDoc(nuovaCollezioneRef, nuovaCategoriaData);
                }
                
                console.log('Migrazione categorie attrezzi completata');
            } catch (error) {
                console.error('Errore migrazione categorie attrezzi:', error);
                // Non bloccare il caricamento se la migrazione fallisce
            }
        }

        // Inizializza categorie predefinite (usando servizio unificato)
        async function initializeCategorie() {
            try {
                if (!currentTenantId) return;
                
                // Migra prima i dati esistenti
                await migraCategorieAttrezziEsistenti();
                
                // Usa codice inline per evitare problemi CORS
                const categorieRef = collection(db, `tenants/${currentTenantId}/categorie`);
                const snapshot = await getDocs(categorieRef);
                
                // Verifica quali categorie predefinite esistono gi√† (per codice)
                const codiciEsistenti = new Set();
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.codice) {
                        codiciEsistenti.add(data.codice);
                    }
                });
                
                // Categorie principali predefinite per attrezzi
                const categoriePrincipaliPredefinite = [
                    { nome: 'Lavorazione del Terreno', codice: 'lavorazione_terreno', descrizione: 'Aratura, erpicatura, fresatura, vangatura, ecc.', applicabileA: 'entrambi', predefinita: true, ordine: 1 },
                    { nome: 'Trattamenti', codice: 'trattamenti', descrizione: 'Fitofarmaci, concimazione, irrigazione, ecc.', applicabileA: 'entrambi', predefinita: true, ordine: 2 },
                    { nome: 'Potatura', codice: 'potatura', descrizione: 'Potatura manuale e meccanica', applicabileA: 'entrambi', predefinita: true, ordine: 3 },
                    { nome: 'Raccolta', codice: 'raccolta', descrizione: 'Raccolta frutta, raccolta verdura, vendemmia, ecc.', applicabileA: 'entrambi', predefinita: true, ordine: 4 },
                    { nome: 'Gestione del Verde', codice: 'gestione_verde', descrizione: 'Falciatura, taglio erba, manutenzione estetica, ecc.', applicabileA: 'entrambi', predefinita: true, ordine: 5 },
                    { nome: 'Diserbo', codice: 'diserbo', descrizione: 'Eliminazione delle erbe infestanti', applicabileA: 'entrambi', predefinita: true, ordine: 6 },
                    { nome: 'Semina e Piantagione', codice: 'semina_piantagione', descrizione: 'Semina, trapianto, piantagione, ecc.', applicabileA: 'entrambi', predefinita: true, ordine: 7 },
                    { nome: 'Trasporto', codice: 'trasporto', descrizione: 'Rimorchi, carri, carrelli, ecc.', applicabileA: 'attrezzi', predefinita: true, ordine: 8 },
                    { nome: 'Altro', codice: 'altro', descrizione: 'Altri tipi non categorizzabili', applicabileA: 'entrambi', predefinita: true, ordine: 10 }
                ];
                
                const categorieMap = new Map(); // codice -> id
                
                // Crea solo le categorie principali predefinite mancanti
                for (const cat of categoriePrincipaliPredefinite) {
                    if (!codiciEsistenti.has(cat.codice)) {
                        const docRef = await addDoc(categorieRef, {
                            ...cat,
                            parentId: null,
                            creatoDa: 'system',
                            createdAt: Timestamp.now(),
                            updatedAt: Timestamp.now()
                        });
                        categorieMap.set(cat.codice, docRef.id);
                        codiciEsistenti.add(cat.codice);
                    } else {
                        // Trova l'ID della categoria esistente
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            if (data.codice === cat.codice) {
                                categorieMap.set(cat.codice, doc.id);
                            }
                        });
                    }
                }
                
                // Crea sottocategorie predefinite mancanti
                const sottocategoriePredefinite = [
                    { nome: 'Generale', codice: 'lavorazione_terreno_generale', parentCodice: 'lavorazione_terreno', descrizione: 'Lavorazione standard per campi aperti', applicabileA: 'entrambi', predefinita: true, ordine: 1 },
                    { nome: 'Tra le File', codice: 'lavorazione_terreno_tra_file', parentCodice: 'lavorazione_terreno', descrizione: 'Lavorazione tra le file di frutteti/vigneti', applicabileA: 'entrambi', predefinita: true, ordine: 2 },
                    { nome: 'Sulla Fila', codice: 'lavorazione_terreno_sulla_fila', parentCodice: 'lavorazione_terreno', descrizione: 'Lavorazione sulla fila di frutteti/vigneti', applicabileA: 'entrambi', predefinita: true, ordine: 3 },
                    { nome: 'Meccanica', codice: 'potatura_meccanica', parentCodice: 'potatura', descrizione: 'Potatura eseguita con attrezzi meccanici', applicabileA: 'attrezzi', predefinita: true, ordine: 2 }
                ];
                
                for (const sottocat of sottocategoriePredefinite) {
                    if (!codiciEsistenti.has(sottocat.codice)) {
                        const parentId = categorieMap.get(sottocat.parentCodice);
                        if (parentId) {
                            await addDoc(categorieRef, {
                                nome: sottocat.nome,
                                codice: sottocat.codice,
                                descrizione: sottocat.descrizione,
                                parentId: parentId,
                                applicabileA: sottocat.applicabileA,
                                predefinita: sottocat.predefinita,
                                ordine: sottocat.ordine,
                                creatoDa: 'system',
                                createdAt: Timestamp.now(),
                                updatedAt: Timestamp.now()
                            });
                            codiciEsistenti.add(sottocat.codice);
                        }
                    }
                }
            } catch (error) {
                console.error('Errore inizializzazione categorie:', error);
            }
        }

        // Carica categorie principali e sottocategorie
        async function loadCategorie() {
            try {
                if (!currentTenantId) return;
                
                const categorieRef = collection(db, `tenants/${currentTenantId}/categorie`);
                
                // Carica tutte le categorie
                const snapshot = await getDocs(query(categorieRef, orderBy('ordine', 'asc')));
                categoriePrincipali = [];
                sottocategorieMap.clear();
                
                snapshot.forEach(doc => {
                    const catData = { id: doc.id, ...doc.data() };
                    
                    // Filtra solo categorie applicabili ad attrezzi
                    if (catData.applicabileA === 'attrezzi' || catData.applicabileA === 'entrambi') {
                        if (!catData.parentId) {
                            // Categoria principale
                            categoriePrincipali.push(catData);
                        } else {
                            // Sottocategoria
                            if (!sottocategorieMap.has(catData.parentId)) {
                                sottocategorieMap.set(catData.parentId, []);
                            }
                            sottocategorieMap.get(catData.parentId).push(catData);
                        }
                    }
                });
                
                // Ordina sottocategorie per ordine
                sottocategorieMap.forEach((sottocat, parentId) => {
                    sottocat.sort((a, b) => (a.ordine || 0) - (b.ordine || 0));
                });
                
                // Popola dropdown categoria principale nel form
                const categoriaPrincipaleSelect = document.getElementById('macchina-categoria-principale');
                if (categoriaPrincipaleSelect) {
                    categoriaPrincipaleSelect.innerHTML = '<option value="">-- Seleziona categoria principale --</option>';
                    categoriePrincipali.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat.id;
                        option.textContent = cat.nome;
                        categoriaPrincipaleSelect.appendChild(option);
                    });
                }
                
                // Popola dropdown filtro categoria (include anche sottocategorie)
                const filterCategoriaSelect = document.getElementById('filter-categoria');
                if (filterCategoriaSelect) {
                    filterCategoriaSelect.innerHTML = '<option value="tutte">Tutte le categorie</option>';
                    categoriePrincipali.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat.id;
                        option.textContent = cat.nome;
                        filterCategoriaSelect.appendChild(option);
                        
                        // Aggiungi sottocategorie
                        const sottocat = sottocategorieMap.get(cat.id);
                        if (sottocat && sottocat.length > 0) {
                            sottocat.forEach(subcat => {
                                const subOption = document.createElement('option');
                                subOption.value = subcat.id;
                                subOption.textContent = `  ‚îî ${subcat.nome}`;
                                filterCategoriaSelect.appendChild(subOption);
                            });
                        }
                    });
                }
            } catch (error) {
                console.error('Errore caricamento categorie:', error);
            }
        }
        
        // Popola sottocategorie quando cambia categoria principale
        function populateSottocategorie(parentId, selectedValue = null) {
            const sottocategoriaSelect = document.getElementById('macchina-sottocategoria');
            const sottocategoriaGroup = document.getElementById('campo-sottocategoria-group');
            
            if (!sottocategoriaSelect || !sottocategoriaGroup) return;
            
            sottocategoriaSelect.innerHTML = '<option value="">-- Nessuna sottocategoria --</option>';
            
            if (!parentId) {
                sottocategoriaGroup.style.display = 'none';
                return;
            }
            
            const sottocat = sottocategorieMap.get(parentId);
            if (sottocat && sottocat.length > 0) {
                sottocategoriaGroup.style.display = 'block';
                sottocat.forEach(subcat => {
                    const option = document.createElement('option');
                    option.value = subcat.id;
                    option.textContent = subcat.nome;
                    if (selectedValue === subcat.id) {
                        option.selected = true;
                    }
                    sottocategoriaSelect.appendChild(option);
                });
            } else {
                sottocategoriaGroup.style.display = 'none';
            }
        }

        // Setup form dinamico (mostra/nascondi campi in base a trattore/attrezzo)
        function setupFormDinamico() {
            const tipoTrattore = document.getElementById('tipo-trattore');
            const tipoAttrezzo = document.getElementById('tipo-attrezzo');
            const campoCavalli = document.getElementById('campo-cavalli-group');
            const campoCategoria = document.getElementById('campo-categoria-group');
            const campoCavalliMinimi = document.getElementById('campo-cavalli-minimi-group');
            
            function updateFormFields() {
                const isTrattore = tipoTrattore.checked;
                const isAttrezzo = tipoAttrezzo.checked;
                
                // Mostra/nascondi campi
                if (campoCavalli) campoCavalli.style.display = isTrattore ? 'block' : 'none';
                if (campoCategoria) campoCategoria.style.display = isAttrezzo ? 'block' : 'none';
                if (campoCavalliMinimi) campoCavalliMinimi.style.display = isAttrezzo ? 'block' : 'none';
                
                // Aggiorna required
                const cavalliInput = document.getElementById('macchina-cavalli');
                const categoriaSelect = document.getElementById('macchina-categoria');
                const cavalliMinimiInput = document.getElementById('macchina-cavalli-minimi');
                
                if (cavalliInput) {
                    cavalliInput.required = isTrattore;
                    if (!isTrattore) cavalliInput.value = '';
                }
                if (categoriaSelect) {
                    categoriaSelect.required = isAttrezzo;
                    if (!isAttrezzo) categoriaSelect.value = '';
                }
                if (cavalliMinimiInput) {
                    cavalliMinimiInput.required = isAttrezzo;
                    if (!isAttrezzo) cavalliMinimiInput.value = '';
                }
            }
            
            if (tipoTrattore) tipoTrattore.addEventListener('change', updateFormFields);
            if (tipoAttrezzo) tipoAttrezzo.addEventListener('change', updateFormFields);
            
            // Event listener per cambio categoria principale (mostra sottocategorie)
            const categoriaPrincipaleSelect = document.getElementById('macchina-categoria-principale');
            if (categoriaPrincipaleSelect) {
                categoriaPrincipaleSelect.addEventListener('change', function() {
                    const categoriaPrincipaleId = this.value;
                    populateSottocategorie(categoriaPrincipaleId);
                });
            }
            
            // Aggiorna anche filtro categoria quando cambia tipo
            const filterTipo = document.getElementById('filter-tipo');
            if (filterTipo) {
                filterTipo.addEventListener('change', function() {
                    const filterCategoriaGroup = document.getElementById('filter-categoria-group');
                    if (filterCategoriaGroup) {
                        filterCategoriaGroup.style.display = this.value === 'attrezzo' ? 'block' : 'none';
                        if (this.value !== 'attrezzo') {
                            document.getElementById('filter-categoria').value = 'tutte';
                        }
                        filterMacchine();
                    }
                });
            }
        }

        // Reset filtri
        resetFilters = function() {
            document.getElementById('filter-stato').value = 'tutti';
            document.getElementById('filter-tipo').value = 'tutti';
            document.getElementById('filter-attive').value = 'false';
            document.getElementById('filter-categoria').value = 'tutte';
            document.getElementById('filter-categoria-group').style.display = 'none';
            filterMacchine();
        }

        // Carica macchine
        async function loadMacchine() {
            const container = document.getElementById('macchine-container');
            container.innerHTML = '<div class="loading">Caricamento macchine...</div>';

            try {
                if (!currentTenantId) {
                    container.innerHTML = '<div class="empty-state">Nessun tenant trovato</div>';
                    return;
                }

                const macchineRef = collection(db, `tenants/${currentTenantId}/macchine`);
                const snapshot = await getDocs(query(macchineRef, orderBy('nome')));
                macchine = [];

                snapshot.forEach(doc => {
                    const data = doc.data();
                    macchine.push({
                        id: doc.id,
                        ...data,
                        prossimaManutenzione: data.prossimaManutenzione || null,
                        dataAcquisto: data.dataAcquisto || null
                    });
                });

                filterMacchine();
            } catch (error) {
                console.error('Errore caricamento macchine:', error);
                showAlert('Errore caricamento macchine', 'error');
                container.innerHTML = '<div class="empty-state">Errore caricamento macchine</div>';
            }
        }

        // Formatta data
        function formattaData(data) {
            if (!data) return '-';
            const d = data.toDate ? data.toDate() : new Date(data);
            return d.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        // Verifica se manutenzione in scadenza
        function isManutenzioneInScadenza(macchina) {
            if (!macchina.prossimaManutenzione && (!macchina.oreProssimaManutenzione || macchina.oreProssimaManutenzione === null)) {
                return false;
            }

            // Verifica per data
            if (macchina.prossimaManutenzione) {
                const oggi = new Date();
                oggi.setHours(0, 0, 0, 0);
                const scadenza = macchina.prossimaManutenzione.toDate ? macchina.prossimaManutenzione.toDate() : new Date(macchina.prossimaManutenzione);
                scadenza.setHours(0, 0, 0, 0);
                const giorniRimanenti = Math.ceil((scadenza - oggi) / (1000 * 60 * 60 * 24));
                
                if (giorniRimanenti <= 30 && giorniRimanenti >= 0) {
                    return true;
                }
            }

            // Verifica per ore
            if (macchina.oreProssimaManutenzione !== null && macchina.oreAttuali !== null) {
                const oreRimanenti = macchina.oreProssimaManutenzione - macchina.oreAttuali;
                if (oreRimanenti <= 50 && oreRimanenti >= 0) {
                    return true;
                }
            }

            return false;
        }

        // Verifica se manutenzione scaduta
        function isManutenzioneScaduta(macchina) {
            if (!macchina.prossimaManutenzione && (!macchina.oreProssimaManutenzione || macchina.oreProssimaManutenzione === null)) {
                return false;
            }

            // Verifica per data
            if (macchina.prossimaManutenzione) {
                const oggi = new Date();
                oggi.setHours(0, 0, 0, 0);
                const scadenza = macchina.prossimaManutenzione.toDate ? macchina.prossimaManutenzione.toDate() : new Date(macchina.prossimaManutenzione);
                scadenza.setHours(0, 0, 0, 0);
                
                if (scadenza < oggi) {
                    return true;
                }
            }

            // Verifica per ore
            if (macchina.oreProssimaManutenzione !== null && macchina.oreAttuali !== null) {
                if (macchina.oreAttuali >= macchina.oreProssimaManutenzione) {
                    return true;
                }
            }

            return false;
        }

        // Filtra macchine
        function filterMacchine() {
            const filterStato = document.getElementById('filter-stato').value;
            const filterTipo = document.getElementById('filter-tipo').value;
            const filterAttive = document.getElementById('filter-attive').value === 'true';
            const filterCategoria = document.getElementById('filter-categoria').value;

            let filtered = macchine.filter(macchina => {
                // Filtro stato
                if (filterStato !== 'tutti' && macchina.stato !== filterStato) {
                    return false;
                }

                // Filtro tipo (supporta sia tipoMacchina che tipo per retrocompatibilit√†)
                if (filterTipo !== 'tutti') {
                    const tipoMacchina = macchina.tipoMacchina || macchina.tipo;
                    if (tipoMacchina !== filterTipo) {
                        return false;
                    }
                }

                // Filtro categoria (solo per attrezzi)
                if (filterCategoria && filterCategoria !== 'tutte') {
                    const tipoMacchina = macchina.tipoMacchina || macchina.tipo;
                    // Usa categoriaId se disponibile, altrimenti categoriaFunzione (retrocompatibilit√†)
                    const macchinaCategoriaId = macchina.categoriaId || macchina.categoriaFunzione;
                    if (tipoMacchina !== 'attrezzo' || macchinaCategoriaId !== filterCategoria) {
                        return false;
                    }
                }

                // Filtro solo attive
                if (filterAttive && macchina.stato === 'dismesso') {
                    return false;
                }

                return true;
            });

            renderMacchine(filtered);
        }

        // Render macchine
        function renderMacchine(macchineList) {
            const container = document.getElementById('macchine-container');
            document.getElementById('macchine-count').textContent = `${macchineList.length} macchine`;

            if (macchineList.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üöú</div><p>Nessuna macchina trovata</p></div>';
                return;
            }

            // Funzione helper per ottenere nome categoria (cerca in principali e sottocategorie)
            function getNomeCategoria(categoriaId) {
                if (!categoriaId) return '-';
                
                // Cerca in categorie principali
                const categoriaPrincipale = categoriePrincipali.find(c => c.id === categoriaId);
                if (categoriaPrincipale) return categoriaPrincipale.nome;
                
                // Cerca in sottocategorie
                for (const [parentId, sottocat] of sottocategorieMap.entries()) {
                    const sottocategoria = sottocat.find(c => c.id === categoriaId);
                    if (sottocategoria) {
                        const parent = categoriePrincipali.find(c => c.id === parentId);
                        return parent ? `${parent.nome} - ${sottocategoria.nome}` : sottocategoria.nome;
                    }
                }
                
                return '-';
            }
            
            // Funzione helper per verificare compatibilit√† attrezzo con trattori disponibili
            function getTrattoriCompatibili(attrezzo) {
                if (!attrezzo.cavalliMinimiRichiesti) return [];
                return macchine.filter(m => {
                    const tipoMacchina = m.tipoMacchina || m.tipo;
                    return tipoMacchina === 'trattore' && m.cavalli && m.cavalli >= attrezzo.cavalliMinimiRichiesti && m.stato !== 'dismesso';
                });
            }

            const statoNames = {
                'disponibile': '‚úÖ Disponibile',
                'in_uso': 'üîÑ In uso',
                'in_manutenzione': 'üîß In manutenzione',
                'guasto': '‚ùå Guasto',
                'dismesso': 'üóëÔ∏è Dismesso'
            };

            let html = `
                <table class="macchine-table">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Tipo</th>
                            <th>Marca/Modello</th>
                            <th>Dettagli</th>
                            <th>Stato</th>
                            <th>Ore</th>
                            <th>Prossima Manutenzione</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            macchineList.forEach(macchina => {
                const tipoMacchina = macchina.tipoMacchina || macchina.tipo || '';
                const oreUtilizzate = macchina.oreAttuali && macchina.oreIniziali 
                    ? (macchina.oreAttuali - macchina.oreIniziali).toFixed(1) 
                    : '-';
                const oreAttuali = macchina.oreAttuali !== null && macchina.oreAttuali !== undefined 
                    ? macchina.oreAttuali.toFixed(1) 
                    : '-';
                
                const manutenzioneScaduta = isManutenzioneScaduta(macchina);
                const manutenzioneInScadenza = isManutenzioneInScadenza(macchina);
                
                let manutenzioneBadge = '';
                if (manutenzioneScaduta) {
                    manutenzioneBadge = '<span class="badge badge-danger">‚ö†Ô∏è Scaduta</span>';
                } else if (manutenzioneInScadenza) {
                    manutenzioneBadge = '<span class="badge badge-warning">‚è∞ In scadenza</span>';
                }

                const marcaModello = [macchina.marca, macchina.modello].filter(Boolean).join(' ') || '-';
                
                // Dettagli specifici per tipo
                let dettagliHTML = '';
                if (tipoMacchina === 'trattore') {
                    dettagliHTML = macchina.cavalli ? `<strong>${macchina.cavalli} CV</strong>` : '-';
                } else if (tipoMacchina === 'attrezzo') {
                    // Usa categoriaId se disponibile, altrimenti categoriaFunzione (retrocompatibilit√†)
                    const macchinaCategoriaId = macchina.categoriaId || macchina.categoriaFunzione;
                    const categoriaNome = getNomeCategoria(macchinaCategoriaId);
                    const trattoriCompatibili = getTrattoriCompatibili(macchina);
                    dettagliHTML = `
                        <div><strong>Categoria:</strong> ${categoriaNome}</div>
                        <div><strong>CV min:</strong> ${macchina.cavalliMinimiRichiesti || '-'}</div>
                        ${trattoriCompatibili.length > 0 
                            ? `<div><small style="color: #28a745;">‚úÖ ${trattoriCompatibili.length} trattore/i compatibile/i</small></div>`
                            : `<div><small style="color: #dc3545;">‚ö†Ô∏è Nessun trattore compatibile</small></div>`
                        }
                    `;
                }
                
                const tipoIcon = tipoMacchina === 'trattore' ? 'üöú' : tipoMacchina === 'attrezzo' ? '‚öôÔ∏è' : '';
                const tipoLabel = tipoMacchina === 'trattore' ? 'Trattore' : tipoMacchina === 'attrezzo' ? 'Attrezzo' : tipoMacchina || '-';
                
                html += `
                    <tr>
                        <td><strong>${macchina.nome || '-'}</strong></td>
                        <td>${tipoIcon} ${tipoLabel}</td>
                        <td>${marcaModello}</td>
                        <td>${dettagliHTML}</td>
                        <td>${statoNames[macchina.stato] || macchina.stato || '-'}</td>
                        <td>
                            ${oreAttuali} ore
                            ${oreUtilizzate !== '-' ? `<br><small style="color: #666;">(${oreUtilizzate} utilizzate)</small>` : ''}
                        </td>
                        <td>
                            ${macchina.prossimaManutenzione ? formattaData(macchina.prossimaManutenzione) : '-'}
                            ${macchina.oreProssimaManutenzione ? `<br><small style="color: #666;">${macchina.oreProssimaManutenzione} ore</small>` : ''}
                            ${manutenzioneBadge}
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-info btn-sm" onclick="openMacchinaModal('${macchina.id}')">‚úèÔ∏è Modifica</button>
                                <button class="btn btn-danger btn-sm" onclick="deleteMacchina('${macchina.id}')">üóëÔ∏è Elimina</button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            container.innerHTML = html;
        }

        // Apri modal macchina
        openMacchinaModal = function(macchinaId = null) {
            document.getElementById('macchina-form').reset();
            document.getElementById('macchina-id').value = macchinaId || '';
            
            // Reset radio buttons
            document.getElementById('tipo-trattore').checked = false;
            document.getElementById('tipo-attrezzo').checked = false;

            if (macchinaId) {
                const macchina = macchine.find(m => m.id === macchinaId);
                if (!macchina) return;

                document.getElementById('modal-title').textContent = 'Modifica Macchina';
                
                const tipoMacchina = macchina.tipoMacchina || macchina.tipo || '';
                
                // Imposta tipo macchina
                if (tipoMacchina === 'trattore') {
                    document.getElementById('tipo-trattore').checked = true;
                } else if (tipoMacchina === 'attrezzo') {
                    document.getElementById('tipo-attrezzo').checked = true;
                }
                
                // Aggiorna campi dinamici
                setupFormDinamico();
                const updateFields = () => {
                    const tipoTrattore = document.getElementById('tipo-trattore');
                    const tipoAttrezzo = document.getElementById('tipo-attrezzo');
                    const campoCavalli = document.getElementById('campo-cavalli-group');
                    const campoCategoria = document.getElementById('campo-categoria-group');
                    const campoCavalliMinimi = document.getElementById('campo-cavalli-minimi-group');
                    
                    if (campoCavalli) campoCavalli.style.display = tipoTrattore.checked ? 'block' : 'none';
                    if (campoCategoria) campoCategoria.style.display = tipoAttrezzo.checked ? 'block' : 'none';
                    if (campoCavalliMinimi) campoCavalliMinimi.style.display = tipoAttrezzo.checked ? 'block' : 'none';
                };
                updateFields();
                
                document.getElementById('macchina-nome').value = macchina.nome || '';
                document.getElementById('macchina-stato').value = macchina.stato || 'disponibile';
                document.getElementById('macchina-marca').value = macchina.marca || '';
                document.getElementById('macchina-modello').value = macchina.modello || '';
                document.getElementById('macchina-targa').value = macchina.targa || '';
                document.getElementById('macchina-numero-telaio').value = macchina.numeroTelaio || '';
                
                // Campi trattore
                if (tipoMacchina === 'trattore') {
                    document.getElementById('macchina-cavalli').value = macchina.cavalli || '';
                }
                
                // Campi attrezzo
                if (tipoMacchina === 'attrezzo') {
                    // Usa categoriaId se disponibile, altrimenti categoriaFunzione (retrocompatibilit√†)
                    const categoriaId = macchina.categoriaId || macchina.categoriaFunzione;
                    
                    // Trova se √® una sottocategoria o categoria principale
                    let categoriaPrincipaleId = null;
                    let sottocategoriaId = null;
                    
                    // Cerca in tutte le categorie
                    const allCategorie = [...categoriePrincipali];
                    sottocategorieMap.forEach(sottocat => {
                        allCategorie.push(...sottocat);
                    });
                    
                    const categoriaTrovata = allCategorie.find(c => c.id === categoriaId);
                    if (categoriaTrovata) {
                        if (categoriaTrovata.parentId) {
                            // √à una sottocategoria
                            sottocategoriaId = categoriaTrovata.id;
                            categoriaPrincipaleId = categoriaTrovata.parentId;
                        } else {
                            // √à una categoria principale
                            categoriaPrincipaleId = categoriaTrovata.id;
                        }
                    }
                    
                    if (categoriaPrincipaleId) {
                        document.getElementById('macchina-categoria-principale').value = categoriaPrincipaleId;
                        populateSottocategorie(categoriaPrincipaleId, sottocategoriaId);
                    }
                    
                    document.getElementById('macchina-cavalli-minimi').value = macchina.cavalliMinimiRichiesti || '';
                }
                
                if (macchina.dataAcquisto) {
                    const dataAcquisto = macchina.dataAcquisto.toDate ? macchina.dataAcquisto.toDate() : new Date(macchina.dataAcquisto);
                    document.getElementById('macchina-data-acquisto').value = dataAcquisto.toISOString().split('T')[0];
                }
                
                document.getElementById('macchina-ore-iniziali').value = macchina.oreIniziali || 0;
                document.getElementById('macchina-ore-attuali').value = macchina.oreAttuali || '';
                
                if (macchina.prossimaManutenzione) {
                    const prossimaManutenzione = macchina.prossimaManutenzione.toDate ? macchina.prossimaManutenzione.toDate() : new Date(macchina.prossimaManutenzione);
                    document.getElementById('macchina-prossima-manutenzione').value = prossimaManutenzione.toISOString().split('T')[0];
                }
                
                document.getElementById('macchina-ore-prossima-manutenzione').value = macchina.oreProssimaManutenzione || '';
                document.getElementById('macchina-note').value = macchina.note || '';
            } else {
                document.getElementById('modal-title').textContent = 'Nuova Macchina';
                document.getElementById('macchina-ore-iniziali').value = 0;
            }

            document.getElementById('macchina-modal').classList.add('active');
        }

        // Chiudi modal macchina
        closeMacchinaModal = function() {
            document.getElementById('macchina-modal').classList.remove('active');
            document.getElementById('macchina-form').reset();
        }

        // Salva macchina
        handleSalvaMacchina = async function(e) {
            e.preventDefault();

            const macchinaId = document.getElementById('macchina-id').value;
            const nome = document.getElementById('macchina-nome').value.trim();
            const tipoTrattore = document.getElementById('tipo-trattore').checked;
            const tipoAttrezzo = document.getElementById('tipo-attrezzo').checked;
            const tipoMacchina = tipoTrattore ? 'trattore' : tipoAttrezzo ? 'attrezzo' : null;
            const stato = document.getElementById('macchina-stato').value;
            const marca = document.getElementById('macchina-marca').value.trim() || null;
            const modello = document.getElementById('macchina-modello').value.trim() || null;
            const targa = document.getElementById('macchina-targa').value.trim() || null;
            const numeroTelaio = document.getElementById('macchina-numero-telaio').value.trim() || null;
            const dataAcquisto = document.getElementById('macchina-data-acquisto').value || null;
            const oreIniziali = parseFloat(document.getElementById('macchina-ore-iniziali').value) || 0;
            const oreAttualiInput = document.getElementById('macchina-ore-attuali').value;
            const oreAttuali = oreAttualiInput ? parseFloat(oreAttualiInput) : oreIniziali;
            const prossimaManutenzione = document.getElementById('macchina-prossima-manutenzione').value || null;
            const oreProssimaManutenzioneInput = document.getElementById('macchina-ore-prossima-manutenzione').value;
            const oreProssimaManutenzione = oreProssimaManutenzioneInput ? parseFloat(oreProssimaManutenzioneInput) : null;
            const note = document.getElementById('macchina-note').value.trim() || null;

            // Validazione
            if (!nome || nome.length < 3) {
                showAlert('Il nome deve essere di almeno 3 caratteri', 'error');
                return;
            }

            if (!tipoMacchina) {
                showAlert('Seleziona un tipo macchina (Trattore o Attrezzo)', 'error');
                return;
            }

            // Validazioni specifiche trattore
            if (tipoMacchina === 'trattore') {
                const cavalli = parseFloat(document.getElementById('macchina-cavalli').value);
                if (!cavalli || cavalli <= 0) {
                    showAlert('Inserisci la potenza del trattore in CV (maggiore di 0)', 'error');
                    return;
                }
                if (cavalli > 1000) {
                    showAlert('I cavalli non possono superare 1000 CV', 'error');
                    return;
                }
            }

            // Validazioni specifiche attrezzo e preparazione categoriaId
            let categoriaId = null;
            if (tipoMacchina === 'attrezzo') {
                const categoriaPrincipaleId = document.getElementById('macchina-categoria-principale')?.value;
                const sottocategoriaId = document.getElementById('macchina-sottocategoria')?.value;
                
                if (!categoriaPrincipaleId) {
                    showAlert('Seleziona una categoria principale per l\'attrezzo', 'error');
                    return;
                }
                
                // Usa sottocategoria se selezionata, altrimenti categoria principale
                categoriaId = sottocategoriaId || categoriaPrincipaleId;
                
                const cavalliMinimiInput = document.getElementById('macchina-cavalli-minimi');
                if (!cavalliMinimiInput) {
                    showAlert('Campo cavalli minimi non trovato', 'error');
                    return;
                }
                const cavalliMinimi = parseFloat(cavalliMinimiInput.value);
                
                if (!cavalliMinimi || cavalliMinimi <= 0) {
                    showAlert('Inserisci i cavalli minimi richiesti (maggiore di 0)', 'error');
                    return;
                }
                if (cavalliMinimi > 1000) {
                    showAlert('I cavalli minimi richiesti non possono superare 1000 CV', 'error');
                    return;
                }
            }

            if (oreAttuali < oreIniziali) {
                showAlert('Le ore attuali non possono essere inferiori alle ore iniziali', 'error');
                return;
            }

            try {
                const macchinaData = {
                    nome,
                    tipoMacchina,
                    tipo: tipoMacchina, // Manteniamo anche tipo per retrocompatibilit√†
                    stato,
                    marca,
                    modello,
                    targa,
                    numeroTelaio,
                    dataAcquisto: dataAcquisto ? Timestamp.fromDate(new Date(dataAcquisto)) : null,
                    oreIniziali,
                    oreAttuali,
                    prossimaManutenzione: prossimaManutenzione ? Timestamp.fromDate(new Date(prossimaManutenzione)) : null,
                    oreProssimaManutenzione,
                    note,
                    creatoDa: currentUser.uid
                };
                
                // Campi specifici trattore
                if (tipoMacchina === 'trattore') {
                    macchinaData.cavalli = parseFloat(document.getElementById('macchina-cavalli').value);
                    macchinaData.categoriaId = null;
                    macchinaData.categoriaFunzione = null; // Mantenuto per retrocompatibilit√†
                    macchinaData.cavalliMinimiRichiesti = null;
                }
                
                // Campi specifici attrezzo
                if (tipoMacchina === 'attrezzo') {
                    macchinaData.categoriaId = categoriaId;
                    macchinaData.categoriaFunzione = categoriaId; // Mantenuto per retrocompatibilit√†
                    macchinaData.cavalliMinimiRichiesti = parseFloat(document.getElementById('macchina-cavalli-minimi').value);
                    macchinaData.cavalli = null;
                }

                if (macchinaId) {
                    // Aggiorna
                    const macchinaRef = doc(db, `tenants/${currentTenantId}/macchine`, macchinaId);
                    await updateDoc(macchinaRef, macchinaData);
                    showAlert('Macchina aggiornata con successo', 'success');
                } else {
                    // Crea nuova
                    macchinaData.createdAt = Timestamp.now();
                    macchinaData.updatedAt = Timestamp.now();
                    await addDoc(collection(db, `tenants/${currentTenantId}/macchine`), macchinaData);
                    showAlert('Macchina creata con successo', 'success');
                }

                closeMacchinaModal();
                await loadMacchine();
            } catch (error) {
                console.error('Errore salvataggio macchina:', error);
                showAlert('Errore salvataggio macchina: ' + error.message, 'error');
            }
        }

        // Elimina macchina
        deleteMacchina = async function(macchinaId) {
            if (!confirm('Sei sicuro di voler eliminare questa macchina?')) {
                return;
            }

            try {
                // Verifica se macchina √® usata in lavori
                const lavoriRef = collection(db, `tenants/${currentTenantId}/lavori`);
                const lavoriSnapshot = await getDocs(query(lavoriRef, where('macchinaId', '==', macchinaId)));
                
                if (!lavoriSnapshot.empty) {
                    if (!confirm(`Questa macchina √® utilizzata in ${lavoriSnapshot.size} lavoro/i. Vuoi eliminarla comunque?`)) {
                        return;
                    }
                }

                await deleteDoc(doc(db, `tenants/${currentTenantId}/macchine`, macchinaId));
                showAlert('Macchina eliminata con successo', 'success');
                await loadMacchine();
            } catch (error) {
                console.error('Errore eliminazione macchina:', error);
                showAlert('Errore eliminazione macchina: ' + error.message, 'error');
            }
        }

        // Mostra alert
        function showAlert(message, type) {
            const container = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.innerHTML = '';
            container.appendChild(alert);

            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        // Setup filtri (definita dopo loadCategorie per avere categorie disponibili)
        function setupFilters() {
            const filterStato = document.getElementById('filter-stato');
            const filterTipo = document.getElementById('filter-tipo');
            const filterAttive = document.getElementById('filter-attive');
            const filterCategoria = document.getElementById('filter-categoria');
            const filterCategoriaGroup = document.getElementById('filter-categoria-group');
            
            if (filterStato) filterStato.addEventListener('change', () => filterMacchine());
            if (filterAttive) filterAttive.addEventListener('change', () => filterMacchine());
            
            if (filterTipo) {
                filterTipo.addEventListener('change', () => {
                    if (filterCategoriaGroup) {
                        filterCategoriaGroup.style.display = filterTipo.value === 'attrezzo' ? 'block' : 'none';
                        if (filterTipo.value !== 'attrezzo' && filterCategoria) {
                            filterCategoria.value = 'tutte';
                        }
                    }
                    filterMacchine();
                });
            }
            
            if (filterCategoria) {
                filterCategoria.addEventListener('change', () => filterMacchine());
            }
        }

        // Apri modal categoria
        openCategoriaModal = function() {
            document.getElementById('categoria-form').reset();
            document.getElementById('categoria-modal').classList.add('active');
        }

        // Chiudi modal categoria
        closeCategoriaModal = function() {
            document.getElementById('categoria-modal').classList.remove('active');
            document.getElementById('categoria-form').reset();
        }

        // Salva categoria
        handleSalvaCategoria = async function(e) {
            e.preventDefault();

            const nome = document.getElementById('categoria-nome').value.trim();
            const descrizione = document.getElementById('categoria-descrizione').value.trim() || null;

            // Validazione
            if (!nome || nome.length < 3) {
                showAlert('Il nome categoria deve essere di almeno 3 caratteri', 'error');
                return;
            }

            try {
                // Genera codice dal nome
                const codice = nome
                    .toLowerCase()
                    .normalize('NFD')
                    .replace(/[\u0300-\u036f]/g, '')
                    .replace(/[^a-z0-9]+/g, '_')
                    .replace(/^_+|_+$/g, '');

                // Verifica che il codice non esista gi√†
                const categorieRef = collection(db, `tenants/${currentTenantId}/categorieAttrezzi`);
                const snapshot = await getDocs(query(categorieRef, where('codice', '==', codice)));
                
                if (!snapshot.empty) {
                    showAlert('Una categoria con questo nome esiste gi√†', 'error');
                    return;
                }

                const categoriaData = {
                    nome,
                    codice,
                    descrizione,
                    predefinita: false,
                    creatoDa: currentUser.uid,
                    createdAt: Timestamp.now(),
                    updatedAt: Timestamp.now()
                };

                await addDoc(categorieRef, categoriaData);
                showAlert('Categoria creata con successo', 'success');
                
                closeCategoriaModal();
                await loadCategorie();
                
                // Seleziona la nuova categoria nel form macchina
                const categoriaPrincipaleSelect = document.getElementById('macchina-categoria-principale');
                if (categoriaPrincipaleSelect) {
                    // Ricarica categorie per includere la nuova
                    await loadCategorie();
                    // Trova la categoria appena creata
                    const nuovaCategoria = categoriePrincipali.find(c => c.codice === codice);
                    if (nuovaCategoria) {
                        categoriaPrincipaleSelect.value = nuovaCategoria.id;
                        populateSottocategorie(nuovaCategoria.id);
                    }
                }
            } catch (error) {
                console.error('Errore salvataggio categoria:', error);
                showAlert('Errore salvataggio categoria: ' + error.message, 'error');
            }
        }

        // Export funzioni globali immediatamente
        window.openMacchinaModal = openMacchinaModal;
        window.closeMacchinaModal = closeMacchinaModal;
        window.handleSalvaMacchina = handleSalvaMacchina;
        window.deleteMacchina = deleteMacchina;
        window.resetFilters = resetFilters;
        window.openCategoriaModal = openCategoriaModal;
        window.closeCategoriaModal = closeCategoriaModal;
        window.handleSalvaCategoria = handleSalvaCategoria;
    </script>
</body>
</html>

