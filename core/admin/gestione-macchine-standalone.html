<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Macchine - GFV Platform</title>
    <link rel="stylesheet" href="https://unpkg.com/intro.js/minified/introjs.min.css">
    <link rel="stylesheet" href="../styles/tour.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #2E8B57 0%, #228B22 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .btn-primary:hover {
            background: rgba(255,255,255,0.3);
        }

        .modal .btn-primary {
            background: #2E8B57;
            color: white;
            border: none;
        }

        .modal .btn-primary:hover {
            background: #228B22;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }

        .content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Intro.js customizations */
        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 12px;
            font-weight: 600;
            color: #495057;
        }

        .filter-group select,
        .filter-group input {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-header h2 {
            color: #2E8B57;
            font-size: 24px;
        }

        .macchine-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .macchine-table th,
        .macchine-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .macchine-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            position: sticky;
            top: 0;
        }

        .macchine-table tr:hover {
            background: #f8f9fa;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .badge-secondary {
            background: #e2e3e5;
            color: #383d41;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 700px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: #2E8B57;
            font-size: 20px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .close-btn:hover {
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #2E8B57;
        }

        .form-group small {
            display: block;
            color: #666;
            font-size: 12px;
            margin-top: 5px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        @media (max-width: 768px) {
            .macchine-table {
                font-size: 12px;
            }

            .macchine-table th,
            .macchine-table td {
                padding: 8px;
            }

            .action-buttons {
                flex-direction: column;
            }

            .filters {
                flex-direction: column;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>🚜 Gestione Macchine</h1>
                <p style="opacity: 0.9; margin-top: 5px;">Gestisci il parco macchine aziendale</p>
            </div>
            <div class="header-actions">
                <a href="impostazioni-standalone.html" class="btn btn-primary" style="text-decoration: none; display: none; align-items: center; gap: 8px;" id="impostazioni-link">
                    <span>⚙️</span>
                    <span>Impostazioni</span>
                </a>
                <button class="btn btn-primary" id="macchine-tour-button" type="button">🧭 Tour</button>
                <button class="btn btn-primary" id="nuova-macchina-button" onclick="openMacchinaModal()">➕ Nuova Macchina</button>
                <a href="../dashboard-standalone.html" class="btn btn-secondary">← Dashboard</a>
            </div>
        </div>

        <div class="content">
            <div id="alert-container"></div>
            
            <div class="filters" data-tour-section="macchine-filters">
                <div class="filter-group">
                    <label>Filtra per Stato</label>
                    <select id="filter-stato">
                        <option value="tutti">Tutti</option>
                        <option value="disponibile">Disponibile</option>
                        <option value="in_uso">In uso</option>
                        <option value="in_manutenzione">In manutenzione</option>
                        <option value="guasto">Guasto</option>
                        <option value="dismesso">Dismesso</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Filtra per Tipo</label>
                    <select id="filter-tipo">
                        <option value="tutti">Tutti</option>
                        <option value="trattore">🚜 Trattori</option>
                        <option value="attrezzo">⚙️ Attrezzi</option>
                    </select>
                </div>
                <div class="filter-group" id="filter-categoria-group" style="display: none;">
                    <label>Filtra per Categoria</label>
                    <select id="filter-categoria">
                        <option value="tutte">Tutte le categorie</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Mostra solo Attive</label>
                    <select id="filter-attive">
                        <option value="false">Tutte</option>
                        <option value="true">Solo Attive</option>
                    </select>
                </div>
                <div class="filter-group" style="align-self: flex-end;">
                    <button class="btn btn-secondary" onclick="resetFilters()">Pulisci Filtri</button>
                </div>
            </div>

            <div class="section-header">
                <h2>Elenco Macchine</h2>
                <div id="macchine-count">0 macchine</div>
            </div>

            <div id="macchine-container" data-tour-section="macchine-list">
                <div class="loading">Caricamento macchine...</div>
            </div>
        </div>
    </div>

    <!-- Modal Macchina -->
    <div id="macchina-modal" class="modal">
        <div class="modal-content" data-tour-section="macchina-form">
            <div class="modal-header">
                <h3 id="modal-title">Nuova Macchina</h3>
                <button class="close-btn" onclick="closeMacchinaModal()">&times;</button>
            </div>
            <form id="macchina-form" onsubmit="handleSalvaMacchina(event)">
                <input type="hidden" id="macchina-id">
                
                <div class="form-group">
                    <label>Tipo Macchina *</label>
                    <div style="display: flex; gap: 20px; margin-top: 10px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="radio" name="tipo-macchina" value="trattore" id="tipo-trattore" required>
                            <span style="font-size: 24px;">🚜</span>
                            <span>Trattore</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="radio" name="tipo-macchina" value="attrezzo" id="tipo-attrezzo" required>
                            <span style="font-size: 24px;">⚙️</span>
                            <span>Attrezzo</span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="macchina-nome">Nome Macchina *</label>
                    <input type="text" id="macchina-nome" required placeholder="es. Trattore John Deere 6120">
                    <small>Nome identificativo della macchina</small>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="macchina-stato">Stato *</label>
                        <select id="macchina-stato" required>
                            <option value="disponibile">✅ Disponibile</option>
                            <option value="in_uso">🔄 In uso</option>
                            <option value="in_manutenzione">🔧 In manutenzione</option>
                            <option value="guasto">❌ Guasto</option>
                            <option value="dismesso">🗑️ Dismesso</option>
                        </select>
                    </div>

                    <!-- Campo Cavalli (solo per Trattore) -->
                    <div class="form-group" id="campo-cavalli-group">
                        <label for="macchina-cavalli">Potenza (CV) *</label>
                        <input type="number" id="macchina-cavalli" step="0.1" min="1" max="1000" placeholder="es. 100">
                        <small>Potenza del trattore in cavalli</small>
                    </div>

                    <!-- Campo Categoria (solo per Attrezzo) -->
                    <div class="form-group" id="campo-categoria-group" style="display: none;">
                        <label for="macchina-categoria-principale">Categoria Principale *</label>
                        <div style="display: flex; gap: 5px;">
                            <select id="macchina-categoria-principale" style="flex: 1;">
                                <option value="">-- Seleziona categoria principale --</option>
                            </select>
                            <button type="button" class="btn btn-info btn-sm" onclick="openCategoriaModal()" style="white-space: nowrap;">➕ Nuova</button>
                        </div>
                        <small>Categoria funzionale principale dell'attrezzo</small>
                    </div>

                    <div class="form-group" id="campo-sottocategoria-group" style="display: none;">
                        <label for="macchina-sottocategoria">Sottocategoria</label>
                        <select id="macchina-sottocategoria">
                            <option value="">-- Nessuna sottocategoria --</option>
                        </select>
                        <small>Sottocategoria specifica (opzionale, se disponibile)</small>
                    </div>
                </div>

                <!-- Campo Cavalli Minimi (solo per Attrezzo) -->
                <div class="form-group" id="campo-cavalli-minimi-group" style="display: none;">
                    <label for="macchina-cavalli-minimi">Cavalli Minimi Richiesti (CV) *</label>
                    <input type="number" id="macchina-cavalli-minimi" step="0.1" min="1" max="1000" placeholder="es. 100">
                    <small>Potenza minima del trattore necessaria per utilizzare questo attrezzo</small>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="macchina-marca">Marca</label>
                        <input type="text" id="macchina-marca" placeholder="es. John Deere">
                    </div>

                    <div class="form-group">
                        <label for="macchina-modello">Modello</label>
                        <input type="text" id="macchina-modello" placeholder="es. 6120">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="macchina-targa">Targa/Numero Identificativo</label>
                        <input type="text" id="macchina-targa" placeholder="es. AB123CD">
                    </div>

                    <div class="form-group">
                        <label for="macchina-numero-telaio">Numero Telaio</label>
                        <input type="text" id="macchina-numero-telaio" placeholder="es. JD123456789">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="macchina-data-acquisto">Data Acquisto</label>
                        <input type="date" id="macchina-data-acquisto">
                    </div>

                    <div class="form-group">
                        <label for="macchina-ore-iniziali">Ore Iniziali</label>
                        <input type="number" id="macchina-ore-iniziali" step="0.1" min="0" value="0">
                        <small>Ore al momento dell'inserimento</small>
                    </div>
                </div>

                <div class="form-group">
                    <label for="macchina-ore-attuali">Ore Attuali</label>
                    <input type="number" id="macchina-ore-attuali" step="0.1" min="0">
                    <small>Ore attuali (se non specificate, usa ore iniziali)</small>
                </div>

                <div class="form-group">
                    <label for="macchina-costo-ora">Costo Orario (€/h)</label>
                    <input type="number" id="macchina-costo-ora" step="0.01" min="0" placeholder="es. 25.50">
                    <small>Costo orario macchina per calcolo costi nei compensi (opzionale)</small>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="macchina-prossima-manutenzione">Prossima Manutenzione (Data)</label>
                        <input type="date" id="macchina-prossima-manutenzione">
                    </div>

                    <div class="form-group">
                        <label for="macchina-ore-prossima-manutenzione">Prossima Manutenzione (Ore)</label>
                        <input type="number" id="macchina-ore-prossima-manutenzione" step="0.1" min="0" placeholder="es. 1000">
                        <small>Ore alla prossima manutenzione</small>
                    </div>
                </div>

                <div class="form-group">
                    <label for="macchina-note">Note</label>
                    <textarea id="macchina-note" placeholder="Note aggiuntive sulla macchina..."></textarea>
                </div>

                <!-- Storico Guasti (solo per macchine esistenti) -->
                <div id="storico-guasti-section" style="display: none; margin-top: 30px; padding-top: 20px; border-top: 2px solid #e0e0e0;">
                    <h4 style="margin-bottom: 15px; color: #333;">📋 Storico Guasti</h4>
                    <div id="storico-guasti-list" style="max-height: 300px; overflow-y: auto; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        <div style="text-align: center; padding: 20px; color: #666;">Caricamento storico guasti...</div>
                    </div>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">Salva</button>
                    <button type="button" class="btn btn-secondary" onclick="closeMacchinaModal()">Annulla</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Categoria Attrezzo -->
    <div id="categoria-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Nuova Categoria Attrezzo</h3>
                <button class="close-btn" onclick="closeCategoriaModal()">&times;</button>
            </div>
            <form id="categoria-form" onsubmit="handleSalvaCategoria(event)">
                <div class="form-group">
                    <label for="categoria-nome">Nome Categoria *</label>
                    <input type="text" id="categoria-nome" required placeholder="es. Lavorazione del Terreno">
                    <small>Nome descrittivo della categoria</small>
                </div>

                <div class="form-group">
                    <label for="categoria-descrizione">Descrizione</label>
                    <textarea id="categoria-descrizione" placeholder="Descrizione opzionale della categoria..."></textarea>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">Salva</button>
                    <button type="button" class="btn btn-secondary" onclick="closeCategoriaModal()">Annulla</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Load Firebase config -->
    <script>
        const configScript = document.createElement('script');
        configScript.src = '../config/firebase-config.js';
        configScript.onerror = function() {
            const fallbackScript = document.createElement('script');
            fallbackScript.src = 'https://raw.githubusercontent.com/VitaraDragon/gfv-platform/main/core/config/firebase-config.js';
            document.head.appendChild(fallbackScript);
        };
        document.head.appendChild(configScript);
    </script>
    
    <!-- Funzioni stub per evitare errori prima del caricamento del modulo -->
    <script>
        window.openMacchinaModal = function(macchinaId) {

        };
        window.closeMacchinaModal = function() {

        };
        window.handleSalvaMacchina = function(e) {
            e.preventDefault();

        };
        window.deleteMacchina = function(macchinaId) {

        };
        window.resetFilters = function() {

        };
        window.openCategoriaModal = function() {

        };
        window.closeCategoriaModal = function() {

        };
        window.handleSalvaCategoria = function(e) {
            e.preventDefault();

        };
    </script>
    
    <script src="https://unpkg.com/intro.js/minified/intro.min.js"></script>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, getDoc, doc, collection, getDocs, query, where, setDoc, addDoc, updateDoc, deleteDoc, Timestamp, orderBy, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // ============================================
        // IMPORTS MODULI
        // ============================================
        import { showAlert, formattaData, isManutenzioneInScadenza, isManutenzioneScaduta, escapeHtml } from './js/gestione-macchine-utils.js';
        import { 
            migraCategorieAttrezziEsistenti as migraCategorieAttrezziEsistentiModule,
            initializeCategorie as initializeCategorieModule,
            loadCategorie as loadCategorieModule,
            populateSottocategorie as populateSottocategorieModule,
            setupMacchineRealtime as setupMacchineRealtimeModule,
            loadMacchine as loadMacchineModule,
            filterMacchine as filterMacchineModule,
            renderMacchine as renderMacchineModule
        } from './js/gestione-macchine-controller.js';
        import {
            setupFormDinamico as setupFormDinamicoModule,
            setupFilters as setupFiltersModule,
            resetFilters as resetFiltersModule,
            openMacchinaModal as openMacchinaModalModule,
            closeMacchinaModal as closeMacchinaModalModule,
            handleSalvaMacchina as handleSalvaMacchinaModule,
            deleteMacchina as deleteMacchinaModule,
            openCategoriaModal as openCategoriaModalModule,
            closeCategoriaModal as closeCategoriaModalModule,
            handleSalvaCategoria as handleSalvaCategoriaModule,
            loadStoricoGuasti as loadStoricoGuastiModule
        } from './js/gestione-macchine-events.js';
        import {
            setupMacchineTourButton as setupMacchineTourButtonModule,
            maybeAutoStartMacchineTour as maybeAutoStartMacchineTourModule,
            startMacchineTour as startMacchineTourModule
        } from './js/gestione-macchine-tour.js';

        function waitForConfig() {
            return new Promise((resolve, reject) => {
                if (typeof window.firebaseConfig !== 'undefined') {
                    resolve(window.firebaseConfig);
                    return;
                }
                
                let attempts = 0;
                const maxAttempts = 50;
                
                const checkInterval = setInterval(() => {
                    attempts++;
                    if (typeof window.firebaseConfig !== 'undefined') {
                        clearInterval(checkInterval);
                        resolve(window.firebaseConfig);
                    } else if (attempts >= maxAttempts) {
                        clearInterval(checkInterval);
                        reject(new Error('Firebase config not loaded after 5 seconds'));
                    }
                }, 100);
            });
        }

        const firebaseConfig = await waitForConfig();

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let currentTenantId = null;
        
        // ============================================
        // VARIABILI GLOBALI (per compatibilità)
        // ============================================
        let macchine = [];
        let categorie = [];
        let categoriePrincipali = [];
        let sottocategorieMap = new Map();
        let macchineUnsubscribe = null;
        let usersMap = new Map();
        
        // ============================================
        // STATE OBJECT
        // ============================================
        const macchineState = {
            macchine: [],
            categorie: [],
            categoriePrincipali: [],
            sottocategorieMap: new Map(), // parentId -> Array<sottocategorie>
            macchineUnsubscribe: null, // Per gestire il listener real-time
            usersMap: new Map(), // Mappa utenti per storico guasti
            macchineTourAutoRequested: false
        };
        
        // ============================================
        // FUNZIONE UPDATE STATE
        // ============================================
        function updateState(updates) {
            Object.assign(macchineState, updates);
            // Aggiorna anche variabili globali per compatibilità
            macchine = macchineState.macchine;
            categorie = macchineState.categorie;
            categoriePrincipali = macchineState.categoriePrincipali;
            sottocategorieMap = macchineState.sottocategorieMap;
            macchineUnsubscribe = macchineState.macchineUnsubscribe;
            usersMap = macchineState.usersMap;
        }
        
        // ============================================
        // DEPENDENCIES OBJECT
        // ============================================
        const dependencies = {
            db,
            auth,
            getDoc,
            doc,
            collection,
            getDocs,
            query,
            where,
            setDoc,
            addDoc,
            updateDoc,
            deleteDoc,
            Timestamp,
            orderBy,
            onSnapshot
        };
        
        // ============================================
        // WRAPPER FUNCTIONS
        // ============================================
        
        // Wrapper per migraCategorieAttrezziEsistenti
        async function migraCategorieAttrezziEsistentiWrapper() {
            return await migraCategorieAttrezziEsistentiModule(currentTenantId, dependencies);
        }
        
        // Wrapper per initializeCategorie
        async function initializeCategorieWrapper() {
            return await initializeCategorieModule(currentTenantId, dependencies, migraCategorieAttrezziEsistentiWrapper);
        }
        
        // Wrapper per loadCategorie
        async function loadCategorieWrapper() {
            return await loadCategorieModule(currentTenantId, dependencies, macchineState, updateState);
        }
        
        // Wrapper per populateSottocategorie
        function populateSottocategorieWrapper(parentId, selectedValue = null) {
            return populateSottocategorieModule(parentId, selectedValue, macchineState);
        }
        
        // Wrapper per setupMacchineRealtime
        async function setupMacchineRealtimeWrapper() {
            const unsubscribe = await setupMacchineRealtimeModule(
                currentTenantId,
                dependencies,
                macchineState,
                updateState,
                filterMacchineWrapper,
                showAlert
            );
            if (unsubscribe) {
                updateState({ macchineUnsubscribe: unsubscribe });
            }
        }
        
        // Wrapper per loadMacchine
        async function loadMacchineWrapper() {
            return await loadMacchineModule(setupMacchineRealtimeWrapper, macchineState);
        }
        
        // Wrapper per filterMacchine
        function filterMacchineWrapper() {
            return filterMacchineModule(macchineState, renderMacchineWrapper);
        }
        
        // Wrapper per renderMacchine
        function renderMacchineWrapper(macchineList) {
            return renderMacchineModule(macchineList, macchineState, maybeAutoStartMacchineTourWrapper);
        }
        
        // Wrapper per setupFormDinamico
        function setupFormDinamicoWrapper() {
            return setupFormDinamicoModule(populateSottocategorieWrapper, filterMacchineWrapper);
        }
        
        // Wrapper per setupFilters
        function setupFiltersWrapper() {
            return setupFiltersModule(filterMacchineWrapper);
        }
        
        // Wrapper per resetFilters
        function resetFiltersWrapper() {
            return resetFiltersModule(filterMacchineWrapper);
        }
        
        // Wrapper per openMacchinaModal
        async function openMacchinaModalWrapper(macchinaId = null) {
            return await openMacchinaModalModule(
                macchinaId,
                macchineState,
                setupFormDinamicoWrapper,
                populateSottocategorieWrapper,
                loadStoricoGuastiWrapper
            );
        }
        
        // Wrapper per closeMacchinaModal
        function closeMacchinaModalWrapper() {
            return closeMacchinaModalModule();
        }
        
        // Wrapper per handleSalvaMacchina
        async function handleSalvaMacchinaWrapper(e) {
            return await handleSalvaMacchinaModule(
                e,
                currentTenantId,
                currentUser.uid,
                dependencies,
                showAlert,
                closeMacchinaModalWrapper
            );
        }
        
        // Wrapper per deleteMacchina
        async function deleteMacchinaWrapper(macchinaId) {
            return await deleteMacchinaModule(macchinaId, currentTenantId, dependencies, showAlert);
        }
        
        // Wrapper per openCategoriaModal
        function openCategoriaModalWrapper() {
            return openCategoriaModalModule();
        }
        
        // Wrapper per closeCategoriaModal
        function closeCategoriaModalWrapper() {
            return closeCategoriaModalModule();
        }
        
        // Wrapper per handleSalvaCategoria
        async function handleSalvaCategoriaWrapper(e) {
            return await handleSalvaCategoriaModule(
                e,
                currentTenantId,
                currentUser.uid,
                dependencies,
                macchineState,
                showAlert,
                closeCategoriaModalWrapper,
                loadCategorieWrapper,
                populateSottocategorieWrapper
            );
        }
        
        // Wrapper per loadStoricoGuasti
        async function loadStoricoGuastiWrapper(macchinaId) {
            return await loadStoricoGuastiModule(macchinaId, currentTenantId, dependencies, macchineState, updateState);
        }
        
        // Wrapper per setupMacchineTourButton
        function setupMacchineTourButtonWrapper() {
            return setupMacchineTourButtonModule(startMacchineTourWrapper);
        }
        
        // Wrapper per maybeAutoStartMacchineTour
        function maybeAutoStartMacchineTourWrapper() {
            return maybeAutoStartMacchineTourModule(startMacchineTourWrapper, macchineState, updateState);
        }
        
        // Wrapper per startMacchineTour
        function startMacchineTourWrapper(triggeredManually) {
            return startMacchineTourModule(triggeredManually, closeMacchinaModalWrapper, openMacchinaModalWrapper);
        }
        
        // Esposizione su window per attributi HTML
        window.openMacchinaModal = openMacchinaModalWrapper;
        window.closeMacchinaModal = closeMacchinaModalWrapper;
        window.handleSalvaMacchina = handleSalvaMacchinaWrapper;
        window.deleteMacchina = deleteMacchinaWrapper;
        window.resetFilters = resetFiltersWrapper;
        window.openCategoriaModal = openCategoriaModalWrapper;
        window.closeCategoriaModal = closeCategoriaModalWrapper;
        window.handleSalvaCategoria = handleSalvaCategoriaWrapper;
        
        // Setup tour button
        setupMacchineTourButtonWrapper();

        // Verifica autenticazione
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                try {
                    const userDoc = await getDoc(doc(db, 'users', user.uid));
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        currentTenantId = userData.tenantId;

                        // Verifica permessi (solo Manager o Amministratore)
                        const ruoli = userData.ruoli || [];
                        const isManager = ruoli.some(r => {
                            const roleLower = r.toLowerCase();
                            return roleLower.includes('manager') || roleLower.includes('amministratore');
                        });

                        if (!isManager) {
                            showAlert('Non hai i permessi per accedere a questa pagina', 'error');
                            setTimeout(() => {
                                window.location.href = '../dashboard-standalone.html';
                            }, 2000);
                            return;
                        }
                        
                        // Mostra link impostazioni (solo Manager/Amministratore, già verificato sopra)
                        const impostazioniLink = document.getElementById('impostazioni-link');
                        if (impostazioniLink) {
                            impostazioniLink.style.display = 'inline-flex';
                        }

                        // Verifica modulo Parco Macchine
                        if (currentTenantId) {
                            try {
                                const tenantDoc = await getDoc(doc(db, 'tenants', currentTenantId));
                                if (tenantDoc.exists()) {
                                    const tenantData = tenantDoc.data();
                                    const hasParcoMacchine = tenantData.modules && tenantData.modules.includes('parcoMacchine');
                                    if (!hasParcoMacchine) {
                                        showAlert('Questa pagina è disponibile solo con il modulo Parco Macchine attivo.', 'error');
                                        setTimeout(() => {
                                            window.location.href = '../dashboard-standalone.html';
                                        }, 3000);
                                        return;
                                    }
                                }
                            } catch (error) {
                                console.warn('Errore verifica modulo:', error);
                            }
                        }

                        // Inizializza categorie predefinite se necessario
                        await initializeCategorieWrapper();
                        // Carica categorie
                        await loadCategorieWrapper();
                        // Setup filtri
                        setupFiltersWrapper();
                        // Setup form dinamico
                        setupFormDinamicoWrapper();
                        // Carica macchine con listener real-time
                        await setupMacchineRealtimeWrapper();
                    } else {
                        window.location.href = '../auth/login-standalone.html';
                    }
                } catch (error) {
                    console.error('Errore:', error);
                    showAlert('Errore caricamento dati', 'error');
                }
            } else {
                window.location.href = '../auth/login-standalone.html';
            }
        });

        // Funzioni migrate nei moduli:
        // - migraCategorieAttrezziEsistenti -> gestione-macchine-controller.js
        // - initializeCategorie -> gestione-macchine-controller.js
        // - loadCategorie -> gestione-macchine-controller.js
        // - populateSottocategorie -> gestione-macchine-controller.js

        // Funzione migrate nei moduli:
        // - setupFormDinamico -> gestione-macchine-events.js

        // Funzioni migrate nei moduli:
        // - resetFilters -> gestione-macchine-events.js
        // - setupMacchineRealtime -> gestione-macchine-controller.js
        // - loadMacchine -> gestione-macchine-controller.js
        // - formattaData -> gestione-macchine-utils.js
        // - isManutenzioneInScadenza -> gestione-macchine-utils.js
        // - isManutenzioneScaduta -> gestione-macchine-utils.js
        // - filterMacchine -> gestione-macchine-controller.js

        // Funzione migrate nei moduli:
        // - renderMacchine -> gestione-macchine-controller.js

        // Funzioni tour migrate nei moduli:
        // - setupMacchineTourButton -> gestione-macchine-tour.js
        // - maybeAutoStartMacchineTour -> gestione-macchine-tour.js
        // - startMacchineTour -> gestione-macchine-tour.js
        // - startMacchineTourWithSteps -> gestione-macchine-tour.js
        // - buildMacchineTourSteps -> gestione-macchine-tour.js

        // NOTA: startMacchineTourWithSteps e buildMacchineTourSteps sono funzioni interne del modulo tour
        // che vengono chiamate da startMacchineTour. Non sono esportate pubblicamente.

        // Funzioni migrate nei moduli:
        // - openMacchinaModal -> gestione-macchine-events.js
        // - loadStoricoGuasti -> gestione-macchine-events.js

        // NOTA: Le funzioni sono state estratte nei moduli. Usare i wrapper definiti sopra.
        // - closeMacchinaModal -> gestione-macchine-events.js
        // - handleSalvaMacchina -> gestione-macchine-events.js
        // - deleteMacchina -> gestione-macchine-events.js
        // - showAlert -> gestione-macchine-utils.js
        // - setupFilters -> gestione-macchine-events.js
        // - openCategoriaModal -> gestione-macchine-events.js
        // - closeCategoriaModal -> gestione-macchine-events.js
        // - handleSalvaCategoria -> gestione-macchine-events.js

        // Pulizia listener quando si chiude la pagina
        window.addEventListener('beforeunload', () => {
            if (macchineState.macchineUnsubscribe) {
                macchineState.macchineUnsubscribe();
                updateState({ macchineUnsubscribe: null });
            }
        });
    </script>
</body>
</html>

