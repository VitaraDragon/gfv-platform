<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Statistiche - GFV Platform</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#2E8B57">
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(180deg, #B0E0E6 0%, #228B22 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0px 8px 20px rgba(0, 0, 0, 0.15);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(180deg, #2E8B57 0%, #256E4A 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .user-info {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info span {
            font-size: 0.9em;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .btn-primary:hover {
            background: rgba(255,255,255,0.3);
        }

        .content {
            padding: 30px;
        }

        .filters {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 12px;
            font-weight: 600;
            color: #495057;
            margin: 0;
        }

        .filters input,
        .filters select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .filters input[type="date"] {
            min-width: 150px;
        }

        .filters select {
            min-width: 150px;
        }

        .filter-range {
            display: flex;
            align-items: flex-end;
            gap: 8px;
        }

        .filter-range-text {
            padding-bottom: 8px;
            font-size: 14px;
            color: #666;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        /* Metriche Cards */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: linear-gradient(135deg, #2E8B57 0%, #228B22 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
        }

        .metric-card.blue {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        }

        .metric-card.orange {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
        }

        .metric-card.purple {
            background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%);
        }

        .metric-value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .metric-label {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .metric-subtitle {
            font-size: 0.9em;
            opacity: 0.8;
            margin-top: 5px;
        }

        /* Grafici */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .chart-card h3 {
            color: #2E8B57;
            font-size: 1.3em;
            margin-bottom: 20px;
            text-align: center;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        .chart-container.tall {
            height: 400px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 3em;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }

            .metrics-grid {
                grid-template-columns: 1fr;
            }

            .user-info {
                position: static;
                justify-content: center;
                margin-top: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ“Š Statistiche e Dashboard</h1>
            <p>Analisi delle attivitÃ  e metriche aziendali</p>
            <div class="user-info">
                <span id="user-name">Caricamento...</span>
                <button class="btn btn-primary" onclick="window.location.href='dashboard-standalone.html'">Dashboard</button>
            </div>
        </div>

        <div class="content">
            <!-- Filtri -->
            <div class="filters">
                <div class="filter-group">
                    <label>Periodo</label>
                    <div class="filter-range">
                        <input type="date" id="filter-data-da" class="form-control">
                        <span class="filter-range-text">a</span>
                        <input type="date" id="filter-data-a" class="form-control">
                    </div>
                </div>
                <div class="filter-group">
                    <label>Terreno</label>
                    <select id="filter-terreno" class="form-control">
                        <option value="">Tutti i terreni</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Tipo Lavoro</label>
                    <select id="filter-tipo-lavoro" class="form-control">
                        <option value="">Tutti i tipi</option>
                    </select>
                </div>
                <div class="filter-group">
                    <button class="btn btn-secondary" onclick="applyFilters()">Applica Filtri</button>
                </div>
                <div class="filter-group">
                    <button class="btn btn-secondary" onclick="resetFilters()">Reset</button>
                </div>
            </div>

            <!-- Metriche -->
            <div class="metrics-grid">
                <div class="metric-card" style="background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);">
                    <div class="metric-value" id="metric-terreni">-</div>
                    <div class="metric-label">Terreni Totali</div>
                </div>
                <div class="metric-card blue">
                    <div class="metric-value" id="metric-ore">-</div>
                    <div class="metric-label">Ore Lavorate</div>
                    <div class="metric-subtitle" id="metric-ore-subtitle">Periodo selezionato</div>
                </div>
                <div class="metric-card orange">
                    <div class="metric-value" id="metric-attivita">-</div>
                    <div class="metric-label">AttivitÃ  Totali</div>
                    <div class="metric-subtitle" id="metric-attivita-subtitle">Periodo selezionato</div>
                </div>
                <div class="metric-card purple">
                    <div class="metric-value" id="metric-ore-mese">-</div>
                    <div class="metric-label">Ore/Mese (Media)</div>
                    <div class="metric-subtitle" id="metric-ore-mese-subtitle">Periodo selezionato</div>
                </div>
            </div>

            <!-- Grafici -->
            <div class="charts-grid">
                <div class="chart-card">
                    <h3>Ore per Tipo Lavoro</h3>
                    <div class="chart-container">
                        <canvas id="chart-ore-tipo"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>AttivitÃ  per Terreno</h3>
                    <div class="chart-container">
                        <canvas id="chart-attivita-terreno"></canvas>
                    </div>
                </div>
                <div class="chart-card" style="grid-column: 1 / -1;">
                    <h3>Ore Lavorate per Mese</h3>
                    <div class="chart-container tall">
                        <canvas id="chart-ore-mese"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>Top 5 Tipi Lavoro</h3>
                    <div class="chart-container">
                        <canvas id="chart-top-lavori"></canvas>
                    </div>
                </div>
            </div>

            <!-- Sezione Statistiche Terreni -->
            <div id="statistiche-terreni-section" style="margin-top: 50px; padding-top: 30px; border-top: 2px solid #e9ecef;">
                <h2 style="color: #2E8B57; font-size: 2em; margin-bottom: 30px; text-align: center;">ðŸŒ¾ Statistiche Terreni</h2>
                
                <!-- Metriche Terreni -->
                <div class="metrics-grid" style="margin-bottom: 40px;">
                    <div class="metric-card" style="background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white;">
                        <div class="metric-value" id="stat-terreni-totali" style="color: white;">-</div>
                        <div class="metric-label" style="color: rgba(255,255,255,0.9);">Terreni Totali</div>
                    </div>
                    <div class="metric-card" style="background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%); color: white;">
                        <div class="metric-value" id="stat-terreni-proprieta" style="color: white;">-</div>
                        <div class="metric-label" style="color: rgba(255,255,255,0.9);">Di ProprietÃ </div>
                    </div>
                    <div class="metric-card" style="background: linear-gradient(135deg, #17a2b8 0%, #117a8b 100%); color: white;">
                        <div class="metric-value" id="stat-terreni-affitto" style="color: white;">-</div>
                        <div class="metric-label" style="color: rgba(255,255,255,0.9);">In Affitto</div>
                    </div>
                    <div class="metric-card" style="background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white;">
                        <div class="metric-value" id="stat-superficie-totale" style="color: white;">-</div>
                        <div class="metric-label" style="color: rgba(255,255,255,0.9);">Superficie Totale (ha)</div>
                    </div>
                    <div class="metric-card" style="background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%); color: white;">
                        <div class="metric-value" id="stat-superficie-proprieta" style="color: white;">-</div>
                        <div class="metric-label" style="color: rgba(255,255,255,0.9);">Superficie ProprietÃ  (ha)</div>
                    </div>
                    <div class="metric-card" style="background: linear-gradient(135deg, #17a2b8 0%, #117a8b 100%); color: white;">
                        <div class="metric-value" id="stat-superficie-affitto" style="color: white;">-</div>
                        <div class="metric-label" style="color: rgba(255,255,255,0.9);">Superficie Affitto (ha)</div>
                    </div>
                    <div class="metric-card" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white;">
                        <div class="metric-value" id="stat-canone-mensile" style="color: white;">-</div>
                        <div class="metric-label" style="color: rgba(255,255,255,0.9);">Canone Mensile Totale</div>
                    </div>
                    <div class="metric-card" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white;">
                        <div class="metric-value" id="stat-canone-annuo" style="color: white;">-</div>
                        <div class="metric-label" style="color: rgba(255,255,255,0.9);">Canone Annuo Totale</div>
                    </div>
                </div>
                
                <!-- Grafici Terreni -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 40px;">
                    <div class="chart-card">
                        <h3>Distribuzione Terreni</h3>
                        <div class="chart-container">
                            <canvas id="chart-distribuzione-terreni"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3>Distribuzione Superficie</h3>
                        <div class="chart-container">
                            <canvas id="chart-distribuzione-superficie"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Affitti in Scadenza -->
                <div style="margin-top: 40px;">
                    <h3 style="color: #2E8B57; margin-bottom: 20px; text-align: center;">ðŸ“… Affitti in Scadenza</h3>
                    <div id="affitti-scadenza-lista" style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                        <div style="text-align: center; color: #666;">Caricamento...</div>
                    </div>
                </div>
            </div>

            <!-- Sezione Statistiche Macchine (solo se modulo Parco Macchine attivo) -->
            <div id="statistiche-macchine-section" style="display: none; margin-top: 40px; padding-top: 40px; border-top: 2px solid #e9ecef;">
                <h2 style="color: #2E8B57; font-size: 2em; margin-bottom: 30px; text-align: center;">ðŸšœ Statistiche Macchine</h2>
                
                <!-- Metriche Macchine -->
                <div class="metrics-grid">
                    <div class="metric-card" style="background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);">
                        <div class="metric-value" id="metric-ore-macchine-totali">-</div>
                        <div class="metric-label">Ore Macchine Totali</div>
                        <div class="metric-subtitle" id="metric-ore-macchine-subtitle">Periodo selezionato</div>
                    </div>
                    <div class="metric-card" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);">
                        <div class="metric-value" id="metric-macchine-utilizzate">-</div>
                        <div class="metric-label">Macchine Utilizzate</div>
                        <div class="metric-subtitle" id="metric-macchine-utilizzate-subtitle">Periodo selezionato</div>
                    </div>
                    <div class="metric-card" style="background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%);">
                        <div class="metric-value" id="metric-manutenzioni-scadenza">-</div>
                        <div class="metric-label">Manutenzioni in Scadenza</div>
                        <div class="metric-subtitle">Prossimi 30 giorni / 50 ore</div>
                    </div>
                    <div class="metric-card" style="background: linear-gradient(135deg, #e91e63 0%, #c2185b 100%);">
                        <div class="metric-value" id="metric-utilizzo-medio">-</div>
                        <div class="metric-label">Utilizzo Medio Macchina</div>
                        <div class="metric-subtitle" id="metric-utilizzo-medio-subtitle">Ore/macchina</div>
                    </div>
                </div>

                <!-- Grafici Macchine -->
                <div class="charts-grid">
                    <div class="chart-card">
                        <h3>Top 5 Macchine PiÃ¹ Utilizzate</h3>
                        <div class="chart-container">
                            <canvas id="chart-top-macchine"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3>Ore Macchina per Terreno</h3>
                        <div class="chart-container">
                            <canvas id="chart-ore-macchina-terreno"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3>Ore Macchina vs Ore Lavoratore</h3>
                        <div class="chart-container">
                            <canvas id="chart-ore-macchina-vs-lavoratore"></canvas>
                        </div>
                    </div>
                    <div class="chart-card" style="grid-column: 1 / -1;">
                        <h3>Ore Macchine per Mese</h3>
                        <div class="chart-container tall">
                            <canvas id="chart-ore-macchine-mese"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Load Firebase config from external file -->
    <!-- Fallback: usa raw GitHub se il file locale non Ã¨ disponibile (per GitHub Pages) -->
    <script>
        function loadConfig() {
            return new Promise((resolve, reject) => {
                if (typeof window.firebaseConfig !== 'undefined') {
                    resolve();
                    return;
                }

                const configScript = document.createElement('script');
                configScript.src = 'config/firebase-config.js';
                
                configScript.onload = function() {
                    setTimeout(() => {
                        if (typeof window.firebaseConfig !== 'undefined') {
                            resolve();
                        } else {
                            loadFallbackConfig().then(resolve).catch(reject);
                        }
                    }, 100);
                };
                
                configScript.onerror = function() {
                    loadFallbackConfig().then(resolve).catch(reject);
                };
                
                document.head.appendChild(configScript);
            });
        }

        function loadFallbackConfig() {
            return new Promise((resolve, reject) => {
                const fallbackScript = document.createElement('script');
                fallbackScript.src = 'https://raw.githubusercontent.com/VitaraDragon/gfv-platform/main/core/config/firebase-config.js';
                
                fallbackScript.onload = function() {
                    setTimeout(() => {
                        if (typeof window.firebaseConfig !== 'undefined') {
                            resolve();
                        } else {
                            reject(new Error('Firebase config not found even after loading from GitHub'));
                        }
                    }, 100);
                };
                
                fallbackScript.onerror = function() {
                    reject(new Error('Failed to load Firebase config from GitHub'));
                };
                
                document.head.appendChild(fallbackScript);
            });
        }

        loadConfig().catch(error => {
            console.error('Errore caricamento config:', error);
        });
    </script>
    
    <!-- Firebase SDK -->
    <script type="module">
        // ============================================
        // IMPORT MODULI (prima di tutto)
        // ============================================
        import {
            formatOre as formatOreUtil,
            formatMese as formatMeseUtil,
            escapeHtml as escapeHtmlUtil,
            calcolaAlertAffitto as calcolaAlertAffittoUtil,
            formattaDataScadenza as formattaDataScadenzaUtil
        } from './js/statistiche-utils.js';

        import {
            getTenantId as getTenantIdModule,
            getTerreniCollection as getTerreniCollectionModule,
            getAttivitaCollection as getAttivitaCollectionModule,
            getMacchineCollection as getMacchineCollectionModule,
            loadMacchine as loadMacchineModule,
            getAllTerreni as getAllTerreniModule,
            getAllAttivita as getAllAttivitaModule,
            getTotaleTerreni as getTotaleTerreniModule,
            getTotaleOre as getTotaleOreModule,
            getTotaleAttivita as getTotaleAttivitaModule,
            getOrePerTipoLavoro as getOrePerTipoLavoroModule,
            getAttivitaPerTerreno as getAttivitaPerTerrenoModule,
            getOrePerMese as getOrePerMeseModule,
            getTipiLavoroPiuFrequenti as getTipiLavoroPiuFrequentiModule,
            getOreMacchineTotali as getOreMacchineTotaliModule,
            getMacchinePiuUtilizzate as getMacchinePiuUtilizzateModule,
            getManutenzioniInScadenza as getManutenzioniInScadenzaModule,
            getOreMacchinaPerTerreno as getOreMacchinaPerTerrenoModule,
            getOreMacchinaVsLavoratore as getOreMacchinaVsLavoratoreModule,
            getOreMacchinePerMese as getOreMacchinePerMeseModule,
            loadStatistiche as loadStatisticheModule,
            loadStatisticheTerreni as loadStatisticheTerreniModule,
            loadStatisticheMacchine as loadStatisticheMacchineModule,
            loadFilters as loadFiltersModule
        } from './js/statistiche-controller.js';

        import {
            updateChartOreTipo as updateChartOreTipoModule,
            updateChartAttivitaTerreno as updateChartAttivitaTerrenoModule,
            updateChartOreMese as updateChartOreMeseModule,
            updateChartTopLavori as updateChartTopLavoriModule,
            updateChartTopMacchine as updateChartTopMacchineModule,
            updateChartOreMacchinaTerreno as updateChartOreMacchinaTerrenoModule,
            updateChartOreMacchinaVsLavoratore as updateChartOreMacchinaVsLavoratoreModule,
            updateChartOreMacchineMese as updateChartOreMacchineMeseModule,
            updateChartDistribuzioneTerreni as updateChartDistribuzioneTerreniModule,
            updateChartDistribuzioneSuperficie as updateChartDistribuzioneSuperficieModule
        } from './js/statistiche-charts.js';

        import {
            applyFilters as applyFiltersModule,
            resetFilters as resetFiltersModule,
            initApp as initAppModule
        } from './js/statistiche-events.js';

        // Attendi che lo script config sia caricato
        function waitForConfig() {
            return new Promise((resolve, reject) => {
                if (typeof window.firebaseConfig !== 'undefined') {
                    resolve(window.firebaseConfig);
                    return;
                }
                
                let attempts = 0;
                const maxAttempts = 50;
                
                const checkInterval = setInterval(() => {
                    attempts++;
                    if (typeof window.firebaseConfig !== 'undefined') {
                        clearInterval(checkInterval);
                        resolve(window.firebaseConfig);
                    } else if (attempts >= maxAttempts) {
                        clearInterval(checkInterval);
                        reject(new Error('Firebase config not loaded after 5 seconds'));
                    }
                }, 100);
            });
        }

        const firebaseConfig = await waitForConfig();

        const {
            initializeFirebase,
            getAuthInstance,
            getDb,
            getAppInstance,
            onAuthStateChanged,
            signOut,
            collection,
            doc,
            getDoc,
            getDocs,
            query,
            where,
            orderBy
        } = await import('./services/firebase-service.js');
        initializeFirebase(firebaseConfig);
        const app = getAppInstance();
        const auth = getAuthInstance();
        const db = getDb();

        // Variabili globali
        let currentTenantId = null;
        let hasParcoMacchineModule = false;
        let macchineList = [];

        // ============================================
        // STATE OBJECT
        // ============================================
        const statisticheState = {
            currentTenantId: null,
            hasParcoMacchineModule: false,
            macchineList: [],
            chartOreTipo: null,
            chartAttivitaTerreno: null,
            chartOreMese: null,
            chartTopLavori: null,
            chartTopMacchine: null,
            chartOreMacchinaTerreno: null,
            chartOreMacchinaVsLavoratore: null,
            chartOreMacchineMese: null
        };

        // Funzione updateState
        function updateState(updates) {
            Object.assign(statisticheState, updates);
            // Aggiorna variabili globali per compatibilitÃ 
            if (updates.currentTenantId !== undefined) currentTenantId = updates.currentTenantId;
            if (updates.hasParcoMacchineModule !== undefined) hasParcoMacchineModule = updates.hasParcoMacchineModule;
            if (updates.macchineList !== undefined) macchineList = updates.macchineList;
            if (updates.chartOreTipo !== undefined) window.chartOreTipo = updates.chartOreTipo;
            if (updates.chartAttivitaTerreno !== undefined) window.chartAttivitaTerreno = updates.chartAttivitaTerreno;
            if (updates.chartOreMese !== undefined) window.chartOreMese = updates.chartOreMese;
            if (updates.chartTopLavori !== undefined) window.chartTopLavori = updates.chartTopLavori;
            if (updates.chartTopMacchine !== undefined) window.chartTopMacchine = updates.chartTopMacchine;
            if (updates.chartOreMacchinaTerreno !== undefined) window.chartOreMacchinaTerreno = updates.chartOreMacchinaTerreno;
            if (updates.chartOreMacchinaVsLavoratore !== undefined) window.chartOreMacchinaVsLavoratore = updates.chartOreMacchinaVsLavoratore;
            if (updates.chartOreMacchineMese !== undefined) window.chartOreMacchineMese = updates.chartOreMacchineMese;
        }

        // Dependencies object
        const dependencies = {
            db,
            auth,
            app,
            collection,
            doc,
            getDoc,
            getDocs,
            query,
            where,
            orderBy
        };

        // Utils object
        const utils = {
            formatOre: formatOreUtil,
            formatMese: formatMeseUtil,
            escapeHtml: escapeHtmlUtil,
            calcolaAlertAffitto: calcolaAlertAffittoUtil,
            formattaDataScadenza: formattaDataScadenzaUtil
        };

        // ============================================
        // WRAPPER FUNCTIONS
        // ============================================

        // Helper functions
        async function getTenantIdWrapper(userId) {
            return await getTenantIdModule(userId, dependencies, currentTenantId);
        }

        function getTerreniCollectionWrapper(tenantId) {
            return getTerreniCollectionModule(tenantId, dependencies);
        }

        function getAttivitaCollectionWrapper(tenantId) {
            return getAttivitaCollectionModule(tenantId, dependencies);
        }

        function getMacchineCollectionWrapper(tenantId) {
            return getMacchineCollectionModule(tenantId, dependencies);
        }

        // Caricamento dati
        async function loadMacchineWrapper() {
            const result = await loadMacchineModule(
                currentTenantId,
                statisticheState,
                updateState,
                dependencies
            );
            return result;
        }

        async function getAllTerreniWrapper() {
            return await getAllTerreniModule(
                currentTenantId,
                dependencies,
                getTenantIdWrapper
            );
        }

        async function getAllAttivitaWrapper(filters = {}) {
            return await getAllAttivitaModule(
                currentTenantId,
                filters,
                dependencies,
                getTenantIdWrapper
            );
        }

        // Statistiche base
        async function getTotaleTerreniWrapper() {
            return await getTotaleTerreniModule(getAllTerreniWrapper);
        }

        async function getTotaleOreWrapper(periodo = {}) {
            return await getTotaleOreModule(periodo, getAllAttivitaWrapper);
        }

        async function getTotaleAttivitaWrapper(periodo = {}) {
            return await getTotaleAttivitaModule(periodo, getAllAttivitaWrapper);
        }

        async function getOrePerTipoLavoroWrapper(periodo = {}) {
            return await getOrePerTipoLavoroModule(periodo, getAllAttivitaWrapper);
        }

        async function getAttivitaPerTerrenoWrapper(periodo = {}) {
            return await getAttivitaPerTerrenoModule(periodo, getAllAttivitaWrapper);
        }

        async function getOrePerMeseWrapper(periodo = {}) {
            return await getOrePerMeseModule(periodo, getAllAttivitaWrapper);
        }

        async function getTipiLavoroPiuFrequentiWrapper(periodo = {}, limit = 5) {
            return await getTipiLavoroPiuFrequentiModule(periodo, limit, getAllAttivitaWrapper);
        }

        // Statistiche macchine
        async function getOreMacchineTotaliWrapper(periodo = {}) {
            return await getOreMacchineTotaliModule(
                periodo,
                hasParcoMacchineModule,
                currentTenantId,
                getAllAttivitaWrapper,
                dependencies
            );
        }

        async function getMacchinePiuUtilizzateWrapper(periodo = {}, limit = 5) {
            return await getMacchinePiuUtilizzateModule(
                periodo,
                limit,
                hasParcoMacchineModule,
                currentTenantId,
                macchineList,
                getAllAttivitaWrapper,
                loadMacchineWrapper,
                dependencies
            );
        }

        async function getManutenzioniInScadenzaWrapper() {
            return await getManutenzioniInScadenzaModule(hasParcoMacchineModule, macchineList);
        }

        async function getOreMacchinaPerTerrenoWrapper(periodo = {}) {
            return await getOreMacchinaPerTerrenoModule(
                periodo,
                hasParcoMacchineModule,
                currentTenantId,
                getAllAttivitaWrapper,
                dependencies
            );
        }

        async function getOreMacchinaVsLavoratoreWrapper(periodo = {}) {
            return await getOreMacchinaVsLavoratoreModule(
                periodo,
                hasParcoMacchineModule,
                getAllAttivitaWrapper
            );
        }

        async function getOreMacchinePerMeseWrapper(periodo = {}) {
            return await getOreMacchinePerMeseModule(
                periodo,
                hasParcoMacchineModule,
                currentTenantId,
                getAllAttivitaWrapper,
                dependencies
            );
        }

        // Charts
        function updateChartOreTipoWrapper(data) {
            updateChartOreTipoModule(data, statisticheState, updateState, utils.formatOre);
        }

        function updateChartAttivitaTerrenoWrapper(data) {
            updateChartAttivitaTerrenoModule(data, statisticheState, updateState);
        }

        function updateChartOreMeseWrapper(data) {
            updateChartOreMeseModule(data, statisticheState, updateState, utils.formatOre, utils.formatMese);
        }

        function updateChartTopLavoriWrapper(data) {
            updateChartTopLavoriModule(data, statisticheState, updateState);
        }

        function updateChartTopMacchineWrapper(data) {
            updateChartTopMacchineModule(data, statisticheState, updateState, utils.formatOre);
        }

        function updateChartOreMacchinaTerrenoWrapper(data) {
            updateChartOreMacchinaTerrenoModule(data, statisticheState, updateState, utils.formatOre);
        }

        function updateChartOreMacchinaVsLavoratoreWrapper(data) {
            updateChartOreMacchinaVsLavoratoreModule(data, statisticheState, updateState, utils.formatOre);
        }

        function updateChartOreMacchineMeseWrapper(data) {
            updateChartOreMacchineMeseModule(data, statisticheState, updateState, utils.formatOre, utils.formatMese);
        }

        function updateChartDistribuzioneTerreniWrapper(proprieta, affitto) {
            updateChartDistribuzioneTerreniModule(proprieta, affitto);
        }

        function updateChartDistribuzioneSuperficieWrapper(proprieta, affitto) {
            updateChartDistribuzioneSuperficieModule(proprieta, affitto);
        }

        // Caricamento statistiche
        async function loadStatisticheWrapper() {
            const callbacks = {
                getAllTerreni: getAllTerreniWrapper,
                getAllAttivita: getAllAttivitaWrapper,
                getTotaleTerreni: getTotaleTerreniWrapper,
                getTotaleOre: getTotaleOreWrapper,
                getTotaleAttivita: getTotaleAttivitaWrapper,
                getOrePerTipoLavoro: getOrePerTipoLavoroWrapper,
                getAttivitaPerTerreno: getAttivitaPerTerrenoWrapper,
                getOrePerMese: getOrePerMeseWrapper,
                getTipiLavoroPiuFrequenti: getTipiLavoroPiuFrequentiWrapper,
                loadStatisticheTerreni: loadStatisticheTerreniWrapper,
                loadStatisticheMacchine: loadStatisticheMacchineWrapper,
                updateChartOreTipo: updateChartOreTipoWrapper,
                updateChartAttivitaTerreno: updateChartAttivitaTerrenoWrapper,
                updateChartOreMese: updateChartOreMeseWrapper,
                updateChartTopLavori: updateChartTopLavoriWrapper
            };
            await loadStatisticheModule(
                currentTenantId,
                dependencies,
                callbacks,
                utils,
                hasParcoMacchineModule
            );
        }

        async function loadStatisticheTerreniWrapper() {
            await loadStatisticheTerreniModule(
                currentTenantId,
                dependencies,
                getAllTerreniWrapper,
                getTenantIdWrapper,
                utils,
                updateChartDistribuzioneTerreniWrapper,
                updateChartDistribuzioneSuperficieWrapper
            );
        }

        async function loadStatisticheMacchineWrapper(periodo = {}) {
            const callbacks = {
                getOreMacchineTotali: getOreMacchineTotaliWrapper,
                getMacchinePiuUtilizzate: getMacchinePiuUtilizzateWrapper,
                getManutenzioniInScadenza: getManutenzioniInScadenzaWrapper,
                getOreMacchinaPerTerreno: getOreMacchinaPerTerrenoWrapper,
                getOreMacchinaVsLavoratore: getOreMacchinaVsLavoratoreWrapper,
                getOreMacchinePerMese: getOreMacchinePerMeseWrapper,
                loadMacchine: loadMacchineWrapper,
                getAllAttivita: getAllAttivitaWrapper,
                updateChartTopMacchine: updateChartTopMacchineWrapper,
                updateChartOreMacchinaTerreno: updateChartOreMacchinaTerrenoWrapper,
                updateChartOreMacchinaVsLavoratore: updateChartOreMacchinaVsLavoratoreWrapper,
                updateChartOreMacchineMese: updateChartOreMacchineMeseWrapper
            };
            await loadStatisticheMacchineModule(
                periodo,
                hasParcoMacchineModule,
                currentTenantId,
                macchineList,
                dependencies,
                callbacks,
                utils
            );
        }

        async function loadFiltersWrapper() {
            await loadFiltersModule(
                currentTenantId,
                dependencies,
                getAllTerreniWrapper,
                getAllAttivitaWrapper,
                getTenantIdWrapper
            );
        }

        // Events
        window.applyFilters = function() {
            applyFiltersModule(loadStatisticheWrapper);
        };

        window.resetFilters = function() {
            resetFiltersModule(loadStatisticheWrapper);
        };

        async function initAppWrapper() {
            await initAppModule(loadFiltersWrapper, loadStatisticheWrapper);
        }

        // Funzioni helper e caricamento dati sono ora nei moduli
        // Le chiamate usano i wrapper definiti sopra
        // Funzione loadMacchine rimossa - ora in statistiche-controller.js, usa loadMacchineWrapper()

        // Verifica autenticazione
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = './auth/login-standalone.html';
                return;
            }

            try {
                // Carica dati utente e tenant
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    const nomeCompleto = `${userData.nome || ''} ${userData.cognome || ''}`.trim();
                    const email = userData.email || user.email;
                    document.getElementById('user-name').textContent = nomeCompleto || email || 'Utente';
                    
                    currentTenantId = userData.tenantId;
                    
                    // Imposta tenantId nel tenant-service per i servizi
                    try {
                        const { setCurrentTenantId } = await import('./services/tenant-service.js');
                        setCurrentTenantId(currentTenantId);
                    } catch (error) {
                        console.warn('Impossibile impostare tenantId nel servizio:', error);
                    }
                    
                    // Assicura che Firebase sia inizializzato nei servizi
                    try {
                        const { setFirebaseInstances } = await import('./services/firebase-service.js');
                        setFirebaseInstances({ app, db, auth });
                    } catch (error) {
                        console.warn('Impossibile impostare Firebase instances nel servizio:', error);
                    }
                    
                    // Verifica modulo Parco Macchine
                    try {
                        const tenantDoc = await getDoc(doc(db, 'tenants', currentTenantId));
                        if (tenantDoc.exists()) {
                            const tenantData = tenantDoc.data();
                            hasParcoMacchineModule = tenantData.modules && tenantData.modules.includes('parcoMacchine');
                            
                            // Mostra/nascondi sezione statistiche macchine
                            const macchineSection = document.getElementById('statistiche-macchine-section');
                            if (macchineSection) {
                                macchineSection.style.display = hasParcoMacchineModule ? 'block' : 'none';
                            }
                            
                            // Carica macchine se modulo attivo
                            if (hasParcoMacchineModule) {
                                await loadMacchineWrapper();
                            }
                        }
                    } catch (error) {
                        console.error('Errore verifica modulo Parco Macchine:', error);
                    }
                } else {
                    document.getElementById('user-name').textContent = user.email || 'Utente';
                }
            } catch (error) {
                console.error('Errore caricamento utente:', error);
                document.getElementById('user-name').textContent = user.email || 'Utente';
            }

            // Inizializza app
            await initAppWrapper();
        });

        // Funzioni statistiche sono ora nei moduli
        // Le chiamate usano i wrapper definiti sopra
        // Funzione getAllTerreni rimossa - usa getAllTerreniWrapper
        // Funzione getAllAttivita rimossa - usa getAllAttivitaWrapper

        // Funzione getAllAttivita rimossa - usa getAllAttivitaWrapper

        // Funzioni statistiche sono ora nei moduli - usa i wrapper
        // Funzioni formatOre, formatMese sono ora in statistiche-utils.js
        // Funzioni updateChart* sono ora in statistiche-charts.js
        // Variabili chart* sono gestite tramite state object

        // Funzioni updateChart* sono ora in statistiche-charts.js
        // Usa i wrapper definiti sopra (updateChartOreTipoWrapper, updateChartAttivitaTerrenoWrapper, ecc.)
        
        // Funzione updateChartOreTipo rimossa - usa updateChartOreTipoWrapper
        // Funzione updateChartAttivitaTerreno rimossa - usa updateChartAttivitaTerrenoWrapper
        // Funzione updateChartOreMese rimossa - usa updateChartOreMeseWrapper
        // Funzione updateChartTopLavori rimossa - usa updateChartTopLavoriWrapper
        // Funzioni updateChart* macchine rimosse - usa i wrapper corrispondenti
        // Funzioni updateChartDistribuzioneTerreni e updateChartDistribuzioneSuperficie rimosse - usa i wrapper

        // ============================================
        // FUNZIONI INLINE RIMOSSE - ORA NEI MODULI
        // ============================================
        // Tutte le funzioni seguenti sono state estratte nei moduli:
        // - statistiche-utils.js: formatOre, formatMese, escapeHtml, calcolaAlertAffitto, formattaDataScadenza
        // - statistiche-controller.js: getAllTerreni, getAllAttivita, getTotale*, getOre*, getAttivita*, getTipiLavoro*, 
        //   getOreMacchineTotali, getMacchinePiuUtilizzate, getManutenzioniInScadenza, getOreMacchinaPerTerreno,
        //   getOreMacchinaVsLavoratore, getOreMacchinePerMese, loadStatistiche, loadStatisticheTerreni, 
        //   loadStatisticheMacchine, loadFilters
        // - statistiche-charts.js: updateChartOreTipo, updateChartAttivitaTerreno, updateChartOreMese, updateChartTopLavori,
        //   updateChartTopMacchine, updateChartOreMacchinaTerreno, updateChartOreMacchinaVsLavoratore, 
        //   updateChartOreMacchineMese, updateChartDistribuzioneTerreni, updateChartDistribuzioneSuperficie
        // - statistiche-events.js: applyFilters, resetFilters, initApp
        // 
        // Le chiamate usano i wrapper definiti sopra

        // Funzione updateChartOreTipo_LEGACY_DO_NOT_USE rimossa completamente
        // Funzione getAllAttivita_LEGACY_DO_NOT_USE rimossa completamente
        // Tutte le funzioni updateChart* inline sono state rimosse - ora in statistiche-charts.js
        // Usa i wrapper definiti sopra

        // Funzioni updateChart* inline rimosse - ora in statistiche-charts.js
        // updateChartAttivitaTerreno, updateChartOreMese, updateChartTopLavori, 
        // updateChartTopMacchine, updateChartOreMacchinaTerreno, updateChartOreMacchinaVsLavoratore,
        // updateChartOreMacchineMese, updateChartDistribuzioneTerreni, updateChartDistribuzioneSuperficie
        // sono tutte nei moduli - usa i wrapper corrispondenti

        // Funzioni updateChart* inline rimosse - ora in statistiche-charts.js
        // Usa i wrapper definiti sopra

        // Funzione updateChartOreMese rimossa - usa updateChartOreMeseWrapper
        function updateChartOreMese_LEGACY_DO_NOT_USE(data) {
            // Trova sempre il container direttamente dal DOM
            let chartContainer = document.querySelector('.chart-card:has(canvas#chart-ore-mese)') || 
                                 document.querySelector('#chart-ore-mese')?.closest('.chart-card');
            
            // Se non trovato, cerca tra tutti i chart-card (fallback)
            if (!chartContainer) {
                const containers = document.querySelectorAll('.chart-card');
                // Il terzo chart-card dovrebbe essere quello delle ore per mese
                chartContainer = containers[2];
            }
            
            if (!chartContainer) {
                console.error('Container per chart-ore-mese non trovato');
                return;
            }
            
            let canvas = chartContainer.querySelector('canvas#chart-ore-mese');
            
            // Se il canvas non esiste o Ã¨ stato sostituito, ricrearlo
            if (!canvas || canvas.tagName !== 'CANVAS') {
                chartContainer.innerHTML = '<canvas id="chart-ore-mese"></canvas>';
                canvas = document.getElementById('chart-ore-mese');
            }
            
            if (chartOreMese) {
                chartOreMese.destroy();
            }
            
            if (data.length === 0) {
                chartContainer.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ðŸ“Š</div><p>Nessun dato disponibile</p></div>';
                return;
            }
            
            const ctx = canvas.getContext('2d');
            chartOreMese = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => formatMese(d.mese)),
                    datasets: [{
                        label: 'Ore Lavorate',
                        data: data.map(d => d.ore),
                        borderColor: '#2E8B57',
                        backgroundColor: 'rgba(46, 139, 87, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${formatOre(context.parsed.y)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatOre(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateChartTopLavori(data) {
            // Trova sempre il container direttamente dal DOM
            let chartContainer = document.querySelector('.chart-card:has(canvas#chart-top-lavori)') || 
                                 document.querySelector('#chart-top-lavori')?.closest('.chart-card');
            
            // Se non trovato, cerca tra tutti i chart-card (fallback)
            if (!chartContainer) {
                const containers = document.querySelectorAll('.chart-card');
                // Il quarto chart-card dovrebbe essere quello dei top lavori
                chartContainer = containers[3];
            }
            
            if (!chartContainer) {
                console.error('Container per chart-top-lavori non trovato');
                return;
            }
            
            let canvas = chartContainer.querySelector('canvas#chart-top-lavori');
            
            // Se il canvas non esiste o Ã¨ stato sostituito, ricrearlo
            if (!canvas || canvas.tagName !== 'CANVAS') {
                chartContainer.innerHTML = '<canvas id="chart-top-lavori"></canvas>';
                canvas = document.getElementById('chart-top-lavori');
            }
            
            if (chartTopLavori) {
                chartTopLavori.destroy();
            }
            
            if (data.length === 0) {
                chartContainer.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ðŸ“Š</div><p>Nessun dato disponibile</p></div>';
                return;
            }
            
            const ctx = canvas.getContext('2d');
            chartTopLavori = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.tipoLavoro),
                    datasets: [{
                        label: 'Frequenza',
                        data: data.map(d => d.frequenza),
                        backgroundColor: '#007bff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // Funzione loadStatistiche rimossa - ora in statistiche-controller.js
        // Usa loadStatisticheWrapper() definito sopra

        // Funzioni statistiche macchine
        async function getOreMacchineTotali(periodo = {}) {
            if (!hasParcoMacchineModule) return 0;
            
            try {
                const attivita = await getAllAttivitaWrapper(periodo);
                let totaleOre = 0;
                
                // Somma ore macchina da attivitÃ  Core Base
                attivita.forEach(att => {
                    if (att.oreMacchina && att.oreMacchina > 0) {
                        totaleOre += att.oreMacchina;
                    }
                });
                
                // Se modulo Manodopera attivo, aggiungi anche ore da lavori
                try {
                    const tenantDoc = await getDoc(doc(db, 'tenants', currentTenantId));
                    if (tenantDoc.exists()) {
                        const tenantData = tenantDoc.data();
                        const hasManodoperaModule = tenantData.modules && tenantData.modules.includes('manodopera');
                        
                        if (hasManodoperaModule) {
                            const lavoriRef = collection(db, 'tenants', currentTenantId, 'lavori');
                            const lavoriSnapshot = await getDocs(lavoriRef);
                            
                            for (const lavoroDoc of lavoriSnapshot.docs) {
                                const lavoro = lavoroDoc.data();
                                const lavoroId = lavoroDoc.id;
                                
                                // Filtra per periodo se necessario
                                if (periodo.dataDa || periodo.dataA) {
                                    const dataInizio = lavoro.dataInizio?.toDate ? lavoro.dataInizio.toDate() : new Date(lavoro.dataInizio);
                                    const dataInizioString = dataInizio.toISOString().split('T')[0];
                                    
                                    if (periodo.dataDa && dataInizioString < periodo.dataDa) continue;
                                    if (periodo.dataA && dataInizioString > periodo.dataA) continue;
                                }
                                
                                // Carica ore validate per questo lavoro
                                const oreRef = collection(db, 'tenants', currentTenantId, 'lavori', lavoroId, 'oreOperai');
                                const oreQuery = query(oreRef, where('stato', '==', 'validate'));
                                const oreSnapshot = await getDocs(oreQuery);
                                
                                oreSnapshot.forEach(oraDoc => {
                                    const ora = oraDoc.data();
                                    if (ora.oreMacchina && ora.oreMacchina > 0) {
                                        totaleOre += ora.oreMacchina;
                                    }
                                });
                            }
                        }
                    }
                } catch (error) {
                    console.warn('Errore caricamento ore macchine da Manodopera:', error);
                }
                
                return parseFloat(totaleOre.toFixed(2));
            } catch (error) {
                console.error('Errore calcolo ore macchine totali:', error);
                return 0;
            }
        }

        async function getMacchinePiuUtilizzate(periodo = {}, limit = 5) {
            if (!hasParcoMacchineModule) return [];
            
            try {
                const attivita = await getAllAttivitaWrapper(periodo);
                const orePerMacchina = {};
                
                // Conta ore per macchina da attivitÃ  Core Base
                attivita.forEach(att => {
                    if (att.macchinaId && att.oreMacchina && att.oreMacchina > 0) {
                        if (!orePerMacchina[att.macchinaId]) {
                            orePerMacchina[att.macchinaId] = 0;
                        }
                        orePerMacchina[att.macchinaId] += att.oreMacchina;
                    }
                    if (att.attrezzoId && att.oreMacchina && att.oreMacchina > 0) {
                        if (!orePerMacchina[att.attrezzoId]) {
                            orePerMacchina[att.attrezzoId] = 0;
                        }
                        orePerMacchina[att.attrezzoId] += att.oreMacchina;
                    }
                });
                
                // Se modulo Manodopera attivo, aggiungi anche ore da lavori
                try {
                    const tenantDoc = await getDoc(doc(db, 'tenants', currentTenantId));
                    if (tenantDoc.exists()) {
                        const tenantData = tenantDoc.data();
                        const hasManodoperaModule = tenantData.modules && tenantData.modules.includes('manodopera');
                        
                        if (hasManodoperaModule) {
                            const lavoriRef = collection(db, 'tenants', currentTenantId, 'lavori');
                            const lavoriSnapshot = await getDocs(lavoriRef);
                            
                            for (const lavoroDoc of lavoriSnapshot.docs) {
                                const lavoro = lavoroDoc.data();
                                const lavoroId = lavoroDoc.id;
                                
                                // Filtra per periodo se necessario
                                if (periodo.dataDa || periodo.dataA) {
                                    const dataInizio = lavoro.dataInizio?.toDate ? lavoro.dataInizio.toDate() : new Date(lavoro.dataInizio);
                                    const dataInizioString = dataInizio.toISOString().split('T')[0];
                                    
                                    if (periodo.dataDa && dataInizioString < periodo.dataDa) continue;
                                    if (periodo.dataA && dataInizioString > periodo.dataA) continue;
                                }
                                
                                // Carica ore validate per questo lavoro
                                const oreRef = collection(db, 'tenants', currentTenantId, 'lavori', lavoroId, 'oreOperai');
                                const oreQuery = query(oreRef, where('stato', '==', 'validate'));
                                const oreSnapshot = await getDocs(oreQuery);
                                
                                oreSnapshot.forEach(oraDoc => {
                                    const ora = oraDoc.data();
                                    if (ora.macchinaId && ora.oreMacchina && ora.oreMacchina > 0) {
                                        if (!orePerMacchina[ora.macchinaId]) {
                                            orePerMacchina[ora.macchinaId] = 0;
                                        }
                                        orePerMacchina[ora.macchinaId] += ora.oreMacchina;
                                    }
                                    if (ora.attrezzoId && ora.oreMacchina && ora.oreMacchina > 0) {
                                        if (!orePerMacchina[ora.attrezzoId]) {
                                            orePerMacchina[ora.attrezzoId] = 0;
                                        }
                                        orePerMacchina[ora.attrezzoId] += ora.oreMacchina;
                                    }
                                });
                            }
                        }
                    }
                } catch (error) {
                    console.warn('Errore caricamento ore macchine da Manodopera:', error);
                }
                
                // Assicurati che le macchine siano caricate
                if (macchineList.length === 0) {
                    await loadMacchine();
                }
                
                // Crea mappa macchine
                const macchineMap = {};
                macchineList.forEach(m => {
                    macchineMap[m.id] = m;
                });

                
                return Object.entries(orePerMacchina)
                    .map(([macchinaId, ore]) => {
                        const macchina = macchineMap[macchinaId];
                        if (!macchina) {
                            console.warn(`âš ï¸ Macchina ID "${macchinaId}" non trovata nella lista`);
                            console.warn(`  - ID cercato: "${macchinaId}"`);
                            console.warn(`  - ID disponibili:`, macchineList.map(m => `"${m.id}"`));
                        } else {

                        }
                        return {
                            macchinaId,
                            nome: macchina?.nome || `Macchina ${macchinaId.substring(0, 8)}...`,
                            tipo: macchina?.tipoMacchina || macchina?.tipo || 'macchina',
                            ore: parseFloat(ore.toFixed(2))
                        };
                    })
                    .sort((a, b) => b.ore - a.ore)
                    .slice(0, limit);
            } catch (error) {
                console.error('Errore calcolo macchine piÃ¹ utilizzate:', error);
                return [];
            }
        }

        async function getManutenzioniInScadenza() {
            if (!hasParcoMacchineModule) return 0;
            
            try {
                const oggi = new Date();
                oggi.setHours(0, 0, 0, 0);
                const tra30Giorni = new Date(oggi);
                tra30Giorni.setDate(tra30Giorni.getDate() + 30);
                
                let count = 0;
                
                macchineList.forEach(macchina => {
                    if (macchina.stato === 'dismesso') return;
                    
                    // Verifica per ore
                    if (macchina.oreProssimaManutenzione && macchina.oreAttuali) {
                        const oreRimanenti = macchina.oreProssimaManutenzione - macchina.oreAttuali;
                        if (oreRimanenti <= 50 && oreRimanenti > 0) {
                            count++;
                        }
                    }
                    
                    // Verifica per data
                    if (macchina.prossimaManutenzione) {
                        const scadenza = macchina.prossimaManutenzione.toDate 
                            ? macchina.prossimaManutenzione.toDate() 
                            : new Date(macchina.prossimaManutenzione);
                        scadenza.setHours(0, 0, 0, 0);
                        
                        if (scadenza >= oggi && scadenza <= tra30Giorni) {
                            count++;
                        }
                    }
                });
                
                return count;
            } catch (error) {
                console.error('Errore calcolo manutenzioni in scadenza:', error);
                return 0;
            }
        }

        async function getOreMacchinaPerTerreno(periodo = {}) {
            if (!hasParcoMacchineModule) return [];
            
            try {
                const attivita = await getAllAttivitaWrapper(periodo);
                const orePerTerreno = {};
                
                attivita.forEach(att => {
                    if (att.terrenoNome && att.oreMacchina && att.oreMacchina > 0) {
                        if (!orePerTerreno[att.terrenoNome]) {
                            orePerTerreno[att.terrenoNome] = 0;
                        }
                        orePerTerreno[att.terrenoNome] += att.oreMacchina;
                    }
                });
                
                // Se modulo Manodopera attivo, aggiungi anche ore da lavori
                try {
                    const tenantDoc = await getDoc(doc(db, 'tenants', currentTenantId));
                    if (tenantDoc.exists()) {
                        const tenantData = tenantDoc.data();
                        const hasManodoperaModule = tenantData.modules && tenantData.modules.includes('manodopera');
                        
                        if (hasManodoperaModule) {
                            const lavoriRef = collection(db, 'tenants', currentTenantId, 'lavori');
                            const lavoriSnapshot = await getDocs(lavoriRef);
                            
                            for (const lavoroDoc of lavoriSnapshot.docs) {
                                const lavoro = lavoroDoc.data();
                                const lavoroId = lavoroDoc.id;
                                
                                // Filtra per periodo se necessario
                                if (periodo.dataDa || periodo.dataA) {
                                    const dataInizio = lavoro.dataInizio?.toDate ? lavoro.dataInizio.toDate() : new Date(lavoro.dataInizio);
                                    const dataInizioString = dataInizio.toISOString().split('T')[0];
                                    
                                    if (periodo.dataDa && dataInizioString < periodo.dataDa) continue;
                                    if (periodo.dataA && dataInizioString > periodo.dataA) continue;
                                }
                                
                                // Carica terreno
                                const terrenoId = lavoro.terrenoId;
                                if (!terrenoId) continue;
                                
                                const terrenoDoc = await getDoc(doc(db, 'tenants', currentTenantId, 'terreni', terrenoId));
                                const terrenoNome = terrenoDoc.exists() ? terrenoDoc.data().nome : 'Terreno sconosciuto';
                                
                                // Carica ore validate per questo lavoro
                                const oreRef = collection(db, 'tenants', currentTenantId, 'lavori', lavoroId, 'oreOperai');
                                const oreQuery = query(oreRef, where('stato', '==', 'validate'));
                                const oreSnapshot = await getDocs(oreQuery);
                                
                                oreSnapshot.forEach(oraDoc => {
                                    const ora = oraDoc.data();
                                    if (ora.oreMacchina && ora.oreMacchina > 0) {
                                        if (!orePerTerreno[terrenoNome]) {
                                            orePerTerreno[terrenoNome] = 0;
                                        }
                                        orePerTerreno[terrenoNome] += ora.oreMacchina;
                                    }
                                });
                            }
                        }
                    }
                } catch (error) {
                    console.warn('Errore caricamento ore macchine da Manodopera:', error);
                }
                
                return Object.entries(orePerTerreno)
                    .map(([terrenoNome, ore]) => ({
                        terrenoNome,
                        ore: parseFloat(ore.toFixed(2))
                    }))
                    .sort((a, b) => b.ore - a.ore);
            } catch (error) {
                console.error('Errore calcolo ore macchina per terreno:', error);
                return [];
            }
        }

        async function getOreMacchinaVsLavoratore(periodo = {}) {
            if (!hasParcoMacchineModule) return { oreLavoratore: 0, oreMacchina: 0 };
            
            try {
                const attivita = await getAllAttivitaWrapper(periodo);
                let oreLavoratore = 0;
                let oreMacchina = 0;
                
                attivita.forEach(att => {
                    if (att.oreNette) oreLavoratore += att.oreNette;
                    if (att.oreMacchina) oreMacchina += att.oreMacchina;
                });
                
                return {
                    oreLavoratore: parseFloat(oreLavoratore.toFixed(2)),
                    oreMacchina: parseFloat(oreMacchina.toFixed(2))
                };
            } catch (error) {
                console.error('Errore calcolo ore macchina vs lavoratore:', error);
                return { oreLavoratore: 0, oreMacchina: 0 };
            }
        }

        async function getOreMacchinePerMese(periodo = {}) {
            if (!hasParcoMacchineModule) return [];
            
            try {
                const attivita = await getAllAttivitaWrapper(periodo);
                const orePerMese = {};
                
                attivita.forEach(att => {
                    if (!att.data || !att.oreMacchina) return;
                    const mese = att.data.substring(0, 7);
                    if (!orePerMese[mese]) {
                        orePerMese[mese] = 0;
                    }
                    orePerMese[mese] += att.oreMacchina;
                });
                
                // Se modulo Manodopera attivo, aggiungi anche ore da lavori
                try {
                    const tenantDoc = await getDoc(doc(db, 'tenants', currentTenantId));
                    if (tenantDoc.exists()) {
                        const tenantData = tenantDoc.data();
                        const hasManodoperaModule = tenantData.modules && tenantData.modules.includes('manodopera');
                        
                        if (hasManodoperaModule) {
                            const lavoriRef = collection(db, 'tenants', currentTenantId, 'lavori');
                            const lavoriSnapshot = await getDocs(lavoriRef);
                            
                            for (const lavoroDoc of lavoriSnapshot.docs) {
                                const lavoro = lavoroDoc.data();
                                const lavoroId = lavoroDoc.id;
                                
                                // Carica ore validate per questo lavoro
                                const oreRef = collection(db, 'tenants', currentTenantId, 'lavori', lavoroId, 'oreOperai');
                                const oreQuery = query(oreRef, where('stato', '==', 'validate'));
                                const oreSnapshot = await getDocs(oreQuery);
                                
                                oreSnapshot.forEach(oraDoc => {
                                    const ora = oraDoc.data();
                                    if (ora.data && ora.oreMacchina && ora.oreMacchina > 0) {
                                        const dataOra = ora.data.toDate ? ora.data.toDate() : new Date(ora.data);
                                        const mese = dataOra.toISOString().substring(0, 7);
                                        
                                        // Filtra per periodo se necessario
                                        if (periodo.dataDa && mese < periodo.dataDa.substring(0, 7)) return;
                                        if (periodo.dataA && mese > periodo.dataA.substring(0, 7)) return;
                                        
                                        if (!orePerMese[mese]) {
                                            orePerMese[mese] = 0;
                                        }
                                        orePerMese[mese] += ora.oreMacchina;
                                    }
                                });
                            }
                        }
                    }
                } catch (error) {
                    console.warn('Errore caricamento ore macchine da Manodopera:', error);
                }
                
                return Object.entries(orePerMese)
                    .map(([mese, ore]) => ({
                        mese,
                        ore: parseFloat(ore.toFixed(2))
                    }))
                    .sort((a, b) => a.mese.localeCompare(b.mese));
            } catch (error) {
                console.error('Errore calcolo ore macchine per mese:', error);
                return [];
            }
        }

        // Carica e aggiorna statistiche macchine
        async function loadStatisticheMacchine(periodo = {}) {
            try {
                // Assicurati che le macchine siano caricate
                if (macchineList.length === 0) {
                    await loadMacchine();
                }
                
                const [
                    oreMacchineTotali,
                    macchinePiuUtilizzate,
                    manutenzioniScadenza,
                    oreMacchinaPerTerreno,
                    oreMacchinaVsLavoratore,
                    oreMacchinePerMese
                ] = await Promise.all([
                    getOreMacchineTotali(periodo),
                    getMacchinePiuUtilizzate(periodo, 5),
                    getManutenzioniInScadenza(),
                    getOreMacchinaPerTerreno(periodo),
                    getOreMacchinaVsLavoratore(periodo),
                    getOreMacchinePerMese(periodo)
                ]);

                // Aggiorna metriche
                document.getElementById('metric-ore-macchine-totali').textContent = formatOre(oreMacchineTotali);
                document.getElementById('metric-macchine-utilizzate').textContent = macchinePiuUtilizzate.length;
                
                const macchineTotali = macchineList.filter(m => m.stato !== 'dismesso').length;
                const utilizzoMedio = macchineTotali > 0 ? (oreMacchineTotali / macchineTotali).toFixed(1) : 0;
                document.getElementById('metric-utilizzo-medio').textContent = formatOre(parseFloat(utilizzoMedio));
                document.getElementById('metric-manutenzioni-scadenza').textContent = manutenzioniScadenza;

                // Aggiorna sottotitoli
                const periodoText = periodo.dataDa && periodo.dataA ? `${periodo.dataDa} - ${periodo.dataA}` : 'Tutti i periodi';
                document.getElementById('metric-ore-macchine-subtitle').textContent = periodoText;
                document.getElementById('metric-macchine-utilizzate-subtitle').textContent = periodoText;

                // Aggiorna grafici
                updateChartTopMacchine(macchinePiuUtilizzate);
                updateChartOreMacchinaTerreno(oreMacchinaPerTerreno);
                updateChartOreMacchinaVsLavoratore(oreMacchinaVsLavoratore);
                updateChartOreMacchineMese(oreMacchinePerMese);
            } catch (error) {
                console.error('Errore caricamento statistiche macchine:', error);
            }
        }

        // Funzioni aggiornamento grafici macchine
        function updateChartTopMacchine(data) {
            const chartContainer = document.querySelector('#chart-top-macchine')?.closest('.chart-card');
            if (!chartContainer) return;
            
            let canvas = chartContainer.querySelector('canvas#chart-top-macchine');
            if (!canvas) {
                chartContainer.querySelector('.chart-container').innerHTML = '<canvas id="chart-top-macchine"></canvas>';
                canvas = document.getElementById('chart-top-macchine');
            }
            
            if (chartTopMacchine) chartTopMacchine.destroy();
            
            if (data.length === 0) {
                chartContainer.querySelector('.chart-container').innerHTML = '<div class="empty-state"><div class="empty-state-icon">ðŸšœ</div><p>Nessun dato disponibile</p></div>';
                return;
            }
            
            const ctx = canvas.getContext('2d');
            chartTopMacchine = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.nome),
                    datasets: [{
                        label: 'Ore Utilizzate',
                        data: data.map(d => d.ore),
                        backgroundColor: '#007bff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${formatOre(context.parsed.x)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatOre(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateChartOreMacchinaTerreno(data) {
            const chartContainer = document.querySelector('#chart-ore-macchina-terreno')?.closest('.chart-card');
            if (!chartContainer) return;
            
            let canvas = chartContainer.querySelector('canvas#chart-ore-macchina-terreno');
            if (!canvas) {
                chartContainer.querySelector('.chart-container').innerHTML = '<canvas id="chart-ore-macchina-terreno"></canvas>';
                canvas = document.getElementById('chart-ore-macchina-terreno');
            }
            
            if (chartOreMacchinaTerreno) chartOreMacchinaTerreno.destroy();
            
            if (data.length === 0) {
                chartContainer.querySelector('.chart-container').innerHTML = '<div class="empty-state"><div class="empty-state-icon">ðŸšœ</div><p>Nessun dato disponibile</p></div>';
                return;
            }
            
            const ctx = canvas.getContext('2d');
            chartOreMacchinaTerreno = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.terrenoNome),
                    datasets: [{
                        label: 'Ore Macchina',
                        data: data.map(d => d.ore),
                        backgroundColor: '#2E8B57'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${formatOre(context.parsed.y)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatOre(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateChartOreMacchinaVsLavoratore(data) {
            const chartContainer = document.querySelector('#chart-ore-macchina-vs-lavoratore')?.closest('.chart-card');
            if (!chartContainer) return;
            
            let canvas = chartContainer.querySelector('canvas#chart-ore-macchina-vs-lavoratore');
            if (!canvas) {
                chartContainer.querySelector('.chart-container').innerHTML = '<canvas id="chart-ore-macchina-vs-lavoratore"></canvas>';
                canvas = document.getElementById('chart-ore-macchina-vs-lavoratore');
            }
            
            if (chartOreMacchinaVsLavoratore) chartOreMacchinaVsLavoratore.destroy();
            
            if (data.oreLavoratore === 0 && data.oreMacchina === 0) {
                chartContainer.querySelector('.chart-container').innerHTML = '<div class="empty-state"><div class="empty-state-icon">ðŸšœ</div><p>Nessun dato disponibile</p></div>';
                return;
            }
            
            const ctx = canvas.getContext('2d');
            chartOreMacchinaVsLavoratore = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Ore Lavoratore', 'Ore Macchina'],
                    datasets: [{
                        data: [data.oreLavoratore, data.oreMacchina],
                        backgroundColor: ['#2E8B57', '#007bff']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${formatOre(context.parsed)}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateChartOreMacchineMese(data) {
            const chartContainer = document.querySelector('#chart-ore-macchine-mese')?.closest('.chart-card');
            if (!chartContainer) return;
            
            let canvas = chartContainer.querySelector('canvas#chart-ore-macchine-mese');
            if (!canvas) {
                chartContainer.querySelector('.chart-container').innerHTML = '<canvas id="chart-ore-macchine-mese"></canvas>';
                canvas = document.getElementById('chart-ore-macchine-mese');
            }
            
            if (chartOreMacchineMese) chartOreMacchineMese.destroy();
            
            if (data.length === 0) {
                chartContainer.querySelector('.chart-container').innerHTML = '<div class="empty-state"><div class="empty-state-icon">ðŸšœ</div><p>Nessun dato disponibile</p></div>';
                return;
            }
            
            const ctx = canvas.getContext('2d');
            chartOreMacchineMese = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => formatMese(d.mese)),
                    datasets: [{
                        label: 'Ore Macchine',
                        data: data.map(d => d.ore),
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${formatOre(context.parsed.y)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatOre(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        // Calcola alert scadenza affitto (stessa logica di terreni-standalone.html)
        function calcolaAlertAffitto(dataScadenza) {
            if (!dataScadenza) {
                return { colore: null, testo: '', giorni: null };
            }

            const oggi = new Date();
            oggi.setHours(0, 0, 0, 0);
            
            const scadenza = dataScadenza.toDate ? dataScadenza.toDate() : new Date(dataScadenza);
            scadenza.setHours(0, 0, 0, 0);

            const giorniRimanenti = Math.ceil((scadenza - oggi) / (1000 * 60 * 60 * 24));
            const mesiRimanenti = giorniRimanenti / 30;

            if (giorniRimanenti < 0) {
                return { colore: 'grey', testo: 'Scaduto', giorni: giorniRimanenti, mesi: null };
            } else if (giorniRimanenti <= 30) {
                return { colore: 'red', testo: `${giorniRimanenti} giorni`, giorni: giorniRimanenti, mesi: mesiRimanenti };
            } else if (giorniRimanenti <= 180) {
                const mesi = Math.floor(mesiRimanenti);
                return { colore: 'yellow', testo: `~${mesi} mesi`, giorni: giorniRimanenti, mesi: mesiRimanenti };
            } else {
                const mesi = Math.floor(mesiRimanenti);
                return { colore: 'green', testo: `~${mesi} mesi`, giorni: giorniRimanenti, mesi: mesiRimanenti };
            }
        }

        // Formatta data scadenza
        function formattaDataScadenza(data) {
            if (!data) return '';
            const d = data.toDate ? data.toDate() : new Date(data);
            return d.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        // Escape HTML per prevenire XSS
        // Funzione escapeHtml rimossa - usa utils.escapeHtml

        // Carica statistiche terreni
        async function loadStatisticheTerreni() {
            try {
                if (!currentTenantId) {
                    const user = auth.currentUser;
                    if (user) {
                        currentTenantId = await getTenantId(user.uid);
                    }
                }
                
                if (!currentTenantId) return;
                
                const terreni = await getAllTerreniWrapper();
                
                // Calcola statistiche
                let totaleTerreni = terreni.length;
                let terreniProprieta = 0;
                let terreniAffitto = 0;
                let superficieTotale = 0;
                let superficieProprieta = 0;
                let superficieAffitto = 0;
                let canoneMensileTotale = 0;
                
                terreni.forEach(terreno => {
                    const superficie = terreno.superficie || 0;
                    superficieTotale += superficie;
                    
                    // Applica default 'proprieta' per retrocompatibilitÃ  (terreni esistenti senza tipoPossesso)
                    const tipoPossesso = terreno.tipoPossesso || 'proprieta';
                    
                    if (tipoPossesso === 'proprieta') {
                        terreniProprieta++;
                        superficieProprieta += superficie;
                    } else if (tipoPossesso === 'affitto') {
                        terreniAffitto++;
                        superficieAffitto += superficie;
                        if (terreno.canoneAffitto) {
                            canoneMensileTotale += terreno.canoneAffitto;
                        }
                    }
                });
                
                const canoneAnnuoTotale = canoneMensileTotale * 12;
                
                // Aggiorna metriche
                document.getElementById('stat-terreni-totali').textContent = totaleTerreni;
                document.getElementById('stat-terreni-proprieta').textContent = terreniProprieta;
                document.getElementById('stat-terreni-affitto').textContent = terreniAffitto;
                document.getElementById('stat-superficie-totale').textContent = superficieTotale.toFixed(2);
                document.getElementById('stat-superficie-proprieta').textContent = superficieProprieta.toFixed(2);
                document.getElementById('stat-superficie-affitto').textContent = superficieAffitto.toFixed(2);
                document.getElementById('stat-canone-mensile').textContent = canoneMensileTotale > 0 ? `â‚¬${canoneMensileTotale.toFixed(2)}` : '-';
                document.getElementById('stat-canone-annuo').textContent = canoneAnnuoTotale > 0 ? `â‚¬${canoneAnnuoTotale.toFixed(2)}` : '-';
                
                // Aggiorna grafici
                updateChartDistribuzioneTerreniWrapper(terreniProprieta, terreniAffitto);
                updateChartDistribuzioneSuperficieWrapper(superficieProprieta, superficieAffitto);
                
                // Carica affitti in scadenza
                const affitti = terreni
                    .filter(t => t.tipoPossesso === 'affitto' && t.dataScadenzaAffitto)
                    .map(t => ({
                        ...t,
                        alert: utils.calcolaAlertAffitto(t.dataScadenzaAffitto)
                    }))
                    .sort((a, b) => {
                        const order = { 'red': 0, 'yellow': 1, 'green': 2, 'grey': 3 };
                        const orderA = order[a.alert.colore] !== undefined ? order[a.alert.colore] : 999;
                        const orderB = order[b.alert.colore] !== undefined ? order[b.alert.colore] : 999;
                        if (orderA !== orderB) return orderA - orderB;
                        return (a.alert.giorni || 999) - (b.alert.giorni || 999);
                    });
                
                const listaEl = document.getElementById('affitti-scadenza-lista');
                if (affitti.length === 0) {
                    listaEl.innerHTML = '<div style="text-align: center; color: #666;">Nessun terreno in affitto registrato</div>';
                } else {
                    let html = '';
                    affitti.forEach(affitto => {
                        const dataFormattata = formattaDataScadenza(affitto.dataScadenzaAffitto);
                        const pallinoEmoji = affitto.alert.colore === 'red' ? 'ðŸ”´' : affitto.alert.colore === 'yellow' ? 'ðŸŸ¡' : affitto.alert.colore === 'green' ? 'ðŸŸ¢' : 'âš«';
                        const coloreBordo = affitto.alert.colore === 'red' ? '#dc3545' : affitto.alert.colore === 'yellow' ? '#ffc107' : affitto.alert.colore === 'green' ? '#28a745' : '#6c757d';
                        const coloreSfondo = affitto.alert.colore === 'red' ? '#f8d7da' : affitto.alert.colore === 'yellow' ? '#fff3cd' : affitto.alert.colore === 'green' ? '#d4edda' : '#e9ecef';
                        
                        html += `
                            <div style="padding: 12px; margin-bottom: 10px; background: ${coloreSfondo}; border-left: 3px solid ${coloreBordo}; border-radius: 4px;">
                                <div style="font-weight: 600; color: #333; margin-bottom: 6px; display: flex; align-items: center; gap: 8px;">
                                    <span>${pallinoEmoji}</span>
                                    <span>${utils.escapeHtml(affitto.nome || 'Senza nome')}</span>
                                </div>
                                <div style="font-size: 13px; color: #666; margin-bottom: 4px;">
                                    <strong>Scade:</strong> ${dataFormattata} (${affitto.alert.testo})
                                </div>
                                ${affitto.canoneAffitto ? `
                                    <div style="font-size: 12px; color: #666;">
                                        <strong>Canone:</strong> â‚¬${affitto.canoneAffitto.toFixed(2)}/mese
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    });
                    listaEl.innerHTML = html;
                }
            } catch (error) {
                console.error('Errore caricamento statistiche terreni:', error);
            }
        }

        // Aggiorna grafico distribuzione terreni
        function updateChartDistribuzioneTerreni(proprieta, affitto) {
            const ctx = document.getElementById('chart-distribuzione-terreni');
            if (!ctx) return;
            
            if (window.chartDistribuzioneTerreni) {
                window.chartDistribuzioneTerreni.destroy();
            }
            
            window.chartDistribuzioneTerreni = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['ProprietÃ ', 'Affitto'],
                    datasets: [{
                        data: [proprieta, affitto],
                        backgroundColor: ['#28a745', '#17a2b8'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((context.parsed / total) * 100).toFixed(1) : 0;
                                    return `${context.label}: ${context.parsed} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Aggiorna grafico distribuzione superficie
        function updateChartDistribuzioneSuperficie(proprieta, affitto) {
            const ctx = document.getElementById('chart-distribuzione-superficie');
            if (!ctx) return;
            
            if (window.chartDistribuzioneSuperficie) {
                window.chartDistribuzioneSuperficie.destroy();
            }
            
            window.chartDistribuzioneSuperficie = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['ProprietÃ ', 'Affitto'],
                    datasets: [{
                        data: [proprieta, affitto],
                        backgroundColor: ['#28a745', '#17a2b8'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((context.parsed / total) * 100).toFixed(1) : 0;
                                    return `${context.label}: ${context.parsed.toFixed(2)} ha (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Carica dropdown filtri
        async function loadFilters() {
            try {
                if (!currentTenantId) {
                    const user = auth.currentUser;
                    if (user) {
                        currentTenantId = await getTenantId(user.uid);
                    }
                }
                
                if (!currentTenantId) {
                    console.warn('Tenant ID non disponibile per caricare filtri');
                    return;
                }

                // Carica terreni
                const terreni = await getAllTerreniWrapper();
                const selectTerreno = document.getElementById('filter-terreno');
                selectTerreno.innerHTML = '<option value="">Tutti i terreni</option>';
                terreni.forEach(terreno => {
                    const option = document.createElement('option');
                    option.value = terreno.id;
                    option.textContent = terreno.nome;
                    selectTerreno.appendChild(option);
                });

                // Carica tipi lavoro usando liste-service.js (fonte unica di veritÃ )
                try {
                    const isFileProtocol = window.location.protocol === 'file:';
                    let tipiLavoro = [];
                    
                    if (isFileProtocol) {
                        // Fallback per ambiente file://: carica direttamente da Firestore
                        console.warn('Ambiente file:// rilevato, uso fallback diretto da Firestore');
                        const listeRef = doc(db, `tenants/${currentTenantId}/liste`, 'personalizzate');
                        const listeSnap = await getDoc(listeRef);
                        
                        if (listeSnap.exists()) {
                            const data = listeSnap.data();
                            tipiLavoro = data.tipiLavoro || [];
                        } else {
                            // Predefiniti
                            tipiLavoro = ['Potatura', 'Raccolta', 'Trattamento', 'Semina', 'Aratura', 'Irrigazione', 'Concimazione', 'Diserbo', 'Raccolta frutta', 'Raccolta verdura'];
                        }
                    } else {
                        // Usa servizio centralizzato
                        // Assicura che Firebase sia inizializzato nel servizio
                        try {
                            const { setFirebaseInstances } = await import('./services/firebase-service.js');
                            setFirebaseInstances({ app, db, auth });
                        } catch (error) {
                            console.warn('Impossibile impostare Firebase instances nel servizio:', error);
                        }
                        
                        // Assicura che il tenantId sia impostato nel servizio
                        try {
                            const { setCurrentTenantId } = await import('./services/tenant-service.js');
                            if (currentTenantId) {
                                setCurrentTenantId(currentTenantId);
                            }
                        } catch (error) {
                            console.warn('Impossibile impostare tenantId nel servizio:', error);
                        }
                        
                        // Usa liste-service per ottenere tipi lavoro sincronizzati
                        const { getTipiLavoroNomi } = await import('./services/liste-service.js');
                        tipiLavoro = await getTipiLavoroNomi();
                    }
                    
                    const selectTipoLavoro = document.getElementById('filter-tipo-lavoro');
                    if (selectTipoLavoro) {
                        selectTipoLavoro.innerHTML = '<option value="">Tutti i tipi</option>';
                        tipiLavoro.forEach(tipo => {
                            const option = document.createElement('option');
                            option.value = tipo;
                            option.textContent = tipo;
                            selectTipoLavoro.appendChild(option);
                        });
                    }
                } catch (error) {
                    console.error('Errore caricamento tipi lavoro:', error);
                    // Fallback: carica dalle attivitÃ 
                    try {
                        const attivita = await getAllAttivitaWrapper();
                        const tipiLavoro = [...new Set(attivita.map(a => a.tipoLavoro).filter(Boolean))].sort();
                        const selectTipoLavoro = document.getElementById('filter-tipo-lavoro');
                        if (selectTipoLavoro) {
                            selectTipoLavoro.innerHTML = '<option value="">Tutti i tipi</option>';
                            tipiLavoro.forEach(tipo => {
                                const option = document.createElement('option');
                                option.value = tipo;
                                option.textContent = tipo;
                                selectTipoLavoro.appendChild(option);
                            });
                        }
                    } catch (fallbackError) {
                        console.error('Errore fallback caricamento tipi lavoro:', fallbackError);
                    }
                }
            } catch (error) {
                console.error('Errore caricamento filtri:', error);
            }
        }

        // Funzioni filtri e initApp sono ora nei moduli
        // Le chiamate usano i wrapper definiti sopra
        // window.applyFilters e window.resetFilters sono giÃ  definiti sopra nei wrapper
        // initApp Ã¨ sostituito da initAppWrapper
    </script>
    
    <!-- Service Worker Registration for PWA -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // Usa percorso relativo per compatibilitÃ  con localhost e GitHub Pages
                const swPath = window.location.pathname.includes('/gfv-platform/') 
                    ? '/gfv-platform/service-worker.js' 
                    : '../../service-worker.js';
                navigator.serviceWorker.register(swPath)
                    .then((registration) => {
                        console.log('Service Worker registrato con successo:', registration.scope);
                    })
                    .catch((error) => {
                        console.warn('Registrazione Service Worker fallita (non critico):', error);
                    });
            });
        }
    </script>
    <!-- Tony widget (assistente su tutte le pagine) -->
    <!-- Tony widget (assistente su tutte le pagine) -->
    <script>
    (function() {
      var path = (window.location.pathname || '').replace(/\\/g, '/');
      var isGH = path.indexOf('/gfv-platform/') >= 0;
      var base = isGH ? (window.location.origin + '/gfv-platform/core') : (path.indexOf('/core/admin/') >= 0 ? '../' : (path.indexOf('/modules/') >= 0 ? '../../../core/' : ''));
      var sep = (base && !base.endsWith('/')) ? '/' : '';
      var link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = (base ? base + sep : '') + 'styles/tony-widget.css';
      document.head.appendChild(link);
      var s = document.createElement('script');
      s.type = 'module';
      s.src = (base ? base + sep : '') + 'js/tony-widget-standalone.js';
      document.body.appendChild(s);
    })();
    </script>
</body>
</html>

