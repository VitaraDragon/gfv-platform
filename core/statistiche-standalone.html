<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Statistiche - GFV Platform</title>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(180deg, #B0E0E6 0%, #228B22 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0px 8px 20px rgba(0, 0, 0, 0.15);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(180deg, #2E8B57 0%, #256E4A 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .user-info {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info span {
            font-size: 0.9em;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .btn-primary:hover {
            background: rgba(255,255,255,0.3);
        }

        .content {
            padding: 30px;
        }

        .filters {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 12px;
            font-weight: 600;
            color: #495057;
            margin: 0;
        }

        .filters input,
        .filters select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .filters input[type="date"] {
            min-width: 150px;
        }

        .filters select {
            min-width: 150px;
        }

        .filter-range {
            display: flex;
            align-items: flex-end;
            gap: 8px;
        }

        .filter-range-text {
            padding-bottom: 8px;
            font-size: 14px;
            color: #666;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        /* Metriche Cards */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: linear-gradient(135deg, #2E8B57 0%, #228B22 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
        }

        .metric-card.blue {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        }

        .metric-card.orange {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
        }

        .metric-card.purple {
            background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%);
        }

        .metric-value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .metric-label {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .metric-subtitle {
            font-size: 0.9em;
            opacity: 0.8;
            margin-top: 5px;
        }

        /* Grafici */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .chart-card h3 {
            color: #2E8B57;
            font-size: 1.3em;
            margin-bottom: 20px;
            text-align: center;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        .chart-container.tall {
            height: 400px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 3em;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }

            .metrics-grid {
                grid-template-columns: 1fr;
            }

            .user-info {
                position: static;
                justify-content: center;
                margin-top: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ“Š Statistiche e Dashboard</h1>
            <p>Analisi delle attivitÃ  e metriche aziendali</p>
            <div class="user-info">
                <span id="user-name">Caricamento...</span>
                <button class="btn btn-primary" onclick="window.location.href='dashboard-standalone.html'">Dashboard</button>
            </div>
        </div>

        <div class="content">
            <!-- Filtri -->
            <div class="filters">
                <div class="filter-group">
                    <label>Periodo</label>
                    <div class="filter-range">
                        <input type="date" id="filter-data-da" class="form-control">
                        <span class="filter-range-text">a</span>
                        <input type="date" id="filter-data-a" class="form-control">
                    </div>
                </div>
                <div class="filter-group">
                    <label>Terreno</label>
                    <select id="filter-terreno" class="form-control">
                        <option value="">Tutti i terreni</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Tipo Lavoro</label>
                    <select id="filter-tipo-lavoro" class="form-control">
                        <option value="">Tutti i tipi</option>
                    </select>
                </div>
                <div class="filter-group">
                    <button class="btn btn-secondary" onclick="applyFilters()">Applica Filtri</button>
                </div>
                <div class="filter-group">
                    <button class="btn btn-secondary" onclick="resetFilters()">Reset</button>
                </div>
            </div>

            <!-- Metriche -->
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-value" id="metric-terreni">-</div>
                    <div class="metric-label">Terreni Totali</div>
                </div>
                <div class="metric-card blue">
                    <div class="metric-value" id="metric-ore">-</div>
                    <div class="metric-label">Ore Lavorate</div>
                    <div class="metric-subtitle" id="metric-ore-subtitle">Periodo selezionato</div>
                </div>
                <div class="metric-card orange">
                    <div class="metric-value" id="metric-attivita">-</div>
                    <div class="metric-label">AttivitÃ  Totali</div>
                    <div class="metric-subtitle" id="metric-attivita-subtitle">Periodo selezionato</div>
                </div>
                <div class="metric-card purple">
                    <div class="metric-value" id="metric-ore-mese">-</div>
                    <div class="metric-label">Ore/Mese (Media)</div>
                    <div class="metric-subtitle" id="metric-ore-mese-subtitle">Periodo selezionato</div>
                </div>
            </div>

            <!-- Grafici -->
            <div class="charts-grid">
                <div class="chart-card">
                    <h3>Ore per Tipo Lavoro</h3>
                    <div class="chart-container">
                        <canvas id="chart-ore-tipo"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>AttivitÃ  per Terreno</h3>
                    <div class="chart-container">
                        <canvas id="chart-attivita-terreno"></canvas>
                    </div>
                </div>
                <div class="chart-card" style="grid-column: 1 / -1;">
                    <h3>Ore Lavorate per Mese</h3>
                    <div class="chart-container tall">
                        <canvas id="chart-ore-mese"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>Top 5 Tipi Lavoro</h3>
                    <div class="chart-container">
                        <canvas id="chart-top-lavori"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Load Firebase config from external file -->
    <!-- Fallback: usa raw GitHub se il file locale non Ã¨ disponibile (per GitHub Pages) -->
    <script>
        function loadConfig() {
            return new Promise((resolve, reject) => {
                if (typeof window.firebaseConfig !== 'undefined') {
                    resolve();
                    return;
                }

                const configScript = document.createElement('script');
                configScript.src = 'config/firebase-config.js';
                
                configScript.onload = function() {
                    setTimeout(() => {
                        if (typeof window.firebaseConfig !== 'undefined') {
                            resolve();
                        } else {
                            loadFallbackConfig().then(resolve).catch(reject);
                        }
                    }, 100);
                };
                
                configScript.onerror = function() {
                    loadFallbackConfig().then(resolve).catch(reject);
                };
                
                document.head.appendChild(configScript);
            });
        }

        function loadFallbackConfig() {
            return new Promise((resolve, reject) => {
                const fallbackScript = document.createElement('script');
                fallbackScript.src = 'https://raw.githubusercontent.com/VitaraDragon/gfv-platform/main/core/config/firebase-config.js';
                
                fallbackScript.onload = function() {
                    setTimeout(() => {
                        if (typeof window.firebaseConfig !== 'undefined') {
                            resolve();
                        } else {
                            reject(new Error('Firebase config not found even after loading from GitHub'));
                        }
                    }, 100);
                };
                
                fallbackScript.onerror = function() {
                    reject(new Error('Failed to load Firebase config from GitHub'));
                };
                
                document.head.appendChild(fallbackScript);
            });
        }

        loadConfig().catch(error => {
            console.error('Errore caricamento config:', error);
        });
    </script>
    
    <!-- Firebase SDK -->
    <script type="module">
        // Attendi che lo script config sia caricato
        function waitForConfig() {
            return new Promise((resolve, reject) => {
                if (typeof window.firebaseConfig !== 'undefined') {
                    resolve(window.firebaseConfig);
                    return;
                }
                
                let attempts = 0;
                const maxAttempts = 50;
                
                const checkInterval = setInterval(() => {
                    attempts++;
                    if (typeof window.firebaseConfig !== 'undefined') {
                        clearInterval(checkInterval);
                        resolve(window.firebaseConfig);
                    } else if (attempts >= maxAttempts) {
                        clearInterval(checkInterval);
                        reject(new Error('Firebase config not loaded after 5 seconds'));
                    }
                }, 100);
            });
        }

        const firebaseConfig = await waitForConfig();

        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { 
            getFirestore, 
            collection, 
            doc, 
            getDoc, 
            getDocs, 
            query, 
            where, 
            orderBy 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Inizializza Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Variabili globali
        let currentTenantId = null;

        // Funzione helper: ottieni tenant ID
        async function getTenantId(userId) {
            if (currentTenantId) return currentTenantId;
            
            try {
                const userDoc = await getDoc(doc(db, 'users', userId));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    currentTenantId = userData.tenantId;
                    return currentTenantId;
                }
            } catch (error) {
                console.error('Errore recupero tenant:', error);
            }
            return null;
        }

        // Funzione helper: ottieni collection
        function getTerreniCollection(tenantId) {
            if (!tenantId) throw new Error('Tenant ID non disponibile');
            return collection(db, `tenants/${tenantId}/terreni`);
        }

        function getAttivitaCollection(tenantId) {
            if (!tenantId) throw new Error('Tenant ID non disponibile');
            return collection(db, `tenants/${tenantId}/attivita`);
        }

        // Verifica autenticazione
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = './auth/login-standalone.html';
                return;
            }

            try {
                // Carica dati utente e tenant
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    const nomeCompleto = `${userData.nome || ''} ${userData.cognome || ''}`.trim();
                    const email = userData.email || user.email;
                    document.getElementById('user-name').textContent = nomeCompleto || email || 'Utente';
                    
                    currentTenantId = userData.tenantId;
                } else {
                    document.getElementById('user-name').textContent = user.email || 'Utente';
                }
            } catch (error) {
                console.error('Errore caricamento utente:', error);
                document.getElementById('user-name').textContent = user.email || 'Utente';
            }

            // Inizializza app
            await initApp();
        });

        // Funzioni statistiche
        async function getAllTerreni() {
            if (!currentTenantId) {
                const user = auth.currentUser;
                if (user) {
                    currentTenantId = await getTenantId(user.uid);
                }
            }
            
            if (!currentTenantId) return [];
            
            try {
                const q = query(getTerreniCollection(currentTenantId));
                const snapshot = await getDocs(q);
                return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) {
                console.error('Errore caricamento terreni:', error);
                return [];
            }
        }

        async function getAllAttivita(filters = {}) {
            if (!currentTenantId) {
                const user = auth.currentUser;
                if (user) {
                    currentTenantId = await getTenantId(user.uid);
                }
            }
            
            if (!currentTenantId) return [];
            
            try {
                let q = query(getAttivitaCollection(currentTenantId));

                // Conta quanti filtri sono attivi
                const hasTerrenoId = !!filters.terrenoId;
                const hasTipoLavoro = !!filters.tipoLavoro;
                const hasDataDa = !!filters.dataDa;
                const hasDataA = !!filters.dataA;
                const filterCount = [hasTerrenoId, hasTipoLavoro, hasDataDa, hasDataA].filter(Boolean).length;

                // Applica filtri
                if (hasTerrenoId) {
                    q = query(q, where('terrenoId', '==', filters.terrenoId));
                }
                if (hasTipoLavoro) {
                    q = query(q, where('tipoLavoro', '==', filters.tipoLavoro));
                }
                if (hasDataDa) {
                    q = query(q, where('data', '>=', filters.dataDa));
                }
                if (hasDataA) {
                    q = query(q, where('data', '<=', filters.dataA));
                }

                // Ordina per data (richiede indice composito se ci sono 2+ filtri)
                q = query(q, orderBy('data', 'desc'));
                const snapshot = await getDocs(q);
                let results = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Se la query fallisce per mancanza di indice, prova senza orderBy e ordina in memoria
                return results;
            } catch (error) {
                // Se l'errore Ã¨ relativo agli indici, prova senza orderBy
                if (error.code === 'failed-precondition' && error.message.includes('index')) {
                    console.warn('Indice Firestore mancante, carico senza orderBy e ordino in memoria...');
                    try {
                        // Ricarica senza orderBy
                        let q = query(getAttivitaCollection(currentTenantId));
                        if (filters.terrenoId) q = query(q, where('terrenoId', '==', filters.terrenoId));
                        if (filters.tipoLavoro) q = query(q, where('tipoLavoro', '==', filters.tipoLavoro));
                        if (filters.dataDa) q = query(q, where('data', '>=', filters.dataDa));
                        if (filters.dataA) q = query(q, where('data', '<=', filters.dataA));
                        
                        const snapshot = await getDocs(q);
                        let results = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        
                        // Ordina in memoria per data
                        results.sort((a, b) => {
                            if (!a.data || !b.data) return 0;
                            return b.data.localeCompare(a.data);
                        });
                        
                        // Filtra per data se necessario (giÃ  fatto nella query, ma per sicurezza)
                        if (filters.dataDa) {
                            results = results.filter(att => att.data >= filters.dataDa);
                        }
                        if (filters.dataA) {
                            results = results.filter(att => att.data <= filters.dataA);
                        }
                        
                        // Mostra messaggio informativo
                        const indexLink = error.message.match(/https:\/\/[^\s]+/);
                        if (indexLink) {
                            console.warn('Per migliorare le prestazioni, crea l\'indice Firestore:', indexLink[0]);
                        }
                        
                        return results;
                    } catch (retryError) {
                        console.error('Errore anche senza orderBy:', retryError);
                        const indexLink = error.message.match(/https:\/\/[^\s]+/);
                        if (indexLink) {
                            alert(`Ãˆ necessario creare un indice Firestore per i filtri multipli.\n\nApri questo link per crearlo automaticamente:\n\n${indexLink[0]}\n\nDopo aver creato l'indice, attendi qualche minuto e riprova.`);
                        }
                        return [];
                    }
                } else {
                    console.error('Errore caricamento attivitÃ :', error);
                    return [];
                }
            }
        }

        // Funzioni statistiche
        async function getTotaleTerreni() {
            const terreni = await getAllTerreni();
            return terreni.length;
        }

        async function getTotaleOre(periodo = {}) {
            const attivita = await getAllAttivita(periodo);
            const totaleOre = attivita.reduce((sum, att) => sum + (att.oreNette || 0), 0);
            return parseFloat(totaleOre.toFixed(2));
        }

        async function getTotaleAttivita(periodo = {}) {
            const attivita = await getAllAttivita(periodo);
            return attivita.length;
        }

        async function getOrePerTipoLavoro(periodo = {}) {
            const attivita = await getAllAttivita(periodo);
            const orePerTipo = {};
            attivita.forEach(att => {
                const tipo = att.tipoLavoro || 'Non specificato';
                if (!orePerTipo[tipo]) {
                    orePerTipo[tipo] = 0;
                }
                orePerTipo[tipo] += att.oreNette || 0;
            });
            return Object.entries(orePerTipo)
                .map(([tipoLavoro, ore]) => ({
                    tipoLavoro,
                    ore: parseFloat(ore.toFixed(2))
                }))
                .sort((a, b) => b.ore - a.ore);
        }

        async function getAttivitaPerTerreno(periodo = {}) {
            const attivita = await getAllAttivita(periodo);
            const attivitaPerTerreno = {};
            attivita.forEach(att => {
                const terrenoNome = att.terrenoNome || 'Non specificato';
                if (!attivitaPerTerreno[terrenoNome]) {
                    attivitaPerTerreno[terrenoNome] = {
                        terrenoNome,
                        numeroAttivita: 0,
                        oreTotali: 0
                    };
                }
                attivitaPerTerreno[terrenoNome].numeroAttivita++;
                attivitaPerTerreno[terrenoNome].oreTotali += att.oreNette || 0;
            });
            return Object.values(attivitaPerTerreno)
                .map(item => ({
                    ...item,
                    oreTotali: parseFloat(item.oreTotali.toFixed(2))
                }))
                .sort((a, b) => b.numeroAttivita - a.numeroAttivita);
        }

        async function getOrePerMese(periodo = {}) {
            const attivita = await getAllAttivita(periodo);
            const orePerMese = {};
            attivita.forEach(att => {
                if (!att.data) return;
                const mese = att.data.substring(0, 7);
                if (!orePerMese[mese]) {
                    orePerMese[mese] = 0;
                }
                orePerMese[mese] += att.oreNette || 0;
            });
            return Object.entries(orePerMese)
                .map(([mese, ore]) => ({
                    mese,
                    ore: parseFloat(ore.toFixed(2))
                }))
                .sort((a, b) => a.mese.localeCompare(b.mese));
        }

        async function getTipiLavoroPiuFrequenti(periodo = {}, limit = 5) {
            const attivita = await getAllAttivita(periodo);
            const frequenza = {};
            attivita.forEach(att => {
                const tipo = att.tipoLavoro || 'Non specificato';
                frequenza[tipo] = (frequenza[tipo] || 0) + 1;
            });
            return Object.entries(frequenza)
                .map(([tipoLavoro, frequenza]) => ({
                    tipoLavoro,
                    frequenza
                }))
                .sort((a, b) => b.frequenza - a.frequenza)
                .slice(0, limit);
        }

        // Grafici
        let chartOreTipo = null;
        let chartAttivitaTerreno = null;
        let chartOreMese = null;
        let chartTopLavori = null;

        function formatOre(ore) {
            const oreInt = Math.floor(ore);
            const minuti = Math.round((ore - oreInt) * 60);
            if (minuti === 0) {
                return `${oreInt}h`;
            }
            return `${oreInt}h ${minuti}min`;
        }

        function formatMese(mese) {
            const [anno, meseNum] = mese.split('-');
            const mesi = ['Gen', 'Feb', 'Mar', 'Apr', 'Mag', 'Giu', 'Lug', 'Ago', 'Set', 'Ott', 'Nov', 'Dic'];
            return `${mesi[parseInt(meseNum) - 1]} ${anno}`;
        }

        function updateChartOreTipo(data) {
            // Trova sempre il container direttamente dal DOM usando querySelector
            let chartContainer = document.querySelector('.chart-card:has(canvas#chart-ore-tipo)') || 
                                 document.querySelector('.chart-card:has([id*="chart-ore-tipo"])') ||
                                 document.querySelector('#chart-ore-tipo')?.closest('.chart-card');
            
            // Se non trovato, cerca tra tutti i chart-card (fallback)
            if (!chartContainer) {
                const containers = document.querySelectorAll('.chart-card');
                // Il primo chart-card dovrebbe essere quello delle ore per tipo
                chartContainer = containers[0];
            }
            
            if (!chartContainer) {
                console.error('Container per chart-ore-tipo non trovato');
                return;
            }
            
            let canvas = chartContainer.querySelector('canvas#chart-ore-tipo');
            
            // Se il canvas non esiste o Ã¨ stato sostituito, ricrearlo
            if (!canvas || canvas.tagName !== 'CANVAS') {
                chartContainer.innerHTML = '<canvas id="chart-ore-tipo"></canvas>';
                canvas = document.getElementById('chart-ore-tipo');
            }
            
            if (chartOreTipo) {
                chartOreTipo.destroy();
            }
            
            if (data.length === 0) {
                chartContainer.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ðŸ“Š</div><p>Nessun dato disponibile</p></div>';
                return;
            }
            
            const ctx = canvas.getContext('2d');
            chartOreTipo = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.map(d => d.tipoLavoro),
                    datasets: [{
                        data: data.map(d => d.ore),
                        backgroundColor: [
                            '#2E8B57', '#007bff', '#ff9800', '#9c27b0', '#e91e63',
                            '#00bcd4', '#4caf50', '#ffc107', '#795548', '#607d8b'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${formatOre(context.parsed)}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateChartAttivitaTerreno(data) {
            // Trova sempre il container direttamente dal DOM
            let chartContainer = document.querySelector('.chart-card:has(canvas#chart-attivita-terreno)') || 
                                 document.querySelector('#chart-attivita-terreno')?.closest('.chart-card');
            
            // Se non trovato, cerca tra tutti i chart-card (fallback)
            if (!chartContainer) {
                const containers = document.querySelectorAll('.chart-card');
                // Il secondo chart-card dovrebbe essere quello delle attivitÃ  per terreno
                chartContainer = containers[1];
            }
            
            if (!chartContainer) {
                console.error('Container per chart-attivita-terreno non trovato');
                return;
            }
            
            let canvas = chartContainer.querySelector('canvas#chart-attivita-terreno');
            
            // Se il canvas non esiste o Ã¨ stato sostituito, ricrearlo
            if (!canvas || canvas.tagName !== 'CANVAS') {
                chartContainer.innerHTML = '<canvas id="chart-attivita-terreno"></canvas>';
                canvas = document.getElementById('chart-attivita-terreno');
            }
            
            if (chartAttivitaTerreno) {
                chartAttivitaTerreno.destroy();
            }
            
            if (data.length === 0) {
                chartContainer.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ðŸ“Š</div><p>Nessun dato disponibile</p></div>';
                return;
            }
            
            const ctx = canvas.getContext('2d');
            chartAttivitaTerreno = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.terrenoNome),
                    datasets: [{
                        label: 'Numero AttivitÃ ',
                        data: data.map(d => d.numeroAttivita),
                        backgroundColor: '#2E8B57'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        function updateChartOreMese(data) {
            // Trova sempre il container direttamente dal DOM
            let chartContainer = document.querySelector('.chart-card:has(canvas#chart-ore-mese)') || 
                                 document.querySelector('#chart-ore-mese')?.closest('.chart-card');
            
            // Se non trovato, cerca tra tutti i chart-card (fallback)
            if (!chartContainer) {
                const containers = document.querySelectorAll('.chart-card');
                // Il terzo chart-card dovrebbe essere quello delle ore per mese
                chartContainer = containers[2];
            }
            
            if (!chartContainer) {
                console.error('Container per chart-ore-mese non trovato');
                return;
            }
            
            let canvas = chartContainer.querySelector('canvas#chart-ore-mese');
            
            // Se il canvas non esiste o Ã¨ stato sostituito, ricrearlo
            if (!canvas || canvas.tagName !== 'CANVAS') {
                chartContainer.innerHTML = '<canvas id="chart-ore-mese"></canvas>';
                canvas = document.getElementById('chart-ore-mese');
            }
            
            if (chartOreMese) {
                chartOreMese.destroy();
            }
            
            if (data.length === 0) {
                chartContainer.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ðŸ“Š</div><p>Nessun dato disponibile</p></div>';
                return;
            }
            
            const ctx = canvas.getContext('2d');
            chartOreMese = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => formatMese(d.mese)),
                    datasets: [{
                        label: 'Ore Lavorate',
                        data: data.map(d => d.ore),
                        borderColor: '#2E8B57',
                        backgroundColor: 'rgba(46, 139, 87, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${formatOre(context.parsed.y)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatOre(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateChartTopLavori(data) {
            // Trova sempre il container direttamente dal DOM
            let chartContainer = document.querySelector('.chart-card:has(canvas#chart-top-lavori)') || 
                                 document.querySelector('#chart-top-lavori')?.closest('.chart-card');
            
            // Se non trovato, cerca tra tutti i chart-card (fallback)
            if (!chartContainer) {
                const containers = document.querySelectorAll('.chart-card');
                // Il quarto chart-card dovrebbe essere quello dei top lavori
                chartContainer = containers[3];
            }
            
            if (!chartContainer) {
                console.error('Container per chart-top-lavori non trovato');
                return;
            }
            
            let canvas = chartContainer.querySelector('canvas#chart-top-lavori');
            
            // Se il canvas non esiste o Ã¨ stato sostituito, ricrearlo
            if (!canvas || canvas.tagName !== 'CANVAS') {
                chartContainer.innerHTML = '<canvas id="chart-top-lavori"></canvas>';
                canvas = document.getElementById('chart-top-lavori');
            }
            
            if (chartTopLavori) {
                chartTopLavori.destroy();
            }
            
            if (data.length === 0) {
                chartContainer.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ðŸ“Š</div><p>Nessun dato disponibile</p></div>';
                return;
            }
            
            const ctx = canvas.getContext('2d');
            chartTopLavori = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.tipoLavoro),
                    datasets: [{
                        label: 'Frequenza',
                        data: data.map(d => d.frequenza),
                        backgroundColor: '#007bff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // Carica dati e aggiorna UI
        async function loadStatistiche() {
            try {
                // Ottieni filtri
                const dataDa = document.getElementById('filter-data-da').value;
                const dataA = document.getElementById('filter-data-a').value;
                const terrenoId = document.getElementById('filter-terreno').value;
                const tipoLavoro = document.getElementById('filter-tipo-lavoro').value;

                const periodo = {};
                if (dataDa) periodo.dataDa = dataDa;
                if (dataA) periodo.dataA = dataA;
                if (terrenoId) periodo.terrenoId = terrenoId;
                if (tipoLavoro) periodo.tipoLavoro = tipoLavoro;

                // Calcola statistiche
                const [totaleTerreni, totaleOre, totaleAttivita, orePerTipoLavoro, attivitaPerTerreno, orePerMese, tipiLavoroPiuFrequenti] = await Promise.all([
                    getTotaleTerreni(),
                    getTotaleOre(periodo),
                    getTotaleAttivita(periodo),
                    getOrePerTipoLavoro(periodo),
                    getAttivitaPerTerreno(periodo),
                    getOrePerMese(periodo),
                    getTipiLavoroPiuFrequenti(periodo, 5)
                ]);

                // Aggiorna metriche
                document.getElementById('metric-terreni').textContent = totaleTerreni;
                document.getElementById('metric-ore').textContent = formatOre(totaleOre);
                document.getElementById('metric-attivita').textContent = totaleAttivita;
                
                // Calcola media ore/mese
                const mediaOreMese = orePerMese.length > 0 ? (totaleOre / orePerMese.length).toFixed(1) : 0;
                document.getElementById('metric-ore-mese').textContent = formatOre(parseFloat(mediaOreMese));

                // Aggiorna sottotitoli
                const periodoText = dataDa && dataA ? `${dataDa} - ${dataA}` : 'Tutti i periodi';
                document.getElementById('metric-ore-subtitle').textContent = periodoText;
                document.getElementById('metric-attivita-subtitle').textContent = periodoText;
                document.getElementById('metric-ore-mese-subtitle').textContent = periodoText;

                // Aggiorna grafici
                updateChartOreTipo(orePerTipoLavoro);
                updateChartAttivitaTerreno(attivitaPerTerreno);
                updateChartOreMese(orePerMese);
                updateChartTopLavori(tipiLavoroPiuFrequenti);
            } catch (error) {
                console.error('Errore caricamento statistiche:', error);
                alert('Errore nel caricamento delle statistiche: ' + error.message);
            }
        }

        // Carica dropdown filtri
        async function loadFilters() {
            try {
                if (!currentTenantId) {
                    const user = auth.currentUser;
                    if (user) {
                        currentTenantId = await getTenantId(user.uid);
                    }
                }
                
                if (!currentTenantId) {
                    console.warn('Tenant ID non disponibile per caricare filtri');
                    return;
                }

                // Carica terreni
                const terreni = await getAllTerreni();
                const selectTerreno = document.getElementById('filter-terreno');
                selectTerreno.innerHTML = '<option value="">Tutti i terreni</option>';
                terreni.forEach(terreno => {
                    const option = document.createElement('option');
                    option.value = terreno.id;
                    option.textContent = terreno.nome;
                    selectTerreno.appendChild(option);
                });

                // Carica tipi lavoro dalle liste personalizzate
                try {
                    const listeRef = doc(db, `tenants/${currentTenantId}/liste`, 'personalizzate');
                    const listeSnap = await getDoc(listeRef);
                    
                    let tipiLavoro = [];
                    if (listeSnap.exists()) {
                        const data = listeSnap.data();
                        tipiLavoro = data.tipiLavoro || [];
                    } else {
                        // Predefiniti
                        tipiLavoro = ['Potatura', 'Raccolta', 'Trattamento', 'Semina', 'Aratura', 'Irrigazione', 'Concimazione', 'Diserbo', 'Raccolta frutta', 'Raccolta verdura'];
                    }
                    
                    const selectTipoLavoro = document.getElementById('filter-tipo-lavoro');
                    selectTipoLavoro.innerHTML = '<option value="">Tutti i tipi</option>';
                    tipiLavoro.forEach(tipo => {
                        const option = document.createElement('option');
                        option.value = tipo;
                        option.textContent = tipo;
                        selectTipoLavoro.appendChild(option);
                    });
                } catch (error) {
                    console.error('Errore caricamento tipi lavoro:', error);
                    // Fallback: carica dalle attivitÃ 
                    const attivita = await getAllAttivita();
                    const tipiLavoro = [...new Set(attivita.map(a => a.tipoLavoro).filter(Boolean))].sort();
                    const selectTipoLavoro = document.getElementById('filter-tipo-lavoro');
                    selectTipoLavoro.innerHTML = '<option value="">Tutti i tipi</option>';
                    tipiLavoro.forEach(tipo => {
                        const option = document.createElement('option');
                        option.value = tipo;
                        option.textContent = tipo;
                        selectTipoLavoro.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Errore caricamento filtri:', error);
            }
        }

        // Funzioni filtri
        window.applyFilters = function() {
            loadStatistiche();
        };

        window.resetFilters = function() {
            document.getElementById('filter-data-da').value = '';
            document.getElementById('filter-data-a').value = '';
            document.getElementById('filter-terreno').value = '';
            document.getElementById('filter-tipo-lavoro').value = '';
            loadStatistiche();
        };

        // Inizializza app
        async function initApp() {
            try {
                await loadFilters();
                await loadStatistiche();
            } catch (error) {
                console.error('Errore inizializzazione app:', error);
            }
        }
    </script>
</body>
</html>

