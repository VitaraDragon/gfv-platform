<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Terreni - GFV Platform</title>
    <link rel="manifest" href="/gfv-platform/manifest.json">
    <meta name="theme-color" content="#2E8B57">
    <link rel="stylesheet" href="https://unpkg.com/intro.js/minified/introjs.min.css">
    <link rel="stylesheet" href="./styles/tour.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #2E8B57 0%, #228B22 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .btn-primary:hover {
            background: rgba(255,255,255,0.3);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-header h2 {
            color: #2E8B57;
            font-size: 24px;
        }

        /* Terreni Table Layout (come vecchia app) */
        .terreni-table {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-top: 20px;
        }

        .terreni-header {
            background: #f8f9fa;
            color: #000;
            display: grid;
            grid-template-columns: 2fr 1.5fr 1.5fr 1.5fr 1fr 0.8fr 2fr 1.5fr;
            gap: 15px;
            padding: 15px 20px;
            font-weight: 600;
            font-size: 0.95em;
            text-align: center;
            border-bottom: 2px solid #2E8B57;
        }

        .terreno-row {
            display: grid;
            grid-template-columns: 2fr 1.5fr 1.5fr 1.5fr 1fr 0.8fr 2fr 1.5fr;
            gap: 15px;
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            align-items: center;
            transition: background-color 0.2s;
            text-align: center;
        }

        .terreno-row:hover {
            background-color: #f8f9fa;
        }

        .terreno-row:last-child {
            border-bottom: none;
        }

        .col-nome {
            text-align: left;
        }

        .terreno-name {
            font-weight: bold;
            color: #28a745;
            font-size: 1em;
        }

        .col-coltura {
            color: #333;
            font-size: 0.9em;
            text-align: center;
        }

        .terreno-coltura {
            color: #333;
            font-size: 0.9em;
        }

        .col-podere {
            color: #666;
            font-size: 0.9em;
            text-align: center;
            font-style: italic;
        }

        .terreno-podere {
            color: #666;
            font-size: 0.9em;
        }

        .col-possesso {
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
            white-space: nowrap;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .alert-dot {
            display: inline-block;
            font-size: 1.2em;
            cursor: help;
            vertical-align: middle;
        }

        .col-ettari {
            font-weight: bold;
            color: #007bff;
            font-size: 1em;
            text-align: center;
        }

        .col-mappa {
            text-align: center;
        }

        .map-indicator {
            font-size: 1.2em;
        }

        .map-indicator.no-map {
            opacity: 0.3;
        }

        .col-note {
            color: #666;
            font-size: 0.9em;
            text-align: left;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .col-azioni {
            display: flex;
            gap: 8px;
            justify-content: center;
            align-items: center;
        }

        .btn-edit-small, .btn-delete-small, .btn-vigneto-small, .btn-frutteto-small {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-edit-small {
            background: #ffc107;
            color: #212529;
        }

        .btn-edit-small:hover {
            background: #e0a800;
            transform: translateY(-1px);
        }

        .btn-delete-small {
            background: #dc3545;
            color: white;
        }

        .btn-delete-small:hover {
            background: #c82333;
            transform: translateY(-1px);
        }

        .btn-vigneto-small {
            background: #6A1B9A;
            color: white;
            font-size: 14px; /* allineato a edit/delete */
        }

        .btn-vigneto-small:hover {
            background: #5a1490;
            transform: translateY(-1px);
        }

        .btn-frutteto-small {
            background: #2E8B57;
            color: white;
            font-size: 14px; /* allineato a edit/delete */
        }

        .btn-frutteto-small:hover {
            background: #228B22;
            transform: translateY(-1px);
        }

        @media (max-width: 768px) {
            .terreni-header, .terreno-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .terreni-header > div, .terreno-row > div {
                text-align: left !important;
                padding: 5px 0;
            }

            .terreni-header > div:before,
            .terreno-row > div:before {
                content: attr(data-label) ": ";
                font-weight: 600;
                color: #666;
            }

            .col-azioni {
                justify-content: flex-start;
            }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #2E8B57;
            font-size: 24px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-modal:hover {
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-group small {
            display: block;
            margin-top: 5px;
            color: #666;
            font-size: 12px;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 30px;
        }

        /* Map Styles */
        .map-container {
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }

        #map {
            width: 100%;
            height: 400px;
        }

        .map-controls {
            background: #f8f9fa;
            padding: 15px;
            border-bottom: 1px solid #ddd;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .map-controls input {
            flex: 1;
            min-width: 200px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        #map-search-wrapper {
            display: flex;
            gap: 10px;
            flex: 1;
            min-width: 200px;
            align-items: center;
        }

        #map-search-wrapper input {
            flex: 1;
            min-width: 0; /* Permette al flex di funzionare correttamente */
        }

        .map-info {
            background: #e7f3ff;
            padding: 15px;
            border-top: 1px solid #ddd;
            display: none;
        }

        .map-info.active {
            display: block;
        }

        .map-info p {
            margin: 5px 0;
            color: #333;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
            }

            .modal-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>üåæ Gestione Terreni</h1>
                <div style="font-size: 14px; opacity: 0.95;" id="user-info">Caricamento...</div>
            </div>
            <div class="header-actions">
                <a href="admin/impostazioni-standalone.html" class="btn btn-primary" style="text-decoration: none; display: none; align-items: center; gap: 8px;" id="impostazioni-link">
                    <span>‚öôÔ∏è</span>
                    <span>Impostazioni</span>
                </a>
                <a href="dashboard-standalone.html" class="btn btn-secondary">‚Üê Dashboard</a>
                <button class="btn btn-primary" id="terreni-tour-button" type="button">üß≠ Tour</button>
                <button class="btn btn-primary" id="add-terreno-button" onclick="openTerrenoModal()">+ Aggiungi Terreno</button>
            </div>
        </div>

        <div class="content">
            <div id="alert-container"></div>
            
            <!-- Filtri -->
            <div class="filters" style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <div class="filter-group" style="display: flex; flex-direction: column; gap: 5px;">
                    <label style="font-size: 12px; font-weight: 600; color: #495057;">Tipo Possesso</label>
                    <select id="filter-tipo-possesso" style="padding: 8px 12px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;" onchange="filterTerreni()">
                        <option value="">Tutti</option>
                        <option value="proprieta">Propriet√†</option>
                        <option value="affitto">Affitto</option>
                    </select>
                </div>
                <div class="filter-group" style="display: flex; flex-direction: column; gap: 5px;">
                    <label style="font-size: 12px; font-weight: 600; color: #495057;">Alert Scadenza</label>
                    <select id="filter-alert" style="padding: 8px 12px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;" onchange="filterTerreni()">
                        <option value="">Tutti</option>
                        <option value="red">Rosso (‚â§1 mese)</option>
                        <option value="yellow">Giallo (1-6 mesi)</option>
                        <option value="green">Verde (>6 mesi)</option>
                        <option value="grey">Scaduto</option>
                    </select>
                </div>
                <div class="filter-group" style="display: flex; align-items: flex-end;">
                    <button onclick="clearFilters()" class="btn btn-secondary" style="padding: 8px 16px; font-size: 14px;">Pulisci Filtri</button>
                </div>
            </div>
            
            <div id="terreni-container" class="loading" data-tour-section="lista-terreni">Caricamento terreni...</div>
        </div>
    </div>

    <!-- Modal Terreno -->
    <div id="terreno-modal" class="modal">
        <div class="modal-content" data-tour-section="form-terreno">
            <div class="modal-header">
                <h2 id="modal-title">Aggiungi Terreno</h2>
                <button class="close-modal" onclick="closeTerrenoModal()">&times;</button>
            </div>
            <form id="terreno-form" onsubmit="handleSaveTerreno(event)">
                <div class="form-group">
                    <label for="terreno-nome">Nome Terreno *</label>
                    <input type="text" id="terreno-nome" required>
                    <small>Nome identificativo del terreno</small>
                </div>

                <div class="form-group">
                    <label for="terreno-superficie">Superficie (ettari)</label>
                    <input type="number" id="terreno-superficie" step="0.01" min="0">
                    <small>Inserisci manualmente o traccia i confini sulla mappa per calcolo automatico</small>
                </div>

                <div class="form-group">
                    <label for="terreno-coltura-categoria">Categoria Coltura</label>
                    <select id="terreno-coltura-categoria" onchange="updateColtureDropdownTerreni()">
                        <option value="">-- Seleziona categoria --</option>
                    </select>
                    <small>Seleziona prima la categoria (es: Frutteto, Seminativo, Ortive)</small>
                </div>
                
                <div class="form-group">
                    <label for="terreno-coltura">Coltura</label>
                    <select id="terreno-coltura">
                        <option value="">-- Seleziona prima la categoria --</option>
                    </select>
                    <small>Seleziona la coltura principale del terreno</small>
                </div>

                <div class="form-group">
                    <label for="terreno-podere">Podere</label>
                    <select id="terreno-podere">
                        <option value="">-- Nessun podere --</option>
                    </select>
                    <small>Seleziona il podere a cui appartiene il terreno. <a href="admin/impostazioni-standalone.html" target="_blank" style="color: #2E8B57; text-decoration: underline;">Gestisci poderi nelle impostazioni</a></small>
                </div>

                <div class="form-group">
                    <label for="terreno-tipo-possesso">Tipo Possesso *</label>
                    <select id="terreno-tipo-possesso" required onchange="toggleDataScadenzaAffitto()">
                        <option value="proprieta">Propriet√†</option>
                        <option value="affitto">Affitto</option>
                    </select>
                    <small>Specifica se il terreno √® di propriet√† o in affitto</small>
                </div>

                <div class="form-group" id="affitto-fields" style="display: none;">
                    <label for="terreno-data-scadenza-affitto">Data Scadenza Affitto *</label>
                    <input type="date" id="terreno-data-scadenza-affitto">
                    <small>Data di scadenza del contratto di affitto</small>
                </div>

                <div class="form-group" id="affitto-canone-field" style="display: none;">
                    <label for="terreno-canone-affitto">Canone Mensile (‚Ç¨)</label>
                    <input type="number" id="terreno-canone-affitto" step="0.01" min="0" placeholder="0.00">
                    <small>Canone mensile dell'affitto (opzionale, per statistiche future)</small>
                </div>

                <div class="form-group">
                    <label>Mappa (opzionale)</label>
                    <div class="map-container" data-tour-section="mappa-terreno">
                        <div class="map-controls">
                            <div id="map-search-wrapper">
                                <input type="text" id="map-search" placeholder="Cerca indirizzo...">
                                <button type="button" class="btn btn-primary" onclick="searchLocation()">üîç Cerca</button>
                            </div>
                            <button type="button" class="btn btn-success" id="btn-draw" onclick="toggleDrawing()">‚úèÔ∏è Traccia Confini</button>
                            <button type="button" class="btn btn-danger" onclick="clearPolygon()">üóëÔ∏è Cancella</button>
                        </div>
                        <div id="map"></div>
                        <div class="map-info" id="map-info">
                            <p><strong>Superficie calcolata:</strong> <span id="calculated-area">0.00</span> ettari</p>
                            <p><strong>Superficie manuale:</strong> <span id="manual-area">0.00</span> ettari</p>
                        </div>
                    </div>
                    <small>Traccia i confini del terreno sulla mappa per calcolare automaticamente la superficie</small>
                </div>

                <div class="form-group">
                    <label for="terreno-note">Note</label>
                    <textarea id="terreno-note" placeholder="Note aggiuntive sul terreno..."></textarea>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeTerrenoModal()">Annulla</button>
                    <button type="submit" class="btn btn-success">Salva Terreno</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Load Firebase and Google Maps config from external files -->
    <!-- Fallback: usa raw GitHub se i file locali non sono disponibili (per GitHub Pages) -->
    <script>
        const firebaseConfigScript = document.createElement('script');
        firebaseConfigScript.src = 'config/firebase-config.js';
        firebaseConfigScript.onerror = function() {
            const fallback = document.createElement('script');
            fallback.src = 'https://raw.githubusercontent.com/VitaraDragon/gfv-platform/main/core/config/firebase-config.js';
            document.head.appendChild(fallback);
        };
        document.head.appendChild(firebaseConfigScript);
        
        const mapsConfigScript = document.createElement('script');
        mapsConfigScript.src = 'config/google-maps-config.js';
        mapsConfigScript.onerror = function() {
            const fallback = document.createElement('script');
            fallback.src = 'https://raw.githubusercontent.com/VitaraDragon/gfv-platform/main/core/config/google-maps-config.js';
            document.head.appendChild(fallback);
        };
        document.head.appendChild(mapsConfigScript);
    </script>
    
    <script src="https://unpkg.com/intro.js/minified/intro.min.js"></script>
    <!-- Firebase SDK e Google Maps -->
    <script type="module">
        // ============================================
        // IMPORT MODULI (prima di tutto)
        // ============================================
        import { 
            waitForConfig as waitForConfigModule,
            getTenantId as getTenantIdModule,
            getTerreniCollection as getTerreniCollectionModule,
            loadPoderi as loadPoderiModule,
            populatePoderiDropdown as populatePoderiDropdownModule,
            loadColture as loadColtureModule,
            loadTerreni as loadTerreniModule,
            renderTerreni as renderTerreniModule,
            filterTerreni as filterTerreniModule,
            clearFilters as clearFiltersModule
        } from './js/terreni-controller.js';

        import {
            showAlert as showAlertUtil,
            escapeHtml as escapeHtmlUtil,
            calcolaAlertAffitto as calcolaAlertAffittoUtil,
            formattaDataScadenza as formattaDataScadenzaUtil,
            getColturaColor as getColturaColorUtil
        } from './js/terreni-utils.js';

        import {
            initMap as initMapModule,
            searchLocation as searchLocationModule,
            toggleDrawing as toggleDrawingModule,
            clearPolygon as clearPolygonModule,
            loadExistingPolygon as loadExistingPolygonModule
        } from './js/terreni-maps.js';

        import {
            openTerrenoModal as openTerrenoModalModule,
            closeTerrenoModal as closeTerrenoModalModule,
            handleSaveTerreno as handleSaveTerrenoModule,
            editTerreno as editTerrenoModule,
            confirmDeleteTerreno as confirmDeleteTerrenoModule,
            toggleDataScadenzaAffitto as toggleDataScadenzaAffittoModule,
            updateColtureDropdownTerreni as updateColtureDropdownTerreniModule,
            setupColturaColorListener as setupColturaColorListenerModule
        } from './js/terreni-events.js';

        import {
            setupTerreniTourButton as setupTerreniTourButtonModule,
            maybeAutoStartTerreniTour as maybeAutoStartTerreniTourModule,
            startTerreniTour as startTerreniTourModule
        } from './js/terreni-tour.js';

        // Attendi che le configurazioni siano caricate
        await waitForConfigModule();

        const firebaseConfig = window.firebaseConfig;
        const GOOGLE_MAPS_API_KEY = window.GOOGLE_MAPS_API_KEY || 'YOUR_GOOGLE_MAPS_API_KEY_HERE';
        
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { 
            getFirestore, 
            getDoc, 
            doc, 
            collection, 
            addDoc, 
            updateDoc,
            setDoc, 
            deleteDoc, 
            getDocs, 
            query, 
            orderBy, 
            where,
            serverTimestamp,
            Timestamp
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Inizializza Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // ============================================
        // STATE OBJECT
        // ============================================
        const terreniState = {
            // Google Maps
            map: null,
            polygon: null,
            isDrawing: false,
            currentPolygonCoords: [],
            
            // Terreni
            currentTerrenoId: null,
            currentTenantId: null,
            terreni: [],
            terreniFiltrati: [],
            
            // Liste
            poderi: [],
            colture: [],
            categorieColtureTerreni: [],
            colturePerCategoriaTerreni: {},
            
            // Tour
            terreniTourAutoRequested: false,
            terreniTourOpenedModal: false,
            
            // Firebase (riferimenti)
            db,
            auth
        };

        // ============================================
        // VARIABILI GLOBALI (per compatibilit√†)
        // ============================================
        let terreni = [];
        let terreniFiltrati = [];
        let currentTerrenoId = null;
        let map = null;
        let polygon = null;
        let isDrawing = false;
        let currentPolygonCoords = [];
        let currentTenantId = null;
        let colture = []; // Lista colture disponibili
        let poderi = []; // Lista poderi disponibili
        const TERRENI_TOUR_STORAGE_KEY = 'gfv_terreni_tour_v1';
        let terreniTourAutoRequested = false;
        let terreniTourOpenedModal = false;

        // Liste aggiuntive per colture (per compatibilit√† con codice esistente)
        let categorieColtureTerreni = [];
        let colturePerCategoriaTerreni = {};

        // ============================================
        // FUNZIONE UPDATE STATE
        // ============================================
        function updateState(updates) {
            Object.assign(terreniState, updates);
            // Sincronizza con variabili globali per compatibilit√†
            map = terreniState.map;
            polygon = terreniState.polygon;
            isDrawing = terreniState.isDrawing;
            currentPolygonCoords = terreniState.currentPolygonCoords;
            currentTerrenoId = terreniState.currentTerrenoId;
            currentTenantId = terreniState.currentTenantId;
            terreni = terreniState.terreni;
            terreniFiltrati = terreniState.terreniFiltrati;
            poderi = terreniState.poderi;
            colture = terreniState.colture;
            categorieColtureTerreni = terreniState.categorieColtureTerreni;
            colturePerCategoriaTerreni = terreniState.colturePerCategoriaTerreni;
            terreniTourAutoRequested = terreniState.terreniTourAutoRequested;
            terreniTourOpenedModal = terreniState.terreniTourOpenedModal;
        }

        // ============================================
        // WRAPPER FUNCTIONS
        // ============================================

        // Wrapper per waitForConfig (usa quello del modulo)
        async function waitForConfigWrapper() {
            return await waitForConfigModule();
        }

        // Wrapper per getTenantId
        async function getTenantIdWrapper(userId) {
            return await getTenantIdModule(userId, db, terreniState.currentTenantId);
        }

        // Wrapper per getTerreniCollection
        function getTerreniCollectionWrapper(tenantId) {
            return getTerreniCollectionModule(tenantId, db);
        }

        // Wrapper per loadPoderi
        async function loadPoderiWrapper() {
            await loadPoderiModule(terreniState.currentTenantId, db, terreniState.poderi);
            updateState({ poderi: terreniState.poderi });
        }

        // Wrapper per populatePoderiDropdown
        function populatePoderiDropdownWrapper() {
            populatePoderiDropdownModule(terreniState.poderi);
        }

        // Wrapper per loadColture
        async function loadColtureWrapper() {
            await loadColtureModule(
                terreniState.currentTenantId,
                db,
                app,
                auth,
                terreniState.categorieColtureTerreni,
                terreniState.colturePerCategoriaTerreni,
                terreniState.colture
            );
            updateState({
                categorieColtureTerreni: terreniState.categorieColtureTerreni,
                colturePerCategoriaTerreni: terreniState.colturePerCategoriaTerreni,
                colture: terreniState.colture
            });
        }

        // Wrapper per loadTerreni
        async function loadTerreniWrapper() {
            await loadTerreniModule(
                terreniState.currentTenantId,
                auth,
                db,
                app,
                terreniState.terreni,
                terreniState.terreniFiltrati,
                (terreni, terreniFiltrati) => {
                    updateState({ terreni, terreniFiltrati });
                    renderTerreniWrapper(terreni, terreniFiltrati);
                }
            );
        }

        // Variabili globali per moduli
        let hasVignetoModule = false;
        let hasFruttetoModule = false;

        // Verifica moduli attivi (senza dipendenze da firebase-service.js)
        async function checkModules() {
            try {
                if (!terreniState.currentTenantId) {
                    hasVignetoModule = false;
                    hasFruttetoModule = false;
                    return;
                }

                const tenantDoc = await getDoc(doc(db, 'tenants', terreniState.currentTenantId));
                if (!tenantDoc.exists()) {
                    hasVignetoModule = false;
                    hasFruttetoModule = false;
                    return;
                }

                const tenantData = tenantDoc.data();
                const modules = Array.isArray(tenantData?.modules) ? tenantData.modules : [];
                hasVignetoModule = modules.includes('vigneto');
                hasFruttetoModule = modules.includes('frutteto');
            } catch (error) {
                console.warn('Errore verifica moduli:', error);
                hasVignetoModule = false;
                hasFruttetoModule = false;
            }
        }

        // Wrapper per renderTerreni
        function renderTerreniWrapper(terreni, terreniFiltrati) {
            renderTerreniModule(
                terreni || terreniState.terreni,
                terreniFiltrati || terreniState.terreniFiltrati,
                () => maybeAutoStartTerreniTourWrapper(),
                hasVignetoModule,
                hasFruttetoModule
            );
        }

        // Wrapper per filterTerreni
        function filterTerreniWrapper() {
            filterTerreniModule(
                terreniState.terreni,
                terreniState.terreniFiltrati,
                (terreni, terreniFiltrati) => {
                    updateState({ terreniFiltrati });
                    renderTerreniWrapper(terreni, terreniFiltrati);
                }
            );
        }

        // Wrapper per clearFilters
        function clearFiltersWrapper() {
            clearFiltersModule(
                terreniState.terreni,
                terreniState.terreniFiltrati,
                (terreni, terreniFiltrati) => {
                    updateState({ terreniFiltrati });
                    renderTerreniWrapper(terreni, terreniFiltrati);
                }
            );
        }

        // Wrapper per openTerrenoModal
        async function openTerrenoModalWrapper(terrenoId) {
            await openTerrenoModalModule(
                terrenoId,
                terreniState,
                updateState,
                loadColtureWrapper,
                populatePoderiDropdownWrapper,
                updateColtureDropdownTerreniWrapper,
                toggleDataScadenzaAffittoWrapper,
                initMapWrapper,
                loadExistingPolygonWrapper
            );
        }

        // Wrapper per closeTerrenoModal
        function closeTerrenoModalWrapper() {
            closeTerrenoModalModule(terreniState, updateState);
        }

        // Wrapper per handleSaveTerreno
        async function handleSaveTerrenoWrapper(e) {
            await handleSaveTerrenoModule(
                e,
                terreniState,
                updateState,
                getTerreniCollectionWrapper,
                loadTerreniWrapper
            );
        }

        // Wrapper per editTerreno
        function editTerrenoWrapper(terrenoId) {
            editTerrenoModule(terrenoId, openTerrenoModalWrapper);
        }

        // Wrapper per confirmDeleteTerreno
        async function confirmDeleteTerrenoWrapper(terrenoId) {
            await confirmDeleteTerrenoModule(
                terrenoId,
                terreniState,
                getTerreniCollectionWrapper,
                loadTerreniWrapper
            );
        }

        // Wrapper per toggleDataScadenzaAffitto
        function toggleDataScadenzaAffittoWrapper() {
            toggleDataScadenzaAffittoModule();
        }

        // Wrapper per updateColtureDropdownTerreni
        function updateColtureDropdownTerreniWrapper() {
            updateColtureDropdownTerreniModule(terreniState, updateState, getColturaColorUtil);
        }

        // Wrapper per initMap - passa anche una funzione per leggere lo state corrente
        function initMapWrapper() {
            // Passa una funzione getState che legge sempre lo state corrente
            initMapModule(terreniState, updateState, () => terreniState);
        }

        // Wrapper per searchLocation
        function searchLocationWrapper() {
            searchLocationModule(terreniState);
        }

        // Wrapper per toggleDrawing
        function toggleDrawingWrapper() {
            toggleDrawingModule(terreniState, updateState);
        }

        // Wrapper per clearPolygon
        function clearPolygonWrapper() {
            clearPolygonModule(terreniState, updateState);
        }

        // Wrapper per loadExistingPolygon
        function loadExistingPolygonWrapper(polygonCoords) {
            loadExistingPolygonModule(polygonCoords, terreniState, updateState);
        }

        // Wrapper per startTerreniTour
        function startTerreniTourWrapper(triggeredManually) {
            startTerreniTourModule(
                triggeredManually,
                terreniState,
                updateState,
                openTerrenoModalWrapper,
                closeTerrenoModalWrapper
            );
        }

        // Wrapper per maybeAutoStartTerreniTour
        function maybeAutoStartTerreniTourWrapper() {
            maybeAutoStartTerreniTourModule(
                terreniState,
                updateState,
                startTerreniTourWrapper
            );
        }

        // Wrapper per setupTerreniTourButton
        function setupTerreniTourButtonWrapper() {
            setupTerreniTourButtonModule(startTerreniTourWrapper);
        }

        // Funzione per gestire click "Gestisci Vigneto"
        window.gestisciVigneto = async function(terrenoId) {
            try {
                // Verifica moduli
                if (!hasVignetoModule) {
                    await checkModules();
                }

                if (!hasVignetoModule) {
                    alert('Il modulo Vigneto non √® attivo. Attivalo dalla pagina Abbonamento.');
                    window.location.href = './admin/abbonamento-standalone.html';
                    return;
                }

                // Apri pagina vigneti con terrenoId come parametro
                window.location.href = `../modules/vigneto/views/vigneti-standalone.html?terrenoId=${terrenoId}`;
            } catch (error) {
                console.error('Errore apertura gestione vigneto:', error);
                alert('Errore nell\'apertura della gestione vigneto: ' + error.message);
            }
        };

        // Funzione per gestire click "Gestisci Frutteto"
        window.gestisciFrutteto = async function(terrenoId) {
            try {
                // Verifica moduli
                if (!hasFruttetoModule) {
                    await checkModules();
                }

                if (!hasFruttetoModule) {
                    alert('Il modulo Frutteto non √® attivo. Attivalo dalla pagina Abbonamento.');
                    window.location.href = './admin/abbonamento-standalone.html';
                    return;
                }

                // Apri pagina frutteti con terrenoId come parametro
                window.location.href = `../modules/frutteto/views/frutteti-standalone.html?terrenoId=${terrenoId}`;
            } catch (error) {
                console.error('Errore apertura gestione frutteto:', error);
                alert('Errore nell\'apertura della gestione frutteto: ' + error.message);
            }
        };

        // ============================================
        // ESPOSIZIONE FUNZIONI SU WINDOW (per attributi HTML)
        // ============================================
        window.openTerrenoModal = openTerrenoModalWrapper;
        window.closeTerrenoModal = closeTerrenoModalWrapper;
        window.handleSaveTerreno = handleSaveTerrenoWrapper;
        window.editTerreno = editTerrenoWrapper;
        window.confirmDeleteTerreno = confirmDeleteTerrenoWrapper;
        window.toggleDataScadenzaAffitto = toggleDataScadenzaAffittoWrapper;
        window.updateColtureDropdownTerreni = updateColtureDropdownTerreniWrapper;
        window.filterTerreni = filterTerreniWrapper;
        window.clearFilters = clearFiltersWrapper;
        window.initMap = initMapWrapper; // Per callback Google Maps
        window.searchLocation = searchLocationWrapper;
        window.toggleDrawing = toggleDrawingWrapper;
        window.clearPolygon = clearPolygonWrapper;
        window.loadExistingPolygon = loadExistingPolygonWrapper;

        // Setup tour button
        setupTerreniTourButtonWrapper();

        // Carica Google Maps API (con async per migliori performance)
        if (GOOGLE_MAPS_API_KEY && GOOGLE_MAPS_API_KEY !== 'YOUR_GOOGLE_MAPS_API_KEY_HERE') {
            // Carica lo script in modo asincrono
            const script = document.createElement('script');
            script.async = true;
            script.defer = true;
            script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&libraries=geometry&loading=async&callback=initGoogleMaps`;
            document.head.appendChild(script);
            
            window.initGoogleMaps = function() {

                window.googleMapsReady = true;
                
                // Ricalcola superficie per terreni con mappa ma senza superficie salvata
                if (terreni && terreni.length > 0) {
                    terreni.forEach(async (terreno) => {
                        if ((!terreno.superficie || terreno.superficie === 0) && 
                            terreno.polygonCoords && 
                            Array.isArray(terreno.polygonCoords) && 
                            terreno.polygonCoords.length >= 3) {
                            
                            try {
                                const coords = terreno.polygonCoords.map(c => {
                                    if (c.lat && c.lng) {
                                        return new google.maps.LatLng(c.lat, c.lng);
                                    }
                                    return c;
                                });
                                
                                const area = google.maps.geometry.spherical.computeArea(coords);
                                const superficie = area / 10000;
                                
                                if (superficie > 0 && superficie < 10000) {
                                    // Aggiorna terreno in memoria
                                    terreno.superficie = superficie;
                                    
                                    // Salva nel database
                                    try {
                                        const terrenoRef = doc(getTerreniCollectionWrapper(currentTenantId), terreno.id);
                                        await updateDoc(terrenoRef, { 
                                            superficie: parseFloat(superficie.toFixed(2)),
                                            updatedAt: serverTimestamp()
                                        });
                                        
                                        // Aggiorna visualizzazione
                                        renderTerreniWrapper();
                                    } catch (e) {
                                        console.warn('Errore salvataggio superficie:', e);
                                    }
                                }
                            } catch (e) {
                                console.warn('Errore calcolo superficie:', e);
                            }
                        }
                    });
                }
            };
        } else {
            console.warn('‚ö†Ô∏è Google Maps API key non configurata. Le mappe non saranno disponibili.');
        }

        // Funzioni helper rimosse - ora usate dai moduli tramite wrapper

        // Verifica autenticazione
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = './auth/login-standalone.html';
                return;
            }

            try {
                // Carica dati utente e tenant
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    const nomeCompleto = `${userData.nome || ''} ${userData.cognome || ''}`.trim();
                    const email = userData.email || user.email;
                    document.getElementById('user-info').textContent = 
                        `Utente: ${nomeCompleto || 'N/A'} (${email})`;
                    
                    // Salva tenant ID
                    currentTenantId = userData.tenantId;
                    updateState({ currentTenantId });
                    
                    // Imposta tenantId nel tenant-service per i servizi
                    try {
                        const { setCurrentTenantId } = await import('./services/tenant-service.js');
                        setCurrentTenantId(currentTenantId);
                    } catch (error) {
                        console.warn('Impossibile impostare tenantId nel servizio:', error);
                    }
                    
                    // Verifica moduli attivi
                    await checkModules();
                    
                    // Carica dati usando wrapper
                    await loadColtureWrapper();
                    await loadPoderiWrapper();
                    await loadTerreniWrapper();
                    
                    // Setup listener colore coltura
                    setupColturaColorListenerModule(terreniState, getColturaColorUtil);
                    
                    // Mostra link impostazioni solo a Manager/Amministratore
                    const impostazioniLink = document.getElementById('impostazioni-link');
                    if (impostazioniLink) {
                        const ruoli = userData.ruoli || [];
                        const isManager = ruoli.some(r => {
                            const roleLower = r.toLowerCase();
                            return roleLower.includes('manager') || roleLower.includes('amministratore');
                        });
                        if (isManager) {
                            impostazioniLink.style.display = 'inline-flex';
                        }
                    }
                }
            } catch (error) {
                console.error('Errore caricamento utente:', error);
            }

            // Carica colture, poderi e terreni (gi√† fatto sopra in onAuthStateChanged)
        });

        // Logout
        document.getElementById('user-info').parentElement.addEventListener('click', async (e) => {
            if (e.target.id === 'logout-button') {
                await signOut(auth);
                window.location.href = './auth/login-standalone.html';
            }
        });

        // Funzioni loadPoderi e populatePoderiDropdown RIMOSSE - ora usate dai moduli tramite wrapper

        // Funzione initializeColturePredefiniteTerreni RIMOSSA - ora gestita nel modulo terreni-controller.js

        // Funzione loadCategorieColtureTerreni RIMOSSA - ora gestita nel modulo terreni-controller.js

        // Funzione loadColturePerCategoriaTerreni RIMOSSA - ora gestita nel modulo terreni-controller.js

        // Funzioni updateColtureDropdownTerreni, setupColturaColorListener, loadColture RIMOSSE - ora gestite nei moduli

        // Funzione loadTerreni RIMOSSA - ora gestita nel modulo terreni-controller.js

        // Filtra terreni - RIMOSSO: ora usa wrapper filterTerreniWrapper esposto su window.filterTerreni

        // Pulisci filtri - RIMOSSO: ora usa wrapper clearFiltersWrapper esposto su window.clearFilters

        // Funzione renderTerreni RIMOSSA - ora gestita nel modulo terreni-controller.js

        // Funzioni setupTerreniTourButton, maybeAutoStartTerreniTour, startTerreniTour, startTourWithSteps, buildTerreniTourSteps RIMOSSE
        // CODICE RIMOSSO (circa 1000+ righe) - funzioni duplicate ora gestite nel modulo terreni-tour.js

        // Funzioni openTerrenoModal, closeTerrenoModal, handleSaveTerreno, editTerreno, confirmDeleteTerreno, toggleDataScadenzaAffitto RIMOSSE
        // CODICE RIMOSSO - funzioni duplicate ora gestite nei moduli tramite wrapper functions

        // Funzioni calcolaAlertAffitto e formattaDataScadenza RIMOSSE - ora gestite nel modulo terreni-utils.js

        // ========== Google Maps Functions ==========
        
        // Colori per colture (palette colori ottimizzata per visibilit√†)
        const colturaColors = {
            'Vite': { fill: '#DC143C', stroke: '#8B0000' },      // Rosso scuro brillante
            'Frutteto': { fill: '#FF6600', stroke: '#CC5500' },  // Arancione brillante
            'Seminativo': { fill: '#FFD700', stroke: '#B8860B' }, // Giallo oro
            'Orto': { fill: '#00FF00', stroke: '#00AA00' },      // Verde lime brillante
            'Ortive': { fill: '#00FF00', stroke: '#00AA00' },    // Alias per Ortive
            'Prato': { fill: '#90EE90', stroke: '#228B22' },    // Verde chiaro
            'Olivo': { fill: '#9370DB', stroke: '#6A5ACD' },    // Viola medio
            'Agrumeto': { fill: '#FFA500', stroke: '#FF8C00' },  // Arancione
            'Bosco': { fill: '#8B4513', stroke: '#654321' },    // Marrone sella
            'Default': { fill: '#1E90FF', stroke: '#0066CC' }   // Blu dodger (invece di verde)
        };
        
        // Funzione per mappare nome coltura specifico a categoria generica
        function mapColturaToColorCategory(colturaNome, colturaCategoria) {
            if (!colturaNome) return 'Default';
            
            const nomeLower = colturaNome.toLowerCase();
            
            // Match esatto nella palette
            if (colturaColors[colturaNome]) {
                return colturaNome;
            }
            
            // Mapping per Vite (tutte le varianti)
            if (nomeLower.includes('vite') || colturaCategoria?.toLowerCase() === 'vite') {
                return 'Vite';
            }
            
            // Mapping per Frutteto (tutte le varianti)
            if (nomeLower.includes('albicocch') || nomeLower.includes('pesco') || 
                nomeLower.includes('melo') || nomeLower.includes('pero') ||
                nomeLower.includes('ciliegio') || nomeLower.includes('susino') ||
                nomeLower.includes('fico') || nomeLower.includes('nocciolo') ||
                nomeLower.includes('mandorlo') || nomeLower.includes('castagno') ||
                nomeLower.includes('kiwi') || nomeLower.includes('mirtillo') ||
                nomeLower.includes('lampone') || nomeLower.includes('ribes') ||
                nomeLower.includes('mora') || nomeLower.includes('melograno') ||
                nomeLower.includes('noce') || nomeLower.includes('pistacchio') ||
                colturaCategoria?.toLowerCase() === 'frutteto') {
                return 'Frutteto';
            }
            
            // Mapping per Seminativo
            if (nomeLower.includes('grano') || nomeLower.includes('mais') ||
                nomeLower.includes('orzo') || nomeLower.includes('favino') ||
                nomeLower.includes('girasole') || nomeLower.includes('soia') ||
                nomeLower.includes('colza') || nomeLower.includes('avena') ||
                nomeLower.includes('segale') || nomeLower.includes('fava') ||
                nomeLower.includes('lenticchia') || nomeLower.includes('cece') ||
                nomeLower.includes('riso') || nomeLower.includes('quinoa') ||
                nomeLower.includes('canapa') || nomeLower.includes('lino') ||
                nomeLower.includes('erba medica') || nomeLower.includes('trifoglio') ||
                colturaCategoria?.toLowerCase() === 'seminativo') {
                return 'Seminativo';
            }
            
            // Mapping per Ortive/Orto
            if (nomeLower.includes('pomodoro') || nomeLower.includes('zucchin') ||
                nomeLower.includes('melanzan') || nomeLower.includes('peperon') ||
                nomeLower.includes('insalata') || nomeLower.includes('carot') ||
                nomeLower.includes('patat') || nomeLower.includes('bietol') ||
                nomeLower.includes('fragol') || nomeLower.includes('cipoll') ||
                nomeLower.includes('aglio') || nomeLower.includes('fagiol') ||
                nomeLower.includes('pisell') || nomeLower.includes('cavolo') ||
                nomeLower.includes('broccoli') || nomeLower.includes('spinaci') ||
                nomeLower.includes('lattuga') || nomeLower.includes('radicchio') ||
                nomeLower.includes('finocchi') || nomeLower.includes('sedano') ||
                nomeLower.includes('cetriol') || nomeLower.includes('anguria') ||
                nomeLower.includes('melon') || colturaCategoria?.toLowerCase() === 'ortive' ||
                colturaCategoria?.toLowerCase() === 'orto') {
                return 'Orto';
            }
            
            // Mapping per Prato
            if (nomeLower.includes('prato') || nomeLower.includes('pascolo') ||
                colturaCategoria?.toLowerCase() === 'prato') {
                return 'Prato';
            }
            
            // Mapping per Olivo
            if (nomeLower.includes('olivo') || nomeLower.includes('oliveto') ||
                colturaCategoria?.toLowerCase() === 'olivo') {
                return 'Olivo';
            }
            
            // Mapping per Agrumeto
            if (nomeLower.includes('arancio') || nomeLower.includes('limone') ||
                nomeLower.includes('mandarino') || nomeLower.includes('clementin') ||
                nomeLower.includes('pompelmo') || nomeLower.includes('bergamotto') ||
                nomeLower.includes('cedro') || nomeLower.includes('lime') ||
                nomeLower.includes('kumquat') || colturaCategoria?.toLowerCase() === 'agrumeto') {
                return 'Agrumeto';
            }
            
            // Mapping per Bosco
            if (nomeLower.includes('bosco') || nomeLower.includes('foresta') ||
                colturaCategoria?.toLowerCase() === 'bosco') {
                return 'Bosco';
            }
            
            return 'Default';
        }
        
        // Funzione per ottenere colore coltura selezionata
        function getColturaColor() {
            const colturaSelect = document.getElementById('terreno-coltura');
            const colturaCategoriaSelect = document.getElementById('terreno-coltura-categoria');
            const colturaNome = colturaSelect ? colturaSelect.value : null;
            const colturaCategoria = colturaCategoriaSelect ? colturaCategoriaSelect.options[colturaCategoriaSelect.selectedIndex]?.text : null;
            const colorCategory = mapColturaToColorCategory(colturaNome, colturaCategoria);
            const colorData = colturaColors[colorCategory] || colturaColors['Default'];
            return {
                fill: colorData.fill,
                stroke: colorData.stroke
            };
        }
        
        // Inizializza mappa
        window.initMap = function() {
            if (!window.googleMapsReady || !google || !google.maps) {
                document.getElementById('map').innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #f8f9fa; border-radius: 8px; flex-direction: column; padding: 20px;">
                        <h3 style="color: #dc3545; margin-bottom: 15px;">‚ö†Ô∏è Google Maps non disponibile</h3>
                        <p style="color: #666; text-align: center;">
                            Per utilizzare la mappa e il calcolo automatico della superficie,<br>
                            √® necessario configurare una chiave API di Google Maps valida.
                        </p>
                    </div>
                `;
                return;
            }
            
            if (map) return; // Gi√† inizializzata
            
            try {
                const defaultCenter = { lat: 44.4949, lng: 11.3426 }; // Bologna area
                
                map = new google.maps.Map(document.getElementById('map'), {
                    zoom: 15,
                    center: defaultCenter,
                    mapTypeId: google.maps.MapTypeId.SATELLITE
                });

                // Click listener per tracciamento poligono
                map.addListener('click', function(event) {
                    if (isDrawing) {
                        if (!polygon) {
                            const colors = getColturaColor();
                            polygon = new google.maps.Polygon({
                                paths: [event.latLng],
                                fillColor: colors.fill + '80', // Aggiungi trasparenza
                                fillOpacity: 0.35,
                                strokeColor: colors.stroke,    // Usa versione scura per perimetro
                                strokeWeight: 3,               // Aumentato per maggiore visibilit√†
                                strokeOpacity: 1.0,            // Massima visibilit√†
                                clickable: false,
                                editable: true,
                                draggable: true
                            });
                            polygon.setMap(map);
                            currentPolygonCoords = [event.latLng];
                        } else {
                            const path = polygon.getPath();
                            path.push(event.latLng);
                            currentPolygonCoords = path.getArray();
                        }
                        
                        if (currentPolygonCoords.length >= 3) {
                            document.getElementById('map-info').classList.add('active');
                            updateAreaInfo();
                        }
                    }
                });

                // Listener per modifiche poligono
                map.addListener('polygon_changed', function() {
                    if (polygon) {
                        currentPolygonCoords = polygon.getPath().getArray();
                        if (currentPolygonCoords.length >= 3) {
                            updateAreaInfo();
                        }
                    }
                });
            } catch (error) {
                console.error('Errore inizializzazione mappa:', error);
            }
        };

        // Cerca indirizzo
        window.searchLocation = function() {
            if (!map || !google || !google.maps) return;
            
            const geocoder = new google.maps.Geocoder();
            const address = document.getElementById('map-search').value;

            if (!address) {
                showAlertUtil('Inserisci un indirizzo da cercare', 'warning');
                return;
            }

            geocoder.geocode({ address: address }, function(results, status) {
                if (status === 'OK') {
                    map.setCenter(results[0].geometry.location);
                    map.setZoom(18);
                    
                    new google.maps.Marker({
                        map: map,
                        position: results[0].geometry.location,
                        title: address
                    });
                } else {
                    showAlertUtil('Indirizzo non trovato: ' + status, 'error');
                }
            });
        };

        // NOTA: window.toggleDrawing √® gi√† definito sopra (riga 1094) come toggleDrawingWrapper
        // Questa funzione duplicata √® stata rimossa per evitare conflitti

        // Cancella poligono
        window.clearPolygon = function() {
            if (polygon) {
                polygon.setMap(null);
                polygon = null;
                currentPolygonCoords = [];
                document.getElementById('map-info').classList.remove('active');
                document.getElementById('terreno-superficie').value = '';
            }
        };

        // Aggiorna info area
        function updateAreaInfo() {
            if (!polygon || !google || !google.maps) return;
            
            const area = google.maps.geometry.spherical.computeArea(currentPolygonCoords);
            const areaHectares = area / 10000;
            
            document.getElementById('calculated-area').textContent = areaHectares.toFixed(2);
            
            // Aggiorna SEMPRE il campo superficie con il valore calcolato dalla mappa
            if (areaHectares > 0) {
                document.getElementById('terreno-superficie').value = areaHectares.toFixed(2);
                document.getElementById('manual-area').textContent = areaHectares.toFixed(2);
            }
        }

        // Carica poligono esistente
        // Funzione loadExistingPolygon RIMOSSA - ora gestita nel modulo terreni-maps.js
    </script>
    
    <!-- Service Worker Registration for PWA -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // Usa percorso relativo per compatibilit√† con localhost e GitHub Pages
                const swPath = window.location.pathname.includes('/gfv-platform/') 
                    ? '/gfv-platform/service-worker.js' 
                    : '../../service-worker.js';
                navigator.serviceWorker.register(swPath)
                    .then((registration) => {
                        console.log('Service Worker registrato con successo:', registration.scope);
                    })
                    .catch((error) => {
                        console.warn('Registrazione Service Worker fallita (non critico):', error);
                    });
            });
        }
    </script>
</body>
</html>

