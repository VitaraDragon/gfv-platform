<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diario Attivit√† - GFV Platform</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#2E8B57">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(180deg, #B0E0E6 0%, #228B22 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0px 8px 20px rgba(0, 0, 0, 0.15);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(180deg, #2E8B57 0%, #256E4A 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .user-info {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-actions {
            position: absolute;
            top: 20px;
            left: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .user-info span {
            font-size: 0.9em;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .btn-primary:hover {
            background: rgba(255,255,255,0.3);
        }
        
        /* Pulsanti nei modal devono avere sfondo verde, non trasparente */
        .modal .btn-primary {
            background: #2E8B57;
            color: white;
            border: none;
        }
        
        .modal .btn-primary:hover {
            background: #228B22;
        }
        
        .modal .btn-secondary {
            background: #6c757d;
            color: white;
            border: none;
        }
        
        .modal .btn-secondary:hover {
            background: #5a6268;
        }

        .content {
            padding: 30px;
        }

        .actions-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .filters {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 12px;
            font-weight: 600;
            color: #495057;
            margin: 0;
        }

        .filters input,
        .filters select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .filters input[type="date"] {
            min-width: 150px;
        }

        .filters select {
            min-width: 150px;
        }

        .filters input[type="text"] {
            min-width: 200px;
        }

        .filter-range {
            display: flex;
            align-items: flex-end;
            gap: 8px;
        }

        .filter-range-text {
            padding-bottom: 8px;
            color: #666;
            font-size: 14px;
            font-weight: 500;
        }

        .section-header {
            margin-bottom: 20px;
        }

        .section-header h2 {
            color: #2E8B57;
            font-size: 24px;
        }

        /* Attivit√† Table Layout */
        .attivita-table {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-top: 20px;
        }

        .attivita-header {
            background: #f8f9fa;
            color: #000;
            display: grid;
            grid-template-columns: 1.2fr 1.5fr 1.5fr 1.2fr 1fr 1fr 1fr 1fr 1.5fr;
            gap: 15px;
            padding: 15px 20px;
            font-weight: 600;
            font-size: 0.95em;
            text-align: center;
            border-bottom: 2px solid #2E8B57;
        }

        .attivita-row {
            display: grid;
            grid-template-columns: 1.2fr 1.5fr 1.5fr 1.2fr 1fr 1fr 1fr 1fr 1.5fr;
            gap: 15px;
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            align-items: center;
            transition: background-color 0.2s;
            text-align: center;
        }

        .attivita-row:hover {
            background-color: #f8f9fa;
        }

        .attivita-row:last-child {
            border-bottom: none;
        }

        .col-data {
            font-weight: 600;
            color: #007bff;
        }

        .col-terreno {
            text-align: left;
            font-weight: 500;
            color: #28a745;
        }

        .col-tipo-lavoro,
        .col-coltura {
            color: #333;
            font-size: 0.9em;
        }

        .col-orari {
            font-family: 'Courier New', monospace;
            color: #666;
            font-size: 0.9em;
        }

        .col-ore {
            font-weight: bold;
            color: #dc3545;
            font-size: 1em;
        }

        .col-note {
            color: #666;
            font-size: 0.85em;
            text-align: left;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .col-macchina {
            font-size: 0.85em;
            color: #666;
            text-align: left;
            max-width: 150px;
        }

        .col-azioni {
            display: flex;
            gap: 8px;
            justify-content: center;
            align-items: center;
        }

        .lavoro-rapido-card {
            transition: all 0.3s ease;
        }
        
        .lavoro-rapido-card:hover {
            box-shadow: 0 2px 8px rgba(25, 118, 210, 0.2);
        }
        
        .form-rapido-lavoro input,
        .form-rapido-lavoro select,
        .form-rapido-lavoro textarea {
            font-size: 14px;
        }
        
        .form-rapido-lavoro input[type="checkbox"] {
            cursor: pointer;
            accent-color: #1976D2;
        }
        
        .form-rapido-lavoro label {
            font-weight: 500;
        }
        
        .lavoro-completato-card {
            transition: all 0.3s ease;
        }
        
        .lavoro-completato-card:hover {
            box-shadow: 0 2px 8px rgba(25, 118, 210, 0.2);
            background-color: #F5F9FF !important;
        }

        .btn-edit-small, .btn-delete-small {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-edit-small {
            background: #ffc107;
            color: #212529;
        }

        .btn-edit-small:hover {
            background: #e0a800;
            transform: translateY(-1px);
        }

        .btn-delete-small {
            background: #dc3545;
            color: white;
        }

        .btn-delete-small:hover {
            background: #c82333;
            transform: translateY(-1px);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 100%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            padding: 0;
        }
        
        /* Padding per il contenuto del modal (escluso header) */
        .modal-content > form,
        .modal-content > .modal-body {
            padding: 30px;
            padding-bottom: 40px; /* Extra padding per i pulsanti */
        }
        
        /* Assicura che i pulsanti siano sempre visibili */
        .modal-content > form > div:last-child {
            margin-bottom: 0;
            padding-top: 10px;
        }
        
        /* Modal annidato (tipo lavoro, categoria) ha z-index pi√π alto e dimensioni pi√π piccole */
        #tipo-lavoro-modal,
        #categoria-lavoro-modal {
            z-index: 2000;
        }
        
        #tipo-lavoro-modal .modal-content,
        #categoria-lavoro-modal .modal-content {
            max-width: 500px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Assicura che il form nel modal annidato abbia padding e scroll corretti */
        #tipo-lavoro-modal .modal-content > form,
        #categoria-lavoro-modal .modal-content > form {
            padding: 30px;
            padding-bottom: 120px; /* Extra padding per assicurare che i pulsanti siano sempre visibili */
            flex: 1;
            overflow-y: auto;
            display: block; /* Cambia da flex a block per evitare problemi */
        }
        
        /* I pulsanti devono essere sempre visibili */
        #tipo-lavoro-modal .modal-content > form > div:last-child,
        #categoria-lavoro-modal .modal-content > form > div:last-child {
            margin-top: 30px;
            position: relative;
        }

        .modal-header {
            background: linear-gradient(135deg, #2E8B57 0%, #228B22 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 12px 12px 0 0;
        }

        .modal-header h2,
        .modal-header h3 {
            margin: 0;
            font-size: 24px;
        }
        
        .modal-header h3 {
            font-size: 20px;
        }

        .close-modal,
        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 32px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .close-modal:hover,
        .close-btn:hover {
            background: rgba(255,255,255,0.2);
        }
        
        /* Close button per modal senza header verde */
        .modal-header .close-btn {
            color: white;
        }

        .modal-body {
            padding: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #2E8B57;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .ore-nette-display {
            background: #e7f3ff;
            border: 2px solid #007bff;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            margin: 20px 0;
        }

        .ore-nette-display strong {
            font-size: 24px;
            color: #007bff;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 30px;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        @media (max-width: 1200px) {
            .attivita-header, .attivita-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .attivita-header > div, .attivita-row > div {
                text-align: left !important;
                padding: 5px 0;
            }

            .attivita-header > div:before,
            .attivita-row > div:before {
                content: attr(data-label) ": ";
                font-weight: 600;
                color: #666;
            }

            .col-azioni {
                justify-content: flex-start;
            }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
            }

            .user-info {
                position: static;
                margin-top: 15px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .modal-content {
                margin: 10px;
            }
        }
    </style>
    <script>
        // Applica modifiche CSS immediatamente per evitare flash iniziale
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const isContoTerzi = urlParams.get('contoTerzi') === 'true';
            const statoFiltro = urlParams.get('stato');
            
            if (isContoTerzi) {
                // Applica gradiente blu immediatamente (controlla se body esiste)
                if (document.body) {
                    document.body.style.background = 'linear-gradient(180deg, #E3F2FD 0%, #1976D2 100%)';
                } else {
                    // Se body non esiste ancora, aspetta che il DOM sia caricato
                    document.addEventListener('DOMContentLoaded', function() {
                        if (document.body) {
                            document.body.style.background = 'linear-gradient(180deg, #E3F2FD 0%, #1976D2 100%)';
                        }
                    });
                }
                
                // Funzione per applicare modifiche
                function applyContoTerziStyles() {
                    const header = document.getElementById('main-header') || document.querySelector('.header');
                    if (header) {
                        header.style.background = 'linear-gradient(180deg, #1976D2 0%, #1565C0 100%)';
                    }
                    
                    const headerTitle = document.querySelector('.header h1');
                    if (headerTitle) {
                        if (statoFiltro === 'completato') {
                            headerTitle.textContent = '‚úÖ Lavori Completati - Conto Terzi';
                        } else {
                            headerTitle.textContent = 'Diario Attivit√† - Conto Terzi';
                        }
                    }
                    
                    const filterClienteGroup = document.getElementById('filter-cliente-group');
                    if (filterClienteGroup) {
                        filterClienteGroup.style.display = 'block';
                    }
                    
                    // Imposta link dashboard (percorso relativo da core/ a modules/)
                    const dashboardLink = document.getElementById('dashboard-link');
                    if (dashboardLink) {
                        dashboardLink.href = '../modules/conto-terzi/views/conto-terzi-home-standalone.html';
                    }
                }
                
                // Nascondi header e container finch√© non sono pronti
                function hideAndApply() {
                    const header = document.getElementById('main-header') || document.querySelector('.header');
                    const container = document.getElementById('attivita-container');
                    
                    if (header) {
                        // Nascondi header temporaneamente
                        header.style.visibility = 'hidden';
                        // Applica modifiche
                        applyContoTerziStyles();
                        // Mostra header dopo aver applicato le modifiche (dopo un delay maggiore per permettere al callback principale di eseguire)
                        setTimeout(() => {
                            if (header) header.style.visibility = 'visible';
                        }, 200);
                    }
                    if (container) {
                        container.style.visibility = 'hidden';
                    }
                }
                
                // Esegui immediatamente se DOM √® pronto, altrimenti aspetta
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', hideAndApply);
                } else {
                    // DOM gi√† pronto, esegui immediatamente
                    setTimeout(hideAndApply, 0);
                }
            }
        })();
    </script>
</head>
<body>
    <script>
        // Script immediato per nascondere tutto prima del rendering
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const isContoTerzi = urlParams.get('contoTerzi') === 'true';
            
            if (isContoTerzi) {
                // Applica gradiente blu immediatamente (controlla se body esiste)
                if (document.body) {
                    document.body.style.background = 'linear-gradient(180deg, #E3F2FD 0%, #1976D2 100%)';
                } else {
                    // Se body non esiste ancora, aspetta che il DOM sia caricato
                    document.addEventListener('DOMContentLoaded', function() {
                        if (document.body) {
                            document.body.style.background = 'linear-gradient(180deg, #E3F2FD 0%, #1976D2 100%)';
                        }
                    });
                }
                // Nascondi tutto finch√© non √® pronto
                document.body.style.visibility = 'hidden';
            }
        })();
    </script>
    <div class="container">
        <div class="header" id="main-header">
            <h1>üìÖ Diario Attivit√†</h1>
            <p>Registra e gestisci le attivit√† lavorative</p>
            <div class="header-actions">
                <a href="admin/impostazioni-standalone.html" class="btn btn-primary" style="text-decoration: none; display: none; align-items: center; gap: 8px;" id="impostazioni-link">
                    <span>‚öôÔ∏è</span>
                    <span>Impostazioni</span>
                </a>
                <a href="#" id="dashboard-link" class="btn btn-secondary" style="text-decoration: none;">‚Üê Dashboard</a>
            </div>
            <div class="user-info">
                <span id="user-info">Caricamento...</span>
                <button id="logout-button" class="btn btn-primary">Logout</button>
            </div>
        </div>

        <div class="content">
            <div id="alert-container"></div>

            <div class="actions-bar">
                <button class="btn btn-success" onclick="openAttivitaModal()">‚ûï Aggiungi Attivit√†</button>
                
                <div class="filters">
                    <div class="filter-group">
                        <label>Periodo</label>
                        <div class="filter-range">
                            <input type="date" id="filter-data-da" placeholder="Da data">
                            <span class="filter-range-text">a</span>
                            <input type="date" id="filter-data-a" placeholder="A data">
                        </div>
                    </div>
                    
                    <div class="filter-group" id="filter-cliente-group" style="display: none;">
                        <label>Cliente</label>
                        <select id="filter-cliente">
                            <option value="">Tutti i clienti</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>Terreno</label>
                        <select id="filter-terreno">
                            <option value="">Tutti i terreni</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>Tipo Lavoro</label>
                        <select id="filter-tipo-lavoro">
                            <option value="">Tutti i tipi lavoro</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>Coltura</label>
                        <select id="filter-coltura">
                            <option value="">Tutte le colture</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>Cerca Note</label>
                        <input type="text" id="filter-ricerca" placeholder="Cerca nelle note...">
                    </div>
                    
                    <div class="filter-group">
                        <label>&nbsp;</label>
                        <button class="btn btn-secondary" onclick="clearFilters()">Pulisci Filtri</button>
                    </div>
                </div>
            </div>

            <div class="section-header">
                <h2>Le Tue Attivit√†</h2>
            </div>

            <div id="attivita-container" style="display: none;">
                <div class="empty-state">
                    <div class="empty-state-icon">‚è≥</div>
                    <h3>Caricamento attivit√†...</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Attivit√† -->
    <!-- Modal Mappa Zone Lavorate -->
    <div id="mappa-zone-modal" class="modal">
        <div class="modal-content" style="max-width: 90vw; width: 1200px;">
            <div class="modal-header">
                <h2 id="mappa-zone-title">Zone Lavorate</h2>
                <button class="close-modal" onclick="closeMappaZoneModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="mappa-zone-container" style="width: 100%; height: 600px; border-radius: 8px; overflow: hidden; margin-bottom: 15px;"></div>
                <div id="mappa-zone-info" style="padding: 10px; background: #f8f9fa; border-radius: 6px; font-size: 14px; color: #666;"></div>
            </div>
        </div>
    </div>

    <div id="attivita-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Aggiungi Attivit√†</h2>
                <button class="close-modal" onclick="closeAttivitaModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="attivita-form" onsubmit="handleSaveAttivita(event)">
                    <div class="form-group">
                        <label for="attivita-data">Data *</label>
                        <input type="date" id="attivita-data" required max="">
                    </div>

                    <div class="form-group">
                        <label for="attivita-terreno">Terreno *</label>
                        <select id="attivita-terreno" required>
                            <option value="">-- Seleziona terreno --</option>
                        </select>
                    </div>

                    <!-- Sezione Conto Terzi (solo se modalit√† Conto Terzi) -->
                    <div id="attivita-conto-terzi-section" style="display: none; border-top: 2px solid #e9ecef; padding-top: 20px; margin-top: 20px;">
                        <h3 style="margin-bottom: 15px; color: #1976D2; font-size: 18px;">üíº Conto Terzi</h3>
                        
                        <div class="form-group">
                            <label for="attivita-cliente">Cliente *</label>
                            <select id="attivita-cliente" required>
                                <option value="">-- Seleziona cliente --</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="attivita-lavoro">Lavoro *</label>
                            <select id="attivita-lavoro" required>
                                <option value="">-- Seleziona lavoro --</option>
                            </select>
                            <small style="color: #666; font-size: 12px;">Il terreno verr√† precompilato automaticamente dal lavoro selezionato</small>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="attivita-ora-inizio-ct">Ora Inizio *</label>
                                <input type="time" id="attivita-ora-inizio-ct" required value="08:00">
                            </div>
                            <div class="form-group">
                                <label for="attivita-ora-fine-ct">Ora Fine *</label>
                                <input type="time" id="attivita-ora-fine-ct" required value="17:00">
                            </div>
                            <div class="form-group">
                                <label for="attivita-pause-ct">Pause (minuti)</label>
                                <input type="number" id="attivita-pause-ct" min="0" value="60" placeholder="60">
                            </div>
                            <div class="form-group">
                                <label for="attivita-ore-nette-ct">Ore Nette</label>
                                <input type="text" id="attivita-ore-nette-ct" readonly value="8.0" style="background: #f5f5f5; cursor: not-allowed;">
                                <small style="color: #666; font-size: 12px;">Calcolate automaticamente</small>
                            </div>
                        </div>
                    </div>

                    <!-- Struttura gerarchica (quando Macchine o Manodopera attivo) -->
                    <div id="attivita-categoria-group" style="display: none;">
                        <div class="form-group">
                            <label for="attivita-categoria-principale">Categoria Principale Lavoro *</label>
                            <div style="display: flex; gap: 5px;">
                                <select id="attivita-categoria-principale" style="flex: 1;">
                                    <option value="">-- Seleziona categoria principale --</option>
                                </select>
                                <button type="button" class="btn btn-info btn-sm" onclick="openCategoriaLavoroModal()" style="white-space: nowrap;">‚ûï Nuova</button>
                            </div>
                            <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                                Seleziona la categoria funzionale principale del lavoro
                            </small>
                        </div>

                        <div class="form-group" id="attivita-sottocategoria-group" style="display: none;">
                            <label for="attivita-sottocategoria">Sottocategoria</label>
                            <select id="attivita-sottocategoria" style="flex: 1;">
                                <option value="">-- Nessuna sottocategoria --</option>
                            </select>
                            <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                                Sottocategoria specifica (opzionale, se disponibile)
                            </small>
                        </div>

                        <div class="form-group" id="attivita-tipo-lavoro-gerarchico-group" style="display: none;">
                            <label for="attivita-tipo-lavoro-gerarchico">Tipo Lavoro Specifico *</label>
                            <div style="display: flex; gap: 5px;">
                                <select id="attivita-tipo-lavoro-gerarchico" style="flex: 1;">
                                    <option value="">-- Seleziona tipo lavoro --</option>
                                </select>
                                <button type="button" class="btn btn-info btn-sm" onclick="openTipoLavoroModal()" style="white-space: nowrap;">‚ûï Nuovo</button>
                            </div>
                            <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                                Seleziona il tipo specifico di lavoro nella categoria selezionata
                            </small>
                        </div>
                        
                        <div class="form-group">
                            <label for="attivita-coltura-categoria">Categoria Coltura *</label>
                            <select id="attivita-coltura-categoria" onchange="updateColtureDropdownAttivita()">
                                <option value="">-- Seleziona categoria --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="attivita-coltura-gerarchica">Coltura *</label>
                            <select id="attivita-coltura-gerarchica">
                                <option value="">-- Seleziona prima la categoria --</option>
                            </select>
                            <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                                La coltura viene precompilata automaticamente dal terreno selezionato
                            </small>
                        </div>
                    </div>

                    <!-- Lista piatta (solo quando nessun modulo attivo) -->
                    <div id="attivita-tipo-lavoro-piatto-group">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="attivita-tipo-lavoro">Tipo Lavoro *</label>
                                <select id="attivita-tipo-lavoro">
                                    <option value="">-- Seleziona tipo lavoro --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="attivita-coltura">Coltura *</label>
                                <select id="attivita-coltura">
                                    <option value="">-- Seleziona coltura --</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="attivita-orario-inizio">Orario Inizio *</label>
                            <input type="time" id="attivita-orario-inizio" required>
                        </div>
                        <div class="form-group">
                            <label for="attivita-orario-fine">Orario Fine (opzionale)</label>
                            <input type="time" id="attivita-orario-fine">
                            <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">
                                Compila quando finisci l'attivit√† per liberare automaticamente le macchine
                            </small>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="attivita-pause">Pause (minuti) *</label>
                        <input type="number" id="attivita-pause" min="0" value="0" required>
                    </div>

                    <div class="ore-nette-display">
                        <div>Ore Nette Lavorate</div>
                        <strong id="ore-nette-display">0.00</strong> ore
                    </div>

                    <div class="form-group">
                        <label for="attivita-note">Note</label>
                        <textarea id="attivita-note" placeholder="Note aggiuntive sull'attivit√†..."></textarea>
                    </div>

                    <!-- Sezione Macchine (solo se modulo Parco Macchine attivo) -->
                    <div id="attivita-macchine-section" style="display: none; border-top: 2px solid #e9ecef; padding-top: 20px; margin-top: 20px;">
                        <h3 style="margin-bottom: 15px; color: #2E8B57; font-size: 18px;">üöú Macchine Utilizzate</h3>
                        
                        <div class="form-group">
                            <label for="attivita-macchina">Trattore (Opzionale)</label>
                            <select id="attivita-macchina">
                                <option value="">-- Nessun trattore --</option>
                            </select>
                            <small style="color: #666; font-size: 12px;">Seleziona il trattore utilizzato per questa attivit√†</small>
                        </div>

                        <div class="form-group" id="attivita-attrezzo-group" style="display: none;">
                            <label for="attivita-attrezzo">Attrezzo (Opzionale)</label>
                            <select id="attivita-attrezzo">
                                <option value="">-- Nessun attrezzo --</option>
                            </select>
                            <small style="color: #666; font-size: 12px;">Seleziona l'attrezzo utilizzato (compatibile con il trattore selezionato)</small>
                        </div>

                        <div class="form-group" id="attivita-ore-macchina-group" style="display: none;">
                            <label for="attivita-ore-macchina">Ore Macchina</label>
                            <input type="number" id="attivita-ore-macchina" step="0.1" min="0" placeholder="Ore effettive macchina">
                            <small style="color: #666; font-size: 12px;">
                                Ore effettive di utilizzo macchina (default: uguale alle ore lavoratore).
                                <br>Esempio: lavoro durato 9 ore, ma macchina usata solo 7 ore ‚Üí inserisci 7
                            </small>
                            <div id="ore-macchina-display" style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 6px; font-size: 14px; color: #666;">
                                <strong>Ore lavoratore:</strong> <span id="ore-lavoratore-display">0.00</span> ore
                            </div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeAttivitaModal()">Annulla</button>
                        <button type="submit" class="btn btn-success">Salva Attivit√†</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Categoria Lavoro -->
    <div id="categoria-lavoro-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Nuova Categoria Lavoro</h3>
                <button class="close-btn" onclick="closeCategoriaLavoroModal()">&times;</button>
            </div>
            <form id="categoria-lavoro-form" onsubmit="handleSalvaCategoriaLavoro(event)">
                <div class="form-group">
                    <label for="categoria-lavoro-nome">Nome Categoria *</label>
                    <input type="text" id="categoria-lavoro-nome" required placeholder="es. Potatura">
                </div>

                <div class="form-group">
                    <label for="categoria-lavoro-descrizione">Descrizione</label>
                    <textarea id="categoria-lavoro-descrizione" placeholder="Descrizione opzionale della categoria..."></textarea>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">Salva</button>
                    <button type="button" class="btn btn-secondary" onclick="closeCategoriaLavoroModal()">Annulla</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Tipo Lavoro -->
    <div id="tipo-lavoro-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Nuovo Tipo Lavoro</h3>
                <button class="close-btn" onclick="closeTipoLavoroModal()">&times;</button>
            </div>
            <form id="tipo-lavoro-form" onsubmit="handleSalvaTipoLavoro(event)">
                <div class="form-group">
                    <label for="tipo-lavoro-nome">Nome Tipo Lavoro *</label>
                    <input type="text" id="tipo-lavoro-nome" required placeholder="es. Aratura">
                    <small>Nome specifico del tipo di lavoro</small>
                </div>

                <div class="form-group">
                    <label for="tipo-lavoro-categoria">Categoria *</label>
                    <select id="tipo-lavoro-categoria" required>
                        <option value="">-- Seleziona categoria --</option>
                    </select>
                    <small>La categoria selezionata nel form sar√† pre-compilata</small>
                </div>

                <div class="form-group">
                    <label for="tipo-lavoro-descrizione">Descrizione</label>
                    <textarea id="tipo-lavoro-descrizione" placeholder="Descrizione opzionale del tipo lavoro..."></textarea>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">Salva</button>
                    <button type="button" class="btn btn-secondary" onclick="closeTipoLavoroModal()">Annulla</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Load Google Maps config -->
    <script>
        function loadMapsConfig() {
            return new Promise((resolve, reject) => {
                if (typeof window.googleMapsConfig !== 'undefined') {
                    resolve();
                    return;
                }

                const mapsConfigScript = document.createElement('script');
                // Prova prima il file in core/config/, poi quello in core/
                mapsConfigScript.src = 'config/google-maps-config.js';
                
                mapsConfigScript.onload = function() {
                    setTimeout(() => {
                        // Verifica se la config √® stata caricata (pu√≤ essere window.googleMapsConfig o window.GOOGLE_MAPS_API_KEY)
                        if (typeof window.googleMapsConfig !== 'undefined' || typeof window.GOOGLE_MAPS_API_KEY !== 'undefined') {
                            // Se abbiamo solo GOOGLE_MAPS_API_KEY, crea googleMapsConfig
                            if (typeof window.googleMapsConfig === 'undefined' && typeof window.GOOGLE_MAPS_API_KEY !== 'undefined') {
                                window.googleMapsConfig = { apiKey: window.GOOGLE_MAPS_API_KEY };
                            }
                            resolve();
                        } else {
                            loadFallbackMapsConfig().then(resolve).catch(reject);
                        }
                    }, 100);
                };
                
                mapsConfigScript.onerror = function() {
                    // Prova anche il file nella root di core/
                    const altScript = document.createElement('script');
                    altScript.src = 'google-maps-config.js';
                    altScript.onload = function() {
                        setTimeout(() => {
                            if (typeof window.googleMapsConfig !== 'undefined' || typeof window.GOOGLE_MAPS_API_KEY !== 'undefined') {
                                if (typeof window.googleMapsConfig === 'undefined' && typeof window.GOOGLE_MAPS_API_KEY !== 'undefined') {
                                    window.googleMapsConfig = { apiKey: window.GOOGLE_MAPS_API_KEY };
                                }
                                resolve();
                            } else {
                                loadFallbackMapsConfig().then(resolve).catch(reject);
                            }
                        }, 100);
                    };
                    altScript.onerror = function() {
                        loadFallbackMapsConfig().then(resolve).catch(reject);
                    };
                    document.head.appendChild(altScript);
                };
                
                document.head.appendChild(mapsConfigScript);
            });
        }

        function loadFallbackMapsConfig() {
            return new Promise((resolve, reject) => {
                const fallbackScript = document.createElement('script');
                fallbackScript.src = 'https://raw.githubusercontent.com/VitaraDragon/gfv-platform/main/core/config/google-maps-config.js';
                
                fallbackScript.onload = function() {
                    setTimeout(() => {
                        if (typeof window.googleMapsConfig !== 'undefined') {
                            resolve();
                        } else {
                            reject(new Error('Google Maps config not found'));
                        }
                    }, 100);
                };
                
                fallbackScript.onerror = function() {
                    reject(new Error('Failed to load Google Maps config'));
                };
                
                document.head.appendChild(fallbackScript);
            });
        }

        let mapsApiLoaded = false;
        
        function loadGoogleMapsAPI() {
            if (mapsApiLoaded || typeof google !== 'undefined') {
                return Promise.resolve();
            }
            
            return loadMapsConfig().then(() => {
                // Gestisci entrambi i formati: window.googleMapsConfig o window.GOOGLE_MAPS_API_KEY
                let apiKey = null;
                if (window.googleMapsConfig && window.googleMapsConfig.apiKey) {
                    apiKey = window.googleMapsConfig.apiKey;
                } else if (window.GOOGLE_MAPS_API_KEY) {
                    apiKey = window.GOOGLE_MAPS_API_KEY;
                    // Crea googleMapsConfig per compatibilit√†
                    window.googleMapsConfig = { apiKey: apiKey };
                }
                
                if (!apiKey) {
                    console.warn('Google Maps API key non configurata');
                    return Promise.resolve();
                }

                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=geometry`;
                    script.async = true;
                    script.defer = true;
                    script.onload = () => {
                        mapsApiLoaded = true;

                        resolve();
                    };
                    script.onerror = () => {
                        console.error('‚ùå Errore caricamento Google Maps API');
                        reject(new Error('Failed to load Google Maps API'));
                    };
                    document.head.appendChild(script);
                });
            }).catch(error => {
                console.warn('‚ö†Ô∏è Google Maps config non disponibile, continuo senza mappa:', error);
                // Non bloccare l'applicazione se Google Maps non √® disponibile
                return Promise.resolve();
            });
        }
    </script>

    <!-- Load Firebase config from external file -->
    <!-- Fallback: usa raw GitHub se il file locale non √® disponibile (per GitHub Pages) -->
    <script>
        function loadConfig() {
            return new Promise((resolve, reject) => {
                if (typeof window.firebaseConfig !== 'undefined') {
                    resolve();
                    return;
                }

                const configScript = document.createElement('script');
                configScript.src = 'config/firebase-config.js';
                
                configScript.onload = function() {
                    setTimeout(() => {
                        if (typeof window.firebaseConfig !== 'undefined') {
                            resolve();
                        } else {
                            loadFallbackConfig().then(resolve).catch(reject);
                        }
                    }, 100);
                };
                
                configScript.onerror = function() {
                    loadFallbackConfig().then(resolve).catch(reject);
                };
                
                document.head.appendChild(configScript);
            });
        }

        function loadFallbackConfig() {
            return new Promise((resolve, reject) => {
                const fallbackScript = document.createElement('script');
                fallbackScript.src = 'https://raw.githubusercontent.com/VitaraDragon/gfv-platform/main/core/config/firebase-config.js';
                
                fallbackScript.onload = function() {
                    setTimeout(() => {
                        if (typeof window.firebaseConfig !== 'undefined') {
                            resolve();
                        } else {
                            reject(new Error('Firebase config not found even after loading from GitHub'));
                        }
                    }, 100);
                };
                
                fallbackScript.onerror = function() {
                    reject(new Error('Failed to load Firebase config from GitHub'));
                };
                
                document.head.appendChild(fallbackScript);
            });
        }

        loadConfig().catch(error => {
            console.error('Errore caricamento config:', error);
        });
    </script>
    
    <!-- Firebase SDK -->
    <script type="module">
        // Attendi che lo script config sia caricato
        await waitForConfigModule();

        const firebaseConfig = window.firebaseConfig;

        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { 
            getFirestore, 
            collection, 
            doc, 
            getDoc, 
            getDocs, 
            addDoc, 
            updateDoc, 
            deleteDoc, 
            query, 
            orderBy, 
            where, 
            serverTimestamp 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // ============================================
        // IMPORT MODULI (prima di tutto)
        // ============================================
        import { 
            waitForConfig as waitForConfigModule,
            getTenantId as getTenantIdModule,
            getAttivitaCollection as getAttivitaCollectionModule,
            getTerreniCollection as getTerreniCollectionModule,
            generaVoceDiarioContoTerzi as generaVoceDiarioContoTerziModule,
            updateMacchinaStato as updateMacchinaStatoModule,
            verificaConflittiMacchine as verificaConflittiMacchineModule,
            liberaMacchineAttivitaPrecedenti as liberaMacchineAttivitaPrecedentiModule,
            loadMacchine as loadMacchineModule,
            populateTrattoriDropdown as populateTrattoriDropdownModule,
            populateAttrezziDropdown as populateAttrezziDropdownModule,
            loadTerreni as loadTerreniModule,
            loadLavoriContoTerzi as loadLavoriContoTerziModule,
            loadClienti as loadClientiModule,
            loadAttivita as loadAttivitaModule,
            populateLavoriDropdown as populateLavoriDropdownModule,
            populateClientiDropdown as populateClientiDropdownModule,
            populateColtureFromTerreni as populateColtureFromTerreniModule,
            updateColtureDropdownAttivita as updateColtureDropdownAttivitaModule,
            populateSottocategorieLavoro as populateSottocategorieLavoroModule,
            populateCategoriaLavoroDropdown as populateCategoriaLavoroDropdownModule,
            populateTipoLavoroDropdown as populateTipoLavoroDropdownModule,
            renderAttivita as renderAttivitaModule,
            caricaDettagliLavoriCompletati as caricaDettagliLavoriCompletatiModule,
            loadListe as loadListeModule,
            loadCategorieLavori as loadCategorieLavoriModule,
            loadTipiLavoro as loadTipiLavoroModule
        } from './js/attivita-controller.js';

        import {
            showAlert as showAlertUtil,
            escapeHtml as escapeHtmlUtil,
            formatOreNette as formatOreNetteUtil,
            calculateOreNette as calculateOreNetteUtil,
            updateOreNette as updateOreNetteUtil,
            updateOreMacchinaDisplay as updateOreMacchinaDisplayUtil,
            updateOreNetteContoTerzi as updateOreNetteContoTerziUtil,
            initCalcoloOreNetteRapido as initCalcoloOreNetteRapidoUtil
        } from './js/attivita-utils.js';

        import {
            applyFilters as applyFiltersModule,
            clearFilters as clearFiltersModule,
            applyContoTerziFilter as applyContoTerziFilterModule,
            closeAttivitaModal as closeAttivitaModalModule,
            editAttivita as editAttivitaModule,
            confirmDeleteAttivita as confirmDeleteAttivitaModule,
            toggleFormRapido as toggleFormRapidoModule,
            setupCategoriaLavoroHandler as setupCategoriaLavoroHandlerModule,
            openAttivitaModal as openAttivitaModalModule,
            handleSaveAttivita as handleSaveAttivitaModule,
            salvaAttivitaRapida as salvaAttivitaRapidaModule,
            openCategoriaLavoroModal as openCategoriaLavoroModalModule,
            closeCategoriaLavoroModal as closeCategoriaLavoroModalModule,
            handleSalvaCategoriaLavoro as handleSalvaCategoriaLavoroModule,
            openTipoLavoroModal as openTipoLavoroModalModule,
            closeTipoLavoroModal as closeTipoLavoroModalModule,
            handleSalvaTipoLavoro as handleSalvaTipoLavoroModule
        } from './js/attivita-events.js';

        import {
            mostraMappaZonaLavorata as mostraMappaZonaLavorataModule,
            closeMappaZoneModal as closeMappaZoneModalModule
        } from './js/attivita-maps.js';
        
        // Import service unificato macchine (solo se modulo attivo)
        let macchineUtilizzoService = null;
        if (typeof window !== 'undefined') {
            // Carica service dinamicamente quando necessario
            window.loadMacchineUtilizzoService = async function() {
                if (!macchineUtilizzoService) {
                    // Verifica se siamo in ambiente file:// (non supportato per moduli ES6)
                    const isFileProtocol = window.location.protocol === 'file:';
                    if (isFileProtocol) {
                        // In ambiente file://, i moduli ES6 non funzionano a causa di CORS
                        // L'applicazione continuer√† a funzionare ma senza le funzionalit√† avanzate del service

                        return null;
                    }
                    
                    try {
                        const module = await import('../../modules/parco-macchine/services/macchine-utilizzo-service.js');
                        macchineUtilizzoService = module;
                        return module;
                    } catch (error) {
                        // Errore gi√† gestito, non loggare se √® un errore CORS in ambiente file://
                        if (!isFileProtocol) {
                            console.warn('Errore caricamento service macchine:', error);
                        }
                        return null;
                    }
                }
                return macchineUtilizzoService;
            };
        }

        // Inizializza Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Variabili globali
        let attivita = [];
        let terreni = [];
        let tipiLavoro = [];
        let colture = [];
        let currentAttivitaId = null;
        let currentTenantId = null;
        let filteredAttivita = [];
        let macchineList = [];
        let hasParcoMacchineModule = false;
        let hasManodoperaModule = false;
        let hasContoTerziModule = false;
        let isContoTerziMode = false; // Modalit√† Conto Terzi (filtro su lavori conto terzi)
        let lavoriList = []; // Lista lavori per filtrare in modalit√† Conto Terzi
        let clientiList = []; // Lista clienti per dropdown
        
        // Variabili per struttura gerarchica (quando Macchine o Manodopera attivo)
        let categorieLavoriPrincipali = [];
        let sottocategorieLavoriMap = new Map();
        let tipiLavoroList = [];

        // Funzione helper: ottieni tenant ID (wrapper)
        async function getTenantId(userId) {
            const result = await getTenantIdModule(userId, db, currentTenantId);
            if (result) currentTenantId = result;
            return result;
        }

        // Funzione helper: ottieni collection (wrapper)
        async function getAttivitaCollection(tenantId) {
            return await getAttivitaCollectionModule(tenantId, db);
        }

        async function getTerreniCollection(tenantId) {
            return await getTerreniCollectionModule(tenantId, db);
        }

        /**
         * Genera automaticamente una voce diario quando un lavoro conto terzi viene completato - wrapper
         * @param {string} lavoroId - ID del lavoro completato
         * @param {Object} lavoroData - Dati del lavoro completato
         * @param {Object} orariOpzionali - Orari opzionali dalla attivit√† appena salvata {orarioInizio, orarioFine, pauseMinuti, oreNette}
         */
        async function generaVoceDiarioContoTerzi(lavoroId, lavoroData, orariOpzionali = null) {
            await generaVoceDiarioContoTerziModule(
                lavoroId,
                lavoroData,
                orariOpzionali,
                currentTenantId,
                db,
                currentUserData,
                hasContoTerziModule
            );
        }

        // Aggiorna stato macchina (disponibile/in_uso) - wrapper
        async function updateMacchinaStato(macchinaId, nuovoStato) {
            await updateMacchinaStatoModule(macchinaId, nuovoStato, currentTenantId, db);
        }

        // Verifica conflitti di orario per macchine/attrezzi - wrapper
        function verificaConflittiMacchine(macchinaId, attrezzoId, data, orarioInizio, orarioFine, attivitaIdEsclusa = null) {
            return verificaConflittiMacchineModule(
                macchinaId,
                attrezzoId,
                data,
                orarioInizio,
                orarioFine,
                attivitaIdEsclusa,
                attivita,
                macchineList
            );
        }

        // Verifica autenticazione
        let currentUserData = null;
        
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = './auth/login-standalone.html';
                return;
            }

            // Rileva parametri URL per modalit√† Conto Terzi
            const urlParams = new URLSearchParams(window.location.search);
            isContoTerziMode = urlParams.get('contoTerzi') === 'true';
            const statoFiltro = urlParams.get('stato'); // es: in_corso

            // Applica gradiente blu se modalit√† Conto Terzi (sempre blu per coerenza)
            if (isContoTerziMode) {
                const urlParams = new URLSearchParams(window.location.search);
                const statoFiltro = urlParams.get('stato');
                
                // Sempre gradiente blu per coerenza con modulo conto terzi
                document.body.style.background = 'linear-gradient(180deg, #E3F2FD 0%, #1976D2 100%)';
                
                const header = document.getElementById('main-header') || document.querySelector('.header');
                if (header) {
                    // Sempre gradiente blu per coerenza con modulo conto terzi
                    header.style.background = 'linear-gradient(180deg, #1976D2 0%, #1565C0 100%)';
                    // Assicurati che l'header sia visibile
                    header.style.visibility = 'visible';
                }
                
                // Modifica titolo header
                const headerTitle = document.querySelector('.header h1');
                if (headerTitle) {
                    if (statoFiltro === 'completato') {
                        headerTitle.textContent = '‚úÖ Lavori Completati - Conto Terzi';
                    } else {
                        headerTitle.textContent = 'Diario Attivit√† - Conto Terzi';
                    }
                }
                
                // Mostra filtro cliente se modalit√† conto terzi
                const filterClienteGroup = document.getElementById('filter-cliente-group');
                if (filterClienteGroup) {
                    filterClienteGroup.style.display = 'block';
                }
                
                // Imposta link dashboard corretto (percorso relativo da core/ a modules/)
                const dashboardLink = document.getElementById('dashboard-link');
                if (dashboardLink) {
                    dashboardLink.href = '../modules/conto-terzi/views/conto-terzi-home-standalone.html';
                }
            } else {
                // Modalit√† normale, nascondi filtro cliente e link alla dashboard principale
                const filterClienteGroup = document.getElementById('filter-cliente-group');
                if (filterClienteGroup) {
                    filterClienteGroup.style.display = 'none';
                }
                
                const dashboardLink = document.getElementById('dashboard-link');
                if (dashboardLink) {
                    dashboardLink.href = 'dashboard-standalone.html';
                }
            }

            try {
                // Carica dati utente e tenant
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    currentUserData = { id: user.uid, ...userData };
                    const nomeCompleto = `${userData.nome || ''} ${userData.cognome || ''}`.trim();
                    const email = userData.email || user.email;
                    document.getElementById('user-info').textContent = 
                        `Utente: ${nomeCompleto || 'N/A'} (${email})`;
                    
                    currentTenantId = userData.tenantId;
                    
                    // Imposta tenantId nel tenant-service per i servizi
                    try {
                        const { setCurrentTenantId } = await import('./services/tenant-service.js');
                        setCurrentTenantId(currentTenantId);
                    } catch (error) {
                        console.warn('Impossibile impostare tenantId nel servizio:', error);
                    }
                    
                    // Mostra link impostazioni solo a Manager/Amministratore
                    const impostazioniLink = document.getElementById('impostazioni-link');
                    if (impostazioniLink) {
                        const ruoli = userData.ruoli || [];
                        const isManager = ruoli.some(r => {
                            const roleLower = r.toLowerCase();
                            return roleLower.includes('manager') || roleLower.includes('amministratore');
                        });
                        if (isManager) {
                            impostazioniLink.style.display = 'inline-flex';
                        }
                    }
                    
                    // Assicura che Firebase sia inizializzato nei servizi
                    try {
                        const { setFirebaseInstances } = await import('./services/firebase-service.js');
                        setFirebaseInstances({ app, db, auth });
                    } catch (error) {
                        console.warn('Impossibile impostare Firebase instances nel servizio:', error);
                    }
                }
            } catch (error) {
                console.error('Errore caricamento utente:', error);
            }

            // Imposta max date a oggi
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('attivita-data').max = today;

            // Verifica moduli attivi
            try {
                if (currentTenantId) {
                    const tenantDoc = await getDoc(doc(db, 'tenants', currentTenantId));
                    if (tenantDoc.exists()) {
                        const tenantData = tenantDoc.data();
                        hasParcoMacchineModule = tenantData.modules && tenantData.modules.includes('parcoMacchine');
                        hasManodoperaModule = tenantData.modules && tenantData.modules.includes('manodopera');
                        hasContoTerziModule = tenantData.modules && tenantData.modules.includes('contoTerzi');
                        
                        // Mostra/nascondi sezione macchine
                        const macchineSection = document.getElementById('attivita-macchine-section');
                        if (macchineSection) {
                            macchineSection.style.display = hasParcoMacchineModule ? 'block' : 'none';
                        }
                        
                        // Mostra/nascondi struttura gerarchica o lista piatta
                        // SEMPRE usa struttura gerarchica (come per le colture)
                        const categoriaGroup = document.getElementById('attivita-categoria-group');
                        const tipoLavoroPiattoGroup = document.getElementById('attivita-tipo-lavoro-piatto-group');
                        const tipoLavoroSelect = document.getElementById('attivita-tipo-lavoro');
                        const tipoLavoroGerarchicoSelect = document.getElementById('attivita-tipo-lavoro-gerarchico');
                        
                        // Usa sempre struttura gerarchica (coerente con colture)
                        const usaStrutturaGerarchica = true;
                        
                        if (categoriaGroup) {
                            categoriaGroup.style.display = 'block';
                        }
                        if (tipoLavoroPiattoGroup) {
                            tipoLavoroPiattoGroup.style.display = 'none';
                        }
                        
                        // Imposta required su struttura gerarchica
                        if (tipoLavoroSelect) {
                            tipoLavoroSelect.removeAttribute('required');
                        }
                        if (tipoLavoroGerarchicoSelect) {
                            tipoLavoroGerarchicoSelect.setAttribute('required', 'required');
                        }
                        
                        // Imposta required su categoria principale
                        const categoriaPrincipaleSelect = document.getElementById('attivita-categoria-principale');
                        if (categoriaPrincipaleSelect) {
                            categoriaPrincipaleSelect.setAttribute('required', 'required');
                        }
                        
                        // Imposta required su coltura gerarchica (non lista piatta)
                        const colturaSelect = document.getElementById('attivita-coltura');
                        const colturaGerarchicaSelect = document.getElementById('attivita-coltura-gerarchica');
                        if (colturaSelect) {
                            colturaSelect.removeAttribute('required');
                        }
                        if (colturaGerarchicaSelect) {
                            colturaGerarchicaSelect.setAttribute('required', 'required');
                        }
                    }
                }
            } catch (error) {
                console.warn('Errore verifica moduli:', error);
            }

            // Carica dati
            const loadPromises = [loadTerreni(), loadListe(), loadAttivita()];
            if (hasParcoMacchineModule) {
                loadPromises.push(loadMacchine());
            }
            
            // Carica sempre categorie lavori per popolare i filtri (anche se non ci sono tipi lavoro)
            loadPromises.push(loadCategorieLavori());
            
            // Se modalit√† Conto Terzi, carica lavori e clienti
            if (isContoTerziMode) {
                loadPromises.push(loadLavoriContoTerzi(), loadClienti());
            }
            
            await Promise.all(loadPromises);
            
            // Popola filtri dopo che tutto √® stato caricato
            populateFiltroColture();
            populateFiltroTipoLavoro();
            
            // Mostra/nascondi sezione Conto Terzi e orari
            const contoTerziSection = document.getElementById('attivita-conto-terzi-section');
            const orariSection = document.querySelector('.form-row:has(#attivita-orario-inizio)');
            const pauseSection = document.querySelector('.form-group:has(#attivita-pause)');
            const oreNetteDisplay = document.querySelector('.ore-nette-display');
            
            if (isContoTerziMode) {
                // Mostra sezione Conto Terzi
                if (contoTerziSection) {
                    contoTerziSection.style.display = 'block';
                }
                // Mostra orari e pause (stesso sistema del diario normale)
                // Gli orari sono nella sezione Conto Terzi con ID diversi
                // Rimuovi required da orario inizio
                const orarioInizio = document.getElementById('attivita-orario-inizio');
                if (orarioInizio) {
                    orarioInizio.removeAttribute('required');
                }
            } else {
                // Nascondi sezione Conto Terzi
                if (contoTerziSection) {
                    contoTerziSection.style.display = 'none';
                }
                // Rimuovi required dai campi Conto Terzi quando nascosti
                const clienteSelect = document.getElementById('attivita-cliente');
                const lavoroSelect = document.getElementById('attivita-lavoro');
                const oraInizioCT = document.getElementById('attivita-ora-inizio-ct');
                const oraFineCT = document.getElementById('attivita-ora-fine-ct');
                
                if (clienteSelect) clienteSelect.removeAttribute('required');
                if (lavoroSelect) lavoroSelect.removeAttribute('required');
                if (oraInizioCT) oraInizioCT.removeAttribute('required');
                if (oraFineCT) oraFineCT.removeAttribute('required');
                
                // Mostra orari e pause
                if (orariSection) {
                    orariSection.style.display = 'flex';
                }
                if (pauseSection) {
                    pauseSection.style.display = 'block';
                }
                if (oreNetteDisplay) {
                    oreNetteDisplay.style.display = 'block';
                }
            }
            
            // Se modalit√† Conto Terzi, riaggiungi required ai campi
            if (isContoTerziMode) {
                const clienteSelect = document.getElementById('attivita-cliente');
                const lavoroSelect = document.getElementById('attivita-lavoro');
                const oraInizioCT = document.getElementById('attivita-ora-inizio-ct');
                const oraFineCT = document.getElementById('attivita-ora-fine-ct');
                
                if (clienteSelect) clienteSelect.setAttribute('required', 'required');
                if (lavoroSelect) lavoroSelect.setAttribute('required', 'required');
                if (oraInizioCT) oraInizioCT.setAttribute('required', 'required');
                if (oraFineCT) oraFineCT.setAttribute('required', 'required');
            }

            // Nascondi container inizialmente se modalit√† conto terzi per evitare flash
            if (isContoTerziMode) {
                const container = document.getElementById('attivita-container');
                if (container) {
                    container.style.display = 'none';
                }
            }
            
            // Applica filtro automatico su lavori conto terzi se specificato
            if (isContoTerziMode && statoFiltro) {
                // Filtra automaticamente le attivit√† per lavori conto terzi con stato specificato
                setTimeout(() => {
                    applyContoTerziFilter(statoFiltro);
                    // Mostra container dopo aver applicato il filtro
                    const container = document.getElementById('attivita-container');
                    if (container) {
                        container.style.display = 'block';
                        container.style.visibility = 'visible';
                    }
                    // Assicurati che l'header sia visibile
                    const header = document.getElementById('main-header') || document.querySelector('.header');
                    if (header) {
                        header.style.visibility = 'visible';
                    }
                    // Mostra il body solo quando tutto √® pronto
                    document.body.style.visibility = 'visible';
                }, 150);
            } else if (isContoTerziMode) {
                // Se modalit√† conto terzi ma senza stato filtro, mostra solo attivit√† conto terzi
                filteredAttivita = attivita.filter(a => a.clienteId != null && a.clienteId !== '');
                renderAttivita();
                const container = document.getElementById('attivita-container');
                if (container) {
                    container.style.display = 'block';
                    container.style.visibility = 'visible';
                }
                // Mostra il body quando tutto √® pronto
                document.body.style.visibility = 'visible';
            } else {
                // Modalit√† normale, mostra container
                const container = document.getElementById('attivita-container');
                if (container) {
                    container.style.display = 'block';
                    container.style.visibility = 'visible';
                }
            }
            
            // Libera macchine di attivit√† del giorno precedente senza orario fine
            if (hasParcoMacchineModule) {
                await liberaMacchineAttivitaPrecedenti();
            }
            
            // Inizializza handler per struttura gerarchica (sempre attiva)
            setupCategoriaLavoroHandler();
        });

        // Logout
        document.getElementById('logout-button').addEventListener('click', async () => {
            await signOut(auth);
            window.location.href = './auth/login-standalone.html';
        });

        // Carica macchine (solo se modulo Parco Macchine attivo) - wrapper
        async function loadMacchine() {
            await loadMacchineModule(
                currentTenantId,
                db,
                app,
                auth,
                hasParcoMacchineModule,
                macchineList,
                () => populateTrattoriDropdown()
            );
        }

        // Popola dropdown trattori - wrapper
        // Accetta macchineList come primo parametro (opzionale) o selectedTrattoreId come secondo
        function populateTrattoriDropdown(macchineListParam = null, selectedTrattoreId = null) {
            // Se il primo parametro √® una stringa (ID), √® selectedTrattoreId
            // Se √® un array, √® macchineList
            let actualMacchineList = macchineList;
            let actualSelectedTrattoreId = selectedTrattoreId;
            
            if (Array.isArray(macchineListParam)) {
                actualMacchineList = macchineListParam;
            } else if (typeof macchineListParam === 'string') {
                // Il primo parametro √® selectedTrattoreId
                actualSelectedTrattoreId = macchineListParam;
            }
            
            populateTrattoriDropdownModule(actualMacchineList, actualSelectedTrattoreId);
        }
        
        // Funzione inline originale rimossa - usa populateTrattoriDropdownModule
        function populateTrattoriDropdownOriginal(selectedTrattoreId = null) {
            const select = document.getElementById('attivita-macchina');
            if (!select) {
                console.warn('Dropdown attivita-macchina non trovato');
                return;
            }
            
            // Pulisci opzioni esistenti (mantieni solo la prima opzione vuota)
            while (select.options.length > 1) {
                select.remove(1);
            }
            
            if (!macchineList || macchineList.length === 0) {
                console.warn('Nessuna macchina disponibile nella lista');
                return;
            }
            
            // Filtra e ordina trattori (escludi solo quelli dismessi)
            const trattori = macchineList
                .filter(macchina => {
                    const tipoMacchina = macchina.tipoMacchina || macchina.tipo;
                    return tipoMacchina === 'trattore' && macchina.stato !== 'dismesso';
                })
                .sort((a, b) => {
                    const nomeA = (a.nome || '').toLowerCase();
                    const nomeB = (b.nome || '').toLowerCase();
                    return nomeA.localeCompare(nomeB);
                });
            
            // Aggiungi trattori al dropdown
            trattori.forEach(macchina => {
                const option = document.createElement('option');
                option.value = macchina.id;
                const nome = macchina.nome || 'Trattore senza nome';
                const cavalli = macchina.cavalli ? ` (${macchina.cavalli} CV)` : '';
                const stato = macchina.stato === 'disponibile' ? '‚úÖ' : 
                             macchina.stato === 'in_uso' ? 'üîÑ' : 
                             macchina.stato === 'in_manutenzione' ? 'üîß' : 
                             macchina.stato === 'guasto' ? '‚ùå' : '';
                option.textContent = `${stato} ${nome}${cavalli}`;
                // NON disabilitiamo i trattori in_uso: il controllo di conflitto al salvataggio gestir√† tutto
                // Questo permette di selezionare trattori anche se sono in_uso per altre attivit√† in orari diversi
                option.disabled = false;
                if (macchina.id === selectedTrattoreId) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }

        // Popola dropdown attrezzi compatibili con trattore selezionato - wrapper
        function populateAttrezziDropdown(trattoreId, selectedAttrezzoId = null) {
            populateAttrezziDropdownModule(trattoreId, macchineList, selectedAttrezzoId);
        }

        // Carica terreni - wrapper
        async function loadTerreni() {
            await loadTerreniModule(
                currentTenantId,
                db,
                app,
                auth,
                terreni,
                isContoTerziMode,
                populateColtureFromTerreni
            );
        }
        
        // Carica lavori conto terzi (solo se modalit√† Conto Terzi) - wrapper
        async function loadLavoriContoTerzi() {
            await loadLavoriContoTerziModule(
                currentTenantId,
                db,
                isContoTerziMode,
                lavoriList,
                populateLavoriDropdown
            );
        }

        // Carica clienti (solo se modalit√† Conto Terzi) - wrapper
        async function loadClienti() {
            await loadClientiModule(
                currentTenantId,
                db,
                isContoTerziMode,
                clientiList,
                populateClientiDropdown
            );
        }

        // Popola dropdown lavori nel form (solo lavori conto terzi in corso) - wrapper
        function populateLavoriDropdown() {
            populateLavoriDropdownModule(lavoriList);
        }

        // Popola dropdown clienti nel form - wrapper
        function populateClientiDropdown() {
            populateClientiDropdownModule(clientiList);
        }

        // Applica filtro automatico su attivit√† per lavori conto terzi - wrapper
        function applyContoTerziFilter(statoFiltro) {
            applyContoTerziFilterModule(
                statoFiltro,
                attivita,
                filteredAttivita,
                lavoriList,
                renderAttivita
            );
        }
        
        // Popola dropdown colture estraendole dai terreni esistenti - wrapper
        function populateColtureFromTerreni() {
            populateColtureFromTerreniModule(terreni);
        }

        // Carica liste personalizzate (tipi lavoro e colture) - wrapper
        async function loadListe() {
            await loadListeModule({
                currentTenantId,
                db,
                app,
                auth,
                collection,
                getDocs,
                query,
                orderBy,
                doc,
                getDoc,
                updateTipiLavoro: (val) => { tipiLavoro = val; },
                updateColture: (val) => { colture = val; },
                updateColturePerCategoria: (val) => { window.colturePerCategoriaAttivita = val; },
                updateCategorieColture: (val) => { window.categorieColture = val; },
                loadCategorieLavoriCallback: loadCategorieLavori,
                loadTipiLavoroCallback: loadTipiLavoro,
                populateFiltroTipoLavoroCallback: populateFiltroTipoLavoro,
                populateFiltroColtureCallback: populateFiltroColture,
                updateColtureDropdownAttivitaCallback: updateColtureDropdownAttivita,
                getTipiLavoro: () => tipiLavoro,
                getColture: () => colture
            });
        }

        // Carica categorie lavori principali e sottocategorie - wrapper
        async function loadCategorieLavori() {
            const categorie = await loadCategorieLavoriModule({
                currentTenantId,
                db,
                app,
                auth,
                collection,
                getDocs,
                query,
                orderBy,
                updateCategorieLavoriPrincipali: (val) => { categorieLavoriPrincipali = val; },
                updateSottocategorieLavoriMap: (val) => { sottocategorieLavoriMap = val; },
                populateCategoriaLavoroDropdownCallback: populateCategoriaLavoroDropdown,
                populateFiltroTipoLavoroCallback: populateFiltroTipoLavoro
            });
            return categorie; // Restituisci le categorie caricate
        }

        // Carica tipi lavoro (filtrati per categoria se specificata) - wrapper
        async function loadTipiLavoro(categoriaId = null) {
            await loadTipiLavoroModule({
                currentTenantId,
                categoriaId,
                db,
                app,
                auth,
                collection,
                getDocs,
                query,
                orderBy,
                categorieLavoriPrincipali,
                sottocategorieLavoriMap,
                updateTipiLavoroList: (val) => { tipiLavoroList = val; },
                populateTipoLavoroDropdownCallback: (catId, selectedValue, tipiFiltrati) => {
                    populateTipoLavoroDropdown(catId, selectedValue, tipiFiltrati);
                }
            });
        }

        // Funzione inline rimossa - ora in attivita-controller.js
        // Le funzioni loadListe(), loadCategorieLavori(), loadTipiLavoro() sono state estratte nel controller
        // Usa i wrapper sopra che chiamano loadListeModule, loadCategorieLavoriModule, loadTipiLavoroModule
        // Le funzioni originali sono state rimosse completamente
        
        // Popola filtro tipo lavoro con categorie
        function populateFiltroTipoLavoro() {
            const filterTipoLavoroSelect = document.getElementById('filter-tipo-lavoro');
            if (!filterTipoLavoroSelect) return;
            
            filterTipoLavoroSelect.innerHTML = '<option value="">Tutte le categorie lavoro</option>';
            
            // Se categorie non ancora caricate, usa fallback
            if (categorieLavoriPrincipali.length === 0) {
                const categorieFallback = [
                    'Lavorazione del Terreno',
                    'Trattamenti',
                    'Potatura',
                    'Raccolta',
                    'Gestione del Verde',
                    'Diserbo',
                    'Semina e Piantagione',
                    'Manutenzione',
                    'Altro'
                ];
                categorieFallback.forEach(categoria => {
                    const option = document.createElement('option');
                    option.value = categoria;
                    option.textContent = categoria;
                    filterTipoLavoroSelect.appendChild(option);
                });
            } else {
                // Popola con categorie lavori principali
                categorieLavoriPrincipali.forEach(categoria => {
                    const option = document.createElement('option');
                    option.value = categoria.nome;
                    option.textContent = categoria.nome;
                    filterTipoLavoroSelect.appendChild(option);
                });
            }
        }
        
        // Popola filtro colture con categorie
        function populateFiltroColture() {
            const filterColturaSelect = document.getElementById('filter-coltura');
            if (!filterColturaSelect) return;
            
            filterColturaSelect.innerHTML = '<option value="">Tutte le categorie colture</option>';
            
            // Usa categorie hardcoded (sincrono, sempre disponibile)
            const categorieColture = ['Vite', 'Frutteto', 'Seminativo', 'Orto', 'Prato', 'Olivo', 'Agrumeto', 'Bosco'];
            categorieColture.forEach(categoria => {
                const option = document.createElement('option');
                option.value = categoria;
                option.textContent = categoria;
                filterColturaSelect.appendChild(option);
            });
        }
        
        // Funzione helper per mappare coltura specifica a categoria (versione locale sincrona)
        function mapColturaToCategoria(colturaNome) {
            if (!colturaNome) return 'Default';
            
            const nomeLower = colturaNome.toLowerCase();
            
            // Match esatto nella palette
            if (colturaNome === 'Vite' || colturaNome === 'Frutteto' || colturaNome === 'Seminativo' || 
                colturaNome === 'Orto' || colturaNome === 'Prato' || colturaNome === 'Olivo' || 
                colturaNome === 'Agrumeto' || colturaNome === 'Bosco') {
                return colturaNome;
            }
            
            // Mapping per Vite
            if (nomeLower.includes('vite')) {
                return 'Vite';
            }
            
            // Mapping per Frutteto
            if (nomeLower.includes('albicocch') || nomeLower.includes('pesco') || 
                nomeLower.includes('melo') || nomeLower.includes('pero') ||
                nomeLower.includes('ciliegio') || nomeLower.includes('susino') ||
                nomeLower.includes('fico') || nomeLower.includes('nocciolo') ||
                nomeLower.includes('mandorlo') || nomeLower.includes('castagno') ||
                nomeLower.includes('kiwi') || nomeLower.includes('mirtillo') ||
                nomeLower.includes('lampone') || nomeLower.includes('ribes') ||
                nomeLower.includes('mora') || nomeLower.includes('melograno') ||
                nomeLower.includes('noce') || nomeLower.includes('pistacchio')) {
                return 'Frutteto';
            }
            
            // Mapping per Seminativo
            if (nomeLower.includes('grano') || nomeLower.includes('mais') ||
                nomeLower.includes('orzo') || nomeLower.includes('favino') ||
                nomeLower.includes('girasole') || nomeLower.includes('soia') ||
                nomeLower.includes('colza') || nomeLower.includes('avena') ||
                nomeLower.includes('segale') || nomeLower.includes('fava') ||
                nomeLower.includes('lenticchia') || nomeLower.includes('cece') ||
                nomeLower.includes('riso') || nomeLower.includes('quinoa') ||
                nomeLower.includes('canapa') || nomeLower.includes('lino') ||
                nomeLower.includes('erba medica') || nomeLower.includes('trifoglio')) {
                return 'Seminativo';
            }
            
            // Mapping per Orto
            if (nomeLower.includes('pomodoro') || nomeLower.includes('zucchin') ||
                nomeLower.includes('melanzan') || nomeLower.includes('peperon') ||
                nomeLower.includes('insalata') || nomeLower.includes('carot') ||
                nomeLower.includes('patat') || nomeLower.includes('bietol') ||
                nomeLower.includes('fragol') || nomeLower.includes('cipoll') ||
                nomeLower.includes('aglio') || nomeLower.includes('fagiol') ||
                nomeLower.includes('pisell') || nomeLower.includes('cavolo') ||
                nomeLower.includes('broccoli') || nomeLower.includes('spinaci') ||
                nomeLower.includes('lattuga') || nomeLower.includes('radicchio') ||
                nomeLower.includes('finocchi') || nomeLower.includes('sedano') ||
                nomeLower.includes('cetriol') || nomeLower.includes('anguria') ||
                nomeLower.includes('melon')) {
                return 'Orto';
            }
            
            // Mapping per Prato
            if (nomeLower.includes('prato') || nomeLower.includes('pascolo')) {
                return 'Prato';
            }
            
            // Mapping per Olivo
            if (nomeLower.includes('olivo') || nomeLower.includes('oliveto')) {
                return 'Olivo';
            }
            
            // Mapping per Agrumeto
            if (nomeLower.includes('arancio') || nomeLower.includes('limone') ||
                nomeLower.includes('mandarino') || nomeLower.includes('clementin') ||
                nomeLower.includes('pompelmo') || nomeLower.includes('bergamotto') ||
                nomeLower.includes('cedro') || nomeLower.includes('lime') ||
                nomeLower.includes('kumquat')) {
                return 'Agrumeto';
            }
            
            // Mapping per Bosco
            if (nomeLower.includes('bosco') || nomeLower.includes('foresta') ||
                nomeLower.includes('castagneto') || nomeLower.includes('faggeto') ||
                nomeLower.includes('querceto') || nomeLower.includes('pineto')) {
                return 'Bosco';
            }
            
            return 'Default';
        }
        
        // Aggiorna dropdown colture in base alla categoria selezionata
        // Aggiorna dropdown colture - wrapper
        function updateColtureDropdownAttivita() {
            const categoriaSelect = document.getElementById('attivita-coltura-categoria');
            const categoriaId = categoriaSelect ? categoriaSelect.value : '';
            updateColtureDropdownAttivitaModule(categoriaId, window.colturePerCategoriaAttivita || {});
        }
        
        // Esponi funzione globalmente per accesso da attributi HTML
        window.updateColtureDropdownAttivita = updateColtureDropdownAttivita;
        
        // Funzione inline rimossa - ora in attivita-controller.js
        // La funzione loadCategorieLavori() √® stata estratta nel controller
        // Usa il wrapper sopra che chiama loadCategorieLavoriModule
        
        // Popola sottocategorie quando cambia categoria principale - wrapper
        function populateSottocategorieLavoro(parentId, selectedValue = null) {
            populateSottocategorieLavoroModule(parentId, sottocategorieLavoriMap, selectedValue);
        }

        // Funzione inline rimossa - ora in attivita-controller.js
        // La funzione loadTipiLavoro() √® stata estratta nel controller
        // Usa il wrapper sopra che chiama loadTipiLavoroModule

        // Popola dropdown categoria principale lavoro - wrapper
        function populateCategoriaLavoroDropdown(selectedValue = null, categorieParam = null) {
            // Se le categorie sono passate come parametro, usale direttamente
            if (categorieParam !== null && Array.isArray(categorieParam) && categorieParam.length > 0) {
                // Assicura che sia un array valido prima di passarlo - crea una copia per sicurezza
                const categorieArray = Array.isArray(categorieParam) ? [...categorieParam] : [];
                // Passa direttamente l'array senza ulteriori manipolazioni
                populateCategoriaLavoroDropdownModule(categorieArray, selectedValue);
                return;
            }
            
            // Altrimenti, usa la variabile globale
            // Se la variabile globale √® vuota, aspetta un attimo e riprova (potrebbe essere ancora in caricamento)
            if (categorieLavoriPrincipali.length === 0) {
                console.warn('‚ö†Ô∏è [populateCategoriaLavoroDropdown] Variabile globale vuota, aspetto e riprovo...');
                setTimeout(() => {
                    if (categorieLavoriPrincipali.length > 0) {
                        populateCategoriaLavoroDropdownModule(categorieLavoriPrincipali, selectedValue);
                    } else {
                        console.error('‚ùå [populateCategoriaLavoroDropdown] Categorie ancora non disponibili dopo attesa');
                    }
                }, 100);
                return;
            }
            
            populateCategoriaLavoroDropdownModule(categorieLavoriPrincipali, selectedValue);
        }

        // Popola dropdown tipo lavoro nel form (filtrato per categoria) - wrapper
        function populateTipoLavoroDropdown(categoriaId = null, selectedValue = null, tipiLavoroFiltratiParam = null) {
            populateTipoLavoroDropdownModule(
                categoriaId,
                tipiLavoroList,
                sottocategorieLavoriMap,
                selectedValue,
                tipiLavoroFiltratiParam
            );
        }
        
        // Setup handler per cambio categoria lavoro - wrapper
        function setupCategoriaLavoroHandler() {
            setupCategoriaLavoroHandlerModule(populateSottocategorieLavoro, loadTipiLavoro);
        }
        
        // Funzioni per gestire modali categoria e tipo lavoro - wrapper
        window.openCategoriaLavoroModal = function() {
            openCategoriaLavoroModalModule();
        }

        window.closeCategoriaLavoroModal = function() {
            closeCategoriaLavoroModalModule();
        }

        window.handleSalvaCategoriaLavoro = async function(e) {
            await handleSalvaCategoriaLavoroModule({
                event: e,
                currentTenantId,
                currentUserData,
                db,
                collection,
                query,
                getDocs,
                where,
                addDoc,
                serverTimestamp,
                showAlert: showAlertUtil,
                closeCategoriaLavoroModal: closeCategoriaLavoroModalModule,
                loadCategorieLavori: loadCategorieLavori
            });
        }

        window.openTipoLavoroModal = function() {
            openTipoLavoroModalModule({
                categorieLavoriPrincipali,
                sottocategorieLavoriMap,
                showAlert: showAlertUtil
            });
        }

        window.closeTipoLavoroModal = function() {
            closeTipoLavoroModalModule();
        }

        window.handleSalvaTipoLavoro = async function(e) {
            await handleSalvaTipoLavoroModule({
                event: e,
                currentTenantId,
                currentUserData,
                db,
                collection,
                query,
                getDocs,
                where,
                doc,
                getDoc,
                addDoc,
                serverTimestamp,
                showAlert: showAlertUtil,
                closeTipoLavoroModal: closeTipoLavoroModalModule,
                loadTipiLavoro: loadTipiLavoro
            });
        }

        // Carica attivit√†
        // Carica attivit√† - wrapper
        async function loadAttivita() {
            await loadAttivitaModule(
                currentTenantId,
                db,
                auth,
                attivita,
                filteredAttivita,
                hasParcoMacchineModule,
                getTenantId,
                async (attivitaList, tenantId, dbInstance, hasModule) => {
                    await liberaMacchineAttivitaPrecedentiModule(attivitaList, tenantId, dbInstance, hasModule);
                },
                renderAttivita,
                showAlertUtil
            );
            // Aggiorna currentTenantId se √® stato recuperato
            if (!currentTenantId && auth.currentUser) {
                currentTenantId = await getTenantId(auth.currentUser.uid);
            }
        }

        // Libera macchine di attivit√† del giorno precedente senza "ora fine" - wrapper
        async function liberaMacchineAttivitaPrecedenti() {
            await liberaMacchineAttivitaPrecedentiModule(attivita, currentTenantId, db, hasParcoMacchineModule);
            // Ricarica macchine per aggiornare dropdown
            await loadMacchine();
        }

        // Render attivit√† - wrapper
        async function renderAttivita() {
            await renderAttivitaModule({
                filteredAttivita,
                attivita,
                lavoriList,
                clientiList,
                terreni,
                macchineList,
                isContoTerziMode,
                hasParcoMacchineModule,
                hasManodoperaModule,
                escapeHtml: escapeHtmlUtil,
                formatOreNette: formatOreNetteUtil,
                populateTrattoriRapido: populateTrattoriRapido,
                initCalcoloOreNetteRapido: initCalcoloOreNetteRapido,
                caricaDettagliLavoriCompletati: async (lavoriCompletati) => {
                    await caricaDettagliLavoriCompletatiModule({
                        lavoriCompletati,
                        attivita,
                        filteredAttivita,
                        clientiList,
                        terreni,
                        currentTenantId,
                        db,
                        collection,
                        getDocs,
                        hasManodoperaModule,
                        escapeHtml: escapeHtmlUtil,
                        formatOreNette: formatOreNetteUtil
                    });
                }
            });
        }

        // Funzione caricaDettagliLavoriCompletati - wrapper
        async function caricaDettagliLavoriCompletati(lavoriCompletati) {
            await caricaDettagliLavoriCompletatiModule({
                lavoriCompletati,
                attivita,
                filteredAttivita,
                clientiList,
                terreni,
                currentTenantId,
                db,
                collection,
                getDocs,
                hasManodoperaModule,
                escapeHtml: escapeHtmlUtil,
                formatOreNette: formatOreNetteUtil
            });
        }

        // Funzione inline rimossa - ora in attivita-controller.js
        // Le funzioni renderAttivita() e caricaDettagliLavoriCompletati() sono state estratte nel controller
        // Usa i wrapper sopra che chiamano renderAttivitaModule e caricaDettagliLavoriCompletatiModule

        // Funzione caricaDettagliLavoriCompletati estratta - ora in attivita-controller.js
        // Usa il wrapper sopra che chiama caricaDettagliLavoriCompletatiModule
        // La funzione originale inline √® stata rimossa


        window.toggleDettagliLavoro = function(lavoroId) {
            const dettagli = document.getElementById(`dettagli-lavoro-${lavoroId}`);
            const icon = document.getElementById(`icon-toggle-${lavoroId}`);
            
            if (dettagli && icon) {
                if (dettagli.style.display === 'none' || !dettagli.style.display) {
                    dettagli.style.display = 'block';
                    icon.textContent = '‚ñ≤';
                } else {
                    dettagli.style.display = 'none';
                    icon.textContent = '‚ñº';
                }
            }
        }

        // Toggle form rapido per lavoro
        // Toggle form rapido - wrapper
        window.toggleFormRapido = function(lavoroId) {
            toggleFormRapidoModule(lavoroId);
            // Inizializza calcolo ore nette quando il form viene aperto
            if (document.getElementById(`form-rapido-${lavoroId}`)?.style.display === 'block') {
                setTimeout(() => initCalcoloOreNetteRapido(lavoroId), 100);
            }
        }

        // Inizializza calcolo automatico ore nette per form rapido
        // Inizializza calcolo ore nette rapido - wrapper
        function initCalcoloOreNetteRapido(lavoroId) {
            initCalcoloOreNetteRapidoUtil(lavoroId);
        }

        // Popola dropdown trattori per form rapido
        function populateTrattoriRapido(lavoroId) {
            const select = document.getElementById(`rapido-trattore-${lavoroId}`);
            if (!select) return;
            
            select.innerHTML = '<option value="">-- Nessun trattore --</option>';
            
            if (!macchineList || macchineList.length === 0) return;
            
            const trattori = macchineList
                .filter(m => {
                    const tipo = m.tipoMacchina || m.tipo;
                    return tipo === 'trattore' && m.stato !== 'dismesso';
                })
                .sort((a, b) => {
                    const nomeA = (a.nome || '').toLowerCase();
                    const nomeB = (b.nome || '').toLowerCase();
                    return nomeA.localeCompare(nomeB);
                });
            
            trattori.forEach(trattore => {
                const option = document.createElement('option');
                option.value = trattore.id;
                const nome = trattore.nome || 'Trattore senza nome';
                const cavalli = trattore.cavalli ? ` (${trattore.cavalli} CV)` : '';
                const stato = trattore.stato === 'disponibile' ? '‚úÖ' : 
                             trattore.stato === 'in_uso' ? 'üîÑ' : 
                             trattore.stato === 'in_manutenzione' ? 'üîß' : 
                             trattore.stato === 'guasto' ? '‚ùå' : '';
                option.textContent = `${stato} ${nome}${cavalli}`;
                select.appendChild(option);
            });
            
            // Listener per attrezzi compatibili
            select.addEventListener('change', function() {
                populateAttrezziRapido(lavoroId, this.value);
            });
        }

        // Popola dropdown attrezzi compatibili per form rapido
        function populateAttrezziRapido(lavoroId, trattoreId) {
            const select = document.getElementById(`rapido-attrezzo-${lavoroId}`);
            const group = document.getElementById(`rapido-attrezzo-group-${lavoroId}`);
            if (!select || !group) return;
            
            select.innerHTML = '<option value="">-- Nessun attrezzo --</option>';
            
            if (!trattoreId) {
                group.style.display = 'none';
                return;
            }
            
            const trattore = macchineList.find(m => m.id === trattoreId);
            if (!trattore || !trattore.cavalli) {
                group.style.display = 'none';
                return;
            }
            
            group.style.display = 'block';
            
            const attrezziCompatibili = macchineList
                .filter(m => {
                    const tipo = m.tipoMacchina || m.tipo;
                    if (tipo !== 'attrezzo' || m.stato === 'dismesso') return false;
                    const cavalliMinimi = m.cavalliMinimiRichiesti || 0;
                    return trattore.cavalli >= cavalliMinimi;
                })
                .sort((a, b) => {
                    const nomeA = (a.nome || '').toLowerCase();
                    const nomeB = (b.nome || '').toLowerCase();
                    return nomeA.localeCompare(nomeB);
                });
            
            attrezziCompatibili.forEach(attrezzo => {
                const option = document.createElement('option');
                option.value = attrezzo.id;
                option.textContent = attrezzo.nome || 'Attrezzo senza nome';
                select.appendChild(option);
            });
        }

        // Salva attivit√† rapida da form lavoro - wrapper
        window.salvaAttivitaRapida = async function(lavoroId) {
            await salvaAttivitaRapidaModule({
                lavoroId,
                currentTenantId,
                clientiList,
                terreni,
                hasParcoMacchineModule,
                macchineList,
                lavoriList,
                hasContoTerziModule,
                isContoTerziMode,
                attivita,
                filteredAttivita,
                showAlert: showAlertUtil,
                serverTimestamp,
                getAttivitaCollection: getAttivitaCollectionModule,
                addDoc,
                doc,
                updateDoc,
                getDoc,
                db,
                updateMacchinaStato: updateMacchinaStatoModule,
                generaVoceDiarioContoTerzi: generaVoceDiarioContoTerzi,
                loadLavoriContoTerzi: loadLavoriContoTerzi,
                loadAttivita: loadAttivitaModule,
                applyContoTerziFilter: applyContoTerziFilter,
                renderAttivita: renderAttivita,
                toggleFormRapido: toggleFormRapidoModule
            });
        }

        // Apri modal attivit√† - wrapper
        window.openAttivitaModal = async function(attivitaId = null) {
            await openAttivitaModalModule({
                attivitaId,
                setCurrentAttivitaId: (id) => { currentAttivitaId = id; },
                filteredAttivita,
                tipiLavoroList,
                categorieLavoriPrincipali,
                sottocategorieLavoriMap,
                hasParcoMacchineModule,
                macchineList,
                terreni,
                loadMacchine: loadMacchineModule,
                loadCategorieLavori,
                loadTipiLavoro,
                loadListe,
                loadTerreni: loadTerreniModule,
                populateCategoriaLavoroDropdown: populateCategoriaLavoroDropdown, // Usa il wrapper, non il modulo
                populateSottocategorieLavoro: populateSottocategorieLavoro, // Usa il wrapper, non il modulo
                populateTipoLavoroDropdown: populateTipoLavoroDropdownModule,
                populateColtureFromTerreni: populateColtureFromTerreniModule,
                updateColtureDropdownAttivita: updateColtureDropdownAttivitaModule,
                populateTrattoriDropdown: populateTrattoriDropdown, // Usa il wrapper, non il modulo
                populateAttrezziDropdown: populateAttrezziDropdown, // Usa il wrapper, non il modulo
                setupCategoriaLavoroHandler: setupCategoriaLavoroHandlerModule,
                updateOreNette,
                updateOreMacchinaDisplay
            });
        }

        // Funzione inline rimossa - ora in attivita-events.js
        // La funzione originale √® stata estratta nel modulo events
        // Ora usa openAttivitaModalModule dal modulo events

        // Chiudi modal attivit√† - wrapper
        window.closeAttivitaModal = function() {
            closeAttivitaModalModule();
            currentAttivitaId = null;
        };

        // Calcola ore nette (ritorna oggetto con ore e minuti)
        // Funzioni utility - wrapper (gi√† estratte in attivita-utils.js)
        function calculateOreNette() {
            return calculateOreNetteUtil();
        }

        function formatOreNette(oreNette) {
            return formatOreNetteUtil(oreNette);
        }

        // Aggiorna display ore nette
        // Aggiorna display ore nette - wrapper
        function updateOreNette() {
            updateOreNetteUtil();
        }

// Listener per precompilare terreno quando si seleziona un lavoro (modalit√† Conto Terzi)
        const lavoroSelect = document.getElementById('attivita-lavoro');
        if (lavoroSelect) {
            lavoroSelect.addEventListener('change', function() {
                if (!isContoTerziMode) return;
                
                const lavoroId = this.value;
                if (lavoroId) {
                    const lavoro = lavoriList.find(l => l.id === lavoroId);
                    if (lavoro && lavoro.terrenoId) {
                        // Precompila terreno
                        const terrenoSelect = document.getElementById('attivita-terreno');
                        if (terrenoSelect) {
                            terrenoSelect.value = lavoro.terrenoId;
                            terrenoSelect.disabled = true; // Disabilita perch√© viene dal lavoro
                            // Trigger change per precompilare coltura se necessario
                            terrenoSelect.dispatchEvent(new Event('change'));
                        }
                    }
                } else {
                    // Se lavoro deselezionato, abilita terreno e resetta
                    const terrenoSelect = document.getElementById('attivita-terreno');
                    if (terrenoSelect) {
                        terrenoSelect.disabled = false;
                        terrenoSelect.value = '';
                    }
                }
            });
        }

        // Listener per precompilare coltura quando si seleziona un terreno
        document.getElementById('attivita-terreno').addEventListener('change', async function() {
            const terrenoId = this.value;
            if (terrenoId) {
                const terreno = terreni.find(t => t.id === terrenoId);
                if (terreno && terreno.coltura) {
                    // Assicura che le categorie siano caricate
                    if (!window.colturePerCategoriaAttivita || Object.keys(window.colturePerCategoriaAttivita).length === 0) {
                        // Se non ancora caricate, caricale ora
                        await loadListe();
                    }
                    
                    // Precompila la coltura del terreno (sia lista piatta che gerarchica)
                    const colturaSelect = document.getElementById('attivita-coltura');
                    const colturaGerarchicaSelect = document.getElementById('attivita-coltura-gerarchica');
                    const categoriaColturaSelect = document.getElementById('attivita-coltura-categoria');
                    
                    // Trova la categoria della coltura usando il servizio (stesso metodo usato per la coltura)
                    let categoriaTrovata = null;
                    
                    if (categoriaColturaSelect) {
                        const isFileProtocol = window.location.protocol === 'file:';
                        
                        if (!isFileProtocol) {
                            // Usa servizio per ottenere coltura completa con categoriaId
                            try {
                                // Assicura che Firebase sia inizializzato nel servizio
                                const { setFirebaseInstances } = await import('./services/firebase-service.js');
                                setFirebaseInstances({ app, db, auth });
                                
                                // Assicura che il tenantId sia impostato nel servizio
                                const { setCurrentTenantId } = await import('./services/tenant-service.js');
                                if (currentTenantId) {
                                    setCurrentTenantId(currentTenantId);
                                }
                                
                                // Ottieni coltura completa dal servizio
                                const { getColturaByNome } = await import('./services/colture-service.js');
                                const colturaCompleta = await getColturaByNome(terreno.coltura);
                                
                                if (colturaCompleta && colturaCompleta.categoriaId) {
                                    categoriaTrovata = colturaCompleta.categoriaId;
                                }
                            } catch (error) {
                                console.warn('Errore recupero categoria coltura dal servizio:', error);
                                // Fallback: cerca in colturePerCategoriaAttivita
                                if (window.colturePerCategoriaAttivita) {
                                    const nomeColturaTerreno = (terreno.coltura || '').trim().toLowerCase();
                                    for (const [categoriaId, coltureList] of Object.entries(window.colturePerCategoriaAttivita)) {
                                        const colturaTrovata = coltureList.find(c => {
                                            const nomeColtura = ((c.nome || c) || '').trim().toLowerCase();
                                            const idColtura = (c.id || '').trim().toLowerCase();
                                            return nomeColtura === nomeColturaTerreno || 
                                                   idColtura === nomeColturaTerreno ||
                                                   nomeColtura === terreno.coltura ||
                                                   idColtura === terreno.coltura;
                                        });
                                        
                                        if (colturaTrovata) {
                                            categoriaTrovata = categoriaId;
                                            break;
                                        }
                                    }
                                }
                            }
                        } else {
                            // Fallback per ambiente file://: cerca in colturePerCategoriaAttivita
                            if (window.colturePerCategoriaAttivita) {
                                const nomeColturaTerreno = (terreno.coltura || '').trim().toLowerCase();
                                for (const [categoriaId, coltureList] of Object.entries(window.colturePerCategoriaAttivita)) {
                                    const colturaTrovata = coltureList.find(c => {
                                        const nomeColtura = ((c.nome || c) || '').trim().toLowerCase();
                                        const idColtura = (c.id || '').trim().toLowerCase();
                                        return nomeColtura === nomeColturaTerreno || 
                                               idColtura === nomeColturaTerreno ||
                                               nomeColtura === terreno.coltura ||
                                               idColtura === terreno.coltura;
                                    });
                                    
                                    if (colturaTrovata) {
                                        categoriaTrovata = categoriaId;
                                        break;
                                    }
                                }
                            }
                        }
                        
                        // Se trovata, seleziona la categoria
                        if (categoriaTrovata) {
                            categoriaColturaSelect.value = categoriaTrovata;
                            // Aggiorna il dropdown colture per mostrare solo quelle della categoria
                            updateColtureDropdownAttivita();
                            // Precompila la coltura (dopo aver aggiornato il dropdown)
                            if (colturaGerarchicaSelect) {
                                // Aspetta un attimo per assicurarsi che il dropdown sia aggiornato
                                setTimeout(() => {
                                    if (colturaGerarchicaSelect.querySelector(`option[value="${terreno.coltura}"]`)) {
                                        colturaGerarchicaSelect.value = terreno.coltura;
                                    }
                                }, 100);
                            }
                        } else {
                            // Se categoria non trovata, mantieni il dropdown colture popolato da populateColtureFromTerreni
                            // e seleziona solo la coltura
                            console.warn('Categoria non trovata per coltura:', terreno.coltura);
                            if (colturaGerarchicaSelect) {
                                // Assicura che il dropdown sia popolato
                                if (colturaGerarchicaSelect.options.length <= 1) {
                                    populateColtureFromTerreni();
                                }
                                // Seleziona la coltura se presente nel dropdown
                                if (colturaGerarchicaSelect.querySelector(`option[value="${terreno.coltura}"]`)) {
                                    colturaGerarchicaSelect.value = terreno.coltura;
                                }
                            }
                        }
                    }
                    
                    // Precompila anche la coltura nella lista piatta (se esiste)
                    if (colturaSelect) {
                        colturaSelect.value = terreno.coltura;
                    }
                } else {
                    // Se non c'√® coltura nel terreno, resetta solo la categoria
                    const categoriaColturaSelect = document.getElementById('attivita-coltura-categoria');
                    
                    if (categoriaColturaSelect) {
                        categoriaColturaSelect.value = '';
                    }
                    // Mantieni il dropdown colture popolato da populateColtureFromTerreni
                    // Non resettarlo completamente
                }
            } else {
                // Se nessun terreno selezionato, resetta solo la categoria
                const categoriaColturaSelect = document.getElementById('attivita-coltura-categoria');
                
                if (categoriaColturaSelect) {
                    categoriaColturaSelect.value = '';
                }
                // Mantieni il dropdown colture popolato da populateColtureFromTerreni
                // Non resettarlo completamente
            }
        });

        // Listener per gestire compatibilit√† attrezzi quando cambia trattore
        document.getElementById('attivita-macchina')?.addEventListener('change', function() {
            const trattoreId = this.value;
            const oreMacchinaGroup = document.getElementById('attivita-ore-macchina-group');
            
            populateAttrezziDropdown(trattoreId);
            
            // Mostra/nascondi gruppo ore macchina
            if (trattoreId || document.getElementById('attivita-attrezzo').value) {
                if (oreMacchinaGroup) oreMacchinaGroup.style.display = 'block';
                updateOreMacchinaDisplay();
            } else {
                if (oreMacchinaGroup) oreMacchinaGroup.style.display = 'none';
            }
        });

        // Listener per attrezzo
        document.getElementById('attivita-attrezzo')?.addEventListener('change', function() {
            const attrezzoId = this.value;
            const trattoreId = document.getElementById('attivita-macchina').value;
            const oreMacchinaGroup = document.getElementById('attivita-ore-macchina-group');
            
            // Mostra/nascondi gruppo ore macchina
            if (trattoreId || attrezzoId) {
                if (oreMacchinaGroup) oreMacchinaGroup.style.display = 'block';
                updateOreMacchinaDisplay();
            } else {
                if (oreMacchinaGroup) oreMacchinaGroup.style.display = 'none';
            }
        });

        // Aggiorna display ore macchina
        // Aggiorna display ore macchina - wrapper
        function updateOreMacchinaDisplay() {
            updateOreMacchinaDisplayUtil();
        }

        // Aggiorna display quando cambiano orari (modalit√† normale)
        document.getElementById('attivita-orario-inizio')?.addEventListener('input', function() {
            updateOreNette();
            updateOreMacchinaDisplay();
        });
        document.getElementById('attivita-orario-fine')?.addEventListener('input', function() {
            updateOreNette();
            updateOreMacchinaDisplay();
        });
        document.getElementById('attivita-pause')?.addEventListener('input', function() {
            updateOreNette();
            updateOreMacchinaDisplay();
        });
        
        // Calcolo automatico ore nette per modalit√† Conto Terzi - wrapper
        function updateOreNetteContoTerzi() {
            updateOreNetteContoTerziUtil();
        }
        
        // Event listeners per modalit√† Conto Terzi
        document.getElementById('attivita-ora-inizio-ct')?.addEventListener('input', updateOreNetteContoTerzi);
        document.getElementById('attivita-ora-inizio-ct')?.addEventListener('change', updateOreNetteContoTerzi);
        document.getElementById('attivita-ora-fine-ct')?.addEventListener('input', updateOreNetteContoTerzi);
        document.getElementById('attivita-ora-fine-ct')?.addEventListener('change', updateOreNetteContoTerzi);
        document.getElementById('attivita-pause-ct')?.addEventListener('input', updateOreNetteContoTerzi);
        document.getElementById('attivita-pause-ct')?.addEventListener('change', updateOreNetteContoTerzi);

        // Salva attivit√† - wrapper
        window.handleSaveAttivita = async function(e) {
            await handleSaveAttivitaModule({
                event: e,
                currentTenantId,
                currentAttivitaId,
                setCurrentAttivitaId: (id) => { currentAttivitaId = id; },
                isContoTerziMode,
                hasParcoMacchineModule,
                lavoriList,
                clientiList,
                terreni,
                attivita,
                showAlert: showAlertUtil,
                app,
                auth,
                verificaConflittiMacchine: verificaConflittiMacchineModule,
                calculateOreNette: calculateOreNetteUtil,
                updateMacchinaStato: updateMacchinaStatoModule,
                getAttivitaCollection: getAttivitaCollectionModule,
                db,
                serverTimestamp,
                doc,
                updateDoc,
                addDoc,
                closeAttivitaModal: closeAttivitaModalModule,
                loadAttivita: loadAttivita, // Usa il wrapper, non il modulo
                loadMacchine: loadMacchineModule
            });
        }

        // Funzione inline rimossa - ora in attivita-events.js
        // La funzione originale √® stata estratta nel modulo events
        // Ora usa handleSaveAttivitaModule dal modulo events

        // Modifica attivit√† - wrapper
        window.editAttivita = function(attivitaId) {
            editAttivitaModule(attivitaId, openAttivitaModal);
        };

        // Conferma eliminazione attivit√† - wrapper
        window.confirmDeleteAttivita = async function(attivitaId) {
            await confirmDeleteAttivitaModule(
                attivitaId,
                currentTenantId,
                db,
                getAttivitaCollection,
                loadAttivita,
                showAlert
            );
        };

        // Filtri
        document.getElementById('filter-data-da').addEventListener('change', applyFilters);
        document.getElementById('filter-data-a').addEventListener('change', applyFilters);
        document.getElementById('filter-terreno').addEventListener('change', applyFilters);
        document.getElementById('filter-tipo-lavoro').addEventListener('change', applyFilters);
        document.getElementById('filter-coltura').addEventListener('change', applyFilters);
        document.getElementById('filter-ricerca').addEventListener('input', applyFilters);

        // Applica filtri - wrapper
        function applyFilters() {
            applyFiltersModule(
                attivita,
                filteredAttivita,
                lavoriList,
                tipiLavoroList,
                categorieLavoriPrincipali,
                isContoTerziMode,
                mapColturaToCategoria,
                renderAttivita
            );
        }

        // Pulisci filtri - wrapper
        window.clearFilters = function() {
            clearFiltersModule();
            
            // Se modalit√† completati, riapplica filtro base
            const urlParams = new URLSearchParams(window.location.search);
            const statoFiltro = urlParams.get('stato');
            if (isContoTerziMode && statoFiltro === 'completato') {
                applyContoTerziFilter(statoFiltro);
            } else {
                filteredAttivita = [...attivita];
                renderAttivita();
            }
        };

        // Mostra alert
        // Funzioni utility - wrapper (gi√† estratte in attivita-utils.js)
        function showAlert(message, type = 'success') {
            showAlertUtil(message, type);
        }

        function escapeHtml(text) {
            return escapeHtmlUtil(text);
        }

        // Variabili globali per la mappa
        let mappaZoneMap = null;
        let mappaZonePolygons = [];

        // Funzione per mostrare mappa zone lavorate - wrapper
        window.mostraMappaZonaLavorata = async function(lavoroId, dataAttivita, dataFormatted) {
            await mostraMappaZonaLavorataModule({
                lavoroId,
                dataAttivita,
                dataFormatted,
                lavoriList,
                terreni,
                currentTenantId,
                db,
                collection,
                getDocs,
                getDoc,
                doc,
                loadGoogleMapsAPI,
                showAlert: showAlertUtil,
                updateMappaZoneMap: (val) => { mappaZoneMap = val; },
                updateMappaZonePolygons: (val) => { mappaZonePolygons = val; },
                getMappaZoneMap: () => mappaZoneMap,
                getMappaZonePolygons: () => mappaZonePolygons
            });
        }

        // Funzione per chiudere modal mappa - wrapper
        window.closeMappaZoneModal = function() {
            closeMappaZoneModalModule({
                getMappaZoneMap: () => mappaZoneMap,
                getMappaZonePolygons: () => mappaZonePolygons,
                updateMappaZoneMap: (val) => { mappaZoneMap = val; },
                updateMappaZonePolygons: (val) => { mappaZonePolygons = val; }
            });
        }
    </script>
    
    <!-- Service Worker Registration for PWA -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // Usa percorso relativo per compatibilit√† con localhost e GitHub Pages
                const swPath = window.location.pathname.includes('/gfv-platform/') 
                    ? '/gfv-platform/service-worker.js' 
                    : '../service-worker.js';
                navigator.serviceWorker.register(swPath)
                    .then((registration) => {
                        console.log('Service Worker registrato:', registration.scope);
                    })
                    .catch((error) => {
                        // Non loggare errori se siamo in ambiente file:// (normale)
                        if (window.location.protocol !== 'file:') {
                            console.warn('Registrazione Service Worker fallita (non critico):', error.message);
                        }
                    });
            });
        }
    </script>
</body>
</html>

