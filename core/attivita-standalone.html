<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diario Attivit√† - GFV Platform</title>
    <link rel="manifest" href="/gfv-platform/manifest.json">
    <meta name="theme-color" content="#2E8B57">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(180deg, #B0E0E6 0%, #228B22 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0px 8px 20px rgba(0, 0, 0, 0.15);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(180deg, #2E8B57 0%, #256E4A 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .user-info {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-actions {
            position: absolute;
            top: 20px;
            left: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .user-info span {
            font-size: 0.9em;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .btn-primary:hover {
            background: rgba(255,255,255,0.3);
        }
        
        /* Pulsanti nei modal devono avere sfondo verde, non trasparente */
        .modal .btn-primary {
            background: #2E8B57;
            color: white;
            border: none;
        }
        
        .modal .btn-primary:hover {
            background: #228B22;
        }
        
        .modal .btn-secondary {
            background: #6c757d;
            color: white;
            border: none;
        }
        
        .modal .btn-secondary:hover {
            background: #5a6268;
        }

        .content {
            padding: 30px;
        }

        .actions-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .filters {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 12px;
            font-weight: 600;
            color: #495057;
            margin: 0;
        }

        .filters input,
        .filters select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .filters input[type="date"] {
            min-width: 150px;
        }

        .filters select {
            min-width: 150px;
        }

        .filters input[type="text"] {
            min-width: 200px;
        }

        .filter-range {
            display: flex;
            align-items: flex-end;
            gap: 8px;
        }

        .filter-range-text {
            padding-bottom: 8px;
            color: #666;
            font-size: 14px;
            font-weight: 500;
        }

        .section-header {
            margin-bottom: 20px;
        }

        .section-header h2 {
            color: #2E8B57;
            font-size: 24px;
        }

        /* Attivit√† Table Layout */
        .attivita-table {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-top: 20px;
        }

        .attivita-header {
            background: #f8f9fa;
            color: #000;
            display: grid;
            grid-template-columns: 1.2fr 1.5fr 1.5fr 1.2fr 1fr 1fr 1fr 1fr 1.5fr;
            gap: 15px;
            padding: 15px 20px;
            font-weight: 600;
            font-size: 0.95em;
            text-align: center;
            border-bottom: 2px solid #2E8B57;
        }

        .attivita-row {
            display: grid;
            grid-template-columns: 1.2fr 1.5fr 1.5fr 1.2fr 1fr 1fr 1fr 1fr 1.5fr;
            gap: 15px;
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            align-items: center;
            transition: background-color 0.2s;
            text-align: center;
        }

        .attivita-row:hover {
            background-color: #f8f9fa;
        }

        .attivita-row:last-child {
            border-bottom: none;
        }

        .col-data {
            font-weight: 600;
            color: #007bff;
        }

        .col-terreno {
            text-align: left;
            font-weight: 500;
            color: #28a745;
        }

        .col-tipo-lavoro,
        .col-coltura {
            color: #333;
            font-size: 0.9em;
        }

        .col-orari {
            font-family: 'Courier New', monospace;
            color: #666;
            font-size: 0.9em;
        }

        .col-ore {
            font-weight: bold;
            color: #dc3545;
            font-size: 1em;
        }

        .col-note {
            color: #666;
            font-size: 0.85em;
            text-align: left;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .col-macchina {
            font-size: 0.85em;
            color: #666;
            text-align: left;
            max-width: 150px;
        }

        .col-azioni {
            display: flex;
            gap: 8px;
            justify-content: center;
            align-items: center;
        }

        .lavoro-rapido-card {
            transition: all 0.3s ease;
        }
        
        .lavoro-rapido-card:hover {
            box-shadow: 0 2px 8px rgba(25, 118, 210, 0.2);
        }
        
        .form-rapido-lavoro input,
        .form-rapido-lavoro select,
        .form-rapido-lavoro textarea {
            font-size: 14px;
        }
        
        .form-rapido-lavoro input[type="checkbox"] {
            cursor: pointer;
            accent-color: #1976D2;
        }
        
        .form-rapido-lavoro label {
            font-weight: 500;
        }
        
        .lavoro-completato-card {
            transition: all 0.3s ease;
        }
        
        .lavoro-completato-card:hover {
            box-shadow: 0 2px 8px rgba(25, 118, 210, 0.2);
            background-color: #F5F9FF !important;
        }

        .btn-edit-small, .btn-delete-small {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-edit-small {
            background: #ffc107;
            color: #212529;
        }

        .btn-edit-small:hover {
            background: #e0a800;
            transform: translateY(-1px);
        }

        .btn-delete-small {
            background: #dc3545;
            color: white;
        }

        .btn-delete-small:hover {
            background: #c82333;
            transform: translateY(-1px);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 100%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            padding: 0;
        }
        
        /* Padding per il contenuto del modal (escluso header) */
        .modal-content > form,
        .modal-content > .modal-body {
            padding: 30px;
            padding-bottom: 40px; /* Extra padding per i pulsanti */
        }
        
        /* Assicura che i pulsanti siano sempre visibili */
        .modal-content > form > div:last-child {
            margin-bottom: 0;
            padding-top: 10px;
        }
        
        /* Modal annidato (tipo lavoro, categoria) ha z-index pi√π alto e dimensioni pi√π piccole */
        #tipo-lavoro-modal,
        #categoria-lavoro-modal {
            z-index: 2000;
        }
        
        #tipo-lavoro-modal .modal-content,
        #categoria-lavoro-modal .modal-content {
            max-width: 500px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Assicura che il form nel modal annidato abbia padding e scroll corretti */
        #tipo-lavoro-modal .modal-content > form,
        #categoria-lavoro-modal .modal-content > form {
            padding: 30px;
            padding-bottom: 120px; /* Extra padding per assicurare che i pulsanti siano sempre visibili */
            flex: 1;
            overflow-y: auto;
            display: block; /* Cambia da flex a block per evitare problemi */
        }
        
        /* I pulsanti devono essere sempre visibili */
        #tipo-lavoro-modal .modal-content > form > div:last-child,
        #categoria-lavoro-modal .modal-content > form > div:last-child {
            margin-top: 30px;
            position: relative;
        }

        .modal-header {
            background: linear-gradient(135deg, #2E8B57 0%, #228B22 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 12px 12px 0 0;
        }

        .modal-header h2,
        .modal-header h3 {
            margin: 0;
            font-size: 24px;
        }
        
        .modal-header h3 {
            font-size: 20px;
        }

        .close-modal,
        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 32px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .close-modal:hover,
        .close-btn:hover {
            background: rgba(255,255,255,0.2);
        }
        
        /* Close button per modal senza header verde */
        .modal-header .close-btn {
            color: white;
        }

        .modal-body {
            padding: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #2E8B57;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .ore-nette-display {
            background: #e7f3ff;
            border: 2px solid #007bff;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            margin: 20px 0;
        }

        .ore-nette-display strong {
            font-size: 24px;
            color: #007bff;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 30px;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        @media (max-width: 1200px) {
            .attivita-header, .attivita-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .attivita-header > div, .attivita-row > div {
                text-align: left !important;
                padding: 5px 0;
            }

            .attivita-header > div:before,
            .attivita-row > div:before {
                content: attr(data-label) ": ";
                font-weight: 600;
                color: #666;
            }

            .col-azioni {
                justify-content: flex-start;
            }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
            }

            .user-info {
                position: static;
                margin-top: 15px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .modal-content {
                margin: 10px;
            }
        }
    </style>
    <script>
        // Applica modifiche CSS immediatamente per evitare flash iniziale
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const isContoTerzi = urlParams.get('contoTerzi') === 'true';
            const statoFiltro = urlParams.get('stato');
            
            if (isContoTerzi) {
                // Applica gradiente blu immediatamente (controlla se body esiste)
                if (document.body) {
                    document.body.style.background = 'linear-gradient(180deg, #E3F2FD 0%, #1976D2 100%)';
                } else {
                    // Se body non esiste ancora, aspetta che il DOM sia caricato
                    document.addEventListener('DOMContentLoaded', function() {
                        if (document.body) {
                            document.body.style.background = 'linear-gradient(180deg, #E3F2FD 0%, #1976D2 100%)';
                        }
                    });
                }
                
                // Funzione per applicare modifiche
                function applyContoTerziStyles() {
                    const header = document.getElementById('main-header') || document.querySelector('.header');
                    if (header) {
                        header.style.background = 'linear-gradient(180deg, #1976D2 0%, #1565C0 100%)';
                    }
                    
                    const headerTitle = document.querySelector('.header h1');
                    if (headerTitle) {
                        if (statoFiltro === 'completato') {
                            headerTitle.textContent = '‚úÖ Lavori Completati - Conto Terzi';
                        } else {
                            headerTitle.textContent = 'Diario Attivit√† - Conto Terzi';
                        }
                    }
                    
                    const filterClienteGroup = document.getElementById('filter-cliente-group');
                    if (filterClienteGroup) {
                        filterClienteGroup.style.display = 'block';
                    }
                    
                    // Imposta link dashboard (percorso relativo da core/ a modules/)
                    const dashboardLink = document.getElementById('dashboard-link');
                    if (dashboardLink) {
                        dashboardLink.href = '../modules/conto-terzi/views/conto-terzi-home-standalone.html';
                    }
                }
                
                // Nascondi header e container finch√© non sono pronti
                function hideAndApply() {
                    const header = document.getElementById('main-header') || document.querySelector('.header');
                    const container = document.getElementById('attivita-container');
                    
                    if (header) {
                        // Nascondi header temporaneamente
                        header.style.visibility = 'hidden';
                        // Applica modifiche
                        applyContoTerziStyles();
                        // Mostra header dopo aver applicato le modifiche (dopo un delay maggiore per permettere al callback principale di eseguire)
                        setTimeout(() => {
                            if (header) header.style.visibility = 'visible';
                        }, 200);
                    }
                    if (container) {
                        container.style.visibility = 'hidden';
                    }
                }
                
                // Esegui immediatamente se DOM √® pronto, altrimenti aspetta
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', hideAndApply);
                } else {
                    // DOM gi√† pronto, esegui immediatamente
                    setTimeout(hideAndApply, 0);
                }
            }
        })();
    </script>
</head>
<body>
    <script>
        // Script immediato per nascondere tutto prima del rendering
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const isContoTerzi = urlParams.get('contoTerzi') === 'true';
            
            if (isContoTerzi) {
                // Applica gradiente blu immediatamente (controlla se body esiste)
                if (document.body) {
                    document.body.style.background = 'linear-gradient(180deg, #E3F2FD 0%, #1976D2 100%)';
                } else {
                    // Se body non esiste ancora, aspetta che il DOM sia caricato
                    document.addEventListener('DOMContentLoaded', function() {
                        if (document.body) {
                            document.body.style.background = 'linear-gradient(180deg, #E3F2FD 0%, #1976D2 100%)';
                        }
                    });
                }
                // Nascondi tutto finch√© non √® pronto
                document.body.style.visibility = 'hidden';
            }
        })();
    </script>
    <div class="container">
        <div class="header" id="main-header">
            <h1>üìÖ Diario Attivit√†</h1>
            <p>Registra e gestisci le attivit√† lavorative</p>
            <div class="header-actions">
                <a href="#" id="dashboard-link" class="btn btn-secondary" style="text-decoration: none;">‚Üê Dashboard</a>
            </div>
            <div class="user-info">
                <span id="user-info">Caricamento...</span>
                <button id="logout-button" class="btn btn-primary">Logout</button>
            </div>
        </div>

        <div class="content">
            <div id="alert-container"></div>

            <div class="actions-bar">
                <button class="btn btn-success" onclick="openAttivitaModal()">‚ûï Aggiungi Attivit√†</button>
                
                <div class="filters">
                    <div class="filter-group">
                        <label>Periodo</label>
                        <div class="filter-range">
                            <input type="date" id="filter-data-da" placeholder="Da data">
                            <span class="filter-range-text">a</span>
                            <input type="date" id="filter-data-a" placeholder="A data">
                        </div>
                    </div>
                    
                    <div class="filter-group" id="filter-cliente-group" style="display: none;">
                        <label>Cliente</label>
                        <select id="filter-cliente">
                            <option value="">Tutti i clienti</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>Terreno</label>
                        <select id="filter-terreno">
                            <option value="">Tutti i terreni</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>Tipo Lavoro</label>
                        <select id="filter-tipo-lavoro">
                            <option value="">Tutti i tipi lavoro</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>Coltura</label>
                        <select id="filter-coltura">
                            <option value="">Tutte le colture</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>Cerca Note</label>
                        <input type="text" id="filter-ricerca" placeholder="Cerca nelle note...">
                    </div>
                    
                    <div class="filter-group">
                        <label>&nbsp;</label>
                        <button class="btn btn-secondary" onclick="clearFilters()">Pulisci Filtri</button>
                    </div>
                </div>
            </div>

            <div class="section-header">
                <h2>Le Tue Attivit√†</h2>
            </div>

            <div id="attivita-container" style="display: none;">
                <div class="empty-state">
                    <div class="empty-state-icon">‚è≥</div>
                    <h3>Caricamento attivit√†...</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Attivit√† -->
    <!-- Modal Mappa Zone Lavorate -->
    <div id="mappa-zone-modal" class="modal">
        <div class="modal-content" style="max-width: 90vw; width: 1200px;">
            <div class="modal-header">
                <h2 id="mappa-zone-title">Zone Lavorate</h2>
                <button class="close-modal" onclick="closeMappaZoneModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="mappa-zone-container" style="width: 100%; height: 600px; border-radius: 8px; overflow: hidden; margin-bottom: 15px;"></div>
                <div id="mappa-zone-info" style="padding: 10px; background: #f8f9fa; border-radius: 6px; font-size: 14px; color: #666;"></div>
            </div>
        </div>
    </div>

    <div id="attivita-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Aggiungi Attivit√†</h2>
                <button class="close-modal" onclick="closeAttivitaModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="attivita-form" onsubmit="handleSaveAttivita(event)">
                    <div class="form-group">
                        <label for="attivita-data">Data *</label>
                        <input type="date" id="attivita-data" required max="">
                    </div>

                    <div class="form-group">
                        <label for="attivita-terreno">Terreno *</label>
                        <select id="attivita-terreno" required>
                            <option value="">-- Seleziona terreno --</option>
                        </select>
                    </div>

                    <!-- Sezione Conto Terzi (solo se modalit√† Conto Terzi) -->
                    <div id="attivita-conto-terzi-section" style="display: none; border-top: 2px solid #e9ecef; padding-top: 20px; margin-top: 20px;">
                        <h3 style="margin-bottom: 15px; color: #1976D2; font-size: 18px;">üíº Conto Terzi</h3>
                        
                        <div class="form-group">
                            <label for="attivita-cliente">Cliente *</label>
                            <select id="attivita-cliente" required>
                                <option value="">-- Seleziona cliente --</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="attivita-lavoro">Lavoro *</label>
                            <select id="attivita-lavoro" required>
                                <option value="">-- Seleziona lavoro --</option>
                            </select>
                            <small style="color: #666; font-size: 12px;">Il terreno verr√† precompilato automaticamente dal lavoro selezionato</small>
                        </div>

                        <div class="form-group">
                            <label for="attivita-ore-manuali">Ore Lavorate *</label>
                            <input type="number" id="attivita-ore-manuali" step="0.1" min="0" required placeholder="Es: 8.5">
                            <small style="color: #666; font-size: 12px;">Inserisci manualmente le ore lavorate (senza validazione)</small>
                        </div>
                    </div>

                    <!-- Struttura gerarchica (quando Macchine o Manodopera attivo) -->
                    <div id="attivita-categoria-group" style="display: none;">
                        <div class="form-group">
                            <label for="attivita-categoria-principale">Categoria Principale Lavoro *</label>
                            <div style="display: flex; gap: 5px;">
                                <select id="attivita-categoria-principale" style="flex: 1;">
                                    <option value="">-- Seleziona categoria principale --</option>
                                </select>
                                <button type="button" class="btn btn-info btn-sm" onclick="openCategoriaLavoroModal()" style="white-space: nowrap;">‚ûï Nuova</button>
                            </div>
                            <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                                Seleziona la categoria funzionale principale del lavoro
                            </small>
                        </div>

                        <div class="form-group" id="attivita-sottocategoria-group" style="display: none;">
                            <label for="attivita-sottocategoria">Sottocategoria</label>
                            <select id="attivita-sottocategoria" style="flex: 1;">
                                <option value="">-- Nessuna sottocategoria --</option>
                            </select>
                            <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                                Sottocategoria specifica (opzionale, se disponibile)
                            </small>
                        </div>

                        <div class="form-group" id="attivita-tipo-lavoro-gerarchico-group" style="display: none;">
                            <label for="attivita-tipo-lavoro-gerarchico">Tipo Lavoro Specifico *</label>
                            <div style="display: flex; gap: 5px;">
                                <select id="attivita-tipo-lavoro-gerarchico" style="flex: 1;">
                                    <option value="">-- Seleziona tipo lavoro --</option>
                                </select>
                                <button type="button" class="btn btn-info btn-sm" onclick="openTipoLavoroModal()" style="white-space: nowrap;">‚ûï Nuovo</button>
                            </div>
                            <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                                Seleziona il tipo specifico di lavoro nella categoria selezionata
                            </small>
                        </div>
                        
                        <div class="form-group">
                            <label for="attivita-coltura-gerarchica">Coltura *</label>
                            <select id="attivita-coltura-gerarchica">
                                <option value="">-- Seleziona coltura --</option>
                            </select>
                            <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                                La coltura viene precompilata automaticamente dal terreno selezionato
                            </small>
                        </div>
                    </div>

                    <!-- Lista piatta (solo quando nessun modulo attivo) -->
                    <div id="attivita-tipo-lavoro-piatto-group">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="attivita-tipo-lavoro">Tipo Lavoro *</label>
                                <select id="attivita-tipo-lavoro">
                                    <option value="">-- Seleziona tipo lavoro --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="attivita-coltura">Coltura *</label>
                                <select id="attivita-coltura">
                                    <option value="">-- Seleziona coltura --</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="attivita-orario-inizio">Orario Inizio *</label>
                            <input type="time" id="attivita-orario-inizio" required>
                        </div>
                        <div class="form-group">
                            <label for="attivita-orario-fine">Orario Fine (opzionale)</label>
                            <input type="time" id="attivita-orario-fine">
                            <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">
                                Compila quando finisci l'attivit√† per liberare automaticamente le macchine
                            </small>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="attivita-pause">Pause (minuti) *</label>
                        <input type="number" id="attivita-pause" min="0" value="0" required>
                    </div>

                    <div class="ore-nette-display">
                        <div>Ore Nette Lavorate</div>
                        <strong id="ore-nette-display">0.00</strong> ore
                    </div>

                    <div class="form-group">
                        <label for="attivita-note">Note</label>
                        <textarea id="attivita-note" placeholder="Note aggiuntive sull'attivit√†..."></textarea>
                    </div>

                    <!-- Sezione Macchine (solo se modulo Parco Macchine attivo) -->
                    <div id="attivita-macchine-section" style="display: none; border-top: 2px solid #e9ecef; padding-top: 20px; margin-top: 20px;">
                        <h3 style="margin-bottom: 15px; color: #2E8B57; font-size: 18px;">üöú Macchine Utilizzate</h3>
                        
                        <div class="form-group">
                            <label for="attivita-macchina">Trattore (Opzionale)</label>
                            <select id="attivita-macchina">
                                <option value="">-- Nessun trattore --</option>
                            </select>
                            <small style="color: #666; font-size: 12px;">Seleziona il trattore utilizzato per questa attivit√†</small>
                        </div>

                        <div class="form-group" id="attivita-attrezzo-group" style="display: none;">
                            <label for="attivita-attrezzo">Attrezzo (Opzionale)</label>
                            <select id="attivita-attrezzo">
                                <option value="">-- Nessun attrezzo --</option>
                            </select>
                            <small style="color: #666; font-size: 12px;">Seleziona l'attrezzo utilizzato (compatibile con il trattore selezionato)</small>
                        </div>

                        <div class="form-group" id="attivita-ore-macchina-group" style="display: none;">
                            <label for="attivita-ore-macchina">Ore Macchina</label>
                            <input type="number" id="attivita-ore-macchina" step="0.1" min="0" placeholder="Ore effettive macchina">
                            <small style="color: #666; font-size: 12px;">
                                Ore effettive di utilizzo macchina (default: uguale alle ore lavoratore).
                                <br>Esempio: lavoro durato 9 ore, ma macchina usata solo 7 ore ‚Üí inserisci 7
                            </small>
                            <div id="ore-macchina-display" style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 6px; font-size: 14px; color: #666;">
                                <strong>Ore lavoratore:</strong> <span id="ore-lavoratore-display">0.00</span> ore
                            </div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeAttivitaModal()">Annulla</button>
                        <button type="submit" class="btn btn-success">Salva Attivit√†</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Categoria Lavoro -->
    <div id="categoria-lavoro-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Nuova Categoria Lavoro</h3>
                <button class="close-btn" onclick="closeCategoriaLavoroModal()">&times;</button>
            </div>
            <form id="categoria-lavoro-form" onsubmit="handleSalvaCategoriaLavoro(event)">
                <div class="form-group">
                    <label for="categoria-lavoro-nome">Nome Categoria *</label>
                    <input type="text" id="categoria-lavoro-nome" required placeholder="es. Potatura">
                </div>

                <div class="form-group">
                    <label for="categoria-lavoro-descrizione">Descrizione</label>
                    <textarea id="categoria-lavoro-descrizione" placeholder="Descrizione opzionale della categoria..."></textarea>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">Salva</button>
                    <button type="button" class="btn btn-secondary" onclick="closeCategoriaLavoroModal()">Annulla</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Tipo Lavoro -->
    <div id="tipo-lavoro-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Nuovo Tipo Lavoro</h3>
                <button class="close-btn" onclick="closeTipoLavoroModal()">&times;</button>
            </div>
            <form id="tipo-lavoro-form" onsubmit="handleSalvaTipoLavoro(event)">
                <div class="form-group">
                    <label for="tipo-lavoro-nome">Nome Tipo Lavoro *</label>
                    <input type="text" id="tipo-lavoro-nome" required placeholder="es. Aratura">
                    <small>Nome specifico del tipo di lavoro</small>
                </div>

                <div class="form-group">
                    <label for="tipo-lavoro-categoria">Categoria *</label>
                    <select id="tipo-lavoro-categoria" required>
                        <option value="">-- Seleziona categoria --</option>
                    </select>
                    <small>La categoria selezionata nel form sar√† pre-compilata</small>
                </div>

                <div class="form-group">
                    <label for="tipo-lavoro-descrizione">Descrizione</label>
                    <textarea id="tipo-lavoro-descrizione" placeholder="Descrizione opzionale del tipo lavoro..."></textarea>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">Salva</button>
                    <button type="button" class="btn btn-secondary" onclick="closeTipoLavoroModal()">Annulla</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Load Google Maps config -->
    <script>
        function loadMapsConfig() {
            return new Promise((resolve, reject) => {
                if (typeof window.googleMapsConfig !== 'undefined') {
                    resolve();
                    return;
                }

                const mapsConfigScript = document.createElement('script');
                // Prova prima il file in core/config/, poi quello in core/
                mapsConfigScript.src = 'config/google-maps-config.js';
                
                mapsConfigScript.onload = function() {
                    setTimeout(() => {
                        // Verifica se la config √® stata caricata (pu√≤ essere window.googleMapsConfig o window.GOOGLE_MAPS_API_KEY)
                        if (typeof window.googleMapsConfig !== 'undefined' || typeof window.GOOGLE_MAPS_API_KEY !== 'undefined') {
                            // Se abbiamo solo GOOGLE_MAPS_API_KEY, crea googleMapsConfig
                            if (typeof window.googleMapsConfig === 'undefined' && typeof window.GOOGLE_MAPS_API_KEY !== 'undefined') {
                                window.googleMapsConfig = { apiKey: window.GOOGLE_MAPS_API_KEY };
                            }
                            resolve();
                        } else {
                            loadFallbackMapsConfig().then(resolve).catch(reject);
                        }
                    }, 100);
                };
                
                mapsConfigScript.onerror = function() {
                    // Prova anche il file nella root di core/
                    const altScript = document.createElement('script');
                    altScript.src = 'google-maps-config.js';
                    altScript.onload = function() {
                        setTimeout(() => {
                            if (typeof window.googleMapsConfig !== 'undefined' || typeof window.GOOGLE_MAPS_API_KEY !== 'undefined') {
                                if (typeof window.googleMapsConfig === 'undefined' && typeof window.GOOGLE_MAPS_API_KEY !== 'undefined') {
                                    window.googleMapsConfig = { apiKey: window.GOOGLE_MAPS_API_KEY };
                                }
                                resolve();
                            } else {
                                loadFallbackMapsConfig().then(resolve).catch(reject);
                            }
                        }, 100);
                    };
                    altScript.onerror = function() {
                        loadFallbackMapsConfig().then(resolve).catch(reject);
                    };
                    document.head.appendChild(altScript);
                };
                
                document.head.appendChild(mapsConfigScript);
            });
        }

        function loadFallbackMapsConfig() {
            return new Promise((resolve, reject) => {
                const fallbackScript = document.createElement('script');
                fallbackScript.src = 'https://raw.githubusercontent.com/VitaraDragon/gfv-platform/main/core/config/google-maps-config.js';
                
                fallbackScript.onload = function() {
                    setTimeout(() => {
                        if (typeof window.googleMapsConfig !== 'undefined') {
                            resolve();
                        } else {
                            reject(new Error('Google Maps config not found'));
                        }
                    }, 100);
                };
                
                fallbackScript.onerror = function() {
                    reject(new Error('Failed to load Google Maps config'));
                };
                
                document.head.appendChild(fallbackScript);
            });
        }

        let mapsApiLoaded = false;
        
        function loadGoogleMapsAPI() {
            if (mapsApiLoaded || typeof google !== 'undefined') {
                return Promise.resolve();
            }
            
            return loadMapsConfig().then(() => {
                // Gestisci entrambi i formati: window.googleMapsConfig o window.GOOGLE_MAPS_API_KEY
                let apiKey = null;
                if (window.googleMapsConfig && window.googleMapsConfig.apiKey) {
                    apiKey = window.googleMapsConfig.apiKey;
                } else if (window.GOOGLE_MAPS_API_KEY) {
                    apiKey = window.GOOGLE_MAPS_API_KEY;
                    // Crea googleMapsConfig per compatibilit√†
                    window.googleMapsConfig = { apiKey: apiKey };
                }
                
                if (!apiKey) {
                    console.warn('Google Maps API key non configurata');
                    return Promise.resolve();
                }
                
                console.log('üîë Caricamento Google Maps API con chiave:', apiKey.substring(0, 10) + '...');
                
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=geometry`;
                    script.async = true;
                    script.defer = true;
                    script.onload = () => {
                        mapsApiLoaded = true;
                        console.log('‚úÖ Google Maps API caricata con successo');
                        resolve();
                    };
                    script.onerror = () => {
                        console.error('‚ùå Errore caricamento Google Maps API');
                        reject(new Error('Failed to load Google Maps API'));
                    };
                    document.head.appendChild(script);
                });
            }).catch(error => {
                console.warn('‚ö†Ô∏è Google Maps config non disponibile, continuo senza mappa:', error);
                // Non bloccare l'applicazione se Google Maps non √® disponibile
                return Promise.resolve();
            });
        }
    </script>

    <!-- Load Firebase config from external file -->
    <!-- Fallback: usa raw GitHub se il file locale non √® disponibile (per GitHub Pages) -->
    <script>
        function loadConfig() {
            return new Promise((resolve, reject) => {
                if (typeof window.firebaseConfig !== 'undefined') {
                    resolve();
                    return;
                }

                const configScript = document.createElement('script');
                configScript.src = 'config/firebase-config.js';
                
                configScript.onload = function() {
                    setTimeout(() => {
                        if (typeof window.firebaseConfig !== 'undefined') {
                            resolve();
                        } else {
                            loadFallbackConfig().then(resolve).catch(reject);
                        }
                    }, 100);
                };
                
                configScript.onerror = function() {
                    loadFallbackConfig().then(resolve).catch(reject);
                };
                
                document.head.appendChild(configScript);
            });
        }

        function loadFallbackConfig() {
            return new Promise((resolve, reject) => {
                const fallbackScript = document.createElement('script');
                fallbackScript.src = 'https://raw.githubusercontent.com/VitaraDragon/gfv-platform/main/core/config/firebase-config.js';
                
                fallbackScript.onload = function() {
                    setTimeout(() => {
                        if (typeof window.firebaseConfig !== 'undefined') {
                            resolve();
                        } else {
                            reject(new Error('Firebase config not found even after loading from GitHub'));
                        }
                    }, 100);
                };
                
                fallbackScript.onerror = function() {
                    reject(new Error('Failed to load Firebase config from GitHub'));
                };
                
                document.head.appendChild(fallbackScript);
            });
        }

        loadConfig().catch(error => {
            console.error('Errore caricamento config:', error);
        });
    </script>
    
    <!-- Firebase SDK -->
    <script type="module">
        // Attendi che lo script config sia caricato
        function waitForConfig() {
            return new Promise((resolve, reject) => {
                if (typeof window.firebaseConfig !== 'undefined') {
                    resolve(window.firebaseConfig);
                    return;
                }
                
                let attempts = 0;
                const maxAttempts = 50;
                
                const checkInterval = setInterval(() => {
                    attempts++;
                    if (typeof window.firebaseConfig !== 'undefined') {
                        clearInterval(checkInterval);
                        resolve(window.firebaseConfig);
                    } else if (attempts >= maxAttempts) {
                        clearInterval(checkInterval);
                        reject(new Error('Firebase config not loaded after 5 seconds'));
                    }
                }, 100);
            });
        }

        const firebaseConfig = await waitForConfig();

        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { 
            getFirestore, 
            collection, 
            doc, 
            getDoc, 
            getDocs, 
            addDoc, 
            updateDoc, 
            deleteDoc, 
            query, 
            orderBy, 
            where, 
            serverTimestamp 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // Import service unificato macchine (solo se modulo attivo)
        let macchineUtilizzoService = null;
        if (typeof window !== 'undefined') {
            // Carica service dinamicamente quando necessario
            window.loadMacchineUtilizzoService = async function() {
                if (!macchineUtilizzoService) {
                    // Verifica se siamo in ambiente file:// (non supportato per moduli ES6)
                    const isFileProtocol = window.location.protocol === 'file:';
                    if (isFileProtocol) {
                        // In ambiente file://, i moduli ES6 non funzionano a causa di CORS
                        // L'applicazione continuer√† a funzionare ma senza le funzionalit√† avanzate del service
                        console.debug('‚ö†Ô∏è Ambiente file:// rilevato: il service macchine non pu√≤ essere caricato. Usa un server HTTP per funzionalit√† complete.');
                        return null;
                    }
                    
                    try {
                        const module = await import('../../modules/parco-macchine/services/macchine-utilizzo-service.js');
                        macchineUtilizzoService = module;
                        return module;
                    } catch (error) {
                        // Errore gi√† gestito, non loggare se √® un errore CORS in ambiente file://
                        if (!isFileProtocol) {
                            console.warn('Errore caricamento service macchine:', error);
                        }
                        return null;
                    }
                }
                return macchineUtilizzoService;
            };
        }

        // Inizializza Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Variabili globali
        let attivita = [];
        let terreni = [];
        let tipiLavoro = [];
        let colture = [];
        let currentAttivitaId = null;
        let currentTenantId = null;
        let filteredAttivita = [];
        let macchineList = [];
        let hasParcoMacchineModule = false;
        let hasManodoperaModule = false;
        let isContoTerziMode = false; // Modalit√† Conto Terzi (filtro su lavori conto terzi)
        let lavoriList = []; // Lista lavori per filtrare in modalit√† Conto Terzi
        let clientiList = []; // Lista clienti per dropdown
        
        // Variabili per struttura gerarchica (quando Macchine o Manodopera attivo)
        let categorieLavoriPrincipali = [];
        let sottocategorieLavoriMap = new Map();
        let tipiLavoroList = [];

        // Funzione helper: ottieni tenant ID
        async function getTenantId(userId) {
            if (currentTenantId) return currentTenantId;
            
            try {
                const userDoc = await getDoc(doc(db, 'users', userId));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    currentTenantId = userData.tenantId;
                    return currentTenantId;
                }
            } catch (error) {
                console.error('Errore recupero tenant:', error);
            }
            return null;
        }

        // Funzione helper: ottieni collection
        function getAttivitaCollection(tenantId) {
            if (!tenantId) throw new Error('Tenant ID non disponibile');
            return collection(db, `tenants/${tenantId}/attivita`);
        }

        function getTerreniCollection(tenantId) {
            if (!tenantId) throw new Error('Tenant ID non disponibile');
            return collection(db, `tenants/${tenantId}/terreni`);
        }

        // Aggiorna stato macchina (disponibile/in_uso)
        async function updateMacchinaStato(macchinaId, nuovoStato) {
            try {
                if (!macchinaId) return;
                
                const macchinaRef = doc(db, 'tenants', currentTenantId, 'macchine', macchinaId);
                await updateDoc(macchinaRef, {
                    stato: nuovoStato,
                    updatedAt: serverTimestamp()
                });
                console.log(`‚úÖ Macchina ${macchinaId} impostata come ${nuovoStato}`);
            } catch (error) {
                console.error(`‚ùå Errore aggiornamento stato macchina ${macchinaId}:`, error);
                // Non bloccare il salvataggio attivit√† se c'√® un errore con la macchina
            }
        }

        // Verifica conflitti di orario per macchine/attrezzi
        function verificaConflittiMacchine(macchinaId, attrezzoId, data, orarioInizio, orarioFine, attivitaIdEsclusa = null) {
            if (!macchinaId && !attrezzoId) {
                return null; // Nessun controllo se non ci sono macchine
            }

            // Converte orario in minuti totali dalla mezzanotte
            function orarioToMinuti(orario) {
                if (!orario) return null;
                const [ore, minuti] = orario.split(':').map(Number);
                return ore * 60 + minuti;
            }

            const inizioMinuti = orarioToMinuti(orarioInizio);
            if (inizioMinuti === null) {
                return null; // Se non c'√® orario inizio, non possiamo verificare
            }

            const fineMinuti = orarioFine ? orarioToMinuti(orarioFine) : null;
            // Se non c'√® orario fine per la nuova attivit√†, considera fino alla fine della giornata (23:59)
            const fineEffettiva = fineMinuti !== null ? fineMinuti : 23 * 60 + 59;
            
            console.log('üîç Verifica conflitti:', {
                macchinaId,
                attrezzoId,
                data,
                orarioInizio,
                orarioFine,
                inizioMinuti,
                fineEffettiva,
                attivitaIdEsclusa,
                totaleAttivita: attivita.length
            });

            // Cerca conflitti nelle attivit√† esistenti
            for (const attivitaEsistente of attivita) {
                // Escludi l'attivit√† corrente se si sta modificando
                if (attivitaIdEsclusa && attivitaEsistente.id === attivitaIdEsclusa) {
                    console.log(`  ‚è≠Ô∏è Escludo attivit√† ${attivitaEsistente.id} (modifica)`);
                    continue;
                }

                // Controlla solo attivit√† della stessa data
                if (attivitaEsistente.data !== data) {
                    continue;
                }
                
                console.log(`  üìã Controllo attivit√† ${attivitaEsistente.id}:`, {
                    data: attivitaEsistente.data,
                    orarioInizio: attivitaEsistente.orarioInizio,
                    orarioFine: attivitaEsistente.orarioFine,
                    macchinaId: attivitaEsistente.macchinaId,
                    attrezzoId: attivitaEsistente.attrezzoId
                });

                // Verifica conflitto trattore
                if (macchinaId && attivitaEsistente.macchinaId === macchinaId) {
                    const esistenteInizio = orarioToMinuti(attivitaEsistente.orarioInizio);
                    if (esistenteInizio === null) continue; // Skip se non ha orario inizio
                    
                    // Se l'attivit√† esistente ha orario fine, usa quello, altrimenti considera fino fine giornata
                    const esistenteFine = attivitaEsistente.orarioFine 
                        ? orarioToMinuti(attivitaEsistente.orarioFine) 
                        : 23 * 60 + 59; // Se non ha ora fine, considera fino fine giornata

                    // Verifica sovrapposizione: due intervalli si sovrappongono se:
                    // nuovoInizio < esistenteFine E nuovoFine > esistenteInizio
                    // Ma dobbiamo anche considerare che se l'attivit√† esistente √® completata (ha orario fine),
                    // la nuova attivit√† pu√≤ iniziare esattamente quando finisce quella esistente
                    const siSovrappongono = inizioMinuti < esistenteFine && fineEffettiva > esistenteInizio;
                    
                    // Se l'attivit√† esistente √® completata (ha orario fine) e la nuova inizia quando finisce o dopo, non c'√® conflitto
                    const iniziaQuandoFinisceEsistente = attivitaEsistente.orarioFine && inizioMinuti >= esistenteFine;
                    
                    if (siSovrappongono && !iniziaQuandoFinisceEsistente) {
                        const macchinaNome = macchineList.find(m => m.id === macchinaId)?.nome || 'Trattore';
                        return {
                            tipo: 'trattore',
                            macchinaNome: macchinaNome,
                            conflitto: attivitaEsistente,
                            messaggio: `Il trattore "${macchinaNome}" √® gi√† in uso dalle ${attivitaEsistente.orarioInizio}${attivitaEsistente.orarioFine ? ` alle ${attivitaEsistente.orarioFine}` : ' (attivit√† in corso)'} per "${attivitaEsistente.tipoLavoro}" sul terreno "${attivitaEsistente.terrenoNome}"`
                        };
                    }
                }

                // Verifica conflitto attrezzo
                if (attrezzoId && attivitaEsistente.attrezzoId === attrezzoId) {
                    const esistenteInizio = orarioToMinuti(attivitaEsistente.orarioInizio);
                    if (esistenteInizio === null) continue; // Skip se non ha orario inizio
                    
                    const esistenteFine = attivitaEsistente.orarioFine 
                        ? orarioToMinuti(attivitaEsistente.orarioFine) 
                        : 23 * 60 + 59;

                    const siSovrappongono = inizioMinuti < esistenteFine && fineEffettiva > esistenteInizio;
                    // Se l'attivit√† esistente √® completata (ha orario fine) e la nuova inizia quando finisce o dopo, non c'√® conflitto
                    const iniziaQuandoFinisceEsistente = attivitaEsistente.orarioFine && inizioMinuti >= esistenteFine;
                    
                    if (siSovrappongono && !iniziaQuandoFinisceEsistente) {
                        const attrezzoNome = macchineList.find(m => m.id === attrezzoId)?.nome || 'Attrezzo';
                        return {
                            tipo: 'attrezzo',
                            attrezzoNome: attrezzoNome,
                            conflitto: attivitaEsistente,
                            messaggio: `L'attrezzo "${attrezzoNome}" √® gi√† in uso dalle ${attivitaEsistente.orarioInizio}${attivitaEsistente.orarioFine ? ` alle ${attivitaEsistente.orarioFine}` : ' (attivit√† in corso)'} per "${attivitaEsistente.tipoLavoro}" sul terreno "${attivitaEsistente.terrenoNome}"`
                        };
                    }
                }
            }

            return null; // Nessun conflitto
        }

        // Verifica autenticazione
        let currentUserData = null;
        
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = './auth/login-standalone.html';
                return;
            }

            // Rileva parametri URL per modalit√† Conto Terzi
            const urlParams = new URLSearchParams(window.location.search);
            isContoTerziMode = urlParams.get('contoTerzi') === 'true';
            const statoFiltro = urlParams.get('stato'); // es: in_corso

            // Applica gradiente blu se modalit√† Conto Terzi (sempre blu per coerenza)
            if (isContoTerziMode) {
                const urlParams = new URLSearchParams(window.location.search);
                const statoFiltro = urlParams.get('stato');
                
                // Sempre gradiente blu per coerenza con modulo conto terzi
                document.body.style.background = 'linear-gradient(180deg, #E3F2FD 0%, #1976D2 100%)';
                
                const header = document.getElementById('main-header') || document.querySelector('.header');
                if (header) {
                    // Sempre gradiente blu per coerenza con modulo conto terzi
                    header.style.background = 'linear-gradient(180deg, #1976D2 0%, #1565C0 100%)';
                    // Assicurati che l'header sia visibile
                    header.style.visibility = 'visible';
                }
                
                // Modifica titolo header
                const headerTitle = document.querySelector('.header h1');
                if (headerTitle) {
                    if (statoFiltro === 'completato') {
                        headerTitle.textContent = '‚úÖ Lavori Completati - Conto Terzi';
                    } else {
                        headerTitle.textContent = 'Diario Attivit√† - Conto Terzi';
                    }
                }
                
                // Mostra filtro cliente se modalit√† conto terzi
                const filterClienteGroup = document.getElementById('filter-cliente-group');
                if (filterClienteGroup) {
                    filterClienteGroup.style.display = 'block';
                }
                
                // Imposta link dashboard corretto (percorso relativo da core/ a modules/)
                const dashboardLink = document.getElementById('dashboard-link');
                if (dashboardLink) {
                    dashboardLink.href = '../modules/conto-terzi/views/conto-terzi-home-standalone.html';
                }
            } else {
                // Modalit√† normale, nascondi filtro cliente e link alla dashboard principale
                const filterClienteGroup = document.getElementById('filter-cliente-group');
                if (filterClienteGroup) {
                    filterClienteGroup.style.display = 'none';
                }
                
                const dashboardLink = document.getElementById('dashboard-link');
                if (dashboardLink) {
                    dashboardLink.href = 'dashboard-standalone.html';
                }
            }

            try {
                // Carica dati utente e tenant
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    currentUserData = { id: user.uid, ...userData };
                    const nomeCompleto = `${userData.nome || ''} ${userData.cognome || ''}`.trim();
                    const email = userData.email || user.email;
                    document.getElementById('user-info').textContent = 
                        `Utente: ${nomeCompleto || 'N/A'} (${email})`;
                    
                    currentTenantId = userData.tenantId;
                }
            } catch (error) {
                console.error('Errore caricamento utente:', error);
            }

            // Imposta max date a oggi
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('attivita-data').max = today;

            // Verifica moduli attivi
            try {
                if (currentTenantId) {
                    const tenantDoc = await getDoc(doc(db, 'tenants', currentTenantId));
                    if (tenantDoc.exists()) {
                        const tenantData = tenantDoc.data();
                        hasParcoMacchineModule = tenantData.modules && tenantData.modules.includes('parcoMacchine');
                        hasManodoperaModule = tenantData.modules && tenantData.modules.includes('manodopera');
                        
                        // Mostra/nascondi sezione macchine
                        const macchineSection = document.getElementById('attivita-macchine-section');
                        if (macchineSection) {
                            macchineSection.style.display = hasParcoMacchineModule ? 'block' : 'none';
                        }
                        
                        // Mostra/nascondi struttura gerarchica o lista piatta
                        const categoriaGroup = document.getElementById('attivita-categoria-group');
                        const tipoLavoroPiattoGroup = document.getElementById('attivita-tipo-lavoro-piatto-group');
                        const tipoLavoroSelect = document.getElementById('attivita-tipo-lavoro');
                        const tipoLavoroGerarchicoSelect = document.getElementById('attivita-tipo-lavoro-gerarchico');
                        
                        // Usa struttura gerarchica se Macchine o Manodopera attivo
                        const usaStrutturaGerarchica = hasParcoMacchineModule || hasManodoperaModule;
                        
                        if (categoriaGroup) {
                            categoriaGroup.style.display = usaStrutturaGerarchica ? 'block' : 'none';
                        }
                        if (tipoLavoroPiattoGroup) {
                            tipoLavoroPiattoGroup.style.display = usaStrutturaGerarchica ? 'none' : 'block';
                        }
                        
                        // Imposta required su quello corretto (solo se visibile)
                        if (tipoLavoroSelect) {
                            tipoLavoroSelect.required = !usaStrutturaGerarchica;
                            // Rimuovi required se nascosto
                            if (usaStrutturaGerarchica) {
                                tipoLavoroSelect.removeAttribute('required');
                            }
                        }
                        if (tipoLavoroGerarchicoSelect) {
                            tipoLavoroGerarchicoSelect.required = usaStrutturaGerarchica;
                            // Rimuovi required se nascosto
                            if (!usaStrutturaGerarchica) {
                                tipoLavoroGerarchicoSelect.removeAttribute('required');
                            }
                        }
                        
                        // Imposta required su categoria principale solo se struttura gerarchica attiva
                        const categoriaPrincipaleSelect = document.getElementById('attivita-categoria-principale');
                        if (categoriaPrincipaleSelect) {
                            if (usaStrutturaGerarchica) {
                                categoriaPrincipaleSelect.setAttribute('required', 'required');
                            } else {
                                categoriaPrincipaleSelect.removeAttribute('required');
                            }
                        }
                        
                        // Imposta required su coltura solo se lista piatta √® visibile
                        const colturaSelect = document.getElementById('attivita-coltura');
                        if (colturaSelect) {
                            if (usaStrutturaGerarchica) {
                                colturaSelect.removeAttribute('required');
                            } else {
                                colturaSelect.setAttribute('required', 'required');
                            }
                        }
                    }
                }
            } catch (error) {
                console.warn('Errore verifica moduli:', error);
            }

            // Carica dati
            const loadPromises = [loadTerreni(), loadListe(), loadAttivita()];
            if (hasParcoMacchineModule) {
                loadPromises.push(loadMacchine());
            }
            
            // Se modalit√† Conto Terzi, carica lavori e clienti
            if (isContoTerziMode) {
                loadPromises.push(loadLavoriContoTerzi(), loadClienti());
            }
            
            await Promise.all(loadPromises);
            
            // Mostra/nascondi sezione Conto Terzi e orari
            const contoTerziSection = document.getElementById('attivita-conto-terzi-section');
            const orariSection = document.querySelector('.form-row:has(#attivita-orario-inizio)');
            const pauseSection = document.querySelector('.form-group:has(#attivita-pause)');
            const oreNetteDisplay = document.querySelector('.ore-nette-display');
            
            if (isContoTerziMode) {
                // Mostra sezione Conto Terzi
                if (contoTerziSection) {
                    contoTerziSection.style.display = 'block';
                }
                // Nascondi orari e pause (usiamo ore manuali)
                if (orariSection) {
                    orariSection.style.display = 'none';
                }
                if (pauseSection) {
                    pauseSection.style.display = 'none';
                }
                if (oreNetteDisplay) {
                    oreNetteDisplay.style.display = 'none';
                }
                // Rimuovi required da orario inizio
                const orarioInizio = document.getElementById('attivita-orario-inizio');
                if (orarioInizio) {
                    orarioInizio.removeAttribute('required');
                }
            } else {
                // Nascondi sezione Conto Terzi
                if (contoTerziSection) {
                    contoTerziSection.style.display = 'none';
                }
                // Mostra orari e pause
                if (orariSection) {
                    orariSection.style.display = 'flex';
                }
                if (pauseSection) {
                    pauseSection.style.display = 'block';
                }
                if (oreNetteDisplay) {
                    oreNetteDisplay.style.display = 'block';
                }
            }

            // Nascondi container inizialmente se modalit√† conto terzi per evitare flash
            if (isContoTerziMode) {
                const container = document.getElementById('attivita-container');
                if (container) {
                    container.style.display = 'none';
                }
            }
            
            // Applica filtro automatico su lavori conto terzi se specificato
            if (isContoTerziMode && statoFiltro) {
                // Filtra automaticamente le attivit√† per lavori conto terzi con stato specificato
                setTimeout(() => {
                    applyContoTerziFilter(statoFiltro);
                    // Mostra container dopo aver applicato il filtro
                    const container = document.getElementById('attivita-container');
                    if (container) {
                        container.style.display = 'block';
                        container.style.visibility = 'visible';
                    }
                    // Assicurati che l'header sia visibile
                    const header = document.getElementById('main-header') || document.querySelector('.header');
                    if (header) {
                        header.style.visibility = 'visible';
                    }
                    // Mostra il body solo quando tutto √® pronto
                    document.body.style.visibility = 'visible';
                }, 150);
            } else if (isContoTerziMode) {
                // Se modalit√† conto terzi ma senza stato filtro, mostra solo attivit√† conto terzi
                filteredAttivita = attivita.filter(a => a.clienteId != null && a.clienteId !== '');
                renderAttivita();
                const container = document.getElementById('attivita-container');
                if (container) {
                    container.style.display = 'block';
                    container.style.visibility = 'visible';
                }
                // Mostra il body quando tutto √® pronto
                document.body.style.visibility = 'visible';
            } else {
                // Modalit√† normale, mostra container
                const container = document.getElementById('attivita-container');
                if (container) {
                    container.style.display = 'block';
                    container.style.visibility = 'visible';
                }
            }
            
            // Libera macchine di attivit√† del giorno precedente senza orario fine
            if (hasParcoMacchineModule) {
                await liberaMacchineAttivitaPrecedenti();
            }
            
            // Inizializza handler per struttura gerarchica se attiva
            const usaStrutturaGerarchica = hasParcoMacchineModule || hasManodoperaModule;
            if (usaStrutturaGerarchica) {
                setupCategoriaLavoroHandler();
            }
        });

        // Logout
        document.getElementById('logout-button').addEventListener('click', async () => {
            await signOut(auth);
            window.location.href = './auth/login-standalone.html';
        });

        // Carica macchine (solo se modulo Parco Macchine attivo)
        async function loadMacchine() {
            if (!hasParcoMacchineModule || !currentTenantId) return;
            
            try {
                const macchineRef = collection(db, 'tenants', currentTenantId, 'macchine');
                const snapshot = await getDocs(macchineRef);
                
                macchineList = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    macchineList.push({ id: doc.id, ...data });
                });
                
                // Popola dropdown trattori
                populateTrattoriDropdown();
            } catch (error) {
                console.error('Errore caricamento macchine:', error);
                macchineList = [];
            }
        }

        // Popola dropdown trattori
        function populateTrattoriDropdown(selectedTrattoreId = null) {
            const select = document.getElementById('attivita-macchina');
            if (!select) {
                console.warn('Dropdown attivita-macchina non trovato');
                return;
            }
            
            // Pulisci opzioni esistenti (mantieni solo la prima opzione vuota)
            while (select.options.length > 1) {
                select.remove(1);
            }
            
            if (!macchineList || macchineList.length === 0) {
                console.warn('Nessuna macchina disponibile nella lista');
                return;
            }
            
            // Filtra e ordina trattori (escludi solo quelli dismessi)
            const trattori = macchineList
                .filter(macchina => {
                    const tipoMacchina = macchina.tipoMacchina || macchina.tipo;
                    return tipoMacchina === 'trattore' && macchina.stato !== 'dismesso';
                })
                .sort((a, b) => {
                    const nomeA = (a.nome || '').toLowerCase();
                    const nomeB = (b.nome || '').toLowerCase();
                    return nomeA.localeCompare(nomeB);
                });
            
            // Aggiungi trattori al dropdown
            trattori.forEach(macchina => {
                const option = document.createElement('option');
                option.value = macchina.id;
                const nome = macchina.nome || 'Trattore senza nome';
                const cavalli = macchina.cavalli ? ` (${macchina.cavalli} CV)` : '';
                const stato = macchina.stato === 'disponibile' ? '‚úÖ' : 
                             macchina.stato === 'in_uso' ? 'üîÑ' : 
                             macchina.stato === 'in_manutenzione' ? 'üîß' : 
                             macchina.stato === 'guasto' ? '‚ùå' : '';
                option.textContent = `${stato} ${nome}${cavalli}`;
                // NON disabilitiamo i trattori in_uso: il controllo di conflitto al salvataggio gestir√† tutto
                // Questo permette di selezionare trattori anche se sono in_uso per altre attivit√† in orari diversi
                option.disabled = false;
                if (macchina.id === selectedTrattoreId) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }

        // Popola dropdown attrezzi compatibili con trattore selezionato
        function populateAttrezziDropdown(trattoreId, selectedAttrezzoId = null) {
            const select = document.getElementById('attivita-attrezzo');
            const group = document.getElementById('attivita-attrezzo-group');
            if (!select || !group) return;
            
            // Pulisci opzioni esistenti
            while (select.options.length > 1) {
                select.remove(1);
            }
            
            if (!trattoreId) {
                group.style.display = 'none';
                return;
            }
            
            group.style.display = 'block';
            
            // Trova trattore selezionato
            const trattore = macchineList.find(m => m.id === trattoreId);
            if (!trattore || !trattore.cavalli) {
                return;
            }
            
            // Filtra e ordina attrezzi compatibili (escludi solo quelli dismessi)
            const attrezziCompatibili = macchineList
                .filter(macchina => {
                    const tipoMacchina = macchina.tipoMacchina || macchina.tipo;
                    if (tipoMacchina !== 'attrezzo' || macchina.stato === 'dismesso') {
                        return false;
                    }
                    const cavalliMinimi = macchina.cavalliMinimiRichiesti || 0;
                    return trattore.cavalli >= cavalliMinimi;
                })
                .sort((a, b) => {
                    const nomeA = (a.nome || '').toLowerCase();
                    const nomeB = (b.nome || '').toLowerCase();
                    return nomeA.localeCompare(nomeB);
                });
            
            // Aggiungi attrezzi compatibili al dropdown
            attrezziCompatibili.forEach(macchina => {
                const option = document.createElement('option');
                option.value = macchina.id;
                const nome = macchina.nome || 'Attrezzo senza nome';
                const stato = macchina.stato === 'disponibile' ? '‚úÖ' : 
                             macchina.stato === 'in_uso' ? 'üîÑ' : 
                             macchina.stato === 'in_manutenzione' ? 'üîß' : 
                             macchina.stato === 'guasto' ? '‚ùå' : '';
                option.textContent = `${stato} ${nome}`;
                // NON disabilitiamo gli attrezzi: il controllo di conflitto al salvataggio gestir√† tutto
                // Questo permette di selezionare attrezzi anche se sono in_uso per altre attivit√† in orari diversi
                option.disabled = false;
                if (macchina.id === selectedAttrezzoId) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }

        // Carica terreni
        async function loadTerreni() {
            try {
                if (!currentTenantId) return;

                const terreniCollection = getTerreniCollection(currentTenantId);
                // Carica tutti i terreni (sia interni che clienti)
                const querySnapshot = await getDocs(terreniCollection);
                
                terreni = [];
                querySnapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    terreni.push({
                        id: docSnap.id,
                        nome: data.nome || '',
                        coltura: data.coltura || null,
                        clienteId: data.clienteId || null, // Include anche terreni clienti
                        superficie: data.superficie || 0,
                        coordinate: data.coordinate || null, // Coordinate centro terreno
                        polygonCoords: data.polygonCoords || null // Confini terreno per mappa
                    });
                });
                
                // Ordina client-side per nome
                terreni.sort((a, b) => {
                    const nomeA = (a.nome || '').toLowerCase();
                    const nomeB = (b.nome || '').toLowerCase();
                    return nomeA.localeCompare(nomeB);
                });

                // Popola dropdown terreni
                const terrenoSelect = document.getElementById('attivita-terreno');
                const filterTerrenoSelect = document.getElementById('filter-terreno');
                
                terrenoSelect.innerHTML = '<option value="">-- Seleziona terreno --</option>';
                filterTerrenoSelect.innerHTML = '<option value="">Tutti i terreni</option>';
                
                // Filtra terreni in base alla modalit√†
                let terreniDaMostrare = terreni;
                if (isContoTerziMode) {
                    // In modalit√† conto terzi, mostra solo terreni clienti (con clienteId)
                    terreniDaMostrare = terreni.filter(t => t.clienteId != null && t.clienteId !== '');
                }
                
                terreniDaMostrare.forEach(terreno => {
                    const option1 = document.createElement('option');
                    option1.value = terreno.id;
                    option1.textContent = terreno.nome;
                    terrenoSelect.appendChild(option1);

                    const option2 = document.createElement('option');
                    option2.value = terreno.id;
                    option2.textContent = terreno.nome;
                    filterTerrenoSelect.appendChild(option2);
                });
                
                // Popola colture dai terreni (per campo gerarchico)
                populateColtureFromTerreni();
            } catch (error) {
                console.error('Errore caricamento terreni:', error);
            }
        }
        
        // Carica lavori conto terzi (solo se modalit√† Conto Terzi)
        async function loadLavoriContoTerzi() {
            try {
                if (!currentTenantId || !isContoTerziMode) return;

                // Carica tutti i lavori e filtra client-side per evitare indice composto
                const lavoriRef = collection(db, 'tenants', currentTenantId, 'lavori');
                const snapshot = await getDocs(lavoriRef);
                
                lavoriList = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    // Filtra solo lavori con clienteId (conto terzi)
                    if (data.clienteId != null && data.clienteId !== '') {
                        lavoriList.push({
                            id: doc.id,
                            ...data,
                            terrenoId: data.terrenoId || null,
                            clienteId: data.clienteId || null
                        });
                    }
                });
                
                // Ordina client-side per nome
                lavoriList.sort((a, b) => {
                    const nomeA = (a.nome || '').toLowerCase();
                    const nomeB = (b.nome || '').toLowerCase();
                    return nomeA.localeCompare(nomeB);
                });

                // Popola dropdown lavori nel form (solo lavori in corso se statoFiltro specificato)
                populateLavoriDropdown();
            } catch (error) {
                console.error('Errore caricamento lavori conto terzi:', error);
                lavoriList = [];
            }
        }

        // Carica clienti (solo se modalit√† Conto Terzi)
        async function loadClienti() {
            try {
                if (!currentTenantId || !isContoTerziMode) return;

                const clientiRef = collection(db, 'tenants', currentTenantId, 'clienti');
                const q = query(clientiRef, orderBy('ragioneSociale', 'asc'));
                const snapshot = await getDocs(q);
                
                clientiList = [];
                snapshot.forEach(doc => {
                    clientiList.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                // Popola dropdown clienti nel form
                populateClientiDropdown();
            } catch (error) {
                console.error('Errore caricamento clienti:', error);
                clientiList = [];
            }
        }

        // Popola dropdown lavori nel form (solo lavori conto terzi in corso)
        function populateLavoriDropdown() {
            const select = document.getElementById('attivita-lavoro');
            if (!select) return;

            // Filtra solo lavori in corso se statoFiltro specificato
            const urlParams = new URLSearchParams(window.location.search);
            const statoFiltro = urlParams.get('stato');
            const lavoriFiltrati = statoFiltro 
                ? lavoriList.filter(l => l.stato === statoFiltro)
                : lavoriList.filter(l => l.stato === 'in_corso'); // Default: solo in corso

            select.innerHTML = '<option value="">-- Seleziona lavoro --</option>';
            lavoriFiltrati.forEach(lavoro => {
                const option = document.createElement('option');
                option.value = lavoro.id;
                option.textContent = lavoro.nome || 'Lavoro senza nome';
                option.dataset.terrenoId = lavoro.terrenoId || '';
                option.dataset.clienteId = lavoro.clienteId || '';
                select.appendChild(option);
            });
        }

        // Popola dropdown clienti nel form
        function populateClientiDropdown() {
            const select = document.getElementById('attivita-cliente');
            if (!select) return;

            select.innerHTML = '<option value="">-- Seleziona cliente --</option>';
            clientiList.forEach(cliente => {
                const option = document.createElement('option');
                option.value = cliente.id;
                option.textContent = cliente.ragioneSociale || cliente.nome || 'Cliente senza nome';
                select.appendChild(option);
            });
            
            // Popola anche il filtro clienti se esiste
            const filterClienteSelect = document.getElementById('filter-cliente');
            if (filterClienteSelect) {
                filterClienteSelect.innerHTML = '<option value="">Tutti i clienti</option>';
                clientiList.forEach(cliente => {
                    const option = document.createElement('option');
                    option.value = cliente.id;
                    option.textContent = cliente.ragioneSociale || cliente.nome || 'Cliente senza nome';
                    filterClienteSelect.appendChild(option);
                });
            }
        }

        // Applica filtro automatico su attivit√† per lavori conto terzi
        function applyContoTerziFilter(statoFiltro) {
            // Filtra le attivit√† mostrate per lavori conto terzi con stato specificato
            const lavoriFiltrati = lavoriList.filter(l => l.stato === statoFiltro);
            const lavoriIds = lavoriFiltrati.map(l => l.id);
            
            // Filtra attivit√† per lavoriId (solo attivit√† conto terzi)
            filteredAttivita = attivita.filter(a => {
                // Deve essere un'attivit√† conto terzi (ha clienteId) e appartenere a un lavoro con lo stato specificato
                return a.clienteId != null && a.clienteId !== '' && a.lavoroId && lavoriIds.includes(a.lavoroId);
            });
            
            renderAttivita();
        }
        
        // Popola dropdown colture estraendole dai terreni esistenti
        function populateColtureFromTerreni() {
            // Estrai colture uniche dai terreni
            const coltureUniche = new Set();
            terreni.forEach(terreno => {
                if (terreno.coltura && terreno.coltura.trim()) {
                    coltureUniche.add(terreno.coltura.trim());
                }
            });
            
            // Ordina le colture
            const coltureOrdinate = Array.from(coltureUniche).sort();
            
            // Popola il campo coltura gerarchica
            const colturaGerarchicaSelect = document.getElementById('attivita-coltura-gerarchica');
            if (colturaGerarchicaSelect) {
                // Mantieni l'opzione vuota se esiste, altrimenti creala
                if (colturaGerarchicaSelect.options.length === 0 || colturaGerarchicaSelect.options[0].value !== '') {
                    colturaGerarchicaSelect.innerHTML = '<option value="">-- Seleziona coltura --</option>';
                } else {
                    // Rimuovi tutte le opzioni tranne la prima (vuota)
                    while (colturaGerarchicaSelect.options.length > 1) {
                        colturaGerarchicaSelect.remove(1);
                    }
                }
                
                // Aggiungi le colture
                coltureOrdinate.forEach(coltura => {
                    const option = document.createElement('option');
                    option.value = coltura;
                    option.textContent = coltura;
                    colturaGerarchicaSelect.appendChild(option);
                });
            }
            
            // Popola anche il campo coltura piatta se non √® gi√† stato popolato da loadListe
            const colturaSelect = document.getElementById('attivita-coltura');
            if (colturaSelect && colturaSelect.options.length <= 1) {
                // Se il campo √® vuoto (solo opzione vuota), popolalo anche qui
                coltureOrdinate.forEach(coltura => {
                    // Verifica che non esista gi√†
                    const esiste = Array.from(colturaSelect.options).some(opt => opt.value === coltura);
                    if (!esiste) {
                        const option = document.createElement('option');
                        option.value = coltura;
                        option.textContent = coltura;
                        colturaSelect.appendChild(option);
                    }
                });
            }
        }

        // Carica liste personalizzate (solo se nessun modulo attivo)
        async function loadListe() {
            try {
                if (!currentTenantId) return;
                
                // Se Macchine o Manodopera attivo, usa struttura gerarchica
                if (hasParcoMacchineModule || hasManodoperaModule) {
                    await loadCategorieLavori();
                    await loadTipiLavoro();
                    return;
                }
                
                // Altrimenti usa lista piatta
                const listeRef = doc(db, `tenants/${currentTenantId}/liste`, 'personalizzate');
                const listeSnap = await getDoc(listeRef);
                
                if (listeSnap.exists()) {
                    const data = listeSnap.data();
                    tipiLavoro = data.tipiLavoro || [];
                    colture = data.colture || [];
                } else {
                    // Predefiniti
                    tipiLavoro = ['Potatura', 'Raccolta', 'Trattamento', 'Semina', 'Aratura', 'Irrigazione', 'Concimazione', 'Diserbo', 'Raccolta frutta', 'Raccolta verdura'];
                    colture = ['Vite', 'Frutteto', 'Seminativo', 'Orto', 'Prato', 'Olivo', 'Agrumeto', 'Bosco'];
                }
                
                // Popola dropdown
                const tipoLavoroSelect = document.getElementById('attivita-tipo-lavoro');
                const colturaSelect = document.getElementById('attivita-coltura');
                const filterTipoLavoroSelect = document.getElementById('filter-tipo-lavoro');
                const filterColturaSelect = document.getElementById('filter-coltura');
                
                if (tipoLavoroSelect) {
                    tipoLavoroSelect.innerHTML = '<option value="">-- Seleziona tipo lavoro --</option>';
                }
                if (colturaSelect) {
                    colturaSelect.innerHTML = '<option value="">-- Seleziona coltura --</option>';
                }
                // Popola anche il campo coltura gerarchica se esiste
                const colturaGerarchicaSelect = document.getElementById('attivita-coltura-gerarchica');
                if (colturaGerarchicaSelect) {
                    colturaGerarchicaSelect.innerHTML = '<option value="">-- Seleziona coltura --</option>';
                }
                if (filterTipoLavoroSelect) {
                    filterTipoLavoroSelect.innerHTML = '<option value="">Tutti i tipi lavoro</option>';
                }
                if (filterColturaSelect) {
                    filterColturaSelect.innerHTML = '<option value="">Tutte le colture</option>';
                }
                
                tipiLavoro.forEach(item => {
                    if (tipoLavoroSelect) {
                        const option1 = document.createElement('option');
                        option1.value = item;
                        option1.textContent = item;
                        tipoLavoroSelect.appendChild(option1);
                    }

                    if (filterTipoLavoroSelect) {
                        const option2 = document.createElement('option');
                        option2.value = item;
                        option2.textContent = item;
                        filterTipoLavoroSelect.appendChild(option2);
                    }
                });
                
                colture.forEach(item => {
                    if (colturaSelect) {
                        const option1 = document.createElement('option');
                        option1.value = item;
                        option1.textContent = item;
                        colturaSelect.appendChild(option1);
                    }
                    
                    // Popola anche il campo coltura gerarchica se esiste
                    const colturaGerarchicaSelect = document.getElementById('attivita-coltura-gerarchica');
                    if (colturaGerarchicaSelect) {
                        const optionGerarchica = document.createElement('option');
                        optionGerarchica.value = item;
                        optionGerarchica.textContent = item;
                        colturaGerarchicaSelect.appendChild(optionGerarchica);
                    }

                    if (filterColturaSelect) {
                        const option2 = document.createElement('option');
                        option2.value = item;
                        option2.textContent = item;
                        filterColturaSelect.appendChild(option2);
                    }
                });
            } catch (error) {
                console.error('Errore caricamento liste:', error);
            }
        }
        
        // Carica categorie lavori principali e sottocategorie (da collezione unificata)
        async function loadCategorieLavori() {
            try {
                if (!currentTenantId) return;
                
                const categorieRef = collection(db, `tenants/${currentTenantId}/categorie`);
                
                // Carica tutte le categorie
                const snapshot = await getDocs(query(categorieRef, orderBy('ordine', 'asc')));
                categorieLavoriPrincipali = [];
                sottocategorieLavoriMap.clear();
                
                snapshot.forEach(doc => {
                    const catData = { id: doc.id, ...doc.data() };
                    
                    // Filtra solo categorie applicabili a lavori
                    if (catData.applicabileA === 'lavori' || catData.applicabileA === 'entrambi') {
                        if (!catData.parentId) {
                            // Categoria principale
                            categorieLavoriPrincipali.push(catData);
                        } else {
                            // Sottocategoria
                            if (!sottocategorieLavoriMap.has(catData.parentId)) {
                                sottocategorieLavoriMap.set(catData.parentId, []);
                            }
                            sottocategorieLavoriMap.get(catData.parentId).push(catData);
                        }
                    }
                });
                
                // Ordina sottocategorie per ordine
                sottocategorieLavoriMap.forEach((sottocat, parentId) => {
                    sottocat.sort((a, b) => (a.ordine || 0) - (b.ordine || 0));
                });
                
                populateCategoriaLavoroDropdown();
            } catch (error) {
                console.error('Errore caricamento categorie lavori:', error);
                categorieLavoriPrincipali = [];
            }
        }
        
        // Popola sottocategorie quando cambia categoria principale
        function populateSottocategorieLavoro(parentId, selectedValue = null) {
            const sottocategoriaSelect = document.getElementById('attivita-sottocategoria');
            const sottocategoriaGroup = document.getElementById('attivita-sottocategoria-group');
            
            if (!sottocategoriaSelect || !sottocategoriaGroup) return;
            
            sottocategoriaSelect.innerHTML = '<option value="">-- Nessuna sottocategoria --</option>';
            
            if (!parentId) {
                sottocategoriaGroup.style.display = 'none';
                return;
            }
            
            const sottocat = sottocategorieLavoriMap.get(parentId);
            if (sottocat && sottocat.length > 0) {
                sottocategoriaGroup.style.display = 'block';
                sottocat.forEach(subcat => {
                    const option = document.createElement('option');
                    option.value = subcat.id;
                    option.textContent = subcat.nome;
                    if (selectedValue === subcat.id) {
                        option.selected = true;
                    }
                    sottocategoriaSelect.appendChild(option);
                });
            } else {
                sottocategoriaGroup.style.display = 'none';
            }
        }

        // Carica tipi lavoro (filtrati per categoria se specificata)
        async function loadTipiLavoro(categoriaId = null) {
            try {
                if (!currentTenantId) return;
                
                const tipiRef = collection(db, `tenants/${currentTenantId}/tipiLavoro`);
                
                // Carica sempre tutti i tipi lavoro (per avere la lista completa)
                const snapshot = await getDocs(query(tipiRef, orderBy('nome', 'asc')));
                tipiLavoroList = [];
                
                snapshot.forEach(doc => {
                    tipiLavoroList.push({ id: doc.id, ...doc.data() });
                });
                
                // Se √® specificata una categoria, filtra per quella categoria o le sue sottocategorie
                if (categoriaId) {
                    // Verifica se categoriaId √® una sottocategoria o categoria principale
                    let allCategorieIds = [categoriaId];
                    
                    // Verifica se √® una sottocategoria (ha parentId)
                    const categoriaTrovata = [...categorieLavoriPrincipali, ...Array.from(sottocategorieLavoriMap.values()).flat()].find(c => c.id === categoriaId);
                    
                    if (categoriaTrovata && !categoriaTrovata.parentId) {
                        // √à una categoria principale, aggiungi le sue sottocategorie
                        const sottocat = sottocategorieLavoriMap.get(categoriaId);
                        if (sottocat) {
                            sottocat.forEach(subcat => allCategorieIds.push(subcat.id));
                        }
                    }
                    
                    // Filtra i tipi per le categorie rilevanti
                    tipiLavoroList = tipiLavoroList.filter(tipo => allCategorieIds.includes(tipo.categoriaId));
                }
                
                populateTipoLavoroDropdown(categoriaId);
            } catch (error) {
                console.error('Errore caricamento tipi lavoro:', error);
                tipiLavoroList = [];
            }
        }

        // Popola dropdown categoria principale lavoro
        function populateCategoriaLavoroDropdown(selectedValue = null) {
            const select = document.getElementById('attivita-categoria-principale');
            if (!select) return;
            
            select.innerHTML = '<option value="">-- Seleziona categoria principale --</option>';
            
            categorieLavoriPrincipali.forEach(categoria => {
                const option = document.createElement('option');
                option.value = categoria.id;
                option.textContent = categoria.nome;
                if (selectedValue === categoria.id) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }

        // Popola dropdown tipo lavoro nel form (filtrato per categoria)
        function populateTipoLavoroDropdown(categoriaId = null, selectedValue = null) {
            const select = document.getElementById('attivita-tipo-lavoro-gerarchico');
            const tipoLavoroGroup = document.getElementById('attivita-tipo-lavoro-gerarchico-group');
            
            if (!select || !tipoLavoroGroup) return;
            
            select.innerHTML = '<option value="">-- Seleziona tipo lavoro --</option>';
            
            if (!categoriaId) {
                tipoLavoroGroup.style.display = 'none';
                return;
            }
            
            tipoLavoroGroup.style.display = 'block';
            
            // Filtra tipi lavoro per categoria (include anche sottocategorie se categoriaId √® principale)
            let tipiFiltrati = tipiLavoroList.filter(tipo => tipo.categoriaId === categoriaId);
            
            // Se non ci sono tipi per questa categoria specifica, verifica se √® una categoria principale
            // e cerca anche nelle sue sottocategorie
            if (tipiFiltrati.length === 0) {
                const sottocat = sottocategorieLavoriMap.get(categoriaId);
                if (sottocat && sottocat.length > 0) {
                    // Cerca tipi lavoro associati alle sottocategorie
                    const sottocatIds = sottocat.map(sc => sc.id);
                    tipiFiltrati = tipiLavoroList.filter(tipo => sottocatIds.includes(tipo.categoriaId));
                }
            }
            
            if (tipiFiltrati.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = '-- Nessun tipo disponibile --';
                option.disabled = true;
                select.appendChild(option);
                return;
            }
            
            tipiFiltrati.forEach(tipo => {
                const option = document.createElement('option');
                option.value = tipo.nome; // Usa nome per retrocompatibilit√† con attivit√† esistenti
                option.textContent = tipo.nome;
                if (selectedValue === tipo.nome) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }
        
        // Setup handler per cambio categoria lavoro
        function setupCategoriaLavoroHandler() {
            const categoriaPrincipaleSelect = document.getElementById('attivita-categoria-principale');
            const sottocategoriaSelect = document.getElementById('attivita-sottocategoria');
            
            if (categoriaPrincipaleSelect) {
                categoriaPrincipaleSelect.addEventListener('change', function() {
                    const categoriaPrincipaleId = this.value;
                    if (categoriaPrincipaleId) {
                        populateSottocategorieLavoro(categoriaPrincipaleId);
                        // Carica tipi lavoro per la categoria principale (include sottocategorie)
                        loadTipiLavoro(categoriaPrincipaleId);
                    } else {
                        const sottocategoriaGroup = document.getElementById('attivita-sottocategoria-group');
                        const tipoLavoroGroup = document.getElementById('attivita-tipo-lavoro-gerarchico-group');
                        if (sottocategoriaGroup) sottocategoriaGroup.style.display = 'none';
                        if (tipoLavoroGroup) tipoLavoroGroup.style.display = 'none';
                        const tipoLavoroSelect = document.getElementById('attivita-tipo-lavoro-gerarchico');
                        if (tipoLavoroSelect) tipoLavoroSelect.value = '';
                    }
                });
            }
            
            if (sottocategoriaSelect) {
                sottocategoriaSelect.addEventListener('change', function() {
                    const sottocategoriaId = this.value;
                    const categoriaPrincipaleId = document.getElementById('attivita-categoria-principale').value;
                    
                    // Usa sottocategoria se selezionata, altrimenti categoria principale
                    const categoriaId = sottocategoriaId || categoriaPrincipaleId;
                    if (categoriaId) {
                        loadTipiLavoro(categoriaId);
                    }
                });
            }
        }
        
        // Funzioni per gestire modali categoria e tipo lavoro
        window.openCategoriaLavoroModal = function() {
            document.getElementById('categoria-lavoro-form').reset();
            document.getElementById('categoria-lavoro-modal').classList.add('active');
        }

        window.closeCategoriaLavoroModal = function() {
            document.getElementById('categoria-lavoro-modal').classList.remove('active');
            document.getElementById('categoria-lavoro-form').reset();
        }

        window.handleSalvaCategoriaLavoro = async function(e) {
            e.preventDefault();

            const nome = document.getElementById('categoria-lavoro-nome').value.trim();
            const descrizione = document.getElementById('categoria-lavoro-descrizione').value.trim() || null;

            if (!nome || nome.length < 3) {
                showAlert('Il nome categoria deve essere di almeno 3 caratteri', 'error');
                return;
            }

            try {
                // Genera codice dal nome
                const codice = nome
                    .toLowerCase()
                    .normalize('NFD')
                    .replace(/[\u0300-\u036f]/g, '')
                    .replace(/[^a-z0-9]+/g, '_')
                    .replace(/^_+|_+$/g, '');
                
                // Verifica che il codice non esista gi√†
                const categorieRef = collection(db, `tenants/${currentTenantId}/categorie`);
                const snapshot = await getDocs(query(categorieRef, where('codice', '==', codice)));
                
                if (!snapshot.empty) {
                    showAlert('Una categoria con questo nome esiste gi√†', 'error');
                    return;
                }
                
                const categoriaData = {
                    nome,
                    codice,
                    descrizione,
                    parentId: null, // Categoria principale
                    applicabileA: 'lavori', // Di default per lavori
                    predefinita: false,
                    ordine: null,
                    creatoDa: currentUserData.id,
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                };
                
                const categoriaDoc = await addDoc(categorieRef, categoriaData);
                
                showAlert('Categoria creata con successo', 'success');
                closeCategoriaLavoroModal();
                
                await loadCategorieLavori();
                
                // Seleziona la nuova categoria nel form attivit√†
                const categoriaSelect = document.getElementById('attivita-categoria-principale');
                if (categoriaSelect) {
                    categoriaSelect.value = categoriaDoc.id;
                    categoriaSelect.dispatchEvent(new Event('change'));
                }
            } catch (error) {
                console.error('Errore salvataggio categoria:', error);
                showAlert('Errore salvataggio categoria: ' + error.message, 'error');
            }
        }

        window.openTipoLavoroModal = function() {
            const categoriaPrincipaleId = document.getElementById('attivita-categoria-principale').value;
            const sottocategoriaId = document.getElementById('attivita-sottocategoria').value;
            
            if (!categoriaPrincipaleId) {
                showAlert('Seleziona prima una categoria principale lavoro', 'error');
                return;
            }

            // Usa sottocategoria se selezionata, altrimenti categoria principale
            const categoriaId = sottocategoriaId || categoriaPrincipaleId;

            document.getElementById('tipo-lavoro-form').reset();
            document.getElementById('tipo-lavoro-categoria').value = categoriaId;
            
            // Popola dropdown categoria nel modal (include principali e sottocategorie)
            const categoriaSelectModal = document.getElementById('tipo-lavoro-categoria');
            categoriaSelectModal.innerHTML = '<option value="">-- Seleziona categoria --</option>';
            
            // Aggiungi categorie principali
            categorieLavoriPrincipali.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = cat.nome;
                if (cat.id === categoriaId) {
                    option.selected = true;
                }
                categoriaSelectModal.appendChild(option);
                
                // Aggiungi sottocategorie
                const sottocat = sottocategorieLavoriMap.get(cat.id);
                if (sottocat) {
                    sottocat.forEach(subcat => {
                        const subOption = document.createElement('option');
                        subOption.value = subcat.id;
                        subOption.textContent = `  ‚îî ${subcat.nome}`;
                        if (subcat.id === categoriaId) {
                            subOption.selected = true;
                        }
                        categoriaSelectModal.appendChild(subOption);
                    });
                }
            });
            
            document.getElementById('tipo-lavoro-modal').classList.add('active');
        }

        window.closeTipoLavoroModal = function() {
            document.getElementById('tipo-lavoro-modal').classList.remove('active');
            document.getElementById('tipo-lavoro-form').reset();
        }

        window.handleSalvaTipoLavoro = async function(e) {
            e.preventDefault();

            const nome = document.getElementById('tipo-lavoro-nome').value.trim();
            const categoriaId = document.getElementById('tipo-lavoro-categoria').value;
            const descrizione = document.getElementById('tipo-lavoro-descrizione').value.trim() || null;

            if (!nome || nome.length < 2) {
                showAlert('Il nome tipo lavoro deve essere di almeno 2 caratteri', 'error');
                return;
            }

            if (!categoriaId) {
                showAlert('Seleziona una categoria', 'error');
                return;
            }

            try {
                // Verifica che la categoria esista (nella collezione unificata)
                const categoriaDoc = await getDoc(doc(db, `tenants/${currentTenantId}/categorie`, categoriaId));
                if (!categoriaDoc.exists()) {
                    showAlert('Categoria lavoro non trovata', 'error');
                    return;
                }
                
                // Verifica che non esista gi√† un tipo con lo stesso nome nella stessa categoria
                const tipiRef = collection(db, `tenants/${currentTenantId}/tipiLavoro`);
                const tipiSnapshot = await getDocs(query(tipiRef, where('categoriaId', '==', categoriaId)));
                
                const tipoEsistente = tipiSnapshot.docs.find(doc => {
                    const data = doc.data();
                    return data.nome && data.nome.toLowerCase() === nome.toLowerCase();
                });
                
                if (tipoEsistente) {
                    showAlert(`Un tipo lavoro con nome "${nome}" esiste gi√† in questa categoria`, 'error');
                    return;
                }
                
                const tipoLavoroData = {
                    nome,
                    categoriaId,
                    descrizione,
                    predefinito: false,
                    creatoDa: currentUserData.id,
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                };
                
                const tipoDoc = await addDoc(tipiRef, tipoLavoroData);
                
                showAlert('Tipo lavoro creato con successo', 'success');
                closeTipoLavoroModal();
                
                // Ricarica tipi lavoro per la categoria selezionata
                await loadTipiLavoro(categoriaId);
                
                // Seleziona il nuovo tipo nel form attivit√†
                const tipoSelect = document.getElementById('attivita-tipo-lavoro-gerarchico');
                if (tipoSelect) {
                    tipoSelect.value = nome;
                }
            } catch (error) {
                console.error('Errore salvataggio tipo lavoro:', error);
                showAlert('Errore salvataggio tipo lavoro: ' + error.message, 'error');
            }
        }

        // Carica attivit√†
        async function loadAttivita() {
            try {
                if (!currentTenantId) {
                    const user = auth.currentUser;
                    if (user) {
                        currentTenantId = await getTenantId(user.uid);
                    }
                }
                
                if (!currentTenantId) {
                    throw new Error('Tenant ID non disponibile');
                }

                const attivitaCollection = getAttivitaCollection(currentTenantId);
                // Usa solo orderBy su data per evitare bisogno di indice composito
                const q = query(attivitaCollection, orderBy('data', 'desc'));
                const querySnapshot = await getDocs(q);
                
                attivita = [];
                querySnapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    attivita.push({
                        id: docSnap.id,
                        data: data.data || '',
                        terrenoId: data.terrenoId || '',
                        terrenoNome: data.terrenoNome || '',
                        tipoLavoro: data.tipoLavoro || '',
                        coltura: data.coltura || '',
                        orarioInizio: data.orarioInizio || '',
                        orarioFine: data.orarioFine || '',
                        pauseMinuti: data.pauseMinuti || 0,
                        oreNette: data.oreNette || 0,
                        note: data.note || '',
                        // Campi conto terzi (opzionali)
                        clienteId: data.clienteId || null,
                        clienteNome: data.clienteNome || null,
                        lavoroId: data.lavoroId || null,
                        // Campi macchina (opzionali)
                        macchinaId: data.macchinaId || null,
                        attrezzoId: data.attrezzoId || null,
                        oreMacchina: data.oreMacchina !== null && data.oreMacchina !== undefined ? data.oreMacchina : null
                    });
                });
                
                // Ordina per data (discendente) e poi per orario inizio (discendente)
                attivita.sort((a, b) => {
                    if (a.data !== b.data) {
                        return b.data.localeCompare(a.data); // Data discendente
                    }
                    // Se stessa data, ordina per orario inizio discendente
                    return (b.orarioInizio || '').localeCompare(a.orarioInizio || '');
                });
                
                filteredAttivita = [...attivita];
                
                // Libera automaticamente macchine di attivit√† del giorno precedente senza "ora fine"
                if (hasParcoMacchineModule) {
                    await liberaMacchineAttivitaPrecedenti();
                }
                
                renderAttivita();
            } catch (error) {
                console.error('Errore caricamento attivit√†:', error);
                showAlert('Errore nel caricamento delle attivit√†: ' + error.message, 'error');
                document.getElementById('attivita-container').innerHTML = `
                    <div class="alert alert-error">
                        <strong>Errore:</strong> ${error.message}
                    </div>
                `;
            }
        }

        // Libera macchine di attivit√† del giorno precedente senza "ora fine" (fallback automatico)
        async function liberaMacchineAttivitaPrecedenti() {
            try {
                const oggi = new Date();
                oggi.setHours(0, 0, 0, 0);
                const oggiString = oggi.toISOString().split('T')[0];
                
                // Trova attivit√† del giorno precedente (o precedenti) senza "ora fine" ma con macchine
                const attivitaPrecedenti = attivita.filter(a => {
                    const dataAttivita = a.data || '';
                    return dataAttivita < oggiString && 
                           !a.orarioFine && 
                           (a.macchinaId || a.attrezzoId);
                });
                
                if (attivitaPrecedenti.length === 0) {
                    return;
                }
                
                console.log(`üîÑ Trovate ${attivitaPrecedenti.length} attivit√† precedenti senza ora fine, libero macchine`);
                
                for (const attivitaPrec of attivitaPrecedenti) {
                    if (attivitaPrec.macchinaId) {
                        await updateMacchinaStato(attivitaPrec.macchinaId, 'disponibile');
                    }
                    if (attivitaPrec.attrezzoId) {
                        await updateMacchinaStato(attivitaPrec.attrezzoId, 'disponibile');
                    }
                }
                
                // Ricarica macchine per aggiornare dropdown
                await loadMacchine();
            } catch (error) {
                console.error('Errore liberazione macchine attivit√† precedenti:', error);
                // Non bloccare il caricamento se c'√® un errore
            }
        }

        // Render attivit√†
        async function renderAttivita() {
            console.log('üé® renderAttivita chiamata');
            const container = document.getElementById('attivita-container');
            
            // Determina se √® modalit√† completati
            const urlParams = new URLSearchParams(window.location.search);
            const statoFiltro = urlParams.get('stato');
            const isModalitaCompletati = isContoTerziMode && statoFiltro === 'completato';
            
            console.log('üìä Stato renderAttivita:', {
                isContoTerziMode,
                statoFiltro,
                isModalitaCompletati,
                lavoriListLength: lavoriList.length
            });
            
            let html = '';
            
            // Se modalit√† Conto Terzi, mostra prima i lavori (in corso o completati) con form rapido o solo consultazione
            if (isContoTerziMode && lavoriList.length > 0) {
                const urlParams = new URLSearchParams(window.location.search);
                const statoFiltro = urlParams.get('stato');
                
                // Se filtro √® "completato", mostra lavori completati (solo consultazione)
                if (statoFiltro === 'completato') {
                    // Applica filtri anche ai lavori
                    const clienteId = document.getElementById('filter-cliente') ? document.getElementById('filter-cliente').value : '';
                    const terrenoId = document.getElementById('filter-terreno') ? document.getElementById('filter-terreno').value : '';
                    
                    let lavoriCompletati = lavoriList.filter(l => l.stato === 'completato');
                    
                    // Filtra per cliente se specificato
                    if (clienteId) {
                        lavoriCompletati = lavoriCompletati.filter(l => l.clienteId === clienteId);
                    }
                    
                    // Filtra per terreno se specificato
                    if (terrenoId) {
                        lavoriCompletati = lavoriCompletati.filter(l => l.terrenoId === terrenoId);
                    }
                    
                    if (lavoriCompletati.length > 0) {
                        html += `
                            <div style="background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%); padding: 20px; border-radius: 12px; margin-bottom: 30px; border: 2px solid #1976D2;">
                                <h2 style="color: #1976D2; margin-bottom: 20px; font-size: 20px;">‚úÖ Lavori Completati</h2>
                                <div style="display: grid; gap: 15px;" id="lavori-completati-container">
                                    <div style="text-align: center; padding: 20px; color: #666;">Caricamento dettagli...</div>
                                </div>
                            </div>
                        `;
                    } else {
                        html += `
                            <div style="background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%); padding: 20px; border-radius: 12px; margin-bottom: 30px; border: 2px solid #1976D2;">
                                <div class="empty-state">
                                    <div class="empty-state-icon">‚úÖ</div>
                                    <h3 style="color: #1976D2;">Nessun lavoro completato</h3>
                                    <p>Non ci sono ancora lavori conto terzi completati.</p>
                                </div>
                            </div>
                        `;
                    }
                } else {
                    // Mostra lavori in corso con form rapido
                    const lavoriInCorso = lavoriList.filter(l => l.stato === 'in_corso');
                    
                    if (lavoriInCorso.length > 0) {
                    html += `
                        <div style="background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%); padding: 20px; border-radius: 12px; margin-bottom: 30px; border: 2px solid #1976D2;">
                            <h2 style="color: #1976D2; margin-bottom: 20px; font-size: 20px;">üíº Lavori in Corso - Aggiungi Attivit√†</h2>
                            <div style="display: grid; gap: 15px;">
                    `;
                    
                    lavoriInCorso.forEach(lavoro => {
                        const cliente = clientiList.find(c => c.id === lavoro.clienteId);
                        const terreno = terreni.find(t => t.id === lavoro.terrenoId);
                        const clienteNome = cliente ? (cliente.ragioneSociale || cliente.nome || 'Cliente sconosciuto') : 'Cliente sconosciuto';
                        const terrenoNome = terreno ? terreno.nome : 'Terreno sconosciuto';
                        
                        html += `
                            <div class="lavoro-rapido-card" style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #BBDEFB;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                                    <div>
                                        <h3 style="color: #1976D2; margin: 0 0 5px 0; font-size: 16px;">${escapeHtml(lavoro.nome || 'Lavoro senza nome')}</h3>
                                        <div style="font-size: 13px; color: #666;">
                                            <strong>Cliente:</strong> ${escapeHtml(clienteNome)} | 
                                            <strong>Terreno:</strong> ${escapeHtml(terrenoNome)} | 
                                            <strong>Tipo:</strong> ${escapeHtml(lavoro.tipoLavoro || '-')}
                                        </div>
                                    </div>
                                    <button onclick="toggleFormRapido('${lavoro.id}')" class="btn btn-primary btn-sm" id="btn-toggle-${lavoro.id}">
                                        ‚ûï Aggiungi Attivit√†
                                    </button>
                                </div>
                                
                                <form id="form-rapido-${lavoro.id}" class="form-rapido-lavoro" style="display: none; padding-top: 15px; border-top: 1px solid #E0E0E0;">
                                    <input type="hidden" id="rapido-cliente-${lavoro.id}" value="${lavoro.clienteId}">
                                    <input type="hidden" id="rapido-lavoro-${lavoro.id}" value="${lavoro.id}">
                                    <input type="hidden" id="rapido-terreno-${lavoro.id}" value="${lavoro.terrenoId}">
                                    <input type="hidden" id="rapido-tipo-lavoro-${lavoro.id}" value="${escapeHtml(lavoro.tipoLavoro || '')}">
                                    
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                        <div>
                                            <label style="display: block; margin-bottom: 5px; font-size: 13px; color: #666;">Data *</label>
                                            <input type="date" id="rapido-data-${lavoro.id}" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        </div>
                                        <div>
                                            <label style="display: block; margin-bottom: 5px; font-size: 13px; color: #666;">Ore Lavorate *</label>
                                            <input type="number" id="rapido-ore-${lavoro.id}" step="0.1" min="0" required placeholder="Es: 8.5" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        </div>
                                        ${hasParcoMacchineModule ? `
                                        <div>
                                            <label style="display: block; margin-bottom: 5px; font-size: 13px; color: #666;">Trattore</label>
                                            <select id="rapido-trattore-${lavoro.id}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                                <option value="">-- Nessun trattore --</option>
                                            </select>
                                        </div>
                                        <div id="rapido-attrezzo-group-${lavoro.id}" style="display: none;">
                                            <label style="display: block; margin-bottom: 5px; font-size: 13px; color: #666;">Attrezzo</label>
                                            <select id="rapido-attrezzo-${lavoro.id}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                                <option value="">-- Nessun attrezzo --</option>
                                            </select>
                                        </div>
                                        ` : ''}
                                    </div>
                                    
                                    <div style="margin-top: 15px;">
                                        <label style="display: block; margin-bottom: 5px; font-size: 13px; color: #666;">Note</label>
                                        <textarea id="rapido-note-${lavoro.id}" placeholder="Note aggiuntive..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; min-height: 60px; resize: vertical;"></textarea>
                                    </div>
                                    
                                    <div style="margin-top: 15px; padding: 12px; background: #f8f9fa; border-radius: 6px; border: 1px solid #E0E0E0;">
                                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 14px; color: #333;">
                                            <input type="checkbox" id="rapido-lavoro-terminato-${lavoro.id}" style="width: 18px; height: 18px; cursor: pointer;">
                                            <strong style="color: #1976D2;">‚úÖ Segna lavoro come completato</strong>
                                        </label>
                                        <small style="display: block; margin-top: 5px; margin-left: 26px; color: #666; font-size: 12px;">
                                            Se selezionato, il lavoro passer√† automaticamente da "In corso" a "Completato"
                                        </small>
                                    </div>
                                    
                                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                                        <button type="button" onclick="salvaAttivitaRapida('${lavoro.id}')" class="btn btn-success" style="flex: 1;">üíæ Salva Attivit√†</button>
                                        <button type="button" onclick="toggleFormRapido('${lavoro.id}')" class="btn btn-secondary">Annulla</button>
                                    </div>
                                </form>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                    } else {
                        // Nessun lavoro in corso
                        html += `
                            <div style="background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%); padding: 20px; border-radius: 12px; margin-bottom: 30px; border: 2px solid #1976D2;">
                                <div class="empty-state">
                                    <div class="empty-state-icon">‚úÖ</div>
                                    <h3 style="color: #1976D2;">Nessun lavoro in corso</h3>
                                    <p>Tutti i lavori conto terzi sono stati completati o non ci sono lavori da pianificare.</p>
                                </div>
                            </div>
                        `;
                    }
                }
            }
            
            // Sezione attivit√† esistenti
            if (filteredAttivita.length === 0 && !isContoTerziMode) {
                html += `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìù</div>
                        <h3>Nessuna attivit√† trovata</h3>
                        <p>Aggiungi la prima attivit√† utilizzando il pulsante "Aggiungi Attivit√†".</p>
                    </div>
                `;
                container.innerHTML = html;
                return;
            }
            
            // Se modalit√† conto terzi e non √® modalit√† completati
            if (isContoTerziMode && !isModalitaCompletati) {
                const lavoriInCorso = lavoriList.filter(l => l.stato === 'in_corso');
                if (lavoriInCorso.length === 0) {
                    // Non ci sono lavori in corso, mostra solo messaggio
                    html += `
                        <div style="margin-top: 20px;">
                            <div class="empty-state">
                                <div class="empty-state-icon">‚úÖ</div>
                                <h3>Nessun lavoro in corso</h3>
                                <p>Tutti i lavori conto terzi sono stati completati o non ci sono lavori da pianificare.</p>
                            </div>
                        </div>
                    `;
                    container.innerHTML = html;
                    return;
                }
                
                // Se ci sono lavori in corso ma nessuna attivit√†, mostra messaggio
                if (filteredAttivita.length === 0) {
                    html += `
                        <div style="margin-top: 20px;">
                            <h3 style="color: #1976D2; margin-bottom: 15px;">üìã Attivit√† Registrate</h3>
                            <div class="empty-state">
                                <div class="empty-state-icon">üìù</div>
                                <h3>Nessuna attivit√† registrata</h3>
                                <p>Usa i form rapidi sopra per aggiungere attivit√† ai lavori in corso.</p>
                            </div>
                        </div>
                    `;
                    container.innerHTML = html;
                    return;
                }
            }
            
            // Se modalit√† completati, non mostrare la sezione attivit√† esistenti (gi√† mostrate nei lavori)
            if (isModalitaCompletati) {
                container.innerHTML = html;
                console.log('‚úÖ HTML aggiunto al container (modalit√† completati)');
                
                // Carica dettagli lavori completati dopo che l'HTML √® stato aggiunto
                const clienteId = document.getElementById('filter-cliente') ? document.getElementById('filter-cliente').value : '';
                const terrenoId = document.getElementById('filter-terreno') ? document.getElementById('filter-terreno').value : '';
                
                let lavoriCompletati = lavoriList.filter(l => l.stato === 'completato');
                
                if (clienteId) {
                    lavoriCompletati = lavoriCompletati.filter(l => l.clienteId === clienteId);
                }
                
                if (terrenoId) {
                    lavoriCompletati = lavoriCompletati.filter(l => l.terrenoId === terrenoId);
                }
                
                if (lavoriCompletati.length > 0) {
                    console.log('üìã Trovati', lavoriCompletati.length, 'lavori completati, avvio caricamento dettagli...');
                    // Chiama la funzione dopo che il DOM √® stato aggiornato
                    setTimeout(() => {
                        const containerCheck = document.getElementById('lavori-completati-container');
                        if (!containerCheck) {
                            console.error('‚ùå Container non trovato dopo timeout');
                            return;
                        }
                        console.log('‚úÖ Container trovato, chiamo caricaDettagliLavoriCompletati');
                        caricaDettagliLavoriCompletati(lavoriCompletati).catch(error => {
                            console.error('‚ùå Errore caricamento dettagli lavori completati:', error);
                            console.error('Stack:', error.stack);
                            const dettagliContainer = document.getElementById('lavori-completati-container');
                            if (dettagliContainer) {
                                dettagliContainer.innerHTML = `<div style="color: #d32f2f; padding: 20px; text-align: center;">
                                    <strong>Errore caricamento dettagli:</strong><br>
                                    ${error.message}<br>
                                    <small style="color: #999; margin-top: 10px; display: block;">Controlla la console per maggiori dettagli</small>
                                </div>`;
                            }
                        });
                    }, 100);
                }
                
                return;
            }
            
            // Mostra attivit√† esistenti
            html += `
                <div style="margin-top: 20px;">
                    <h3 style="color: ${isContoTerziMode ? '#1976D2' : '#2E8B57'}; margin-bottom: 15px;">üìã Attivit√† Registrate</h3>
            `;

            // Crea mappa macchine per visualizzazione
            let macchineMap = {};
            if (hasParcoMacchineModule) {
                try {
                    macchineList.forEach(m => {
                        macchineMap[m.id] = m.nome || 'Macchina senza nome';
                    });
                } catch (error) {
                    console.warn('Errore creazione mappa macchine:', error);
                }
            }

            html += `
                <div class="attivita-table">
                    <div class="attivita-header">
                        <div class="col-data">Data</div>
                        ${isContoTerziMode ? '<div class="col-cliente">Cliente</div>' : ''}
                        <div class="col-terreno">Terreno</div>
                        <div class="col-tipo-lavoro">Tipo Lavoro</div>
                        ${!isContoTerziMode ? '<div class="col-coltura">Coltura</div>' : ''}
                        ${!isContoTerziMode ? '<div class="col-orari">Inizio</div>' : ''}
                        ${!isContoTerziMode ? '<div class="col-orari">Fine</div>' : ''}
                        ${!isContoTerziMode ? '<div class="col-orari">Pause</div>' : ''}
                        <div class="col-ore">Ore Nette</div>
                        ${hasParcoMacchineModule ? '<div class="col-macchina">Macchina</div>' : ''}
                        <div class="col-azioni">Azioni</div>
                    </div>
                    ${filteredAttivita.map(att => {
                        const dataFormatted = att.data ? new Date(att.data + 'T00:00:00').toLocaleDateString('it-IT') : '';
                        const pauseFormatted = `${att.pauseMinuti} min`;
                        const oreFormatted = formatOreNette(att.oreNette || 0);
                        
                        // Badge Conto Terzi se presente (sempre se ha clienteId)
                        const isContoTerzi = att.clienteId != null && att.clienteId !== '';
                        const contoTerziBadge = isContoTerzi ? '<span class="badge" style="background: #1976D2; color: white; margin-left: 5px; font-size: 10px; padding: 2px 6px; border-radius: 3px;">üíº Conto Terzi</span>' : '';
                        const contoTerziStyle = isContoTerzi ? 'style="background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%); border-left: 4px solid #1976D2;"' : '';
                        
                        return `
                        <div class="attivita-row" ${contoTerziStyle}>
                            <div class="col-data" data-label="Data">
                                ${escapeHtml(dataFormatted)}
                            </div>
                            ${isContoTerziMode ? `
                            <div class="col-cliente" data-label="Cliente">
                                ${escapeHtml(att.clienteNome || '-')}${contoTerziBadge}
                            </div>
                            ` : ''}
                            <div class="col-terreno" data-label="Terreno">
                                ${escapeHtml(att.terrenoNome || '-')}
                            </div>
                            <div class="col-tipo-lavoro" data-label="Tipo Lavoro">
                                ${escapeHtml(att.tipoLavoro || '-')}
                            </div>
                            ${!isContoTerziMode ? `
                            <div class="col-coltura" data-label="Coltura">
                                ${escapeHtml(att.coltura || '-')}
                            </div>
                            <div class="col-orari" data-label="Inizio">
                                ${escapeHtml(att.orarioInizio || '-')}
                            </div>
                            <div class="col-orari" data-label="Fine">
                                ${escapeHtml(att.orarioFine || '-')}
                            </div>
                            <div class="col-orari" data-label="Pause">
                                ${pauseFormatted}
                            </div>
                            ` : ''}
                            <div class="col-ore" data-label="Ore Nette">
                                ${oreFormatted}
                            </div>
                            ${hasParcoMacchineModule ? `
                            <div class="col-macchina" data-label="Macchina" style="font-size: 12px; color: #666;">
                                ${(() => {
                                    const macchinaNome = att.macchinaId ? macchineMap[att.macchinaId] : null;
                                    const attrezzoNome = att.attrezzoId ? macchineMap[att.attrezzoId] : null;
                                    const oreMacchina = att.oreMacchina !== null && att.oreMacchina !== undefined ? att.oreMacchina : null;
                                    
                                    if (!macchinaNome && !attrezzoNome) {
                                        return '-';
                                    }
                                    
                                    const parts = [];
                                    if (macchinaNome) parts.push(`üöú ${escapeHtml(macchinaNome)}`);
                                    if (attrezzoNome) parts.push(`‚öôÔ∏è ${escapeHtml(attrezzoNome)}`);
                                    
                                    let result = parts.join('<br>');
                                    if (oreMacchina !== null && oreMacchina !== att.oreNette) {
                                        result += `<br><small style="color: #999;">Ore macchina: ${formatOreNette(oreMacchina)}</small>`;
                                    }
                                    
                                    return result;
                                })()}
                            </div>
                            ` : ''}
                            <div class="col-azioni" data-label="Azioni">
                                <button onclick="editAttivita('${att.id}')" class="btn-edit-small" title="Modifica">‚úèÔ∏è</button>
                                <button onclick="confirmDeleteAttivita('${att.id}')" class="btn-delete-small" title="Elimina">üóëÔ∏è</button>
                            </div>
                        </div>
                        `;
                    }).join('')}
                </div>
            `;
            
            html += `</div>`;
            container.innerHTML = html;
            console.log('‚úÖ HTML aggiunto al container');
            
            // Se ci sono lavori completati, carica i dettagli dopo che l'HTML √® stato aggiunto al DOM
            const urlParamsCheck = new URLSearchParams(window.location.search);
            const statoFiltroCheck = urlParamsCheck.get('stato');
            const isModalitaCompletatiCheck = isContoTerziMode && statoFiltroCheck === 'completato';
            
            console.log('üîç Verifica condizioni per caricamento dettagli:', {
                isContoTerziMode,
                isModalitaCompletatiCheck,
                lavoriListLength: lavoriList.length,
                statoFiltroCheck
            });
            
            if (isContoTerziMode && isModalitaCompletatiCheck && lavoriList.length > 0) {
                console.log('‚úÖ Condizioni soddisfatte, procedo con caricamento dettagli');
                const clienteId = document.getElementById('filter-cliente') ? document.getElementById('filter-cliente').value : '';
                const terrenoId = document.getElementById('filter-terreno') ? document.getElementById('filter-terreno').value : '';
                
                let lavoriCompletati = lavoriList.filter(l => l.stato === 'completato');
                
                if (clienteId) {
                    lavoriCompletati = lavoriCompletati.filter(l => l.clienteId === clienteId);
                }
                
                if (terrenoId) {
                    lavoriCompletati = lavoriCompletati.filter(l => l.terrenoId === terrenoId);
                }
                
                if (lavoriCompletati.length > 0) {
                    console.log('üìã Trovati', lavoriCompletati.length, 'lavori completati, avvio caricamento dettagli...');
                    // Chiama la funzione dopo che il DOM √® stato aggiornato
                    setTimeout(() => {
                        const containerCheck = document.getElementById('lavori-completati-container');
                        if (!containerCheck) {
                            console.error('‚ùå Container non trovato dopo timeout');
                            return;
                        }
                        console.log('‚úÖ Container trovato, chiamo caricaDettagliLavoriCompletati');
                        caricaDettagliLavoriCompletati(lavoriCompletati).catch(error => {
                            console.error('‚ùå Errore caricamento dettagli lavori completati:', error);
                            console.error('Stack:', error.stack);
                            const dettagliContainer = document.getElementById('lavori-completati-container');
                            if (dettagliContainer) {
                                dettagliContainer.innerHTML = `<div style="color: #d32f2f; padding: 20px; text-align: center;">
                                    <strong>Errore caricamento dettagli:</strong><br>
                                    ${error.message}<br>
                                    <small style="color: #999; margin-top: 10px; display: block;">Controlla la console per maggiori dettagli</small>
                                </div>`;
                            }
                        });
                    }, 100);
                } else {
                    console.log('‚ö†Ô∏è Nessun lavoro completato trovato dopo filtri');
                }
            }
            
            // Popola dropdown macchine per form rapidi se Parco Macchine attivo
            if (isContoTerziMode && hasParcoMacchineModule && lavoriList.length > 0) {
                const lavoriInCorso = lavoriList.filter(l => l.stato === 'in_corso');
                lavoriInCorso.forEach(lavoro => {
                    populateTrattoriRapido(lavoro.id);
                });
            }
            
            // Imposta data di default a oggi per tutti i form rapidi
            const today = new Date().toISOString().split('T')[0];
            const lavoriInCorso = isContoTerziMode ? lavoriList.filter(l => l.stato === 'in_corso') : [];
            lavoriInCorso.forEach(lavoro => {
                const dataInput = document.getElementById(`rapido-data-${lavoro.id}`);
                if (dataInput) {
                    dataInput.value = today;
                    dataInput.max = today;
                }
            });
        }

        // Toggle dettagli lavoro completato
        // Carica dettagli completi per lavori completati (zone lavorate e ore validate)
        async function caricaDettagliLavoriCompletati(lavoriCompletati) {
            const container = document.getElementById('lavori-completati-container');
            if (!container) {
                console.error('Container lavori-completati-container non trovato');
                return;
            }
            
            console.log('Caricamento dettagli per', lavoriCompletati.length, 'lavori completati');
            
            try {
                // Le funzioni collection e getDocs sono gi√† importate all'inizio del file
                let html = '';
                
                if (!currentTenantId) {
                    throw new Error('Tenant ID non disponibile');
                }
                
                if (!db) {
                    throw new Error('Database Firestore non inizializzato');
                }
                
                for (const lavoro of lavoriCompletati) {
                    const cliente = clientiList.find(c => c.id === lavoro.clienteId);
                    const terreno = terreni.find(t => t.id === lavoro.terrenoId);
                    const clienteNome = cliente ? (cliente.ragioneSociale || cliente.nome || 'Cliente sconosciuto') : 'Cliente sconosciuto';
                    const terrenoNome = terreno ? terreno.nome : 'Terreno sconosciuto';
                    
                    // Trova attivit√† per questo lavoro
                    const attivitaLavoro = attivita.filter(a => a.lavoroId === lavoro.id);
                    const totaleOreAttivita = attivitaLavoro.reduce((sum, a) => sum + (a.oreNette || 0), 0);
                    
                    // Carica zone lavorate
                    const zoneRef = collection(db, 'tenants', currentTenantId, 'lavori', lavoro.id, 'zoneLavorate');
                    const zoneSnapshot = await getDocs(zoneRef);
                    const zoneLavorate = [];
                    let superficieTotaleLavorata = 0;
                    const zonePerData = {};
                    
                    zoneSnapshot.forEach(zonaDoc => {
                        const zonaData = zonaDoc.data();
                        let dataZona;
                        if (zonaData.data?.toDate) {
                            dataZona = zonaData.data.toDate();
                        } else if (zonaData.data) {
                            dataZona = new Date(zonaData.data);
                        } else {
                            dataZona = new Date();
                        }
                        
                        const dataKey = new Date(dataZona.getFullYear(), dataZona.getMonth(), dataZona.getDate());
                        const dataKeyString = dataKey.toISOString().split('T')[0];
                        
                        const zona = {
                            id: zonaDoc.id,
                            ...zonaData,
                            dataNormalizzata: dataKey,
                            dataKeyString: dataKeyString
                        };
                        
                        zoneLavorate.push(zona);
                        superficieTotaleLavorata += zona.superficieHa || 0;
                        
                        if (!zonePerData[dataKeyString]) {
                            zonePerData[dataKeyString] = [];
                        }
                        zonePerData[dataKeyString].push(zona);
                    });
                    
                    // Carica ore validate e raggruppa per data
                    const oreRef = collection(db, 'tenants', currentTenantId, 'lavori', lavoro.id, 'oreOperai');
                    const oreSnapshot = await getDocs(oreRef);
                    let totaleOreValidate = 0;
                    let totaleOreDaValidare = 0;
                    const orePerData = {}; // Raggruppa ore per data
                    
                    oreSnapshot.forEach(oraDoc => {
                        const oraData = oraDoc.data();
                        const oreNette = oraData.oreNette || 0;
                        
                        if (oraData.stato === 'validate') {
                            totaleOreValidate += oreNette;
                        } else if (oraData.stato === 'da_validare') {
                            totaleOreDaValidare += oreNette;
                        }
                        
                        // Raggruppa per data
                        let dataOra;
                        if (oraData.data?.toDate) {
                            dataOra = oraData.data.toDate();
                        } else if (oraData.data) {
                            dataOra = new Date(oraData.data);
                        } else {
                            return; // Salta se non ha data
                        }
                        
                        const dataKey = new Date(dataOra.getFullYear(), dataOra.getMonth(), dataOra.getDate());
                        const dataKeyString = dataKey.toISOString().split('T')[0];
                        
                        if (!orePerData[dataKeyString]) {
                            orePerData[dataKeyString] = {
                                validate: 0,
                                daValidare: 0,
                                totale: 0
                            };
                        }
                        
                        if (oraData.stato === 'validate') {
                            orePerData[dataKeyString].validate += oreNette;
                        } else if (oraData.stato === 'da_validare') {
                            orePerData[dataKeyString].daValidare += oreNette;
                        }
                        orePerData[dataKeyString].totale += oreNette;
                    });
                    
                    // Usa superficie dal documento lavoro se disponibile, altrimenti calcolata
                    const superficieLavorata = lavoro.superficieTotaleLavorata || superficieTotaleLavorata;
                    const superficieTotale = terreno?.superficie || 0;
                    const percentuale = superficieTotale > 0 ? Math.round((superficieLavorata / superficieTotale) * 100) : 0;
                    
                    // Ordina date zone lavorate (pi√π recenti prima)
                    const dateZone = Object.keys(zonePerData).sort((a, b) => new Date(b) - new Date(a));
                    
                    html += `
                        <div class="lavoro-completato-card" style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #BBDEFB; cursor: pointer;" onclick="toggleDettagliLavoro('${lavoro.id}')">
                            <div style="margin-bottom: 15px;">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div style="flex: 1;">
                                        <h3 style="color: #1976D2; margin: 0 0 5px 0; font-size: 16px;">${escapeHtml(lavoro.nome || 'Lavoro senza nome')}</h3>
                                        <div style="font-size: 13px; color: #666; margin-bottom: 10px;">
                                            <strong>Cliente:</strong> ${escapeHtml(clienteNome)} | 
                                            <strong>Terreno:</strong> ${escapeHtml(terrenoNome)} | 
                                            <strong>Tipo:</strong> ${escapeHtml(lavoro.tipoLavoro || '-')}
                                        </div>
                                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-top: 10px;">
                                            <div style="font-size: 13px; color: #1976D2;">
                                                <strong>üìä Superficie:</strong> ${superficieLavorata.toFixed(2)} / ${superficieTotale.toFixed(2)} ha
                                            </div>
                                            <div style="font-size: 13px; color: #1976D2;">
                                                <strong>‚úÖ Completamento:</strong> ${percentuale}%
                                            </div>
                                            <div style="font-size: 13px; color: #1976D2;">
                                                <strong>‚è±Ô∏è Ore Validate:</strong> ${formatOreNette(totaleOreValidate)}
                                            </div>
                                            <div style="font-size: 13px; color: #1976D2;">
                                                <strong>üìù Zone:</strong> ${zoneLavorate.length}
                                            </div>
                                        </div>
                                        ${superficieTotale > 0 ? `
                                        <div style="margin-top: 10px;">
                                            <div style="background: #E0E0E0; height: 8px; border-radius: 4px; overflow: hidden;">
                                                <div style="background: linear-gradient(90deg, #4CAF50 0%, #8BC34A 100%); height: 100%; width: ${Math.min(percentuale, 100)}%; transition: width 0.3s;"></div>
                                            </div>
                                        </div>
                                        ` : ''}
                                    </div>
                                    <div style="margin-left: 10px; color: #1976D2; font-size: 20px;" id="icon-toggle-${lavoro.id}">
                                        ‚ñº
                                    </div>
                                </div>
                            </div>
                            
                            <div id="dettagli-lavoro-${lavoro.id}" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid #E0E0E0;" onclick="event.stopPropagation();">
                                ${dateZone.length > 0 || Object.keys(orePerData).length > 0 ? `
                                <h4 style="color: #1976D2; font-size: 14px; margin-bottom: 10px;">üìÖ Dettagli Giornalieri (Zone e Ore):</h4>
                                <div style="display: grid; gap: 10px; margin-bottom: 15px;">
                                    ${dateZone.map(dataKey => {
                                        const zoneGiorno = zonePerData[dataKey] || [];
                                        const oreGiorno = orePerData[dataKey] || { validate: 0, daValidare: 0, totale: 0 };
                                        const dataObj = new Date(dataKey);
                                        const dataFormatted = dataObj.toLocaleDateString('it-IT', { 
                                            weekday: 'long', 
                                            year: 'numeric', 
                                            month: 'long', 
                                            day: 'numeric' 
                                        });
                                        const superficieGiorno = zoneGiorno.reduce((sum, z) => sum + (z.superficieHa || 0), 0);
                                        
                                        return `
                                            <div style="background: #E3F2FD; padding: 12px; border-radius: 6px; border-left: 4px solid #1976D2;">
                                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                                    <div style="flex: 1;">
                                                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 6px; flex-wrap: wrap;">
                                                            <strong style="color: #1976D2;">üìÖ ${escapeHtml(dataFormatted)}</strong>
                                                            ${zoneGiorno.length > 0 ? `
                                                                <span style="color: #666; font-size: 12px;">
                                                                    üó∫Ô∏è ${zoneGiorno.length} ${zoneGiorno.length === 1 ? 'zona' : 'zone'}, ${superficieGiorno.toFixed(2)} ha
                                                                </span>
                                                            ` : ''}
                                                            ${oreGiorno.totale > 0 ? `
                                                                <span style="color: #1976D2; font-size: 12px; font-weight: bold;">
                                                                    ‚è±Ô∏è ${formatOreNette(oreGiorno.totale)}
                                                                    ${oreGiorno.validate > 0 ? `<span style="color: #4CAF50;">(${formatOreNette(oreGiorno.validate)} validate)</span>` : ''}
                                                                    ${oreGiorno.daValidare > 0 ? `<span style="color: #FF9800;">(${formatOreNette(oreGiorno.daValidare)} da validare)</span>` : ''}
                                                                </span>
                                                            ` : ''}
                                                        </div>
                                                        ${zoneGiorno.length === 0 && oreGiorno.totale === 0 ? `
                                                            <span style="color: #999; font-size: 12px; font-style: italic;">Nessun dato disponibile per questo giorno</span>
                                                        ` : ''}
                                                    </div>
                                                    ${zoneGiorno.length > 0 ? `
                                                        <button onclick="mostraMappaZonaLavorata('${lavoro.id}', '${dataKey}', '${escapeHtml(dataFormatted)}')" 
                                                                style="background: #1976D2; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 4px; white-space: nowrap;"
                                                                onmouseover="this.style.background='#1565C0'" 
                                                                onmouseout="this.style.background='#1976D2'"
                                                                title="Visualizza zone lavorate di questo giorno">
                                                            üó∫Ô∏è Mappa
                                                        </button>
                                                    ` : ''}
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                    
                                    ${Object.keys(orePerData).filter(dataKey => !dateZone.includes(dataKey)).map(dataKey => {
                                        const oreGiorno = orePerData[dataKey];
                                        const dataObj = new Date(dataKey);
                                        const dataFormatted = dataObj.toLocaleDateString('it-IT', { 
                                            weekday: 'long', 
                                            year: 'numeric', 
                                            month: 'long', 
                                            day: 'numeric' 
                                        });
                                        
                                        return `
                                            <div style="background: #E3F2FD; padding: 12px; border-radius: 6px; border-left: 4px solid #1976D2;">
                                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                                    <div style="flex: 1;">
                                                        <div style="display: flex; align-items: center; gap: 10px;">
                                                            <strong style="color: #1976D2;">üìÖ ${escapeHtml(dataFormatted)}</strong>
                                                            ${oreGiorno.totale > 0 ? `
                                                                <span style="color: #1976D2; font-size: 12px; font-weight: bold;">
                                                                    ‚è±Ô∏è ${formatOreNette(oreGiorno.totale)}
                                                                    ${oreGiorno.validate > 0 ? `<span style="color: #4CAF50;">(${formatOreNette(oreGiorno.validate)} validate)</span>` : ''}
                                                                    ${oreGiorno.daValidare > 0 ? `<span style="color: #FF9800;">(${formatOreNette(oreGiorno.daValidare)} da validare)</span>` : ''}
                                                                </span>
                                                            ` : ''}
                                                        </div>
                                                        <span style="color: #999; font-size: 12px; font-style: italic; margin-top: 4px; display: block;">Nessuna zona tracciata per questo giorno</span>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                                ` : ''}
                                
                                ${attivitaLavoro.length > 0 ? `
                                <h4 style="color: #1976D2; font-size: 14px; margin-bottom: 10px;">üìù Attivit√† registrate:</h4>
                                <div style="display: grid; gap: 8px;">
                                    ${attivitaLavoro
                                        .filter(att => {
                                            if (filteredAttivita.length === 0 && attivita.length > 0) {
                                                return false;
                                            }
                                            if (filteredAttivita.length > 0) {
                                                return filteredAttivita.some(fa => fa.id === att.id);
                                            }
                                            return true;
                                        })
                                        .map(att => {
                                            const dataFormatted = att.data ? new Date(att.data + 'T00:00:00').toLocaleDateString('it-IT') : '';
                                            const oreFormatted = formatOreNette(att.oreNette || 0);
                                            return `
                                                <div style="background: #F5F5F5; padding: 10px; border-radius: 6px; border-left: 3px solid #1976D2;">
                                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                                        <div style="flex: 1;">
                                                            <strong style="color: #1976D2;">${escapeHtml(dataFormatted)}</strong>
                                                            <span style="color: #666; margin-left: 10px;">${escapeHtml(oreFormatted)}</span>
                                                            ${att.note ? `<div style="color: #666; font-size: 12px; margin-top: 4px;">${escapeHtml(att.note)}</div>` : ''}
                                                        </div>
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                </div>
                                ` : '<div style="color: #999; font-size: 13px; font-style: italic;">Nessuna attivit√† registrata</div>'}
                            </div>
                        </div>
                    `;
                }
                
                container.innerHTML = html;
                console.log('‚úÖ Dettagli lavori completati caricati con successo:', lavoriCompletati.length, 'lavori');
            } catch (error) {
                console.error('‚ùå Errore caricamento dettagli lavori completati:', error);
                console.error('Stack trace:', error.stack);
                if (container) {
                    container.innerHTML = `<div style="color: #d32f2f; padding: 20px; text-align: center;">
                        <strong>Errore caricamento dettagli:</strong><br>
                        ${error.message}<br>
                        <small style="color: #999; margin-top: 10px; display: block;">Controlla la console per maggiori dettagli</small>
                    </div>`;
                }
            }
        }

        window.toggleDettagliLavoro = function(lavoroId) {
            const dettagli = document.getElementById(`dettagli-lavoro-${lavoroId}`);
            const icon = document.getElementById(`icon-toggle-${lavoroId}`);
            
            if (dettagli && icon) {
                if (dettagli.style.display === 'none' || !dettagli.style.display) {
                    dettagli.style.display = 'block';
                    icon.textContent = '‚ñ≤';
                } else {
                    dettagli.style.display = 'none';
                    icon.textContent = '‚ñº';
                }
            }
        }

        // Toggle form rapido per lavoro
        window.toggleFormRapido = function(lavoroId) {
            const form = document.getElementById(`form-rapido-${lavoroId}`);
            const btn = document.getElementById(`btn-toggle-${lavoroId}`);
            
            if (form && btn) {
                if (form.style.display === 'none' || !form.style.display) {
                    form.style.display = 'block';
                    btn.textContent = '‚ùå Annulla';
                } else {
                    form.style.display = 'none';
                    btn.textContent = '‚ûï Aggiungi Attivit√†';
                    // Reset form
                    form.reset();
                    const today = new Date().toISOString().split('T')[0];
                    const dataInput = document.getElementById(`rapido-data-${lavoroId}`);
                    if (dataInput) {
                        dataInput.value = today;
                    }
                }
            }
        }

        // Popola dropdown trattori per form rapido
        function populateTrattoriRapido(lavoroId) {
            const select = document.getElementById(`rapido-trattore-${lavoroId}`);
            if (!select) return;
            
            select.innerHTML = '<option value="">-- Nessun trattore --</option>';
            
            if (!macchineList || macchineList.length === 0) return;
            
            const trattori = macchineList
                .filter(m => {
                    const tipo = m.tipoMacchina || m.tipo;
                    return tipo === 'trattore' && m.stato !== 'dismesso';
                })
                .sort((a, b) => {
                    const nomeA = (a.nome || '').toLowerCase();
                    const nomeB = (b.nome || '').toLowerCase();
                    return nomeA.localeCompare(nomeB);
                });
            
            trattori.forEach(trattore => {
                const option = document.createElement('option');
                option.value = trattore.id;
                const nome = trattore.nome || 'Trattore senza nome';
                const cavalli = trattore.cavalli ? ` (${trattore.cavalli} CV)` : '';
                const stato = trattore.stato === 'disponibile' ? '‚úÖ' : 
                             trattore.stato === 'in_uso' ? 'üîÑ' : 
                             trattore.stato === 'in_manutenzione' ? 'üîß' : 
                             trattore.stato === 'guasto' ? '‚ùå' : '';
                option.textContent = `${stato} ${nome}${cavalli}`;
                select.appendChild(option);
            });
            
            // Listener per attrezzi compatibili
            select.addEventListener('change', function() {
                populateAttrezziRapido(lavoroId, this.value);
            });
        }

        // Popola dropdown attrezzi compatibili per form rapido
        function populateAttrezziRapido(lavoroId, trattoreId) {
            const select = document.getElementById(`rapido-attrezzo-${lavoroId}`);
            const group = document.getElementById(`rapido-attrezzo-group-${lavoroId}`);
            if (!select || !group) return;
            
            select.innerHTML = '<option value="">-- Nessun attrezzo --</option>';
            
            if (!trattoreId) {
                group.style.display = 'none';
                return;
            }
            
            const trattore = macchineList.find(m => m.id === trattoreId);
            if (!trattore || !trattore.cavalli) {
                group.style.display = 'none';
                return;
            }
            
            group.style.display = 'block';
            
            const attrezziCompatibili = macchineList
                .filter(m => {
                    const tipo = m.tipoMacchina || m.tipo;
                    if (tipo !== 'attrezzo' || m.stato === 'dismesso') return false;
                    const cavalliMinimi = m.cavalliMinimiRichiesti || 0;
                    return trattore.cavalli >= cavalliMinimi;
                })
                .sort((a, b) => {
                    const nomeA = (a.nome || '').toLowerCase();
                    const nomeB = (b.nome || '').toLowerCase();
                    return nomeA.localeCompare(nomeB);
                });
            
            attrezziCompatibili.forEach(attrezzo => {
                const option = document.createElement('option');
                option.value = attrezzo.id;
                option.textContent = attrezzo.nome || 'Attrezzo senza nome';
                select.appendChild(option);
            });
        }

        // Salva attivit√† rapida da form lavoro
        window.salvaAttivitaRapida = async function(lavoroId) {
            try {
                if (!currentTenantId) {
                    showAlert('Errore: Tenant ID non disponibile', 'error');
                    return;
                }
                
                const clienteId = document.getElementById(`rapido-cliente-${lavoroId}`).value;
                const lavoroIdValue = document.getElementById(`rapido-lavoro-${lavoroId}`).value;
                const terrenoId = document.getElementById(`rapido-terreno-${lavoroId}`).value;
                const tipoLavoro = document.getElementById(`rapido-tipo-lavoro-${lavoroId}`).value;
                const data = document.getElementById(`rapido-data-${lavoroId}`).value;
                const ore = parseFloat(document.getElementById(`rapido-ore-${lavoroId}`).value);
                const note = document.getElementById(`rapido-note-${lavoroId}`).value.trim();
                const lavoroTerminato = document.getElementById(`rapido-lavoro-terminato-${lavoroId}`).checked;
                
                // Validazioni
                if (!data) {
                    showAlert('La data √® obbligatoria', 'error');
                    return;
                }
                
                const oggi = new Date();
                const oggiString = oggi.getFullYear() + '-' + 
                                  String(oggi.getMonth() + 1).padStart(2, '0') + '-' + 
                                  String(oggi.getDate()).padStart(2, '0');
                if (data > oggiString) {
                    showAlert('La data non pu√≤ essere futura', 'error');
                    return;
                }
                
                if (!ore || ore <= 0) {
                    showAlert('Le ore devono essere maggiori di 0', 'error');
                    return;
                }
                
                // Trova terreno e cliente
                const terreno = terreni.find(t => t.id === terrenoId);
                if (!terreno) {
                    showAlert('Terreno non trovato', 'error');
                    return;
                }
                
                const cliente = clientiList.find(c => c.id === clienteId);
                const clienteNome = cliente ? (cliente.ragioneSociale || cliente.nome || 'Cliente sconosciuto') : 'Cliente sconosciuto';
                
                // Campi macchina (solo se modulo attivo)
                let macchinaId = null;
                let attrezzoId = null;
                if (hasParcoMacchineModule) {
                    macchinaId = document.getElementById(`rapido-trattore-${lavoroId}`).value || null;
                    attrezzoId = document.getElementById(`rapido-attrezzo-${lavoroId}`).value || null;
                }
                
                // Prepara dati attivit√†
                const attivitaData = {
                    data: data,
                    terrenoId: terrenoId,
                    terrenoNome: terreno.nome,
                    tipoLavoro: tipoLavoro,
                    coltura: null,
                    orarioInizio: null,
                    orarioFine: null,
                    pauseMinuti: 0,
                    oreNette: ore,
                    note: note || null,
                    clienteId: clienteId,
                    lavoroId: lavoroIdValue,
                    clienteNome: clienteNome,
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                };
                
                // Aggiungi campi macchina se presenti
                if (macchinaId) attivitaData.macchinaId = macchinaId;
                if (attrezzoId) attivitaData.attrezzoId = attrezzoId;
                
                // Salva attivit√†
                const attivitaCollection = getAttivitaCollection(currentTenantId);
                await addDoc(attivitaCollection, attivitaData);
                
                // Se checkbox "lavoro terminato" √® selezionato, aggiorna stato lavoro
                if (lavoroTerminato) {
                    try {
                        const lavoroRef = doc(db, 'tenants', currentTenantId, 'lavori', lavoroIdValue);
                        const lavoroData = {
                            stato: 'completato',
                            aggiornatoIl: serverTimestamp()
                        };
                        await updateDoc(lavoroRef, lavoroData);
                        
                        // Se Parco Macchine attivo, libera macchine assegnate al lavoro
                        if (hasParcoMacchineModule) {
                            const lavoro = lavoriList.find(l => l.id === lavoroIdValue);
                            if (lavoro) {
                                if (lavoro.macchinaId) {
                                    await updateMacchinaStato(lavoro.macchinaId, 'disponibile');
                                }
                                if (lavoro.attrezzoId) {
                                    await updateMacchinaStato(lavoro.attrezzoId, 'disponibile');
                                }
                            }
                        }
                        
                        showAlert('Attivit√† creata e lavoro segnato come completato!', 'success');
                        
                        // Ricarica lavori per aggiornare lista
                        await loadLavoriContoTerzi();
                    } catch (error) {
                        console.error('Errore aggiornamento stato lavoro:', error);
                        showAlert('Attivit√† creata, ma errore nell\'aggiornamento stato lavoro', 'warning');
                    }
                } else {
                    showAlert('Attivit√† creata con successo!', 'success');
                }
                
                // Reset form
                document.getElementById(`form-rapido-${lavoroId}`).reset();
                const today = new Date().toISOString().split('T')[0];
                document.getElementById(`rapido-data-${lavoroId}`).value = today;
                toggleFormRapido(lavoroId); // Chiudi form
                
                // Ricarica attivit√† e lavori
                await loadAttivita();
                if (isContoTerziMode) {
                    await loadLavoriContoTerzi();
                    // Se c'√® un filtro stato, riapplica
                    const urlParams = new URLSearchParams(window.location.search);
                    const statoFiltro = urlParams.get('stato');
                    if (statoFiltro) {
                        applyContoTerziFilter(statoFiltro);
                    } else {
                        // Filtra solo attivit√† conto terzi
                        filteredAttivita = attivita.filter(a => a.clienteId != null && a.clienteId !== '');
                        renderAttivita();
                    }
                } else {
                    renderAttivita();
                }
                
            } catch (error) {
                console.error('Errore salvataggio attivit√† rapida:', error);
                showAlert(`Errore: ${error.message}`, 'error');
            }
        }

        // Apri modal attivit√†
        window.openAttivitaModal = async function(attivitaId = null) {
            currentAttivitaId = attivitaId;
            const modal = document.getElementById('attivita-modal');
            const form = document.getElementById('attivita-form');
            const title = document.getElementById('modal-title');
            
            // Ricarica macchine se modulo attivo e non ancora caricate
            if (hasParcoMacchineModule && macchineList.length === 0) {
                await loadMacchine();
            }
            
            // Carica categorie e tipi lavoro se struttura gerarchica attiva
            const usaStrutturaGerarchica = hasParcoMacchineModule || hasManodoperaModule;
            if (usaStrutturaGerarchica) {
                if (categorieLavoriPrincipali.length === 0) {
                    await loadCategorieLavori();
                }
                if (tipiLavoroList.length === 0) {
                    await loadTipiLavoro();
                }
                // Popola colture dai terreni se non ancora fatto
                populateColtureFromTerreni();
            }
            
            // Imposta required correttamente quando si apre il modal
            const tipoLavoroSelect = document.getElementById('attivita-tipo-lavoro');
            const tipoLavoroGerarchicoSelect = document.getElementById('attivita-tipo-lavoro-gerarchico');
            const categoriaPrincipaleSelect = document.getElementById('attivita-categoria-principale');
            const colturaSelect = document.getElementById('attivita-coltura');
            
            if (tipoLavoroSelect) {
                if (usaStrutturaGerarchica) {
                    tipoLavoroSelect.removeAttribute('required');
                } else {
                    tipoLavoroSelect.setAttribute('required', 'required');
                }
            }
            
            if (tipoLavoroGerarchicoSelect) {
                if (usaStrutturaGerarchica) {
                    tipoLavoroGerarchicoSelect.setAttribute('required', 'required');
                } else {
                    tipoLavoroGerarchicoSelect.removeAttribute('required');
                }
            }
            
            if (categoriaPrincipaleSelect) {
                if (usaStrutturaGerarchica) {
                    categoriaPrincipaleSelect.setAttribute('required', 'required');
                } else {
                    categoriaPrincipaleSelect.removeAttribute('required');
                }
            }
            
            if (colturaSelect) {
                if (usaStrutturaGerarchica) {
                    colturaSelect.removeAttribute('required');
                } else {
                    colturaSelect.setAttribute('required', 'required');
                }
            }
            
            // Imposta required su coltura gerarchica se struttura gerarchica attiva
            const colturaGerarchicaSelect = document.getElementById('attivita-coltura-gerarchica');
            if (colturaGerarchicaSelect) {
                if (usaStrutturaGerarchica) {
                    colturaGerarchicaSelect.setAttribute('required', 'required');
                } else {
                    colturaGerarchicaSelect.removeAttribute('required');
                }
            }
            
            if (attivitaId) {
                title.textContent = 'Modifica Attivit√†';
                // Carica dati attivit√†
                const attivita = filteredAttivita.find(a => a.id === attivitaId);
                if (attivita) {
                    document.getElementById('attivita-data').value = attivita.data || '';
                    document.getElementById('attivita-terreno').value = attivita.terrenoId || '';
                    document.getElementById('attivita-coltura').value = attivita.coltura || '';
                    document.getElementById('attivita-orario-inizio').value = attivita.orarioInizio || '';
                    document.getElementById('attivita-orario-fine').value = attivita.orarioFine || '';
                    document.getElementById('attivita-pause').value = attivita.pauseMinuti || 0;
                    document.getElementById('attivita-note').value = attivita.note || '';
                    
                    // Gestione tipo lavoro (gerarchico o piatto)
                    if (usaStrutturaGerarchica) {
                        // Cerca il tipo lavoro nella struttura gerarchica
                        const tipoLavoroObj = tipiLavoroList.find(t => t.nome === attivita.tipoLavoro);
                        if (tipoLavoroObj && tipoLavoroObj.categoriaId) {
                            // Trova categoria principale
                            let categoriaPrincipaleId = tipoLavoroObj.categoriaId;
                            const categoriaTrovata = categorieLavoriPrincipali.find(c => c.id === categoriaPrincipaleId);
                            if (!categoriaTrovata) {
                                // √à una sottocategoria, trova la principale
                                for (const [parentId, sottocat] of sottocategorieLavoriMap.entries()) {
                                    if (sottocat.find(sc => sc.id === categoriaPrincipaleId)) {
                                        categoriaPrincipaleId = parentId;
                                        break;
                                    }
                                }
                            }
                            populateCategoriaLavoroDropdown(categoriaPrincipaleId);
                            populateSottocategorieLavoro(categoriaPrincipaleId);
                            await loadTipiLavoro(tipoLavoroObj.categoriaId);
                            document.getElementById('attivita-tipo-lavoro-gerarchico').value = attivita.tipoLavoro || '';
                        } else {
                            populateCategoriaLavoroDropdown();
                        }
                    } else {
                        document.getElementById('attivita-tipo-lavoro').value = attivita.tipoLavoro || '';
                    }
                    
                    // Carica dati macchina se presenti
                    if (hasParcoMacchineModule) {
                        const macchinaId = attivita.macchinaId || null;
                        const attrezzoId = attivita.attrezzoId || null;
                        const oreMacchina = attivita.oreMacchina || null;
                        
                        populateTrattoriDropdown(macchinaId);
                        populateAttrezziDropdown(macchinaId, attrezzoId);
                        
                        if (macchinaId || attrezzoId) {
                            const oreMacchinaGroup = document.getElementById('attivita-ore-macchina-group');
                            if (oreMacchinaGroup) oreMacchinaGroup.style.display = 'block';
                            if (oreMacchina) {
                                document.getElementById('attivita-ore-macchina').value = oreMacchina;
                            }
                        }
                    }
                    
                    updateOreNette();
                    updateOreMacchinaDisplay();
                }
            } else {
                title.textContent = 'Aggiungi Attivit√†';
                form.reset();
                // Imposta data di default a oggi
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('attivita-data').value = today;
                document.getElementById('attivita-pause').value = 0;
                
                // Reset struttura gerarchica se attiva
                if (usaStrutturaGerarchica) {
                    populateCategoriaLavoroDropdown();
                    const sottocategoriaGroup = document.getElementById('attivita-sottocategoria-group');
                    const tipoLavoroGroup = document.getElementById('attivita-tipo-lavoro-gerarchico-group');
                    if (sottocategoriaGroup) sottocategoriaGroup.style.display = 'none';
                    if (tipoLavoroGroup) tipoLavoroGroup.style.display = 'none';
                }
                
                // Reset e popola macchine se modulo attivo
                if (hasParcoMacchineModule) {
                    // Assicurati che le macchine siano caricate
                    if (macchineList.length === 0) {
                        await loadMacchine();
                    }
                    populateTrattoriDropdown();
                    populateAttrezziDropdown(null);
                    const oreMacchinaGroup = document.getElementById('attivita-ore-macchina-group');
                    if (oreMacchinaGroup) oreMacchinaGroup.style.display = 'none';
                }
                
                updateOreNette();
                updateOreMacchinaDisplay();
            }
            
            modal.classList.add('active');
        };

        // Chiudi modal attivit√†
        window.closeAttivitaModal = function() {
            const modal = document.getElementById('attivita-modal');
            modal.classList.remove('active');
            currentAttivitaId = null;
        };

        // Calcola ore nette (ritorna oggetto con ore e minuti)
        function calculateOreNette() {
            const inizio = document.getElementById('attivita-orario-inizio').value;
            const fine = document.getElementById('attivita-orario-fine').value;
            const pause = parseInt(document.getElementById('attivita-pause').value) || 0;
            
            if (!inizio) return { ore: 0, minuti: 0, decimali: 0 };
            
            // Se non c'√® orario fine, non calcolare ore (attivit√† in corso)
            if (!fine) return { ore: 0, minuti: 0, decimali: 0 };
            
            try {
                const [inizioOre, inizioMinuti] = inizio.split(':').map(Number);
                const [fineOre, fineMinuti] = fine.split(':').map(Number);
                
                const inizioMinutiTotali = inizioOre * 60 + inizioMinuti;
                const fineMinutiTotali = fineOre * 60 + fineMinuti;
                
                let minutiTotali = fineMinutiTotali - inizioMinutiTotali;
                if (minutiTotali < 0) return { ore: 0, minuti: 0, decimali: 0 };
                
                minutiTotali -= pause;
                if (minutiTotali < 0) return { ore: 0, minuti: 0, decimali: 0 };
                
                const ore = Math.floor(minutiTotali / 60);
                const minuti = minutiTotali % 60;
                const decimali = parseFloat((minutiTotali / 60).toFixed(2));
                
                return { ore, minuti, decimali };
            } catch (e) {
                return { ore: 0, minuti: 0, decimali: 0 };
            }
        }

        // Formatta ore in formato leggibile
        function formatOreNette(oreNette) {
            if (typeof oreNette === 'number') {
                const ore = Math.floor(oreNette);
                const minuti = Math.round((oreNette - ore) * 60);
                
                if (minuti === 0) {
                    return `${ore}h`;
                } else if (ore === 0) {
                    return `${minuti}min`;
                } else {
                    return `${ore}h ${minuti}min`;
                }
            }
            return '0h';
        }

        // Aggiorna display ore nette
        function updateOreNette() {
            const result = calculateOreNette();
            let displayText = '';
            
            if (result.ore === 0 && result.minuti === 0) {
                displayText = '0h';
            } else if (result.minuti === 0) {
                displayText = `${result.ore}h`;
            } else if (result.ore === 0) {
                displayText = `${result.minuti}min`;
            } else {
                displayText = `${result.ore}h ${result.minuti}min`;
            }
            
            document.getElementById('ore-nette-display').textContent = displayText;
        }


        // Listener per precompilare terreno quando si seleziona un lavoro (modalit√† Conto Terzi)
        const lavoroSelect = document.getElementById('attivita-lavoro');
        if (lavoroSelect) {
            lavoroSelect.addEventListener('change', function() {
                if (!isContoTerziMode) return;
                
                const lavoroId = this.value;
                if (lavoroId) {
                    const lavoro = lavoriList.find(l => l.id === lavoroId);
                    if (lavoro && lavoro.terrenoId) {
                        // Precompila terreno
                        const terrenoSelect = document.getElementById('attivita-terreno');
                        if (terrenoSelect) {
                            terrenoSelect.value = lavoro.terrenoId;
                            terrenoSelect.disabled = true; // Disabilita perch√© viene dal lavoro
                            // Trigger change per precompilare coltura se necessario
                            terrenoSelect.dispatchEvent(new Event('change'));
                        }
                    }
                } else {
                    // Se lavoro deselezionato, abilita terreno e resetta
                    const terrenoSelect = document.getElementById('attivita-terreno');
                    if (terrenoSelect) {
                        terrenoSelect.disabled = false;
                        terrenoSelect.value = '';
                    }
                }
            });
        }

        // Listener per precompilare coltura quando si seleziona un terreno
        document.getElementById('attivita-terreno').addEventListener('change', function() {
            const terrenoId = this.value;
            if (terrenoId) {
                const terreno = terreni.find(t => t.id === terrenoId);
                if (terreno && terreno.coltura) {
                    // Precompila la coltura del terreno (sia lista piatta che gerarchica)
                    const colturaSelect = document.getElementById('attivita-coltura');
                    const colturaGerarchicaSelect = document.getElementById('attivita-coltura-gerarchica');
                    if (colturaSelect) {
                        colturaSelect.value = terreno.coltura;
                    }
                    if (colturaGerarchicaSelect) {
                        colturaGerarchicaSelect.value = terreno.coltura;
                    }
                }
            }
        });

        // Listener per gestire compatibilit√† attrezzi quando cambia trattore
        document.getElementById('attivita-macchina')?.addEventListener('change', function() {
            const trattoreId = this.value;
            const oreMacchinaGroup = document.getElementById('attivita-ore-macchina-group');
            
            populateAttrezziDropdown(trattoreId);
            
            // Mostra/nascondi gruppo ore macchina
            if (trattoreId || document.getElementById('attivita-attrezzo').value) {
                if (oreMacchinaGroup) oreMacchinaGroup.style.display = 'block';
                updateOreMacchinaDisplay();
            } else {
                if (oreMacchinaGroup) oreMacchinaGroup.style.display = 'none';
            }
        });

        // Listener per attrezzo
        document.getElementById('attivita-attrezzo')?.addEventListener('change', function() {
            const attrezzoId = this.value;
            const trattoreId = document.getElementById('attivita-macchina').value;
            const oreMacchinaGroup = document.getElementById('attivita-ore-macchina-group');
            
            // Mostra/nascondi gruppo ore macchina
            if (trattoreId || attrezzoId) {
                if (oreMacchinaGroup) oreMacchinaGroup.style.display = 'block';
                updateOreMacchinaDisplay();
            } else {
                if (oreMacchinaGroup) oreMacchinaGroup.style.display = 'none';
            }
        });

        // Aggiorna display ore macchina
        function updateOreMacchinaDisplay() {
            const oreLavoratoreDisplay = document.getElementById('ore-lavoratore-display');
            const oreMacchinaInput = document.getElementById('attivita-ore-macchina');
            
            if (oreLavoratoreDisplay) {
                const oreNetteResult = calculateOreNette();
                oreLavoratoreDisplay.textContent = oreNetteResult.decimali.toFixed(2);
                
                // Pre-compila ore macchina con ore lavoratore se vuoto
                if (oreMacchinaInput && !oreMacchinaInput.value) {
                    oreMacchinaInput.value = oreNetteResult.decimali.toFixed(2);
                }
            }
        }

        // Aggiorna display quando cambiano orari
        document.getElementById('attivita-orario-inizio')?.addEventListener('input', function() {
            updateOreNette();
            updateOreMacchinaDisplay();
        });
        document.getElementById('attivita-orario-fine')?.addEventListener('input', function() {
            updateOreNette();
            updateOreMacchinaDisplay();
        });
        document.getElementById('attivita-pause')?.addEventListener('input', function() {
            updateOreNette();
            updateOreMacchinaDisplay();
        });

        // Salva attivit√†
        window.handleSaveAttivita = async function(e) {
            e.preventDefault();
            
            if (!currentTenantId) {
                showAlert('Errore: Tenant ID non disponibile', 'error');
                return;
            }
            
            const data = document.getElementById('attivita-data').value;
            
            // Se modalit√† Conto Terzi, usa campi specifici
            let terrenoId, tipoLavoro, coltura, orarioInizio, orarioFine, pauseMinuti;
            let clienteId = null;
            let lavoroId = null;
            let oreManuali = null;
            
            if (isContoTerziMode) {
                clienteId = document.getElementById('attivita-cliente').value;
                lavoroId = document.getElementById('attivita-lavoro').value;
                oreManuali = parseFloat(document.getElementById('attivita-ore-manuali').value) || 0;
                
                // Trova lavoro per ottenere terreno e tipo lavoro
                const lavoro = lavoriList.find(l => l.id === lavoroId);
                if (!lavoro) {
                    showAlert('Lavoro non trovato', 'error');
                    return;
                }
                terrenoId = lavoro.terrenoId;
                tipoLavoro = lavoro.tipoLavoro || '';
                coltura = ''; // Non obbligatorio in modalit√† Conto Terzi
                orarioInizio = null;
                orarioFine = null;
                pauseMinuti = 0;
            } else {
                terrenoId = document.getElementById('attivita-terreno').value;
            const usaStrutturaGerarchica = hasParcoMacchineModule || hasManodoperaModule;
                tipoLavoro = usaStrutturaGerarchica 
                ? document.getElementById('attivita-tipo-lavoro-gerarchico').value 
                : document.getElementById('attivita-tipo-lavoro').value;
                coltura = usaStrutturaGerarchica
                ? document.getElementById('attivita-coltura-gerarchica').value
                : document.getElementById('attivita-coltura').value;
                orarioInizio = document.getElementById('attivita-orario-inizio').value;
                orarioFine = document.getElementById('attivita-orario-fine').value;
                pauseMinuti = parseInt(document.getElementById('attivita-pause').value) || 0;
            }
            
            const note = document.getElementById('attivita-note').value.trim();
            
            // Validazioni
            if (!data) {
                showAlert('La data √® obbligatoria', 'error');
                return;
            }
            
            // Verifica data non futura (accetta oggi e passato)
            // Usa la data locale invece di UTC per evitare problemi di fuso orario
            const oggi = new Date();
            const oggiString = oggi.getFullYear() + '-' + 
                              String(oggi.getMonth() + 1).padStart(2, '0') + '-' + 
                              String(oggi.getDate()).padStart(2, '0');
            // Permette oggi (data <= oggiString) e rifiuta solo date future (data > oggiString)
            if (data > oggiString) {
                showAlert('La data non pu√≤ essere futura', 'error');
                return;
            }
            
            if (!terrenoId) {
                showAlert('Il terreno √® obbligatorio', 'error');
                return;
            }
            
            // Validazioni specifiche per modalit√† Conto Terzi
            if (isContoTerziMode) {
                if (!clienteId) {
                    showAlert('Il cliente √® obbligatorio', 'error');
                    return;
                }
                if (!lavoroId) {
                    showAlert('Il lavoro √® obbligatorio', 'error');
                    return;
                }
                if (!oreManuali || oreManuali <= 0) {
                    showAlert('Le ore lavorate devono essere maggiori di 0', 'error');
                    return;
                }
            } else {
                // Validazioni standard
            if (!tipoLavoro) {
                showAlert('Il tipo lavoro √® obbligatorio', 'error');
                return;
            }
            
            if (!coltura) {
                showAlert('La coltura √® obbligatoria', 'error');
                return;
            }
            
            if (!orarioInizio) {
                showAlert('L\'orario inizio √® obbligatorio', 'error');
                return;
                }
            }
            
            // Se c'√® orario fine, valida che sia maggiore di inizio (solo se non modalit√† Conto Terzi)
            if (!isContoTerziMode && orarioFine) {
                const [inizioOre, inizioMinuti] = orarioInizio.split(':').map(Number);
                const [fineOre, fineMinuti] = orarioFine.split(':').map(Number);
                const inizioMinutiTotali = inizioOre * 60 + inizioMinuti;
                const fineMinutiTotali = fineOre * 60 + fineMinuti;
                
                if (fineMinutiTotali <= inizioMinutiTotali) {
                    showAlert('L\'orario fine deve essere maggiore dell\'orario inizio', 'error');
                    return;
                }
                
                const minutiLavoro = fineMinutiTotali - inizioMinutiTotali;
                if (pauseMinuti < 0) {
                    showAlert('Le pause non possono essere negative', 'error');
                    return;
                }
                if (pauseMinuti >= minutiLavoro) {
                    showAlert('Le pause non possono essere maggiori o uguali al tempo di lavoro', 'error');
                    return;
                }
            } else if (!isContoTerziMode) {
                // Se non c'√® orario fine, valida solo che le pause non siano negative (solo se non modalit√† Conto Terzi)
                if (pauseMinuti < 0) {
                    showAlert('Le pause non possono essere negative', 'error');
                    return;
                }
            }
            
            // Trova nome terreno
            const terreno = terreni.find(t => t.id === terrenoId);
            if (!terreno) {
                showAlert('Terreno non trovato', 'error');
                return;
            }
            
            // Campi macchina (solo se modulo Parco Macchine attivo)
            const macchinaId = hasParcoMacchineModule ? document.getElementById('attivita-macchina').value || null : null;
            const attrezzoId = hasParcoMacchineModule ? document.getElementById('attivita-attrezzo').value || null : null;
            
            // Verifica conflitti di orario per macchine/attrezzi
            if (hasParcoMacchineModule && (macchinaId || attrezzoId)) {
                const conflitto = verificaConflittiMacchine(
                    macchinaId, 
                    attrezzoId, 
                    data, 
                    orarioInizio, 
                    orarioFine, 
                    currentAttivitaId
                );
                
                if (conflitto) {
                    showAlert(conflitto.messaggio, 'error');
                    return;
                }
            }
            
            // Calcola ore nette (in formato decimale per salvataggio)
            // Se modalit√† Conto Terzi, usa ore manuali
            const oreNette = isContoTerziMode ? oreManuali : calculateOreNette().decimali;
            
            const oreMacchinaInput = hasParcoMacchineModule ? document.getElementById('attivita-ore-macchina').value : null;
            const oreMacchina = oreMacchinaInput ? parseFloat(oreMacchinaInput) : (oreNette || null); // Default = ore nette se non specificato
            
            // Prepara dati
            const attivitaData = {
                data: data,
                terrenoId: terrenoId,
                terrenoNome: terreno.nome,
                tipoLavoro: tipoLavoro,
                coltura: coltura || null,
                orarioInizio: orarioInizio || null,
                orarioFine: orarioFine || null,
                pauseMinuti: pauseMinuti,
                oreNette: oreNette,
                note: note || null,
                updatedAt: serverTimestamp()
            };
            
            // Aggiungi campi Conto Terzi se modalit√† attiva
            if (isContoTerziMode) {
                attivitaData.clienteId = clienteId;
                attivitaData.lavoroId = lavoroId;
                // Trova nome cliente
                const cliente = clientiList.find(c => c.id === clienteId);
                if (cliente) {
                    attivitaData.clienteNome = cliente.ragioneSociale || cliente.nome || 'Cliente senza nome';
                }
            }
            
            // Aggiungi campi macchina solo se modulo attivo e se presenti
            if (hasParcoMacchineModule) {
                if (macchinaId) attivitaData.macchinaId = macchinaId;
                if (attrezzoId) attivitaData.attrezzoId = attrezzoId;
                if (oreMacchina !== null) attivitaData.oreMacchina = oreMacchina;
            }
            
            try {
                const attivitaCollection = getAttivitaCollection(currentTenantId);
                
                if (currentAttivitaId) {
                    // Aggiorna
                    const attivitaRef = doc(attivitaCollection, currentAttivitaId);
                    await updateDoc(attivitaRef, attivitaData);
                    showAlert('Attivit√† aggiornata con successo!', 'success');
                } else {
                    // Crea
                    attivitaData.createdAt = serverTimestamp();
                    await addDoc(attivitaCollection, attivitaData);
                    showAlert('Attivit√† creata con successo!', 'success');
                }
                
                // Gestisci stato macchine e aggiorna ore (solo se modulo attivo)
                if (hasParcoMacchineModule && (macchinaId || attrezzoId)) {
                    // Se si sta modificando un'attivit√† esistente, verifica se le macchine sono cambiate
                    if (currentAttivitaId) {
                        const attivitaEsistente = attivita.find(a => a.id === currentAttivitaId);
                        if (attivitaEsistente) {
                            // Se l'attivit√† esistente aveva macchine diverse, libera quelle vecchie
                            if (attivitaEsistente.macchinaId && attivitaEsistente.macchinaId !== macchinaId) {
                                console.log(`üîÑ Macchina cambiata: libero vecchia ${attivitaEsistente.macchinaId}`);
                                await updateMacchinaStato(attivitaEsistente.macchinaId, 'disponibile');
                            }
                            if (attivitaEsistente.attrezzoId && attivitaEsistente.attrezzoId !== attrezzoId) {
                                console.log(`üîÑ Attrezzo cambiato: libero vecchio ${attivitaEsistente.attrezzoId}`);
                                await updateMacchinaStato(attivitaEsistente.attrezzoId, 'disponibile');
                            }
                            
                            // Se l'attivit√† esistente non aveva "ora fine" ma ora ce l'ha, libera le macchine
                            if (!attivitaEsistente.orarioFine && orarioFine) {
                                console.log('‚úÖ Aggiunta ora fine a attivit√† esistente, libero macchine');
                                if (attivitaEsistente.macchinaId) {
                                    await updateMacchinaStato(attivitaEsistente.macchinaId, 'disponibile');
                                }
                                if (attivitaEsistente.attrezzoId) {
                                    await updateMacchinaStato(attivitaEsistente.attrezzoId, 'disponibile');
                                }
                            }
                            // Se l'attivit√† esistente aveva "ora fine" ma ora non ce l'ha pi√π, imposta come in_uso
                            if (attivitaEsistente.orarioFine && !orarioFine) {
                                console.log('üîÑ Rimossa ora fine da attivit√† esistente, imposto macchine come in_uso');
                                if (macchinaId) {
                                    await updateMacchinaStato(macchinaId, 'in_uso');
                                }
                                if (attrezzoId) {
                                    await updateMacchinaStato(attrezzoId, 'in_uso');
                                }
                            }
                        }
                    }
                    
                    // Se c'√® orario fine, libera le macchine (attivit√† completata)
                    if (orarioFine) {
                        console.log('‚úÖ Attivit√† completata (ora fine presente), libero macchine');
                        if (macchinaId) {
                            await updateMacchinaStato(macchinaId, 'disponibile');
                        }
                        if (attrezzoId) {
                            await updateMacchinaStato(attrezzoId, 'disponibile');
                        }
                        
                        // Aggiorna ore macchine solo se ci sono ore da aggiungere
                        if (oreMacchina > 0) {
                            try {
                                const service = await window.loadMacchineUtilizzoService();
                                if (service && service.aggiornaOreMacchinaDaUtilizzo) {
                                    await service.aggiornaOreMacchinaDaUtilizzo({
                                        macchinaId: macchinaId,
                                        attrezzoId: attrezzoId,
                                        oreMacchina: oreMacchina,
                                        tenantId: currentTenantId,
                                        showAlertCallback: showAlert
                                    });
                                } else {
                                    // Service non disponibile (probabilmente ambiente file://)
                                    // L'attivit√† √® stata salvata correttamente, ma le ore macchina non sono state aggiornate automaticamente
                                    console.debug('Service macchine non disponibile: le ore macchina non sono state aggiornate automaticamente');
                                }
                            } catch (error) {
                                // Non loggare errori se il service non √® disponibile (ambiente file://)
                                if (window.location.protocol !== 'file:') {
                                    console.error('Errore aggiornamento ore macchina:', error);
                                }
                            }
                        }
                    } else {
                        // Se NON c'√® orario fine, imposta macchine come "in_uso" (attivit√† in corso)
                        console.log('üîÑ Attivit√† in corso (ora fine assente), imposto macchine come in_uso');
                        if (macchinaId) {
                            await updateMacchinaStato(macchinaId, 'in_uso');
                        }
                        if (attrezzoId) {
                            await updateMacchinaStato(attrezzoId, 'in_uso');
                        }
                    }
                    
                    // Ricarica macchine per aggiornare dropdown con stati aggiornati
                    await loadMacchine();
                }
                
                closeAttivitaModal();
                await loadAttivita();
            } catch (error) {
                console.error('Errore salvataggio attivit√†:', error);
                showAlert('Errore nel salvataggio: ' + error.message, 'error');
            }
        };

        // Modifica attivit√†
        window.editAttivita = function(attivitaId) {
            openAttivitaModal(attivitaId);
        };

        // Conferma eliminazione attivit√†
        window.confirmDeleteAttivita = async function(attivitaId) {
            if (!confirm('Sei sicuro di voler eliminare questa attivit√†?')) {
                return;
            }
            
            if (!currentTenantId) {
                showAlert('Errore: Tenant ID non disponibile', 'error');
                return;
            }
            
            try {
                const attivitaCollection = getAttivitaCollection(currentTenantId);
                const attivitaRef = doc(attivitaCollection, attivitaId);
                await deleteDoc(attivitaRef);
                showAlert('Attivit√† eliminata con successo!', 'success');
                await loadAttivita();
            } catch (error) {
                console.error('Errore eliminazione attivit√†:', error);
                showAlert('Errore nell\'eliminazione: ' + error.message, 'error');
            }
        };

        // Filtri
        document.getElementById('filter-data-da').addEventListener('change', applyFilters);
        document.getElementById('filter-data-a').addEventListener('change', applyFilters);
        document.getElementById('filter-terreno').addEventListener('change', applyFilters);
        document.getElementById('filter-tipo-lavoro').addEventListener('change', applyFilters);
        document.getElementById('filter-coltura').addEventListener('change', applyFilters);
        document.getElementById('filter-ricerca').addEventListener('input', applyFilters);

        function applyFilters() {
            const urlParams = new URLSearchParams(window.location.search);
            const statoFiltro = urlParams.get('stato');
            const isModalitaCompletati = isContoTerziMode && statoFiltro === 'completato';
            
            const dataDa = document.getElementById('filter-data-da').value;
            const dataA = document.getElementById('filter-data-a').value;
            const clienteId = document.getElementById('filter-cliente') ? document.getElementById('filter-cliente').value : '';
            const terrenoId = document.getElementById('filter-terreno').value;
            const tipoLavoro = document.getElementById('filter-tipo-lavoro').value;
            const coltura = document.getElementById('filter-coltura').value;
            const ricerca = document.getElementById('filter-ricerca').value.toLowerCase();
            
            // Se modalit√† completati, applica filtri base e poi filtra per lavori completati
            if (isModalitaCompletati) {
                // Filtra attivit√† base
                let attivitaFiltrate = attivita.filter(att => {
                    if (dataDa && att.data < dataDa) return false;
                    if (dataA && att.data > dataA) return false;
                    if (clienteId && att.clienteId !== clienteId) return false;
                    if (terrenoId && att.terrenoId !== terrenoId) return false;
                    if (tipoLavoro && att.tipoLavoro !== tipoLavoro) return false;
                    if (coltura && att.coltura !== coltura) return false;
                    if (ricerca && att.note && !att.note.toLowerCase().includes(ricerca)) return false;
                    return true;
                });
                
                // Filtra per lavori completati
                let lavoriCompletati = lavoriList.filter(l => l.stato === 'completato');
                
                // Se c'√® filtro cliente, filtra anche i lavori
                if (clienteId) {
                    lavoriCompletati = lavoriCompletati.filter(l => l.clienteId === clienteId);
                }
                
                // Se c'√® filtro terreno, filtra anche i lavori
                if (terrenoId) {
                    lavoriCompletati = lavoriCompletati.filter(l => l.terrenoId === terrenoId);
                }
                
                const lavoriIds = lavoriCompletati.map(l => l.id);
                filteredAttivita = attivitaFiltrate.filter(a => {
                    return a.clienteId != null && a.clienteId !== '' && a.lavoroId && lavoriIds.includes(a.lavoroId);
                });
            } else {
                // Filtri normali
            filteredAttivita = attivita.filter(att => {
                if (dataDa && att.data < dataDa) return false;
                if (dataA && att.data > dataA) return false;
                    if (clienteId && att.clienteId !== clienteId) return false;
                if (terrenoId && att.terrenoId !== terrenoId) return false;
                if (tipoLavoro && att.tipoLavoro !== tipoLavoro) return false;
                if (coltura && att.coltura !== coltura) return false;
                    if (ricerca && att.note && !att.note.toLowerCase().includes(ricerca)) return false;
                return true;
            });
            }
            
            renderAttivita();
        }

        // Pulisci filtri
        window.clearFilters = function() {
            document.getElementById('filter-data-da').value = '';
            document.getElementById('filter-data-a').value = '';
            const filterCliente = document.getElementById('filter-cliente');
            if (filterCliente) {
                filterCliente.value = '';
            }
            document.getElementById('filter-terreno').value = '';
            document.getElementById('filter-tipo-lavoro').value = '';
            document.getElementById('filter-coltura').value = '';
            document.getElementById('filter-ricerca').value = '';
            
            // Se modalit√† completati, riapplica filtro base
            const urlParams = new URLSearchParams(window.location.search);
            const statoFiltro = urlParams.get('stato');
            if (isContoTerziMode && statoFiltro === 'completato') {
                applyContoTerziFilter(statoFiltro);
            } else {
            filteredAttivita = [...attivita];
            renderAttivita();
            }
        };

        // Mostra alert
        function showAlert(message, type = 'success') {
            const container = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        // Escape HTML
        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return String(text).replace(/[&<>"']/g, m => map[m]);
        }

        // Variabili globali per la mappa
        let mappaZoneMap = null;
        let mappaZonePolygons = [];

        // Funzione per mostrare mappa zone lavorate
        window.mostraMappaZonaLavorata = async function(lavoroId, dataAttivita, dataFormatted) {
            try {
                console.log('üó∫Ô∏è Apertura mappa per lavoro:', lavoroId, 'data:', dataAttivita);
                
                // Apri modal prima di caricare la mappa
                document.getElementById('mappa-zone-title').textContent = `Zone Lavorate - ${dataFormatted}`;
                document.getElementById('mappa-zone-modal').classList.add('active');
                
                const mapContainer = document.getElementById('mappa-zone-container');
                const infoContainer = document.getElementById('mappa-zone-info');
                
                // Mostra loading
                mapContainer.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666;">Caricamento mappa...</div>';
                infoContainer.innerHTML = 'Caricamento zone lavorate...';
                
                // Carica Google Maps API se non gi√† caricato
                await loadGoogleMapsAPI();
                
                if (typeof google === 'undefined' || !google.maps) {
                    console.error('‚ùå Google Maps non disponibile');
                    showAlert('Google Maps non disponibile. Verifica che il file config/google-maps-config.js sia presente e configurato correttamente.', 'error');
                    mapContainer.innerHTML = 
                        '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #d32f2f; text-align: center; padding: 20px;">Google Maps non disponibile.<br>Verifica la configurazione.</div>';
                    infoContainer.innerHTML = 
                        '<div style="color: #d32f2f;">Errore: Google Maps non disponibile</div>';
                    return;
                }
                
                console.log('‚úÖ Google Maps caricato correttamente');

                // Trova lavoro e terreno
                const lavoro = lavoriList.find(l => l.id === lavoroId);
                if (!lavoro) {
                    mapContainer.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #d32f2f;">Lavoro non trovato</div>';
                    infoContainer.innerHTML = 'Errore: Lavoro non trovato';
                    return;
                }

                let terreno = terreni.find(t => t.id === lavoro.terrenoId);
                
                // Se il terreno non ha polygonCoords, caricalo dal database
                if (!terreno || !terreno.polygonCoords || terreno.polygonCoords.length === 0) {
                    console.log('‚ö†Ô∏è Terreno non ha polygonCoords in cache, carico dal database...');
                    try {
                        const terrenoDoc = await getDoc(doc(db, 'tenants', currentTenantId, 'terreni', lavoro.terrenoId));
                        if (terrenoDoc.exists()) {
                            const terrenoData = terrenoDoc.data();
                            terreno = {
                                id: terrenoDoc.id,
                                nome: terrenoData.nome || '',
                                superficie: terrenoData.superficie || 0,
                                coordinate: terrenoData.coordinate || null,
                                polygonCoords: terrenoData.polygonCoords || null
                            };
                            // Aggiorna anche nella lista cache
                            const terrenoIndex = terreni.findIndex(t => t.id === lavoro.terrenoId);
                            if (terrenoIndex >= 0) {
                                terreni[terrenoIndex] = terreno;
                            }
                        }
                    } catch (error) {
                        console.error('Errore caricamento terreno:', error);
                    }
                }
                
                if (!terreno || !terreno.polygonCoords || terreno.polygonCoords.length === 0) {
                    console.error('‚ùå Terreno senza confini mappa:', terreno);
                    mapContainer.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #d32f2f;">Terreno senza confini mappa</div>';
                    infoContainer.innerHTML = 'Errore: Terreno senza confini mappa. Verifica che il terreno abbia i confini tracciati.';
                    return;
                }
                
                console.log('‚úÖ Terreno trovato con confini:', terreno.nome, 'coordinate:', terreno.polygonCoords.length);

                // Inizializza mappa
                const center = terreno.coordinate || { lat: 45.0, lng: 9.0 };
                mappaZoneMap = new google.maps.Map(mapContainer, {
                    zoom: 15,
                    center: center,
                    mapTypeId: 'satellite'
                });

                // Pulisci poligoni precedenti
                mappaZonePolygons.forEach(p => p.setMap(null));
                mappaZonePolygons = [];

                // Disegna confini terreno
                const terrenoCoords = terreno.polygonCoords.map(c => {
                    if (typeof c === 'object' && c !== null) {
                        return {
                            lat: c.lat !== undefined ? c.lat : (Array.isArray(c) ? c[0] : 45.0),
                            lng: c.lng !== undefined ? c.lng : (Array.isArray(c) ? c[1] : 9.0)
                        };
                    } else if (Array.isArray(c)) {
                        return { lat: c[0] || 45.0, lng: c[1] || 9.0 };
                    }
                    return { lat: 45.0, lng: 9.0 };
                });
                
                const terrenoPolygon = new google.maps.Polygon({
                    paths: terrenoCoords,
                    strokeColor: '#FF0000',
                    strokeOpacity: 0.8,
                    strokeWeight: 3,
                    fillColor: '#FF0000',
                    fillOpacity: 0.1
                });
                terrenoPolygon.setMap(mappaZoneMap);
                mappaZonePolygons.push(terrenoPolygon);

                // Aggiusta zoom per includere tutto il terreno
                const bounds = new google.maps.LatLngBounds();
                terrenoCoords.forEach(coord => bounds.extend(coord));
                mappaZoneMap.fitBounds(bounds);

                // Carica zone lavorate per questa data specifica
                // collection e getDocs sono gi√† importate all'inizio del file
                const zoneRef = collection(db, 'tenants', currentTenantId, 'lavori', lavoroId, 'zoneLavorate');
                const zoneSnapshot = await getDocs(zoneRef);
                
                // Normalizza data attivit√† per confronto (YYYY-MM-DD)
                const dataAttivitaObj = new Date(dataAttivita + 'T00:00:00');
                const dataAttivitaKey = dataAttivitaObj.toISOString().split('T')[0];
                
                let zoneTrovate = [];
                let superficieTotale = 0;

                zoneSnapshot.forEach(zonaDoc => {
                    const zonaData = zonaDoc.data();
                    
                    // Normalizza data zona
                    let dataZona;
                    if (zonaData.data?.toDate) {
                        dataZona = zonaData.data.toDate();
                    } else if (zonaData.data) {
                        dataZona = new Date(zonaData.data);
                    } else {
                        return; // Salta se non ha data
                    }
                    
                    const dataZonaKey = new Date(dataZona.getFullYear(), dataZona.getMonth(), dataZona.getDate()).toISOString().split('T')[0];
                    
                    // Filtra per data specifica
                    if (dataZonaKey === dataAttivitaKey) {
                        const zona = { id: zonaDoc.id, ...zonaData };
                        zoneTrovate.push(zona);
                        superficieTotale += zona.superficieHa || 0;
                        
                        // Disegna zona lavorata sulla mappa
                        if (zona.coordinate && zona.coordinate.length > 0) {
                            const zonaCoords = zona.coordinate.map(c => ({
                                lat: c.lat,
                                lng: c.lng
                            }));
                            
                            const zonaPolygon = new google.maps.Polygon({
                                paths: zonaCoords,
                                strokeColor: '#00FF00',
                                strokeOpacity: 0.9,
                                strokeWeight: 2,
                                fillColor: '#00FF00',
                                fillOpacity: 0.4
                            });
                            zonaPolygon.setMap(mappaZoneMap);
                            mappaZonePolygons.push(zonaPolygon);
                        }
                    }
                });

                // Aggiorna info
                if (zoneTrovate.length === 0) {
                    infoContainer.innerHTML = `
                        <div style="color: #d32f2f;">
                            ‚ö†Ô∏è Nessuna zona lavorata tracciata per il ${dataFormatted}
                        </div>
                    `;
                } else {
                    infoContainer.innerHTML = `
                        <div style="color: #2E7D32;">
                            ‚úÖ <strong>${zoneTrovate.length}</strong> ${zoneTrovate.length === 1 ? 'zona' : 'zone'} lavorata${zoneTrovate.length === 1 ? '' : 'e'} 
                            per un totale di <strong>${superficieTotale.toFixed(2)} ha</strong>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Errore caricamento mappa zone:', error);
                document.getElementById('mappa-zone-container').innerHTML = 
                    '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #d32f2f;">Errore caricamento mappa</div>';
                document.getElementById('mappa-zone-info').innerHTML = 
                    `<div style="color: #d32f2f;">Errore: ${error.message}</div>`;
            }
        };

        // Funzione per chiudere modal mappa
        window.closeMappaZoneModal = function() {
            document.getElementById('mappa-zone-modal').classList.remove('active');
            
            // Pulisci mappa
            if (mappaZoneMap) {
                mappaZonePolygons.forEach(p => p.setMap(null));
                mappaZonePolygons = [];
                mappaZoneMap = null;
            }
        };
    </script>
    
    <!-- Service Worker Registration for PWA -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/gfv-platform/service-worker.js')
                    .then((registration) => {
                        console.log('Service Worker registrato con successo:', registration.scope);
                    })
                    .catch((error) => {
                        console.log('Registrazione Service Worker fallita:', error);
                    });
            });
        }
    </script>
</body>
</html>

